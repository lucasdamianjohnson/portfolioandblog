<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Concurrency and Parallelism in JavaScript</title><meta name="description" content="How to achieve concurrency and parallelism in JavaScript."/><meta name="next-head-count" content="4"/><link rel="preload" href="/portfolioandblog/_next/static/css/096e9d22de2dcd3a.css" as="style"/><link rel="stylesheet" href="/portfolioandblog/_next/static/css/096e9d22de2dcd3a.css" data-n-g=""/><link rel="preload" href="/portfolioandblog/_next/static/css/75fcda23719cd412.css" as="style"/><link rel="stylesheet" href="/portfolioandblog/_next/static/css/75fcda23719cd412.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/portfolioandblog/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/portfolioandblog/_next/static/chunks/webpack-54a79e58ec8024c2.js" defer=""></script><script src="/portfolioandblog/_next/static/chunks/framework-a58013ecf93b5e10.js" defer=""></script><script src="/portfolioandblog/_next/static/chunks/main-0b65d642a4ac4d54.js" defer=""></script><script src="/portfolioandblog/_next/static/chunks/pages/_app-7e2d3fd7c9a12493.js" defer=""></script><script src="/portfolioandblog/_next/static/chunks/522-3ebed60bceee5f06.js" defer=""></script><script src="/portfolioandblog/_next/static/chunks/506-bd9109170824ca61.js" defer=""></script><script src="/portfolioandblog/_next/static/chunks/pages/blog/posts/%5Bid%5D-dc9338d99306373b.js" defer=""></script><script src="/portfolioandblog/_next/static/8viYGhfZQTXc3dslKz5va/_buildManifest.js" defer=""></script><script src="/portfolioandblog/_next/static/8viYGhfZQTXc3dslKz5va/_ssgManifest.js" defer=""></script><script src="/portfolioandblog/_next/static/8viYGhfZQTXc3dslKz5va/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><header><div class="nav_main-header-nav-container__f3aWf"><nav class="nav_main-header-nav__QbsNZ"><span class="nav_main-header-title__gVKJ_">Luke Johnson</span></nav><div class="nav-mobile-menu-button_nav-mobile-menu-button-container__5drSF"><svg class="nav-mobile-menu-button_nav-mobile-menu-button__4EHmH" viewBox="0 0 100 80" width="40" height="40"><rect width="100" height="20"></rect><rect y="30" width="100" height="20"></rect><rect y="60" width="100" height="20"></rect></svg></div></div><div class="nav_main-header-mobile-links__XXYJI"><a href="/portfolioandblog"><div class="nav_main-header-link-conatiner__Vc8ao">Home</div></a><a href="/portfolioandblog/portfolio"><div class="nav_main-header-link-conatiner__Vc8ao">Portfolio</div></a><a href="/portfolioandblog/blog"><div class="nav_main-header-link-conatiner__Vc8ao nav_active__oTtOr">Blog</div></a><a href="/portfolioandblog/about"><div class="nav_main-header-link-conatiner__Vc8ao">About</div></a></div></header><main id="main"><article class="posts_blog-post-container__Gov9e"><div class="banner_post-banner-image-container__hlC_Y"><img src="/portfolioandblog/images/voxel.jpg" class="banner_post-banner-image__cLZGG" alt="sup"/></div><h2 class="typeographery_default-h2-title__jG_A4">Concurrency and Parallelism in JavaScript</h2><p>Today I want to cover how you can achieve some sort of concurrency and or parallelism in Javascript. When I was a computer science student I heard only nightmare stories of trying to set up concurrency and parallelism in lower-level languages like C++. But JavaScript thankfully handles the biggest problem. It lets you know when something is finished and it is very hard to create unwanted overlapping processes.</p>
<p>But chances are if you have just been doing standard web development there has not been much use for these kinds of things. With the exception of course of service workers and so on. However, let&#x27;s consider a highly resource-intensive application like a game or a 3D modeling program. With modern JS game engines like Three.JS and Babylon.JS, you can easily get some models rendering on the screen but what if then you have to perform an expensive calculation like rebuilding a mesh or doing some complicated game logic?</p>
<p>Well if everything is in the main thread this will cause the user to either experience immense slowdowns or even lockups. And this is something we want to try to avoid as much as possible in order to provide a great user experience.</p>
<p>So, this is where Web Workers, Shared Array Buffers, and Transferables come in. If you do not know what those are I will explain each briefly here.</p>
<h2>Web Worker</h2>
<p>A web worker is a separate process started by the browser and created through JavaScript. Each runs in it&#x27;s own separate context. Meaning you do not have direct access to a web worker from any other web worker or the main thread. You can only communicate by sending messages back and forward.</p>
<h2>Shared Array Buffers</h2>
<p>A Shared Array Buffer is a fixed-length array that can be shared between two separate contexts.</p>
<p>Note: This feature is supported in modern browsers but best used in a Chromium base (for now at least). A while ago it did cause some security vulnerabilities and was taken out of spec but since has been patched and put back.</p>
<h2>Transferables</h2>
<p>A transferable is a way in JavaScript to pass an array buffer or specific object like a canvas by reference to another context. In normal communication with a web worker, the message is serialized and deserialized. This is not that much of a deal until the bandwidth of the data increases.</p>
<p>If you want to see a full list of what all can be transferred here is the MDN docs on transferables: link</p>
<p>The goal in mind is to try to keep the communication between the main thread and the web workers as minimal and as fast as possible.</p>
<h2>Example Use Cases</h2>
<p>So now I will show each of these things in action in relation to the example I provided above. I am currently developing a voxel engine in TypeScript so I will show how I actually used each of these. I am going to be using TypeScript for these examples but they all can be converted into JS.</p>
<p>First, let&#x27;s start with setting up a web worker. Which looks like this:</p>
<pre><div node="[object Object]" style="color:#e3e9f2;background:#111b27;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto"><code class="language-ts" style="color:#e3e9f2;background:none;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d88b4a">function</span><span> </span><span class="token" style="color:#cf7ef6">createWorldWorker</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> worldGen </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">Worker</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token" style="color:#cdb74a">URL</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#82c366">&quot;../Contexts/worker.js&quot;</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token module" style="color:#d88b4a">import</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">meta</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">url</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>      type</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#82c366">&quot;module&quot;</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  worldGen</span><span class="token" style="color:#e3e9f2">.</span><span class="token method-variable function-variable method" style="color:#cf7ef6">onerror</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>er</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">ErrorEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token console" style="color:#6ab3e4">console</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">log</span><span class="token" style="color:#e3e9f2">(</span><span>er</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  worldGen</span><span class="token" style="color:#e3e9f2">.</span><span class="token method-variable function-variable method" style="color:#cf7ef6">onmessage</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#ccd6e4;font-style:italic">//do stuff</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token control-flow" style="color:#d88b4a">return</span><span> worldGen</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span></code></div></pre>
<p>You could have this in a class or a stand-alone function like this. But you can see that we simply just give the Worker constructor the relative path from the current to the worker script. The second param is an options object. In this example, I enabled modules so we can import other code into the web worker which is really nice.</p>
<p>After we set the worker up next, what we have to do is set up the worker&#x27;s onmessage and onerror functions. This is where you will set up communication between the main thread and the worker thread.</p>
<p>Now lets us look at inside the worker:</p>
<pre><div node="[object Object]" style="color:#e3e9f2;background:#111b27;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto"><code class="language-ts" style="color:#e3e9f2;background:none;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#ccd6e4;font-style:italic">//Inside web worker</span><span>
</span><span></span><span class="token" style="color:#ccd6e4;font-style:italic">//Listen for messages from main</span><span>
</span><span></span><span class="token" style="color:#cf7ef6">addEventListener</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#82c366">&quot;message&quot;</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> eventData </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#ccd6e4;font-style:italic">//do something with data</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span></span><span class="token" style="color:#ccd6e4;font-style:italic">//Send Messages To Main</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> worker </span><span class="token" style="color:#d88b4a">=</span><span> self</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#d88b4a">function</span><span> </span><span class="token" style="color:#cf7ef6">sendMessageToMain</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">any</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  worker</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">postMessage</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span></code></div></pre>
<p>So, now we have successfully set up communication between two separate threads.</p>
<p>Now that we got our workers set up, what are we going to use them for? Well in this example let&#x27;s say we have a worker that generates a game world procedurally and builds a 3D model from it. A 3D model can be created from scratch in a game engine like Three.Js and Babylon.JS (even plain gl if you want to do it yourself) by providing a set of vertices and index pairs for the vertices that specify the faces of the mesh and their orientation. We can also supply UV coordinates to texture the model and calculate its color to do “light baking”. But all of which can be a tremendous amount of data.</p>
<p>Let&#x27;s say for any given area 16×16 meters of the game world there could be potentially a model with a quarter of a million or more vertices. Sending all that data through the normal postMessage causes those huge arrays to be serialized and then deserialized on the main thread which would grind the program to halt.</p>
<p>So, what can we do? This is where we can use transferables.</p>
<p>Here is an example of it in action:</p>
<pre><div node="[object Object]" style="color:#e3e9f2;background:#111b27;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto"><code class="language-ts" style="color:#e3e9f2;background:none;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d88b4a">type</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">MeshData</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  positions</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  indices</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  colors</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  uvs</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#d88b4a">function</span><span> </span><span class="token" style="color:#cf7ef6">sendWorldDataData</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>  message</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#82c366">&quot;new&quot;</span><span> </span><span class="token" style="color:#d88b4a">|</span><span> </span><span class="token" style="color:#82c366">&quot;update&quot;</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>  positionX</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>  positionZ</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>  data</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MeshData</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> positionArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">positions</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> indicesArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Int32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">indices</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> colorsArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">colors</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> uvArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">uvs</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  worker</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">postMessage</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">[</span><span>
</span><span>      message</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      positionX</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      positionZ</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      positionArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      indicesArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      colorsArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      uvArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#82c366">&quot;/&quot;</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">[</span><span>
</span><span>      positionArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      indicesArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      colorsArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      uvArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">]</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span>
</span>
<span></span><span class="token" style="color:#ccd6e4;font-style:italic">//in the main thread</span><span>
</span><span>worker</span><span class="token" style="color:#e3e9f2">.</span><span class="token method-variable function-variable method" style="color:#cf7ef6">onmessage</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> eventData </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> message </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>message </span><span class="token" style="color:#d88b4a">==</span><span> </span><span class="token" style="color:#82c366">&quot;new&quot;</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> x </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> z </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">2</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#cf7ef6">buildNewMesh</span><span class="token" style="color:#e3e9f2">(</span><span>x</span><span class="token" style="color:#e3e9f2">,</span><span> z</span><span class="token" style="color:#e3e9f2">,</span><span> eventData</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#d88b4a">function</span><span> </span><span class="token" style="color:#cf7ef6">buildNewMesh</span><span class="token" style="color:#e3e9f2">(</span><span>positionX</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span> positionZ</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span> data</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">any</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> positions </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">2</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> indices </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Int32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">3</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> colors </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> uvs </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">5</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> newMesh </span><span class="token" style="color:#d88b4a">=</span><span> meshBuilder</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">makeMesh</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>    positionX</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    positionZ</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    positions</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    indices</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    colors</span><span class="token" style="color:#e3e9f2">,</span><span>
</span>    uvs
<span>  </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">meshes</span><span class="token" style="color:#e3e9f2">[</span><span>positionX</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">??=</span><span> </span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">meshes</span><span class="token" style="color:#e3e9f2">[</span><span>positionX</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">[</span><span>positionZ</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> newMesh</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span></code></div></pre>
<p>As you can see before we send the data to the main thread we create array buffers from the original data arrays. And then on the main thread, it only has to deserialize the data&#x27;s intent and the model&#x27;s new position To get the arrays back from the array buffers we just make a new TypedArray from the buffer. Make sure that you use the same TypedArray in the worker and main thread otherwise it could cause problems.</p>
<h2>Can This Go Faster Though?</h2>
<p>Well if you noticed we only created one other process off of main. But what if we could have more? So, in this 3D example let&#x27;s imagine that the worker we just created instead of itself calculating all of the mesh data it sends a condensed sort of template to another worker that builds the mesh data and sends that to the main.</p>
<p>This is where we can use something called a MessagePort to connect other workers together. So, in this example, we are going to create an array of workers that will be sent the model&#x27;s template data. The number of workers will be calculated by the machine&#x27;s thread count which we can get by using:</p>
<pre><div node="[object Object]" style="color:#e3e9f2;background:#111b27;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto"><code class="language-ts" style="color:#e3e9f2;background:none;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#d88b4a">const</span><span> numWorkers </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token dom" style="color:#6ab3e4">window</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">navigator</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">hardwareConcurrency</span><span class="token" style="color:#e3e9f2">;</span></code></div></pre>
<p>You could probably get away with using half or less but in this example, I am just showing that you can try to use the entire CPU if you want.</p>
<p>But here is what that would look like:</p>
<pre><div node="[object Object]" style="color:#e3e9f2;background:#111b27;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto"><code class="language-ts" style="color:#e3e9f2;background:none;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#ccd6e4;font-style:italic">//in main thread</span><span>
</span><span>worker</span><span class="token" style="color:#e3e9f2">.</span><span class="token method-variable function-variable method" style="color:#cf7ef6">onmessage</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> eventData </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> message </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>message </span><span class="token" style="color:#d88b4a">==</span><span> </span><span class="token" style="color:#82c366">&quot;new&quot;</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> x </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> z </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">2</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#cf7ef6">buildNewMesh</span><span class="token" style="color:#e3e9f2">(</span><span>x</span><span class="token" style="color:#e3e9f2">,</span><span> z</span><span class="token" style="color:#e3e9f2">,</span><span> eventData</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#d88b4a">function</span><span> </span><span class="token" style="color:#cf7ef6">buildNewMesh</span><span class="token" style="color:#e3e9f2">(</span><span>positionX</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span> positionZ</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span> data</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">any</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> chunkMesh </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">_getChunkMesh</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  chunkMesh</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">setEnabled</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#cdb74a">true</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>  </span><span class="token" style="color:#d88b4a">const</span><span> positions </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">2</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> indices </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Int32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">3</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> colors </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> uvs </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">5</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> newChunk </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">chunkBuilder</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">makeChunkMesh</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>    chunkMesh</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    positionX</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    positionZ</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">material</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    positions</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    indices</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    colors</span><span class="token" style="color:#e3e9f2">,</span><span>
</span>    uvs
<span>  </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#ccd6e4;font-style:italic">//chunkMesh.updateFacetData();</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">chunkMeshes</span><span class="token" style="color:#e3e9f2">[</span><span>positionX</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">??=</span><span> </span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">chunkMeshes</span><span class="token" style="color:#e3e9f2">[</span><span>positionX</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">[</span><span>positionZ</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> newChunk</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span>
</span>
<span></span><span class="token" style="color:#d88b4a">function</span><span> </span><span class="token" style="color:#cf7ef6">createBuilders</span><span class="token" style="color:#e3e9f2">(</span><span>world</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">Worker</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> numBuilders </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token dom" style="color:#6ab3e4">window</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">navigator</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">hardwareConcurrency</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token control-flow" style="color:#d88b4a">for</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#d88b4a">let</span><span> i </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">;</span><span> i </span><span class="token" style="color:#d88b4a">&lt;</span><span> numBuilders</span><span class="token" style="color:#e3e9f2">;</span><span> i</span><span class="token" style="color:#d88b4a">++</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">builders</span><span class="token" style="color:#e3e9f2">[</span><span>i</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">Worker</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token" style="color:#cdb74a">URL</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>        </span><span class="token" style="color:#82c366">&quot;../Contexts/MeshBuilders/ChunkMeshBuilder.worker.js&quot;</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>        </span><span class="token module" style="color:#d88b4a">import</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">meta</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">url</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>        type</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#82c366">&quot;module&quot;</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">builders</span><span class="token" style="color:#e3e9f2">[</span><span>i</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">.</span><span class="token method-variable function-variable method" style="color:#cf7ef6">onerror</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>er</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">ErrorEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>      </span><span class="token console" style="color:#6ab3e4">console</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">log</span><span class="token" style="color:#e3e9f2">(</span><span>er</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">builders</span><span class="token" style="color:#e3e9f2">[</span><span>i</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">.</span><span class="token method-variable function-variable method" style="color:#cf7ef6">onmessage</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">async</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">_handleMeshBuildEvent</span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d88b4a">const</span><span> channel </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">MessageChannel</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> builderWorker </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">builders</span><span class="token" style="color:#e3e9f2">[</span><span>i</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ccd6e4;font-style:italic">// Setup the connection: Port 1 is for worker 1</span><span>
</span><span>    world</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">postMessage</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#82c366">&quot;connect-builder&quot;</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#e3e9f2">[</span><span>channel</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">port1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>    </span><span class="token" style="color:#ccd6e4;font-style:italic">// Setup the connection: Port 2 is for worker 2</span><span>
</span><span>    builderWorker</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">postMessage</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#82c366">&quot;connect-world&quot;</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#e3e9f2">[</span><span>channel</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">port2</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span>
</span>
<span></span><span class="token" style="color:#ccd6e4;font-style:italic">//in world worker</span><span>
</span><span></span><span class="token" style="color:#d88b4a">class</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">BuildManager</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  count </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  numBuilders </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  mainThreadCom</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">Worker</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  builders</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessagePort</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>  </span><span class="token" style="color:#cf7ef6">addBuilder</span><span class="token" style="color:#e3e9f2">(</span><span>port</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessagePort</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">builders</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">push</span><span class="token" style="color:#e3e9f2">(</span><span>port</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">numBuilders</span><span class="token" style="color:#d88b4a">++</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>  </span><span class="token" style="color:#cf7ef6">requestChunkBeBuilt</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>    chunkX</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    chunkZ</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    meshTemplate</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">count</span><span class="token" style="color:#d88b4a">++</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">count</span><span> </span><span class="token" style="color:#d88b4a">&gt;=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">numBuilders</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">count</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> positions </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Uint16Array</span><span class="token" style="color:#e3e9f2">(</span><span>meshTemplate</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> indices </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Uint8Array</span><span class="token" style="color:#e3e9f2">(</span><span>meshTemplate</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> blocks </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Uint16Array</span><span class="token" style="color:#e3e9f2">(</span><span>meshTemplate</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">2</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> groups </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>meshTemplate</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">3</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> ambientOcclusion </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>meshTemplate</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">builders</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">count</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">postMessage</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">[</span><span>
</span><span>      chunkX</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      chunkZ</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      positions</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      indices</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      blocks</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      groups</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      ambientOcclusion</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">[</span><span>
</span><span>        positions</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>        indices</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>        blocks</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>        ambientOcclusion</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> builderManager </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">BuildManager</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span></span><span class="token" style="color:#cf7ef6">addEventListener</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#82c366">&quot;message&quot;</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> eventData </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> message </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>  </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>message </span><span class="token" style="color:#d88b4a">==</span><span> </span><span class="token" style="color:#82c366">&quot;connect-builder&quot;</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> port </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">ports</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    builderManager</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">addBuilder</span><span class="token" style="color:#e3e9f2">(</span><span>port</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span></span><span class="token" style="color:#ccd6e4;font-style:italic">//In builder worker</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> worker </span><span class="token" style="color:#d88b4a">=</span><span> self</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#ccd6e4;font-style:italic">//mesh builder</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> builder</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">any</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span></span><span class="token" style="color:#d88b4a">function</span><span> </span><span class="token" style="color:#cf7ef6">sendChunkData</span><span class="token" style="color:#e3e9f2">(</span><span>chunkX</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span> chunkZ</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span> data</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MeshData</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> positionArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">positions</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> indicesArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Int32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">indices</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> colorsArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">colors</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> uvArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">uvs</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  worker</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">postMessage</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">[</span><span>
</span><span>      chunkX</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      chunkZ</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      positionArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      indicesArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      colorsArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      uvArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#82c366">&quot;/&quot;</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">[</span><span>
</span><span>      positionArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      indicesArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      colorsArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      uvArray</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">buffer</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">]</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span>
</span>
<span></span><span class="token" style="color:#d88b4a">const</span><span> </span><span class="token function-variable" style="color:#cf7ef6">messageFromWorld</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> data </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>  </span><span class="token" style="color:#d88b4a">const</span><span> positionX </span><span class="token" style="color:#d88b4a">=</span><span> data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> positionZ </span><span class="token" style="color:#d88b4a">=</span><span> data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> meshPositions </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Uint16Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">2</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> meshIndices </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Uint8Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">3</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> meshBlocks </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Uint16Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> meshGroups </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">5</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> meshAO </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">6</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> meshData </span><span class="token" style="color:#d88b4a">=</span><span> builder</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">buildMesh</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>    positionX</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    positionZ</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    meshPositions</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    meshIndices</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    meshBlocks</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>    meshGroups</span><span class="token" style="color:#e3e9f2">,</span><span>
</span>    meshAO
<span>  </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>  </span><span class="token" style="color:#cf7ef6">sendChunkData</span><span class="token" style="color:#e3e9f2">(</span><span>positionX</span><span class="token" style="color:#e3e9f2">,</span><span> positionZ</span><span class="token" style="color:#e3e9f2">,</span><span> meshData</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#cf7ef6">addEventListener</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#82c366">&quot;message&quot;</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> data </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> message </span><span class="token" style="color:#d88b4a">=</span><span> data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>  </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>message </span><span class="token" style="color:#d88b4a">==</span><span> </span><span class="token" style="color:#82c366">&quot;connect-world&quot;</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> port </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">ports</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>    port</span><span class="token" style="color:#e3e9f2">.</span><span class="token method-variable function-variable method" style="color:#cf7ef6">onmessage</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>      </span><span class="token" style="color:#cf7ef6">messageFromWorld</span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span></code></div></pre>
<p>As you can see we create a few instances of the builder worker and when it is time to build a new model we send it just the template. It then constructs the model and sends it to the main thread. So, with this set up you could build as many meshes as you have workers. But all of this stuff is happening more or less concurrently. What about parallelism?</p>
<h2>Parallelism</h2>
<p>Well, I am going to give a simple example but should give you a good idea of what you can do with a Shared Array Buffer.</p>
<p>The thing you need to note with a Shared Array Buffer is that they are a fixed size and must be declared their size at the start. You define the size by the number of bytes. So, if you need an array of 3 32 bit floats you would need 12 bytes 4 bytes for each number. Then in order to use the array-like, it is an array of 32 bit floats you must create a TypedArray from it that is also a 32BitFloat. And of course, we are using signed bytes so we can go in the negative also.</p>
<p>Another thing to note in this example. I have one thread write and one thread read. You could run into problems if you are having multiple threads read and write at the same time. If you are doing this please check into Atomics: link</p>
<p>It basically ensures thread safety when reading and writing shared data across multiple contexts.</p>
<p>So, a use case for the game example would be keeping track of the player&#x27;s position and doing something based on where they moved or where they are looking. What we can do actually is continually load the player&#x27;s position into the array with the shared array buffer. And from any other context that we share that buffer too can also access where the player is at. So, let&#x27; see that in action:</p>
<pre><div node="[object Object]" style="color:#e3e9f2;background:#111b27;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0.5em 0;overflow:auto"><code class="language-ts" style="color:#e3e9f2;background:none;font-family:Consolas, Monaco, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#ccd6e4;font-style:italic">//In main thread</span><span>
</span><span></span><span class="token" style="color:#d88b4a">class</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">Player</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  position </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span> x</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">,</span><span> y</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">,</span><span> z</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#cdb74a">0</span><span> </span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  sharedPositionArrayBuffer </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">SharedArrayBuffer</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#cdb74a">12</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  sharedPositionArray </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">sharedPositionArrayBuffer</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#cf7ef6">update</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">sharedPositionArray</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">position</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">x</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">sharedPositionArray</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">position</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">y</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">sharedPositionArray</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">2</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">position</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">z</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#ccd6e4;font-style:italic">//Get a worker - Just used for example</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> worldWorker</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">Worker</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">&lt;</span><span class="token maybe-class-name">Worker</span><span class="token" style="color:#d88b4a">&gt;</span><span class="token" style="color:#e3e9f2">{</span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> player </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">Player</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>worldWorker</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">postMessage</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#82c366">&quot;connect-player&quot;</span><span class="token" style="color:#e3e9f2">,</span><span> player</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">sharedPositionArrayBuffer</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">[</span><span>player</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">sharedPositionArrayBuffer</span><span class="token" style="color:#e3e9f2">]</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#ccd6e4;font-style:italic">//game update loop</span><span>
</span><span></span><span class="token" style="color:#cf7ef6">setInterval</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  player</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">update</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#cdb74a">50</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span></span><span class="token" style="color:#ccd6e4;font-style:italic">//In Worker</span><span>
</span><span></span><span class="token" style="color:#d88b4a">class</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">PlayerWatcher</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  playerABSPositon</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  cachedPlayerX</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  cachedPlayerZ</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  cachedZone</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#cf7ef6">calculateGameZone</span><span class="token" style="color:#e3e9f2">(</span><span>positionX</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">,</span><span> positionZ</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token" style="color:#ea89ea">number</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> zonePositionX </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>positionX </span><span class="token" style="color:#d88b4a">&gt;&gt;</span><span> </span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#d88b4a">&lt;&lt;</span><span> </span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> zonePositionZ </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>positionZ </span><span class="token" style="color:#d88b4a">&gt;&gt;</span><span> </span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#d88b4a">&lt;&lt;</span><span> </span><span class="token" style="color:#cdb74a">4</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token control-flow" style="color:#d88b4a">return</span><span> </span><span class="token" style="color:#e3e9f2">[</span><span>zonePositionX</span><span class="token" style="color:#e3e9f2">,</span><span> zonePositionZ</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span>
<span>  </span><span class="token" style="color:#cf7ef6">setPlayerSharedArrays</span><span class="token" style="color:#e3e9f2">(</span><span>postionBuffer</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">SharedArrayBuffer</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token known-class-name" style="color:#6ab3e4">Float32Array</span><span class="token" style="color:#e3e9f2">(</span><span>postionBuffer</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>  </span><span class="token" style="color:#cf7ef6">startWatchingPlayer</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedPlayerX</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedPlayerZ</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">const</span><span> zone </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">calculateGameZone</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedZone</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> zone</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#cf7ef6">setInterval</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">let</span><span> movedX </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">false</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedPlayerX</span><span> </span><span class="token" style="color:#d88b4a">!=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>        movedX </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">true</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">let</span><span> movedZ </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">false</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedPlayerZ</span><span> </span><span class="token" style="color:#d88b4a">!=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>        movedZ </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">true</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">const</span><span> zone </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">calculateGameZone</span><span class="token" style="color:#e3e9f2">(</span><span>
</span><span>        </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">,</span><span>
</span><span>        </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">let</span><span> zoneXChanged </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">false</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>zone</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">!=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedZone</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>        zoneXChanged </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">true</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">let</span><span> zoneZChanged </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">false</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>zone</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span> </span><span class="token" style="color:#d88b4a">!=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedZone</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>        zoneZChanged </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#cdb74a">true</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedZone</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> zone</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedPlayerX</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>      </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">cachedPlayerZ</span><span> </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">this</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">playerABSPositon</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    </span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#cdb74a">50</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> playerWatcher </span><span class="token" style="color:#d88b4a">=</span><span> </span><span class="token" style="color:#d88b4a">new</span><span> </span><span class="token maybe-class-name" style="color:#6ab3e4">PlayerWatcher</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#d88b4a">const</span><span> worker </span><span class="token" style="color:#d88b4a">=</span><span> self</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span></span><span class="token" style="color:#cf7ef6">addEventListener</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#82c366">&quot;message&quot;</span><span class="token" style="color:#e3e9f2">,</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#d88b4a">:</span><span> </span><span class="token maybe-class-name">MessageEvent</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token arrow" style="color:#d88b4a">=&gt;</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> eventData </span><span class="token" style="color:#d88b4a">=</span><span> event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#d88b4a">const</span><span> message </span><span class="token" style="color:#d88b4a">=</span><span> eventData</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">0</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">;</span><span>
</span>
<span>  </span><span class="token control-flow" style="color:#d88b4a">if</span><span> </span><span class="token" style="color:#e3e9f2">(</span><span>message </span><span class="token" style="color:#d88b4a">==</span><span> </span><span class="token" style="color:#82c366">&quot;connect-player&quot;</span><span class="token" style="color:#e3e9f2">)</span><span> </span><span class="token" style="color:#e3e9f2">{</span><span>
</span><span>    playerWatcher</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">setPlayerSharedArrays</span><span class="token" style="color:#e3e9f2">(</span><span>event</span><span class="token" style="color:#e3e9f2">.</span><span class="token" style="color:#6ab3e4">data</span><span class="token" style="color:#e3e9f2">[</span><span class="token" style="color:#cdb74a">1</span><span class="token" style="color:#e3e9f2">]</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>    playerWatcher</span><span class="token" style="color:#e3e9f2">.</span><span class="token method" style="color:#6ab3e4">startWatchingPlayer</span><span class="token" style="color:#e3e9f2">(</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span><span>
</span><span>  </span><span class="token" style="color:#e3e9f2">}</span><span>
</span><span></span><span class="token" style="color:#e3e9f2">}</span><span class="token" style="color:#e3e9f2">)</span><span class="token" style="color:#e3e9f2">;</span></code></div></pre>
<p>In the player class, we are just getting the player&#x27;s position and setting that in the shared array. While in the worker we are just reading that data from the array. So, in this way we can react instantaneously and in parallel to the player&#x27;s updated position. Pretty cool huh? We don&#x27;t have to fuss with postMessage or message events at all.</p>
<h2>Conclusion</h2>
<p>Achieving parallelism and concurrency is not that hard in JavaScript. It could be a great benefit to your application to offload as much as you could to the separate threads. Though I would always say don&#x27;t prematurely optimize and realize the consequences of having many workers and sharing lots of data between them. Make sure to always test the actual effects of using a worker. There is still the potential for memory leaks and performance hits. It&#x27;s really about striking a balance.</p>
<p>Other things you could consider are things like web assembly and if you are doing game programming you could maybe move some intensive actions to the GPU like UV animations on a model.</p></article></main><footer class="footer_main-footer__8GXj7"><div class="footer_main-footer-content__sCsP0"><h2 class="footer_main-footer-title__R7K7k typeographery_default-text-center__2eLto">Luke Johnson</h2><h3 class="typeographery_default-h3-title__DZnVN typeographery_default-text-center__2eLto">Find Me</h3><div class="social-icon-group_social-icon-group-default-container__v5UJK social-icon-group_center-container__lqebP"><span class="social-icon-group_social-icon__WoOQW social-icon-group_twitter-icon__znuFY"><a href="https://twitter.com/DivineSoftware"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path></svg></a></span><span class="social-icon-group_social-icon__WoOQW social-icon-group_youtube-icon__0aK6c"><a href="https://www.youtube.com/channel/UC6n2h7qiuEHI6oLLvod5wdg"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm4.441 16.892c-2.102.144-6.784.144-8.883 0-2.276-.156-2.541-1.27-2.558-4.892.017-3.629.285-4.736 2.558-4.892 2.099-.144 6.782-.144 8.883 0 2.277.156 2.541 1.27 2.559 4.892-.018 3.629-.285 4.736-2.559 4.892zm-6.441-7.234l4.917 2.338-4.917 2.346v-4.684z"></path></svg></a></span><span class="social-icon-group_social-icon__WoOQW undefined"><a href="https://www.linkedin.com/in/luke-damian-johnson/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm-2 16h-2v-6h2v6zm-1-6.891c-.607 0-1.1-.496-1.1-1.109 0-.612.492-1.109 1.1-1.109s1.1.497 1.1 1.109c0 .613-.493 1.109-1.1 1.109zm8 6.891h-1.998v-2.861c0-1.881-2.002-1.722-2.002 0v2.861h-2v-6h2v1.093c.872-1.616 4-1.736 4 1.548v3.359z"></path></svg></a></span><span class="social-icon-group_social-icon__WoOQW social-icon-group_reddit-icon__xii7e"><a href="https://www.reddit.com/r/DivineStarGames/"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M14.238 15.348c.085.084.085.221 0 .306-.465.462-1.194.687-2.231.687l-.008-.002-.008.002c-1.036 0-1.766-.225-2.231-.688-.085-.084-.085-.221 0-.305.084-.084.222-.084.307 0 .379.377 1.008.561 1.924.561l.008.002.008-.002c.915 0 1.544-.184 1.924-.561.085-.084.223-.084.307 0zm-3.44-2.418c0-.507-.414-.919-.922-.919-.509 0-.923.412-.923.919 0 .506.414.918.923.918.508.001.922-.411.922-.918zm13.202-.93c0 6.627-5.373 12-12 12s-12-5.373-12-12 5.373-12 12-12 12 5.373 12 12zm-5-.129c0-.851-.695-1.543-1.55-1.543-.417 0-.795.167-1.074.435-1.056-.695-2.485-1.137-4.066-1.194l.865-2.724 2.343.549-.003.034c0 .696.569 1.262 1.268 1.262.699 0 1.267-.566 1.267-1.262s-.568-1.262-1.267-1.262c-.537 0-.994.335-1.179.804l-2.525-.592c-.11-.027-.223.037-.257.145l-.965 3.038c-1.656.02-3.155.466-4.258 1.181-.277-.255-.644-.415-1.05-.415-.854.001-1.549.693-1.549 1.544 0 .566.311 1.056.768 1.325-.03.164-.05.331-.05.5 0 2.281 2.805 4.137 6.253 4.137s6.253-1.856 6.253-4.137c0-.16-.017-.317-.044-.472.486-.261.82-.766.82-1.353zm-4.872.141c-.509 0-.922.412-.922.919 0 .506.414.918.922.918s.922-.412.922-.918c0-.507-.413-.919-.922-.919z"></path></svg></a></span></div><h3 class="typeographery_default-h3-title__DZnVN typeographery_default-text-center__2eLto">Contact Me</h3><p class="typeographery_default-span__Rq_Yg typeographery_default-text-center__2eLto">Email:<a href="mailto:ldjohnso@mtu.edu">ldjohnso@mtu.edu</a></p><p class="footer_copyright-notice__r3E3f">©️ 2022, All rights reserved.</p><p class="footer_copyright-notice__r3E3f">All content is created by Lucas Johnson. Any content that is not is linked with attritubutes.</p></div></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"data":{"title":"Concurrency and Parallelism in JavaScript","description":"How to achieve concurrency and parallelism in JavaScript.","date":"2021-11-01","banner":" { \"src\" : \"/images/voxel.jpg\", \"alt\":\"sup\" } ","id":"concurrency-and-parallelism-in-javascript"},"content":"\r\nToday I want to cover how you can achieve some sort of concurrency and or parallelism in Javascript. When I was a computer science student I heard only nightmare stories of trying to set up concurrency and parallelism in lower-level languages like C++. But JavaScript thankfully handles the biggest problem. It lets you know when something is finished and it is very hard to create unwanted overlapping processes.\r\n\r\nBut chances are if you have just been doing standard web development there has not been much use for these kinds of things. With the exception of course of service workers and so on. However, let's consider a highly resource-intensive application like a game or a 3D modeling program. With modern JS game engines like Three.JS and Babylon.JS, you can easily get some models rendering on the screen but what if then you have to perform an expensive calculation like rebuilding a mesh or doing some complicated game logic?\r\n\r\nWell if everything is in the main thread this will cause the user to either experience immense slowdowns or even lockups. And this is something we want to try to avoid as much as possible in order to provide a great user experience.\r\n\r\nSo, this is where Web Workers, Shared Array Buffers, and Transferables come in. If you do not know what those are I will explain each briefly here.\r\n\r\n## Web Worker\r\n\r\nA web worker is a separate process started by the browser and created through JavaScript. Each runs in it's own separate context. Meaning you do not have direct access to a web worker from any other web worker or the main thread. You can only communicate by sending messages back and forward.\r\n\r\n## Shared Array Buffers\r\n\r\nA Shared Array Buffer is a fixed-length array that can be shared between two separate contexts.\r\n\r\nNote: This feature is supported in modern browsers but best used in a Chromium base (for now at least). A while ago it did cause some security vulnerabilities and was taken out of spec but since has been patched and put back.\r\n\r\n## Transferables\r\n\r\nA transferable is a way in JavaScript to pass an array buffer or specific object like a canvas by reference to another context. In normal communication with a web worker, the message is serialized and deserialized. This is not that much of a deal until the bandwidth of the data increases.\r\n\r\nIf you want to see a full list of what all can be transferred here is the MDN docs on transferables: link\r\n\r\nThe goal in mind is to try to keep the communication between the main thread and the web workers as minimal and as fast as possible.\r\n\r\n## Example Use Cases\r\n\r\nSo now I will show each of these things in action in relation to the example I provided above. I am currently developing a voxel engine in TypeScript so I will show how I actually used each of these. I am going to be using TypeScript for these examples but they all can be converted into JS.\r\n\r\nFirst, let's start with setting up a web worker. Which looks like this:\r\n\r\n```ts\r\nfunction createWorldWorker() {\r\n  const worldGen = new Worker(\r\n    new URL(\"../Contexts/worker.js\", import.meta.url),\r\n    {\r\n      type: \"module\",\r\n    }\r\n  );\r\n  worldGen.onerror = (er: ErrorEvent) =\u003e {\r\n    console.log(er);\r\n  };\r\n  worldGen.onmessage = (event: MessageEvent) =\u003e {\r\n    //do stuff\r\n  };\r\n  return worldGen;\r\n}\r\n```\r\n\r\nYou could have this in a class or a stand-alone function like this. But you can see that we simply just give the Worker constructor the relative path from the current to the worker script. The second param is an options object. In this example, I enabled modules so we can import other code into the web worker which is really nice.\r\n\r\nAfter we set the worker up next, what we have to do is set up the worker's onmessage and onerror functions. This is where you will set up communication between the main thread and the worker thread.\r\n\r\nNow lets us look at inside the worker:\r\n\r\n```ts\r\n//Inside web worker\r\n//Listen for messages from main\r\naddEventListener(\"message\", (event: MessageEvent) =\u003e {\r\n  const eventData = event.data;\r\n  //do something with data\r\n});\r\n\r\n//Send Messages To Main\r\nconst worker = self;\r\nfunction sendMessageToMain(data: any) {\r\n  worker.postMessage(data);\r\n}\r\n```\r\n\r\nSo, now we have successfully set up communication between two separate threads.\r\n\r\nNow that we got our workers set up, what are we going to use them for? Well in this example let's say we have a worker that generates a game world procedurally and builds a 3D model from it. A 3D model can be created from scratch in a game engine like Three.Js and Babylon.JS (even plain gl if you want to do it yourself) by providing a set of vertices and index pairs for the vertices that specify the faces of the mesh and their orientation. We can also supply UV coordinates to texture the model and calculate its color to do “light baking”. But all of which can be a tremendous amount of data.\r\n\r\nLet's say for any given area 16×16 meters of the game world there could be potentially a model with a quarter of a million or more vertices. Sending all that data through the normal postMessage causes those huge arrays to be serialized and then deserialized on the main thread which would grind the program to halt.\r\n\r\nSo, what can we do? This is where we can use transferables.\r\n\r\nHere is an example of it in action:\r\n\r\n```ts\r\ntype MeshData = {\r\n  positions: number[];\r\n  indices: number[];\r\n  colors: number[];\r\n  uvs: number[];\r\n};\r\nfunction sendWorldDataData(\r\n  message: \"new\" | \"update\",\r\n  positionX: number,\r\n  positionZ: number,\r\n  data: MeshData\r\n) {\r\n  const positionArray = new Float32Array(data.positions);\r\n  const indicesArray = new Int32Array(data.indices);\r\n  const colorsArray = new Float32Array(data.colors);\r\n  const uvArray = new Float32Array(data.uvs);\r\n  worker.postMessage(\r\n    [\r\n      message,\r\n      positionX,\r\n      positionZ,\r\n      positionArray.buffer,\r\n      indicesArray.buffer,\r\n      colorsArray.buffer,\r\n      uvArray.buffer,\r\n    ],\r\n    \"/\",\r\n    [\r\n      positionArray.buffer,\r\n      indicesArray.buffer,\r\n      colorsArray.buffer,\r\n      uvArray.buffer,\r\n    ]\r\n  );\r\n}\r\n\r\n//in the main thread\r\nworker.onmessage = (event: MessageEvent) =\u003e {\r\n  const eventData = event.data;\r\n  const message = eventData[0];\r\n  if (message == \"new\") {\r\n    const x = eventData[1];\r\n    const z = eventData[2];\r\n    buildNewMesh(x, z, eventData);\r\n  }\r\n};\r\nfunction buildNewMesh(positionX: number, positionZ: number, data: any) {\r\n  const positions = new Float32Array(data[2]);\r\n  const indices = new Int32Array(data[3]);\r\n  const colors = new Float32Array(data[4]);\r\n  const uvs = new Float32Array(data[5]);\r\n  const newMesh = meshBuilder.makeMesh(\r\n    positionX,\r\n    positionZ,\r\n    positions,\r\n    indices,\r\n    colors,\r\n    uvs\r\n  );\r\n  this.meshes[positionX] ??= [];\r\n  this.meshes[positionX][positionZ] = newMesh;\r\n}\r\n```\r\n\r\nAs you can see before we send the data to the main thread we create array buffers from the original data arrays. And then on the main thread, it only has to deserialize the data's intent and the model's new position To get the arrays back from the array buffers we just make a new TypedArray from the buffer. Make sure that you use the same TypedArray in the worker and main thread otherwise it could cause problems.\r\n\r\n## Can This Go Faster Though?\r\n\r\nWell if you noticed we only created one other process off of main. But what if we could have more? So, in this 3D example let's imagine that the worker we just created instead of itself calculating all of the mesh data it sends a condensed sort of template to another worker that builds the mesh data and sends that to the main.\r\n\r\nThis is where we can use something called a MessagePort to connect other workers together. So, in this example, we are going to create an array of workers that will be sent the model's template data. The number of workers will be calculated by the machine's thread count which we can get by using:\r\n\r\n```ts\r\nconst numWorkers = window.navigator.hardwareConcurrency;\r\n```\r\n\r\nYou could probably get away with using half or less but in this example, I am just showing that you can try to use the entire CPU if you want.\r\n\r\nBut here is what that would look like:\r\n\r\n```ts\r\n//in main thread\r\nworker.onmessage = (event: MessageEvent) =\u003e {\r\n  const eventData = event.data;\r\n  const message = eventData[0];\r\n  if (message == \"new\") {\r\n    const x = eventData[1];\r\n    const z = eventData[2];\r\n    buildNewMesh(x, z, eventData);\r\n  }\r\n};\r\nfunction buildNewMesh(positionX: number, positionZ: number, data: any) {\r\n  const chunkMesh = this._getChunkMesh();\r\n  chunkMesh.setEnabled(true);\r\n\r\n  const positions = new Float32Array(data[2]);\r\n  const indices = new Int32Array(data[3]);\r\n  const colors = new Float32Array(data[4]);\r\n  const uvs = new Float32Array(data[5]);\r\n  const newChunk = this.chunkBuilder.makeChunkMesh(\r\n    chunkMesh,\r\n    positionX,\r\n    positionZ,\r\n    this.material,\r\n    positions,\r\n    indices,\r\n    colors,\r\n    uvs\r\n  );\r\n  //chunkMesh.updateFacetData();\r\n  this.chunkMeshes[positionX] ??= [];\r\n  this.chunkMeshes[positionX][positionZ] = newChunk;\r\n}\r\n\r\nfunction createBuilders(world: Worker) {\r\n  const numBuilders = window.navigator.hardwareConcurrency;\r\n  for (let i = 0; i \u003c numBuilders; i++) {\r\n    this.builders[i] = new Worker(\r\n      new URL(\r\n        \"../Contexts/MeshBuilders/ChunkMeshBuilder.worker.js\",\r\n        import.meta.url\r\n      ),\r\n      {\r\n        type: \"module\",\r\n      }\r\n    );\r\n    this.builders[i].onerror = (er: ErrorEvent) =\u003e {\r\n      console.log(er);\r\n    };\r\n    this.builders[i].onmessage = async (event) =\u003e {\r\n      this._handleMeshBuildEvent(event);\r\n    };\r\n\r\n    const channel = new MessageChannel();\r\n    const builderWorker = this.builders[i];\r\n\r\n    // Setup the connection: Port 1 is for worker 1\r\n    world.postMessage([\"connect-builder\"], [channel.port1]);\r\n\r\n    // Setup the connection: Port 2 is for worker 2\r\n    builderWorker.postMessage([\"connect-world\"], [channel.port2]);\r\n  }\r\n}\r\n\r\n//in world worker\r\nclass BuildManager {\r\n  count = 0;\r\n  numBuilders = 0;\r\n  mainThreadCom: Worker;\r\n  builders: MessagePort[] = [];\r\n\r\n  addBuilder(port: MessagePort) {\r\n    this.builders.push(port);\r\n    this.numBuilders++;\r\n  }\r\n  requestChunkBeBuilt(\r\n    chunkX: number,\r\n    chunkZ: number,\r\n    meshTemplate: number[][]\r\n  ) {\r\n    this.count++;\r\n    if (this.count \u003e= this.numBuilders) {\r\n      this.count = 0;\r\n    }\r\n    const positions = new Uint16Array(meshTemplate[0]);\r\n    const indices = new Uint8Array(meshTemplate[1]);\r\n    const blocks = new Uint16Array(meshTemplate[2]);\r\n    const groups = new Float32Array(meshTemplate[3]);\r\n    const ambientOcclusion = new Float32Array(meshTemplate[4]);\r\n\r\n    this.builders[this.count].postMessage([\r\n      chunkX,\r\n      chunkZ,\r\n      positions.buffer,\r\n      indices.buffer,\r\n      blocks.buffer,\r\n      groups.buffer,\r\n      ambientOcclusion.buffer,\r\n    ]),\r\n      [\r\n        positions.buffer,\r\n        indices.buffer,\r\n        blocks.buffer,\r\n        ambientOcclusion.buffer,\r\n      ];\r\n  }\r\n}\r\nconst builderManager = new BuildManager();\r\n\r\naddEventListener(\"message\", (event: MessageEvent) =\u003e {\r\n  const eventData = event.data;\r\n  const message = eventData[0];\r\n\r\n  if (message == \"connect-builder\") {\r\n    const port = event.ports[0];\r\n    builderManager.addBuilder(port);\r\n  }\r\n});\r\n\r\n//In builder worker\r\nconst worker = self;\r\n//mesh builder\r\nconst builder: any = {};\r\n\r\nfunction sendChunkData(chunkX: number, chunkZ: number, data: MeshData) {\r\n  const positionArray = new Float32Array(data.positions);\r\n  const indicesArray = new Int32Array(data.indices);\r\n  const colorsArray = new Float32Array(data.colors);\r\n  const uvArray = new Float32Array(data.uvs);\r\n  worker.postMessage(\r\n    [\r\n      chunkX,\r\n      chunkZ,\r\n      positionArray.buffer,\r\n      indicesArray.buffer,\r\n      colorsArray.buffer,\r\n      uvArray.buffer,\r\n    ],\r\n    \"/\",\r\n    [\r\n      positionArray.buffer,\r\n      indicesArray.buffer,\r\n      colorsArray.buffer,\r\n      uvArray.buffer,\r\n    ]\r\n  );\r\n}\r\n\r\nconst messageFromWorld = (event: MessageEvent) =\u003e {\r\n  const data = event.data;\r\n\r\n  const positionX = data[0];\r\n  const positionZ = data[1];\r\n  const meshPositions = new Uint16Array(data[2]);\r\n  const meshIndices = new Uint8Array(data[3]);\r\n  const meshBlocks = new Uint16Array(data[4]);\r\n  const meshGroups = new Float32Array(data[5]);\r\n  const meshAO = new Float32Array(data[6]);\r\n  const meshData = builder.buildMesh(\r\n    positionX,\r\n    positionZ,\r\n    meshPositions,\r\n    meshIndices,\r\n    meshBlocks,\r\n    meshGroups,\r\n    meshAO\r\n  );\r\n\r\n  sendChunkData(positionX, positionZ, meshData);\r\n};\r\naddEventListener(\"message\", (event: MessageEvent) =\u003e {\r\n  const data = event.data;\r\n  const message = data[0];\r\n\r\n  if (message == \"connect-world\") {\r\n    const port = event.ports[0];\r\n\r\n    port.onmessage = (event: MessageEvent) =\u003e {\r\n      messageFromWorld(event);\r\n    };\r\n  }\r\n});\r\n```\r\n\r\nAs you can see we create a few instances of the builder worker and when it is time to build a new model we send it just the template. It then constructs the model and sends it to the main thread. So, with this set up you could build as many meshes as you have workers. But all of this stuff is happening more or less concurrently. What about parallelism?\r\n\r\n## Parallelism\r\n\r\nWell, I am going to give a simple example but should give you a good idea of what you can do with a Shared Array Buffer.\r\n\r\nThe thing you need to note with a Shared Array Buffer is that they are a fixed size and must be declared their size at the start. You define the size by the number of bytes. So, if you need an array of 3 32 bit floats you would need 12 bytes 4 bytes for each number. Then in order to use the array-like, it is an array of 32 bit floats you must create a TypedArray from it that is also a 32BitFloat. And of course, we are using signed bytes so we can go in the negative also.\r\n\r\nAnother thing to note in this example. I have one thread write and one thread read. You could run into problems if you are having multiple threads read and write at the same time. If you are doing this please check into Atomics: link\r\n\r\nIt basically ensures thread safety when reading and writing shared data across multiple contexts.\r\n\r\nSo, a use case for the game example would be keeping track of the player's position and doing something based on where they moved or where they are looking. What we can do actually is continually load the player's position into the array with the shared array buffer. And from any other context that we share that buffer too can also access where the player is at. So, let' see that in action:\r\n\r\n```ts\r\n//In main thread\r\nclass Player {\r\n  position = { x: 0, y: 0, z: 0 };\r\n  sharedPositionArrayBuffer = new SharedArrayBuffer(12);\r\n  sharedPositionArray = new Float32Array(this.sharedPositionArrayBuffer);\r\n  update() {\r\n    this.sharedPositionArray[0] = this.position.x;\r\n    this.sharedPositionArray[1] = this.position.y;\r\n    this.sharedPositionArray[2] = this.position.z;\r\n  }\r\n}\r\n//Get a worker - Just used for example\r\nconst worldWorker: Worker = \u003cWorker\u003e{};\r\nconst player = new Player();\r\nworldWorker.postMessage(\r\n  [\"connect-player\", player.sharedPositionArrayBuffer],\r\n  [player.sharedPositionArrayBuffer]\r\n);\r\n//game update loop\r\nsetInterval(() =\u003e {\r\n  player.update();\r\n}, 50);\r\n\r\n//In Worker\r\nclass PlayerWatcher {\r\n  playerABSPositon: Float32Array;\r\n  cachedPlayerX: number;\r\n  cachedPlayerZ: number;\r\n  cachedZone: number[];\r\n  calculateGameZone(positionX: number, positionZ: number) {\r\n    const zonePositionX = (positionX \u003e\u003e 4) \u003c\u003c 4;\r\n    const zonePositionZ = (positionZ \u003e\u003e 4) \u003c\u003c 4;\r\n    return [zonePositionX, zonePositionZ];\r\n  }\r\n\r\n  setPlayerSharedArrays(postionBuffer: SharedArrayBuffer) {\r\n    this.playerABSPositon = new Float32Array(postionBuffer);\r\n  }\r\n  startWatchingPlayer() {\r\n    this.cachedPlayerX = this.playerABSPositon[0];\r\n    this.cachedPlayerZ = this.playerABSPositon[1];\r\n    const zone = this.calculateGameZone(\r\n      this.playerABSPositon[0],\r\n      this.playerABSPositon[1]\r\n    );\r\n    this.cachedZone = zone;\r\n    setInterval(() =\u003e {\r\n      let movedX = false;\r\n      if (this.cachedPlayerX != this.playerABSPositon[0]) {\r\n        movedX = true;\r\n      }\r\n      let movedZ = false;\r\n      if (this.cachedPlayerZ != this.playerABSPositon[1]) {\r\n        movedZ = true;\r\n      }\r\n      const zone = this.calculateGameZone(\r\n        this.playerABSPositon[0],\r\n        this.playerABSPositon[1]\r\n      );\r\n      let zoneXChanged = false;\r\n      if (zone[0] != this.cachedZone[0]) {\r\n        zoneXChanged = true;\r\n      }\r\n      let zoneZChanged = false;\r\n      if (zone[1] != this.cachedZone[1]) {\r\n        zoneZChanged = true;\r\n      }\r\n      this.cachedZone = zone;\r\n      this.cachedPlayerX = this.playerABSPositon[0];\r\n      this.cachedPlayerZ = this.playerABSPositon[1];\r\n    }, 50);\r\n  }\r\n}\r\nconst playerWatcher = new PlayerWatcher();\r\nconst worker = self;\r\naddEventListener(\"message\", (event: MessageEvent) =\u003e {\r\n  const eventData = event.data;\r\n  const message = eventData[0];\r\n\r\n  if (message == \"connect-player\") {\r\n    playerWatcher.setPlayerSharedArrays(event.data[1]);\r\n    playerWatcher.startWatchingPlayer();\r\n  }\r\n});\r\n```\r\n\r\nIn the player class, we are just getting the player's position and setting that in the shared array. While in the worker we are just reading that data from the array. So, in this way we can react instantaneously and in parallel to the player's updated position. Pretty cool huh? We don't have to fuss with postMessage or message events at all.\r\n\r\n## Conclusion\r\n\r\nAchieving parallelism and concurrency is not that hard in JavaScript. It could be a great benefit to your application to offload as much as you could to the separate threads. Though I would always say don't prematurely optimize and realize the consequences of having many workers and sharing lots of data between them. Make sure to always test the actual effects of using a worker. There is still the potential for memory leaks and performance hits. It's really about striking a balance.\r\n\r\nOther things you could consider are things like web assembly and if you are doing game programming you could maybe move some intensive actions to the GPU like UV animations on a model.\r\n","id":"concurrency-and-parallelism-in-javascript"},"__N_SSG":true},"page":"/blog/posts/[id]","query":{"id":"concurrency-and-parallelism-in-javascript"},"buildId":"8viYGhfZQTXc3dslKz5va","assetPrefix":"/portfolioandblog","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>