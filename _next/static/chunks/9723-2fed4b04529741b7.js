"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9723,8570,6877,6861,8734,4667,3148,1511,8974,7534,8869,9022,6914,3509,9653,4669,5250,4378,1778,1903,5356,4879,7623,1442,5899,6018,3581,4359,8272],{35488:function(e,t,i){var r,s,n=i(6132),a=i(82877),o=i(28116),l=i(90247),c=i(94551),u=i(39884);class h{get syncRoot(){return this._syncRoot}get masterFrame(){return 0===this._runtimeAnimations.length?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(-1===e){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e,null!==this._goToFrame&&this.goToFrame(this._goToFrame)}get elapsedTime(){return null===this._localDelayOffset?0:this._scene._animationTime-this._localDelayOffset}constructor(e,t,i=0,r=100,s=!1,n=1,o,l,c,u=!1,h=0){this.target=t,this.fromFrame=i,this.toFrame=r,this.loopAnimation=s,this.onAnimationEnd=o,this.onAnimationLoop=c,this.isAdditive=u,this.playOrder=h,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=[],this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this._goToFrame=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new a.y$,this.onAnimationLoopObservable=new a.y$,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=n,e._activeAnimatables.push(this)}syncWith(e){if(this._syncRoot=e,e){let e=this._scene._activeAnimatables.indexOf(this);e>-1&&(this._scene._activeAnimatables.splice(e,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){let r=t[i],s=new o.o(e,r,this._scene,this);s._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(s)}}getAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){let t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){let e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){let t=this._runtimeAnimations;if(t[0]){let i=t[0].animation.framePerSecond;this._frameToSyncFromJump=this._frameToSyncFromJump??t[0].currentFrame;let r=0===this.speedRatio?0:(e-this._frameToSyncFromJump)/i*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let i=0;i<t.length;i++)t[i].goToFrame(e,this._weight);this._goToFrame=e}get paused(){return this._paused}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t,i=!1,r=!1){if(e||t){let s=this._scene._activeAnimatables.indexOf(this);if(s>-1){let n=this._runtimeAnimations;for(let i=n.length-1;i>=0;i--){let r=n[i];(!e||r.animation.name==e)&&(!t||t(r.target))&&(r.dispose(),n.splice(i,1))}0!=n.length||(i||this._scene._activeAnimatables.splice(s,1),r||this._raiseOnAnimationEnd())}}else{let e=this._scene._activeAnimatables.indexOf(this);if(e>-1){i||this._scene._activeAnimatables.splice(e,1);let t=this._runtimeAnimations;for(let e=0;e<t.length;e++)t[e].dispose();this._runtimeAnimations.length=0,r||this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){let t;if(this._paused)return this.animationStarted=!1,null===this._pausedDelay&&(this._pausedDelay=e),!0;if(null===this._localDelayOffset?(this._localDelayOffset=e,this._pausedDelay=null):null!==this._pausedDelay&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),null!==this._manualJumpDelay&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._goToFrame=null,0===this._weight)return!0;let i=!1,r=this._runtimeAnimations;for(t=0;t<r.length;t++){let s=r[t].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);i=i||s}if(this.animationStarted=i,!i){if(this.disposeOnEnd)for(t=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(t,1),t=0;t<r.length;t++)r[t].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return i}}r=i(44755).x,(s=n.N)&&(s.prototype.copyAnimationRange=function(e,t,i,r=!1,s=null){let n,a,o;0===this.animations.length&&(this.animations.push(new l.fw(this.name,"_matrix",e.animations[0].framePerSecond,l.fw.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));let c=e.animations[0].getRange(t);if(!c)return!1;let u=c.from,h=c.to,d=e.animations[0].getKeys(),f=e.length,p=e.getParent(),m=this.getParent(),_=r&&p&&f&&this.length&&f!==this.length,g=_&&m&&p?m.length/p.length:1,v=r&&!m&&s&&(1!==s.x||1!==s.y||1!==s.z),S=this.animations[0].getKeys();for(let e=0,t=d.length;e<t;e++)(n=d[e]).frame>=u&&n.frame<=h&&(r?(o=n.value.clone(),_?(a=o.getTranslation(),o.setTranslation(a.scaleInPlace(g))):v&&s?(a=o.getTranslation(),o.setTranslation(a.multiplyInPlace(s))):o=n.value):o=n.value,S.push({frame:n.frame+i,value:o}));return this.animations[0].createRange(t,u+i,h+i),!0}),r&&(r.prototype._animate=function(e){if(!this.animationsEnabled)return;let t=c.F.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=t}this.deltaTime=void 0!==e?e:this.useConstantAnimationDeltaTime?16:(t-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=t;let i=this._activeAnimatables;if(0===i.length)return;this._animationTime+=this.deltaTime;let r=this._animationTime;for(let e=0;e<i.length;e++){let t=i[e];!t._animate(r)&&t.disposeOnEnd&&e--}!function(e){if(e._registeredForLateAnimationBindings.length){for(let t=0;t<e._registeredForLateAnimationBindings.length;t++){let i=e._registeredForLateAnimationBindings.data[t];for(let e in i._lateAnimationHolders){let t=i._lateAnimationHolders[e],r=t.animations[0],s=t.originalValue;if(null==s)continue;let n=l.fw.AllowMatrixDecomposeForInterpolation&&s.m,a=i[e];if(n)a=function(e){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return e.originalValue;let t=1,i=u.jp.Vector3[0],r=u.jp.Vector3[1],s=u.jp.Quaternion[0],n=0,a=e.animations[0],o=e.originalValue,l=1,c=!1;if(e.totalWeight<1)l=1-e.totalWeight,o.decompose(r,s,i);else{if(n=1,t=e.totalWeight,1==(l=a.weight/t)){if(!e.totalAdditiveWeight)return a.currentValue;c=!0}a.currentValue.decompose(r,s,i)}if(!c){r.scaleInPlace(l),i.scaleInPlace(l),s.scaleInPlace(l);for(let a=n;a<e.animations.length;a++){let n=e.animations[a];if(0===n.weight)continue;l=n.weight/t;let o=u.jp.Vector3[2],c=u.jp.Vector3[3],h=u.jp.Quaternion[1];n.currentValue.decompose(c,h,o),c.scaleAndAddToRef(l,r),h.scaleAndAddToRef(u._f.Dot(s,h)>0?l:-l,s),o.scaleAndAddToRef(l,i)}s.normalize()}for(let t=0;t<e.additiveAnimations.length;t++){let n=e.additiveAnimations[t];if(0===n.weight)continue;let a=u.jp.Vector3[2],o=u.jp.Vector3[3],l=u.jp.Quaternion[1];n.currentValue.decompose(o,l,a),o.multiplyToRef(r,o),u.P.LerpToRef(r,o,n.weight,r),s.multiplyToRef(l,l),u._f.SlerpToRef(s,l,n.weight,s),a.scaleAndAddToRef(n.weight,i)}let h=a?a._animationState.workValue:u.jp.Matrix[0].clone();return u.y3.ComposeToRef(r,s,i,h),h}(t);else if(void 0!==s.w)a=function(e,t){if(0===e.totalWeight&&0===e.totalAdditiveWeight)return t;let i=e.animations[0],r=e.originalValue,s=t;if(0===e.totalWeight&&e.totalAdditiveWeight>0)s.copyFrom(r);else if(1===e.animations.length){if(u._f.SlerpToRef(r,i.currentValue,Math.min(1,e.totalWeight),s),0===e.totalAdditiveWeight)return s}else if(e.animations.length>1){let i,n,a=1;if(e.totalWeight<1){let t=1-e.totalWeight;n=[],(i=[]).push(r),n.push(t)}else{if(2===e.animations.length&&(u._f.SlerpToRef(e.animations[0].currentValue,e.animations[1].currentValue,e.animations[1].weight/e.totalWeight,t),0===e.totalAdditiveWeight))return t;i=[],n=[],a=e.totalWeight}for(let t=0;t<e.animations.length;t++){let r=e.animations[t];i.push(r.currentValue),n.push(r.weight/a)}let o=0;for(let e=0;e<i.length;){if(!e){u._f.SlerpToRef(i[e],i[e+1],n[e+1]/(n[e]+n[e+1]),t),s=t,o=n[e]+n[e+1],e+=2;continue}o+=n[e],u._f.SlerpToRef(s,i[e],n[e]/o,s),e++}}for(let t=0;t<e.additiveAnimations.length;t++){let i=e.additiveAnimations[t];0!==i.weight&&(s.multiplyToRef(i.currentValue,u.jp.Quaternion[0]),u._f.SlerpToRef(s,u.jp.Quaternion[0],i.weight,s))}return s}(t,a||u._f.Identity());else{let e=0,i=1,n=r&&r._animationState.loopMode===l.fw.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT;if(t.totalWeight<1)a=n?s.clone?s.clone():s:r&&s.scale?s.scale(1-t.totalWeight):r?s*(1-t.totalWeight):s.clone?s.clone():s;else if(r){i=t.totalWeight;let o=r.weight/i;a=1!==o?r.currentValue.scale?r.currentValue.scale(o):r.currentValue*o:r.currentValue,n&&(a.addToRef?a.addToRef(s,a):a+=s),e=1}for(let r=e;r<t.animations.length;r++){let e=t.animations[r],s=e.weight/i;s&&(e.currentValue.scaleAndAddToRef?e.currentValue.scaleAndAddToRef(s,a):a+=e.currentValue*s)}for(let e=0;e<t.additiveAnimations.length;e++){let i=t.additiveAnimations[e],r=i.weight;r&&(i.currentValue.scaleAndAddToRef?i.currentValue.scaleAndAddToRef(r,a):a+=i.currentValue*r)}}i[e]=a}i._lateAnimationHolders={}}e._registeredForLateAnimationBindings.reset()}}(this)},r.prototype.sortActiveAnimatables=function(){this._activeAnimatables.sort((e,t)=>e.playOrder-t.playOrder)},r.prototype.beginWeightedAnimation=function(e,t,i,r=1,s,n=1,a,o,l,c,u=!1){let h=this.beginAnimation(e,t,i,s,n,a,o,!1,l,c,u);return h.weight=r,h},r.prototype.beginAnimation=function(e,t,i,r,s=1,n,a,o=!0,l,c,u=!1){if(s<0){let e=t;t=i,i=e,s=-s}t>i&&(s=-s),o&&this.stopAnimation(e,void 0,l),a||(a=new h(this,e,t,i,r,s,n,void 0,c,u));let d=!l||l(e);if(e.animations&&d&&a.appendAnimations(e,e.animations),e.getAnimatables){let u=e.getAnimatables();for(let e=0;e<u.length;e++)this.beginAnimation(u[e],t,i,r,s,n,a,o,l,c)}return a.reset(),a},r.prototype.beginHierarchyAnimation=function(e,t,i,r,s,n=1,a,o,l=!0,c,u,h=!1){let d=e.getDescendants(t),f=[];for(let t of(f.push(this.beginAnimation(e,i,r,s,n,a,o,l,c,void 0,h)),d))f.push(this.beginAnimation(t,i,r,s,n,a,o,l,c,void 0,h));return f},r.prototype.beginDirectAnimation=function(e,t,i,r,s,n=1,a,o,l=!1){if(n<0){let e=i;i=r,r=e,n=-n}return i>r&&(n=-n),new h(this,e,i,r,s,n,a,t,o,l)},r.prototype.beginDirectHierarchyAnimation=function(e,t,i,r,s,n,a,o,l,c=!1){let u=e.getDescendants(t),h=[];for(let t of(h.push(this.beginDirectAnimation(e,i,r,s,n,a,o,l,c)),u))h.push(this.beginDirectAnimation(t,i,r,s,n,a,o,l,c));return h},r.prototype.getAnimatableByTarget=function(e){for(let t=0;t<this._activeAnimatables.length;t++)if(this._activeAnimatables[t].target===e)return this._activeAnimatables[t];return null},r.prototype.getAllAnimatablesByTarget=function(e){let t=[];for(let i=0;i<this._activeAnimatables.length;i++)this._activeAnimatables[i].target===e&&t.push(this._activeAnimatables[i]);return t},r.prototype.stopAnimation=function(e,t,i){for(let r of this.getAllAnimatablesByTarget(e))r.stop(t,i)},r.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let e=0;e<this._activeAnimatables.length;e++)this._activeAnimatables[e].stop(void 0,void 0,!0);this._activeAnimatables.length=0}for(let e of this.animationGroups)e.stop()})},90247:function(e,t,i){i.d(t,{Mj:function(){return p},S7:function(){return _},XP:function(){return g},cy:function(){return f},fw:function(){return S},j4:function(){return m},sd:function(){return d}});var r=i(39884),s=i(57449),n=i(65330),a=i(7724),o=i(22170),l=i(67020),c=i(33005),u=i(79114),h=i(90212);let d=Object.freeze(new r._f(0,0,0,0)),f=Object.freeze(r.P.Zero()),p=Object.freeze(r.FM.Zero()),m=Object.freeze(c.$.Zero()),_=Object.freeze(s.Wo.Black()),g=Object.freeze(new s.HE(0,0,0,0)),v={key:0,repeatCount:0,loopMode:2};class S{static _PrepareAnimation(e,t,i,n,a,o,l,u){let h;if(!isNaN(parseFloat(a))&&isFinite(a)?h=S.ANIMATIONTYPE_FLOAT:a instanceof r._f?h=S.ANIMATIONTYPE_QUATERNION:a instanceof r.P?h=S.ANIMATIONTYPE_VECTOR3:a instanceof r.FM?h=S.ANIMATIONTYPE_VECTOR2:a instanceof s.Wo?h=S.ANIMATIONTYPE_COLOR3:a instanceof s.HE?h=S.ANIMATIONTYPE_COLOR4:a instanceof c.$&&(h=S.ANIMATIONTYPE_SIZE),void 0==h)return null;let d=new S(e,t,i,h,l);return d.setKeys([{frame:0,value:a},{frame:n,value:o}]),void 0!==u&&d.setEasingFunction(u),d}static CreateAnimation(e,t,i,r){let s=new S(e+"Animation",e,i,t,S.ANIMATIONLOOPMODE_CONSTANT);return s.setEasingFunction(r),s}static CreateAndStartAnimation(e,t,i,r,s,n,a,o,l,c,u){let h=S._PrepareAnimation(e,i,r,s,n,a,o,l);return h&&(t.getScene&&(u=t.getScene()),u)?u.beginDirectAnimation(t,[h],0,s,1===h.loopMode,1,c):null}static CreateAndStartHierarchyAnimation(e,t,i,r,s,n,a,o,l,c,u){let h=S._PrepareAnimation(e,r,s,n,a,o,l,c);return h?t.getScene().beginDirectHierarchyAnimation(t,i,[h],0,n,1===h.loopMode,1,u):null}static CreateMergeAndStartAnimation(e,t,i,r,s,n,a,o,l,c){let u=S._PrepareAnimation(e,i,r,s,n,a,o,l);return u?(t.animations.push(u),t.getScene().beginAnimation(t,0,s,1===u.loopMode,1,c)):null}static MakeAnimationAdditive(e,t,i,s=!1,n){let a;let o=e;if((a="object"==typeof t?t:{referenceFrame:t??0,range:i,cloneOriginalAnimation:s,clonedAnimationName:n}).cloneOriginalAnimation&&((o=e.clone()).name=a.clonedAnimationName||o.name),!o._keys.length)return o;let l=a.referenceFrame&&a.referenceFrame>=0?a.referenceFrame:0,c=0,u=o._keys[0],h=o._keys.length-1,d=o._keys[h],f={referenceValue:u.value,referencePosition:r.jp.Vector3[0],referenceQuaternion:r.jp.Quaternion[0],referenceScaling:r.jp.Vector3[1],keyPosition:r.jp.Vector3[2],keyQuaternion:r.jp.Quaternion[1],keyScaling:r.jp.Vector3[3]},p=u.frame,m=d.frame;if(a.range){let e=o.getRange(a.range);e&&(p=e.from,m=e.to)}else p=a.fromFrame??p,m=a.toFrame??m;if(p!==u.frame&&(c=o.createKeyForFrame(p)),m!==d.frame&&(h=o.createKeyForFrame(m)),1===o._keys.length){let e=o._getKeyValue(o._keys[0]);f.referenceValue=e.clone?e.clone():e}else if(l<=u.frame){let e=o._getKeyValue(u.value);f.referenceValue=e.clone?e.clone():e}else if(l>=d.frame){let e=o._getKeyValue(d.value);f.referenceValue=e.clone?e.clone():e}else{v.key=0;let e=o._interpolate(l,v);f.referenceValue=e.clone?e.clone():e}o.dataType===S.ANIMATIONTYPE_QUATERNION?f.referenceValue.normalize().conjugateInPlace():o.dataType===S.ANIMATIONTYPE_MATRIX&&(f.referenceValue.decompose(f.referenceScaling,f.referenceQuaternion,f.referencePosition),f.referenceQuaternion.normalize().conjugateInPlace());let _=Number.MAX_VALUE,g=a.clipKeys?[]:null;for(let e=c;e<=h;e++){let t=o._keys[e];if((g||a.cloneOriginalAnimation)&&(t={frame:t.frame,value:t.value.clone?t.value.clone():t.value,inTangent:t.inTangent,outTangent:t.outTangent,interpolation:t.interpolation,lockedTangent:t.lockedTangent},g&&(_===Number.MAX_VALUE&&(_=t.frame),t.frame-=_,g.push(t))),!e||o.dataType===S.ANIMATIONTYPE_FLOAT||t.value!==u.value)switch(o.dataType){case S.ANIMATIONTYPE_MATRIX:t.value.decompose(f.keyScaling,f.keyQuaternion,f.keyPosition),f.keyPosition.subtractInPlace(f.referencePosition),f.keyScaling.divideInPlace(f.referenceScaling),f.referenceQuaternion.multiplyToRef(f.keyQuaternion,f.keyQuaternion),r.y3.ComposeToRef(f.keyScaling,f.keyQuaternion,f.keyPosition,t.value);break;case S.ANIMATIONTYPE_QUATERNION:f.referenceValue.multiplyToRef(t.value,t.value);break;case S.ANIMATIONTYPE_VECTOR2:case S.ANIMATIONTYPE_VECTOR3:case S.ANIMATIONTYPE_COLOR3:case S.ANIMATIONTYPE_COLOR4:t.value.subtractToRef(f.referenceValue,t.value);break;case S.ANIMATIONTYPE_SIZE:t.value.width-=f.referenceValue.width,t.value.height-=f.referenceValue.height;break;default:t.value-=f.referenceValue}}return g&&o.setKeys(g,!0),o}static TransitionTo(e,t,i,r,s,n,a,o=null){if(a<=0)return i[e]=t,o&&o(),null;let l=a/1e3*s;n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:l,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);let c=r.beginAnimation(i,0,l,!1);return c.onAnimationEnd=o,c}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(let e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}constructor(e,t,i,r,s,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=r,this.loopMode=s,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=[],this._events=[],this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=r,this.loopMode=void 0===s?S.ANIMATIONLOOPMODE_CYCLE:s,this.uniqueId=S._UniqueIdGenerator++}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType]+", nKeys: "+(this._keys?this._keys.length:"none")+", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let e=!0;for(let i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((e,t)=>e.frame-t.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new o.X(e,t,i))}deleteRange(e,t=!0){let i=this._ranges[e];if(i){if(t){let e=i.from,t=i.to;for(let i=this._keys.length-1;i>=0;i--)this._keys[i].frame>=e&&this._keys[i].frame<=t&&this._keys.splice(i,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return(0,n.Lerp)(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,r,s){return(0,n.Hermite)(e,t,i,r,s)}quaternionInterpolateFunction(e,t,i){return r._f.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,n){return r._f.Hermite(e,t,i,s,n).normalize()}vector3InterpolateFunction(e,t,i){return r.P.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,n){return r.P.Hermite(e,t,i,s,n)}vector2InterpolateFunction(e,t,i){return r.FM.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,n){return r.FM.Hermite(e,t,i,s,n)}sizeInterpolateFunction(e,t,i){return c.$.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return s.Wo.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,r,n){return s.Wo.Hermite(e,t,i,r,n)}color4InterpolateFunction(e,t,i){return s.HE.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,r,n){return s.HE.Hermite(e,t,i,r,n)}_getKeyValue(e){return"function"==typeof e?e():e}evaluate(e){return v.key=0,this._interpolate(e,v)}_interpolate(e,t,i=!1){if(t.loopMode===S.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;let r=this._keys,s=r.length,n=t.key;for(;n>=0&&e<r[n].frame;)--n;for(;n+1<=s-1&&e>=r[n+1].frame;)++n;if(t.key=n,n<0)return i?void 0:this._getKeyValue(r[0].value);if(n+1>s-1)return i?void 0:this._getKeyValue(r[s-1].value);let a=r[n],o=r[n+1];if(i&&(e===a.frame||e===o.frame))return;let l=this._getKeyValue(a.value),c=this._getKeyValue(o.value);if(1===a.interpolation)return o.frame>e?l:c;let u=void 0!==a.outTangent&&void 0!==o.inTangent,h=o.frame-a.frame,v=(e-a.frame)/h,x=a.easingFunction||this.getEasingFunction();switch(null!==x&&(v=x.ease(v)),this.dataType){case S.ANIMATIONTYPE_FLOAT:{let e=u?this.floatInterpolateFunctionWithTangents(l,a.outTangent*h,c,o.inTangent*h,v):this.floatInterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return(t.offsetValue??0)*t.repeatCount+e}break}case S.ANIMATIONTYPE_QUATERNION:{let e=u?this.quaternionInterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),v):this.quaternionInterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:break;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.addInPlace((t.offsetValue||d).scale(t.repeatCount))}return e}case S.ANIMATIONTYPE_VECTOR3:{let e=u?this.vector3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),v):this.vector3InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||f).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_VECTOR2:{let e=u?this.vector2InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),v):this.vector2InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||p).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_SIZE:switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return this.sizeInterpolateFunction(l,c,v);case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return this.sizeInterpolateFunction(l,c,v).add((t.offsetValue||m).scale(t.repeatCount))}break;case S.ANIMATIONTYPE_COLOR3:{let e=u?this.color3InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),v):this.color3InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||_).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_COLOR4:{let e=u?this.color4InterpolateFunctionWithTangents(l,a.outTangent.scale(h),c,o.inTangent.scale(h),v):this.color4InterpolateFunction(l,c,v);switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:return e;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return e.add((t.offsetValue||g).scale(t.repeatCount))}break}case S.ANIMATIONTYPE_MATRIX:switch(t.loopMode){case S.ANIMATIONLOOPMODE_CYCLE:case S.ANIMATIONLOOPMODE_CONSTANT:case S.ANIMATIONLOOPMODE_YOYO:if(S.AllowMatricesInterpolation)return this.matrixInterpolateFunction(l,c,v,t.workValue);return l;case S.ANIMATIONLOOPMODE_RELATIVE:case S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT:return l}}return 0}matrixInterpolateFunction(e,t,i,s){return S.AllowMatrixDecomposeForInterpolation?s?(r.y3.DecomposeLerpToRef(e,t,i,s),s):r.y3.DecomposeLerp(e,t,i):s?(r.y3.LerpToRef(e,t,i,s),s):r.y3.Lerp(e,t,i)}clone(){let e=new S(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges)for(let t in e._ranges={},this._ranges){let i=this._ranges[t];i&&(e._ranges[t]=i.clone())}return e}setKeys(e,t=!1){this._keys=t?e:e.slice(0)}createKeyForFrame(e){v.key=0;let t=this._interpolate(e,v,!0);if(!t)return this._keys[v.key].frame===e?v.key:v.key+1;let i={frame:e,value:t.clone?t.clone():t};return this._keys.splice(v.key+1,0,i),v.key+1}serialize(){let e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;let t=this.dataType;e.keys=[];let i=this.getKeys();for(let r=0;r<i.length;r++){let s=i[r],n={};switch(n.frame=s.frame,t){case S.ANIMATIONTYPE_FLOAT:n.values=[s.value],void 0!==s.inTangent&&n.values.push(s.inTangent),void 0!==s.outTangent&&(void 0===s.inTangent&&n.values.push(void 0),n.values.push(s.outTangent)),void 0!==s.interpolation&&(void 0===s.inTangent&&n.values.push(void 0),void 0===s.outTangent&&n.values.push(void 0),n.values.push(s.interpolation));break;case S.ANIMATIONTYPE_QUATERNION:case S.ANIMATIONTYPE_MATRIX:case S.ANIMATIONTYPE_VECTOR3:case S.ANIMATIONTYPE_COLOR3:case S.ANIMATIONTYPE_COLOR4:n.values=s.value.asArray(),void 0!=s.inTangent&&n.values.push(s.inTangent.asArray()),void 0!=s.outTangent&&(void 0===s.inTangent&&n.values.push(void 0),n.values.push(s.outTangent.asArray())),void 0!==s.interpolation&&(void 0===s.inTangent&&n.values.push(void 0),void 0===s.outTangent&&n.values.push(void 0),n.values.push(s.interpolation))}e.keys.push(n)}for(let t in e.ranges=[],this._ranges){let i=this._ranges[t];if(!i)continue;let r={};r.name=t,r.from=i.from,r.to=i.to,e.ranges.push(r)}return e}static _UniversalLerp(e,t,i){let r=e.constructor;return r.Lerp?r.Lerp(e,t,i):r.Slerp?r.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){let t,i;let n=new S(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),a=e.dataType,o=[];for(e.enableBlending&&(n.enableBlending=e.enableBlending),e.blendingSpeed&&(n.blendingSpeed=e.blendingSpeed),i=0;i<e.keys.length;i++){let n,l,c;let u=e.keys[i];switch(a){case S.ANIMATIONTYPE_FLOAT:t=u.values[0],u.values.length>=2&&(n=u.values[1]),u.values.length>=3&&(l=u.values[2]),u.values.length>=4&&(c=u.values[3]);break;case S.ANIMATIONTYPE_QUATERNION:if(t=r._f.FromArray(u.values),u.values.length>=8){let e=r._f.FromArray(u.values.slice(4,8));e.equals(r._f.Zero())||(n=e)}if(u.values.length>=12){let e=r._f.FromArray(u.values.slice(8,12));e.equals(r._f.Zero())||(l=e)}u.values.length>=13&&(c=u.values[12]);break;case S.ANIMATIONTYPE_MATRIX:t=r.y3.FromArray(u.values),u.values.length>=17&&(c=u.values[16]);break;case S.ANIMATIONTYPE_COLOR3:t=s.Wo.FromArray(u.values),u.values[3]&&(n=s.Wo.FromArray(u.values[3])),u.values[4]&&(l=s.Wo.FromArray(u.values[4])),u.values[5]&&(c=u.values[5]);break;case S.ANIMATIONTYPE_COLOR4:t=s.HE.FromArray(u.values),u.values[4]&&(n=s.HE.FromArray(u.values[4])),u.values[5]&&(l=s.HE.FromArray(u.values[5])),u.values[6]&&(c=s.HE.FromArray(u.values[6]));break;case S.ANIMATIONTYPE_VECTOR3:default:t=r.P.FromArray(u.values),u.values[3]&&(n=r.P.FromArray(u.values[3])),u.values[4]&&(l=r.P.FromArray(u.values[4])),u.values[5]&&(c=u.values[5])}let h={};h.frame=u.frame,h.value=t,void 0!=n&&(h.inTangent=n),void 0!=l&&(h.outTangent=l),void 0!=c&&(h.interpolation=c),o.push(h)}if(n.setKeys(o),e.ranges)for(i=0;i<e.ranges.length;i++)t=e.ranges[i],n.createRange(t.name,t.from,t.to);return n}static AppendSerializedAnimations(e,t){h.p.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,r)=>{let s=new u.g;s.addEventListener("readystatechange",()=>{if(4==s.readyState){if(200==s.status){let t=JSON.parse(s.responseText);if(t.animations&&(t=t.animations),t.length){let e=[];for(let i of t)e.push(this.Parse(i));i(e)}else{let r=this.Parse(t);e&&(r.name=e),i(r)}}else r("Unable to load the animation")}}),s.open("GET",t),s.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{let r=new u.g;r.addEventListener("readystatechange",()=>{if(4==r.readyState){if(200==r.status){let i=JSON.parse(JSON.parse(r.responseText).jsonPayload);if(i.animations){let r=JSON.parse(i.animations),s=[];for(let t of r.animations){let i=this.Parse(t);i.snippetId=e,s.push(i)}t(s)}else{let r=JSON.parse(i.animation),s=this.Parse(r);s.snippetId=e,t(s)}}else i("Unable to load the snippet "+e)}}),r.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),r.send()})}}S._UniqueIdGenerator=0,S.AllowMatricesInterpolation=!1,S.AllowMatrixDecomposeForInterpolation=!0,S.SnippetUrl="https://snippet.babylonjs.com",S.ANIMATIONTYPE_FLOAT=0,S.ANIMATIONTYPE_VECTOR3=1,S.ANIMATIONTYPE_QUATERNION=2,S.ANIMATIONTYPE_MATRIX=3,S.ANIMATIONTYPE_COLOR3=4,S.ANIMATIONTYPE_COLOR4=7,S.ANIMATIONTYPE_VECTOR2=5,S.ANIMATIONTYPE_SIZE=6,S.ANIMATIONLOOPMODE_RELATIVE=0,S.ANIMATIONLOOPMODE_CYCLE=1,S.ANIMATIONLOOPMODE_CONSTANT=2,S.ANIMATIONLOOPMODE_YOYO=4,S.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT=5,S.CreateFromSnippetAsync=S.ParseFromSnippetAsync,(0,a.H7)("BABYLON.Animation",S),l.N._AnimationRangeFactory=(e,t,i)=>new o.X(e,t,i)},18003:function(e,t,i){i.d(t,{O:function(){return l}});var r=i(90247),s=i(82877),n=i(51092),a=i(88388);i(35488);class o{getClassName(){return"TargetedAnimation"}serialize(){let e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class l{get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this.syncWithMask(!0))}syncWithMask(e=!1){if(!this.mask&&!e){this._numActiveAnimatables=this._targetedAnimations.length;return}this._numActiveAnimatables=0;for(let e=0;e<this._animatables.length;++e){let t=this._animatables[e];!this.mask||this.mask.disabled||this.mask.retainsTarget(t.target.name)?(this._numActiveAnimatables++,t.paused&&t.restart()):t.paused||t.pause()}}removeUnmaskedAnimations(){if(this.mask&&!this.mask.disabled){for(let e=0;e<this._animatables.length;++e){let t=this._animatables[e];!this.mask.retainsTarget(t.target.name)&&(t.stop(),this._animatables.splice(e,1),--e)}for(let e=0;e<this._targetedAnimations.length;e++){let t=this._targetedAnimations[e];!this.mask.retainsTarget(t.target.name)&&(this._targetedAnimations.splice(e,1),--e)}}}get from(){return this._from}set from(e){if(this._from!==e){this._from=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].fromFrame=this._from}}get to(){return this._to}set to(e){if(this._to!==e){this._to=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].toFrame=this._to}}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].speedRatio=this._speedRatio}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].loopAnimation=this._loopAnimation}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let e=0;e<this._animatables.length;e++)this._animatables[e].isAdditive=this._isAdditive}}get weight(){return this._weight}set weight(e){this._weight!==e&&(this._weight=e,this.setWeightForAllAnimatables(this._weight))}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}get playOrder(){return this._playOrder}set playOrder(e){if(this._playOrder!==e&&(this._playOrder=e,this._animatables.length>0)){for(let e=0;e<this._animatables.length;e++)this._animatables[e].playOrder=this._playOrder;this._scene.sortActiveAnimatables()}}get enableBlending(){return this._enableBlending}set enableBlending(e){if(this._enableBlending!==e&&(this._enableBlending=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.enableBlending=e}get blendingSpeed(){return this._blendingSpeed}set blendingSpeed(e){if(this._blendingSpeed!==e&&(this._blendingSpeed=e,null!==e))for(let t=0;t<this._targetedAnimations.length;++t)this._targetedAnimations[t].animation.blendingSpeed=e}getLength(e,t){e=e??this._from,t=t??this._to;let i=this.targetedAnimations[0].animation.framePerSecond*this._speedRatio;return(t-e)/i}static MergeAnimationGroups(e,t=!0,i=!1,r){if(0===e.length)return null;r=r??e[0].weight;let s=Number.MAX_VALUE,n=-Number.MAX_VALUE;if(i)for(let t of e)t.from<s&&(s=t.from),t.to>n&&(n=t.to);let a=new l(e[0].name+"_merged",e[0]._scene,r);for(let r of e){for(let e of(i&&r.normalize(s,n),r.targetedAnimations))a.addTargetedAnimation(e.animation,e.target);t&&r.dispose()}return a}constructor(e,t=null,i=-1,r=0){this.name=e,this._targetedAnimations=[],this._animatables=[],this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._weight=-1,this._playOrder=0,this._enableBlending=null,this._blendingSpeed=null,this._numActiveAnimatables=0,this._shouldStart=!0,this._parentContainer=null,this.onAnimationEndObservable=new s.y$,this.onAnimationLoopObservable=new s.y$,this.onAnimationGroupLoopObservable=new s.y$,this.onAnimationGroupEndObservable=new s.y$,this.onAnimationGroupPauseObservable=new s.y$,this.onAnimationGroupPlayObservable=new s.y$,this.metadata=null,this._mask=null,this._animationLoopFlags=[],this._scene=t||n.l.LastCreatedScene,this._weight=i,this._playOrder=r,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}addTargetedAnimation(e,t){let i=new o;i.animation=e,i.target=t;let r=e.getKeys();return this._from>r[0].frame&&(this._from=r[0].frame),this._to<r[r.length-1].frame&&(this._to=r[r.length-1].frame),null!==this._enableBlending&&(e.enableBlending=this._enableBlending),null!==this._blendingSpeed&&(e.blendingSpeed=this._blendingSpeed),this._targetedAnimations.push(i),this._shouldStart=!0,i}removeTargetedAnimation(e){for(let t=this._targetedAnimations.length-1;t>-1;t--)this._targetedAnimations[t].animation===e&&this._targetedAnimations.splice(t,1)}normalize(e=null,t=null){null==e&&(e=this._from),null==t&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){let r=this._targetedAnimations[i].animation.getKeys(),s=r[0],n=r[r.length-1];if(s.frame>e){let t={frame:e,value:s.value,inTangent:s.inTangent,outTangent:s.outTangent,interpolation:s.interpolation};r.splice(0,0,t)}if(n.frame<t){let e={frame:t,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};r.push(e)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),this._animationLoopFlags[i]||(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount!==this._numActiveAnimatables||(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,r,s){if(this._isStarted||0===this._targetedAnimations.length)return this;this._loopAnimation=e,this._shouldStart=!1,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){let a=this._targetedAnimations[n],o=this._scene.beginDirectAnimation(a.target,[a.animation],void 0!==i?i:this._from,void 0!==r?r:this._to,e,t,void 0,void 0,void 0!==s?s:this._isAdditive);o.weight=this._weight,o.playOrder=this._playOrder,o.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(a),this._checkAnimationGroupEnded(o)},this._processLoop(o,a,n),this._animatables.push(o)}return this.syncWithMask(),this._scene.sortActiveAnimatables(),this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length&&!this._shouldStart?(void 0!==e&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(!0),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.syncWithMask(),this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(e=!1){if(!this._isStarted)return this;let t=this._animatables.slice();for(let i=0;i<t.length;i++)t[i].stop(void 0,void 0,!0,e);let i=0;for(let t=0;t<this._scene._activeAnimatables.length;t++){let r=this._scene._activeAnimatables[t];r._runtimeAnimations.length>0?this._scene._activeAnimatables[i++]=r:e&&this._checkAnimationGroupEnded(r,e)}return this._scene._activeAnimatables.length=i,this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].weight=e;return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}getCurrentFrame(){return this.animatables[0]?.masterFrame||0}dispose(){this.isStarted&&this.stop(),this._targetedAnimations.length=0,this._animatables.length=0;let e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){let e=this._parentContainer.animationGroups.indexOf(this);e>-1&&this._parentContainer.animationGroups.splice(e,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e,t=!1){let i=this._animatables.indexOf(e);i>-1&&this._animatables.splice(i,1),0!==this._animatables.length||(this._isStarted=!1,t||this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){let r=new l(e||this.name,this._scene,this._weight,this._playOrder);for(let e of(r._from=this.from,r._to=this.to,r._speedRatio=this.speedRatio,r._loopAnimation=this.loopAnimation,r._isAdditive=this.isAdditive,r._enableBlending=this.enableBlending,r._blendingSpeed=this.blendingSpeed,r.metadata=this.metadata,r.mask=this.mask,this._targetedAnimations))r.addTargetedAnimation(i?e.animation.clone():e.animation,t?t(e.target):e.target);return r}serialize(){let e={};e.name=this.name,e.from=this.from,e.to=this.to,e.speedRatio=this.speedRatio,e.loopAnimation=this.loopAnimation,e.isAdditive=this.isAdditive,e.weight=this.weight,e.playOrder=this.playOrder,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){let i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return a.$&&a.$.HasTags(this)&&(e.tags=a.$.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){let i=new l(e.name,t,e.weight,e.playOrder);for(let s=0;s<e.targetedAnimations.length;s++){let n=e.targetedAnimations[s],a=r.fw.Parse(n.animation),o=n.targetId;if("influence"===n.animation.property){let e=t.getMorphTargetById(o);e&&i.addTargetedAnimation(a,e)}else{let e=t.getNodeById(o);null!=e&&i.addTargetedAnimation(a,e)}}return a.$&&a.$.AddTagsTo(i,e.tags),null!==e.from&&null!==e.to&&i.normalize(e.from,e.to),void 0!==e.speedRatio&&(i._speedRatio=e.speedRatio),void 0!==e.loopAnimation&&(i._loopAnimation=e.loopAnimation),void 0!==e.isAdditive&&(i._isAdditive=e.isAdditive),void 0!==e.weight&&(i._weight=e.weight),void 0!==e.playOrder&&(i._playOrder=e.playOrder),void 0!==e.enableBlending&&(i._enableBlending=e.enableBlending),void 0!==e.blendingSpeed&&(i._blendingSpeed=e.blendingSpeed),void 0!==e.metadata&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t,i,s=!1,n){let a;let o=e;(a="object"==typeof t?t:{referenceFrame:t,range:i,cloneOriginalAnimationGroup:s,clonedAnimationName:n}).cloneOriginalAnimationGroup&&(o=e.clone(a.clonedAnimationGroupName||o.name));let l=o.targetedAnimations;for(let e=0;e<l.length;e++){let t=l[e];t.animation=r.fw.MakeAnimationAdditive(t.animation,a)}if(o.isAdditive=!0,a.clipKeys){let e=Number.MAX_VALUE,t=-Number.MAX_VALUE,i=o.targetedAnimations;for(let r=0;r<i.length;r++){let s=i[r].animation.getKeys();e>s[0].frame&&(e=s[0].frame),t<s[s.length-1].frame&&(t=s[s.length-1].frame)}o._from=e,o._to=t}return o}static ClipKeys(e,t,i,r,s){let n=e.clone(r||e.name);return l.ClipKeysInPlace(n,t,i,s)}static ClipKeysInPlace(e,t,i,r){return l.ClipInPlace(e,t,i,r,!1)}static ClipFrames(e,t,i,r,s){let n=e.clone(r||e.name);return l.ClipFramesInPlace(n,t,i,s)}static ClipFramesInPlace(e,t,i,r){return l.ClipInPlace(e,t,i,r,!0)}static ClipInPlace(e,t,i,r,s=!1){let n=Number.MAX_VALUE,a=-Number.MAX_VALUE,o=e.targetedAnimations;for(let e=0;e<o.length;e++){let l=o[e],c=r?l.animation:l.animation.clone();s&&(c.createKeyForFrame(t),c.createKeyForFrame(i));let u=c.getKeys(),h=[],d=Number.MAX_VALUE;for(let e=0;e<u.length;e++){let r=u[e];if(!s&&e>=t&&e<=i||s&&r.frame>=t&&r.frame<=i){let e={frame:r.frame,value:r.value.clone?r.value.clone():r.value,inTangent:r.inTangent,outTangent:r.outTangent,interpolation:r.interpolation,lockedTangent:r.lockedTangent};d===Number.MAX_VALUE&&(d=e.frame),e.frame-=d,h.push(e)}}if(0===h.length){o.splice(e,1),e--;continue}n>h[0].frame&&(n=h[0].frame),a<h[h.length-1].frame&&(a=h[h.length-1].frame),c.setKeys(h,!0),l.animation=c}return e._from=n,e._to=a,e}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from+", to: "+this._to+", isStarted: "+this._isStarted+", speedRatio: "+this._speedRatio+", targetedAnimations length: "+this._targetedAnimations.length+", animatables length: "+this._animatables),t}}},22170:function(e,t,i){i.d(t,{X:function(){return r}});class r{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new r(this.name,this.from,this.to)}}},28116:function(e,t,i){i.d(t,{o:function(){return n}});var r=i(39884),s=i(90247);class n{get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}constructor(e,t,i,n){if(this._events=[],this._currentFrame=0,this._originalValue=[],this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._absoluteFrameOffset=0,this._previousElapsedTime=0,this._yoyoDirection=1,this._previousAbsoluteFrame=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=n,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===s.fw.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=r.y3.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,0!==this._minFrame){let e={frame:0,value:this._minValue};this._keys.splice(0,0,e)}if(this._target instanceof Array){let e=0;for(let t of this._target)this._preparePath(t,e),this._getOriginalValues(e),e++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];let a=t.getEvents();a&&a.length>0&&a.forEach(e=>{this._events.push(e._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}_preparePath(e,t=0){let i=this._animation.targetPropertyPath;if(i.length>1){let r=e;for(let e=0;e<i.length-1;e++){let t=i[e];if(void 0===(r=r[t]))throw Error(`Invalid property (${t}) in property path (${i.join(".")})`)}this._targetPath=i[i.length-1],this._activeTargets[t]=r}else this._targetPath=i[0],this._activeTargets[t]=e;if(void 0===this._activeTargets[t][this._targetPath])throw Error(`Invalid property (${this._targetPath}) in property path (${i.join(".")})`)}get animation(){return this._animation}reset(e=!1){if(e){if(this._target instanceof Array){let e=0;for(let t of this._target)void 0!==this._originalValue[e]&&this._setValue(t,this._activeTargets[e],this._originalValue[e],-1,e),e++}else void 0!==this._originalValue[0]&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0)}this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let e=0;e<this._events.length;e++)this._events[e].isDone=!1}isStopped(){return this._stopped}dispose(){let e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){let r=this._target[i];this._setValue(r,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;let i=this._activeTargets[e];(t=i.getLocalMatrix&&"_matrix"===this._targetPath?i.getLocalMatrix():i[this._targetPath])&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_registerTargetForLateAnimationBinding(e,t){let i=e.target;this._scene._registeredForLateAnimationBindings.pushNoDuplicate(i),i._lateAnimationHolders||(i._lateAnimationHolders={}),i._lateAnimationHolders[e.targetPath]||(i._lateAnimationHolders[e.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:t}),e.isAdditive?(i._lateAnimationHolders[e.targetPath].additiveAnimations.push(e),i._lateAnimationHolders[e.targetPath].totalAdditiveWeight+=e.weight):(i._lateAnimationHolders[e.targetPath].animations.push(e),i._lateAnimationHolders[e.targetPath].totalWeight+=e.weight)}_setValue(e,t,i,n,a){if(this._currentActiveTarget=t,this._weight=n,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){let e=t[this._targetPath];e.clone?this._originalBlendValue=e.clone():this._originalBlendValue=e}this._originalBlendValue.m?s.fw.AllowMatrixDecomposeForInterpolation?this._currentValue?r.y3.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=r.y3.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?r.y3.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=r.y3.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=s.fw._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);let n=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=n}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i?.clone?this._currentValue=i.clone():this._currentValue=i;-1!==n?this._registerTargetForLateAnimationBinding(this,this._originalValue[a]):this._animationState.loopMode===s.fw.ANIMATIONLOOPMODE_RELATIVE_FROM_CURRENT?this._currentValue.addToRef?this._currentValue.addToRef(this._originalValue[a],t[this._targetPath]):t[this._targetPath]=this._originalValue[a]+this._currentValue:t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e,t=-1){let i=this._animation.getKeys();e<i[0].frame?e=i[0].frame:e>i[i.length-1].frame&&(e=i[i.length-1].frame);let r=this._events;if(r.length)for(let t=0;t<r.length;t++)r[t].onlyOnce||(r[t].isDone=r[t].frame<e);this._currentFrame=e;let s=this._animation._interpolate(e,this._animationState);this.setValue(s,t)}_prepareForSpeedRatioChange(e){let t=this._previousElapsedTime*(this._animation.framePerSecond*e)/1e3;this._absoluteFrameOffset=this._previousAbsoluteFrame-t}animate(e,t,i,r,n,a=-1){let o,l;let c=this._animation,u=c.targetPropertyPath;if(!u||u.length<1)return this._stopped=!0,!1;let h=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);let d=i-t,f=c.framePerSecond*n*e/1e3+this._absoluteFrameOffset,p=0,m=!1,_=r&&this._animationState.loopMode===s.fw.ANIMATIONLOOPMODE_YOYO;if(_){let e=Math.sin((f-t)/d*Math.PI);f=Math.abs(e)*d+t;let i=e>=0?1:-1;this._yoyoDirection!==i&&(m=!0),this._yoyoDirection=i}if(this._previousElapsedTime=e,this._previousAbsoluteFrame=f,!r&&i>=t&&(f>=d&&n>0||f<=0&&n<0))h=!1,p=c._getKeyValue(this._maxValue);else if(!r&&t>=i&&(f<=d&&n<0||f>=0&&n>0))h=!1,p=c._getKeyValue(this._minValue);else if(this._animationState.loopMode!==s.fw.ANIMATIONLOOPMODE_CYCLE){let e=i.toString()+t.toString();if(!this._offsetsCache[e]){this._animationState.repeatCount=0,this._animationState.loopMode=s.fw.ANIMATIONLOOPMODE_CYCLE;let r=c._interpolate(t,this._animationState),n=c._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),c.dataType){case s.fw.ANIMATIONTYPE_FLOAT:this._offsetsCache[e]=n-r;break;case s.fw.ANIMATIONTYPE_QUATERNION:case s.fw.ANIMATIONTYPE_VECTOR3:case s.fw.ANIMATIONTYPE_VECTOR2:case s.fw.ANIMATIONTYPE_SIZE:case s.fw.ANIMATIONTYPE_COLOR3:this._offsetsCache[e]=n.subtract(r)}this._highLimitsCache[e]=n}p=this._highLimitsCache[e],o=this._offsetsCache[e]}if(void 0===o)switch(c.dataType){case s.fw.ANIMATIONTYPE_FLOAT:o=0;break;case s.fw.ANIMATIONTYPE_QUATERNION:o=s.sd;break;case s.fw.ANIMATIONTYPE_VECTOR3:o=s.cy;break;case s.fw.ANIMATIONTYPE_VECTOR2:o=s.Mj;break;case s.fw.ANIMATIONTYPE_SIZE:o=s.j4;break;case s.fw.ANIMATIONTYPE_COLOR3:o=s.S7;break;case s.fw.ANIMATIONTYPE_COLOR4:o=s.XP}if(this._host&&this._host.syncRoot){let e=this._host.syncRoot,i=(e.masterFrame-e.fromFrame)/(e.toFrame-e.fromFrame);l=t+d*i}else l=f>0&&t>i||f<0&&t<i?h&&0!==d?i+f%d:t:h&&0!==d?t+f%d:i;let g=this._events;if(!_&&(n>0&&this.currentFrame>l||n<0&&this.currentFrame<l)||_&&m){this._onLoop();for(let e=0;e<g.length;e++)g[e].onlyOnce||(g[e].isDone=!1);this._animationState.key=n>0?0:c.getKeys().length-1}this._currentFrame=l,this._animationState.repeatCount=0===d?0:f/d>>0,this._animationState.highLimitValue=p,this._animationState.offsetValue=o;let v=c._interpolate(l,this._animationState);if(this.setValue(v,a),g.length){for(let e=0;e<g.length;e++)if(d>=0&&l>=g[e].frame&&g[e].frame>=t||d<0&&l<=g[e].frame&&g[e].frame<=t){let t=g[e];t.isDone||(t.onlyOnce&&(g.splice(e,1),e--),t.isDone=!0,t.action(l))}}return h||(this._stopped=!0),h}}},84903:function(e,t,i){i.d(t,{N:function(){return c}});var r=i(44755),s=i(74909),n=i(39884),a=i(82877),o=i(3860),l=i(35910);class c{constructor(){this._attachedToElement=!1,this._virtualMeshesInfo={},this._tmpVector=new n.P,this._tmpQuaternion=new n._f,this._dragType={NONE:0,DRAG:1,DRAG_WITH_CONTROLLER:2,NEAR_DRAG:3},this._moving=!1,this._dragging=this._dragType.NONE,this.draggableMeshes=null,this.zDragFactor=3,this.currentDraggingPointerIds=[],this.detachCameraControls=!0,this.onDragStartObservable=new a.y$,this.onDragObservable=new a.y$,this.onDragEndObservable=new a.y$,this.allowMultiPointer=!0}get currentDraggingPointerId(){return void 0!==this.currentDraggingPointerIds[0]?this.currentDraggingPointerIds[0]:-1}set currentDraggingPointerId(e){this.currentDraggingPointerIds[0]=e}get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}get name(){return"BaseSixDofDrag"}get isMoving(){return this._moving}init(){}get _pointerCamera(){return this._scene.cameraToUseForPointers?this._scene.cameraToUseForPointers:this._scene.activeCamera}_createVirtualMeshInfo(){let e=new o.Y("",c._virtualScene);e.rotationQuaternion=new n._f;let t=new o.Y("",c._virtualScene);t.rotationQuaternion=new n._f;let i=new o.Y("",c._virtualScene);return i.rotationQuaternion=new n._f,{dragging:!1,moving:!1,dragMesh:e,originMesh:t,pivotMesh:i,startingPivotPosition:new n.P,startingPivotOrientation:new n._f,startingPosition:new n.P,startingOrientation:new n._f,lastOriginPosition:new n.P,lastDragPosition:new n.P}}_resetVirtualMeshesPosition(){for(let e=0;e<this.currentDraggingPointerIds.length;e++)this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPivotOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].pivotMesh.rotationQuaternion),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingPosition.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.position),this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].startingOrientation.copyFrom(this._virtualMeshesInfo[this.currentDraggingPointerIds[e]].dragMesh.rotationQuaternion)}_pointerUpdate2D(e,t,i){!this._pointerCamera||this._pointerCamera.cameraRigMode!=l.V.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||(e.origin.copyFrom(this._pointerCamera.globalPosition),i=0);let r=this._virtualMeshesInfo[t],s=n.jp.Vector3[0];e.origin.subtractToRef(r.lastOriginPosition,s),r.lastOriginPosition.copyFrom(e.origin);let a=-n.P.Dot(s,e.direction);r.originMesh.addChild(r.dragMesh),r.originMesh.addChild(r.pivotMesh),this._applyZOffset(r.dragMesh,a,i),this._applyZOffset(r.pivotMesh,a,i),r.originMesh.position.copyFrom(e.origin);let o=n.jp.Vector3[0];e.origin.addToRef(e.direction,o),r.originMesh.lookAt(o),r.originMesh.removeChild(r.dragMesh),r.originMesh.removeChild(r.pivotMesh)}_pointerUpdateXR(e,t,i,r){let s=this._virtualMeshesInfo[i];if(s.originMesh.position.copyFrom(e.position),this._dragging===this._dragType.NEAR_DRAG&&t?s.originMesh.rotationQuaternion.copyFrom(t.rotationQuaternion):s.originMesh.rotationQuaternion.copyFrom(e.rotationQuaternion),s.pivotMesh.computeWorldMatrix(!0),s.dragMesh.computeWorldMatrix(!0),0!==r){let e=n.jp.Vector3[0],t=n.jp.Vector3[1];e.copyFrom(this._pointerCamera.getForwardRay().direction),s.originMesh.position.subtractToRef(s.lastOriginPosition,t),s.lastOriginPosition.copyFrom(s.originMesh.position);let i=t.length();t.normalize();let a=n.jp.Vector3[2],o=n.jp.Vector3[3];s.dragMesh.absolutePosition.subtractToRef(this._pointerCamera.globalPosition,a),s.dragMesh.absolutePosition.subtractToRef(s.originMesh.position,o);let l=o.length();a.normalize(),o.normalize();let c=Math.abs(n.P.Dot(t,o))*n.P.Dot(t,e)*r*i*l;c<0&&.01-l>c&&(c=Math.min(.01-l,0)),o.scaleInPlace(c),o.addToRef(s.pivotMesh.absolutePosition,this._tmpVector),s.pivotMesh.setAbsolutePosition(this._tmpVector),o.addToRef(s.dragMesh.absolutePosition,this._tmpVector),s.dragMesh.setAbsolutePosition(this._tmpVector)}}attach(e){this._ownerNode=e,this._scene=this._ownerNode.getScene(),c._virtualScene||(c._virtualScene=new r.x(this._scene.getEngine(),{virtual:!0}),c._virtualScene.detachControl());let t=e=>this._ownerNode===e||e.isDescendantOf(this._ownerNode)&&(!this.draggableMeshes||-1!==this.draggableMeshes.indexOf(e));this._pointerObserver=this._scene.onPointerObservable.add(e=>{let i=e.event.pointerId;this._virtualMeshesInfo[i]||(this._virtualMeshesInfo[i]=this._createVirtualMeshInfo());let r=this._virtualMeshesInfo[i],n="xr-near"===e.event.pointerType||"xr"===e.event.pointerType;if(e.type==s.kD.POINTERDOWN){if(!r.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&(!n||e.pickInfo.aimTransform)&&t(e.pickInfo.pickedMesh)){if((!this.allowMultiPointer||n)&&this.currentDraggingPointerIds.length>0)return;!this._pointerCamera||this._pointerCamera.cameraRigMode!==l.V.RIG_MODE_NONE||this._pointerCamera._isLeftCamera||this._pointerCamera._isRightCamera||e.pickInfo.ray.origin.copyFrom(this._pointerCamera.globalPosition),this._ownerNode.computeWorldMatrix(!0);let t=this._virtualMeshesInfo[i];n?(this._dragging=e.pickInfo.originMesh?this._dragType.NEAR_DRAG:this._dragType.DRAG_WITH_CONTROLLER,t.originMesh.position.copyFrom(e.pickInfo.aimTransform.position),this._dragging===this._dragType.NEAR_DRAG&&e.pickInfo.gripTransform?t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.gripTransform.rotationQuaternion):t.originMesh.rotationQuaternion.copyFrom(e.pickInfo.aimTransform.rotationQuaternion)):(this._dragging=this._dragType.DRAG,t.originMesh.position.copyFrom(e.pickInfo.ray.origin)),t.lastOriginPosition.copyFrom(t.originMesh.position),t.dragMesh.position.copyFrom(e.pickInfo.pickedPoint),t.lastDragPosition.copyFrom(e.pickInfo.pickedPoint),t.pivotMesh.position.copyFrom(this._ownerNode.getAbsolutePivotPoint()),t.pivotMesh.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),t.startingPosition.copyFrom(t.dragMesh.position),t.startingPivotPosition.copyFrom(t.pivotMesh.position),t.startingOrientation.copyFrom(t.dragMesh.rotationQuaternion),t.startingPivotOrientation.copyFrom(t.pivotMesh.rotationQuaternion),n?(t.originMesh.addChild(t.dragMesh),t.originMesh.addChild(t.pivotMesh)):t.originMesh.lookAt(t.dragMesh.position),t.dragging=!0,-1===this.currentDraggingPointerIds.indexOf(i)&&this.currentDraggingPointerIds.push(i),this.detachCameraControls&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._pointerCamera.inputs&&this._pointerCamera.inputs.attachedToElement?(this._pointerCamera.detachControl(),this._attachedToElement=!0):this.allowMultiPointer&&0!==this.currentDraggingPointerIds.length||(this._attachedToElement=!1)),this._targetDragStart(t.pivotMesh.position,t.pivotMesh.rotationQuaternion,i),this.onDragStartObservable.notifyObservers({position:t.pivotMesh.position})}}else if(e.type==s.kD.POINTERUP||e.type==s.kD.POINTERDOUBLETAP){let e=this.currentDraggingPointerIds.indexOf(i);r.dragging=!1,-1!==e&&(this.currentDraggingPointerIds.splice(e,1),0===this.currentDraggingPointerIds.length&&(this._moving=!1,this._dragging=this._dragType.NONE,this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1)),r.originMesh.removeChild(r.dragMesh),r.originMesh.removeChild(r.pivotMesh),this._targetDragEnd(i),this.onDragEndObservable.notifyObservers({}))}else if(e.type==s.kD.POINTERMOVE&&-1!==this.currentDraggingPointerIds.indexOf(i)&&r.dragging&&e.pickInfo&&(e.pickInfo.ray||e.pickInfo.aimTransform)){let t=this.zDragFactor;(this.currentDraggingPointerIds.length>1||e.pickInfo.originMesh)&&(t=0),this._ownerNode.computeWorldMatrix(!0),n?this._pointerUpdateXR(e.pickInfo.aimTransform,e.pickInfo.gripTransform,i,t):this._pointerUpdate2D(e.pickInfo.ray,i,t),this._tmpQuaternion.copyFrom(r.startingPivotOrientation),this._tmpQuaternion.x=-this._tmpQuaternion.x,this._tmpQuaternion.y=-this._tmpQuaternion.y,this._tmpQuaternion.z=-this._tmpQuaternion.z,r.pivotMesh.absoluteRotationQuaternion.multiplyToRef(this._tmpQuaternion,this._tmpQuaternion),r.pivotMesh.absolutePosition.subtractToRef(r.startingPivotPosition,this._tmpVector),this.onDragObservable.notifyObservers({delta:this._tmpVector,position:r.pivotMesh.position,pickInfo:e.pickInfo}),this._targetDrag(this._tmpVector,this._tmpQuaternion,i),r.lastDragPosition.copyFrom(r.dragMesh.absolutePosition),this._moving=!0}})}_applyZOffset(e,t,i){e.position.z-=e.position.z<1?t*i:t*i*e.position.z,e.position.z<0&&(e.position.z=0)}_targetDragStart(e,t,i){}_targetDrag(e,t,i){}_targetDragEnd(e){}_reattachCameraControls(){if(this._pointerCamera){if("ArcRotateCamera"===this._pointerCamera.getClassName()){let e=this._pointerCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._pointerCamera.attachControl(!this._pointerCamera.inputs||this._pointerCamera.inputs.noPreventDefault)}}detach(){for(let e in this._scene&&(this.detachCameraControls&&this._attachedToElement&&this._pointerCamera&&!this._pointerCamera.leftCamera&&(this._reattachCameraControls(),this._attachedToElement=!1),this._scene.onPointerObservable.remove(this._pointerObserver)),this._virtualMeshesInfo)this._virtualMeshesInfo[e].originMesh.dispose(),this._virtualMeshesInfo[e].dragMesh.dispose();this.onDragEndObservable.clear(),this.onDragObservable.clear(),this.onDragStartObservable.clear()}}},96937:function(e,t,i){i.d(t,{Y:function(){return r}});class r{get delay(){return this.fadeInDelay}set delay(e){this.fadeInDelay=e,this.fadeOutDelay=e}constructor(){this.fadeInDelay=0,this.fadeOutDelay=0,this.fadeInTime=300,this.fadeOutTime=300,this._millisecondsPerFrame=1e3/60,this._hovered=!1,this._hoverValue=0,this._ownerNode=null,this._delay=0,this._time=300,this._update=()=>{if(this._ownerNode){if(this._hoverValue+=this._hovered?this._millisecondsPerFrame:-this._millisecondsPerFrame,this._setAllVisibility(this._ownerNode,(this._hoverValue-this._delay)/this._time),this._ownerNode.visibility>1){if(this._setAllVisibility(this._ownerNode,1),this._hoverValue>this._time){this._hoverValue=this._time,this._detachObserver();return}}else if(this._ownerNode.visibility<0&&(this._setAllVisibility(this._ownerNode,0),this._hoverValue<0)){this._hoverValue=0,this._detachObserver();return}this._attachObserver()}}}get name(){return"FadeInOut"}init(){}attach(e){this._ownerNode=e,this._setAllVisibility(this._ownerNode,0)}detach(){this._ownerNode=null}fadeIn(e=!0){this._delay=e?this.fadeInDelay:this.fadeOutDelay,this._time=e?this.fadeInTime:this.fadeOutTime,this._detachObserver(),this._ownerNode&&(e&&this._ownerNode.visibility>=1||!e&&this._ownerNode.visibility<=0)||(this._hovered=e,this._hovered||(this._delay*=-1),this._ownerNode.visibility>=1?this._hoverValue=this._time:this._ownerNode.visibility<=0&&(this._hoverValue=0),this._update())}fadeOut(){this.fadeIn(!1)}_setAllVisibility(e,t){e.visibility=t,e.getChildMeshes().forEach(e=>{this._setAllVisibility(e,t)})}_attachObserver(){this._onBeforeRenderObserver||(this._onBeforeRenderObserver=this._ownerNode?.getScene().onBeforeRenderObservable.add(this._update))}_detachObserver(){this._onBeforeRenderObserver&&(this._ownerNode?.getScene().onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=null)}}},90224:function(e,t,i){i.d(t,{j:function(){return a}});var r=i(39884),s=i(65330),n=i(31644);class a{constructor(){this._tmpQuaternion=new r._f,this._tmpVectors=[new r.P,new r.P,new r.P,new r.P,new r.P,new r.P,new r.P],this._tmpMatrix=new r.y3,this._tmpInvertView=new r.y3,this._tmpForward=new r.P,this._tmpNodeForward=new r.P,this._tmpPosition=new r.P,this._workingPosition=new r.P,this._workingQuaternion=new r._f,this._lastTick=-1,this._recenterNextUpdate=!0,this.interpolatePose=!0,this.lerpTime=500,this.ignoreCameraPitchAndRoll=!1,this.pitchOffset=15,this.maxViewVerticalDegrees=30,this.maxViewHorizontalDegrees=30,this.orientToCameraDeadzoneDegrees=60,this.ignoreDistanceClamp=!1,this.ignoreAngleClamp=!1,this.verticalMaxDistance=0,this.defaultDistance=.8,this.maximumDistance=2,this.minimumDistance=.3,this.useFixedVerticalOffset=!1,this.fixedVerticalOffset=0,this._enabled=!0}get followedCamera(){return this._followedCamera||this._scene.activeCamera}set followedCamera(e){this._followedCamera=e}get name(){return"Follow"}init(){}attach(e,t){this._scene=e.getScene(),this.attachedNode=e,t&&(this.followedCamera=t),this._addObservables()}detach(){this.attachedNode=null,this._removeObservables()}recenter(){this._recenterNextUpdate=!0}_angleBetweenVectorAndPlane(e,t){return this._tmpVectors[0].copyFrom(e),e=this._tmpVectors[0],this._tmpVectors[1].copyFrom(t),t=this._tmpVectors[1],e.normalize(),t.normalize(),Math.PI/2-Math.acos(r.P.Dot(e,t))}_length2D(e){return Math.sqrt(e.x*e.x+e.z*e.z)}_distanceClamp(e,t=!1){let i=this.minimumDistance,r=this.maximumDistance,n=this.defaultDistance,a=this._tmpVectors[0];a.copyFrom(e);let o=a.length();if(a.normalizeFromLength(o),this.ignoreCameraPitchAndRoll){i=this._length2D(a)*i,r=this._length2D(a)*r;let t=this._length2D(e);a.scaleInPlace(o/t),o=t}let l=o;return l=t?n:(0,s.Clamp)(o,i,r),e.copyFrom(a).scaleInPlace(l),o!==l}_applyVerticalClamp(e){0!==this.verticalMaxDistance&&(e.y=(0,s.Clamp)(e.y,-this.verticalMaxDistance,this.verticalMaxDistance))}_toOrientationQuatToRef(e,t){r._f.RotationYawPitchRollToRef(Math.atan2(e.x,e.z),Math.atan2(e.y,Math.sqrt(e.z*e.z+e.x*e.x)),0,t)}_applyPitchOffset(e){let t=this._tmpVectors[0],i=this._tmpVectors[1];t.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),i.copyFromFloats(1,0,0),r.P.TransformNormalToRef(t,e,t),t.y=0,t.normalize(),r.P.TransformNormalToRef(i,e,i),r._f.RotationAxisToRef(i,this.pitchOffset*Math.PI/180,this._tmpQuaternion),t.rotateByQuaternionToRef(this._tmpQuaternion,t),this._toOrientationQuatToRef(t,this._tmpQuaternion),this._tmpQuaternion.toRotationMatrix(this._tmpMatrix),e.copyFrom(this._tmpMatrix)}_angularClamp(e,t){let i=this._tmpVectors[5];i.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1);let s=this._tmpVectors[6];s.copyFromFloats(1,0,0),r.P.TransformNormalToRef(i,e,i),r.P.TransformNormalToRef(s,e,s);let a=r.P.UpReadOnly;if(t.length()<n.kn)return!1;let o=!1,l=this._tmpQuaternion;if(this.ignoreCameraPitchAndRoll){let e=r.P.GetAngleBetweenVectorsOnPlane(t,i,s);r._f.RotationAxisToRef(s,e,l),t.rotateByQuaternionToRef(l,t)}else{let e=-r.P.GetAngleBetweenVectorsOnPlane(t,i,s),n=this.maxViewVerticalDegrees*Math.PI/180*.5;e<-n?(r._f.RotationAxisToRef(s,-e-n,l),t.rotateByQuaternionToRef(l,t),o=!0):e>n&&(r._f.RotationAxisToRef(s,-e+n,l),t.rotateByQuaternionToRef(l,t),o=!0)}let c=this._angleBetweenVectorAndPlane(t,s)*(this._scene.useRightHandedSystem?-1:1),u=this.maxViewHorizontalDegrees*Math.PI/180*.5;return c<-u?(r._f.RotationAxisToRef(a,-c-u,l),t.rotateByQuaternionToRef(l,t),o=!0):c>u&&(r._f.RotationAxisToRef(a,-c+u,l),t.rotateByQuaternionToRef(l,t),o=!0),o}_orientationClamp(e,t){let i=this._tmpVectors[0];i.copyFrom(e).scaleInPlace(-1).normalize();let s=this._tmpVectors[1],a=this._tmpVectors[2];s.copyFromFloats(0,1,0),r.P.CrossToRef(i,s,a);let o=a.length();o<n.kn||(a.normalizeFromLength(o),r.P.CrossToRef(a,i,s),this.attachedNode?.getScene().useRightHandedSystem?r._f.FromLookDirectionRHToRef(i,s,t):r._f.FromLookDirectionLHToRef(i,s,t))}_passedOrientationDeadzone(e,t){let i=this._tmpVectors[5];return i.copyFrom(e),i.normalize(),180*Math.abs(r.P.GetAngleBetweenVectorsOnPlane(t,i,r.P.UpReadOnly))/Math.PI>this.orientToCameraDeadzoneDegrees}_updateLeashing(e){if(this.attachedNode&&this._enabled){let t=this.attachedNode.parent;this.attachedNode.setParent(null);let i=this.attachedNode.getWorldMatrix(),s=this._workingPosition,n=this._workingQuaternion,a=this.attachedNode.getPivotPoint(),o=this._tmpInvertView;o.copyFrom(e.getViewMatrix()),o.invert(),r.P.TransformCoordinatesToRef(a,i,s);let l=this._tmpPosition;l.copyFromFloats(0,0,0),r.P.TransformCoordinatesToRef(l,i,l),l.scaleInPlace(-1).subtractInPlace(a),s.subtractInPlace(e.globalPosition),this.ignoreCameraPitchAndRoll&&this._applyPitchOffset(o);let c=!1,u=this._tmpForward;u.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),r.P.TransformNormalToRef(u,o,u);let h=this._tmpNodeForward;if(h.copyFromFloats(0,0,this._scene.useRightHandedSystem?-1:1),r.P.TransformNormalToRef(h,i,h),this._recenterNextUpdate)s.copyFrom(u).scaleInPlace(this.defaultDistance);else if(this.ignoreAngleClamp){let e=s.length();s.copyFrom(u).scaleInPlace(e)}else c=this._angularClamp(o,s);let d=!1;this.ignoreDistanceClamp||(d=this._distanceClamp(s,c),this._applyVerticalClamp(s)),this.useFixedVerticalOffset&&(s.y=l.y-e.globalPosition.y+this.fixedVerticalOffset),(c||d||this._passedOrientationDeadzone(s,h)||this._recenterNextUpdate)&&this._orientationClamp(s,n),this._workingPosition.subtractInPlace(a),this._recenterNextUpdate=!1,this.attachedNode.setParent(t)}}_updateTransformToGoal(e){if(!this.attachedNode||!this.followedCamera||!this._enabled)return;this.attachedNode.rotationQuaternion||(this.attachedNode.rotationQuaternion=r._f.Identity());let t=this.attachedNode.parent;if(this.attachedNode.setParent(null),!this.interpolatePose){this.attachedNode.position.copyFrom(this.followedCamera.globalPosition).addInPlace(this._workingPosition),this.attachedNode.rotationQuaternion.copyFrom(this._workingQuaternion);return}let i=new r.P;i.copyFrom(this.attachedNode.position).subtractInPlace(this.followedCamera.globalPosition),r.P.SmoothToRef(i,this._workingPosition,e,this.lerpTime,i),i.addInPlace(this.followedCamera.globalPosition),this.attachedNode.position.copyFrom(i);let s=new r._f;s.copyFrom(this.attachedNode.rotationQuaternion),r._f.SmoothToRef(s,this._workingQuaternion,e,this.lerpTime,this.attachedNode.rotationQuaternion),this.attachedNode.setParent(t)}_addObservables(){this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add(()=>{if(!this.followedCamera)return;let e=Date.now();this._updateLeashing(this.followedCamera),this._updateTransformToGoal(e-this._lastTick),this._lastTick=e})}_removeObservables(){this._onBeforeRender&&this._scene.onBeforeRenderObservable.remove(this._onBeforeRender)}}},53320:function(e,t,i){i.d(t,{q_:function(){return d}});var r,s,n,a,o,l,c=i(34362),u=i(39884),h=i(4224);(r=a||(a={}))[r.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",r[r.RADIAL_SIDE=1]="RADIAL_SIDE",r[r.ULNAR_SIDE=2]="ULNAR_SIDE",r[r.BELOW_WRIST=3]="BELOW_WRIST",(s=o||(o={}))[s.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",s[s.HAND_ROTATION=1]="HAND_ROTATION",(n=l||(l={}))[n.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",n[n.PALM_UP=1]="PALM_UP",n[n.GAZE_FOCUS=2]="GAZE_FOCUS",n[n.PALM_AND_GAZE=3]="PALM_AND_GAZE";class d{constructor(){this._sceneRenderObserver=null,this._zoneAxis={},this.handConstraintVisibility=3,this.palmUpStrictness=.95,this.gazeProximityRadius=.15,this.targetOffset=.1,this.targetZone=2,this.zoneOrientationMode=1,this.nodeOrientationMode=1,this.handedness="none",this.lerpTime=100,this._zoneAxis[0]=new u.P(0,1,0),this._zoneAxis[1]=new u.P(-1,0,0),this._zoneAxis[2]=new u.P(1,0,0),this._zoneAxis[3]=new u.P(0,-1,0)}get name(){return"HandConstraint"}enable(){this._node.setEnabled(!0)}disable(){this._node.setEnabled(!1)}_getHandPose(){let e;if(!this._handTracking)return null;if(e="none"===this.handedness?this._handTracking.getHandByHandedness("left")||this._handTracking.getHandByHandedness("right"):this._handTracking.getHandByHandedness(this.handedness)){let t=e.getJointMesh("pinky-finger-metacarpal"),i=e.getJointMesh("middle-finger-metacarpal"),r=e.getJointMesh("wrist");if(r&&i&&t){let s={position:i.absolutePosition,quaternion:new u._f,id:e.xrController.uniqueId},n=u.jp.Vector3[0],a=u.jp.Vector3[1],o=u.jp.Vector3[2];return n.copyFrom(i.absolutePosition).subtractInPlace(r.absolutePosition).normalize(),a.copyFrom(t.absolutePosition).subtractInPlace(i.absolutePosition).normalize(),u.P.CrossToRef(n,a,a),u.P.CrossToRef(a,n,o),u._f.FromLookDirectionLHToRef(a,n,s.quaternion),s}}return null}init(){}attach(e){this._node=e,this._scene=e.getScene(),this._node.rotationQuaternion||(this._node.rotationQuaternion=u._f.RotationYawPitchRoll(this._node.rotation.y,this._node.rotation.x,this._node.rotation.z));let t=Date.now();this._sceneRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{let e=this._getHandPose();if(this._node.reservedDataStore=this._node.reservedDataStore||{},this._node.reservedDataStore.nearInteraction=this._node.reservedDataStore.nearInteraction||{},this._node.reservedDataStore.nearInteraction.excludedControllerId=null,e){let i=u.jp.Vector3[0],r=this._scene.activeCamera;i.copyFrom(this._zoneAxis[this.targetZone]);let s=u.jp.Quaternion[0];if(r&&(0===this.zoneOrientationMode||0===this.nodeOrientationMode)){let t=u.jp.Vector3[1];t.copyFrom(r.position).subtractInPlace(e.position).normalize(),this._scene.useRightHandedSystem?u._f.FromLookDirectionRHToRef(t,u.P.UpReadOnly,s):u._f.FromLookDirectionLHToRef(t,u.P.UpReadOnly,s)}1===this.zoneOrientationMode?e.quaternion.toRotationMatrix(u.jp.Matrix[0]):s.toRotationMatrix(u.jp.Matrix[0]),u.P.TransformNormalToRef(i,u.jp.Matrix[0],i),i.scaleInPlace(this.targetOffset);let n=u.jp.Vector3[2],a=u.jp.Quaternion[1];n.copyFrom(e.position).addInPlace(i),1===this.nodeOrientationMode?a.copyFrom(e.quaternion):a.copyFrom(s);let o=Date.now()-t;u.P.SmoothToRef(this._node.position,n,o,this.lerpTime,this._node.position),u._f.SmoothToRef(this._node.rotationQuaternion,a,o,this.lerpTime,this._node.rotationQuaternion),this._node.reservedDataStore.nearInteraction.excludedControllerId=e.id}this._setVisibility(e),t=Date.now()})}_setVisibility(e){let t=!0,i=!0,r=this._scene.activeCamera;if(r){let s=r.getForwardRay();if(2===this.handConstraintVisibility||3===this.handConstraintVisibility){let t;i=!1,this._eyeTracking&&(t=this._eyeTracking.getEyeGaze()),t=t||s;let r=u.jp.Vector3[0];e?e.position.subtractToRef(t.origin,r):this._node.getAbsolutePosition().subtractToRef(t.origin,r);let n=u.P.Dot(r,t.direction);n>0&&r.lengthSquared()-n*n<this.gazeProximityRadius*this.gazeProximityRadius&&(i=!0)}if((1===this.handConstraintVisibility||3===this.handConstraintVisibility)&&(t=!1,e)){let i=u.jp.Vector3[0];u.P.LeftHandedForwardReadOnly.rotateByQuaternionToRef(e.quaternion,i),u.P.Dot(i,s.direction)>2*this.palmUpStrictness-1&&(t=!0)}}this._node.setEnabled(t&&i)}detach(){this._scene.onBeforeRenderObservable.remove(this._sceneRenderObserver)}linkToXRExperience(e){let t=e.featuresManager?e.featuresManager:e;if(t){try{this._eyeTracking=t.getEnabledFeature(c.b.EYE_TRACKING)}catch{}try{this._handTracking=t.getEnabledFeature(c.b.HAND_TRACKING)}catch{h.w1.Error("Hand tracking must be enabled for the Hand Menu to work")}}else h.w1.Error("XR features manager must be available or provided directly for the Hand Menu to work")}}},80783:function(e,t,i){i.d(t,{M:function(){return d}});var r=i(35823),s=i(44755),n=i(82877),a=i(39884),o=i(74909),l=i(7981),c=i(73030),u=i(74591),h=i(31644);class d{get currentDraggingPointerID(){return this.currentDraggingPointerId}set currentDraggingPointerID(e){this.currentDraggingPointerId=e}set enabled(e){e!=this._enabled&&this.onEnabledObservable.notifyObservers(e),this._enabled=e}get enabled(){return this._enabled}get options(){return this._options}set options(e){this._options=e}constructor(e){this._useAlternatePickedPointAboveMaxDragAngleDragSpeed=-1.1,this._activeDragButton=-1,this.maxDragAngle=0,this.dragButtons=[0,1,2],this._useAlternatePickedPointAboveMaxDragAngle=!1,this.currentDraggingPointerId=-1,this.dragging=!1,this.dragDeltaRatio=.2,this.updateDragPlane=!0,this._debugMode=!1,this._moving=!1,this.onDragObservable=new n.y$,this.onDragStartObservable=new n.y$,this.onDragEndObservable=new n.y$,this.onEnabledObservable=new n.y$,this.moveAttached=!0,this._enabled=!0,this.startAndReleaseDragOnPointerEvents=!0,this.detachCameraControls=!0,this.useObjectOrientationForDragging=!0,this.validateDrag=e=>!0,this._tmpVector=new a.P(0,0,0),this._alternatePickedPoint=new a.P(0,0,0),this._worldDragAxis=new a.P(0,0,0),this._targetPosition=new a.P(0,0,0),this._attachedToElement=!1,this._startDragRay=new l.zH(new a.P,new a.P),this._lastPointerRay={},this._dragDelta=new a.P,this._pointA=new a.P(0,0,0),this._pointC=new a.P(0,0,0),this._localAxis=new a.P(0,0,0),this._lookAt=new a.P(0,0,0),this._options=e||{};let t=0;if(this._options.dragAxis&&t++,this._options.dragPlaneNormal&&t++,t>1)throw"Multiple drag modes specified in dragBehavior options. Only one expected"}get name(){return"PointerDrag"}init(){}attach(e,t){this._scene=e.getScene(),e.isNearGrabbable=!0,this.attachedNode=e,d._PlaneScene||(this._debugMode?d._PlaneScene=this._scene:(d._PlaneScene=new s.x(this._scene.getEngine(),{virtual:!0}),d._PlaneScene.detachControl(),this._scene.onDisposeObservable.addOnce(()=>{d._PlaneScene.dispose(),d._PlaneScene=null}))),this._dragPlane=(0,u.pT)("pointerDragPlane",{size:this._debugMode?1:1e4,updatable:!1,sideOrientation:r.Kj.DOUBLESIDE},d._PlaneScene),this.lastDragPosition=new a.P(0,0,0);let i=t||(e=>this.attachedNode==e||e.isDescendantOf(this.attachedNode));this._pointerObserver=this._scene.onPointerObservable.add(e=>{if(!this.enabled){this._attachedToElement&&this.releaseDrag();return}if(e.type==o.kD.POINTERDOWN)this.startAndReleaseDragOnPointerEvents&&!this.dragging&&e.pickInfo&&e.pickInfo.hit&&e.pickInfo.pickedMesh&&e.pickInfo.pickedPoint&&e.pickInfo.ray&&i(e.pickInfo.pickedMesh)&&-1===this._activeDragButton&&-1!==this.dragButtons.indexOf(e.event.button)&&(this._activeDragButton=e.event.button,this._activePointerInfo=e,this._startDrag(e.event.pointerId,e.pickInfo.ray,e.pickInfo.pickedPoint));else if(e.type==o.kD.POINTERUP)this.startAndReleaseDragOnPointerEvents&&this.currentDraggingPointerId==e.event.pointerId&&(this._activeDragButton===e.event.button||-1===this._activeDragButton)&&this.releaseDrag();else if(e.type==o.kD.POINTERMOVE){let t=e.event.pointerId;if(this.currentDraggingPointerId===d._AnyMouseId&&t!==d._AnyMouseId){let i=e.event;("mouse"===i.pointerType||!this._scene.getEngine().hostInformation.isMobile&&i instanceof MouseEvent)&&(this._lastPointerRay[this.currentDraggingPointerId]&&(this._lastPointerRay[t]=this._lastPointerRay[this.currentDraggingPointerId],delete this._lastPointerRay[this.currentDraggingPointerId]),this.currentDraggingPointerId=t)}this._lastPointerRay[t]||(this._lastPointerRay[t]=new l.zH(new a.P,new a.P)),e.pickInfo&&e.pickInfo.ray&&(this._lastPointerRay[t].origin.copyFrom(e.pickInfo.ray.origin),this._lastPointerRay[t].direction.copyFrom(e.pickInfo.ray.direction),this.currentDraggingPointerId==t&&this.dragging&&this._moveDrag(e.pickInfo.ray))}}),this._beforeRenderObserver=this._scene.onBeforeRenderObservable.add(()=>{if(this._moving&&this.moveAttached){let e=!1;c.m._RemoveAndStorePivotPoint(this.attachedNode),this._targetPosition.subtractToRef(this.attachedNode.absolutePosition,this._tmpVector),this._tmpVector.scaleInPlace(this.dragDeltaRatio),this.attachedNode.getAbsolutePosition().addToRef(this._tmpVector,this._tmpVector),this.validateDrag(this._tmpVector)&&(this.attachedNode.setAbsolutePosition(this._tmpVector),e=!0),c.m._RestorePivotPoint(this.attachedNode),e&&this.attachedNode.computeWorldMatrix()}})}releaseDrag(){if(this.dragging&&(this.dragging=!1,this.onDragEndObservable.notifyObservers({dragPlanePoint:this.lastDragPosition,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo})),this.currentDraggingPointerId=-1,this._activeDragButton=-1,this._activePointerInfo=null,this._moving=!1,this.detachCameraControls&&this._attachedToElement&&this._scene.activeCamera&&!this._scene.activeCamera.leftCamera){if("ArcRotateCamera"===this._scene.activeCamera.getClassName()){let e=this._scene.activeCamera;e.attachControl(!e.inputs||e.inputs.noPreventDefault,e._useCtrlForPanning,e._panningMouseButton)}else this._scene.activeCamera.attachControl(!this._scene.activeCamera.inputs||this._scene.activeCamera.inputs.noPreventDefault);this._attachedToElement=!1}}startDrag(e=d._AnyMouseId,t,i){this._startDrag(e,t,i);let r=this._lastPointerRay[e];e===d._AnyMouseId&&(r=this._lastPointerRay[Object.keys(this._lastPointerRay)[0]]),r&&this._moveDrag(r)}_startDrag(e,t,i){if(!this._scene.activeCamera||this.dragging||!this.attachedNode)return;c.m._RemoveAndStorePivotPoint(this.attachedNode),t?(this._startDragRay.direction.copyFrom(t.direction),this._startDragRay.origin.copyFrom(t.origin)):(this._startDragRay.origin.copyFrom(this._scene.activeCamera.position),this.attachedNode.getWorldMatrix().getTranslationToRef(this._tmpVector),this._tmpVector.subtractToRef(this._scene.activeCamera.position,this._startDragRay.direction)),this._updateDragPlanePosition(this._startDragRay,i||this._tmpVector);let r=this._pickWithRayOnDragPlane(this._startDragRay);r?(this.dragging=!0,this.currentDraggingPointerId=e,this.lastDragPosition.copyFrom(r),this.onDragStartObservable.notifyObservers({dragPlanePoint:r,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this._targetPosition.copyFrom(this.attachedNode.getAbsolutePosition()),this.detachCameraControls&&this._scene.activeCamera&&this._scene.activeCamera.inputs&&!this._scene.activeCamera.leftCamera&&(this._scene.activeCamera.inputs.attachedToElement?(this._scene.activeCamera.detachControl(),this._attachedToElement=!0):this._attachedToElement=!1)):this.releaseDrag(),c.m._RestorePivotPoint(this.attachedNode)}_moveDrag(e){this._moving=!0;let t=this._pickWithRayOnDragPlane(e);if(t){c.m._RemoveAndStorePivotPoint(this.attachedNode),this.updateDragPlane&&this._updateDragPlanePosition(e,t);let i=0;this._options.dragAxis?(this.useObjectOrientationForDragging?a.P.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._worldDragAxis):this._worldDragAxis.copyFrom(this._options.dragAxis),t.subtractToRef(this.lastDragPosition,this._tmpVector),i=a.P.Dot(this._tmpVector,this._worldDragAxis),this._worldDragAxis.scaleToRef(i,this._dragDelta)):(i=this._dragDelta.length(),t.subtractToRef(this.lastDragPosition,this._dragDelta)),this._targetPosition.addInPlace(this._dragDelta),this.onDragObservable.notifyObservers({dragDistance:i,delta:this._dragDelta,dragPlanePoint:t,dragPlaneNormal:this._dragPlane.forward,pointerId:this.currentDraggingPointerId,pointerInfo:this._activePointerInfo}),this.lastDragPosition.copyFrom(t),c.m._RestorePivotPoint(this.attachedNode)}}_pickWithRayOnDragPlane(e){if(!e)return null;let t=Math.acos(a.P.Dot(this._dragPlane.forward,e.direction));if(t>Math.PI/2&&(t=Math.PI-t),this.maxDragAngle>0&&t>this.maxDragAngle){if(!this._useAlternatePickedPointAboveMaxDragAngle)return null;{this._tmpVector.copyFrom(e.direction),this.attachedNode.absolutePosition.subtractToRef(e.origin,this._alternatePickedPoint),this._alternatePickedPoint.normalize(),this._alternatePickedPoint.scaleInPlace(this._useAlternatePickedPointAboveMaxDragAngleDragSpeed*a.P.Dot(this._alternatePickedPoint,this._tmpVector)),this._tmpVector.addInPlace(this._alternatePickedPoint);let t=a.P.Dot(this._dragPlane.forward,this._tmpVector);return this._dragPlane.forward.scaleToRef(-t,this._alternatePickedPoint),this._alternatePickedPoint.addInPlace(this._tmpVector),this._alternatePickedPoint.addInPlace(this.attachedNode.absolutePosition),this._alternatePickedPoint}}let i=this._dragPlane.forward,r=this._dragPlane.position,s=e.direction.dot(i);if(Math.abs(s)<h.kn)return null;r.subtractToRef(e.origin,a.jp.Vector3[0]);let n=a.jp.Vector3[0].dot(i)/s;return n<0?null:(e.direction.scaleToRef(n,a.jp.Vector3[0]),e.origin.add(a.jp.Vector3[0]))}_updateDragPlanePosition(e,t){this._pointA.copyFrom(t),this._options.dragAxis?(this.useObjectOrientationForDragging?a.P.TransformCoordinatesToRef(this._options.dragAxis,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragAxis),e.origin.subtractToRef(this._pointA,this._pointC),this._pointC.normalize(),Math.abs(a.P.Dot(this._localAxis,this._pointC))>.999?Math.abs(a.P.Dot(a.P.UpReadOnly,this._pointC))>.999?this._lookAt.copyFrom(a.P.Right()):this._lookAt.copyFrom(a.P.UpReadOnly):(a.P.CrossToRef(this._localAxis,this._pointC,this._lookAt),a.P.CrossToRef(this._localAxis,this._lookAt,this._lookAt),this._lookAt.normalize()),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._lookAt,this._lookAt),this._dragPlane.lookAt(this._lookAt)):this._options.dragPlaneNormal?(this.useObjectOrientationForDragging?a.P.TransformCoordinatesToRef(this._options.dragPlaneNormal,this.attachedNode.getWorldMatrix().getRotationMatrix(),this._localAxis):this._localAxis.copyFrom(this._options.dragPlaneNormal),this._dragPlane.position.copyFrom(this._pointA),this._pointA.addToRef(this._localAxis,this._lookAt),this._dragPlane.lookAt(this._lookAt)):(this._dragPlane.position.copyFrom(this._pointA),this._dragPlane.lookAt(e.origin)),this._dragPlane.position.copyFrom(this.attachedNode.getAbsolutePosition()),this._dragPlane.computeWorldMatrix(!0)}detach(){this._lastPointerRay={},this.attachedNode&&(this.attachedNode.isNearGrabbable=!1),this._pointerObserver&&this._scene.onPointerObservable.remove(this._pointerObserver),this._beforeRenderObserver&&this._scene.onBeforeRenderObservable.remove(this._beforeRenderObserver),this._dragPlane&&this._dragPlane.dispose(),this.releaseDrag()}}d._AnyMouseId=-2},98547:function(e,t,i){i.d(t,{K:function(){return o}});var r=i(39884),s=i(82877),n=i(84903),a=i(3860);class o extends n.N{constructor(){super(...arguments),this._sceneRenderObserver=null,this._targetPosition=new r.P(0,0,0),this._targetOrientation=new r._f,this._targetScaling=new r.P(1,1,1),this._startingPosition=new r.P(0,0,0),this._startingOrientation=new r._f,this._startingScaling=new r.P(1,1,1),this.onPositionChangedObservable=new s.y$,this.dragDeltaRatio=.2,this.rotateDraggedObject=!0,this.rotateAroundYOnly=!1,this.rotateWithMotionController=!0,this.disableMovement=!1,this.faceCameraOnDragStart=!1}get name(){return"SixDofDrag"}attach(e){super.attach(e),e.isNearGrabbable=!0,e.getChildMeshes().forEach(e=>{e.isNearGrabbable=!0}),this._virtualTransformNode=new a.Y("virtual_sixDof",n.N._virtualScene),this._virtualTransformNode.rotationQuaternion=r._f.Identity(),this._sceneRenderObserver=e.getScene().onBeforeRenderObservable.add(()=>{if(1===this.currentDraggingPointerIds.length&&this._moving&&!this.disableMovement){let t=r.jp.Vector3[0];t.copyFrom(this._targetPosition).subtractInPlace(e.absolutePosition).scaleInPlace(this.dragDeltaRatio);let i=r.jp.Vector3[1];if(i.copyFrom(t),e.parent){let s=r.jp.Matrix[0];e.parent.absoluteRotationQuaternion.toRotationMatrix(s),s.invert(),r.P.TransformNormalToRef(t,s,i)}if(e.position.addInPlace(i),this.onPositionChangedObservable.notifyObservers({position:e.absolutePosition}),!e.parent||e.parent.scaling&&!e.parent.scaling.isNonUniformWithinEpsilon(.001)){let t=r.jp.Quaternion[0];if(t.copyFrom(this._targetOrientation),e.parent){let i=r.jp.Quaternion[0];i.copyFrom(e.parent.absoluteRotationQuaternion),i.invertInPlace(),i.multiplyToRef(this._targetOrientation,t)}r._f.SlerpToRef(e.rotationQuaternion,t,this.dragDeltaRatio,e.rotationQuaternion)}}})}_getPositionOffsetAround(e,t,i){let s=r.jp.Matrix[0],n=r.jp.Matrix[1],a=r.jp.Matrix[2],o=r.jp.Matrix[3],l=r.jp.Matrix[4];return r.y3.TranslationToRef(e.x,e.y,e.z,s),r.y3.TranslationToRef(-e.x,-e.y,-e.z,n),r.y3.FromQuaternionToRef(i,a),r.y3.ScalingToRef(t,t,t,o),n.multiplyToRef(a,l),l.multiplyToRef(o,l),l.multiplyToRef(s,l),l.getTranslation()}_onePointerPositionUpdated(e,t){r.jp.Vector3[0].setAll(0),this._dragging===this._dragType.DRAG?this.rotateDraggedObject&&(this.rotateAroundYOnly?r._f.RotationYawPitchRollToRef(t.toEulerAngles().y,0,0,r.jp.Quaternion[0]):r.jp.Quaternion[0].copyFrom(t),r.jp.Quaternion[0].multiplyToRef(this._startingOrientation,this._targetOrientation)):(this._dragging===this._dragType.NEAR_DRAG||this._dragging===this._dragType.DRAG_WITH_CONTROLLER&&this.rotateWithMotionController)&&t.multiplyToRef(this._startingOrientation,this._targetOrientation),this._targetPosition.copyFrom(this._startingPosition).addInPlace(e)}_twoPointersPositionUpdated(){let e=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].startingPosition,t=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].startingPosition,i=r.jp.Vector3[0];e.addToRef(t,i),i.scaleInPlace(.5);let s=r.jp.Vector3[1];t.subtractToRef(e,s);let n=this._virtualMeshesInfo[this.currentDraggingPointerIds[0]].dragMesh.absolutePosition,a=this._virtualMeshesInfo[this.currentDraggingPointerIds[1]].dragMesh.absolutePosition,o=r.jp.Vector3[2];n.addToRef(a,o),o.scaleInPlace(.5);let l=r.jp.Vector3[3];a.subtractToRef(n,l);let c=l.length()/s.length(),u=o.subtract(i),h=r._f.FromEulerAngles(0,r.P.GetAngleBetweenVectorsOnPlane(s.normalize(),l.normalize(),r.P.UpReadOnly),0),d=this._ownerNode.parent;this._ownerNode.setParent(null);let f=this._getPositionOffsetAround(i.subtract(this._virtualTransformNode.getAbsolutePivotPoint()),c,h);this._virtualTransformNode.rotationQuaternion.multiplyToRef(h,this._ownerNode.rotationQuaternion),this._virtualTransformNode.scaling.scaleToRef(c,this._ownerNode.scaling),this._virtualTransformNode.position.addToRef(u.addInPlace(f),this._ownerNode.position),this.onPositionChangedObservable.notifyObservers({position:this._ownerNode.position}),this._ownerNode.setParent(d)}_targetDragStart(){let e=this.currentDraggingPointerIds.length;this._ownerNode.rotationQuaternion||(this._ownerNode.rotationQuaternion=r._f.RotationYawPitchRoll(this._ownerNode.rotation.y,this._ownerNode.rotation.x,this._ownerNode.rotation.z));let t=this._ownerNode.getAbsolutePivotPoint();if(1===e){if(this._targetPosition.copyFrom(this._ownerNode.absolutePosition),this._targetOrientation.copyFrom(this._ownerNode.rotationQuaternion),this._targetScaling.copyFrom(this._ownerNode.absoluteScaling),this.faceCameraOnDragStart&&this._scene.activeCamera){let e=r.jp.Vector3[0];this._scene.activeCamera.position.subtractToRef(t,e),e.normalize();let i=r.jp.Quaternion[0];this._scene.useRightHandedSystem?r._f.FromLookDirectionRHToRef(e,new r.P(0,1,0),i):r._f.FromLookDirectionLHToRef(e,new r.P(0,1,0),i),i.normalize(),r._f.RotationYawPitchRollToRef(i.toEulerAngles().y,0,0,r.jp.Quaternion[0]),this._targetOrientation.copyFrom(r.jp.Quaternion[0])}this._startingPosition.copyFrom(this._targetPosition),this._startingOrientation.copyFrom(this._targetOrientation),this._startingScaling.copyFrom(this._targetScaling)}else 2===e&&(this._virtualTransformNode.setPivotPoint(new r.P(0,0,0),0),this._virtualTransformNode.position.copyFrom(this._ownerNode.absolutePosition),this._virtualTransformNode.scaling.copyFrom(this._ownerNode.absoluteScaling),this._virtualTransformNode.rotationQuaternion.copyFrom(this._ownerNode.absoluteRotationQuaternion),this._virtualTransformNode.setPivotPoint(t,1),this._resetVirtualMeshesPosition())}_targetDrag(e,t){1===this.currentDraggingPointerIds.length?this._onePointerPositionUpdated(e,t):2===this.currentDraggingPointerIds.length&&this._twoPointersPositionUpdated()}_targetDragEnd(){if(1===this.currentDraggingPointerIds.length){this._resetVirtualMeshesPosition();let e=this.faceCameraOnDragStart;this.faceCameraOnDragStart=!1,this._targetDragStart(),this.faceCameraOnDragStart=e}}detach(){super.detach(),this._ownerNode&&this._ownerNode.getScene().onBeforeRenderObservable.remove(this._sceneRenderObserver),this._virtualTransformNode&&this._virtualTransformNode.dispose()}}},14814:function(e,t,i){i.d(t,{p:function(){return n}});var r=i(74909),s=i(39884);class n{constructor(){this._attachPointLocalOffset=new s.P,this._workingPosition=new s.P,this._workingQuaternion=new s._f,this._lastTick=-1,this._hit=!1,this.hitNormalOffset=.05,this.meshes=[],this.interpolatePose=!0,this.lerpTime=250,this.keepOrientationVertical=!0,this.enabled=!0,this.maxStickingDistance=.8}get name(){return"SurfaceMagnetism"}init(){}attach(e,t){this._attachedMesh=e,this._scene=t||e.getScene(),this._attachedMesh.rotationQuaternion||(this._attachedMesh.rotationQuaternion=s._f.RotationYawPitchRoll(this._attachedMesh.rotation.y,this._attachedMesh.rotation.x,this._attachedMesh.rotation.z)),this.updateAttachPoint(),this._workingPosition.copyFrom(this._attachedMesh.position),this._workingQuaternion.copyFrom(this._attachedMesh.rotationQuaternion),this._addObservables()}detach(){this._attachedMesh=null,this._removeObservables()}_getTargetPose(e){if(!this._attachedMesh)return null;if(e&&e.hit){let t=e.getNormal(!0,!0),i=e.pickedPoint;if(!t||!i)return null;t.normalize();let r=s.jp.Vector3[0];return r.copyFrom(t),r.scaleInPlace(this.hitNormalOffset),r.addInPlace(i),this._attachedMesh.parent&&(s.jp.Matrix[0].copyFrom(this._attachedMesh.parent.getWorldMatrix()).invert(),s.P.TransformNormalToRef(r,s.jp.Matrix[0],r)),{position:r,quaternion:s._f.RotationYawPitchRoll(-Math.atan2(t.x,-t.z),this.keepOrientationVertical?0:Math.atan2(t.y,Math.sqrt(t.z*t.z+t.x*t.x)),0)}}return null}updateAttachPoint(){this._getAttachPointOffsetToRef(this._attachPointLocalOffset)}findAndUpdateTarget(e){if(this._hit=!1,!e.ray)return!1;let t=e.ray.intersectsMeshes(this.meshes)[0];if(this._attachedMesh&&t&&t.hit&&t.pickedMesh){let e=this._getTargetPose(t);e&&s.P.Distance(this._attachedMesh.position,e.position)<this.maxStickingDistance&&(this._workingPosition.copyFrom(e.position),this._workingQuaternion.copyFrom(e.quaternion),this._hit=!0)}return this._hit}_getAttachPointOffsetToRef(e){if(!this._attachedMesh){e.setAll(0);return}let t=s.jp.Quaternion[0];t.copyFrom(this._attachedMesh.rotationQuaternion),this._attachedMesh.rotationQuaternion.copyFromFloats(0,0,0,1),this._attachedMesh.computeWorldMatrix();let i=this._attachedMesh.getHierarchyBoundingVectors(),r=s.jp.Vector3[0];i.max.addToRef(i.min,r),r.scaleInPlace(.5),r.z=i.max.z;let n=s.jp.Matrix[0];this._attachedMesh.getWorldMatrix().invertToRef(n),s.P.TransformCoordinatesToRef(r,n,e),this._attachedMesh.rotationQuaternion.copyFrom(t)}_updateTransformToGoal(e){if(!this._attachedMesh||!this._hit)return;let t=this._attachedMesh.parent;this._attachedMesh.setParent(null);let i=s.jp.Vector3[0];if(s.P.TransformNormalToRef(this._attachPointLocalOffset,this._attachedMesh.getWorldMatrix(),i),!this.interpolatePose){this._attachedMesh.position.copyFrom(this._workingPosition).subtractInPlace(i),this._attachedMesh.rotationQuaternion.copyFrom(this._workingQuaternion);return}let r=new s.P;s.P.SmoothToRef(this._attachedMesh.position,this._workingPosition,e,this.lerpTime,r),this._attachedMesh.position.copyFrom(r);let n=new s._f;n.copyFrom(this._attachedMesh.rotationQuaternion),s._f.SmoothToRef(n,this._workingQuaternion,e,this.lerpTime,this._attachedMesh.rotationQuaternion),this._attachedMesh.setParent(t)}_addObservables(){this._pointerObserver=this._scene.onPointerObservable.add(e=>{this.enabled&&e.type==r.kD.POINTERMOVE&&e.pickInfo&&this.findAndUpdateTarget(e.pickInfo)}),this._lastTick=Date.now(),this._onBeforeRender=this._scene.onBeforeRenderObservable.add(()=>{let e=Date.now();this._updateTransformToGoal(e-this._lastTick),this._lastTick=e})}_removeObservables(){this._scene.onPointerObservable.remove(this._pointerObserver),this._scene.onBeforeRenderObservable.remove(this._onBeforeRender),this._pointerObserver=null,this._onBeforeRender=null}}},6132:function(e,t,i){i.d(t,{N:function(){return a}});var r=i(39884),s=i(178),n=i(67020);class a extends n.N{get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){(e.updateFlag!==this._localMatrix.updateFlag||this._needToCompose)&&(this._needToCompose=!1,this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}constructor(e,t,i=null,s=null,n=null,a=null,o=null){super(e,t.getScene(),!1),this.name=e,this.children=[],this.animations=[],this._index=null,this._scalingDeterminant=1,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=s?.clone()??r.y3.Identity(),this._restMatrix=n??this._localMatrix.clone(),this._bindMatrix=a??this._localMatrix.clone(),this._index=o,this._absoluteMatrix=new r.y3,this._absoluteBindMatrix=new r.y3,this._absoluteInverseBindMatrix=new r.y3,this._finalMatrix=new r.y3,t.bones.push(this),this.setParent(i,!1),this._updateAbsoluteBindMatrices()}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return null===this._index?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){let e=this.parent.children.indexOf(this);-1!==e&&this.parent.children.splice(e,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateAbsoluteBindMatrices(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBindMatrix(){return this._bindMatrix}getBaseMatrix(){return this.getBindMatrix()}getRestMatrix(){return this._restMatrix}getRestPose(){return this.getRestMatrix()}setRestMatrix(e){this._restMatrix.copyFrom(e)}setRestPose(e){this.setRestMatrix(e)}getBindPose(){return this.getBindMatrix()}setBindMatrix(e){this.updateMatrix(e)}setBindPose(e){this.setBindMatrix(e)}getFinalMatrix(){return this._finalMatrix}getWorldMatrix(){return this.getFinalMatrix()}returnToRest(){if(this._linkedTransformNode){let e=r.jp.Vector3[0],t=r.jp.Quaternion[0],i=r.jp.Vector3[1];this.getRestMatrix().decompose(e,t,i),this._linkedTransformNode.position.copyFrom(i),this._linkedTransformNode.rotationQuaternion=this._linkedTransformNode.rotationQuaternion??r._f.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(t),this._linkedTransformNode.scaling.copyFrom(e)}else this._matrix=this._restMatrix}getAbsoluteInverseBindMatrix(){return this._absoluteInverseBindMatrix}getInvertedAbsoluteTransform(){return this.getAbsoluteInverseBindMatrix()}getAbsoluteMatrix(){return this._absoluteMatrix}getAbsoluteTransform(){return this._absoluteMatrix}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){this._needToDecompose&&(this._needToDecompose=!1,this._localScaling||(this._localScaling=r.P.Zero(),this._localRotation=r._f.Zero(),this._localPosition=r.P.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,r.y3.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._bindMatrix.copyFrom(e),t&&this._updateAbsoluteBindMatrices(),i?this._matrix=e:this.markAsDirty()}_updateAbsoluteBindMatrices(e,t=!0){if(e||(e=this._bindMatrix),this.parent?e.multiplyToRef(this.parent._absoluteBindMatrix,this._absoluteBindMatrix):this._absoluteBindMatrix.copyFrom(e),this._absoluteBindMatrix.invertToRef(this._absoluteInverseBindMatrix),t)for(let e=0;e<this.children.length;e++)this.children[e]._updateAbsoluteBindMatrices();this._scalingDeterminant=0>this._absoluteBindMatrix.determinant()?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}_updatePosition(e,t=0,i,s=!0){let n=this.getLocalMatrix();if(0==t)s?(n.addAtIndex(12,e.x),n.addAtIndex(13,e.y),n.addAtIndex(14,e.z)):n.setTranslationFromFloats(e.x,e.y,e.z);else{let t=null;i&&(t=i.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let o=a._TmpMats[0],l=a._TmpVecs[0];this.parent?i&&t?(o.copyFrom(this.parent.getAbsoluteMatrix()),o.multiplyToRef(t,o)):o.copyFrom(this.parent.getAbsoluteMatrix()):r.y3.IdentityToRef(o),s&&o.setTranslationFromFloats(0,0,0),o.invert(),r.P.TransformCoordinatesToRef(e,o,l),s?(n.addAtIndex(12,l.x),n.addAtIndex(13,l.y),n.addAtIndex(14,l.z)):n.setTranslationFromFloats(l.x,l.y,l.z)}this._markAsDirtyAndDecompose()}translate(e,t=0,i){this._updatePosition(e,t,i,!0)}setPosition(e,t=0,i){this._updatePosition(e,t,i,!1)}setAbsolutePosition(e,t){this.setPosition(e,1,t)}scale(e,t,i,s=!1){let n=this.getLocalMatrix(),o=a._TmpMats[0];for(let s of(r.y3.ScalingToRef(e,t,i,o),o.multiplyToRef(n,n),o.invert(),this.children)){let r=s.getLocalMatrix();r.multiplyToRef(o,r),r.multiplyAtIndex(12,e),r.multiplyAtIndex(13,t),r.multiplyAtIndex(14,i),s._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(let r of this.children)r.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=0,n){if(0===s){let o=a._TmpQuat;r._f.RotationYawPitchRollToRef(e,t,i,o),this.setRotationQuaternion(o,s,n);return}let o=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(o,n))return;let l=a._TmpMats[1];r.y3.RotationYawPitchRollToRef(e,t,i,l),o.multiplyToRef(l,l),this._rotateWithMatrix(l,s,n)}rotate(e,t,i=0,s){let n=a._TmpMats[0];n.setTranslationFromFloats(0,0,0),r.y3.RotationAxisToRef(e,t,n),this._rotateWithMatrix(n,i,s)}setAxisAngle(e,t,i=0,s){if(0===i){let n=a._TmpQuat;r._f.RotationAxisToRef(e,t,n),this.setRotationQuaternion(n,i,s);return}let n=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(n,s))return;let o=a._TmpMats[1];r.y3.RotationAxisToRef(e,t,o),n.multiplyToRef(o,o),this._rotateWithMatrix(o,i,s)}setRotation(e,t=0,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=0,i){if(0===t){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}let s=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;let n=a._TmpMats[1];r.y3.FromQuaternionToRef(e,n),s.multiplyToRef(n,n),this._rotateWithMatrix(n,t,i)}setRotationMatrix(e,t=0,i){if(0===t){let s=a._TmpQuat;r._f.FromRotationMatrixToRef(e,s),this.setRotationQuaternion(s,t,i);return}let s=a._TmpMats[0];if(!this._getAbsoluteInverseMatrixUnscaledToRef(s,i))return;let n=a._TmpMats[1];n.copyFrom(e),s.multiplyToRef(e,n),this._rotateWithMatrix(n,t,i)}_rotateWithMatrix(e,t=0,i){let r=this.getLocalMatrix(),s=r.m[12],n=r.m[13],o=r.m[14],l=this.getParent(),c=a._TmpMats[3],u=a._TmpMats[4];l&&1==t?(i?(c.copyFrom(i.getWorldMatrix()),l.getAbsoluteMatrix().multiplyToRef(c,c)):c.copyFrom(l.getAbsoluteMatrix()),u.copyFrom(c),u.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):1==t&&i?(c.copyFrom(i.getWorldMatrix()),u.copyFrom(c),u.invert(),r.multiplyToRef(c,r),r.multiplyToRef(e,r),r.multiplyToRef(u,r)):r.multiplyToRef(e,r),r.setTranslationFromFloats(s,n,o),this.computeAbsoluteMatrices(),this._markAsDirtyAndDecompose()}_getAbsoluteInverseMatrixUnscaledToRef(e,t){let i=a._TmpMats[2];return e.copyFrom(this.getAbsoluteMatrix()),t?(e.multiplyToRef(t.getWorldMatrix(),e),r.y3.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):r.y3.IdentityToRef(i),e.invert(),!isNaN(e.m[0])&&(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=0,t=null){let i=r.P.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=0,t,i){if(0==e){let e=this.getLocalMatrix();i.x=e.m[12],i.y=e.m[13],i.z=e.m[14]}else{let e=null;t&&(e=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let r=a._TmpMats[0];t&&e?(r.copyFrom(this.getAbsoluteMatrix()),r.multiplyToRef(e,r)):r=this.getAbsoluteMatrix(),i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}}getAbsolutePosition(e=null){let t=r.P.Zero();return this.getPositionToRef(1,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(1,e,t)}computeAbsoluteMatrices(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteMatrix,this._absoluteMatrix);else{this._absoluteMatrix.copyFrom(this._localMatrix);let e=this._skeleton.getPoseMatrix();e&&this._absoluteMatrix.multiplyToRef(e,this._absoluteMatrix)}let e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteMatrices()}computeAbsoluteTransforms(){this.computeAbsoluteMatrices()}getDirection(e,t=null){let i=r.P.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=a._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),r.P.TransformNormalToRef(e,n,i),i.normalize()}getRotation(e=0,t=null){let i=r.P.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=0,t=null,i){let r=a._TmpQuat;this.getRotationQuaternionToRef(e,t,r),r.toEulerAnglesToRef(i)}getRotationQuaternion(e=0,t=null){let i=r._f.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=0,t=null,i){if(0==e)this._decompose(),i.copyFrom(this._localRotation);else{let e=a._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(r),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.decompose(void 0,i,void 0)}}getRotationMatrix(e=0,t){let i=r.y3.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=0,t,i){if(0==e)this.getLocalMatrix().getRotationMatrixToRef(i);else{let e=a._TmpMats[0],r=this.getAbsoluteMatrix();t?r.multiplyToRef(t.getWorldMatrix(),e):e.copyFrom(r),e.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyAtIndex(1,this._scalingDeterminant),e.multiplyAtIndex(2,this._scalingDeterminant),e.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){let i=r.P.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=a._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),r.P.TransformCoordinatesToRef(e,n,i)}getLocalPositionFromAbsolute(e,t=null){let i=r.P.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteMatrices();let n=a._TmpMats[0];n.copyFrom(this.getAbsoluteMatrix()),t&&s&&n.multiplyToRef(s,n),n.invert(),r.P.TransformCoordinatesToRef(e,n,i)}setCurrentPoseAsRest(){this.setRestMatrix(this.getLocalMatrix())}}a._TmpVecs=(0,s.$G)(2,r.P.Zero),a._TmpQuat=r._f.Identity(),a._TmpMats=(0,s.$G)(5,r.y3.Identity)},91867:function(e,t,i){i.d(t,{N:function(){return r}});class r{constructor(e,t,i=3,r){this._engine=e,this._label=r,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t,this._label)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){this._buffer&&this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i,r){return this._engine.readFromStorageBuffer(this._buffer,e,t,i,r)}dispose(){let e=this._engine._storageBuffers,t=e.indexOf(this);-1!==t&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}},87868:function(e,t,i){i.d(t,{U:function(){return d}});var r=i(46456),s=i(22287),n=i(90212),a=i(7724),o=i(81209),l=i(73266),c=i(9719),u=i(72831),h=i(64525);class d{get options(){return this._options}get shaderPath(){return this._shaderPath}constructor(e,t,i,r={}){if(this._bindings={},this._samplers={},this._contextIsDirty=!1,this.fastMode=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=l.K.UniqueId,t.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new h.Q),!this._engine.getCaps().supportComputeShaders){c.Y.Error("This engine does not support compute shaders!");return}if(!r.bindingsMapping){c.Y.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!");return}this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...r}}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){let r=this._bindings[e];this._bindings[e]={type:i?0:4,object:t,indexInGroupEntries:r?.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!r||r.object!==t||r.type!==this._bindings[e].type)}setStorageTexture(e,t){let i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:1,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setExternalTexture(e,t){let i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:6,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setVideoTexture(e,t){return!!t.externalTexture&&(this.setExternalTexture(e,t.externalTexture),!0)}setUniformBuffer(e,t){let i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:d._BufferIsDataBuffer(t)?7:2,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setStorageBuffer(e,t){let i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:d._BufferIsDataBuffer(t)?7:3,object:t,indexInGroupEntries:i?.indexInGroupEntries}}setTextureSampler(e,t){let i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:5,object:t,indexInGroupEntries:i?.indexInGroupEntries}}isReady(){let e=this._effect;for(let e in this._bindings){let t=this._bindings[e],i=t.type,r=t.object;switch(i){case 0:case 4:case 1:case 6:if(!r.isReady())return!1}}let t=[],i=this._shaderPath;if(this._options.defines)for(let e=0;e<this._options.defines.length;e++)t.push(this._options.defines[e]);let r=t.join("\n");return this._cachedDefines!==r&&(this._cachedDefines=r,e=this._engine.createComputeEffect(i,{defines:r,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){return!!(this.fastMode||this._checkContext())&&(this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping,this.gpuTimeInFrame),!0)}dispatchIndirect(e,t=0){if(!this.fastMode&&!this._checkContext())return!1;let i=d._BufferIsDataBuffer(e)?e:e.getBuffer();return this._engine.computeDispatchIndirect(this._effect,this._context,this._bindings,i,t,this._options.bindingsMapping,this.gpuTimeInFrame),!0}_checkContext(){if(!this.isReady())return!1;for(let e in this._bindings){let t=this._bindings[e];if(!this._options.bindingsMapping[e])throw Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+e+"'");switch(t.type){case 0:{let i=this._samplers[e],r=t.object;i&&r._texture&&i.compareSampler(r._texture)||(this._samplers[e]=new u.a().setParameters(r.wrapU,r.wrapV,r.wrapR,r.anisotropicFilteringLevel,r._texture.samplingMode,r._texture?._comparisonFunction),this._contextIsDirty=!0);break}case 6:this._contextIsDirty=!0;break;case 2:{let e=t.object;e.getBuffer()!==t.buffer&&(t.buffer=e.getBuffer(),this._contextIsDirty=!0)}}}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),!0}dispatchWhenReady(e,t,i,r=10){return new Promise(s=>{let n=()=>{this.dispatch(e,t,i)?s():setTimeout(n,r)};n()})}serialize(){let e=n.p.Serialize(this);for(let t in e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={},this._bindings){let i=this._bindings[t],r=i.object;switch(i.type){case 0:case 4:case 1:{let s=r.serialize();s&&(e.textures[t]=s,e.bindings[t]={type:i.type})}}}return e}static Parse(e,t,i){let r=n.p.Parse(()=>new d(e.name,t.getEngine(),e.shaderPath,e.options),e,t,i);for(let s in e.textures){let n=e.bindings[s],a=o.x.Parse(e.textures[s],t,i);0===n.type?r.setTexture(s,a):4===n.type?r.setTexture(s,a,!1):r.setStorageTexture(s,a)}return r}static _BufferIsDataBuffer(e){return void 0!==e.underlyingResource}}(0,r.gn)([(0,s.qC)()],d.prototype,"name",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"fastMode",void 0),(0,a.H7)("BABYLON.ComputeShader",d)},91166:function(e,t,i){i.r(t),i.d(t,{ComputeShaderBoundingHelper:function(){return u}});var r=i(87868),s=i(91867),n=i(93954),a=i(39884),o=i(76608),l=i(29427);let c=`struct Results {minX : atomic<i32>,
minY : atomic<i32>,
minZ : atomic<i32>,
maxX : atomic<i32>,
maxY : atomic<i32>,
maxZ : atomic<i32>,
dummy1 : i32,
dummy2 : i32,};fn floatToBits(value: f32)->i32 {return bitcast<i32>(value);}
fn bitsToFloat(value: i32)->f32 {return bitcast<f32>(value);}
fn atomicMinFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value>=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn atomicMaxFloat(atomicVar: ptr<storage,atomic<i32>,read_write>,value: f32) {let intValue=floatToBits(value);loop {let oldIntValue=atomicLoad(atomicVar);let oldValue=bitsToFloat(oldIntValue);if (value<=oldValue) {break;}
if (atomicCompareExchangeWeak(atomicVar,oldIntValue,intValue).old_value==oldIntValue) {break;}}}
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);return mat4x4<f32>(m0,m1,m2,m3);}
const identity=mat4x4f(
vec4f(1.0,0.0,0.0,0.0),
vec4f(0.0,1.0,0.0,0.0),
vec4f(0.0,0.0,1.0,0.0),
vec4f(0.0,0.0,0.0,1.0)
);struct Settings {morphTargetTextureInfo: vec3f,
morphTargetCount: i32,
indexResult : u32,};@group(0) @binding(0) var<storage,read> positionBuffer : array<f32>;@group(0) @binding(1) var<storage,read_write> resultBuffer : array<Results>;@group(0) @binding(7) var<uniform> settings : Settings;
#if NUM_BONE_INFLUENCERS>0
@group(0) @binding(2) var boneSampler : texture_2d<f32>;@group(0) @binding(3) var<storage,read> indexBuffer : array<vec4f>;@group(0) @binding(4) var<storage,read> weightBuffer : array<vec4f>;
#if NUM_BONE_INFLUENCERS>4
@group(0) @binding(5) var<storage,read> indexExtraBuffer : array<vec4f>;@group(0) @binding(6) var<storage,read> weightExtraBuffer : array<vec4f>;
#endif
#endif
#ifdef MORPHTARGETS
@group(0) @binding(8) var morphTargets : texture_2d_array<f32>;@group(0) @binding(9) var<storage,read> morphTargetInfluences : array<f32>;@group(0) @binding(10) var<storage,read> morphTargetTextureIndices : array<f32>;
#endif
#ifdef MORPHTARGETS
fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : u32)->vec3f
{ 
let vertexID=f32(vertexIndex)*settings.morphTargetTextureInfo.x;let y=floor(vertexID/settings.morphTargetTextureInfo.y);let x=vertexID-y*settings.morphTargetTextureInfo.y;let textureUV=vec2<i32>(i32(x),i32(y));return textureLoad(morphTargets,textureUV,i32(morphTargetTextureIndices[targetIndex]),0).xyz;}
#endif
@compute @workgroup_size(256,1,1)
fn main(@builtin(global_invocation_id) global_id : vec3<u32>) {let index=global_id.x;if (index>=arrayLength(&positionBuffer)/3) {return;}
let position=vec3f(positionBuffer[index*3],positionBuffer[index*3+1],positionBuffer[index*3+2]);var finalWorld=identity;var positionUpdated=position;
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;let matricesIndices=indexBuffer[index];let matricesWeights=weightBuffer[index];influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
let matricesIndicesExtra=indexExtraBuffer[index];let matricesWeightsExtra=weightExtraBuffer[index];influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.x)*matricesWeightsExtra.x;
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.y)*matricesWeightsExtra.y;
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.z)*matricesWeightsExtra.z;
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra.w)*matricesWeightsExtra.w;
#endif 
#endif 
finalWorld=finalWorld*influence;
#endif
#ifdef MORPHTARGETS
for (var i=0; i<NUM_MORPH_INFLUENCERS; i=i+1) {if (i>=settings.morphTargetCount) {break;}
positionUpdated=positionUpdated+(readVector3FromRawSampler(i,index)-position)*morphTargetInfluences[i];}
#endif
var worldPos=finalWorld*vec4f(positionUpdated.x,positionUpdated.y,positionUpdated.z,1.0);atomicMinFloat(&resultBuffer[settings.indexResult].minX,worldPos.x);atomicMinFloat(&resultBuffer[settings.indexResult].minY,worldPos.y);atomicMinFloat(&resultBuffer[settings.indexResult].minZ,worldPos.z);atomicMaxFloat(&resultBuffer[settings.indexResult].maxX,worldPos.x);atomicMaxFloat(&resultBuffer[settings.indexResult].maxY,worldPos.y);atomicMaxFloat(&resultBuffer[settings.indexResult].maxZ,worldPos.z);}
`;l.v.ShadersStoreWGSL.boundingInfoComputeShader=c;class u{constructor(e){this._computeShadersCache={},this._positionBuffers={},this._indexBuffers={},this._weightBuffers={},this._indexExtraBuffers={},this._weightExtraBuffers={},this._morphTargetInfluenceBuffers={},this._morphTargetTextureIndexBuffers={},this._ubos=[],this._uboIndex=0,this._processedMeshes=[],this._computeShaders=[],this._uniqueComputeShaders=new Set,this._resultBuffers=[],this._engine=e}_getComputeShader(e,t,i){let s;let n=e.join("\n");if(this._computeShadersCache[n])s=this._computeShadersCache[n];else{let a={positionBuffer:{group:0,binding:0},resultBuffer:{group:0,binding:1},settings:{group:0,binding:7}};t&&(a.boneSampler={group:0,binding:2},a.indexBuffer={group:0,binding:3},a.weightBuffer={group:0,binding:4},a.indexExtraBuffer={group:0,binding:5},a.weightExtraBuffer={group:0,binding:6}),i&&(a.morphTargets={group:0,binding:8},a.morphTargetInfluences={group:0,binding:9},a.morphTargetTextureIndices={group:0,binding:10}),s=new r.U(`boundingInfoCompute${t?"_bones":""}${i?"_morphs":""}`,this._engine,"boundingInfo",{bindingsMapping:a,defines:e}),this._computeShadersCache[n]=s}return s}_getUBO(){if(this._uboIndex>=this._ubos.length){let e=new o.M(this._engine);e.addFloat3("morphTargetTextureInfo",0,0,0),e.addUniform("morphTargetCount",1),e.addUniform("indexResult",1),this._ubos.push(e)}return this._ubos[this._uboIndex++]}_extractDataAndLink(e,t,i,r,n,a){let o;let l=t.getTotalVertices();if(a[t.uniqueId])o=a[t.uniqueId];else{let e=t.getVertexBuffer(i)?.getFloatData(l);(o=new s.N(this._engine,Float32Array.BYTES_PER_ELEMENT*l*r)).update(e),a[t.uniqueId]=o}e.setStorageBuffer(n,o)}_prepareStorage(e,t,i,r,n,a){let o;r[i]?o=r[i]:(o=new s.N(this._engine,Float32Array.BYTES_PER_ELEMENT*n),r[i]=o),o.update(a),e.setStorageBuffer(t,o)}async processAsync(e){await this.registerMeshListAsync(e),this.processMeshList(),await this.fetchResultsForMeshListAsync()}registerMeshListAsync(e){this._disposeForMeshList(),Array.isArray(e)||(e=[e]);let t=0;for(let i=0;i<e.length;i++){let r=e[i];if(0===r.getTotalVertices()||!r.getVertexBuffer||!r.getVertexBuffer(n.o.PositionKind))continue;this._processedMeshes.push(r);let s=r.morphTargetManager;s&&(t=Math.max(t,s.numTargets))}for(let e=0;e<this._processedMeshes.length;e++){let i=this._processedMeshes[e],r=[""],s=!1;i&&i.useBones&&i.computeBonesUsingShaders&&i.skeleton&&(r.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),s=!0);let n=this._getComputeShader(r,s,!1);if(this._uniqueComputeShaders.add(n),i.morphTargetManager){(r=r.slice()).push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+t);let e=this._getComputeShader(r,s,!0);this._uniqueComputeShaders.add(e),this._computeShaders.push([n,e])}else this._computeShaders.push([n,n]);let a=this._getUBO();a.updateUInt("indexResult",e),a.update()}return new Promise(e=>{let t=()=>{let i=this._uniqueComputeShaders.keys();for(let e=i.next();!0!==e.done;e=i.next())if(!e.value.isReady()){setTimeout(t,10);return}e()};t()})}processMeshList(){if(0===this._processedMeshes.length)return;this._uboIndex=0;let e=8*this._processedMeshes.length,t=new Float32Array(e),i=new s.N(this._engine,Float32Array.BYTES_PER_ELEMENT*e);this._resultBuffers.push(i);for(let e=0;e<this._processedMeshes.length;e++)t[8*e+0]=Number.POSITIVE_INFINITY,t[8*e+1]=Number.POSITIVE_INFINITY,t[8*e+2]=Number.POSITIVE_INFINITY,t[8*e+3]=Number.NEGATIVE_INFINITY,t[8*e+4]=Number.NEGATIVE_INFINITY,t[8*e+5]=Number.NEGATIVE_INFINITY;i.update(t);for(let e=0;e<this._processedMeshes.length;e++){let t=this._processedMeshes[e],r=t.getTotalVertices(),[s,a]=this._computeShaders[e],o=t.morphTargetManager,l=o&&o.numInfluencers>0,c=l?a:s;if(this._extractDataAndLink(c,t,n.o.PositionKind,3,"positionBuffer",this._positionBuffers),t&&t.useBones&&t.computeBonesUsingShaders&&t.skeleton&&t.skeleton.useTextureToStoreBoneMatrices){this._extractDataAndLink(c,t,n.o.MatricesIndicesKind,4,"indexBuffer",this._indexBuffers),this._extractDataAndLink(c,t,n.o.MatricesWeightsKind,4,"weightBuffer",this._weightBuffers);let e=t.skeleton.getTransformMatrixTexture(t);c.setTexture("boneSampler",e,!1),t.numBoneInfluencers>4&&(this._extractDataAndLink(c,t,n.o.MatricesIndicesExtraKind,4,"indexExtraBuffer",this._indexExtraBuffers),this._extractDataAndLink(c,t,n.o.MatricesWeightsExtraKind,4,"weightExtraBuffer",this._weightExtraBuffers))}let u=this._getUBO();if(l){let e=o._targetStoreTexture;c.setTexture("morphTargets",e,!1),this._prepareStorage(c,"morphTargetInfluences",t.uniqueId,this._morphTargetInfluenceBuffers,o.numInfluencers,o.influences),this._prepareStorage(c,"morphTargetTextureIndices",t.uniqueId,this._morphTargetTextureIndexBuffers,o.numInfluencers,o._morphTargetTextureIndices),u.updateFloat3("morphTargetTextureInfo",o._textureVertexStride,o._textureWidth,o._textureHeight),u.updateInt("morphTargetCount",o.numInfluencers),u.update()}c.setStorageBuffer("resultBuffer",i),c.setUniformBuffer("settings",u),c.dispatch(Math.ceil(r/256)),this._engine.flushFramebuffer()}}fetchResultsForMeshListAsync(){return new Promise(e=>{let t=[],i=0;for(let e=0;e<this._resultBuffers.length;e++){let r=this._resultBuffers[e].getBuffer();t.push(r),i+=r.capacity}let r=new Float32Array(i/Float32Array.BYTES_PER_ELEMENT),s=a.P.Zero(),n=a.P.Zero(),o={minimum:s,maximum:n};this._engine.readFromMultipleStorageBuffers(t,0,void 0,r,!0).then(()=>{let t=0;for(let e=0;e<this._resultBuffers.length;e++){for(let i=0;i<this._processedMeshes.length;i++){let l=this._processedMeshes[i];a.P.FromArrayToRef(r,t+8*i,s),a.P.FromArrayToRef(r,t+8*i+3,n),e>0&&(s.minimizeInPlace(l.getBoundingInfo().minimum),n.maximizeInPlace(l.getBoundingInfo().maximum)),l._refreshBoundingInfoDirect(o)}t+=8*this._processedMeshes.length}for(let e of this._resultBuffers)e.dispose();this._resultBuffers=[],this._uboIndex=0,e()})})}_disposeCache(e){for(let t in e)e[t].dispose()}_disposeForMeshList(){for(let e of this._resultBuffers)e.dispose();this._resultBuffers=[],this._processedMeshes=[],this._computeShaders=[],this._uniqueComputeShaders=new Set}dispose(){for(let e of(this._disposeCache(this._positionBuffers),this._positionBuffers={},this._disposeCache(this._indexBuffers),this._indexBuffers={},this._disposeCache(this._weightBuffers),this._weightBuffers={},this._disposeCache(this._morphTargetInfluenceBuffers),this._morphTargetInfluenceBuffers={},this._disposeCache(this._morphTargetTextureIndexBuffers),this._morphTargetTextureIndexBuffers={},this._ubos))e.dispose();this._ubos=[],this._computeShadersCache={},this._engine=void 0,this._disposeForMeshList()}}},58093:function(e,t,i){i.r(t),i.d(t,{TransformFeedbackBoundingHelper:function(){return u}});var r=i(93954),s=i(3609),n=i(59874),a=i(39884),o=i(29427);i(74910),i(96944),i(50731),i(43626),i(76086),i(74436),i(27373),i(59343);let l=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
out vec3 outPosition;const mat4 identity=mat4(
vec4(1.0,0.0,0.0,0.0),
vec4(0.0,1.0,0.0,0.0),
vec4(0.0,0.0,1.0,0.0),
vec4(0.0,0.0,0.0,1.0)
);void main(void) {vec3 positionUpdated=position;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
mat4 finalWorld=identity;
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);outPosition=worldPos.xyz;}`;o.v.ShadersStore.gpuTransformVertexShader=l;let c=`#version 300 es
void main() {discard;}
`;o.v.ShadersStore.gpuTransformPixelShader=c;class u{constructor(e){this._buffers={},this._effects={},this._meshListCounter=0,this._engine=e}processAsync(e){return Array.isArray(e)||(e=[e]),this._meshListCounter=0,this._processMeshList(e),Promise.resolve()}_processMeshList(e){let t=this._engine.getCaps().parallelShaderCompile;this._engine.getCaps().parallelShaderCompile=void 0;for(let t=0;t<e.length;++t){let i;let n=e[t];if(0===n.getTotalVertices()||!n.getVertexBuffer||!n.getVertexBuffer(r.o.PositionKind))continue;let a=0,o=[],l=[],c=[r.o.PositionKind],u=[];if(n&&n.useBones&&n.computeBonesUsingShaders&&n.skeleton){c.push(r.o.MatricesIndicesKind),c.push(r.o.MatricesWeightsKind),n.numBoneInfluencers>4&&(c.push(r.o.MatricesIndicesExtraKind),c.push(r.o.MatricesWeightsExtraKind));let e=n.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),e.isUsingTextureForMatrices?(o.push("#define BONETEXTURE"),-1===l.indexOf("boneTextureWidth")&&l.push("boneTextureWidth"),-1===u.indexOf("boneSampler")&&u.push("boneSampler")):(o.push("#define BonesPerMesh "+(e.bones.length+1)),-1===l.indexOf("mBones")&&l.push("mBones"))}else o.push("#define NUM_BONE_INFLUENCERS 0");let h=n?n.morphTargetManager:null;if(h){(a=h.numMaxInfluencers||h.numInfluencers)>0&&o.push("#define MORPHTARGETS"),h.isUsingTextureForTargets&&(o.push("#define MORPHTARGETS_TEXTURE"),-1===l.indexOf("morphTargetTextureIndices")&&l.push("morphTargetTextureIndices"),-1===u.indexOf("morphTargets")&&u.push("morphTargets")),o.push("#define NUM_MORPH_INFLUENCERS "+a);for(let e=0;e<a;e++)c.push(r.o.PositionKind+e);a>0&&((l=l.slice()).push("morphTargetInfluences"),l.push("morphTargetCount"),l.push("morphTargetTextureInfo"),l.push("morphTargetTextureIndices"))}let d=n.bakedVertexAnimationManager;d&&d.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),-1===l.indexOf("bakedVertexAnimationSettings")&&l.push("bakedVertexAnimationSettings"),-1===l.indexOf("bakedVertexAnimationTextureSizeInverted")&&l.push("bakedVertexAnimationTextureSizeInverted"),-1===l.indexOf("bakedVertexAnimationTime")&&l.push("bakedVertexAnimationTime"),-1===u.indexOf("bakedVertexAnimationTexture")&&u.push("bakedVertexAnimationTexture"),(0,s.pd)(c,n,o));let f=o.join("\n");if(this._effects[f])i=this._effects[f];else{let e={attributes:c,uniformsNames:l,uniformBuffersNames:[],samplers:u,defines:f,fallbacks:null,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:a},maxSimultaneousLights:0,transformFeedbackVaryings:["outPosition"]};i=this._engine.createEffect("gpuTransform",e,this._engine),this._effects[f]=i}this._compute(n,i)}this._engine.getCaps().parallelShaderCompile=t}_compute(e,t){let i;let a=this._engine,o=e.getTotalVertices();if(this._buffers[e.uniqueId])i=this._buffers[e.uniqueId];else{let t=new Float32Array(3*o);i=new r.l(e.getEngine(),t,!0,3),this._buffers[e.uniqueId]=i}t.getEngine().enableEffect(t),e._bindDirect(t,null,!0),(0,s.qx)(e,t);let l=e.morphTargetManager;l&&l.numInfluencers>0&&(0,s.KG)(e,t);let c=e.bakedVertexAnimationManager;c&&c.isEnabled&&e.bakedVertexAnimationManager?.bind(t,!1);let h=i.getData();if(a.bindTransformFeedbackBuffer(i.getBuffer()),a.setRasterizerState(!1),a.beginTransformFeedback(!0),a.drawArraysType(2,0,o),a.endTransformFeedback(),a.setRasterizerState(!0),a.readTransformFeedbackBuffer(h),a.bindTransformFeedbackBuffer(null),0===this._meshListCounter)e._refreshBoundingInfo(h,null);else{let t=e.getBoundingInfo().boundingBox,i=(0,n.k)(h,0,o);u._Min.copyFrom(t.minimum).minimizeInPlace(i.minimum),u._Max.copyFrom(t.maximum).maximizeInPlace(i.maximum),e._refreshBoundingInfoDirect({minimum:u._Min,maximum:u._Max})}}registerMeshListAsync(e){return Array.isArray(e)||(e=[e]),this._meshList=e,this._meshListCounter=0,Promise.resolve()}processMeshList(){0!==this._meshList.length&&(this._processMeshList(this._meshList),this._meshListCounter++)}fetchResultsForMeshListAsync(){return this._meshListCounter=0,Promise.resolve()}dispose(){for(let e in this._buffers)this._buffers[e].dispose();this._buffers={},this._effects={},this._engine=null}}u._Min=new a.P,u._Max=new a.P},23050:function(e,t,i){i.d(t,{Bg:function(){return b},K7:function(){return f},XI:function(){return v},dv:function(){return E},kA:function(){return p},mo:function(){return x},pE:function(){return C},yc:function(){return d},z9:function(){return S},zH:function(){return u}});var r=i(31644),s=i(39884),n=i(178),a=i(13306),o=i(88251),l=i(51092),c=i(5325);class u{constructor(e,t,i=Number.MAX_VALUE,s=r.kn){this.origin=e,this.direction=t,this.length=i,this.epsilon=s}clone(){return new u(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){let r,s,n,a;let o=u._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),l=u._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i),c=0,h=Number.MAX_VALUE;if(1e-7>Math.abs(this.direction.x)){if(this.origin.x<o.x||this.origin.x>l.x)return!1}else if(r=1/this.direction.x,s=(o.x-this.origin.x)*r,(n=(l.x-this.origin.x)*r)==-1/0&&(n=1/0),s>n&&(a=s,s=n,n=a),(c=Math.max(s,c))>(h=Math.min(n,h)))return!1;if(1e-7>Math.abs(this.direction.y)){if(this.origin.y<o.y||this.origin.y>l.y)return!1}else if(r=1/this.direction.y,s=(o.y-this.origin.y)*r,(n=(l.y-this.origin.y)*r)==-1/0&&(n=1/0),s>n&&(a=s,s=n,n=a),(c=Math.max(s,c))>(h=Math.min(n,h)))return!1;if(1e-7>Math.abs(this.direction.z)){if(this.origin.z<o.z||this.origin.z>l.z)return!1}else if(r=1/this.direction.z,s=(o.z-this.origin.z)*r,(n=(l.z-this.origin.z)*r)==-1/0&&(n=1/0),s>n&&(a=s,s=n,n=a),(c=Math.max(s,c))>(h=Math.min(n,h)))return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){let i=e.center.x-this.origin.x,r=e.center.y-this.origin.y,s=e.center.z-this.origin.z,n=i*i+r*r+s*s,a=e.radius+t,o=a*a;if(n<=o)return!0;let l=i*this.direction.x+r*this.direction.y+s*this.direction.z;return!(l<0)&&n-l*l<=o}intersectsTriangle(e,t,i){let r=u._TmpVector3[0],n=u._TmpVector3[1],o=u._TmpVector3[2],l=u._TmpVector3[3],c=u._TmpVector3[4];t.subtractToRef(e,r),i.subtractToRef(e,n),s.P.CrossToRef(this.direction,n,o);let h=s.P.Dot(r,o);if(0===h)return null;let d=1/h;this.origin.subtractToRef(e,l);let f=s.P.Dot(l,o)*d;if(f<-this.epsilon||f>1+this.epsilon)return null;s.P.CrossToRef(l,r,c);let p=s.P.Dot(this.direction,c)*d;if(p<-this.epsilon||f+p>1+this.epsilon)return null;let m=s.P.Dot(n,c)*d;return m>this.length?null:new a.c(1-f-p,f,m)}intersectsPlane(e){let t;let i=s.P.Dot(e.normal,this.direction);if(999999997475243e-21>Math.abs(i))return null;{let r=s.P.Dot(e.normal,this.origin);return(t=(-e.d-r)/i)<0?t<-.000000999999997475243?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{let e=(this.origin.y-t)/this.direction.y;if(e>0)return null;return new s.P(this.origin.x+-(this.direction.x*e),t,this.origin.z+-(this.direction.z*e))}case"x":{let e=(this.origin.x-t)/this.direction.x;if(e>0)return null;return new s.P(t,this.origin.y+-(this.direction.y*e),this.origin.z+-(this.direction.z*e))}case"z":{let e=(this.origin.z-t)/this.direction.z;if(e>0)return null;return new s.P(this.origin.x+-(this.direction.x*e),this.origin.y+-(this.direction.y*e),t)}default:return null}}intersectsMesh(e,t,i,r=!1,n,a=!1){let o=s.jp.Matrix[0];return e.getWorldMatrix().invertToRef(o),this._tmpRay?u.TransformToRef(this,o,this._tmpRay):this._tmpRay=u.Transform(this,o),e.intersects(this._tmpRay,t,i,r,n,a)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let r=0;r<e.length;r++){let s=this.intersectsMesh(e[r],t);s.hit&&i.push(s)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){let r=this.origin,n=s.jp.Vector3[0],a=s.jp.Vector3[1],o=s.jp.Vector3[2],l=s.jp.Vector3[3];t.subtractToRef(e,n),this.direction.scaleToRef(u._Rayl,o),r.addToRef(o,a),e.subtractToRef(r,l);let c=s.P.Dot(n,n),h=s.P.Dot(n,o),d=s.P.Dot(o,o),f=s.P.Dot(n,l),p=s.P.Dot(o,l),m=c*d-h*h,_,g=m,v,S=m;m<u._Smallnum?(_=0,g=1,v=p,S=d):(_=h*p-d*f,v=c*p-h*f,_<0?(_=0,v=p,S=d):_>g&&(_=g,v=p+h,S=d)),v<0?(v=0,0>-f?_=0:-f>c?_=g:(_=-f,g=c)):v>S&&(v=S,-f+h<0?_=0:-f+h>c?_=g:(_=-f+h,g=c));let x=Math.abs(_)<u._Smallnum?0:_/g,E=Math.abs(v)<u._Smallnum?0:v/S,C=s.jp.Vector3[4];o.scaleToRef(E,C);let T=s.jp.Vector3[5];n.scaleToRef(x,T),T.addInPlace(l);let b=s.jp.Vector3[6];return(T.subtractToRef(C,b),E>0&&E<=this.length&&b.lengthSquared()<i*i)?T.length():-1}update(e,t,i,r,n,a,o,l=!1){if(l){u._RayDistant||(u._RayDistant=u.Zero()),u._RayDistant.unprojectRayToRef(e,t,i,r,s.y3.IdentityReadOnly,a,o);let l=s.jp.Matrix[0];n.invertToRef(l),u.TransformToRef(u._RayDistant,l,this)}else this.unprojectRayToRef(e,t,i,r,n,a,o);return this}static Zero(){return new u(s.P.Zero(),s.P.Zero())}static CreateNew(e,t,i,r,s,n,a){return u.Zero().update(e,t,i,r,s,n,a)}static CreateNewFromTo(e,t,i=s.y3.IdentityReadOnly){let r=new u(new s.P(0,0,0),new s.P(0,0,0));return u.CreateFromToToRef(e,t,r,i)}static CreateFromToToRef(e,t,i,r=s.y3.IdentityReadOnly){i.origin.copyFrom(e);let n=t.subtractToRef(e,i.direction),a=Math.sqrt(n.x*n.x+n.y*n.y+n.z*n.z);return i.length=a,i.direction.normalize(),u.TransformToRef(i,r,i)}static Transform(e,t){let i=new u(new s.P(0,0,0),new s.P(0,0,0));return u.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){s.P.TransformCoordinatesToRef(e.origin,t,i.origin),s.P.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length,i.epsilon=e.epsilon;let r=i.direction,n=r.length();if(!(0===n||1===n)){let e=1/n;r.x*=e,r.y*=e,r.z*=e,i.length*=n}return i}unprojectRayToRef(e,t,i,r,n,a,o){let c=s.jp.Matrix[0];n.multiplyToRef(a,c),c.multiplyToRef(o,c),c.invert();let u=l.l.LastCreatedEngine,h=s.jp.Vector3[0];h.x=e/i*2-1,h.y=-(t/r*2-1),h.z=u?.useReverseDepthBuffer?1:u?.isNDCHalfZRange?0:-1;let d=s.jp.Vector3[1].copyFromFloats(h.x,h.y,1-1e-8),f=s.jp.Vector3[2],p=s.jp.Vector3[3];s.P._UnprojectFromInvertedMatrixToRef(h,c,f),s.P._UnprojectFromInvertedMatrixToRef(d,c,p),this.origin.copyFrom(f),p.subtractToRef(f,this.direction),this.direction.normalize()}}function h(e,t,i,r,s,n=!1){let a=u.Zero();return d(e,t,i,r,a,s,n),a}function d(e,t,i,r,n,a,o=!1,l=!1){let c=e.getEngine();if(!a&&!(a=e.activeCamera))return e;let u=a.viewport,h=c.getRenderHeight(),{x:d,y:f,width:p,height:m}=u.toGlobal(c.getRenderWidth(),h),_=1/c.getHardwareScalingLevel();return t=t*_-d,i=i*_-(h-f-m),n.update(t,i,p,m,r||s.y3.IdentityReadOnly,o?s.y3.IdentityReadOnly:a.getViewMatrix(),a.getProjectionMatrix(),l),e}function f(e,t,i,r){let s=u.Zero();return p(e,t,i,s,r),s}function p(e,t,i,r,n){if(!o.p)return e;let a=e.getEngine();if(!n&&!(n=e.activeCamera))throw Error("Active camera not set");let l=n.viewport,c=a.getRenderHeight(),{x:u,y:h,width:d,height:f}=l.toGlobal(a.getRenderWidth(),c),p=s.y3.Identity(),m=1/a.getHardwareScalingLevel();return t=t*m-u,i=i*m-(c-h-f),r.update(t,i,d,f,p,p,n.getProjectionMatrix()),e}function m(e,t,i,r,s,n,a,o){let l=t(r,i.enableDistantPicking),c=i.intersects(l,s,a,n,r,o);return c&&c.hit&&(s||null==e||!(c.distance>=e.distance))?c:null}function _(e,t,i,r,n,a){let l=null,c=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),u=e.cameraToUseForPointers||e.activeCamera;for(let o=0;o<e.meshes.length;o++){let h=e.meshes[o];if(i){if(!i(h,-1))continue}else if(!h.isEnabled()||!h.isVisible||!h.isPickable)continue;let d=c&&h.isWorldMatrixCameraDependent(),f=h.computeWorldMatrix(d,u);if(h.hasThinInstances&&h.thinInstanceEnablePicking){let e=m(l,t,h,f,!0,!0,a);if(e){if(n)return e;let o=s.jp.Matrix[1],c=h.thinInstanceGetWorldMatrices();for(let e=0;e<c.length;e++){if(i&&!i(h,e))continue;c[e].multiplyToRef(f,o);let s=m(l,t,h,o,r,n,a,!0);if(s&&((l=s).thinInstanceIndex=e,r))return l}}}else{let e=m(l,t,h,f,r,n,a);if(e&&(l=e,r))return l}}return l||new o.p}function g(e,t,i,r){if(!o.p)return null;let n=[],a=!!(e.activeCameras&&e.activeCameras.length>1&&e.cameraToUseForPointers!==e.activeCamera),l=e.cameraToUseForPointers||e.activeCamera;for(let o=0;o<e.meshes.length;o++){let c=e.meshes[o];if(i){if(!i(c,-1))continue}else if(!c.isEnabled()||!c.isVisible||!c.isPickable)continue;let u=a&&c.isWorldMatrixCameraDependent(),h=c.computeWorldMatrix(u,l);if(c.hasThinInstances&&c.thinInstanceEnablePicking){if(m(null,t,c,h,!0,!0,r)){let e=s.jp.Matrix[1],a=c.thinInstanceGetWorldMatrices();for(let s=0;s<a.length;s++){if(i&&!i(c,s))continue;a[s].multiplyToRef(h,e);let o=m(null,t,c,e,!1,!1,r,!0);o&&(o.thinInstanceIndex=s,n.push(o))}}}else{let e=m(null,t,c,h,!1,!1,r);e&&n.push(e)}}return n}function v(e,t,i,r,n,a){if(!o.p)return null;let l=_(e,r=>(e._tempPickingRay||(e._tempPickingRay=u.Zero()),d(e,t,i,r,e._tempPickingRay,a||null),e._tempPickingRay),r,n,!0);return l&&(l.ray=h(e,t,i,s.y3.Identity(),a||null)),l}function S(e,t,i,r,n,a,o,l=!1){let c=_(e,(r,s)=>(e._tempPickingRay||(e._tempPickingRay=u.Zero()),d(e,t,i,r,e._tempPickingRay,a||null,!1,s),e._tempPickingRay),r,n,!1,o);return c&&(c.ray=h(e,t,i,s.y3.Identity(),a||null)),c}function x(e,t,i,r,n){let a=_(e,i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=s.y3.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=u.Zero()),u.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform),i,r,!1,n);return a&&(a.ray=t),a}function E(e,t,i,r,s,n){return g(e,r=>h(e,t,i,r,s||null),r,n)}function C(e,t,i,r){return g(e,i=>(e._pickWithRayInverseMatrix||(e._pickWithRayInverseMatrix=s.y3.Identity()),i.invertToRef(e._pickWithRayInverseMatrix),e._cachedRayForTransform||(e._cachedRayForTransform=u.Zero()),u.TransformToRef(t,e._pickWithRayInverseMatrix,e._cachedRayForTransform),e._cachedRayForTransform),i,r)}function T(e,t,i=100,r,n){r||(r=e.getWorldMatrix()),t.length=i,n?t.origin.copyFrom(n):t.origin.copyFrom(e.position);let a=s.jp.Vector3[2];a.set(0,0,e._scene.useRightHandedSystem?-1:1);let o=s.jp.Vector3[3];return s.P.TransformNormalToRef(a,r,o),s.P.NormalizeToRef(o,t.direction),t}function b(e,t){t&&(t.prototype.getForwardRay=function(e=100,t,i){return T(this,new u(s.P.Zero(),s.P.Zero(),e),e,t,i)},t.prototype.getForwardRayToRef=function(e,t=100,i,r){return T(this,e,t,i,r)}),e&&(c.r._IsPickingAvailable=!0,e.prototype.createPickingRay=function(e,t,i,r,s=!1){return h(this,e,t,i,r,s)})}u._TmpVector3=(0,n.$G)(6,s.P.Zero),u._RayDistant=u.Zero(),u._Smallnum=1e-8,u._Rayl=1e9},7981:function(e,t,i){i.d(t,{zH:function(){return n.zH}});var r=i(44755),s=i(35910),n=i(23050);(0,n.Bg)(r.x,s.V),r.x.prototype.createPickingRayToRef=function(e,t,i,r,s,a=!1,o=!1){return(0,n.yc)(this,e,t,i,r,s,a,o)},r.x.prototype.createPickingRayInCameraSpace=function(e,t,i){return(0,n.K7)(this,e,t,i)},r.x.prototype.createPickingRayInCameraSpaceToRef=function(e,t,i,r){return(0,n.kA)(this,e,t,i,r)},r.x.prototype.pickWithBoundingInfo=function(e,t,i,r,s){return(0,n.XI)(this,e,t,i,r,s)},r.x.prototype.pick=function(e,t,i,r,s,a,o=!1){return(0,n.z9)(this,e,t,i,r,s,a,o)},r.x.prototype.pickWithRay=function(e,t,i,r){return(0,n.mo)(this,e,t,i,r)},r.x.prototype.multiPick=function(e,t,i,r,s){return(0,n.dv)(this,e,t,i,r,s)},r.x.prototype.multiPickWithRay=function(e,t,i){return(0,n.pE)(this,e,t,i)}},91410:function(e,t,i){var r=i(61146),s=i(46263),n=i(9520);s.ThinEngine.prototype.createDynamicTexture=function(e,t,i,s){let a=new n.l(this,4);return a.baseWidth=e,a.baseHeight=t,i&&(e=this.needPOTTextures?(0,r.p7)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,r.p7)(t,this._caps.maxTextureSize):t),a.width=e,a.height=t,a.isReady=!1,a.generateMipMaps=i,a.samplingMode=s,this.updateTextureSamplingMode(s,a),this._internalTexturesCache.push(a),a},s.ThinEngine.prototype.updateDynamicTexture=function(e,t,i,r=!1,s,n=!1,a=!1){if(!e)return;let o=this._gl,l=o.TEXTURE_2D,c=this._bindTextureDirectly(l,e,!0,n);this._unpackFlipY(void 0===i?e.invertY:i),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);let u=this._getWebGLTextureType(e.type),h=this._getInternalFormat(s||e.format),d=this._getRGBABufferInternalSizedFormat(e.type,h);o.texImage2D(l,0,d,h,u,t),e.generateMipMaps&&o.generateMipmap(l),c||this._bindTextureDirectly(l,null),r&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),s&&(e.format=s),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0}},32985:function(e,t,i){i.d(t,{Z:function(){return n}});var r=i(9719),s=i(2463);class n{get code(){return this._sourceCode}constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}processCode(){this.debug&&r.Y.Log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&r.Y.Log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){let t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;let i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&r.Y.Warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}let a=n._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!a){this.debug&&r.Y.Warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}let[o,l]=[a[3],a[4]],c=(0,s.vt)("(",")",this._sourceCode,i);if(c<0){this.debug&&r.Y.Warn(`Could not extract the parameters the function '${l}' (type=${o}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}let u=this._sourceCode.substring(i+1,c),h=(0,s.Pm)(this._sourceCode,c+1);if(h===this._sourceCode.length){this.debug&&r.Y.Warn(`Could not extract the body of the function '${l}' (type=${o}). funcParamsEndIndex=${c}`),e=t+this.inlineToken.length;continue}let d=(0,s.vt)("{","}",this._sourceCode,h);if(d<0){this.debug&&r.Y.Warn(`Could not extract the body of the function '${l}' (type=${o}). funcBodyStartIndex=${h}`),e=t+this.inlineToken.length;continue}let f=this._sourceCode.substring(h,d+1),p=(0,s.Kt)(u).split(","),m=[];for(let e=0;e<p.length;++e){let t=p[e].trim(),i=t.lastIndexOf(" ");i>=0&&m.push(t.substring(i+1))}"void"!==o&&m.push("return"),this._functionDescr.push({name:l,type:o,parameters:m,body:f,callIndex:0}),e=d+1;let _=t>0?this._sourceCode.substring(0,t):"",g=d+1<this._sourceCode.length-1?this._sourceCode.substring(d+1):"";this._sourceCode=_+g,e-=d+1-t}this.debug&&r.Y.Log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=${this._functionDescr}`)}_processInlining(e=20){for(;e-- >=0&&this._replaceFunctionCallsByCode(););return this.debug&&r.Y.Log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(let t of this._functionDescr){let{name:i,type:n,parameters:a,body:o}=t,l=0;for(;l<this._sourceCode.length;){let c=this._sourceCode.indexOf(i,l);if(c<0)break;if(0===c||(0,s.uA)(this._sourceCode.charAt(c-1))){l=c+i.length;continue}let u=(0,s.Pm)(this._sourceCode,c+i.length);if(u===this._sourceCode.length||"("!==this._sourceCode.charAt(u)){l=c+i.length;continue}let h=(0,s.vt)("(",")",this._sourceCode,u);if(h<0){this.debug&&r.Y.Warn(`Could not extract the parameters of the function call. Function '${i}' (type=${n}). callParamsStartIndex=${u}`),l=c+i.length;continue}let d=this._sourceCode.substring(u+1,h),f=(e=>{let t=[],i=0,r=0;for(;i<e.length;){if("("===e.charAt(i)){let t=(0,s.vt)("(",")",e,i);if(t<0)return null;i=t}else","===e.charAt(i)&&(t.push(e.substring(r,i)),r=i+1);i++}return r<i&&t.push(e.substring(r,i)),t})((0,s.Kt)(d));if(null===f){this.debug&&r.Y.Warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${n}). callParamsStartIndex=${u}, callParams=`+d),l=c+i.length;continue}let p=[];for(let e=0;e<f.length;++e){let t=f[e].trim();p.push(t)}let m="void"!==n?i+"_"+t.callIndex++:null;if(m&&p.push(m+" ="),p.length!==a.length){this.debug&&r.Y.Warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${n}). function parameters=${a}, call parameters=${p}`),l=c+i.length;continue}l=h+1;let _=this._replaceNames(o,a,p),g=c>0?this._sourceCode.substring(0,c):"",v=h+1<this._sourceCode.length-1?this._sourceCode.substring(h+1):"";if(m){let e=(0,s.wm)(this._sourceCode,c-1,"\n","{");g=this._sourceCode.substring(0,e+1);let t=this._sourceCode.substring(e+1,c);this._sourceCode=g+n+" "+m+";\n"+_+"\n"+t+m+v,this.debug&&r.Y.Log(`Replace function call by code. Function '${i}' (type=${n}). injectDeclarationIndex=${e}, call parameters=${p}`)}else this._sourceCode=g+_+v,l+=_.length-(h+1-c),this.debug&&r.Y.Log(`Replace function call by code. Function '${i}' (type=${n}). functionCallIndex=${c}, call parameters=${p}`);e=!0}}return e}_replaceNames(e,t,i){for(let r=0;r<t.length;++r){let n=RegExp((0,s.AW)(t[r]),"g"),a=t[r].length,o=i[r];e=e.replace(n,(i,...n)=>{let l=n[0];return(0,s.uA)(e.charAt(l-1))||(0,s.uA)(e.charAt(l+a))?t[r]:o})}return e}}n._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/},64525:function(e,t,i){i.d(t,{Q:function(){return s}});var r=i(51366);class s{constructor(){this._gpuTimeInFrameId=-1,this.counter=new r.z}_addDuration(e,t){e<this._gpuTimeInFrameId||(this._gpuTimeInFrameId!==e?(this.counter._fetchResult(),this.counter.fetchNewFrame(),this.counter.addCount(t,!1),this._gpuTimeInFrameId=e):this.counter.addCount(t,!1))}}},58535:function(e,t,i){i.d(t,{g:function(){return r}});class r{}r.AUTOSAMPLERSUFFIX="Sampler",r.DISABLEUA="#define DISABLE_UNIFORMITY_ANALYSIS",r.ALPHA_DISABLE=0,r.ALPHA_ADD=1,r.ALPHA_COMBINE=2,r.ALPHA_SUBTRACT=3,r.ALPHA_MULTIPLY=4,r.ALPHA_MAXIMIZED=5,r.ALPHA_ONEONE=6,r.ALPHA_PREMULTIPLIED=7,r.ALPHA_PREMULTIPLIED_PORTERDUFF=8,r.ALPHA_INTERPOLATE=9,r.ALPHA_SCREENMODE=10,r.ALPHA_ONEONE_ONEONE=11,r.ALPHA_ALPHATOCOLOR=12,r.ALPHA_REVERSEONEMINUS=13,r.ALPHA_SRC_DSTONEMINUSSRCALPHA=14,r.ALPHA_ONEONE_ONEZERO=15,r.ALPHA_EXCLUSION=16,r.ALPHA_LAYER_ACCUMULATE=17,r.ALPHA_EQUATION_ADD=0,r.ALPHA_EQUATION_SUBSTRACT=1,r.ALPHA_EQUATION_REVERSE_SUBTRACT=2,r.ALPHA_EQUATION_MAX=3,r.ALPHA_EQUATION_MIN=4,r.ALPHA_EQUATION_DARKEN=5,r.DELAYLOADSTATE_NONE=0,r.DELAYLOADSTATE_LOADED=1,r.DELAYLOADSTATE_LOADING=2,r.DELAYLOADSTATE_NOTLOADED=4,r.NEVER=512,r.ALWAYS=519,r.LESS=513,r.EQUAL=514,r.LEQUAL=515,r.GREATER=516,r.GEQUAL=518,r.NOTEQUAL=517,r.KEEP=7680,r.ZERO=0,r.REPLACE=7681,r.INCR=7682,r.DECR=7683,r.INVERT=5386,r.INCR_WRAP=34055,r.DECR_WRAP=34056,r.TEXTURE_CLAMP_ADDRESSMODE=0,r.TEXTURE_WRAP_ADDRESSMODE=1,r.TEXTURE_MIRROR_ADDRESSMODE=2,r.TEXTURE_CREATIONFLAG_STORAGE=1,r.TEXTUREFORMAT_ALPHA=0,r.TEXTUREFORMAT_LUMINANCE=1,r.TEXTUREFORMAT_LUMINANCE_ALPHA=2,r.TEXTUREFORMAT_RGB=4,r.TEXTUREFORMAT_RGBA=5,r.TEXTUREFORMAT_RED=6,r.TEXTUREFORMAT_R=6,r.TEXTUREFORMAT_RG=7,r.TEXTUREFORMAT_RED_INTEGER=8,r.TEXTUREFORMAT_R_INTEGER=8,r.TEXTUREFORMAT_RG_INTEGER=9,r.TEXTUREFORMAT_RGB_INTEGER=10,r.TEXTUREFORMAT_RGBA_INTEGER=11,r.TEXTUREFORMAT_BGRA=12,r.TEXTUREFORMAT_DEPTH24_STENCIL8=13,r.TEXTUREFORMAT_DEPTH32_FLOAT=14,r.TEXTUREFORMAT_DEPTH16=15,r.TEXTUREFORMAT_DEPTH24=16,r.TEXTUREFORMAT_DEPTH24UNORM_STENCIL8=17,r.TEXTUREFORMAT_DEPTH32FLOAT_STENCIL8=18,r.TEXTUREFORMAT_STENCIL8=19,r.TEXTUREFORMAT_UNDEFINED=4294967295,r.TEXTUREFORMAT_COMPRESSED_RGBA_BPTC_UNORM=36492,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_BPTC_UNORM=36493,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT=36495,r.TEXTUREFORMAT_COMPRESSED_RGB_BPTC_SIGNED_FLOAT=36494,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT5=33779,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT3=33778,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918,r.TEXTUREFORMAT_COMPRESSED_RGBA_S3TC_DXT1=33777,r.TEXTUREFORMAT_COMPRESSED_RGB_S3TC_DXT1=33776,r.TEXTUREFORMAT_COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917,r.TEXTUREFORMAT_COMPRESSED_SRGB_S3TC_DXT1_EXT=35916,r.TEXTUREFORMAT_COMPRESSED_RGBA_ASTC_4x4=37808,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840,r.TEXTUREFORMAT_COMPRESSED_RGB_ETC1_WEBGL=36196,r.TEXTUREFORMAT_COMPRESSED_RGB8_ETC2=37492,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ETC2=37493,r.TEXTUREFORMAT_COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494,r.TEXTUREFORMAT_COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495,r.TEXTUREFORMAT_COMPRESSED_RGBA8_ETC2_EAC=37496,r.TEXTUREFORMAT_COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497,r.TEXTURETYPE_UNSIGNED_BYTE=0,r.TEXTURETYPE_UNSIGNED_INT=0,r.TEXTURETYPE_FLOAT=1,r.TEXTURETYPE_HALF_FLOAT=2,r.TEXTURETYPE_BYTE=3,r.TEXTURETYPE_SHORT=4,r.TEXTURETYPE_UNSIGNED_SHORT=5,r.TEXTURETYPE_INT=6,r.TEXTURETYPE_UNSIGNED_INTEGER=7,r.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8,r.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9,r.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10,r.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11,r.TEXTURETYPE_UNSIGNED_INT_24_8=12,r.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13,r.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14,r.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15,r.TEXTURETYPE_UNDEFINED=16,r.TEXTURE_2D=3553,r.TEXTURE_2D_ARRAY=35866,r.TEXTURE_CUBE_MAP=34067,r.TEXTURE_CUBE_MAP_ARRAY=3735928559,r.TEXTURE_3D=32879,r.TEXTURE_NEAREST_SAMPLINGMODE=1,r.TEXTURE_NEAREST_NEAREST=1,r.TEXTURE_BILINEAR_SAMPLINGMODE=2,r.TEXTURE_LINEAR_LINEAR=2,r.TEXTURE_TRILINEAR_SAMPLINGMODE=3,r.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3,r.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4,r.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5,r.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6,r.TEXTURE_NEAREST_LINEAR=7,r.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8,r.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9,r.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10,r.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11,r.TEXTURE_LINEAR_NEAREST=12,r.TEXTURE_EXPLICIT_MODE=0,r.TEXTURE_SPHERICAL_MODE=1,r.TEXTURE_PLANAR_MODE=2,r.TEXTURE_CUBIC_MODE=3,r.TEXTURE_PROJECTION_MODE=4,r.TEXTURE_SKYBOX_MODE=5,r.TEXTURE_INVCUBIC_MODE=6,r.TEXTURE_EQUIRECTANGULAR_MODE=7,r.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8,r.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9,r.TEXTURE_FILTERING_QUALITY_OFFLINE=4096,r.TEXTURE_FILTERING_QUALITY_HIGH=64,r.TEXTURE_FILTERING_QUALITY_MEDIUM=16,r.TEXTURE_FILTERING_QUALITY_LOW=8,r.SCALEMODE_FLOOR=1,r.SCALEMODE_NEAREST=2,r.SCALEMODE_CEILING=3,r.MATERIAL_TextureDirtyFlag=1,r.MATERIAL_LightDirtyFlag=2,r.MATERIAL_FresnelDirtyFlag=4,r.MATERIAL_AttributesDirtyFlag=8,r.MATERIAL_MiscDirtyFlag=16,r.MATERIAL_PrePassDirtyFlag=32,r.MATERIAL_AllDirtyFlag=63,r.MATERIAL_TriangleFillMode=0,r.MATERIAL_WireFrameFillMode=1,r.MATERIAL_PointFillMode=2,r.MATERIAL_PointListDrawMode=3,r.MATERIAL_LineListDrawMode=4,r.MATERIAL_LineLoopDrawMode=5,r.MATERIAL_LineStripDrawMode=6,r.MATERIAL_TriangleStripDrawMode=7,r.MATERIAL_TriangleFanDrawMode=8,r.MATERIAL_ClockWiseSideOrientation=0,r.MATERIAL_CounterClockWiseSideOrientation=1,r.ACTION_NothingTrigger=0,r.ACTION_OnPickTrigger=1,r.ACTION_OnLeftPickTrigger=2,r.ACTION_OnRightPickTrigger=3,r.ACTION_OnCenterPickTrigger=4,r.ACTION_OnPickDownTrigger=5,r.ACTION_OnDoublePickTrigger=6,r.ACTION_OnPickUpTrigger=7,r.ACTION_OnPickOutTrigger=16,r.ACTION_OnLongPressTrigger=8,r.ACTION_OnPointerOverTrigger=9,r.ACTION_OnPointerOutTrigger=10,r.ACTION_OnEveryFrameTrigger=11,r.ACTION_OnIntersectionEnterTrigger=12,r.ACTION_OnIntersectionExitTrigger=13,r.ACTION_OnKeyDownTrigger=14,r.ACTION_OnKeyUpTrigger=15,r.PARTICLES_BILLBOARDMODE_Y=2,r.PARTICLES_BILLBOARDMODE_ALL=7,r.PARTICLES_BILLBOARDMODE_STRETCHED=8,r.PARTICLES_BILLBOARDMODE_STRETCHED_LOCAL=9,r.MESHES_CULLINGSTRATEGY_STANDARD=0,r.MESHES_CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2,r.MESHES_CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3,r.SCENELOADER_NO_LOGGING=0,r.SCENELOADER_MINIMAL_LOGGING=1,r.SCENELOADER_SUMMARY_LOGGING=2,r.SCENELOADER_DETAILED_LOGGING=3,r.PREPASS_IRRADIANCE_TEXTURE_TYPE=0,r.PREPASS_POSITION_TEXTURE_TYPE=1,r.PREPASS_VELOCITY_TEXTURE_TYPE=2,r.PREPASS_REFLECTIVITY_TEXTURE_TYPE=3,r.PREPASS_COLOR_TEXTURE_TYPE=4,r.PREPASS_DEPTH_TEXTURE_TYPE=5,r.PREPASS_NORMAL_TEXTURE_TYPE=6,r.PREPASS_ALBEDO_SQRT_TEXTURE_TYPE=7,r.PREPASS_WORLD_NORMAL_TEXTURE_TYPE=8,r.PREPASS_LOCAL_POSITION_TEXTURE_TYPE=9,r.PREPASS_SCREENSPACE_DEPTH_TEXTURE_TYPE=10,r.PREPASS_VELOCITY_LINEAR_TEXTURE_TYPE=11,r.BUFFER_CREATIONFLAG_READ=1,r.BUFFER_CREATIONFLAG_WRITE=2,r.BUFFER_CREATIONFLAG_READWRITE=3,r.BUFFER_CREATIONFLAG_UNIFORM=4,r.BUFFER_CREATIONFLAG_VERTEX=8,r.BUFFER_CREATIONFLAG_INDEX=16,r.BUFFER_CREATIONFLAG_STORAGE=32,r.BUFFER_CREATIONFLAG_INDIRECT=64,r.RENDERPASS_MAIN=0,r.INPUT_ALT_KEY=18,r.INPUT_CTRL_KEY=17,r.INPUT_META_KEY1=91,r.INPUT_META_KEY2=92,r.INPUT_META_KEY3=93,r.INPUT_SHIFT_KEY=16,r.SNAPSHOTRENDERING_STANDARD=0,r.SNAPSHOTRENDERING_FAST=1,r.PERSPECTIVE_CAMERA=0,r.ORTHOGRAPHIC_CAMERA=1,r.FOVMODE_VERTICAL_FIXED=0,r.FOVMODE_HORIZONTAL_FIXED=1,r.RIG_MODE_NONE=0,r.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11,r.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12,r.RIG_MODE_STEREOSCOPIC_OVERUNDER=13,r.RIG_MODE_STEREOSCOPIC_INTERLACED=14,r.RIG_MODE_VR=20,r.RIG_MODE_CUSTOM=22,r.MAX_SUPPORTED_UV_SETS=6,r.GL_ALPHA_EQUATION_ADD=32774,r.GL_ALPHA_EQUATION_MIN=32775,r.GL_ALPHA_EQUATION_MAX=32776,r.GL_ALPHA_EQUATION_SUBTRACT=32778,r.GL_ALPHA_EQUATION_REVERSE_SUBTRACT=32779,r.GL_ALPHA_FUNCTION_SRC=768,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_COLOR=769,r.GL_ALPHA_FUNCTION_SRC_ALPHA=770,r.GL_ALPHA_FUNCTION_ONE_MINUS_SRC_ALPHA=771,r.GL_ALPHA_FUNCTION_DST_ALPHA=772,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_ALPHA=773,r.GL_ALPHA_FUNCTION_DST_COLOR=774,r.GL_ALPHA_FUNCTION_ONE_MINUS_DST_COLOR=775,r.GL_ALPHA_FUNCTION_SRC_ALPHA_SATURATED=776,r.GL_ALPHA_FUNCTION_CONSTANT_COLOR=32769,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_COLOR=32770,r.GL_ALPHA_FUNCTION_CONSTANT_ALPHA=32771,r.GL_ALPHA_FUNCTION_ONE_MINUS_CONSTANT_ALPHA=32772,r.SnippetUrl="https://snippet.babylonjs.com",r.FOGMODE_NONE=0,r.FOGMODE_EXP=1,r.FOGMODE_EXP2=2,r.FOGMODE_LINEAR=3,r.BYTE=5120,r.UNSIGNED_BYTE=5121,r.SHORT=5122,r.UNSIGNED_SHORT=5123,r.INT=5124,r.UNSIGNED_INT=5125,r.FLOAT=5126,r.PositionKind="position",r.NormalKind="normal",r.TangentKind="tangent",r.UVKind="uv",r.UV2Kind="uv2",r.UV3Kind="uv3",r.UV4Kind="uv4",r.UV5Kind="uv5",r.UV6Kind="uv6",r.ColorKind="color",r.ColorInstanceKind="instanceColor",r.MatricesIndicesKind="matricesIndices",r.MatricesWeightsKind="matricesWeights",r.MatricesIndicesExtraKind="matricesIndicesExtra",r.MatricesWeightsExtraKind="matricesWeightsExtra"},21204:function(e,t,i){i.d(t,{o:function(){return s},p:function(){return r}});class r{}r.COPY=1,r.CUT=2,r.PASTE=3;class s{constructor(e,t){this.type=e,this.event=t}static GetTypeFromCharacter(e){switch(e){case 67:return r.COPY;case 86:return r.PASTE;case 88:return r.CUT;default:return -1}}}},82076:function(e,t,i){i.d(t,{tb:function(){return f}});var r,s,n,a,o=i(39884),l=i(35823),c=i(35910),u=i(38018),h=i(74909),d=i(59744);(r=n||(n={}))[r.Origin=0]="Origin",r[r.Pivot=1]="Pivot",(s=a||(a={}))[s.World=0]="World",s[s.Local=1]="Local";class f{set scaleRatio(e){this._scaleRatio=e}get scaleRatio(){return this._scaleRatio}get isHovered(){return this._isHovered}get attachedMesh(){return this._attachedMesh}set attachedMesh(e){this._attachedMesh=e,e&&(this._attachedNode=e),this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}get attachedNode(){return this._attachedNode}set attachedNode(e){this._attachedNode=e,this._attachedMesh=null,this._rootMesh.setEnabled(!!e),this._attachedNodeChanged(e)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._rootMesh.getChildMeshes().forEach(e=>{e.dispose()}),e.parent=this._rootMesh,this._customMeshSet=!0}get additionalTransformNode(){return this._additionalTransformNode}set additionalTransformNode(e){this._additionalTransformNode=e}set updateGizmoRotationToMatchAttachedMesh(e){this._updateGizmoRotationToMatchAttachedMesh=e}get updateGizmoRotationToMatchAttachedMesh(){return this._updateGizmoRotationToMatchAttachedMesh}set updateGizmoPositionToMatchAttachedMesh(e){this._updateGizmoPositionToMatchAttachedMesh=e}get updateGizmoPositionToMatchAttachedMesh(){return this._updateGizmoPositionToMatchAttachedMesh}set anchorPoint(e){this._anchorPoint=e}get anchorPoint(){return this._anchorPoint}set coordinatesMode(e){this._coordinatesMode=e,this.updateGizmoRotationToMatchAttachedMesh=1==e,this.updateGizmoPositionToMatchAttachedMesh=!0}get coordinatesMode(){return this._coordinatesMode}set updateScale(e){this._updateScale=e}get updateScale(){return this._updateScale}_attachedNodeChanged(e){}constructor(e=u.x.DefaultUtilityLayer){this.gizmoLayer=e,this._attachedMesh=null,this._attachedNode=null,this._customRotationQuaternion=null,this._scaleRatio=1,this._isHovered=!1,this._customMeshSet=!1,this._updateGizmoRotationToMatchAttachedMesh=!0,this._updateGizmoPositionToMatchAttachedMesh=!0,this._anchorPoint=0,this._updateScale=!0,this._coordinatesMode=1,this._interactionsEnabled=!0,this._rightHandtoLeftHandMatrix=o.y3.RotationY(Math.PI),this._rootMesh=new l.Kj("gizmoRootNode",e.utilityLayerScene),this._rootMesh.rotationQuaternion=o._f.Identity(),this._beforeRenderObserver=this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.add(()=>{this._update()})}get customRotationQuaternion(){return this._customRotationQuaternion}set customRotationQuaternion(e){this._customRotationQuaternion=e}_update(){if(this.attachedNode){let e=this.attachedNode;if(this.attachedMesh&&(e=this.attachedMesh||this.attachedNode),this.updateGizmoPositionToMatchAttachedMesh){if(1==this.anchorPoint&&e.getAbsolutePivotPoint){let t=e.getAbsolutePivotPoint();this._rootMesh.position.copyFrom(t)}else{let t=e.getWorldMatrix().getRow(3),i=t?t.toVector3():new o.P(0,0,0);this._rootMesh.position.copyFrom(i)}}if(this.updateGizmoRotationToMatchAttachedMesh){let t=e._isMesh||"AbstractMesh"===e.getClassName()||"TransformNode"===e.getClassName()||"InstancedMesh"===e.getClassName()?e:void 0;e.getWorldMatrix().decompose(void 0,this._rootMesh.rotationQuaternion,void 0,f.PreserveScaling?t:void 0),this._rootMesh.rotationQuaternion.normalize()}else this._customRotationQuaternion?this._rootMesh.rotationQuaternion.copyFrom(this._customRotationQuaternion):this._rootMesh.rotationQuaternion.set(0,0,0,1);if(this.updateScale){let t=this.gizmoLayer.utilityLayerScene.activeCamera,i=t.globalPosition;this._rootMesh.position.subtractToRef(i,o.jp.Vector3[0]);let r=this.scaleRatio;if(t.mode==c.V.ORTHOGRAPHIC_CAMERA)t.orthoTop&&t.orthoBottom&&(r*=t.orthoTop-t.orthoBottom);else{let e=t.getScene().useRightHandedSystem?o.P.RightHandedForwardReadOnly:o.P.LeftHandedForwardReadOnly,i=t.getDirection(e);r*=o.P.Dot(o.jp.Vector3[0],i)}this._rootMesh.scaling.setAll(r),0>e._getWorldMatrixDeterminant()&&!f.PreserveScaling&&(this._rootMesh.scaling.y*=-1)}else this._rootMesh.scaling.setAll(this.scaleRatio)}this.additionalTransformNode&&(this._rootMesh.computeWorldMatrix(!0),this._rootMesh.getWorldMatrix().multiplyToRef(this.additionalTransformNode.getWorldMatrix(),o.jp.Matrix[0]),o.jp.Matrix[0].decompose(this._rootMesh.scaling,this._rootMesh.rotationQuaternion,this._rootMesh.position))}_handlePivotMatrixInverse(e,t,i){if(e.isUsingPivotMatrix()&&!e.isUsingPostMultiplyPivotMatrix()){e.getPivotMatrix().invertToRef(o.jp.Matrix[5]),o.jp.Matrix[5].multiplyToRef(t,i);return}i.copyFrom(t)}_matrixChanged(){if(this._attachedNode){if(this._attachedNode._isCamera){let e,t;let i=this._attachedNode;if(i.parent){let t=o.jp.Matrix[1];i.parent._worldMatrix.invertToRef(t),this._attachedNode._worldMatrix.multiplyToRef(t,o.jp.Matrix[0]),e=o.jp.Matrix[0]}else e=this._attachedNode._worldMatrix;if(i.getScene().useRightHandedSystem?(this._rightHandtoLeftHandMatrix.multiplyToRef(e,o.jp.Matrix[1]),t=o.jp.Matrix[1]):t=e,t.decompose(o.jp.Vector3[1],o.jp.Quaternion[0],o.jp.Vector3[0]),"FreeCamera"===this._attachedNode.getClassName()||"FlyCamera"===this._attachedNode.getClassName()||"ArcFollowCamera"===this._attachedNode.getClassName()||"TargetCamera"===this._attachedNode.getClassName()||"TouchCamera"===this._attachedNode.getClassName()||"UniversalCamera"===this._attachedNode.getClassName()){let e=this._attachedNode;e.rotation=o.jp.Quaternion[0].toEulerAngles(),e.rotationQuaternion&&(e.rotationQuaternion.copyFrom(o.jp.Quaternion[0]),e.rotationQuaternion.normalize())}i.position.copyFrom(o.jp.Vector3[0])}else if(this._attachedNode._isMesh||"AbstractMesh"===this._attachedNode.getClassName()||"TransformNode"===this._attachedNode.getClassName()||"InstancedMesh"===this._attachedNode.getClassName()){let e=this._attachedNode;if(e.parent){let t=o.jp.Matrix[0],i=o.jp.Matrix[1];e.parent.getWorldMatrix().invertToRef(t),this._attachedNode.getWorldMatrix().multiplyToRef(t,i);let r=o.jp.Matrix[4];if(this._handlePivotMatrixInverse(e,i,r),r.decompose(o.jp.Vector3[0],o.jp.Quaternion[0],e.position,f.PreserveScaling?e:void 0,f.UseAbsoluteScaling),o.jp.Quaternion[0].normalize(),e.isUsingPivotMatrix()){let t=o.jp.Quaternion[1];o._f.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,t);let i=o.jp.Matrix[2];o.y3.ScalingToRef(e.scaling.x,e.scaling.y,e.scaling.z,i);let r=o.jp.Matrix[2];t.toRotationMatrix(r);let s=e.getPivotMatrix(),n=o.jp.Matrix[3];s.invertToRef(n),s.multiplyToRef(i,o.jp.Matrix[4]),o.jp.Matrix[4].multiplyToRef(r,o.jp.Matrix[5]),o.jp.Matrix[5].multiplyToRef(n,o.jp.Matrix[6]),o.jp.Matrix[6].getTranslationToRef(o.jp.Vector3[1]),e.position.subtractInPlace(o.jp.Vector3[1])}}else{let t=o.jp.Matrix[4];this._handlePivotMatrixInverse(e,this._attachedNode._worldMatrix,t),t.decompose(o.jp.Vector3[0],o.jp.Quaternion[0],e.position,f.PreserveScaling?e:void 0,f.UseAbsoluteScaling)}o.jp.Vector3[0].scaleInPlace(1/e.scalingDeterminant),e.scaling.copyFrom(o.jp.Vector3[0]),e.billboardMode||(e.rotationQuaternion?(e.rotationQuaternion.copyFrom(o.jp.Quaternion[0]),e.rotationQuaternion.normalize()):e.rotation=o.jp.Quaternion[0].toEulerAngles())}else if("Bone"===this._attachedNode.getClassName()){let e=this._attachedNode,t=e.getParent();if(t){let i=o.jp.Matrix[0],r=o.jp.Matrix[1];t.getFinalMatrix().invertToRef(i),e.getFinalMatrix().multiplyToRef(i,r),e.getLocalMatrix().copyFrom(r)}else e.getLocalMatrix().copyFrom(e.getFinalMatrix());e.markAsDirty()}else{let e=this._attachedNode;if(e.getTypeID){let t=e.getTypeID();if(t===d._.LIGHTTYPEID_DIRECTIONALLIGHT||t===d._.LIGHTTYPEID_SPOTLIGHT||t===d._.LIGHTTYPEID_POINTLIGHT){let t=e.parent;if(t){let i=o.jp.Matrix[0],r=o.jp.Matrix[1];t.getWorldMatrix().invertToRef(i),e.getWorldMatrix().multiplyToRef(i,r),r.decompose(void 0,o.jp.Quaternion[0],o.jp.Vector3[0])}else this._attachedNode._worldMatrix.decompose(void 0,o.jp.Quaternion[0],o.jp.Vector3[0]);e.position=new o.P(o.jp.Vector3[0].x,o.jp.Vector3[0].y,o.jp.Vector3[0].z),e.direction&&(e.direction=new o.P(e.direction.x,e.direction.y,e.direction.z))}}}}}_setGizmoMeshMaterial(e,t){e&&e.forEach(e=>{e.material=t,e.color&&(e.color=t.diffuseColor)})}static GizmoAxisPointerObserver(e,t){let i=!1;return e.utilityLayerScene.onPointerObservable.add(e=>{if(e.pickInfo){if(e.type===h.kD.POINTERMOVE){if(i)return;t.forEach(t=>{if(t.colliderMeshes&&t.gizmoMeshes){let i=t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh)!=-1,r=t.dragBehavior.enabled?i||t.active?t.hoverMaterial:t.material:t.disableMaterial;t.gizmoMeshes.forEach(e=>{e.material=r,e.color&&(e.color=r.diffuseColor)})}})}e.type===h.kD.POINTERDOWN&&t.has(e.pickInfo.pickedMesh?.parent)&&(i=!0,t.get(e.pickInfo.pickedMesh?.parent).active=!0,t.forEach(t=>{let i=(t.colliderMeshes?.indexOf(e?.pickInfo?.pickedMesh)!=-1||t.active)&&t.dragBehavior.enabled?t.hoverMaterial:t.disableMaterial;t.gizmoMeshes.forEach(e=>{e.material=i,e.color&&(e.color=i.diffuseColor)})})),e.type===h.kD.POINTERUP&&t.forEach(e=>{e.active=!1,i=!1,e.gizmoMeshes.forEach(t=>{t.material=e.dragBehavior.enabled?e.material:e.disableMaterial,t.color&&(t.color=e.material.diffuseColor)})})}})}dispose(){this._rootMesh.dispose(),this._beforeRenderObserver&&this.gizmoLayer.utilityLayerScene.onBeforeRenderObservable.remove(this._beforeRenderObserver)}}f.PreserveScaling=!1,f.UseAbsoluteScaling=!0},53179:function(e,t,i){i.d(t,{m:function(){return f}});var r=i(82877),s=i(39884),n=i(57449),a=i(51092),o=i(93954),l=i(5848),c=i(81209),u=i(32253),h=i(56692),d=i(83260);class f{set applyPostProcess(e){this._applyPostProcess=e}get applyPostProcess(){return this.isBackground||this._applyPostProcess}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,l,p,m=!1){this.name=e,this._applyPostProcess=!0,this.scale=new s.FM(1,1),this.offset=new s.FM(0,0),this.alphaBlendingMode=2,this.layerMask=268435455,this.renderTargetTextures=[],this.renderOnlyInRenderTargetTextures=!1,this.isEnabled=!0,this._vertexBuffers={},this.onDisposeObservable=new r.y$,this.onBeforeRenderObservable=new r.y$,this.onAfterRenderObservable=new r.y$,this._shaderLanguage=0,this._shadersLoaded=!1,this.texture=t?new c.x(t,i,!0):null,this.isBackground=void 0===l||l,this.color=void 0===p?new n.HE(1,1,1,1):p,this._scene=i||a.l.LastCreatedScene;let _=this._scene.getEngine();!_.isWebGPU||m||f.ForceGLSL||(this._shaderLanguage=1);let g=this._scene._getComponent(u.l.NAME_LAYER);g||(g=new h.N(this._scene),this._scene._addComponent(g)),this._scene.layers.push(this),this._drawWrapper=new d.q(_);let v=[];v.push(1,1),v.push(-1,1),v.push(-1,-1),v.push(1,-1);let S=new o.o(_,v,o.o.PositionKind,!1,!1,2);this._vertexBuffers[o.o.PositionKind]=S,this._createIndexBuffer()}_createIndexBuffer(){let e=this._scene.getEngine(),t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){let e=this._vertexBuffers[o.o.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}isReady(){let e=this._scene.getEngine(),t="";this.alphaTest&&(t="#define ALPHATEST"),this.texture&&!this.texture.gammaSpace&&(t+="\n#define LINEAR"),this._previousDefines!==t&&(this._previousDefines=t,this._drawWrapper.effect=e.createEffect("layer",[o.o.PositionKind],["textureMatrix","color","scale","offset"],["textureSampler"],t,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,75439)),Promise.resolve().then(i.bind(i,48407))]):await Promise.all([Promise.resolve().then(i.bind(i,14337)),Promise.resolve().then(i.bind(i,94566))]),this._shadersLoaded=!0}));let r=this._drawWrapper.effect;return r?.isReady()&&(!this.texture||this.texture.isReady())}render(){if(!this.isEnabled)return;let e=this._scene.getEngine();if(!this.isReady())return;let t=this._drawWrapper.effect;this.onBeforeRenderObservable.notifyObservers(this),e.enableEffect(this._drawWrapper),e.setState(!1),this.texture&&(t.setTexture("textureSampler",this.texture),t.setMatrix("textureMatrix",this.texture.getTextureMatrix())),t.setFloat4("color",this.color.r,this.color.g,this.color.b,this.color.a),t.setVector2("offset",this.offset),t.setVector2("scale",this.scale),e.bindBuffers(this._vertexBuffers,this._indexBuffer,t),this.alphaTest?e.drawElementsType(l.F.TriangleFillMode,0,6):(e.setAlphaMode(this.alphaBlendingMode),e.drawElementsType(l.F.TriangleFillMode,0,6),e.setAlphaMode(0)),this.onAfterRenderObservable.notifyObservers(this)}dispose(){let e=this._vertexBuffers[o.o.PositionKind];e&&(e.dispose(),this._vertexBuffers[o.o.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this.texture&&(this.texture.dispose(),this.texture=null),this.renderTargetTextures=[];let t=this._scene.layers.indexOf(this);this._scene.layers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderObservable.clear()}}f.ForceGLSL=!1},56692:function(e,t,i){i.d(t,{N:function(){return n}});var r=i(32253),s=i(51092);class n{constructor(e){if(this.name=r.l.NAME_LAYER,this.scene=e||s.l.LastCreatedScene,!this.scene)return;this._engine=this.scene.getEngine()}register(){this.scene._beforeCameraDrawStage.registerStep(r.l.STEP_BEFORECAMERADRAW_LAYER,this,this._drawCameraBackground),this.scene._afterCameraDrawStage.registerStep(r.l.STEP_AFTERCAMERADRAW_LAYER,this,this._drawCameraForegroundWithPostProcessing),this.scene._afterCameraPostProcessStage.registerStep(r.l.STEP_AFTERCAMERAPOSTPROCESS_LAYER,this,this._drawCameraForegroundWithoutPostProcessing),this.scene._beforeRenderTargetDrawStage.registerStep(r.l.STEP_BEFORERENDERTARGETDRAW_LAYER,this,this._drawRenderTargetBackground),this.scene._afterRenderTargetDrawStage.registerStep(r.l.STEP_AFTERRENDERTARGETDRAW_LAYER,this,this._drawRenderTargetForegroundWithPostProcessing),this.scene._afterRenderTargetPostProcessStage.registerStep(r.l.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER,this,this._drawRenderTargetForegroundWithoutPostProcessing)}rebuild(){for(let e of this.scene.layers)e._rebuild()}dispose(){let e=this.scene.layers;for(;e.length;)e[0].dispose()}_draw(e){let t=this.scene.layers;if(t.length){for(let i of(this._engine.setDepthBuffer(!1),t))e(i)&&i.render();this._engine.setDepthBuffer(!0)}}_drawCameraPredicate(e,t,i,r){return!e.renderOnlyInRenderTargetTextures&&e.isBackground===t&&e.applyPostProcess===i&&(e.layerMask&r)!=0}_drawCameraBackground(e){this._draw(t=>this._drawCameraPredicate(t,!0,!0,e.layerMask))}_drawCameraForegroundWithPostProcessing(e){this._draw(t=>this._drawCameraPredicate(t,!1,!0,e.layerMask))}_drawCameraForegroundWithoutPostProcessing(e){this._draw(t=>this._drawCameraPredicate(t,!1,!1,e.layerMask))}_drawRenderTargetPredicate(e,t,i,r,s){return e.renderTargetTextures.length>0&&e.isBackground===t&&e.applyPostProcess===i&&e.renderTargetTextures.indexOf(s)>-1&&(e.layerMask&r)!=0}_drawRenderTargetBackground(e){this._draw(t=>this._drawRenderTargetPredicate(t,!0,!0,this.scene.activeCamera.layerMask,e))}_drawRenderTargetForegroundWithPostProcessing(e){this._draw(t=>this._drawRenderTargetPredicate(t,!1,!0,this.scene.activeCamera.layerMask,e))}_drawRenderTargetForegroundWithoutPostProcessing(e){this._draw(t=>this._drawRenderTargetPredicate(t,!1,!1,this.scene.activeCamera.layerMask,e))}addFromContainer(e){e.layers&&e.layers.forEach(e=>{this.scene.layers.push(e)})}removeFromContainer(e,t=!1){e.layers&&e.layers.forEach(e=>{let i=this.scene.layers.indexOf(e);-1!==i&&this.scene.layers.splice(i,1),t&&e.dispose()})}}},89259:function(e,t,i){i.d(t,{n0:function(){return R}});var r,s,n=i(4224),a=i(82877),o=i(44755),l=i(51092),c=i(9719),u=i(27243),h=i(14684),d=i(77669),f=i(25675),p=i(3176);(r=s||(s={}))[r.Clean=0]="Clean",r[r.Stop=1]="Stop",r[r.Sync=2]="Sync",r[r.NoSync=3]="NoSync";let m=new a.y$,_={},g=!1;function v(){return _[".babylon"]}function S(e){return _[e]||(c.Y.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),v())}function x(e,t,i){let r="Unable to load from "+(e.rawData?"binary data":e.url);return t?r+=`: ${t}`:i&&(r+=`: ${i}`),r}function E(e,t,i,r,s,n,a,o,l){var c;let u="data:"===(c=e.url).substring(0,5)?c.substring(5):null;if(e.rawData&&!a)throw"When using ArrayBufferView to load data the file extension must be provided.";let d=a?S(a):u?function(e){for(let t in _){let i=_[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return _[t]}return v()}(e.url):function(e){let t=e.indexOf("?");-1!==t&&(e=e.substring(0,t));let i=e.lastIndexOf(".");return S(e.substring(i,e.length).toLowerCase())}(e.url);if(!d)throw Error(`No plugin or fallback for ${a??e.url}`);if(l?.[d.plugin.name]?.enabled===!1)throw Error(`The '${d.plugin.name}' plugin is disabled via the loader options passed to the loading operation.`);if(e.rawData&&!d.isBinary)throw"Loading from ArrayBufferView can not be used with plugins that don't support binary loading.";return(e=>{if(!d.plugin.createPlugin)return e(d.plugin),d.plugin;{let t=d.plugin.createPlugin(l??{});return t instanceof Promise?(t.then(e).catch(e=>{s("Error instantiating plugin.",e)}),null):(e(t),t)}})(l=>{if(!l)throw`The loader plugin corresponding to the '${a}' file type has not been found. If using es6, please import the plugin you wish to use before.`;if(m.notifyObservers(l),u&&(l.canDirectLoad&&l.canDirectLoad(e.url)||!(0,h.VL)(e.url))){if(l.directLoad){let e=l.directLoad(t,u);e instanceof Promise?e.then(e=>{i(l,e)}).catch(e=>{s("Error in directLoad of _loadData: "+e,e)}):i(l,e)}else i(l,u);return}let c=d.isBinary,f=(e,r)=>{if(t.isDisposed){s("Scene has been disposed");return}i(l,e,r)},_=null,g=!1;l.onDisposeObservable?.add(()=>{g=!0,_&&(_.abort(),_=null),n()});let v=()=>{if(g)return;let i=(e,t)=>{s(e?.statusText,t)};if(!l.loadFile&&e.rawData)throw"Plugin does not support loading ArrayBufferView.";_=l.loadFile?l.loadFile(t,e.rawData||e.file||e.url,e.rootUrl,f,r,c,i,o):t._loadFile(e.file||e.url,f,r,!0,c,i)},S=t.getEngine(),x=S.enableOfflineSupport;if(x){let i=!1;for(let r of t.disableOfflineSupportExceptionRules)if(r.test(e.url)){i=!0;break}x=!i}x&&p.a.OfflineProviderFactory?t.offlineProvider=p.a.OfflineProviderFactory(e.url,v,S.disableManifestCheck):v()})}function C(e,t){let i,r;let s=null,a=null;if(t){if(t.name)i=`file:${t.name}`,r=t.name,s=t;else if(ArrayBuffer.isView(t))i="",r=(0,f.f)(),a=t;else if(t.startsWith("data:"))i=t,r="";else if(e){if("/"===t.substring(0,1))return n.w1.Error("Wrong sceneFilename parameter"),null;i=e+t,r=t}else i=t,r=n.w1.GetFilename(t),e=n.w1.GetFolderPath(t)}else i=e,r=n.w1.GetFilename(e),e=n.w1.GetFolderPath(e);return{url:i,rootUrl:e,name:r,file:s,rawData:a}}function T(e,t,i="",r=l.l.LastCreatedScene,s=null,n=null,a=null,o=null,u="",h={}){if(!r)return c.Y.Error("No scene available to import mesh to"),null;let f=C(t,i);if(!f)return null;let p={};r.addPendingData(p);let m=()=>{r.removePendingData(p)},_=(e,t)=>{let i=x(f,e,t);a?a(r,i,new d.LH(i,d.SM.SceneLoaderError,t)):c.Y.Error(i),m()},g=n?e=>{try{n(e)}catch(e){_("Error in onProgress callback: "+e,e)}}:void 0,v=(e,t,i,n,a,o,l,c)=>{if(r.importedMeshesFiles.push(f.url),s)try{s(e,t,i,n,a,o,l,c)}catch(e){_("Error in onSuccess callback: "+e,e)}r.removePendingData(p)};return E(f,r,(t,i,s)=>{if(t.rewriteRootURL&&(f.rootUrl=t.rewriteRootURL(f.rootUrl,s)),t.importMesh){let s=[],n=[],a=[];t.importMesh(e,r,i,f.rootUrl,s,n,a,_)&&(r.loadingPluginName=t.name,v(s,n,a,[],[],[],[],[]))}else t.importMeshAsync(e,r,i,f.rootUrl,g,f.name).then(e=>{r.loadingPluginName=t.name,v(e.meshes,e.particleSystems,e.skeletons,e.animationGroups,e.transformNodes,e.geometries,e.lights,e.spriteManagers)}).catch(e=>{_(e.message,e)})},g,_,m,o,u,h)}function b(e,t="",i=l.l.LastCreatedEngine,r=null,s=null,a=null,c=null,u="",h={}){return i?y(e,t,new o.x(i),r,s,a,c,u,h):(n.w1.Error("No engine available"),null)}function y(e,t="",i=l.l.LastCreatedScene,r=null,s=null,n=null,a=null,o="",h={}){if(!i)return c.Y.Error("No scene available to append to"),null;let f=C(e,t);if(!f)return null;let p={};i.addPendingData(p);let m=()=>{i.removePendingData(p)};u.Z.ShowLoadingScreen&&!g&&(g=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),g=!1}));let _=(e,t)=>{let r=x(f,e,t);n?n(i,r,new d.LH(r,d.SM.SceneLoaderError,t)):c.Y.Error(r),m()},v=s?e=>{try{s(e)}catch(e){_("Error in onProgress callback",e)}}:void 0,S=()=>{if(r)try{r(i)}catch(e){_("Error in onSuccess callback",e)}i.removePendingData(p)};return E(f,i,(e,t)=>{e.load?!e.load(i,t,f.rootUrl,_)||(i.loadingPluginName=e.name,S()):e.loadAsync(i,t,f.rootUrl,v,f.name).then(()=>{i.loadingPluginName=e.name,S()}).catch(e=>{_(e.message,e)})},v,_,m,a,o,h)}function I(e,t="",i=l.l.LastCreatedScene,r=null,s=null,n=null,a=null,o="",u={}){if(!i)return c.Y.Error("No scene available to load asset container to"),null;let h=C(e,t);if(!h)return null;let f={};i.addPendingData(f);let p=()=>{i.removePendingData(f)},m=(e,t)=>{let r=x(h,e,t);n?n(i,r,new d.LH(r,d.SM.SceneLoaderError,t)):c.Y.Error(r),p()},_=s?e=>{try{s(e)}catch(e){m("Error in onProgress callback",e)}}:void 0,g=e=>{if(r)try{r(e)}catch(e){m("Error in onSuccess callback",e)}i.removePendingData(f)};return E(h,i,(e,t)=>{if(e.loadAssetContainer){let r=e.loadAssetContainer(i,t,h.rootUrl,m);r&&(r.populateRootNodes(),i.loadingPluginName=e.name,g(r))}else e.loadAssetContainerAsync?e.loadAssetContainerAsync(i,t,h.rootUrl,_,h.name).then(t=>{t.populateRootNodes(),i.loadingPluginName=e.name,g(t)}).catch(e=>{m(e.message,e)}):m("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},_,m,p,a,o,u)}function P(e,t="",i=l.l.LastCreatedScene,r=!0,s=0,n=null,a=null,o=null,u=null,h=null,d="",f={}){if(!i){c.Y.Error("No scene available to load animations to");return}if(r){for(let e of i.animatables)e.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(e=>{e.dispose()}),i.getNodes().forEach(e=>{e.animations&&(e.animations=[])})}else switch(s){case 0:i.animationGroups.slice().forEach(e=>{e.dispose()});break;case 1:i.animationGroups.forEach(e=>{e.stop()});break;case 2:i.animationGroups.forEach(e=>{e.reset(),e.restart()});break;case 3:break;default:c.Y.Error("Unknown animation group loading mode value '"+s+"'");return}let p=i.animatables.length;I(e,t,i,e=>{e.mergeAnimationsTo(i,i.animatables.slice(p),n),e.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),a&&a(i)},o,u,h,d,f)}class R{static get ForceFullSceneLoadingForIncremental(){return u.Z.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){u.Z.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return u.Z.ShowLoadingScreen}static set ShowLoadingScreen(e){u.Z.ShowLoadingScreen=e}static get loggingLevel(){return u.Z.loggingLevel}static set loggingLevel(e){u.Z.loggingLevel=e}static get CleanBoneMatrixWeights(){return u.Z.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){u.Z.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return v()}static GetPluginForExtension(e){return S(e)?.plugin}static IsPluginForExtensionAvailable(e){return!!_[e]}static RegisterPlugin(e){!function(e){if("string"==typeof e.extensions)_[e.extensions.toLowerCase()]={plugin:e,isBinary:!1};else{let t=e.extensions;Object.keys(t).forEach(i=>{_[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}(e)}static ImportMesh(e,t,i,r,s,n,a,o,l){return T(e,t,i,r,s,n,a,o,l)}static ImportMeshAsync(e,t,i,r,s,n,a){return new Promise((o,l)=>{T(e,t,i,r,(e,t,i,r,s,n,a,l)=>{o({meshes:e,particleSystems:t,skeletons:i,animationGroups:r,transformNodes:s,geometries:n,lights:a,spriteManagers:l})},s,(e,t,i)=>{l(i||Error(t))},n,a,void 0)})}static Load(e,t,i,r,s,n,a,o){return b(e,t,i,r,s,n,a,o)}static LoadAsync(e,t,i,r,s,n){return new Promise((a,o)=>{b(e,t,i,e=>{a(e)},r,(e,t,i)=>{o(i||Error(t))},s,n,void 0)})}static Append(e,t,i,r,s,n,a,o){return y(e,t,i,r,s,n,a,o)}static AppendAsync(e,t,i,r,s,n){return new Promise((a,o)=>{y(e,t,i,e=>{a(e)},r,(e,t,i)=>{o(i||Error(t))},s,n,void 0)})}static LoadAssetContainer(e,t,i,r,s,n,a,o){return I(e,t,i,r,s,n,a,o)}static LoadAssetContainerAsync(e,t,i,r,s,n){return new Promise((a,o)=>{I(e,t,i,e=>{a(e)},r,(e,t,i)=>{o(i||Error(t))},s,n,void 0)})}static ImportAnimations(e,t,i,r,s,n,a,o,l,c,u){P(e,t,i,r,s,n,a,o,l,c,u)}static ImportAnimationsAsync(e,t,i,r,s,n,a,o,l,c,u){return new Promise((a,l)=>{P(e,t,i,r,s,n,e=>{a(e)},o,(e,t,i)=>{l(i||Error(t))},c,u,void 0)})}}R.NO_LOGGING=0,R.MINIMAL_LOGGING=1,R.SUMMARY_LOGGING=2,R.DETAILED_LOGGING=3,R.OnPluginActivatedObservable=m},66114:function(e,t,i){i.d(t,{u:function(){return d}});var r=i(46456),s=i(22287),n=i(93954),a=i(39884),o=i(50953),l=i(65940),c=i(16188),u=i(3609);class h extends c.H{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.ANISOTROPIC_LEGACY=!1,this.MAINUV1=!1}}class d extends l.n{set angle(e){this.direction.x=Math.cos(e),this.direction.y=Math.sin(e)}get angle(){return Math.atan2(this.direction.y,this.direction.x)}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markAllSubMeshesAsMiscDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRAnisotropic",110,new h,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new a.FM(1,0),this._texture=null,this.texture=null,this._legacy=!1,this.legacy=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16]}isReadyForSubMesh(e,t){return!this._isEnabled||!e._areTexturesDirty||!t.texturesEnabled||!this._texture||!o.k.AnisotropicTextureEnabled||!!this._texture.isReadyOrNotBlocking()}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(n.o.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&o.k.AnisotropicTextureEnabled?(0,u.lw)(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1),e._areMiscDirty&&(e.ANISOTROPIC_LEGACY=this._legacy)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.ANISOTROPIC_LEGACY=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;e.useUbo&&i&&e.isSync||(this._texture&&o.k.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),(0,u.NL)(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&o.k.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}parse(e,t,i){super.parse(e,t,i),void 0===e.legacy&&(this.legacy=!0)}}(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isEnabled",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"intensity",void 0),(0,r.gn)([(0,s.QC)()],d.prototype,"direction",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"texture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsMiscDirty")],d.prototype,"legacy",void 0)},30362:function(e,t,i){i.d(t,{d:function(){return l}});var r=i(46456),s=i(22287),n=i(16188),a=i(65940);class o extends n.H{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class l extends a.n{_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRBRDF",90,new o,t),this._useEnergyConservation=l.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=l.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=l.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=l.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=l.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=l.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=l.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=l.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}l.DEFAULT_USE_ENERGY_CONSERVATION=!0,l.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0,l.DEFAULT_USE_SPHERICAL_HARMONICS=!0,l.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0,(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useEnergyConservation",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useSmithVisibilityHeightCorrelated",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useSphericalHarmonics",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsMiscDirty")],l.prototype,"useSpecularGlossinessInputEnergyConservation",void 0)},40193:function(e,t,i){i.d(t,{m:function(){return O}});var r=i(46456),s=i(22287),n=i(9719),a=i(93287),o=i(45260),l=i(44755),c=i(39884),u=i(93954),h=i(30362),d=i(58487),f=i(57449),p=i(91176),m=i(5848),_=i(16188),g=i(31786),v=i(81209),S=i(50953);i(78344);var x=i(34634),E=i(29526),C=i(66110),T=i(66114),b=i(70325),y=i(88118),I=i(33776),P=i(49449),R=i(3609),A=i(76608);let M={effect:null,subMesh:null};class N extends _.H{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAX_RHS=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_NORMAL_WORLDSPACE=!1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_VELOCITY_LINEAR=!1,this.PREPASS_VELOCITY_LINEAR_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DECAL_AFTER_DETAIL=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class O extends g.a{get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}constructor(e,t,i=!1){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new c.Lt(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=O.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=f.Wo.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new f.Wo(0,0,0),this._albedoColor=new f.Wo(1,1,1),this._reflectivityColor=new f.Wo(1,1,1),this._reflectionColor=new f.Wo(1,1,1),this._emissiveColor=new f.Wo(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=O.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new a.t(16),this._globalAmbientColor=new f.Wo(0,0,0),this._unlit=!1,this._applyDecalMapAfterDetailMap=!1,this._debugMode=0,this._shadersLoaded=!1,this._breakShaderLoadedCheck=!1,this.debugMode=0,this.debugLimit=-1,this.debugFactor=1,this._cacheHasRenderTargetTextures=!1;let r=this.getScene().getEngine();!r.isWebGPU||i||O.ForceGLSL||(this._uniformBuffer&&this._uniformBuffer.dispose(),this._uniformBuffer=new A.M(r,void 0,void 0,this.name,!0),this._shaderLanguage=1),this.brdf=new h.d(this),this.clearCoat=new E.Y(this),this.iridescence=new C.B(this),this.anisotropy=new T.u(this),this.sheen=new b.B(this),this.subSurface=new y.u(this),this.detailMap=new I.p(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),S.k.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=(0,o.$)(this.getScene()),this.prePassConfiguration=new d.o}get hasRenderTargetTextures(){return!!S.k.ReflectionTextureEnabled&&!!this._reflectionTexture&&!!this._reflectionTexture.isRenderTarget||this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get _disableAlphaBlending(){return this._transparencyMode===O.PBRMATERIAL_OPAQUE||this._transparencyMode===O.PBRMATERIAL_ALPHATEST||this.subSurface?.disableAlphaBlending}needAlphaBlending(){return!this._disableAlphaBlending&&(this.alpha<1||null!=this._opacityTexture||this._shouldUseAlphaFromAlbedoTexture())}needAlphaTesting(){return!!this._forceAlphaTest||!this.subSurface?.disableAlphaBlending&&this._hasAlphaChannel()&&(null==this._transparencyMode||this._transparencyMode===O.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==O.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return null!=this._albedoTexture&&this._albedoTexture.hasAlpha||null!=this._opacityTexture}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){this._uniformBufferLayoutBuilt||this.buildUniformLayout();let r=t._drawWrapper;if(r.effect&&this.isFrozen&&r._wasPreviouslyReady&&r._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(4,this._eventInfo),t.materialDefines=new N(this._eventInfo.defineNames));let s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=this.getScene(),o=a.getEngine();if(s._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,a.texturesEnabled)){if(this._albedoTexture&&S.k.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&S.k.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&S.k.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;let e=this._getReflectionTexture();if(e&&S.k.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;if(e.irradianceTexture){if(!e.irradianceTexture.isReadyOrNotBlocking())return!1}else if(!e.sphericalPolynomial&&e.getInternalTexture()?._sphericalPolynomialPromise)return!1}if(this._lightmapTexture&&S.k.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&S.k.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(S.k.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(o.getCaps().standardDerivatives&&this._bumpTexture&&S.k.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&S.k.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._eventInfo.subMesh=t,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||s._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;o.getCaps().standardDerivatives||e.isVerticesDataPresent(u.o.NormalKind)||(e.createNormals(!0),n.Y.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));let l=t.effect,c=s._areLightsDisposed,h=this._prepareEffect(e,s,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances),d=!1;if(h){if(this._onEffectCreatedObservable&&(M.effect=h,M.subMesh=t,this._onEffectCreatedObservable.notifyObservers(M)),this.allowShaderHotSwapping&&l&&!h.isReady()){if(h=l,s.markAsUnprocessed(),d=this.isFrozen,c)return s._areLightsDisposed=!0,!1}else a.resetCachedMaterial(),t.setEffect(h,s,this._materialContext)}return!!(t.effect&&t.effect.isReady())&&(s._renderId=a.getRenderId(),r._wasPreviouslyReady=!d,r._wasPreviouslyUsingInstances=!!i,this._checkScenePerformancePriority(),!0)}isMetallicWorkflow(){return null!=this._metallic||null!=this._roughness||!!this._metallicTexture}_prepareEffect(e,t,r=null,s=null,n=null,a=null,o){if(this._prepareDefines(e,t,n,a,o),!t.isDirty)return null;t.markAsProcessed();let l=this.getScene().getEngine(),c=new x.L,h=0;t.USESPHERICALINVERTEX&&c.addFallback(h++,"USESPHERICALINVERTEX"),t.FOG&&c.addFallback(h,"FOG"),t.SPECULARAA&&c.addFallback(h,"SPECULARAA"),t.POINTSIZE&&c.addFallback(h,"POINTSIZE"),t.LOGARITHMICDEPTH&&c.addFallback(h,"LOGARITHMICDEPTH"),t.PARALLAX&&c.addFallback(h,"PARALLAX"),t.PARALLAX_RHS&&c.addFallback(h,"PARALLAX_RHS"),t.PARALLAXOCCLUSION&&c.addFallback(h++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&c.addFallback(h++,"ENVIRONMENTBRDF"),t.TANGENT&&c.addFallback(h++,"TANGENT"),t.BUMP&&c.addFallback(h++,"BUMP"),h=(0,R.Lh)(t,c,this._maxSimultaneousLights,h++),t.SPECULARTERM&&c.addFallback(h++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&c.addFallback(h++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&c.addFallback(h++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&c.addFallback(h++,"LIGHTMAP"),t.NORMAL&&c.addFallback(h++,"NORMAL"),t.AMBIENT&&c.addFallback(h++,"AMBIENT"),t.EMISSIVE&&c.addFallback(h++,"EMISSIVE"),t.VERTEXCOLOR&&c.addFallback(h++,"VERTEXCOLOR"),t.MORPHTARGETS&&c.addFallback(h++,"MORPHTARGETS"),t.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");let f=[u.o.PositionKind];t.NORMAL&&f.push(u.o.NormalKind),t.TANGENT&&f.push(u.o.TangentKind);for(let e=1;e<=6;++e)t["UV"+e]&&f.push(`uv${1===e?"":e}`);t.VERTEXCOLOR&&f.push(u.o.ColorKind),(0,R.TD)(f,e,t,c),(0,R.od)(f,t),(0,R.n5)(f,e,t),(0,R.pd)(f,e,t);let m="pbr",_=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],g=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],v=["Material","Scene","Mesh"],S={maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS};this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=h,this._eventInfo.defines=t,this._eventInfo.uniforms=_,this._eventInfo.attributes=f,this._eventInfo.samplers=g,this._eventInfo.uniformBuffersNames=v,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._eventInfo.indexParameters=S,this._callbackPluginEventGeneric(128,this._eventInfo),d.o.AddUniforms(_),d.o.AddSamplers(g),(0,P.qx)(_),p.$&&(p.$.PrepareUniforms(_,t),p.$.PrepareSamplers(g,t)),(0,R.DI)({uniformsNames:_,uniformBuffersNames:v,samplers:g,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});let E={};this.customShaderNameResolve&&(m=this.customShaderNameResolve(m,_,v,g,t,f,E));let C=t.toString(),T=l.createEffect(m,{attributes:f,uniformsNames:_,uniformBuffersNames:v,samplers:g,defines:C,fallbacks:c,onCompiled:r,onError:s,indexParameters:S,processFinalCode:E.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,8133)),Promise.resolve().then(i.bind(i,77082))]):await Promise.all([Promise.resolve().then(i.bind(i,98296)),Promise.resolve().then(i.bind(i,80024))]),this._shadersLoaded=!0}},l);return this._eventInfo.customCode=void 0,T}_prepareDefines(e,t,i=null,r=null,s=!1){let n=this.getScene(),a=n.getEngine();(0,R.UX)(n,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,(0,R.Z7)(n,t);let o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if((0,R.Kg)(n,t,this.canRenderToMRT&&!o),(0,R.t6)(n,t,o),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){t._needUVs=!1;for(let e=1;e<=6;++e)t["MAINUV"+e]=!1;if(n.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,a.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&S.k.DiffuseTextureEnabled?((0,R.lw)(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&S.k.AmbientTextureEnabled?((0,R.lw)(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&S.k.OpacityTextureEnabled?((0,R.lw)(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;let e=this._getReflectionTexture();if(e&&S.k.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=e.gammaSpace,t.RGBDREFLECTION=e.isRGBD,t.LODINREFLECTIONALPHA=e.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=e.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,a._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,t.INVERTCUBICMAP=e.coordinatesMode===v.x.INVCUBIC_MODE,t.REFLECTIONMAP_3D=e.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,e.coordinatesMode){case v.x.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case v.x.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case v.x.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case v.x.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case v.x.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case v.x.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case v.x.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case v.x.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case v.x.CUBIC_MODE:case v.x.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!e.boundingBoxSize}e.coordinatesMode!==v.x.SKYBOX_MODE&&(e.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):e.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||this._twoSidedLighting||a.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;this._lightmapTexture&&S.k.LightmapTextureEnabled?((0,R.lw)(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&S.k.EmissiveTextureEnabled?((0,R.lw)(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,S.k.SpecularTextureEnabled?(this._metallicTexture?((0,R.lw)(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?((0,R.lw)(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture?(t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture,this._metallicReflectanceTexture?((0,R.lw)(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?((0,R.lw)(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1):(t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1),this._microSurfaceTexture?(0,R.lw)(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1):(t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1),a.getCaps().standardDerivatives&&this._bumpTexture&&S.k.BumpTextureEnabled&&!this._disableBumpMap?((0,R.lw)(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&S.k.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAX_RHS=n.useRightHandedSystem,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAX_RHS=!1,t.PARALLAXOCCLUSION=!1,t.OBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&S.k.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===O.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===O.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=a.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1==0?".":""}`,t.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&((0,R.BV)(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t,this._applyDecalMapAfterDetailMap),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(u.o.NormalKind),t.DEBUGMODE=this._debugMode),(0,R.vG)(n,a,this,t,!!i,r,s),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),(0,R.wJ)(e,t,!0,!0,!0,this._transparencyMode!==O.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){let r={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(4,this._eventInfo),(()=>{if(this._breakShaderLoadedCheck)return;let i=new N(this._eventInfo.defineNames),s=this._prepareEffect(e,i,void 0,void 0,r.useInstances,r.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(M.effect=s,M.subMesh=null,this._onEffectCreatedObservable.notifyObservers(M)),s.isReady()?t&&t(this):s.onCompileObservable.add(()=>{t&&t(this)})})()}buildUniformLayout(){let e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.materialDefines;if(!s)return;let n=i.effect;if(!n)return;this._activeEffect=n,t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e);let a=r.getEngine();this._uniformBuffer.bindToEffect(n,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),s.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));let o=this._mustRebind(r,n,i,t.visibility);(0,R.qx)(t,this._activeEffect,this.prePassConfiguration);let c=null,u=this._uniformBuffer;if(o){if(this.bindViewProjection(n),c=this._getReflectionTexture(),!u.useUbo||!this.isFrozen||!u.isSync||i._drawWrapper._forceRebindOnNextCall){if(r.texturesEnabled){if(this._albedoTexture&&S.k.DiffuseTextureEnabled&&(u.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),(0,R.NL)(this._albedoTexture,u,"albedo")),this._ambientTexture&&S.k.AmbientTextureEnabled&&(u.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),(0,R.NL)(this._ambientTexture,u,"ambient")),this._opacityTexture&&S.k.OpacityTextureEnabled&&(u.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),(0,R.NL)(this._opacityTexture,u,"opacity")),c&&S.k.ReflectionTextureEnabled){if(u.updateMatrix("reflectionMatrix",c.getReflectionTextureMatrix()),u.updateFloat2("vReflectionInfos",c.level,0),c.boundingBoxSize){let e=c;u.updateVector3("vReflectionPosition",e.boundingBoxPosition),u.updateVector3("vReflectionSize",e.boundingBoxSize)}if(this.realTimeFiltering){let e=c.getSize().width;u.updateFloat2("vReflectionFilteringInfo",e,Math.log2(e))}if(!s.USEIRRADIANCEMAP){let e=c.sphericalPolynomial;if(s.USESPHERICALFROMREFLECTIONMAP&&e){if(s.SPHERICAL_HARMONICS){let t=e.preScaledHarmonics;u.updateVector3("vSphericalL00",t.l00),u.updateVector3("vSphericalL1_1",t.l1_1),u.updateVector3("vSphericalL10",t.l10),u.updateVector3("vSphericalL11",t.l11),u.updateVector3("vSphericalL2_2",t.l2_2),u.updateVector3("vSphericalL2_1",t.l2_1),u.updateVector3("vSphericalL20",t.l20),u.updateVector3("vSphericalL21",t.l21),u.updateVector3("vSphericalL22",t.l22)}else u.updateFloat3("vSphericalX",e.x.x,e.x.y,e.x.z),u.updateFloat3("vSphericalY",e.y.x,e.y.y,e.y.z),u.updateFloat3("vSphericalZ",e.z.x,e.z.y,e.z.z),u.updateFloat3("vSphericalXX_ZZ",e.xx.x-e.zz.x,e.xx.y-e.zz.y,e.xx.z-e.zz.z),u.updateFloat3("vSphericalYY_ZZ",e.yy.x-e.zz.x,e.yy.y-e.zz.y,e.yy.z-e.zz.z),u.updateFloat3("vSphericalZZ",e.zz.x,e.zz.y,e.zz.z),u.updateFloat3("vSphericalXY",e.xy.x,e.xy.y,e.xy.z),u.updateFloat3("vSphericalYZ",e.yz.x,e.yz.y,e.yz.z),u.updateFloat3("vSphericalZX",e.zx.x,e.zx.y,e.zx.z)}}u.updateFloat3("vReflectionMicrosurfaceInfos",c.getSize().width,c.lodGenerationScale,c.lodGenerationOffset)}this._emissiveTexture&&S.k.EmissiveTextureEnabled&&(u.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),(0,R.NL)(this._emissiveTexture,u,"emissive")),this._lightmapTexture&&S.k.LightmapTextureEnabled&&(u.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),(0,R.NL)(this._lightmapTexture,u,"lightmap")),S.k.SpecularTextureEnabled&&(this._metallicTexture?(u.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),(0,R.NL)(this._metallicTexture,u,"reflectivity")):this._reflectivityTexture&&(u.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),(0,R.NL)(this._reflectivityTexture,u,"reflectivity")),this._metallicReflectanceTexture&&(u.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),(0,R.NL)(this._metallicReflectanceTexture,u,"metallicReflectance")),this._reflectanceTexture&&s.REFLECTANCE&&(u.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),(0,R.NL)(this._reflectanceTexture,u,"reflectance")),this._microSurfaceTexture&&(u.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),(0,R.NL)(this._microSurfaceTexture,u,"microSurfaceSampler"))),this._bumpTexture&&a.getCaps().standardDerivatives&&S.k.BumpTextureEnabled&&!this._disableBumpMap&&(u.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),(0,R.NL)(this._bumpTexture,u,"bump"),r._mirroredCameraPosition?u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):u.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&u.updateFloat("pointSize",this.pointSize),s.METALLICWORKFLOW){f.zZ.Color3[0].r=void 0===this._metallic||null===this._metallic?1:this._metallic,f.zZ.Color3[0].g=void 0===this._roughness||null===this._roughness?1:this._roughness,u.updateColor4("vReflectivityColor",f.zZ.Color3[0],1);let e=this.subSurface?._indexOfRefraction??1.5;this._metallicReflectanceColor.scaleToRef(Math.pow((e-1)/(e+1),2)*this._metallicF0Factor,f.zZ.Color3[0]);let t=this._metallicF0Factor;u.updateColor4("vMetallicReflectanceFactors",f.zZ.Color3[0],t)}else u.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);u.updateColor3("vEmissiveColor",S.k.EmissiveTextureEnabled?this._emissiveColor:f.Wo.BlackReadOnly),u.updateColor3("vReflectionColor",this._reflectionColor),!s.SS_REFRACTION&&this.subSurface?._linkRefractionWithTransparency?u.updateColor4("vAlbedoColor",this._albedoColor,1):u.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*r.environmentIntensity,this._lightingInfos.w=this._specularIntensity,u.updateVector4("vLightingIntensity",this._lightingInfos),r.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),u.updateColor3("vAmbientColor",this._globalAmbientColor),u.updateFloat2("vDebugMode",this.debugLimit,this.debugFactor)}r.texturesEnabled&&(this._albedoTexture&&S.k.DiffuseTextureEnabled&&u.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&S.k.AmbientTextureEnabled&&u.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&S.k.OpacityTextureEnabled&&u.setTexture("opacitySampler",this._opacityTexture),c&&S.k.ReflectionTextureEnabled&&(s.LODBASEDMICROSFURACE?u.setTexture("reflectionSampler",c):(u.setTexture("reflectionSampler",c._lodTextureMid||c),u.setTexture("reflectionSamplerLow",c._lodTextureLow||c),u.setTexture("reflectionSamplerHigh",c._lodTextureHigh||c)),s.USEIRRADIANCEMAP&&u.setTexture("irradianceSampler",c.irradianceTexture)),s.ENVIRONMENTBRDF&&u.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&S.k.EmissiveTextureEnabled&&u.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&S.k.LightmapTextureEnabled&&u.setTexture("lightmapSampler",this._lightmapTexture),S.k.SpecularTextureEnabled&&(this._metallicTexture?u.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&u.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&u.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&s.REFLECTANCE&&u.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&u.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&a.getCaps().standardDerivatives&&S.k.BumpTextureEnabled&&!this._disableBumpMap&&u.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(n),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),(0,P.an)(this._activeEffect,this,r),this.bindEyePosition(n)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&(0,R.VX)(r,t,this._activeEffect,s,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==l.x.FOGMODE_NONE||c||this.subSurface.refractionTexture||t.receiveShadows||s.PREPASS)&&this.bindView(n),(0,R.D1)(r,t,this._activeEffect,!0),s.NUM_MORPH_INFLUENCERS&&(0,R.KG)(t,this._activeEffect),s.BAKED_VERTEX_ANIMATION_TEXTURE&&t.bakedVertexAnimationManager?.bind(n,s.INSTANCES),this._imageProcessingConfiguration.bind(this._activeEffect),(0,R.gz)(s,this._activeEffect,r)),this._afterBind(t,this._activeEffect,i),u.update()}getAnimatables(){let e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._metallicReflectanceTexture&&this._metallicReflectanceTexture.animations&&this._metallicReflectanceTexture.animations.length>0&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&this._reflectanceTexture.animations&&this._reflectanceTexture.animations.length>0&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&this._microSurfaceTexture.animations&&this._microSurfaceTexture.animations.length>0&&e.push(this._microSurfaceTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){let e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e}setPrePassRenderer(){if(!this.subSurface?.isScatteringEnabled)return!1;let e=this.getScene().enableSubSurfaceForPrePass();return e&&(e.enabled=!0),!0}dispose(e,t){this._breakShaderLoadedCheck=!0,t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),this._albedoTexture?.dispose(),this._ambientTexture?.dispose(),this._opacityTexture?.dispose(),this._reflectionTexture?.dispose(),this._emissiveTexture?.dispose(),this._metallicTexture?.dispose(),this._reflectivityTexture?.dispose(),this._bumpTexture?.dispose(),this._lightmapTexture?.dispose(),this._metallicReflectanceTexture?.dispose(),this._reflectanceTexture?.dispose(),this._microSurfaceTexture?.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}O.PBRMATERIAL_OPAQUE=m.F.MATERIAL_OPAQUE,O.PBRMATERIAL_ALPHATEST=m.F.MATERIAL_ALPHATEST,O.PBRMATERIAL_ALPHABLEND=m.F.MATERIAL_ALPHABLEND,O.PBRMATERIAL_ALPHATESTANDBLEND=m.F.MATERIAL_ALPHATESTANDBLEND,O.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0,O.LIGHTFALLOFF_PHYSICAL=0,O.LIGHTFALLOFF_GLTF=1,O.LIGHTFALLOFF_STANDARD=2,O.ForceGLSL=!1,(0,r.gn)([(0,s.rX)()],O.prototype,"_imageProcessingConfiguration",void 0),(0,r.gn)([(0,s.wz)("_markAllSubMeshesAsMiscDirty")],O.prototype,"debugMode",void 0)},29526:function(e,t,i){i.d(t,{Y:function(){return h}});var r=i(46456),s=i(22287),n=i(57449),a=i(50953),o=i(65940),l=i(16188),c=i(3609);class u extends l.H{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class h extends o.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRClearCoat",100,new u,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=h._DefaultIndexOfRefraction,this.indexOfRefraction=h._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=n.Wo.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;let r=this._material._disableBumpMap;return!e._areTexturesDirty||!t.texturesEnabled||(!this._texture||!a.k.ClearCoatTextureEnabled||!!this._texture.isReadyOrNotBlocking())&&(!this._textureRoughness||!a.k.ClearCoatTextureEnabled||!!this._textureRoughness.isReadyOrNotBlocking())&&(!i.getCaps().standardDerivatives||!this._bumpTexture||!a.k.ClearCoatBumpTextureEnabled||!!r||!!this._bumpTexture.isReady())&&(!this._isTintEnabled||!this._tintTexture||!a.k.ClearCoatTintTextureEnabled||!!this._tintTexture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&a.k.ClearCoatTextureEnabled?(0,c.lw)(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&a.k.ClearCoatTextureEnabled?(0,c.lw)(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&a.k.ClearCoatBumpTextureEnabled?(0,c.lw)(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===h._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&a.k.ClearCoatTintTextureEnabled?((0,c.lw)(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;let s=r.materialDefines,n=this._material.isFrozen,o=this._material._disableBumpMap,l=this._material._invertNormalMapX,u=this._material._invertNormalMapY;if(!e.useUbo||!n||!e.isSync){(this._texture||this._textureRoughness)&&a.k.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&(0,c.NL)(this._texture,e,"clearCoat"),this._textureRoughness&&!s.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&(0,c.NL)(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&a.k.ClearCoatTextureEnabled&&!o&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),(0,c.NL)(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",l?1:-1,u?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",l?-1:1,u?-1:1)),this._tintTexture&&a.k.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),(0,c.NL)(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);let r=1-this._indexOfRefraction,n=1+this._indexOfRefraction,h=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",Math.pow(-r/n,2),h,r,n),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&a.k.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!s.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&a.k.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&a.k.ClearCoatBumpTextureEnabled&&!o&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&a.k.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose(),this._bumpTexture?.dispose(),this._tintTexture?.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}h._DefaultIndexOfRefraction=1.5,(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"isEnabled",void 0),(0,r.gn)([(0,s.qC)()],h.prototype,"intensity",void 0),(0,r.gn)([(0,s.qC)()],h.prototype,"roughness",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"indexOfRefraction",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"texture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useRoughnessFromMainTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"textureRoughness",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"remapF0OnInterfaceChange",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"bumpTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"isTintEnabled",void 0),(0,r.gn)([(0,s.n9)()],h.prototype,"tintColor",void 0),(0,r.gn)([(0,s.qC)()],h.prototype,"tintColorAtDistance",void 0),(0,r.gn)([(0,s.qC)()],h.prototype,"tintThickness",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"tintTexture",void 0)},66110:function(e,t,i){i.d(t,{B:function(){return u}});var r=i(46456),s=i(22287),n=i(50953),a=i(65940),o=i(16188),l=i(3609);class c extends o.H{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0}}class u extends a.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRIridescence",110,new c,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=u._DefaultMinimumThickness,this.maximumThickness=u._DefaultMaximumThickness,this.indexOfRefraction=u._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!e._areTexturesDirty||!t.texturesEnabled||(!this._texture||!n.k.IridescenceTextureEnabled||!!this._texture.isReadyOrNotBlocking())&&(!this._thicknessTexture||!n.k.IridescenceTextureEnabled||!!this._thicknessTexture.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.IRIDESCENCE=!0,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&n.k.IridescenceTextureEnabled?(0,l.lw)(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,this._thicknessTexture&&n.k.IridescenceTextureEnabled?(0,l.lw)(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t){if(!this._isEnabled)return;let i=this._material.isFrozen;e.useUbo&&i&&e.isSync||((this._texture||this._thicknessTexture)&&n.k.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._thicknessTexture?.coordinatesIndex??0,this._thicknessTexture?.level??0),this._texture&&(0,l.NL)(this._texture,e,"iridescence"),this._thicknessTexture&&(0,l.NL)(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&n.k.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&n.k.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){e&&(this._texture?.dispose(),this._thicknessTexture?.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}u._DefaultMinimumThickness=100,u._DefaultMaximumThickness=400,u._DefaultIndexOfRefraction=1.3,(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"isEnabled",void 0),(0,r.gn)([(0,s.qC)()],u.prototype,"intensity",void 0),(0,r.gn)([(0,s.qC)()],u.prototype,"minimumThickness",void 0),(0,r.gn)([(0,s.qC)()],u.prototype,"maximumThickness",void 0),(0,r.gn)([(0,s.qC)()],u.prototype,"indexOfRefraction",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"texture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],u.prototype,"thicknessTexture",void 0)},49950:function(e,t,i){i.d(t,{Y:function(){return h}});var r=i(46456),s=i(22287),n=i(45260),a=i(57449),o=i(40193),l=i(7724),c=i(5848),u=i(90212);class h extends o.m{get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===o.m.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=o.m.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=o.m.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===o.m.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=o.m.LIGHTFALLOFF_GLTF:this._lightFalloff=o.m.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t,i),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=h.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=a.Wo.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new a.Wo(0,0,0),this.albedoColor=new a.Wo(1,1,1),this.reflectivityColor=new a.Wo(1,1,1),this.reflectionColor=new a.Wo(1,1,1),this.emissiveColor=new a.Wo(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this.applyDecalMapAfterDetailMap=!1,this._environmentBRDFTexture=(0,n.$)(this.getScene())}getClassName(){return"PBRMaterial"}clone(e,t=!0,i=""){let r=u.p.Clone(()=>new h(e,this.getScene()),this,{cloneTexturesOnlyOnce:t});return r.id=e,r.name=e,this.stencil.copyTo(r.stencil),this._clonePlugins(r,i),r}serialize(){let e=super.serialize();return e.customType="BABYLON.PBRMaterial",e}static Parse(e,t,i){let r=u.p.Parse(()=>new h(e.name,t),e,t,i);return e.stencil&&r.stencil.parse(e.stencil,t,i),c.F._ParsePlugins(e,r,t,i),e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}h.PBRMATERIAL_OPAQUE=o.m.PBRMATERIAL_OPAQUE,h.PBRMATERIAL_ALPHATEST=o.m.PBRMATERIAL_ALPHATEST,h.PBRMATERIAL_ALPHABLEND=o.m.PBRMATERIAL_ALPHABLEND,h.PBRMATERIAL_ALPHATESTANDBLEND=o.m.PBRMATERIAL_ALPHATESTANDBLEND,h.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=o.m.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"directIntensity",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"emissiveIntensity",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"environmentIntensity",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"specularIntensity",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"disableBumpMap",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"albedoTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"ambientTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"ambientTextureStrength",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"ambientTextureImpactOnAnalyticalLights",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesAndMiscDirty")],h.prototype,"opacityTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"reflectionTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"emissiveTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"reflectivityTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"metallicTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"metallic",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"roughness",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"metallicF0Factor",void 0),(0,r.gn)([(0,s.n9)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"metallicReflectanceColor",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"metallicReflectanceTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"reflectanceTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"microSurfaceTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"bumpTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty",null)],h.prototype,"lightmapTexture",void 0),(0,r.gn)([(0,s.n9)("ambient"),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"ambientColor",void 0),(0,r.gn)([(0,s.n9)("albedo"),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"albedoColor",void 0),(0,r.gn)([(0,s.n9)("reflectivity"),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"reflectivityColor",void 0),(0,r.gn)([(0,s.n9)("reflection"),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"reflectionColor",void 0),(0,r.gn)([(0,s.n9)("emissive"),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"emissiveColor",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"microSurface",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useLightmapAsShadowmap",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesAndMiscDirty")],h.prototype,"useAlphaFromAlbedoTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesAndMiscDirty")],h.prototype,"forceAlphaTest",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesAndMiscDirty")],h.prototype,"alphaCutOff",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useSpecularOverAlpha",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useRoughnessFromMetallicTextureAlpha",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useRoughnessFromMetallicTextureGreen",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useMetallnessFromMetallicTextureBlue",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useAmbientInGrayScale",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0),(0,r.gn)([(0,s.qC)()],h.prototype,"usePhysicalLightFalloff",null),(0,r.gn)([(0,s.qC)()],h.prototype,"useGLTFLightFalloff",null),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useRadianceOverAlpha",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useObjectSpaceNormalMap",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useParallax",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useParallaxOcclusion",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"parallaxScaleBias",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsLightsDirty")],h.prototype,"disableLighting",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"forceIrradianceInFragment",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsLightsDirty")],h.prototype,"maxSimultaneousLights",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"invertNormalMapX",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"invertNormalMapY",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"twoSidedLighting",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useAlphaFresnel",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useLinearAlphaFresnel",void 0),(0,r.gn)([(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"environmentBRDFTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"forceNormalForward",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"enableSpecularAntiAliasing",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useHorizonOcclusion",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useRadianceOcclusion",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsMiscDirty")],h.prototype,"unlit",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsMiscDirty")],h.prototype,"applyDecalMapAfterDetailMap",void 0),(0,l.H7)("BABYLON.PBRMaterial",h)},70325:function(e,t,i){i.d(t,{B:function(){return h}});var r=i(46456),s=i(22287),n=i(57449),a=i(50953),o=i(65940),l=i(16188),c=i(3609);class u extends l.H{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1}}class h extends o.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"Sheen",120,new u,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=n.Wo.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t){return!this._isEnabled||!e._areTexturesDirty||!t.texturesEnabled||(!this._texture||!a.k.SheenTextureEnabled||!!this._texture.isReadyOrNotBlocking())&&(!this._textureRoughness||!a.k.SheenTextureEnabled||!!this._textureRoughness.isReadyOrNotBlocking())}prepareDefinesBeforeAttributes(e,t){this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=null!==this._roughness,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&a.k.SheenTextureEnabled?((0,c.lw)(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&a.k.SheenTextureEnabled?(0,c.lw)(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,r){if(!this._isEnabled)return;let s=r.materialDefines,n=this._material.isFrozen;e.useUbo&&n&&e.isSync||((this._texture||this._textureRoughness)&&a.k.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",this._texture?.coordinatesIndex??0,this._texture?.level??0,this._textureRoughness?.coordinatesIndex??0,this._textureRoughness?.level??0),this._texture&&(0,c.NL)(this._texture,e,"sheen"),this._textureRoughness&&!s.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&(0,c.NL)(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),null!==this._roughness&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&a.k.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!s.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&a.k.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){e&&(this._texture?.dispose(),this._textureRoughness?.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"isEnabled",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"linkSheenWithAlbedo",void 0),(0,r.gn)([(0,s.qC)()],h.prototype,"intensity",void 0),(0,r.gn)([(0,s.n9)()],h.prototype,"color",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"texture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"useRoughnessFromMainTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"roughness",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"textureRoughness",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],h.prototype,"albedoScaling",void 0)},88118:function(e,t,i){i.d(t,{u:function(){return d}});var r=i(46456),s=i(22287),n=i(57449),a=i(50953),o=i(39884),l=i(65940),c=i(16188),u=i(3609);class h extends c.H{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,this.SS_SCATTERING=!1,this.SS_DISPERSION=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,this.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_USE_GLTF_TEXTURES=!1}}class d extends l.n{get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){this._scene.enableSubSurfaceForPrePass()&&e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"PBRSubSurface",130,new h,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isDispersionEnabled=!1,this.isDispersionEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=n.Wo.White(),this.tintColorAtDistance=1,this.dispersion=0,this.diffusionDistance=n.Wo.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this.translucencyColor=null,this._translucencyColorTexture=null,this.translucencyColorTexture=null,this._useGltfStyleTextures=!0,this.useGltfStyleTextures=!0,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&a.k.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking()||this._translucencyColorTexture&&a.k.TranslucencyColorTextureEnabled&&!this._translucencyColorTexture.isReadyOrNotBlocking()||this._translucencyIntensityTexture&&a.k.TranslucencyIntensityTextureEnabled&&!this._translucencyIntensityTexture.isReadyOrNotBlocking())return!1;let e=this._getRefractionTexture(t);if(e&&a.k.RefractionTextureEnabled&&!e.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_DISPERSION=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e.SS_TRANSLUCENCYCOLOR_TEXTUREDIRECTUV=0;return}if(e._areTexturesDirty){if(e.SUBSURFACE=!0,e.SS_DISPERSION=this._isDispersionEnabled,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_TRANSLUCENCYCOLOR_TEXTURE=!1,e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&a.k.ThicknessTextureEnabled&&(0,u.lw)(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&a.k.RefractionIntensityTextureEnabled&&(0,u.lw)(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&a.k.TranslucencyIntensityTextureEnabled&&(0,u.lw)(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE"),this._translucencyColorTexture&&a.k.TranslucencyColorTextureEnabled&&(0,u.lw)(this._translucencyColorTexture,e,"SS_TRANSLUCENCYCOLOR_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!=0,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._refractionIntensityTexture,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS=this._useMaskFromThicknessTexture&&!this._translucencyIntensityTexture,this._isRefractionEnabled&&t.texturesEnabled){let i=this._getRefractionTexture(t);i&&a.k.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=i.isCube,e.SS_GAMMAREFRACTION=i.gammaSpace,e.SS_RGBDREFRACTION=i.isRGBD,e.SS_LINEARSPECULARREFRACTION=i.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=this._scene.useRightHandedSystem&&i.isCube?!i.invertZ:i.invertZ,e.SS_LODINREFRACTIONALPHA=i.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=i.isCube&&i.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,r){if(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled){if(0===this.maximumThickness&&0===this.minimumThickness)e.updateFloat2("vThicknessParam",0,0);else{r.getRenderingMesh().getWorldMatrix().decompose(o.jp.Vector3[0]);let t=Math.max(Math.abs(o.jp.Vector3[0].x),Math.abs(o.jp.Vector3[0].y),Math.abs(o.jp.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*t,(this.maximumThickness-this.minimumThickness)*t)}}}bindForSubMesh(e,t,i,r){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;let s=r.materialDefines,n=this._material.isFrozen,o=this._material.realTimeFiltering,l=s.LODBASEDMICROSFURACE,c=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&a.k.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),(0,u.NL)(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&a.k.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),(0,u.NL)(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyColorTexture&&a.k.TranslucencyColorTextureEnabled&&s.SS_TRANSLUCENCYCOLOR_TEXTURE&&(e.updateFloat2("vTranslucencyColorInfos",this._translucencyColorTexture.coordinatesIndex,this._translucencyColorTexture.level),(0,u.NL)(this._translucencyColorTexture,e,"translucencyColor")),this._translucencyIntensityTexture&&a.k.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),(0,u.NL)(this._translucencyIntensityTexture,e,"translucencyIntensity")),c&&a.k.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",c.getRefractionTextureMatrix());let t=1;!c.isCube&&c.depth&&(t=c.depth);let i=c.getSize().width,r=this.volumeIndexOfRefraction;e.updateFloat4("vRefractionInfos",c.level,1/r,t,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",i,c.lodGenerationScale,c.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",i,Math.log2(i)),c.boundingBoxSize&&(e.updateVector3("vRefractionPosition",c.boundingBoxPosition),e.updateVector3("vRefractionSize",c.boundingBoxSize))}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateColor4("vTranslucencyColor",this.translucencyColor??this.tintColor,0),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0),e.updateFloat("dispersion",this.dispersion)}t.texturesEnabled&&(this._thicknessTexture&&a.k.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&a.k.RefractionIntensityTextureEnabled&&s.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&a.k.TranslucencyIntensityTextureEnabled&&s.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),this._translucencyColorTexture&&a.k.TranslucencyColorTextureEnabled&&s.SS_TRANSLUCENCYCOLOR_TEXTURE&&e.setTexture("translucencyColorSampler",this._translucencyColorTexture),c&&a.k.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",c):(e.setTexture("refractionSampler",c._lodTextureMid||c),e.setTexture("refractionSamplerLow",c._lodTextureLow||c),e.setTexture("refractionSamplerHigh",c._lodTextureHigh||c))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){a.k.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e||this._refractionIntensityTexture===e||this._translucencyIntensityTexture===e||this._translucencyColorTexture===e}hasRenderTargetTextures(){return!!a.k.RefractionTextureEnabled&&!!this._refractionTexture&&!!this._refractionTexture.isRenderTarget}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture),this._translucencyColorTexture&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&e.push(this._translucencyIntensityTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),this._translucencyColorTexture&&this._translucencyColorTexture.animations&&this._translucencyColorTexture.animations.length>0&&e.push(this._translucencyColorTexture),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.animations&&this._translucencyIntensityTexture.animations.length>0&&e.push(this._translucencyIntensityTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose(),this._translucencyColorTexture&&this._translucencyColorTexture.dispose(),this._translucencyIntensityTexture&&this._translucencyIntensityTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh","translucencyColorSampler")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"},{name:"dispersion",size:1,type:"float"},{name:"vTranslucencyColor",size:4,type:"vec4"},{name:"vTranslucencyColorInfos",size:2,type:"vec2"},{name:"translucencyColorMatrix",size:16,type:"mat4"}]}}}(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isRefractionEnabled",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isTranslucencyEnabled",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"isDispersionEnabled",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markScenePrePassDirty")],d.prototype,"isScatteringEnabled",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"_scatteringDiffusionProfileIndex",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"refractionIntensity",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"translucencyIntensity",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"useAlbedoToTintRefraction",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"useAlbedoToTintTranslucency",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"thicknessTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"refractionTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"indexOfRefraction",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"_volumeIndexOfRefraction",void 0),(0,r.gn)([(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"volumeIndexOfRefraction",null),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"invertRefractionY",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"linkRefractionWithTransparency",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"minimumThickness",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"maximumThickness",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"useThicknessAsDepth",void 0),(0,r.gn)([(0,s.n9)()],d.prototype,"tintColor",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"tintColorAtDistance",void 0),(0,r.gn)([(0,s.qC)()],d.prototype,"dispersion",void 0),(0,r.gn)([(0,s.n9)()],d.prototype,"diffusionDistance",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"useMaskFromThicknessTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"refractionIntensityTexture",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"translucencyIntensityTexture",void 0),(0,r.gn)([(0,s.n9)()],d.prototype,"translucencyColor",void 0),(0,r.gn)([(0,s.oU)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"translucencyColorTexture",void 0),(0,r.gn)([(0,s.qC)(),(0,s.wz)("_markAllSubMeshesAsTexturesDirty")],d.prototype,"useGltfStyleTextures",void 0)},18570:function(e,t,i){i.r(t),i.d(t,{_DDSTextureLoader:function(){return n}});var r=i(8937),s=i(90580);class n{constructor(){this.supportCascades=!0}loadCubeData(e,t,i,n){let a;let o=t.getEngine(),l=!1,c=1e3;if(Array.isArray(e))for(let i=0;i<e.length;i++){let r=e[i];a=s.N.GetDDSInfo(r),t.width=a.width,t.height=a.height,l=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,o._unpackFlipY(a.isCompressed),s.N.UploadDDSLevels(o,t,r,a,l,6,-1,i),a.isFourCC||1!==a.mipmapCount?c=a.mipmapCount-1:o.generateMipMapsForCubemap(t)}else a=s.N.GetDDSInfo(e),t.width=a.width,t.height=a.height,i&&(a.sphericalPolynomial=new r.i),l=(a.isRGB||a.isLuminance||a.mipmapCount>1)&&t.generateMipMaps,o._unpackFlipY(a.isCompressed),s.N.UploadDDSLevels(o,t,e,a,l,6),a.isFourCC||1!==a.mipmapCount?c=a.mipmapCount-1:o.generateMipMapsForCubemap(t,!1);o._setCubeMapTextureParams(t,l,c),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),n&&n({isDDS:!0,width:t.width,info:a,data:e,texture:t})}loadData(e,t,i){let r=s.N.GetDDSInfo(e),n=(r.isRGB||r.isLuminance||r.mipmapCount>1)&&t.generateMipMaps&&Math.max(r.width,r.height)>>r.mipmapCount-1==1;i(r.width,r.height,n,r.isFourCC,()=>{s.N.UploadDDSLevels(t.getEngine(),t,e,r,n,1)})}}},46877:function(e,t,i){i.r(t),i.d(t,{_HDRTextureLoader:function(){return s}});var r=i(32958);class s{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){let s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=(0,r.dK)(s),a=(0,r.ls)(s,n),o=n.width*n.height,l=new Float32Array(4*o);for(let e=0;e<o;e+=1)l[4*e]=a[3*e],l[4*e+1]=a[3*e+1],l[4*e+2]=a[3*e+2],l[4*e+3]=1;i(n.width,n.height,t.generateMipMaps,!1,()=>{let e=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,e._uploadDataToTextureDirectly(t,l)})}}},86861:function(e,t,i){i.r(t),i.d(t,{_TGATextureLoader:function(){return s}});var r=i(98029);class s{constructor(){this.supportCascades=!1}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){let s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),n=(0,r.A6)(s);i(n.width,n.height,t.generateMipMaps,!1,()=>{(0,r.Ab)(t,s)})}}},30115:function(e,t,i){i.d(t,{c:function(){return n}});var r=i(9719),s=i(81209);i(91410);class n extends s.x{constructor(e,t,i=null,r=!1,n=3,a=5,o){super(null,i,!r,o,n,void 0,void 0,void 0,void 0,a),this.name=e,this.wrapU=s.x.CLAMP_ADDRESSMODE,this.wrapV=s.x.CLAMP_ADDRESSMODE,this._generateMipMaps=r;let l=this._getEngine();if(!l)return;t.getContext?(this._canvas=t,this._ownCanvas=!1,this._texture=l.createDynamicTexture(t.width,t.height,r,n)):(this._canvas=l.createCanvas(1,1),this._ownCanvas=!0,t.width||0===t.width?this._texture=l.createDynamicTexture(t.width,t.height,r,n):this._texture=l.createDynamicTexture(t,t,r,n));let c=this.getSize();this._canvas.width!==c.width&&(this._canvas.width=c.width),this._canvas.height!==c.height&&(this._canvas.height=c.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){let t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){let i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(e){let t=this.getSize();e&&(this._context.fillStyle=e),this._context.clearRect(0,0,t.width,t.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,void 0===e||e,t,this._format||void 0,void 0,i)}drawText(e,t,i,r,s,n,a,o=!0){let l=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,l.width,l.height)),this._context.font=r,null==t){let i=this._context.measureText(e);t=(l.width-i.width)/2}if(null==i){let e=parseInt(r.replace(/\D/g,""));i=l.height/2+e/3.65}this._context.fillStyle=s||"",this._context.fillText(e,t,i),o&&this.update(a)}dispose(){super.dispose(),this._ownCanvas&&this._canvas?.remove?.(),this._canvas=null,this._context=null}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),i=new n(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){let e=this.getScene();e&&!e.isReady()&&r.Y.Warn("The scene must be ready before serializing the dynamic texture");let t=super.serialize();return n._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return void 0!==e.toDataURL}_rebuild(){this.update()}}},25184:function(e,t,i){i.d(t,{R:function(){return n}});var r=i(65330);let s=r.HighestCommonFactor,n={...r,TwoPi:2*Math.PI,Sign:Math.sign,Log2:Math.log2,HCF:s}},21658:function(e,t,i){var r=i(35823),s=i(93954),n=i(39884),a=i(9719),o=i(29892);r.Kj.prototype.thinInstanceAdd=function(e,t=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return a.Y.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(e)?e.length:1);let i=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(e))for(let i=0;i<e.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e[i],i===e.length-1&&t);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,e,t);return i},r.Kj.prototype.thinInstanceAddSelf=function(e=!0){return this.thinInstanceAdd(n.y3.IdentityReadOnly,e)},r.Kj.prototype.thinInstanceRegisterAttribute=function(e,t){e===s.o.ColorKind&&(e=s.o.ColorInstanceKind),this.removeVerticesData(e),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[e]=t,this._userThinInstanceBuffersStorage.sizes[e]=t*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[e]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[e]),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new s.o(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!0,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])},r.Kj.prototype.thinInstanceSetMatrixAt=function(e,t,i=!0){if(!this._thinInstanceDataStorage.matrixData||e>=this._thinInstanceDataStorage.instancesCount)return!1;let r=this._thinInstanceDataStorage.matrixData;return t.copyToArray(r,16*e),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[e]=t),i&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0},r.Kj.prototype.thinInstanceSetAttributeAt=function(e,t,i,r=!0){return e===s.o.ColorKind&&(e=s.o.ColorInstanceKind),!!this._userThinInstanceBuffersStorage&&!!this._userThinInstanceBuffersStorage.data[e]&&!(t>=this._thinInstanceDataStorage.instancesCount)&&(this._thinInstanceUpdateBufferSize(e,0),this._userThinInstanceBuffersStorage.data[e].set(i,t*this._userThinInstanceBuffersStorage.strides[e]),r&&this.thinInstanceBufferUpdated(e),!0)},Object.defineProperty(r.Kj.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(e){let t=this._thinInstanceDataStorage.matrixData??this.source?._thinInstanceDataStorage.matrixData;e<=(t?t.length/16:0)&&(this._thinInstanceDataStorage.instancesCount=e)},enumerable:!0,configurable:!0}),r.Kj.prototype._thinInstanceCreateMatrixBuffer=function(e,t,i=!0){let r=new s.l(this.getEngine(),t,!i,16,!1,!0);for(let t=0;t<4;t++)this.setVerticesBuffer(r.createVertexBuffer(e+t,4*t,4));return r},r.Kj.prototype.thinInstanceSetBuffer=function(e,t,i=0,r=!0){i=i||16,"matrix"===e?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=t?t.length:32*i,this._thinInstanceDataStorage.matrixData=t,this._thinInstanceDataStorage.worldMatrices=null,null!==t?(this._thinInstanceDataStorage.instancesCount=t.length/i,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",t,r),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):"previousMatrix"===e?(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=t,null!==t&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",t,r))):(e===s.o.ColorKind&&(e=s.o.ColorInstanceKind),null===t?this._userThinInstanceBuffersStorage?.data[e]&&(this.removeVerticesData(e),delete this._userThinInstanceBuffersStorage.data[e],delete this._userThinInstanceBuffersStorage.strides[e],delete this._userThinInstanceBuffersStorage.sizes[e],delete this._userThinInstanceBuffersStorage.vertexBuffers[e]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[e]=t,this._userThinInstanceBuffersStorage.strides[e]=i,this._userThinInstanceBuffersStorage.sizes[e]=t.length,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new s.o(this.getEngine(),t,e,!r,!1,i,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e])))},r.Kj.prototype.thinInstanceBufferUpdated=function(e){"matrix"===e?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.matrixBuffer&&!this._thinInstanceDataStorage.matrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._thinInstanceDataStorage.matrixBuffer?.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount)):"previousMatrix"===e?(this.thinInstanceAllowAutomaticStaticBufferRecreation&&this._thinInstanceDataStorage.previousMatrixBuffer&&!this._thinInstanceDataStorage.previousMatrixBuffer.isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._thinInstanceDataStorage.previousMatrixBuffer?.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount)):(e===s.o.ColorKind&&(e=s.o.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[e]&&(this.thinInstanceAllowAutomaticStaticBufferRecreation&&!this._userThinInstanceBuffersStorage.vertexBuffers[e].isUpdatable()&&this._thinInstanceRecreateBuffer(e),this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(this._userThinInstanceBuffersStorage.data[e],0)))},r.Kj.prototype.thinInstancePartialBufferUpdate=function(e,t,i){"matrix"===e?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(t,i):(e===s.o.ColorKind&&(e=s.o.ColorInstanceKind),this._userThinInstanceBuffersStorage?.vertexBuffers[e]&&this._userThinInstanceBuffersStorage.vertexBuffers[e].updateDirectly(t,i))},r.Kj.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];let e=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=[];for(let t=0;t<this._thinInstanceDataStorage.instancesCount;++t)this._thinInstanceDataStorage.worldMatrices[t]=n.y3.FromArray(e,16*t)}return this._thinInstanceDataStorage.worldMatrices},r.Kj.prototype.thinInstanceRefreshBoundingInfo=function(e=!1,t=!1,i=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;let r=this._thinInstanceDataStorage.boundingVectors;if(e||!this.rawBoundingInfo){r.length=0,this.refreshBoundingInfo(t,i);let e=this.getBoundingInfo();this.rawBoundingInfo=new o.j(e.minimum,e.maximum)}let s=this.getBoundingInfo(),a=this._thinInstanceDataStorage.matrixData;if(0===r.length)for(let e=0;e<s.boundingBox.vectors.length;++e)r.push(s.boundingBox.vectors[e].clone());n.jp.Vector3[0].setAll(Number.POSITIVE_INFINITY),n.jp.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e){n.y3.FromArrayToRef(a,16*e,n.jp.Matrix[0]);for(let e=0;e<r.length;++e)n.P.TransformCoordinatesToRef(r[e],n.jp.Matrix[0],n.jp.Vector3[2]),n.jp.Vector3[0].minimizeInPlace(n.jp.Vector3[2]),n.jp.Vector3[1].maximizeInPlace(n.jp.Vector3[2])}s.reConstruct(n.jp.Vector3[0],n.jp.Vector3[1]),this._updateBoundingInfo()},r.Kj.prototype._thinInstanceRecreateBuffer=function(e,t=!0){"matrix"===e?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",this._thinInstanceDataStorage.matrixData,t)):"previousMatrix"===e?this._scene.needsPreviousWorldMatrices&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.previousMatrixData??this._thinInstanceDataStorage.matrixData,t)):(e===s.o.ColorKind&&(e=s.o.ColorInstanceKind),this._userThinInstanceBuffersStorage.vertexBuffers[e]?.dispose(),this._userThinInstanceBuffersStorage.vertexBuffers[e]=new s.o(this.getEngine(),this._userThinInstanceBuffersStorage.data[e],e,!t,!1,this._userThinInstanceBuffersStorage.strides[e],!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))},r.Kj.prototype._thinInstanceUpdateBufferSize=function(e,t=1){e===s.o.ColorKind&&(e=s.o.ColorInstanceKind);let i="matrix"===e;if(!i&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[e]))return;let r=i?16:this._userThinInstanceBuffersStorage.strides[e],n=i?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[e],a=i?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[e],o=(this._thinInstanceDataStorage.instancesCount+t)*r,l=n;for(;l<o;)l*=2;if(!a||n!=l){if(a){let e=new Float32Array(l);e.set(a,0),a=e}else a=new Float32Array(l);i?(this._thinInstanceDataStorage.matrixBuffer?.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",a,!1),this._thinInstanceDataStorage.matrixData=a,this._thinInstanceDataStorage.matrixBufferSize=l,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",a,!1))):(this._userThinInstanceBuffersStorage.vertexBuffers[e]?.dispose(),this._userThinInstanceBuffersStorage.data[e]=a,this._userThinInstanceBuffersStorage.sizes[e]=l,this._userThinInstanceBuffersStorage.vertexBuffers[e]=new s.o(this.getEngine(),a,e,!0,!1,r,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[e]))}},r.Kj.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})},r.Kj.prototype._disposeThinInstanceSpecificData=function(){this._thinInstanceDataStorage?.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)}},32958:function(e,t,i){i.d(t,{dK:function(){return a},ls:function(){return l},od:function(){return o}});var r=i(75769);function s(e,t,i,r,s,n){if(s>0){var a;s=(a=s-136)>1023?898846567431158e293*Math.pow(2,a-1023):a<-1074?5e-324*1*Math.pow(2,a+1074):1*Math.pow(2,a),e[n+0]=t*s,e[n+1]=i*s,e[n+2]=r*s}else e[n+0]=0,e[n+1]=0,e[n+2]=0}function n(e,t){let i="",r="";for(let s=t;s<e.length-t&&"\n"!=(r=String.fromCharCode(e[s]));s++)i+=r;return i}function a(e){let t=0,i=0,r=n(e,0);if("#"!=r[0]||"?"!=r[1])throw"Bad HDR Format.";let s=!1,a=!1,o=0;do o+=r.length+1,"FORMAT=32-bit_rle_rgbe"==(r=n(e,o))?a=!0:0==r.length&&(s=!0);while(!s);if(!a)throw"HDR Bad header format, unsupported FORMAT";o+=r.length+1,r=n(e,o);let l=/^-Y (.*) \+X (.*)$/g.exec(r);if(!l||l.length<3)throw"HDR Bad header format, no size";if(i=parseInt(l[2]),t=parseInt(l[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return{height:t,width:i,dataPosition:o+=r.length+1}}function o(e,t,i=!1){let s=new Uint8Array(e),n=a(s),o=c(s,n);return r.B.ConvertPanoramaToCubemap(o,n.width,n.height,t,i)}function l(e,t){return c(e,t)}function c(e,t){let i,r,n,a,o,l=t.height,c=t.width,u=t.dataPosition,h=0,d=0,f=0,p=new Uint8Array(new ArrayBuffer(4*c)),m=new Float32Array(new ArrayBuffer(t.width*t.height*12));for(;l>0;){if(i=e[u++],r=e[u++],n=e[u++],a=e[u++],2!=i||2!=r||128&n||t.width<8||t.width>32767)return function(e,t){let i,r,n=t.height,a=t.width,o=t.dataPosition,l=new Float32Array(new ArrayBuffer(t.width*t.height*12));for(;n>0;){for(r=0;r<t.width;r++)i=e[o++],s(l,i,e[o++],e[o++],e[o++],(t.height-n)*a*3+3*r);n--}return l}(e,t);if((n<<8|a)!=c)throw"HDR Bad header format, wrong scan line width";for(f=0,h=0;f<4;f++)for(d=(f+1)*c;h<d;)if(i=e[u++],r=e[u++],i>128){if(0==(o=i-128)||o>d-h)throw"HDR Bad Format, bad scanline data (run)";for(;o-- >0;)p[h++]=r}else{if(0==(o=i)||o>d-h)throw"HDR Bad Format, bad scanline data (non-run)";if(p[h++]=r,--o>0)for(let t=0;t<o;t++)p[h++]=e[u++]}for(f=0;f<c;f++)i=p[f],s(m,i,r=p[f+c],n=p[f+2*c],a=p[f+3*c],(t.height-l)*c*3+3*f);l--}return m}},75769:function(e,t,i){i.d(t,{B:function(){return s}});var r=i(39884);class s{static ConvertPanoramaToCubemap(e,t,i,r,s=!1){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";let n=this.CreateCubemapTexture(r,this.FACE_FRONT,e,t,i,s),a=this.CreateCubemapTexture(r,this.FACE_BACK,e,t,i,s),o=this.CreateCubemapTexture(r,this.FACE_LEFT,e,t,i,s);return{front:n,back:a,left:o,right:this.CreateCubemapTexture(r,this.FACE_RIGHT,e,t,i,s),up:this.CreateCubemapTexture(r,this.FACE_UP,e,t,i,s),down:this.CreateCubemapTexture(r,this.FACE_DOWN,e,t,i,s),size:r,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,r,s,n=!1){let a=new Float32Array(new ArrayBuffer(e*e*12)),o=n?Math.max(1,Math.round(r/4/e)):1,l=1/o,c=l*l,u=t[1].subtract(t[0]).scale(l/e),h=t[3].subtract(t[2]).scale(l/e),d=1/e,f=0;for(let n=0;n<e;n++)for(let p=0;p<o;p++){let p=t[0],m=t[2];for(let t=0;t<e;t++)for(let l=0;l<o;l++){let o=m.subtract(p).scale(f).add(p);o.normalize();let l=this.CalcProjectionSpherical(o,i,r,s);a[n*e*3+3*t+0]+=l.r*c,a[n*e*3+3*t+1]+=l.g*c,a[n*e*3+3*t+2]+=l.b*c,p=p.add(u),m=m.add(h)}f+=d*l}return a}static CalcProjectionSpherical(e,t,i,r){let s=Math.atan2(e.z,e.x),n=Math.acos(e.y);for(;s<-Math.PI;)s+=2*Math.PI;for(;s>Math.PI;)s-=2*Math.PI;let a=s/Math.PI,o=Math.round((a=.5*a+.5)*i);o<0?o=0:o>=i&&(o=i-1);let l=Math.round(n/Math.PI*r);l<0?l=0:l>=r&&(l=r-1);let c=r-l-1;return{r:t[c*i*3+3*o+0],g:t[c*i*3+3*o+1],b:t[c*i*3+3*o+2]}}}s.FACE_LEFT=[new r.P(-1,-1,-1),new r.P(1,-1,-1),new r.P(-1,1,-1),new r.P(1,1,-1)],s.FACE_RIGHT=[new r.P(1,-1,1),new r.P(-1,-1,1),new r.P(1,1,1),new r.P(-1,1,1)],s.FACE_FRONT=[new r.P(1,-1,-1),new r.P(1,-1,1),new r.P(1,1,-1),new r.P(1,1,1)],s.FACE_BACK=[new r.P(-1,-1,1),new r.P(-1,-1,-1),new r.P(-1,1,1),new r.P(-1,1,-1)],s.FACE_DOWN=[new r.P(1,1,-1),new r.P(1,1,1),new r.P(-1,1,-1),new r.P(-1,1,1)],s.FACE_UP=[new r.P(-1,-1,-1),new r.P(-1,-1,1),new r.P(1,-1,-1),new r.P(1,-1,1)]},45260:function(e,t,i){i.d(t,{$:function(){return a}});var r=i(81209),s=i(99265);let n=0,a=e=>{if(!e.environmentBRDFTexture){let t=e.useDelayedTextureLoading;e.useDelayedTextureLoading=!1;let i=e._blockEntityCollection;e._blockEntityCollection=!1;let a=r.x.CreateFromBase64String("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==","EnvironmentBRDFTexture"+n++,e,!0,!1,r.x.BILINEAR_SAMPLINGMODE);e._blockEntityCollection=i;let o=e.getEngine().getLoadedTexturesCache(),l=o.indexOf(a.getInternalTexture());-1!==l&&o.splice(l,1),a.isRGBD=!0,a.wrapU=r.x.CLAMP_ADDRESSMODE,a.wrapV=r.x.CLAMP_ADDRESSMODE,e.environmentBRDFTexture=a,e.useDelayedTextureLoading=t,s.r.ExpandRGBDTexture(a);let c=e.getEngine().onContextRestoredObservable.add(()=>{a.isRGBD=!0;let t=e.onBeforeRenderObservable.add(()=>{a.isReady()&&(e.onBeforeRenderObservable.remove(t),s.r.ExpandRGBDTexture(a))})});e.onDisposeObservable.add(()=>{e.getEngine().onContextRestoredObservable.remove(c)})}return e.environmentBRDFTexture}},2463:function(e,t,i){function r(e,t,i,r){let s=r,n=0,a="";for(;s<i.length;){let r=i.charAt(s);if(a)r===a?'"'===a||"'"===a?"\\"!==i.charAt(s-1)&&(a=""):a="":"*/"===a&&"*"===r&&s+1<i.length&&("/"===i.charAt(s+1)&&(a=""),""===a&&s++);else switch(r){case e:n++;break;case t:n--;break;case'"':case"'":case"`":a=r;break;case"/":if(s+1<i.length){let e=i.charAt(s+1);"/"===e?a="\n":"*"===e&&(a="*/")}}if(s++,0===n)break}return 0===n?s-1:-1}function s(e,t){for(;t<e.length;){let i=e[t];if(" "!==i&&"\n"!==i&&"\r"!==i&&"	"!==i&&"\n"!==i&&"\xa0"!==i)break;t++}return t}function n(e){let t=e.charCodeAt(0);return t>=48&&t<=57||t>=65&&t<=90||t>=97&&t<=122||95==t}function a(e){let t=0,i="",r=!1,s=[];for(;t<e.length;){let n=e.charAt(t);if(i)n===i?'"'===i||"'"===i?("\\"!==e.charAt(t-1)&&(i=""),s.push(n)):(i="",r=!1):"*/"===i&&"*"===n&&t+1<e.length?("/"===e.charAt(t+1)&&(i=""),""===i&&(r=!1,t++)):r||s.push(n);else{switch(n){case'"':case"'":case"`":i=n;break;case"/":if(t+1<e.length){let s=e.charAt(t+1);"/"===s?(i="\n",r=!0):"*"===s&&(i="*/",r=!0)}}r||s.push(n)}t++}return s.join("")}function o(e,t,i,r){for(;t>=0&&e.charAt(t)!==i&&(!r||e.charAt(t)!==r);)t--;return t}function l(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function c(e,t,i,r){let s=e.indexOf(t);if(s<0)return e;if(i){for(;s++<e.length&&"{"!=e.charAt(s););s<e.length&&(e=e.substring(0,s+1)+i+e.substring(s+1))}if(r){let t=e.lastIndexOf("}");e=e.substring(0,t)+(r+"\n}")}return e}i.d(t,{AW:function(){return l},Kt:function(){return a},Pm:function(){return s},e0:function(){return c},uA:function(){return n},vt:function(){return r},wm:function(){return o}})},73030:function(e,t,i){i.d(t,{m:function(){return s}});var r=i(39884);class s{static _RemoveAndStorePivotPoint(e){e&&0===s._PivotCached&&(e.getPivotPointToRef(s._OldPivotPoint),s._PivotPostMultiplyPivotMatrix=e._postMultiplyPivotMatrix,s._OldPivotPoint.equalsToFloats(0,0,0)||(e.setPivotMatrix(r.y3.IdentityReadOnly),s._OldPivotPoint.subtractToRef(e.getPivotPoint(),s._PivotTranslation),s._PivotTmpVector.copyFromFloats(1,1,1),s._PivotTmpVector.subtractInPlace(e.scaling),s._PivotTmpVector.multiplyInPlace(s._PivotTranslation),e.position.addInPlace(s._PivotTmpVector))),s._PivotCached++}static _RestorePivotPoint(e){e&&!s._OldPivotPoint.equalsToFloats(0,0,0)&&1===s._PivotCached&&(e.setPivotPoint(s._OldPivotPoint),e._postMultiplyPivotMatrix=s._PivotPostMultiplyPivotMatrix,s._PivotTmpVector.copyFromFloats(1,1,1),s._PivotTmpVector.subtractInPlace(e.scaling),s._PivotTmpVector.multiplyInPlace(s._PivotTranslation),e.position.subtractInPlace(s._PivotTmpVector)),this._PivotCached--}}s._PivotCached=0,s._OldPivotPoint=new r.P,s._PivotTranslation=new r.P,s._PivotTmpVector=new r.P,s._PivotPostMultiplyPivotMatrix=!1},98029:function(e,t,i){i.d(t,{A6:function(){return s},Ab:function(){return n}});var r=i(9719);function s(e){let t=0;return{id_length:e[t++],colormap_type:e[t++],image_type:e[t++],colormap_index:e[t++]|e[t++]<<8,colormap_length:e[t++]|e[t++]<<8,colormap_size:e[t++],origin:[e[t++]|e[t++]<<8,e[t++]|e[t++]<<8],width:e[t++]|e[t++]<<8,height:e[t++]|e[t++]<<8,pixel_size:e[t++],flags:e[t++]}}function n(e,t){let i,n,o,l,c,u,h,d;if(t.length<19){r.Y.Error("Unable to load TGA file - Not enough data to contain header");return}let f=18,p=s(t);if(p.id_length+f>t.length){r.Y.Error("Unable to load TGA file - Not enough data");return}f+=p.id_length;let m=!1,_=!1,g=!1;switch(p.image_type){case 9:m=!0;case 1:_=!0;break;case 10:m=!0;case 2:break;case 11:m=!0;case 3:g=!0}let v=p.pixel_size>>3,S=p.width*p.height*v;if(_&&(n=t.subarray(f,f+=p.colormap_length*(p.colormap_size>>3))),m){let e,r,s;i=new Uint8Array(S);let n=0,a=new Uint8Array(v);for(;f<S&&n<S;)if(r=(127&(e=t[f++]))+1,128&e){for(s=0;s<v;++s)a[s]=t[f++];for(s=0;s<r;++s)i.set(a,n+s*v);n+=v*r}else{for(r*=v,s=0;s<r;++s)i[n+s]=t[f++];n+=r}}else i=t.subarray(f,f+=_?p.width*p.height:S);switch((48&p.flags)>>4){default:case 2:o=0,c=1,d=p.width,l=0,u=1,h=p.height;break;case 0:o=0,c=1,d=p.width,l=p.height-1,u=-1,h=-1;break;case 3:o=p.width-1,c=-1,d=-1,l=0,u=1,h=p.height;break;case 1:o=p.width-1,c=-1,d=-1,l=p.height-1,u=-1,h=-1}let x=a["_getImageData"+(g?"Grey":"")+p.pixel_size+"bits"](p,n,i,l,u,h,o,c,d);e.getEngine()._uploadDataToTextureDirectly(e,x)}let a={GetTGAHeader:s,UploadContent:n,_getImageData8bits:function(e,t,i,r,s,n,a,o,l){let c=e.width,u=e.height,h,d=0,f,p,m=new Uint8Array(c*u*4);for(p=r;p!==n;p+=s)for(f=a;f!==l;f+=o,d++)h=i[d],m[(f+c*p)*4+3]=255,m[(f+c*p)*4+2]=t[3*h+0],m[(f+c*p)*4+1]=t[3*h+1],m[(f+c*p)*4+0]=t[3*h+2];return m},_getImageData16bits:function(e,t,i,r,s,n,a,o,l){let c=e.width,u=e.height,h,d=0,f,p,m=new Uint8Array(c*u*4);for(p=r;p!==n;p+=s)for(f=a;f!==l;f+=o,d+=2){let e=((31744&(h=i[d+0]+(i[d+1]<<8)))>>10)*255/31|0,t=((992&h)>>5)*255/31|0,r=(31&h)*255/31|0;m[(f+c*p)*4+0]=e,m[(f+c*p)*4+1]=t,m[(f+c*p)*4+2]=r,m[(f+c*p)*4+3]=32768&h?0:255}return m},_getImageData24bits:function(e,t,i,r,s,n,a,o,l){let c=e.width,u=e.height,h=0,d,f,p=new Uint8Array(c*u*4);for(f=r;f!==n;f+=s)for(d=a;d!==l;d+=o,h+=3)p[(d+c*f)*4+3]=255,p[(d+c*f)*4+2]=i[h+0],p[(d+c*f)*4+1]=i[h+1],p[(d+c*f)*4+0]=i[h+2];return p},_getImageData32bits:function(e,t,i,r,s,n,a,o,l){let c=e.width,u=e.height,h=0,d,f,p=new Uint8Array(c*u*4);for(f=r;f!==n;f+=s)for(d=a;d!==l;d+=o,h+=4)p[(d+c*f)*4+2]=i[h+0],p[(d+c*f)*4+1]=i[h+1],p[(d+c*f)*4+0]=i[h+2],p[(d+c*f)*4+3]=i[h+3];return p},_getImageDataGrey8bits:function(e,t,i,r,s,n,a,o,l){let c=e.width,u=e.height,h,d=0,f,p,m=new Uint8Array(c*u*4);for(p=r;p!==n;p+=s)for(f=a;f!==l;f+=o,d++)h=i[d],m[(f+c*p)*4+0]=h,m[(f+c*p)*4+1]=h,m[(f+c*p)*4+2]=h,m[(f+c*p)*4+3]=255;return m},_getImageDataGrey16bits:function(e,t,i,r,s,n,a,o,l){let c=e.width,u=e.height,h=0,d,f,p=new Uint8Array(c*u*4);for(f=r;f!==n;f+=s)for(d=a;d!==l;d+=o,h+=2)p[(d+c*f)*4+0]=i[h+0],p[(d+c*f)*4+1]=i[h+0],p[(d+c*f)*4+2]=i[h+0],p[(d+c*f)*4+3]=i[h+1];return p}}},38018:function(e,t,i){i.d(t,{x:function(){return h}});var r=i(44755),s=i(82877),n=i(74909),a=i(88251),o=i(51092),l=i(97375),c=i(39884),u=i(57449);class h{getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return(t=this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:this.originalScene.activeCamera,e&&t&&t.isRigCamera)?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new l.e("shared gizmo light",new c.P(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=u.Wo.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return null==h._DefaultUtilityLayer?h._CreateDefaultUtilityLayerFromScene(o.l.LastCreatedScene):h._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return h._DefaultUtilityLayer=new h(e),h._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{h._DefaultUtilityLayer=null}),h._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return null==h._DefaultKeepDepthUtilityLayer&&(h._DefaultKeepDepthUtilityLayer=new h(o.l.LastCreatedScene),h._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,h._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{h._DefaultKeepDepthUtilityLayer=null})),h._DefaultKeepDepthUtilityLayer}constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new s.y$,this.utilityLayerScene=new r.x(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(t=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&t.type!==n.kD.POINTERMOVE&&t.type!==n.kD.POINTERUP&&t.type!==n.kD.POINTERDOWN&&t.type!==n.kD.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;let i=t.event;if(e.isPointerCaptured(i.pointerId)){this._pointerCaptures[i.pointerId]=!1;return}let r=i=>{let r=null;if(t.nearInteractionPickingInfo)r=t.nearInteractionPickingInfo.pickedMesh.getScene()==i?t.nearInteractionPickingInfo:new a.p;else if(i!==this.utilityLayerScene&&t.originalPickingInfo)r=t.originalPickingInfo;else{let s=null;this._renderCamera&&(s=i._activeCamera,i._activeCamera=this._renderCamera,t.ray=null),r=t.ray?i.pickWithRay(t.ray):i.pick(e.pointerX,e.pointerY),s&&(i._activeCamera=s)}return r},s=r(this.utilityLayerScene);if(!t.ray&&s&&(t.ray=s.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(t),this.onlyCheckPointerDownEvents&&t.type!=n.kD.POINTERDOWN){t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new n.R5(t.type,t.event,s),t.type),t.type===n.kD.POINTERUP&&this._pointerCaptures[i.pointerId]&&(this._pointerCaptures[i.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)s&&s.hit&&(t.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new n.R5(t.type,t.event,s),t.type),t.skipOnPointerObservable=!0);else{let i=r(e),a=t.event;i&&s&&(0===s.distance&&i.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,a),t.skipOnPointerObservable=!0):t.type===n.kD.POINTERDOWN?this._pointerCaptures[a.pointerId]=!0:(t.type===n.kD.POINTERMOVE||t.type===n.kD.POINTERUP)&&(this._lastPointerEvents[a.pointerId]&&(this.onPointerOutObservable.notifyObservers(a.pointerId),delete this._lastPointerEvents[a.pointerId]),this._notifyObservers(t,i,a)):!this._pointerCaptures[a.pointerId]&&(s.distance<i.distance||0===i.distance)?(this._notifyObservers(t,s,a),t.skipOnPointerObservable||(t.skipOnPointerObservable=s.distance>0)):!this._pointerCaptures[a.pointerId]&&s.distance>=i.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(i.pickedMesh)?(this._notifyObservers(t,i,a),t.skipOnPointerObservable=!0):((t.type===n.kD.POINTERMOVE||t.type===n.kD.POINTERUP)&&this._lastPointerEvents[a.pointerId]&&(this.onPointerOutObservable.notifyObservers(a.pointerId),delete this._lastPointerEvents[a.pointerId]),this._notifyObservers(t,s,a))),t.type===n.kD.POINTERUP&&this._pointerCaptures[a.pointerId]&&(this._pointerCaptures[a.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(e=>{this.shouldRender&&e==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new n.R5(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){let e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}h._DefaultUtilityLayer=null,h._DefaultKeepDepthUtilityLayer=null},40230:function(e,t,i){var r=i(29427);i(74575);let s=`uniform vPrimaryColor: vec4f;uniform vPrimaryColorShadow: vec4f;uniform vDiffuseInfos: vec2f;uniform vReflectionInfos: vec2f;uniform diffuseMatrix: mat4x4f;uniform reflectionMatrix: mat4x4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform fFovMultiplier: f32;uniform pointSize: f32;uniform shadowLevel: f32;uniform alpha: f32;uniform vBackgroundCenter: vec3f;uniform vReflectionControl: vec4f;uniform projectedGroundInfos: vec2f;
#include<sceneUboDeclaration>
`;r.v.IncludesShadersStoreWGSL.backgroundUboDeclaration=s},21514:function(e,t,i){var r=i(29427);let s=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {return uniforms.vSphericalL00
+ uniforms.vSphericalL1_1*(normal.y)
+ uniforms.vSphericalL10*(normal.z)
+ uniforms.vSphericalL11*(normal.x)
+ uniforms.vSphericalL2_2*(normal.y*normal.x)
+ uniforms.vSphericalL2_1*(normal.y*normal.z)
+ uniforms.vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ uniforms.vSphericalL21*(normal.z*normal.x)
+ uniforms.vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
fn computeEnvironmentIrradiance(normal: vec3f)->vec3f {var Nx: f32=normal.x;var Ny: f32=normal.y;var Nz: f32=normal.z;var C1: vec3f=uniforms.vSphericalZZ.rgb;var Cx: vec3f=uniforms.vSphericalX.rgb;var Cy: vec3f=uniforms.vSphericalY.rgb;var Cz: vec3f=uniforms.vSphericalZ.rgb;var Cxx_zz: vec3f=uniforms.vSphericalXX_ZZ.rgb;var Cyy_zz: vec3f=uniforms.vSphericalYY_ZZ.rgb;var Cxy: vec3f=uniforms.vSphericalXY.rgb;var Cyz: vec3f=uniforms.vSphericalYZ.rgb;var Czx: vec3f=uniforms.vSphericalZX.rgb;var a1: vec3f=Cyy_zz*Ny+Cy;var a2: vec3f=Cyz*Nz+a1;var b1: vec3f=Czx*Nz+Cx;var b2: vec3f=Cxy*Ny+b1;var b3: vec3f=Cxx_zz*Nx+b2;var t1: vec3f=Cz *Nz+C1;var t2: vec3f=a2 *Ny+t1;var t3: vec3f=b3 *Nx+t2;return t3;}
#endif
#endif
`;r.v.IncludesShadersStoreWGSL.harmonicsFunctions=s},62456:function(e,t,i){var r=i(29427);let s=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
fn radicalInverse_VdC(value: u32)->f32 
{var bits=(value<<16u) | (value>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return f32(bits)*2.3283064365386963e-10; }
fn hammersley(i: u32,N: u32)->vec2f
{return vec2f( f32(i)/ f32(N),radicalInverse_VdC(i));}
fn log4(x: f32)->f32 {return log2(x)/2.;}
const NUM_SAMPLES_FLOAT: f32= f32(NUM_SAMPLES);const NUM_SAMPLES_FLOAT_INVERSED: f32=1./NUM_SAMPLES_FLOAT;const K: f32=4.;fn irradiance(inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var result: vec3f= vec3f(0.0);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var Ls: vec3f=hemisphereCosSample(Xi);Ls=normalize(Ls);var Ns: vec3f= vec3f(0.,0.,1.);var NoL: f32=dot(Ns,Ls);if (NoL>0.) {var pdf_inversed: f32=PI/NoL;var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp(l,0.0,maxLevel);var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpaceVec3(c);
#endif
result+=c;}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
fn radiance(alphaG: f32,inputTexture: texture_cube<f32>,inputSampler: sampler,inputN: vec3f,filteringInfo: vec2f)->vec3f
{var n: vec3f=normalize(inputN);var c: vec3f=textureSample(inputTexture,inputSampler,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {var result: vec3f= vec3f(0.);var tangent: vec3f=select(vec3f(1.,0.,0.),vec3f(0.,0.,1.),abs(n.z)<0.999);tangent=normalize(cross(tangent,n));var bitangent: vec3f=cross(n,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,n);var maxLevel: f32=filteringInfo.y;var dim0: f32=filteringInfo.x;var omegaP: f32=(4.*PI)/(6.*dim0*dim0);var weight: f32=0.;for(var i: u32=0u; i<NUM_SAMPLES; i++)
{var Xi: vec2f=hammersley(i,NUM_SAMPLES);var H: vec3f=hemisphereImportanceSampleDggx(Xi,alphaG);var NoV: f32=1.;var NoH: f32=H.z;var NoH2: f32=H.z*H.z;var NoL: f32=2.*NoH2-1.;var L: vec3f= vec3f(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {var pdf_inversed: f32=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);var omegaS: f32=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;var l: f32=log4(omegaS)-log4(omegaP)+log4(K);var mipLevel: f32=clamp( f32(l),0.0,maxLevel);weight+=NoL;var c: vec3f=textureSampleLevel(inputTexture,inputSampler,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;r.v.IncludesShadersStoreWGSL.hdrFilteringFunctions=s},84147:function(e,t,i){var r=i(29427);let s=`fn hemisphereCosSample(u: vec2f)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=1.-u.y;var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDggx(u: vec2f,a: f32)->vec3f {var phi: f32=2.*PI*u.x;var cosTheta2: f32=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));var cosTheta: f32=sqrt(cosTheta2);var sinTheta: f32=sqrt(1.-cosTheta2);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
fn hemisphereImportanceSampleDCharlie(u: vec2f,a: f32)->vec3f { 
var phi: f32=2.*PI*u.x;var sinTheta: f32=pow(u.y,a/(2.*a+1.));var cosTheta: f32=sqrt(1.-sinTheta*sinTheta);return vec3f(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;r.v.IncludesShadersStoreWGSL.importanceSampling=s},84715:function(e,t,i){i(29427).v.IncludesShadersStoreWGSL.kernelBlurVaryingDeclaration="varying sampleCoord{X}: vec2f;"},758:function(e,t,i){i.r(t),i.d(t,{packingFunctionsWGSL:function(){return a}});var r=i(29427);let s="packingFunctions",n=`fn pack(depth: f32)->vec4f
{const bit_shift: vec4f= vec4f(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const bit_mask: vec4f= vec4f(0.0,1.0/255.0,1.0/255.0,1.0/255.0);var res: vec4f=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
fn unpack(color: vec4f)->f32
{const bit_shift: vec4f= vec4f(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;r.v.IncludesShadersStoreWGSL[s]=n;let a={name:s,shader:n}},41435:function(e,t,i){var r=i(29427);let s=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
fn getEnergyConservationFactor(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
fn getBRDFLookup(NdotV: f32,perceptualRoughness: f32)->vec3f {var UV: vec2f= vec2f(NdotV,perceptualRoughness);var brdfLookup: vec4f= textureSample(environmentBrdfSampler,environmentBrdfSamplerSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup=vec4f(fromRGBD(brdfLookup.rgba),brdfLookup.a);
#endif
return brdfLookup.rgb;}
fn getReflectanceFromBRDFWithEnvLookup(specularEnvironmentR0: vec3f,specularEnvironmentR90: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
fn getReflectanceFromBRDFLookup(specularEnvironmentR0: vec3f,environmentBrdf: vec3f)->vec3f {
#ifdef BRDF_V_HEIGHT_CORRELATED
var reflectance: vec3f=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
var reflectance: vec3f=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
fn getBRDFLookupCharlieSheen(NdotV: f32,perceptualRoughness: f32)->f32
{var c: f32=1.0-NdotV;var c3: f32=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
fn getReflectanceFromAnalyticalBRDFLookup_Jones(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
fn getSheenReflectanceFromBRDFLookup(reflectance0: vec3f,environmentBrdf: vec3f)->vec3f {var sheenEnvironmentReflectance: vec3f=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
fn fresnelSchlickGGXVec3(VdotH: f32,reflectance0: vec3f,reflectance90: vec3f)->vec3f
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
fn fresnelSchlickGGX(VdotH: f32,reflectance0: f32,reflectance90: f32)->f32
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
fn getR0RemappedForClearCoat(f0: vec3f)->vec3f {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturateVec3(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturateVec3(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
var s: vec3f=sqrt(f0);var t: vec3f=(uniforms.vClearCoatRefractionParams.z+uniforms.vClearCoatRefractionParams.w*s)/(uniforms.vClearCoatRefractionParams.w+uniforms.vClearCoatRefractionParams.z*s);return squareVec3(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const XYZ_TO_REC709: mat3x3f= mat3x3f(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);fn getIORTfromAirToSurfaceR0(f0: vec3f)->vec3f {var sqrtF0: vec3f=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
fn getR0fromIORsVec3(iorT: vec3f,iorI: f32)->vec3f {return squareVec3((iorT- vec3f(iorI))/(iorT+ vec3f(iorI)));}
fn getR0fromIORs(iorT: f32,iorI: f32)->f32 {return square((iorT-iorI)/(iorT+iorI));}
fn evalSensitivity(opd: f32,shift: vec3f)->vec3f {var phase: f32=2.0*PI*opd*1.0e-9;const val: vec3f= vec3f(5.4856e-13,4.4201e-13,5.2481e-13);const pos: vec3f= vec3f(1.6810e+06,1.7953e+06,2.2084e+06);const vr: vec3f= vec3f(4.3278e+09,9.3046e+09,6.6121e+09);var xyz: vec3f=val*sqrt(2.0*PI*vr)*cos(pos*phase+shift)*exp(-square(phase)*vr);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;var srgb: vec3f=XYZ_TO_REC709*xyz;return srgb;}
fn evalIridescence(outsideIOR: f32,eta2: f32,cosTheta1: f32,thinFilmThickness: f32,baseF0: vec3f)->vec3f {var I: vec3f= vec3f(1.0);var iridescenceIOR: f32=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));var sinTheta2Sq: f32=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));var cosTheta2Sq: f32=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
var cosTheta2: f32=sqrt(cosTheta2Sq);var R0: f32=getR0fromIORs(iridescenceIOR,outsideIOR);var R12: f32=fresnelSchlickGGX(cosTheta1,R0,1.);var R21: f32=R12;var T121: f32=1.0-R12;var phi12: f32=0.0;if (iridescenceIOR<outsideIOR) {phi12=PI;}
var phi21: f32=PI-phi12;var baseIOR: vec3f=getIORTfromAirToSurfaceR0(clamp(baseF0,vec3f(0.0),vec3f(0.9999))); 
var R1: vec3f=getR0fromIORsVec3(baseIOR,iridescenceIOR);var R23: vec3f=fresnelSchlickGGXVec3(cosTheta2,R1, vec3f(1.));var phi23: vec3f= vec3f(0.0);if (baseIOR[0]<iridescenceIOR) {phi23[0]=PI;}
if (baseIOR[1]<iridescenceIOR) {phi23[1]=PI;}
if (baseIOR[2]<iridescenceIOR) {phi23[2]=PI;}
var opd: f32=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;var phi: vec3f= vec3f(phi21)+phi23;var R123: vec3f=clamp(R12*R23,vec3f(1e-5),vec3f(0.9999));var r123: vec3f=sqrt(R123);var Rs: vec3f=(T121*T121)*R23/( vec3f(1.0)-R123);var C0: vec3f=R12+Rs;I=C0;var Cm: vec3f=Rs-T121;for (var m: i32=1; m<=2; m++)
{Cm*=r123;var Sm: vec3f=2.0*evalSensitivity( f32(m)*opd, f32(m)*phi);I+=Cm*Sm;}
return max(I, vec3f(0.0));}
#endif
fn normalDistributionFunction_TrowbridgeReitzGGX(NdotH: f32,alphaG: f32)->f32
{var a2: f32=alphaG*alphaG;var d: f32=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
fn normalDistributionFunction_CharlieSheen(NdotH: f32,alphaG: f32)->f32
{var invR: f32=1./alphaG;var cos2h: f32=NdotH*NdotH;var sin2h: f32=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
fn normalDistributionFunction_BurleyGGX_Anisotropic(NdotH: f32,TdotH: f32,BdotH: f32,alphaTB: vec2f)->f32 {var a2: f32=alphaTB.x*alphaTB.y;var v: vec3f= vec3f(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);var v2: f32=dot(v,v);var w2: f32=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
fn smithVisibility_GGXCorrelated(NdotL: f32,NdotV: f32,alphaG: f32)->f32 {
#ifdef MOBILE
var GGXV: f32=NdotL*(NdotV*(1.0-alphaG)+alphaG);var GGXL: f32=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
var a2: f32=alphaG*alphaG;var GGXV: f32=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);var GGXL: f32=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
fn smithVisibilityG1_TrowbridgeReitzGGXFast(dot: f32,alphaG: f32)->f32
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
var alphaSquared: f32=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
fn smithVisibility_TrowbridgeReitzGGXFast(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var visibility: f32=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
fn smithVisibility_GGXCorrelated_Anisotropic(NdotL: f32,NdotV: f32,TdotV: f32,BdotV: f32,TdotL: f32,BdotL: f32,alphaTB: vec2f)->f32 {var lambdaV: f32=NdotL*length( vec3f(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));var lambdaL: f32=NdotV*length( vec3f(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));var v: f32=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
fn visibility_Kelemen(VdotH: f32)->f32 {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
fn visibility_Ashikhmin(NdotL: f32,NdotV: f32)->f32
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
fn l(x: f32,alphaG: f32)->f32
{var oneMinusAlphaSq: f32=(1.0-alphaG)*(1.0-alphaG);var a: f32=mix(21.5473,25.3245,oneMinusAlphaSq);var b: f32=mix(3.82987,3.32435,oneMinusAlphaSq);var c: f32=mix(0.19823,0.16801,oneMinusAlphaSq);var d: f32=mix(-1.97760,-1.27393,oneMinusAlphaSq);var e: f32=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
fn lambdaSheen(cosTheta: f32,alphaG: f32)->f32
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
fn visibility_CharlieSheen(NdotL: f32,NdotV: f32,alphaG: f32)->f32
{var G: f32=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
fn diffuseBRDF_Burley(NdotL: f32,NdotV: f32,VdotH: f32,roughness: f32)->f32 {var diffuseFresnelNV: f32=pow5(saturateEps(1.0-NdotL));var diffuseFresnelNL: f32=pow5(saturateEps(1.0-NdotV));var diffuseFresnel90: f32=0.5+2.0*VdotH*VdotH*roughness;var fresnel: f32 =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
fn transmittanceBRDF_Burley(tintColor: vec3f,diffusionDistance: vec3f,thickness: f32)->vec3f {var S: vec3f=1./maxEpsVec3(diffusionDistance);var temp: vec3f=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
fn computeWrappedDiffuseNdotL(NdotL: f32,w: f32)->f32 {var t: f32=1.0+w;var invt2: f32=1.0/(t*t);return saturate((NdotL+w)*invt2);}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBRDFFunctions=s},53523:function(e,t,i){var r=i(29427);i(74575),i(31896);let s=`uniform vAlbedoInfos: vec2f;uniform vAmbientInfos: vec4f;uniform vOpacityInfos: vec2f;uniform vEmissiveInfos: vec2f;uniform vLightmapInfos: vec2f;uniform vReflectivityInfos: vec3f;uniform vMicroSurfaceSamplerInfos: vec2f;uniform vReflectionInfos: vec2f;uniform vReflectionFilteringInfo: vec2f;uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;uniform vBumpInfos: vec3f;uniform albedoMatrix: mat4x4f;uniform ambientMatrix: mat4x4f;uniform opacityMatrix: mat4x4f;uniform emissiveMatrix: mat4x4f;uniform lightmapMatrix: mat4x4f;uniform reflectivityMatrix: mat4x4f;uniform microSurfaceSamplerMatrix: mat4x4f;uniform bumpMatrix: mat4x4f;uniform vTangentSpaceParams: vec2f;uniform reflectionMatrix: mat4x4f;uniform vReflectionColor: vec3f;uniform vAlbedoColor: vec4f;uniform vLightingIntensity: vec4f;uniform vReflectionMicrosurfaceInfos: vec3f;uniform pointSize: f32;uniform vReflectivityColor: vec4f;uniform vEmissiveColor: vec3f;uniform vAmbientColor: vec3f;uniform vDebugMode: vec2f;uniform vMetallicReflectanceFactors: vec4f;uniform vMetallicReflectanceInfos: vec2f;uniform metallicReflectanceMatrix: mat4x4f;uniform vReflectanceInfos: vec2f;uniform reflectanceMatrix: mat4x4f;uniform vSphericalL00: vec3f;uniform vSphericalL1_1: vec3f;uniform vSphericalL10: vec3f;uniform vSphericalL11: vec3f;uniform vSphericalL2_2: vec3f;uniform vSphericalL2_1: vec3f;uniform vSphericalL20: vec3f;uniform vSphericalL21: vec3f;uniform vSphericalL22: vec3f;uniform vSphericalX: vec3f;uniform vSphericalY: vec3f;uniform vSphericalZ: vec3f;uniform vSphericalXX_ZZ: vec3f;uniform vSphericalYY_ZZ: vec3f;uniform vSphericalZZ: vec3f;uniform vSphericalXY: vec3f;uniform vSphericalYZ: vec3f;uniform vSphericalZX: vec3f;
#define ADDITIONAL_UBO_DECLARATION
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.v.IncludesShadersStoreWGSL.pbrUboDeclaration=s},60015:function(e,t,i){var r=i(29427);let s=`fn distanceSquared(a: vec2f,b: vec2f)->f32 { 
var temp=a-b; 
return dot(temp,temp); }
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
fn linearizeDepth(depth: f32,near: f32,far: f32)->f32 {
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
return -(near*far)/(far-depth*(far-near));
#else
return (near*far)/(far-depth*(far-near));
#endif
}
#endif
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera. Should be the actual near plane if screen-space depth is enabled.
param farPlaneZ The far plane for the camera. Used when screen-space depth is enabled.
param stride Step in horizontal or vertical pixels between samples. This is a var because: f32 integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avar self: voidnull collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param numIterations number of iterations performed
param csHitPovar Camera: i32 space location of the ray hit
*/
fn traceScreenSpaceRay1(
csOrigin: vec3f,
csDirection: vec3f,
projectToPixelMatrix: mat4x4f,
csZBuffer: texture_2d<f32>,
csZBufferSize: vec2f,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
csZBackBuffer: texture_2d<f32>,
csZBackSizeFactor: f32,
#endif
csZThickness: f32,
nearPlaneZ: f32,
farPlaneZ: f32,
stride: f32,
jitterFraction: f32,
maxSteps: f32,
maxRayTraceDistance: f32,
selfCollisionNumSkip: f32,
startPixel: ptr<function,vec2f>,
hitPixel: ptr<function,vec2f>,
csHitPoint: ptr<function,vec3f>,
numIterations: ptr<function,f32>
#ifdef SSRAYTRACE_DEBUG
,debugColor: ptr<function,vec3f>
#endif
)->bool
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
var rayLength: f32=select(maxRayTraceDistance,(-nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ);
#else
var rayLength: f32=select(maxRayTraceDistance,(nearPlaneZ-csOrigin.z)/csDirection.z,(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ);
#endif
var csEndPoint: vec3f=csOrigin+csDirection*rayLength;*hitPixel= vec2f(-1.0,-1.0);var H0: vec4f=projectToPixelMatrix* vec4f(csOrigin,1.0);var H1: vec4f=projectToPixelMatrix* vec4f(csEndPoint,1.0);var k0: f32=1.0/H0.w;var k1: f32=1.0/H1.w;var Q0: vec3f=csOrigin*k0;var Q1: vec3f=csEndPoint*k1;var P0: vec2f=H0.xy*k0;var P1: vec2f=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
var xMax: f32=csZBufferSize.x-0.5;var xMin=0.5;var yMax=csZBufferSize.y-0.5;var yMin=0.5;var alpha: f32=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-select(yMin,yMax,(P1.y>yMax)))/(P1.y-P0.y);}
if ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-select(xMin,xMax,(P1.x>xMax)))/(P1.x-P0.x));}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) { 
permute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }
var stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f= vec2f(stepDirection,delta.y*invdx);var dQ: vec3f=(Q1-Q0)*invdx;var dk: f32=(k1-k0)*invdx;var zMin: f32=min(csEndPoint.z,csOrigin.z);var zMax: f32=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;var pqk: vec4f= vec4f(P0,Q0.z,k0);var dPQK: vec4f= vec4f(dP,dQ.z,dk);*startPixel=select(P0.xy,P0.yx,permute);var prevZMaxEstimate: f32=csOrigin.z;var rayZMin: f32=prevZMaxEstimate;var rayZMax=prevZMaxEstimate;var sceneZMax: f32=rayZMax+1e4;var end: f32=P1.x*stepDirection;var hit: bool=false;var stepCount: f32;for (stepCount=0.0;(stepCount<=selfCollisionNumSkip) ||
((pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0);pqk+=dPQK 
)
{*hitPixel=select(pqk.xy,pqk.yx,permute);rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { 
var t: f32=rayZMin; rayZMin=rayZMax; rayZMax=t;}
sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var sceneBackZ: f32=textureLoad(csZBackBuffer,vec2<i32>(*hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
stepCount+=1.0;}
pqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;var invStride: f32=1.0/stride;dPQK*=invStride;var refinementStepCount: f32=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||
((refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0));pqk+=dPQK)
{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);*hitPixel=select(pqk.xy,pqk.yx,permute);sceneZMax=textureLoad(csZBuffer,vec2<i32>(*hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
refinementStepCount+=1.0;}
pqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}
#endif
Q0=vec3f(Q0.xy+dQ.xy*stepCount,pqk.z);*csHitPoint=Q0/pqk.w;*numIterations=stepCount+1.0;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {*debugColor= vec3f(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {*debugColor= vec3f(1,0,0);} else if (sceneZMax==0.0) {*debugColor= vec3f(1,1,0);} else {*debugColor= vec3f(0,stepCount/maxSteps,0);}
#endif
return hit;}
/**
texCoord: in the [0,1] range
depth: depth in view space (range [znear,zfar]])
*/
fn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32,projection: mat4x4f,invProjectionMatrix: mat4x4f)->vec3f {var xy=texCoord*2.0-1.0;var z: f32;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef ORTHOGRAPHIC_CAMERA
z=-projection[2].z*depth+projection[3].z;
#else
z=-projection[2].z-projection[3].z/depth;
#endif
#else
#ifdef ORTHOGRAPHIC_CAMERA
z=projection[2].z*depth+projection[3].z;
#else
z=projection[2].z+projection[3].z/depth;
#endif
#endif
var w=1.0;var ndc=vec4f(xy,z,w);var eyePos: vec4f=invProjectionMatrix*ndc;var result=eyePos.xyz/eyePos.w;return result;}
`;r.v.IncludesShadersStoreWGSL.screenSpaceRayTrace=s},3342:function(e,t,i){i.r(t),i.d(t,{shadowMapFragmentWGSL:function(){return a}});var r=i(29427);let s="shadowMapFragment",n=`var depthSM: f32=fragmentInputs.vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
depthSM=(fragmentInputs.zSM+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
fragmentOutputs.fragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
fragmentOutputs.fragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(fragmentInputs.vPositionWSM-uniforms.lightDataSM)+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,uniforms.biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
fragmentOutputs.color= vec4f(depthSM,1.0,1.0,1.0);
#else
fragmentOutputs.color=pack(depthSM);
#endif
`;r.v.IncludesShadersStoreWGSL[s]=n;let a={name:s,shader:n}},11395:function(e,t,i){i.r(t),i.d(t,{shadowMapFragmentSoftTransparentShadowWGSL:function(){return a}});var r=i(29427);let s="shadowMapFragmentSoftTransparentShadow",n=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alpha) {discard;}
#endif
`;r.v.IncludesShadersStoreWGSL[s]=n;let a={name:s,shader:n}},58530:function(e,t,i){i.r(t),i.d(t,{shadowMapVertexMetricWGSL:function(){return a}});var r=i(29427);let s="shadowMapVertexMetric",n=`#if SM_USEDISTANCE==1
vertexOutputs.vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.position.z-=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;
#else
vertexOutputs.position.z+=uniforms.biasAndScaleSM.x*vertexOutputs.position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
vertexOutputs.zSM=vertexOutputs.position.z;vertexOutputs.position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetricSM=(-vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#else
vertexOutputs.vDepthMetricSM=(vertexOutputs.position.z+uniforms.depthValuesSM.x)/uniforms.depthValuesSM.y+uniforms.biasAndScaleSM.x;
#endif
#endif
`;r.v.IncludesShadersStoreWGSL[s]=n;let a={name:s,shader:n}},18034:function(e,t,i){i.r(t),i.d(t,{anaglyphPixelShaderWGSL:function(){return a}});var r=i(29427);let s="anaglyphPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var leftSamplerSampler: sampler;var leftSampler: texture_2d<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var leftFrag: vec4f=textureSample(leftSampler,leftSamplerSampler,input.vUV);leftFrag= vec4f(1.0,leftFrag.g,leftFrag.b,1.0);var rightFrag: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);rightFrag= vec4f(rightFrag.r,1.0,1.0,1.0);fragmentOutputs.color= vec4f(rightFrag.rgb*leftFrag.rgb,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},50131:function(e,t,i){i.r(t),i.d(t,{backgroundPixelShaderWGSL:function(){return a}});var r=i(29427);i(40230),i(42766),i(82370),i(16693),i(42751),i(14696),i(89716),i(31103),i(50973),i(71030),i(1741),i(24228),i(39192),i(92907),i(33220);let s="backgroundPixelShader",n=`#include<backgroundUboDeclaration>
#include<helperFunctions>
varying vPositionW: vec3f;
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif 
#ifdef MAINUV2 
varying vMainUV2: vec2f; 
#endif 
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vDiffuseUV: vec2f;
#endif
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef TEXTURELODSUPPORT
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
fn fresnelSchlickEnvironmentGGX(VdotN: f32,reflectance0: vec3f,reflectance90: vec3f,smoothness: f32)->vec3f
{var weight: f32=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
fn diskIntersectWithBackFaceCulling(ro: vec3f,rd: vec3f,c: vec3f,r: f32)->f32 {var d: f32=rd.y;if(d>0.0) { return 1e6; }
var o: vec3f=ro-c;var t: f32=-o.y/d;var q: vec3f=o+rd*t;return select(1e6,t,(dot(q,q)<r*r));}
fn sphereIntersect(ro: vec3f,rd: vec3f,ra: f32)->f32 {var b: f32=dot(ro,rd);var c: f32=dot(ro,ro)-ra*ra;var h: f32=b*b-c;if(h<0.0) { return -1.0; }
h=sqrt(h);return-b+h;}
fn project(viewDirectionW: vec3f,eyePosition: vec3f)->vec3f {var radius: f32=uniforms.projectedGroundInfos.x;var height: f32=uniforms.projectedGroundInfos.y;var camDir: vec3f=-viewDirectionW;var skySphereDistance: f32=sphereIntersect(eyePosition,camDir,radius);var skySpherePositionW: vec3f=eyePosition+camDir*skySphereDistance;var p: vec3f=normalize(skySpherePositionW);var upEyePosition=vec3f(eyePosition.x,eyePosition.y-height,eyePosition.z);var sIntersection: f32=sphereIntersect(upEyePosition,p,radius);var h: vec3f= vec3f(0.0,-height,0.0);var dIntersection: f32=diskIntersectWithBackFaceCulling(upEyePosition,p,h,radius);p=(upEyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(fragmentInputs.vNormalW);
#else
var normalW: vec3f= vec3f(0.0,1.0,0.0);
#endif
var shadow: f32=1.;var globalShadow: f32=0.;var shadowLightCount: f32=0.;var aggShadow: f32=0.;var numLights: f32=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
var reflectionColor: vec4f= vec4f(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
var reflectionVector: vec3f=project(viewDirectionW,scene.vEyePosition.xyz);reflectionVector= (uniforms.reflectionMatrix*vec4f(reflectionVector,1.)).xyz;
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(fragmentInputs.vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f=reflectionVector;
#else
var reflectionCoords: vec2f=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
var reflectionLOD: f32=uniforms.vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD);var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var reflectionSpecularMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
textureSample(reflectionrHighSampler,reflectionrHighSamplerSampler,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
var reflectionSample: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor=vec4f(fromRGBD(reflectionColor).rgb,reflectionColor.a);
#endif
#ifdef GAMMAREFLECTION
reflectionColor=vec4f(toLinearSpaceVec3(reflectionColor.rgb),reflectionColor.a);
#endif
#ifdef REFLECTIONBGR
reflectionColor=vec4f(reflectionColor.bgr,reflectionColor.a);
#endif
reflectionColor=vec4f(reflectionColor.rgb*uniforms.vReflectionInfos.x,reflectionColor.a);
#endif
var diffuseColor: vec3f= vec3f(1.,1.,1.);var finalAlpha: f32=uniforms.alpha;
#ifdef DIFFUSE
var diffuseMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap=vec4f(toLinearSpaceVec3(diffuseMap.rgb),diffuseMap.a);
#endif
diffuseMap=vec4f(diffuseMap.rgb *uniforms.vDiffuseInfos.y,diffuseMap.a);
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
var colorBase: vec3f=diffuseColor;
#else
var colorBase: vec3f=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,vec3f(0.0));
#ifdef USERGBCOLOR
var finalColor: vec3f=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
var mainColor: vec3f=mix(uniforms.vPrimaryColorShadow.rgb,uniforms.vPrimaryColor.rgb,colorBase);
#else
var mainColor: vec3f=uniforms.vPrimaryColor.rgb;
#endif
var finalColor: vec3f=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
var reflectionAmount: vec3f=uniforms.vReflectionControl.xxx;var reflectionReflectance0: vec3f=uniforms.vReflectionControl.yyy;var reflectionReflectance90: vec3f=uniforms.vReflectionControl.zzz;var VdotN: f32=dot(normalize(scene.vEyePosition.xyz),normalW);var planarReflectionFresnel: vec3f=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
var reflectionDistanceFalloff: f32=1.0-saturate(length(vPositionW.xyz-uniforms.vBackgroundCenter)*uniforms.vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturateVec3(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
var viewAngleToFloor: f32=dot(normalW,normalize(scene.vEyePosition.xyz-uniforms.vBackgroundCenter));const startAngle: f32=0.1;var fadeFactor: f32=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*uniforms.shadowLevel,finalColor,globalShadow);
#endif
var color: vec4f= vec4f(finalColor,finalAlpha);
#else
var color: vec4f= vec4f(uniforms.vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*uniforms.alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color=vec4f(clamp(color.rgb,vec3f(0.),vec3f(30.0)),color.a);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color=vec4f(color.rgb *color.a,color.a);
#endif
#ifdef NOISE
color=vec4f(color.rgb+dither(fragmentInputs.vPositionW.xy,0.5),color.a);color=max(color,vec4f(0.0));
#endif
fragmentOutputs.color=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},95538:function(e,t,i){i.r(t),i.d(t,{backgroundVertexShaderWGSL:function(){return a}});var r=i(29427);i(40230),i(42766),i(10001),i(7694),i(93725),i(47659),i(24398),i(18777),i(50973),i(90860),i(30037),i(80867),i(46479),i(5352),i(14413),i(96748);let s="backgroundVertexShader",n=`#include<backgroundUboDeclaration>
#include<helperFunctions>
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vPositionW: vec3f;
#ifdef NORMAL
varying vNormalW: vec3f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef MAINUV1
varying vMainUV1: vec2f;
#endif
#ifdef MAINUV2
varying vMainUV2: vec2f;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vDiffuseUV: vec2f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=input.position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);} else {vertexOutputs.position=scene.viewProjectionR*finalWorld* vec4f(input.position,1.0);}
#else
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(input.position,1.0);
#endif
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#ifdef NORMAL
var normalWorld: mat3x3f=mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*input.normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(input.position,0.0)).xyz);
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
var screenToWorld: mat3x3f=inverseMat3( mat3x3f(finalWorld*scene.viewProjection));var segment: vec3f=mix(vertexOutputs.vDirectionW,screenToWorld* vec3f(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vertexOutputs.vDirectionW=normalize(segment);} else {vertexOutputs.vDirectionW=normalize(vertexOutputs.vDirectionW+(vertexOutputs.vDirectionW-segment));}
#endif
#endif
#ifndef UV1
var uv: vec2f=vec2f(0.,0.);
#else
var uv=input.uv;
#endif
#ifndef UV2
var uv2: vec2f=vec2f(0.,0.);
#else
var uv2=input.uv2;
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uv;
#endif
#ifdef MAINUV2
vertexOutputs.vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (uniforms.vDiffuseInfos.x==0.)
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv,1.0,0.0)).xy;}
else
{vertexOutputs.vDiffuseUV= (uniforms.diffuseMatrix* vec4f(uv2,1.0,0.0)).xy;}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vertexOutputs.vColor=color;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},98101:function(e,t,i){i.r(t),i.d(t,{bilateralBlurPixelShaderWGSL:function(){return a}});var r=i(29427);let s="bilateralBlurPixelShader",n=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}
var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
var sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords=vec2f(f32(x));var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var depthDelta: f32=abs(sampleDepth-depth);var wd: f32=step(depthDelta,uniforms.depthThreshold);var normalDelta: vec3f=abs(sampleNormal-normal);var wn: f32=step(normalDelta.x+normalDelta.y+normalDelta.z,uniforms.normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}
fragmentOutputs.color= vec4f(sum/wsum,1.);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},45971:function(e,t,i){i.r(t),i.d(t,{bilateralBlurQualityPixelShaderWGSL:function(){return a}});var r=i(29427);let s="bilateralBlurQualityPixelShader",n=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;uniform depthThreshold: f32;uniform normalThreshold: f32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color= vec4f(color,1.);return fragmentOutputs;}
var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
var sigma: f32= f32(uniforms.filterSize);var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sigmaNormal: f32=uniforms.normalThreshold;var two_sigmaNormal2: f32=2.0*sigmaNormal*sigmaNormal;var sum: vec3f= vec3f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {for (var y: i32=-uniforms.filterSize; y<=uniforms.filterSize; y++) {var coords: vec2f= vec2f(x,y)*uniforms.blurDir;var sampleColor: vec3f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords,0.).rgb;var sampleDepth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV+coords,0.).r;var sampleNormal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV+coords,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepth-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);var rNormal: f32=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);var wn: f32=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}
fragmentOutputs.color= vec4f(sum/wsum,1.);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},51414:function(e,t,i){i.r(t),i.d(t,{blackAndWhitePixelShaderWGSL:function(){return a}});var r=i(29427);let s="blackAndWhitePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform degree: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var luminance: f32=dot(color, vec3f(0.3,0.59,0.11)); 
var blackAndWhite: vec3f= vec3f(luminance,luminance,luminance);fragmentOutputs.color= vec4f(color-((color-blackAndWhite)*uniforms.degree),1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},37846:function(e,t,i){i.r(t),i.d(t,{bloomMergePixelShaderWGSL:function(){return a}});var r=i(29427);let s="bloomMergePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var bloomBlurSampler: sampler;var bloomBlur: texture_2d<f32>;uniform bloomWeight: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var blurred: vec3f=textureSample(bloomBlur,bloomBlurSampler,input.vUV).rgb;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+(blurred.rgb*uniforms.bloomWeight),fragmentOutputs.color.a);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},23581:function(e,t,i){i.r(t),i.d(t,{boundingBoxRendererPixelShaderWGSL:function(){return a}});var r=i(29427);let s="boundingBoxRendererPixelShader",n=`uniform color: vec4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
fragmentOutputs.color=uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},96018:function(e,t,i){i.r(t),i.d(t,{boundingBoxRendererVertexShaderWGSL:function(){return a}});var r=i(29427);let s="boundingBoxRendererVertexShader",n=`attribute position: vec3f;uniform world: mat4x4f;uniform viewProjection: mat4x4f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var worldPos: vec4f=uniforms.world* vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#define CUSTOM_VERTEX_MAIN_END
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},8290:function(e,t,i){i.r(t),i.d(t,{chromaticAberrationPixelShaderWGSL:function(){return a}});var r=i(29427);let s="chromaticAberrationPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform chromatic_aberration: f32;uniform radialIntensity: f32;uniform direction: vec2f;uniform centerPosition: vec2f;uniform screen_width: f32;uniform screen_height: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var centered_screen_pos: vec2f= vec2f(input.vUV.x-uniforms.centerPosition.x,input.vUV.y-uniforms.centerPosition.y);var directionOfEffect: vec2f=uniforms.direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}
var radius2: f32=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;var radius: f32=sqrt(radius2);var ref_indices: vec3f= vec3f(-0.3,0.0,0.3);var ref_shiftX: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.x/uniforms.screen_width;var ref_shiftY: f32=uniforms.chromatic_aberration*pow(radius,uniforms.radialIntensity)*directionOfEffect.y/uniforms.screen_height;var ref_coords_r: vec2f=vec2f(input.vUV.x+ref_indices.r*ref_shiftX,input.vUV.y+ref_indices.r*ref_shiftY*0.5);var ref_coords_g: vec2f=vec2f(input.vUV.x+ref_indices.g*ref_shiftX,input.vUV.y+ref_indices.g*ref_shiftY*0.5);var ref_coords_b: vec2f=vec2f(input.vUV.x+ref_indices.b*ref_shiftX,input.vUV.y+ref_indices.b*ref_shiftY*0.5);var r=textureSample(textureSampler,textureSamplerSampler,ref_coords_r);var g=textureSample(textureSampler,textureSamplerSampler,ref_coords_g);var b=textureSample(textureSampler,textureSamplerSampler,ref_coords_b);var a=clamp(r.a+g.a+b.a,0.,1.);fragmentOutputs.color=vec4f(r.r,g.g,b.b,a);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},9969:function(e,t,i){i.r(t),i.d(t,{circleOfConfusionPixelShaderWGSL:function(){return a}});var r=i(29427);let s="circleOfConfusionPixelShader",n=`varying vUV: vec2f;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform cameraMinMaxZ: vec2f;uniform focusDistance: f32;uniform cocPrecalculation: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;
#define CUSTOM_COC_DEPTH
var pixelDistance: f32=(uniforms.cameraMinMaxZ.x+uniforms.cameraMinMaxZ.y*depth)*1000.0; 
#define CUSTOM_COC_PIXELDISTANCE
var coc: f32=abs(uniforms.cocPrecalculation*((uniforms.focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);fragmentOutputs.color= vec4f(coc,coc,coc,1.0);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},65691:function(e,t,i){i.r(t),i.d(t,{colorPixelShaderWGSL:function(){return a}});var r=i(29427);i(71030),i(1741),i(24228),i(33220);let s="colorPixelShader",n=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vColor: vec4f;
#else
uniform color: vec4f;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
fragmentOutputs.color=input.vColor;
#else
fragmentOutputs.color=uniforms.color;
#endif
#include<fogFragment>(color,fragmentOutputs.color)
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},92030:function(e,t,i){i.r(t),i.d(t,{colorVertexShaderWGSL:function(){return a}});var r=i(29427);i(10001),i(7694),i(47659),i(24398),i(93725),i(90860),i(30037),i(80867),i(46479),i(5352),i(16888);let s="colorVertexShader",n=`attribute position: vec3f;
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform view: mat4x4f;
#endif
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},55840:function(e,t,i){i.r(t),i.d(t,{colorCorrectionPixelShaderWGSL:function(){return a}});var r=i(29427);let s="colorCorrectionPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;var colorTableSampler: sampler;var colorTable: texture_2d<f32>;const SLICE_COUNT: f32=16.0; 
fn sampleAs3DTexture(uv: vec3f,width: f32)->vec4f {var sliceSize: f32=1.0/width; 
var slicePixelSize: f32=sliceSize/width; 
var sliceInnerSize: f32=slicePixelSize*(width-1.0); 
var zSlice0: f32=min(floor(uv.z*width),width-1.0);var zSlice1: f32=min(zSlice0+1.0,width-1.0);var xOffset: f32=slicePixelSize*0.5+uv.x*sliceInnerSize;var s0: f32=xOffset+(zSlice0*sliceSize);var s1: f32=xOffset+(zSlice1*sliceSize);var slice0Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s0,uv.y));var slice1Color: vec4f=textureSample(colorTable,colorTableSampler,vec2f(s1,uv.y));var zOffset: f32=((uv.z*width)%(1.0));return mix(slice0Color,slice1Color,zOffset);}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var screen_color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=sampleAs3DTexture(screen_color.rgb,SLICE_COUNT);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},38458:function(e,t,i){i.r(t),i.d(t,{convolutionPixelShaderWGSL:function(){return a}});var r=i(29427);let s="convolutionPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform kernel: array<f32,9>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var colorSum: vec4f =
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,-1))*uniforms.kernel[0] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,-1))*uniforms.kernel[1] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,-1))*uniforms.kernel[2] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,0))*uniforms.kernel[3] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,0))*uniforms.kernel[4] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,0))*uniforms.kernel[5] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(-1,1))*uniforms.kernel[6] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(0,1))*uniforms.kernel[7] +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel* vec2f(1,1))*uniforms.kernel[8];var kernelWeight: f32 =
uniforms.kernel[0] +
uniforms.kernel[1] +
uniforms.kernel[2] +
uniforms.kernel[3] +
uniforms.kernel[4] +
uniforms.kernel[5] +
uniforms.kernel[6] +
uniforms.kernel[7] +
uniforms.kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}
fragmentOutputs.color= vec4f((colorSum/kernelWeight).rgb,1);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},97989:function(e,t,i){i.r(t),i.d(t,{copyTexture3DLayerToTexturePixelShaderWGSL:function(){return a}});var r=i(29427);let s="copyTexture3DLayerToTexturePixelShader",n=`var textureSampler: texture_3d<f32>;uniform layerNum: i32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let coord=vec3f(vec2f(input.vUV.x,input.vUV.y)*vec2f(textureDimensions(textureSampler,0).xy),f32(uniforms.layerNum));let color=textureLoad(textureSampler,vec3i(coord),0).rgb;fragmentOutputs.color= vec4f(color,1);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},26918:function(e,t,i){i.r(t),i.d(t,{copyTextureToTexturePixelShaderWGSL:function(){return a}});var r=i(29427);i(42766);let s="copyTextureToTexturePixelShader",n=`uniform conversion: f32;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;
#include<helperFunctions>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#ifdef DEPTH_TEXTURE
fragmentOutputs.fragDepth=color.r;
#else
if (uniforms.conversion==1.) {color=toLinearSpaceVec4(color);} else if (uniforms.conversion==2.) {color=toGammaSpace(color);}
fragmentOutputs.color=color;
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},81042:function(e,t,i){i.r(t),i.d(t,{depthPixelShaderWGSL:function(){return a}});var r=i(29427);i(71030),i(758),i(24228);let s="depthPixelShader",n=`#ifdef ALPHATEST
varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
varying vDepthMetric: f32;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vViewPos: vec4f;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
fragmentOutputs.color=pack(input.vViewPos.z);
#else
fragmentOutputs.color= vec4f(input.vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
fragmentOutputs.color=pack(input.position.z);
#else
fragmentOutputs.color= vec4f(input.position.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
fragmentOutputs.color=pack(input.vDepthMetric);
#else
fragmentOutputs.color= vec4f(input.vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},74725:function(e,t,i){i.r(t),i.d(t,{depthVertexShaderWGSL:function(){return a}});var r=i(29427);i(10001),i(7694),i(54394),i(31343),i(47659),i(93725),i(8772),i(87696),i(90860),i(30037),i(80867),i(46479);let s="depthVertexShader",n=`attribute position: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;uniform depthValues: vec2f;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vUV: vec2f;uniform diffuseMatrix: mat4x4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform view: mat4x4f;varying vViewPos: vec4f;
#endif
varying vDepthMetric: f32;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#include<clipPlaneVertex>
vertexOutputs.position=uniforms.viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vertexOutputs.vViewPos=uniforms.view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vertexOutputs.vDepthMetric=((-vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));
#else
vertexOutputs.vDepthMetric=((vertexOutputs.position.z+uniforms.depthValues.x)/(uniforms.depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef UV2
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},69639:function(e,t,i){i.r(t),i.d(t,{depthBoxBlurPixelShaderWGSL:function(){return a}});var r=i(29427);let s="depthBoxBlurPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var colorDepth: vec4f=vec4f(0.0);for (var x: i32=-OFFSET; x<=OFFSET; x++) {for (var y: i32=-OFFSET; y<=OFFSET; y++) {colorDepth+=textureSample(textureSampler,textureSamplerSampler,input.vUV+ vec2f(f32(x),f32(y))/uniforms.screenSize);}}
fragmentOutputs.color=(colorDepth/ f32((OFFSET*2+1)*(OFFSET*2+1)));}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},56930:function(e,t,i){i.r(t),i.d(t,{depthOfFieldMergePixelShaderWGSL:function(){return a}});var r=i(29427);let s="depthOfFieldMergePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;var blurStep0Sampler: sampler;var blurStep0: texture_2d<f32>;
#if BLUR_LEVEL>0
var blurStep1Sampler: sampler;var blurStep1: texture_2d<f32>;
#endif
#if BLUR_LEVEL>1
var blurStep2Sampler: sampler;var blurStep2: texture_2d<f32>;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coc: f32=textureSampleLevel(circleOfConfusionSampler,circleOfConfusionSamplerSampler,input.vUV,0.0).r;
#if BLUR_LEVEL==0
var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL==1
if(coc<0.5){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred1,coc/0.5);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.5)/0.5);}
#endif
#if BLUR_LEVEL==2
if(coc<0.33){var original: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(original,blurred2,coc/0.33);}else if(coc<0.66){var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);var blurred2: vec4f=textureSampleLevel(blurStep2,blurStep2Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{var blurred0: vec4f=textureSampleLevel(blurStep0,blurStep0Sampler,input.vUV,0.0);var blurred1: vec4f=textureSampleLevel(blurStep1,blurStep1Sampler,input.vUV,0.0);fragmentOutputs.color=mix(blurred1,blurred0,(coc-0.66)/0.34);}
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},76995:function(e,t,i){i.r(t),i.d(t,{displayPassPixelShaderWGSL:function(){return a}});var r=i(29427);let s="displayPassPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var passSamplerSampler: sampler;var passSampler: texture_2d<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(passSampler,passSamplerSampler,input.vUV);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},71764:function(e,t,i){i.r(t),i.d(t,{extractHighlightsPixelShaderWGSL:function(){return a}});var r=i(29427);i(42766);let s="extractHighlightsPixelShader",n=`#include<helperFunctions>
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform threshold: f32;uniform exposure: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var luma: f32=dot(LuminanceEncodeApprox,fragmentOutputs.color.rgb*uniforms.exposure);fragmentOutputs.color=vec4f(step(uniforms.threshold,luma)*fragmentOutputs.color.rgb,fragmentOutputs.color.a);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},25232:function(e,t,i){i.r(t),i.d(t,{filterPixelShaderWGSL:function(){return a}});var r=i(29427);let s="filterPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform kernelMatrix: mat4x4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var baseColor: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var updatedColor: vec3f=(uniforms.kernelMatrix* vec4f(baseColor,1.0)).rgb;fragmentOutputs.color= vec4f(updatedColor,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},85355:function(e,t,i){i.r(t),i.d(t,{fluidRenderingBilateralBlurPixelShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingBilateralBlurPixelShader",n=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform maxFilterSize: i32;uniform blurDir: vec2f;uniform projectedParticleConstant: f32;uniform depthThreshold: f32;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var depth: f32=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.).x;if (depth>=1e6 || depth<=0.) {fragmentOutputs.color=vec4f(vec3f(depth),1.);return fragmentOutputs;}
var filterSize: i32=min(uniforms.maxFilterSize,i32(ceil(uniforms.projectedParticleConstant/depth)));var sigma: f32=f32(filterSize)/3.0;var two_sigma2: f32=2.0*sigma*sigma;var sigmaDepth: f32=uniforms.depthThreshold/3.0;var two_sigmaDepth2: f32=2.0*sigmaDepth*sigmaDepth;var sum: f32=0.;var wsum: f32=0.;var sumVel: f32=0.;for (var x: i32=-filterSize; x<=filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampleDepthVel: vec2f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.).rg;var r: f32=dot(coords,coords);var w: f32=exp(-r/two_sigma2);var rDepth: f32=sampleDepthVel.r-depth;var wd: f32=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}
fragmentOutputs.color=vec4f(sum/wsum,sumVel/wsum,0.,1.);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},68534:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleDepthPixelShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingParticleDepthPixelShader",n=`uniform projection: mat4x4f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;
#ifdef FLUIDRENDERING_VELOCITY
varying velocityNorm: f32;
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}
var normal: vec3f=vec3f(normalxy,sqrt(1.0-r2));
#ifndef FLUIDRENDERING_RHS
normal.z=-normal.z;
#endif
var realViewPos: vec4f=vec4f(input.viewPos+normal*input.sphereRadius,1.0);var clipSpacePos: vec4f=uniforms.projection*realViewPos;fragmentOutputs.fragDepth=clipSpacePos.z/clipSpacePos.w;
#ifdef FLUIDRENDERING_RHS
realViewPos.z=-realViewPos.z;
#endif
#ifdef FLUIDRENDERING_VELOCITY
fragmentOutputs.color=vec4f(realViewPos.z,input.velocityNorm,0.,1.);
#else
fragmentOutputs.color=vec4f(realViewPos.z,0.,0.,1.);
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},51083:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleDepthVertexShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingParticleDepthVertexShader",n=`attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying viewPos: vec3f;varying sphereRadius: f32;
#ifdef FLUIDRENDERING_VELOCITY
attribute velocity: vec3f;varying velocityNorm: f32;
#endif
@vertex
fn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(
vec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,
0.0
);vertexOutputs.viewPos=(uniforms.view*vec4f(input.position,1.0)).xyz;vertexOutputs.position=uniforms.projection*vec4f(vertexOutputs.viewPos+cornerPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.sphereRadius=uniforms.size.x/2.0;
#ifdef FLUIDRENDERING_VELOCITY
vertexOutputs.velocityNorm=length(velocity);
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},17160:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleDiffusePixelShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingParticleDiffusePixelShader",n=`uniform particleAlpha: f32;varying uv: vec2f;varying diffuseColor: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}
fragmentOutputs.color=vec4f(input.diffuseColor,1.0);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},74836:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleThicknessPixelShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingParticleThicknessPixelShader",n=`uniform particleAlpha: f32;varying uv: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normalxy: vec2f=input.uv*2.0-1.0;var r2: f32=dot(normalxy,normalxy);if (r2>1.0) {discard;}
var thickness: f32=sqrt(1.0-r2);fragmentOutputs.color=vec4f(vec3f(uniforms.particleAlpha*thickness),1.0);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},2530:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleThicknessVertexShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingParticleThicknessVertexShader",n=`attribute position: vec3f;attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;@vertex
fn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(
vec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,
0.0
);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},26356:function(e,t,i){i.r(t),i.d(t,{fluidRenderingRenderPixelShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingRenderPixelShader",n=`#define DISABLE_UNIFORMITY_ANALYSIS
#define IOR 1.333
#define ETA 1.0/IOR
#define F0 0.02
var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#else
uniform diffuseColor: vec3f;
#endif
#ifdef FLUIDRENDERING_FIXED_THICKNESS
uniform thickness: f32;var bgDepthSamplerSampler: sampler;var bgDepthSampler: texture_2d<f32>;
#else
uniform minimumThickness: f32;var thicknessSamplerSampler: sampler;var thicknessSampler: texture_2d<f32>;
#endif
#ifdef FLUIDRENDERING_ENVIRONMENT
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;
#endif
uniform viewMatrix: mat4x4f;uniform projectionMatrix: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform texelSize: vec2f;uniform dirLight: vec3f;uniform cameraFar: f32;uniform density: f32;uniform refractionStrength: f32;uniform fresnelClamp: f32;uniform specularPower: f32;varying vUV: vec2f;fn computeViewPosFromUVDepth(texCoord: vec2f,depth: f32)->vec3f {var ndc: vec4f=vec4f(texCoord*2.0-1.0,0.0,1.0);
#ifdef FLUIDRENDERING_RHS
ndc.z=-uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;
#else
ndc.z=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;
#endif
ndc.w=1.0;var eyePos: vec4f=uniforms.invProjectionMatrix*ndc;return eyePos.xyz/eyePos.w;}
fn getViewPosFromTexCoord(texCoord: vec2f)->vec3f {var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var texCoord: vec2f=input.vUV;
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
var color: vec4f=textureSample(debugSampler,debugSamplerSampler,texCoord);
#ifdef FLUIDRENDERING_DEBUG_DEPTH
fragmentOutputs.color=vec4f(color.rgb/vec3f(2.0),1.);if (color.r>0.999 && color.g>0.999) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}
#else
fragmentOutputs.color=vec4f(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,texCoord);}
#endif
return fragmentOutputs;
#endif
var depthVel: vec2f=textureSampleLevel(depthSampler,depthSamplerSampler,texCoord,0.).rg;var depth: f32=depthVel.r;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
var thickness: f32=textureSample(thicknessSampler,thicknessSamplerSampler,texCoord).x;
#else
var thickness: f32=uniforms.thickness;var bgDepth: f32=textureSample(bgDepthSampler,bgDepthSamplerSampler,texCoord).x;var depthNonLinear: f32=uniforms.projectionMatrix[2].z+uniforms.projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;
#endif
var backColor: vec4f=textureSample(textureSampler,textureSamplerSampler,texCoord);
#ifndef FLUIDRENDERING_FIXED_THICKNESS
if (depth>=uniforms.cameraFar || depth<=0. || thickness<=uniforms.minimumThickness) {
#else
if (depth>=uniforms.cameraFar || depth<=0. || bgDepth<=depthNonLinear) {
#endif
#ifdef FLUIDRENDERING_COMPOSITE_MODE
fragmentOutputs.color=vec4f(backColor.rgb*backColor.a,backColor.a);
#else
fragmentOutputs.color=backColor;
#endif
return fragmentOutputs;}
var viewPos: vec3f=computeViewPosFromUVDepth(texCoord,depth);var ddx: vec3f=getViewPosFromTexCoord(texCoord+vec2f(uniforms.texelSize.x,0.))-viewPos;var ddy: vec3f=getViewPosFromTexCoord(texCoord+vec2f(0.,uniforms.texelSize.y))-viewPos;var ddx2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(-uniforms.texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}
var ddy2: vec3f=viewPos-getViewPosFromTexCoord(texCoord+vec2f(0.,-uniforms.texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}
var normal: vec3f=normalize(cross(ddy,ddx));
#ifdef FLUIDRENDERING_RHS
normal=-normal;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)
fragmentOutputs.color=vec4f(normal*0.5+0.5,1.0);return fragmentOutputs;
#endif
var rayDir: vec3f=normalize(viewPos); 
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
var diffuseColor: vec3f=textureSampleLevel(diffuseSampler,diffuseSamplerSampler,texCoord,0.0).rgb;
#else
var diffuseColor: vec3f=uniforms.diffuseColor;
#endif
var lightDir: vec3f=normalize((uniforms.viewMatrix*vec4f(-uniforms.dirLight,0.)).xyz);var H: vec3f =normalize(lightDir-rayDir);var specular: f32 =pow(max(0.0,dot(H,normal)),uniforms.specularPower);
#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING
var diffuse: f32 =max(0.0,dot(lightDir,normal))*1.0;fragmentOutputs.color=vec4f(vec3f(0.1) /*ambient*/+vec3f(0.42,0.50,1.00)*diffuse+vec3f(0,0,0.2)+specular,1.);return fragmentOutputs;
#endif
var refractionDir: vec3f=refract(rayDir,normal,ETA);var transmitted: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,vec2f(texCoord+refractionDir.xy*thickness*uniforms.refractionStrength),0.0);
#ifdef FLUIDRENDERING_COMPOSITE_MODE
if (transmitted.a==0.) {transmitted.a=thickness;}
#endif
var transmittance: vec3f=exp(-uniforms.density*thickness*(1.0-diffuseColor)); 
var refractionColor: vec3f=transmitted.rgb*transmittance;
#ifdef FLUIDRENDERING_ENVIRONMENT
var reflectionDir: vec3f=reflect(rayDir,normal);var reflectionColor: vec3f=(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionDir).rgb);var fresnel: f32=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,uniforms.fresnelClamp);var finalColor: vec3f=mix(refractionColor,reflectionColor,fresnel)+specular;
#else
var finalColor: vec3f=refractionColor+specular;
#endif
#ifdef FLUIDRENDERING_VELOCITY
var velocity: f32=depthVel.g;finalColor=mix(finalColor,vec3f(1.0),smoothstep(0.3,1.0,velocity/6.0));
#endif
fragmentOutputs.color=vec4f(finalColor,transmitted.a);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},16785:function(e,t,i){i.r(t),i.d(t,{fluidRenderingStandardBlurPixelShaderWGSL:function(){return a}});var r=i(29427);let s="fluidRenderingStandardBlurPixelShader",n=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform filterSize: i32;uniform blurDir: vec2f;varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var s: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.);if (s.r==0.) {fragmentOutputs.color=vec4f(0.,0.,0.,1.);return fragmentOutputs;}
var sigma: f32=f32(uniforms.filterSize)/3.0;var twoSigma2: f32=2.0*sigma*sigma;var sum: vec4f=vec4f(0.);var wsum: f32=0.;for (var x: i32=-uniforms.filterSize; x<=uniforms.filterSize; x++) {var coords: vec2f=vec2f(f32(x));var sampl: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV+coords*uniforms.blurDir,0.);var w: f32=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}
sum/=wsum;fragmentOutputs.color=vec4f(sum.rgb,1.);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},75426:function(e,t,i){i.r(t),i.d(t,{fxaaPixelShaderWGSL:function(){return a}});var r=i(29427);let s="fxaaPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform texelSize: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const fxaaQualitySubpix: f32=1.0;const fxaaQualityEdgeThreshold: f32=0.166;const fxaaQualityEdgeThresholdMin: f32=0.0833;const kLumaCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);fn FxaaLuma(rgba: vec4f)->f32 {return dot(rgba.rgb,kLumaCoefficients);} 
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var posM: vec2f;posM.x=input.vUV.x;posM.y=input.vUV.y;var rgbyM: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var lumaM: f32=FxaaLuma(rgbyM);var lumaS: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordS,0.0));var lumaE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordE,0.0));var lumaN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordN,0.0));var lumaW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordW,0.0));var maxSM: f32=max(lumaS,lumaM);var minSM: f32=min(lumaS,lumaM);var maxESM: f32=max(lumaE,maxSM);var minESM: f32=min(lumaE,minSM);var maxWN: f32=max(lumaN,lumaW);var minWN: f32=min(lumaN,lumaW);var rangeMax: f32=max(maxWN,maxESM);var rangeMin: f32=min(minWN,minESM);var rangeMaxScaled: f32=rangeMax*fxaaQualityEdgeThreshold;var range: f32=rangeMax-rangeMin;var rangeMaxClamped: f32=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{fragmentOutputs.color=rgbyM;return fragmentOutputs;}
#endif
var lumaNW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNW,0.0));var lumaSE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSE,0.0));var lumaNE: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordNE,0.0));var lumaSW: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,input.sampleCoordSW,0.0));var lumaNS: f32=lumaN+lumaS;var lumaWE: f32=lumaW+lumaE;var subpixRcpRange: f32=1.0/range;var subpixNSWE: f32=lumaNS+lumaWE;var edgeHorz1: f32=(-2.0*lumaM)+lumaNS;var edgeVert1: f32=(-2.0*lumaM)+lumaWE;var lumaNESE: f32=lumaNE+lumaSE;var lumaNWNE: f32=lumaNW+lumaNE;var edgeHorz2: f32=(-2.0*lumaE)+lumaNESE;var edgeVert2: f32=(-2.0*lumaN)+lumaNWNE;var lumaNWSW: f32=lumaNW+lumaSW;var lumaSWSE: f32=lumaSW+lumaSE;var edgeHorz4: f32=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);var edgeVert4: f32=(abs(edgeVert1)*2.0)+abs(edgeVert2);var edgeHorz3: f32=(-2.0*lumaW)+lumaNWSW;var edgeVert3: f32=(-2.0*lumaS)+lumaSWSE;var edgeHorz: f32=abs(edgeHorz3)+edgeHorz4;var edgeVert: f32=abs(edgeVert3)+edgeVert4;var subpixNWSWNESE: f32=lumaNWSW+lumaNESE;var lengthSign: f32=uniforms.texelSize.x;var horzSpan: bool=edgeHorz>=edgeVert;var subpixA: f32=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)
{lumaN=lumaW;}
if (!horzSpan) 
{lumaS=lumaE;}
if (horzSpan) 
{lengthSign=uniforms.texelSize.y;}
var subpixB: f32=(subpixA*(1.0/12.0))-lumaM;var gradientN: f32=lumaN-lumaM;var gradientS: f32=lumaS-lumaM;var lumaNN: f32=lumaN+lumaM;var lumaSS: f32=lumaS+lumaM;var pairN: bool=abs(gradientN)>=abs(gradientS);var gradient: f32=max(abs(gradientN),abs(gradientS));if (pairN)
{lengthSign=-lengthSign;}
var subpixC: f32=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);var posB: vec2f;posB.x=posM.x;posB.y=posM.y;var offNP: vec2f;offNP.x=select(uniforms.texelSize.x,0.0,(!horzSpan));offNP.y=select(uniforms.texelSize.y,0.0,(horzSpan));if (!horzSpan) 
{posB.x+=lengthSign*0.5;}
if (horzSpan)
{posB.y+=lengthSign*0.5;}
var posN: vec2f;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;var posP: vec2f;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;var subpixD: f32=((-2.0)*subpixC)+3.0;var lumaEndN: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN,0.0));var subpixE: f32=subpixC*subpixC;var lumaEndP: f32=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP,0.0));if (!pairN) 
{lumaNN=lumaSS;}
var gradientScaled: f32=gradient*1.0/4.0;var lumaMM: f32=lumaM-lumaNN*0.5;var subpixF: f32=subpixD*subpixE;var lumaMLTZero: bool=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;var doneN: bool=abs(lumaEndN)>=gradientScaled;var doneP: bool=abs(lumaEndP)>=gradientScaled;if (!doneN) 
{posN.x-=offNP.x*3.0;}
if (!doneN) 
{posN.y-=offNP.y*3.0;}
var doneNP: bool=(!doneN) || (!doneP);if (!doneP) 
{posP.x+=offNP.x*3.0;}
if (!doneP)
{posP.y+=offNP.y*3.0;}
if (doneNP)
{if (!doneN) {lumaEndN=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posN.xy,0.0));}
if (!doneP) {lumaEndP=FxaaLuma(textureSampleLevel(textureSampler,textureSamplerSampler,posP.xy,0.0));}
if (!doneN) {lumaEndN=lumaEndN-lumaNN*0.5;}
if (!doneP) {lumaEndP=lumaEndP-lumaNN*0.5;}
doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) {posN.x-=offNP.x*12.0;}
if (!doneN) {posN.y-=offNP.y*12.0;}
doneNP=(!doneN) || (!doneP);if (!doneP) {posP.x+=offNP.x*12.0;}
if (!doneP) {posP.y+=offNP.y*12.0;}}
var dstN: f32=posM.x-posN.x;var dstP: f32=posP.x-posM.x;if (!horzSpan)
{dstN=posM.y-posN.y;}
if (!horzSpan) 
{dstP=posP.y-posM.y;}
var goodSpanN: bool=(lumaEndN<0.0) != lumaMLTZero;var spanLength: f32=(dstP+dstN);var goodSpanP: bool=(lumaEndP<0.0) != lumaMLTZero;var spanLengthRcp: f32=1.0/spanLength;var directionN: bool=dstN<dstP;var dst: f32=min(dstN,dstP);var goodSpan: bool=select(goodSpanP,goodSpanN,directionN);var subpixG: f32=subpixF*subpixF;var pixelOffset: f32=(dst*(-spanLengthRcp))+0.5;var subpixH: f32=subpixG*fxaaQualitySubpix;var pixelOffsetGood: f32=select(0.0,pixelOffset,goodSpan);var pixelOffsetSubpix: f32=max(pixelOffsetGood,subpixH);if (!horzSpan)
{posM.x+=pixelOffsetSubpix*lengthSign;}
if (horzSpan)
{posM.y+=pixelOffsetSubpix*lengthSign;}
#ifdef MALI
if(range<rangeMaxClamped) 
{fragmentOutputs.color=rgbyM;}
else
{fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);}
#else
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,posM,0.0);
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},4527:function(e,t,i){i.r(t),i.d(t,{fxaaVertexShaderWGSL:function(){return a}});var r=i(29427);let s="fxaaVertexShader",n=`attribute position: vec2f;uniform texelSize: vec2f;varying vUV: vec2f;varying sampleCoordS: vec2f;varying sampleCoordE: vec2f;varying sampleCoordN: vec2f;varying sampleCoordW: vec2f;varying sampleCoordNW: vec2f;varying sampleCoordSE: vec2f;varying sampleCoordNE: vec2f;varying sampleCoordSW: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=(input.position*madd+madd);vertexOutputs.sampleCoordS=vertexOutputs.vUV+ vec2f( 0.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordE=vertexOutputs.vUV+ vec2f( 1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordN=vertexOutputs.vUV+ vec2f( 0.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordW=vertexOutputs.vUV+ vec2f(-1.0,0.0)*uniforms.texelSize;vertexOutputs.sampleCoordNW=vertexOutputs.vUV+ vec2f(-1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSE=vertexOutputs.vUV+ vec2f( 1.0,1.0)*uniforms.texelSize;vertexOutputs.sampleCoordNE=vertexOutputs.vUV+ vec2f( 1.0,-1.0)*uniforms.texelSize;vertexOutputs.sampleCoordSW=vertexOutputs.vUV+ vec2f(-1.0,1.0)*uniforms.texelSize;vertexOutputs.position=vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},62598:function(e,t,i){i.r(t),i.d(t,{geometryPixelShaderWGSL:function(){return a}});var r=i(29427);i(71030),i(40373),i(6877),i(42766),i(24228),i(24140);let s="geometryPixelShader",n=`#ifdef BUMP
varying vWorldView: mat4x4f;varying vNormalW: vec3f;
#else
varying vNormalV: vec3f;
#endif
varying vViewPos: vec4f;
#if defined(POSITION) || defined(BUMP)
varying vPositionW: vec3f;
#endif
#ifdef VELOCITY
varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#ifdef NEED_UV
varying vUV: vec2f;
#endif
#ifdef BUMP
uniform vBumpInfos: vec3f;uniform vTangentSpaceParams: vec2f;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;varying vReflectivityUV: vec2f;
#endif
#ifdef ALBEDOTEXTURE
varying vAlbedoUV: vec2f;var albedoSamplerSampler: sampler;var albedoSampler: texture_2d<f32>;
#endif
#ifdef REFLECTIVITYCOLOR
uniform reflectivityColor: vec3f;
#endif
#ifdef ALBEDOCOLOR
uniform albedoColor: vec3f;
#endif
#ifdef METALLIC
uniform metallic: f32;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform glossiness: f32;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV).a<0.4) {discard;}
#endif
var normalOutput: vec3f;
#ifdef BUMP
var normalW: vec3f=normalize(input.vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize( vec3f(input.vWorldView* vec4f(normalW,0.0)));
#endif
#else
normalOutput=normalize(input.vNormalV);
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef DEPTH
fragData[DEPTH_INDEX]=vec4f(input.vViewPos.z/input.vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef NORMAL
fragData[NORMAL_INDEX]=vec4f(normalOutput,1.0);
#endif
#ifdef SCREENSPACE_DEPTH
fragData[SCREENSPACE_DEPTH_INDEX]=vec4f(fragmentInputs.position.z,0.0,0.0,1.0);
#endif
#ifdef POSITION
fragData[POSITION_INDEX]= vec4f(input.vPositionW,1.0);
#endif
#ifdef VELOCITY
var a: vec2f=(input.vCurrentPosition.xy/input.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(input.vPreviousPosition.xy/input.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[VELOCITY_INDEX]= vec4f(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
var reflectivity: vec4f= vec4f(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
var metal: f32=1.0;var roughness: f32=1.0;
#ifdef ORMTEXTURE
metal*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).b;roughness*=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=uniforms.metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-uniforms.glossiness); 
#endif
reflectivity=vec4f(reflectivity.rgb,reflectivity.a-roughness);var color: vec3f= vec3f(1.0);
#ifdef ALBEDOTEXTURE
color=textureSample(albedoSampler,albedoSamplerSampler,input.vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpaceVec4(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=uniforms.albedoColor.xyz;
#endif
reflectivity=vec4f(mix( vec3f(0.04),color,metal),reflectivity.a);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity=vec4f(toLinearSpaceVec3(reflectivity.rgb),reflectivity.a);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity=vec4f(toLinearSpaceVec3(uniforms.reflectivityColor.xyz),1.0);
#endif
#endif
#ifdef GLOSSINESSS
reflectivity=vec4f(reflectivity.rgb,reflectivity.a*glossiness); 
#endif
#endif
fragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},18938:function(e,t,i){i.r(t),i.d(t,{geometryVertexShaderWGSL:function(){return a}});var r=i(29427);i(10001),i(7694),i(54394),i(31343),i(93725),i(74575),i(47659),i(8772),i(87696),i(90860),i(30037),i(80867),i(46479),i(39017);let s="geometryVertexShader",n=`#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<sceneUboDeclaration>
#include<clipPlaneVertexDeclaration>
attribute position: vec3f;attribute normal: vec3f;
#ifdef NEED_UV
varying vUV: vec2f;
#ifdef ALPHATEST
uniform diffuseMatrix: mat4x4f;
#endif
#ifdef BUMP
uniform bumpMatrix: mat4x4f;varying vBumpUV: vec2f;
#endif
#ifdef REFLECTIVITY
uniform reflectivityMatrix: mat4x4f;uniform albedoMatrix: mat4x4f;varying vReflectivityUV: vec2f;varying vAlbedoUV: vec2f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#ifdef BUMP
varying vWorldView: mat4x4f;
#endif
#ifdef BUMP
varying vNormalW: vec3f;
#else
varying vNormalV: vec3f;
#endif
varying vViewPos: vec4f;
#if defined(POSITION) || defined(BUMP)
varying vPositionW: vec3f;
#endif
#ifdef VELOCITY
uniform previousViewProjection: mat4x4f;varying vCurrentPosition: vec4f;varying vPreviousPosition: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=scene.viewProjection*finalWorld*vec4f(positionUpdated,1.0);vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f= vec4f(finalWorld* vec4f(positionUpdated,1.0));
#ifdef BUMP
vertexOutputs.vWorldView=scene.view*finalWorld;vertexOutputs.vNormalW=normalUpdated;
#else
#ifdef NORMAL_WORLDSPACE
vertexOutputs.vNormalV=normalize((finalWorld* vec4f(normalUpdated,0.0)).xyz);
#else
vertexOutputs.vNormalV=normalize(((scene.view*finalWorld)* vec4f(normalUpdated,0.0)).xyz);
#endif
#endif
vertexOutputs.vViewPos=scene.view*worldPos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
var previousInfluence: mat4x4f;previousInfluence=mPreviousBones[ i32(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[ i32(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[ i32(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[ i32(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[ i32(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld*previousInfluence* vec4f(positionUpdated,1.0);
#else
vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vertexOutputs.vPositionW=worldPos.xyz/worldPos.w;
#endif
vertexOutputs.position=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#else
vertexOutputs.vUV=input.uv;
#endif
#ifdef BUMP_UV1
vertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef REFLECTIVITY_UV1
vertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef ALBEDO_UV1
vertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vertexOutputs.vUV=(uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#else
vertexOutputs.vUV=input.uv2;
#endif
#ifdef BUMP_UV2
vertexOutputs.vBumpUV=(uniforms.bumpMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#ifdef REFLECTIVITY_UV2
vertexOutputs.vReflectivityUV=(uniforms.reflectivityMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#ifdef ALBEDO_UV2
vertexOutputs.vAlbedoUV=(uniforms.albedoMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#endif
#endif
#include<bumpVertex>
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},54879:function(e,t,i){i.r(t),i.d(t,{glowBlurPostProcessPixelShaderWGSL:function(){return a}});var r=i(29427);let s="glowBlurPostProcessPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform direction: vec2f;uniform blurWidth: f32;fn getLuminance(color: vec3f)->f32
{return dot(color, vec3f(0.2126,0.7152,0.0722));}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var weights: array<f32 ,7>;weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;var texelSize: vec2f= vec2f(1.0/uniforms.screenSize.x,1.0/uniforms.screenSize.y);var texelStep: vec2f=texelSize*uniforms.direction*uniforms.blurWidth;var start: vec2f=input.vUV-3.0*texelStep;var baseColor: vec4f= vec4f(0.,0.,0.,0.);var texelOffset: vec2f= vec2f(0.,0.);for (var i: i32=0; i<7; i++)
{var texel: vec4f=textureSample(textureSampler,textureSamplerSampler,start+texelOffset);baseColor=vec4f(baseColor.rgb,baseColor.a+texel.a*weights[i]);var luminance: f32=getLuminance(baseColor.rgb);var luminanceTexel: f32=getLuminance(texel.rgb);var choice: f32=step(luminanceTexel,luminance);baseColor=vec4f(choice*baseColor.rgb+(1.0-choice)*texel.rgb,baseColor.a);texelOffset+=texelStep;}
fragmentOutputs.color=baseColor;}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},37933:function(e,t,i){i.r(t),i.d(t,{glowMapGenerationPixelShaderWGSL:function(){return a}});var r=i(29427);i(42766),i(71030),i(24228);let s="glowMapGenerationPixelShader",n=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vUVDiffuse: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#ifdef OPACITY
varying vUVOpacity: vec2f;var opacitySamplerSampler: sampler;var opacitySampler: texture_2d<f32>;uniform var opacityIntensity: f32;
#endif
#ifdef EMISSIVE
varying vUVEmissive: vec2f;var emissiveSamplerSampler: sampler;var emissiveSampler: texture_2d<f32>;
#endif
#ifdef VERTEXALPHA
varying vColor: vec4f;
#endif
uniform glowColor: vec4f;uniform glowIntensity: f32;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
var finalColor: vec4f=uniforms.glowColor;
#ifdef DIFFUSE
var albedoTexture: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor=vec4f(finalColor.rgb,finalColor.a*albedoTexture.a);
#endif
#ifdef HIGHLIGHT
finalColor=vec4f(finalColor.rgb,albedoTexture.a);
#endif
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vUVOpacity);
#ifdef OPACITYRGB
finalColor=vec4f(finalColor.rgb,finalColor.a*getLuminance(opacityMap.rgb));
#else
finalColor=vec4f(finalColor.rgb,finalColor.a*opacityMap.a);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*opacityIntensity);
#endif
#ifdef VERTEXALPHA
finalColor=vec4f(finalColor.rgb,finalColor.a*vColor.a);
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
var emissive: vec4f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
fragmentOutputs.color=emissive*finalColor*uniforms.glowIntensity;
#else
fragmentOutputs.color=finalColor*uniforms.glowIntensity;
#endif
#ifdef HIGHLIGHT
fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb,uniforms.glowColor.a);
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},33758:function(e,t,i){i.r(t),i.d(t,{glowMapGenerationVertexShaderWGSL:function(){return a}});var r=i(29427);i(10001),i(7694),i(54394),i(31343),i(47659),i(93725),i(8772),i(87696),i(90860),i(30037),i(80867),i(46479);let s="glowMapGenerationVertexShader",n=`attribute position: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;varying vPosition: vec4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#ifdef DIFFUSE
varying vUVDiffuse: vec2f;uniform diffuseMatrix: mat4x4f;
#endif
#ifdef OPACITY
varying vUVOpacity: vec2f;uniform opacityMatrix: mat4x4f;
#endif
#ifdef EMISSIVE
varying vUVEmissive: vec2f;uniform emissiveMatrix: mat4x4f;
#endif
#ifdef VERTEXALPHA
attribute color: vec4f;varying vColor: vec4f;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#ifdef CUBEMAP
vertexOutputs.vPosition=worldPos;vertexOutputs.position=uniforms.viewProjection*finalWorld* vec4f(input.position,1.0);
#else
vertexOutputs.vPosition=uniforms.viewProjection*worldPos;vertexOutputs.position=vertexOutputs.vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef DIFFUSEUV2
vertexOutputs.vUVDiffuse= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef OPACITYUV2
vertexOutputs.vUVOpacity= (uniforms.opacityMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef EMISSIVEUV2
vertexOutputs.vUVEmissive= (uniforms.emissiveMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#endif
#ifdef VERTEXALPHA
vertexOutputs.vColor=color;
#endif
#include<clipPlaneVertex>
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},41903:function(e,t,i){i.r(t),i.d(t,{glowMapMergePixelShaderWGSL:function(){return a}});var r=i(29427);let s="glowMapMergePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#ifdef EMISSIVE
var textureSampler2Sampler: sampler;var textureSampler2: texture_2d<f32>;
#endif
uniform offset: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#ifdef EMISSIVE
baseColor+=textureSample(textureSampler2,textureSampler2Sampler,input.vUV);baseColor*=uniforms.offset;
#else
baseColor=vec4f(baseColor.rgb,abs(uniforms.offset-baseColor.a));
#ifdef STROKE
var alpha: f32=smoothstep(.0,.1,baseColor.a);baseColor=vec4f(baseColor.rgb*alpha,alpha);
#endif
#endif
#if LDR
baseColor=clamp(baseColor,0.,1.0);
#endif
fragmentOutputs.color=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},75356:function(e,t,i){i.r(t),i.d(t,{glowMapMergeVertexShaderWGSL:function(){return a}});var r=i(29427);let s="glowMapMergeVertexShader",n=`attribute position: vec2f;varying vUV: vec2f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},78562:function(e,t,i){i.r(t),i.d(t,{grainPixelShaderWGSL:function(){return a}});var r=i(29427);i(42766);let s="grainPixelShader",n=`#include<helperFunctions>
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform intensity: f32;uniform animatedSeed: f32;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);var seed: vec2f=input.vUV*uniforms.animatedSeed;var grain: f32=dither(seed,uniforms.intensity);var lum: f32=getLuminance(fragmentOutputs.color.rgb);var grainAmount: f32=(cos(-PI+(lum*PI*2.))+1.)/2.;fragmentOutputs.color=vec4f(fragmentOutputs.color.rgb+grain*grainAmount,fragmentOutputs.color.a);fragmentOutputs.color=vec4f(max(fragmentOutputs.color.rgb,vec3f(0.0)),fragmentOutputs.color.a);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},74988:function(e,t,i){i.r(t),i.d(t,{hdrFilteringPixelShaderWGSL:function(){return a}});var r=i(29427);i(42766),i(84147),i(41435),i(62456);let s="hdrFilteringPixelShader",n=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform alphaG: f32;var inputTextureSampler: sampler;var inputTexture: texture_cube<f32>;uniform vFilteringInfo: vec2f;uniform hdrScale: f32;varying direction: vec3f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=radiance(uniforms.alphaG,inputTexture,inputTextureSampler,input.direction,uniforms.vFilteringInfo);fragmentOutputs.color= vec4f(color*uniforms.hdrScale,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},54625:function(e,t,i){i.r(t),i.d(t,{hdrFilteringVertexShaderWGSL:function(){return a}});var r=i(29427);let s="hdrFilteringVertexShader",n=`attribute position: vec2f;varying direction: vec3f;uniform up: vec3f;uniform right: vec3f;uniform front: vec3f;
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var view: mat3x3f= mat3x3f(uniforms.up,uniforms.right,uniforms.front);vertexOutputs.direction=view*vec3f(input.position,1.0);vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},47837:function(e,t,i){i.r(t),i.d(t,{highlightsPixelShaderWGSL:function(){return a}});var r=i(29427);let s="highlightsPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;const RGBLuminanceCoefficients: vec3f= vec3f(0.2126,0.7152,0.0722);
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var tex: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var c: vec3f=tex.rgb;var luma: f32=dot(c.rgb,RGBLuminanceCoefficients);fragmentOutputs.color= vec4f(pow(c, vec3f(25.0-luma*15.0)),tex.a); }`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},44370:function(e,t,i){i.r(t),i.d(t,{iblCombineVoxelGridsPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblCombineVoxelGridsPixelShader",n=`varying vUV: vec2f;var voxelXaxisSamplerSampler: sampler;var voxelXaxisSampler: texture_3d<f32>;var voxelYaxisSamplerSampler: sampler;var voxelYaxisSampler: texture_3d<f32>;var voxelZaxisSamplerSampler: sampler;var voxelZaxisSampler: texture_3d<f32>;uniform layer: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coordZ: vec3f= vec3f(fragmentInputs.vUV.x,fragmentInputs.vUV.y,uniforms.layer);var voxelZ: f32=textureSample(voxelZaxisSampler,voxelZaxisSamplerSampler,coordZ).r;var coordX: vec3f= vec3f(1.0-uniforms.layer,fragmentInputs.vUV.y,fragmentInputs.vUV.x);var voxelX: f32=textureSample(voxelXaxisSampler,voxelXaxisSamplerSampler,coordX).r;var coordY: vec3f= vec3f(uniforms.layer,fragmentInputs.vUV.x,fragmentInputs.vUV.y);var voxelY: f32=textureSample(voxelYaxisSampler,voxelYaxisSamplerSampler,coordY).r;var voxel=select(0.0,1.0,(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0));fragmentOutputs.color= vec4f( vec3f(voxel),1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},57809:function(e,t,i){i.r(t),i.d(t,{iblGenerateVoxelMipPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblGenerateVoxelMipPixelShader",n=`varying vUV: vec2f;var srcMip: texture_3d<f32>;uniform layerNum: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var Coords=vec3i(2)*vec3i(vec2i(fragmentInputs.position.xy),uniforms.layerNum);var tex =
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,0),0).x>0.0f))
<< 0u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,0),0).x>0.0f))
<< 1u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,0),0).x>0.0f))
<< 2u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,0),0).x>0.0f))
<< 3u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,0,1),0).x>0.0f))
<< 4u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,0,1),0).x>0.0f))
<< 5u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(0,1,1),0).x>0.0f))
<< 6u) |
(u32(select(0u,1u,textureLoad(srcMip,Coords+vec3i(1,1,1),0).x>0.0f))
<< 7u);fragmentOutputs.color=vec4f( f32(tex)/255.0f,0.0f,0.0f,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},21419:function(e,t,i){i.r(t),i.d(t,{iblShadowAccumulationPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowAccumulationPixelShader",n=`varying vUV: vec2f;uniform accumulationParameters: vec4f;
#define remanence uniforms.accumulationParameters.x
#define resetb uniforms.accumulationParameters.y
var motionSampler: texture_2d<f32>; 
var localPositionSampler: texture_2d<f32>; 
var textureSampler: texture_2d<f32>; 
var oldAccumulationSamplerSampler: sampler;var oldAccumulationSampler: texture_2d<f32>; 
var prevLocalPositionSamplerSampler: sampler;var prevLocalPositionSampler: texture_2d<f32>; 
fn max2(v: vec2f,w: vec2f)->vec2f { 
return vec2f(max(v.x,w.x),max(v.y,w.y)); }
fn lessThan(x: vec2f,y: vec2f)->vec2<bool> {return x<y;}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var reset: bool= bool(resetb);var Resolution: vec2f= vec2f(textureDimensions(textureSampler,0));var currentPixel: vec2i= vec2i(input.vUV*Resolution);var LP: vec4f=textureLoad(localPositionSampler,currentPixel,0);if (0.0==LP.w) {fragmentOutputs.color=vec4f(1.0,0.0,0.0,1.0);return fragmentOutputs;}
var velocityColor: vec2f=textureLoad(motionSampler,currentPixel,0).xy;var prevCoord: vec2f=input.vUV+velocityColor;var PrevLP: vec3f=textureSampleLevel(prevLocalPositionSampler,prevLocalPositionSamplerSampler,prevCoord,0.0).xyz;var PrevShadows: vec2f=textureSampleLevel(oldAccumulationSampler,oldAccumulationSamplerSampler,prevCoord,0.0).xy;var newShadows: f32=textureLoad(textureSampler,currentPixel,0).x;PrevShadows.y=select(1.0,max(PrevShadows.y/(1.0+PrevShadows.y),1.0-remanence),!reset && all(lessThan(abs(prevCoord- vec2f(0.5)), vec2f(0.5))) &&
distance(LP.xyz,PrevLP)<5e-2);PrevShadows=max( vec2f(0.0),PrevShadows);fragmentOutputs.color= vec4f(mix(PrevShadows.x,newShadows,PrevShadows.y),
PrevShadows.y,0,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},58876:function(e,t,i){i.r(t),i.d(t,{iblShadowDebugPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowDebugPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var debugSamplerSampler: sampler;var debugSampler: texture_2d<f32>;uniform sizeParams: vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =
vec2f((offsetX+fragmentInputs.vUV.x)*widthScale,(offsetY+fragmentInputs.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV);var debugColour: vec4f=textureSample(debugSampler,debugSamplerSampler,fragmentInputs.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {fragmentOutputs.color=vec4f(mix(debugColour.rgb,background.rgb,0.0),1.0);}}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},67662:function(e,t,i){i.r(t),i.d(t,{iblShadowGBufferDebugPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowGBufferDebugPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var prePass_NdcDepthSampler: sampler;var prePass_NdcDepth: texture_2d<f32>;var prePass_WorldNormalSampler: sampler;var prePass_WorldNormal: texture_2d<f32>;var prePass_PositionSampler: sampler;var prePass_Position: texture_2d<f32>;var prePass_LocalPositionSampler: sampler;var prePass_LocalPosition: texture_2d<f32>;var prePass_VelocityLinearSampler: sampler;var prePass_VelocityLinear: texture_2d<f32>;uniform sizeParams: vec4f;uniform maxDepth: f32;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =
vec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var backgroundColour: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgba;var depth: vec4f=textureSample(prePass_NdcDepth,prePass_NdcDepthSampler,input.vUV);var worldNormal: vec4f=textureSample(prePass_WorldNormal,prePass_WorldNormalSampler,input.vUV);var worldPosition: vec4f=textureSample(prePass_Position,prePass_PositionSampler,input.vUV);var localPosition: vec4f=textureSample(prePass_LocalPosition,prePass_LocalPositionSampler,input.vUV);var velocityLinear: vec4f=textureSample(prePass_VelocityLinear,prePass_VelocityLinearSampler,input.vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=backgroundColour;} else {if (uv.x<=0.2) { 
fragmentOutputs.color=vec4f(depth.rgb,1.0);} else if (uv.x<=0.4) {velocityLinear=vec4f(velocityLinear.r*0.5+0.5,velocityLinear.g*0.5+0.5,velocityLinear.b,velocityLinear.a);fragmentOutputs.color=vec4f(velocityLinear.rgb,1.0);} else if (uv.x<=0.6) {fragmentOutputs.color=vec4f(worldPosition.rgb,1.0);} else if (uv.x<=0.8) {fragmentOutputs.color=vec4f(localPosition.rgb,1.0);} else {fragmentOutputs.color=vec4f(worldNormal.rgb,1.0);}}}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},81140:function(e,t,i){i.r(t),i.d(t,{iblShadowSpatialBlurPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowSpatialBlurPixelShader",n=`#define PI 3.1415927
varying vUV: vec2f;var linearDepthSampler: texture_2d<f32>;var worldNormalSampler: texture_2d<f32>;var textureSampler: texture_2d<f32>;uniform blurParameters: vec4f;
#define stridef uniforms.blurParameters.x
#define worldScale uniforms.blurParameters.y
const weights=array<f32,5>(0.0625,0.25,0.375,0.25,0.0625);const nbWeights: i32=5;fn max2(v: vec2f,w: vec2f)->vec2f {return vec2f(max(v.x,w.x),max(v.y,w.y));}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var Resolution=vec2f(textureDimensions(linearDepthSampler,0));var PixelCoord= vec2i(fragmentInputs.vUV*Resolution);var N: vec3f=textureLoad(worldNormalSampler,PixelCoord,0).xyz;if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}
var depth: f32=-textureLoad(linearDepthSampler,PixelCoord,0).x;var X: vec2f= vec2f(0.0);for(var y: i32=0; y<nbWeights; y++) {for(var x: i32=0; x<nbWeights; x++) {var Coords: vec2i=PixelCoord+i32(stridef)*vec2i(x-(nbWeights>>1),y-(nbWeights>>1));var T: vec2f=textureLoad(textureSampler,Coords,0).xy;var ddepth: f32=-textureLoad(linearDepthSampler,Coords,0).x-depth;var dN: vec3f=textureLoad(worldNormalSampler,Coords,0).xyz-N;var w: f32=weights[x]*weights[y] *
exp2(max(-1000.0/(worldScale*worldScale),-0.5) *
(ddepth*ddepth) -
1e1*dot(dN,dN));X+= vec2f(w*T.x,w);}}
fragmentOutputs.color= vec4f(X.x/X.y,1.0,0.0,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},5901:function(e,t,i){i.r(t),i.d(t,{iblShadowVoxelTracingPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowVoxelTracingPixelShader",n=`#define PI 3.1415927
varying vUV: vec2f;
#define DISABLE_UNIFORMITY_ANALYSIS
var depthSampler: texture_2d<f32>;var worldNormalSampler: texture_2d<f32>;var worldPositionSampler: texture_2d<f32>;var blueNoiseSampler: texture_2d<f32>;var icdfxSamplerSampler: sampler;var icdfxSampler: texture_2d<f32>;var icdfySamplerSampler: sampler;var icdfySampler: texture_2d<f32>;var voxelGridSamplerSampler: sampler;var voxelGridSampler: texture_3d<f32>;uniform shadowParameters: vec4f;
#define SHADOWdirs uniforms.shadowParameters.x
#define SHADOWframe uniforms.shadowParameters.y
#define SHADOWdownscale uniforms.shadowParameters.z
#define SHADOWenvRot uniforms.shadowParameters.w
uniform offsetDataParameters: vec4f;
#define PixelOffset uniforms.offsetDataParameters.xy
#define highestMipLevel uniforms.offsetDataParameters.z
uniform sssParameters: vec4f;
#define SSSsamples uniforms.sssParameters.x
#define SSSstride uniforms.sssParameters.y
#define SSSmaxDistance uniforms.sssParameters.z
#define SSSthickness uniforms.sssParameters.w
uniform shadowOpacity: vec4f;uniform projMtx: mat4x4f;uniform viewMtx: mat4x4f;uniform invProjMtx: mat4x4f;uniform invViewMtx: mat4x4f;uniform wsNormalizationMtx: mat4x4f;uniform invVPMtx: mat4x4f;
#define PI 3.1415927
#define GOLD 0.618034
struct AABB3f {m_min: vec3f,
m_max: vec3f,};struct Ray {orig: vec3f,
dir: vec3f,
dir_rcp: vec3f,
t_min: f32,
t_max: f32,};fn make_ray(origin: vec3f,direction: vec3f,tmin: f32,
tmax: f32)->Ray {var ray: Ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}
fn ray_box_intersection(aabb: AABB3f,ray: Ray ,
distance_near: ptr<function,f32>,distance_far: ptr<function,f32>)->bool{var tbot: vec3f=ray.dir_rcp*(aabb.m_min-ray.orig);var ttop: vec3f=ray.dir_rcp*(aabb.m_max-ray.orig);var tmin: vec3f=min(ttop,tbot);var tmax: vec3f=max(ttop,tbot);*distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));*distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return *distance_near<=*distance_far;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
struct VoxelMarchDiagnosticInfo {heat: f32,
voxel_intersect_coords: vec3i,};
#endif
fn hash(i: u32)->u32 {var temp=i ^ (i>>16u);temp*=0x7FEB352Du;temp ^= temp>>15u;temp*=0x846CA68Bu;temp ^= temp>>16u;return temp;}
fn uintBitsToFloat(x: u32)->f32 {return bitcast<f32>(x);}
fn uint2float(i: u32)->f32 {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}
fn uv_to_normal(uv: vec2f)->vec3f {var N: vec3f;var uvRange: vec2f=uv;var theta: f32=uvRange.x*2.0*PI;var phi: f32=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
fn plasticSequence(rstate: u32)->vec2f {return vec2f(uint2float(rstate*3242174889u),
uint2float(rstate*2447445414u));}
fn goldenSequence(rstate: u32)->f32 {return uint2float(rstate*2654435769u);}
fn distanceSquared(a: vec2f,b: vec2f)->f32 {var diff: vec2f=a-b;return dot(diff,diff);}
fn genTB(N: vec3f,T: ptr<function,vec3f>,B: ptr<function,vec3f>) {var s: f32=select(1.0,-1.0,N.z<0.0);var a: f32=-1.0/(s+N.z);var b: f32=N.x*N.y*a;*T= vec3f(1.0+s*N.x*N.x*a,s*b,-s*N.x);*B= vec3f(b,s+N.y*N.y*a,-N.y);}
fn lessThan(x: vec3f,y: vec3f)->vec3<bool> {return x<y;}
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fn anyHitVoxels(ray_vs: Ray,
voxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->bool {
#else
fn anyHitVoxels(ray_vs: Ray)->bool {
#endif
var stack=array<i32,24>(); 
var invD: vec3f=ray_vs.dir_rcp;var D: vec3f=ray_vs.dir;var O: vec3f=ray_vs.orig;var negD=vec3i(lessThan(D, vec3f(0,0,0)));var voxel0: i32=negD.x | (negD.y<<1) | (negD.z<<2);var t0: vec3f=-O*invD;var t1=(vec3f(1.0)-O)*invD;var maxLod: i32= i32(highestMipLevel);var stackLevel: i32=0;
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
var steps: u32=0u;
#endif
stack[stackLevel]=maxLod<<24;stackLevel++;while (stackLevel>0) {stackLevel=stackLevel-1;var elem: i32=stack[stackLevel];var Coords: vec4i =
vec4i(elem & 0xFF,(elem>>8) & 0xFF,(elem>>16) & 0xFF,elem>>24);if (Coords.w==0) {
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
*voxel_march_diagnostic_info.heat= f32(steps)/24.0;
#endif
return true;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
++steps;
#endif
var invRes: f32=exp2(f32(Coords.w-maxLod));var bbmin: vec3f=invRes*vec3f(Coords.xyz+negD);var bbmax: vec3f=invRes*vec3f(Coords.xyz-negD+vec3i(1));var mint: vec3f=mix(t0,t1,bbmin);var maxt: vec3f=mix(t0,t1,bbmax);var midt: vec3f=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);var nodeMask: u32= u32(
round(textureLoad(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;var voxelBit: u32=u32(voxel0);Coords=vec4i((Coords.xyz<<vec3u(1))+negD,Coords.w);var packedCoords: i32 =
Coords.x | (Coords.y<<8) | (Coords.z<<16) | (Coords.w<<24);if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}
voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&
((1u<<voxelBit) & nodeMask) != 0) {stack[stackLevel]=packedCoords;stackLevel++;}}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
*voxel_march_diagnostic_info.heat= f32(steps)/24.0;
#endif
return false;}
fn screenSpaceShadow(csOrigin: vec3f,csDirection: vec3f,csZBufferSize: vec2f,
nearPlaneZ: f32,noise: f32)->f32 {var csZDir: f32=select(-1.0,1.0,uniforms.projMtx[2][2]>0.0);var ssSamples: f32=SSSsamples;var ssMaxDist: f32=SSSmaxDistance;var ssStride: f32=SSSstride;var ssThickness: f32=SSSthickness;var rayLength: f32 =
select(ssMaxDist,(nearPlaneZ-csOrigin.z)/csDirection.z,
csZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ);var csEndPoint: vec3f=csOrigin+rayLength*csDirection;var H0: vec4f=uniforms.projMtx* vec4f(csOrigin,1.0);var H1: vec4f=uniforms.projMtx* vec4f(csEndPoint,1.0);
#ifndef IS_NDC_HALF_ZRANGE
var Z0=(0.5*H0.z/H0.w+0.5);var Z1=(0.5*H1.z/H1.w+0.5);
#else
var Z0=(H0.z/H0.w);var Z1=(H1.z/H1.w);
#endif
var P0=csZBufferSize*(0.5*H0.xy/H0.w+0.5);var P1=csZBufferSize*(0.5*H1.xy/H1.w+0.5);P1+= vec2f(select(0.0,0.01,distanceSquared(P0,P1)<0.0001));var delta: vec2f=P1-P0;var permute: bool=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}
var stepDirection: f32=sign(delta.x);var invdx: f32=stepDirection/delta.x;var dP: vec2f=ssStride* vec2f(stepDirection,invdx*delta.y);var dZ=ssStride*invdx*(Z1-Z0);var opacity: f32=0.0;var P: vec2f=P0+noise*dP;var Z=Z0+noise*dZ;var end: f32=P1.x*stepDirection;Z+=dZ;for (var stepCount: f32=0.0; 
opacity<1.0 && P.x*stepDirection<end && stepCount<ssSamples;stepCount+=1) { 
var coords=vec2i(select(P,P.yx,permute));var sceneDepth=textureLoad(depthSampler,coords,0).x;var thicknessScale=pow(1.0-sceneDepth,1.6);opacity +=
max(opacity,step(Z+dZ,sceneDepth+thicknessScale*ssThickness) *
step(sceneDepth,Z));P+=dP;Z+=dZ;}
return opacity;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,
DitherNoise: vec2f,
voxel_march_diagnostic_info: ptr<function,VoxelMarchDiagnosticInfo>)->f32 {
#else
fn voxelShadow(wsOrigin: vec3f,wsDirection: vec3f,wsNormal: vec3f,
DitherNoise: vec2f)->f32 {
#endif
var vxResolution: f32=f32(textureDimensions(voxelGridSampler,0).x);var T: vec3f;var B: vec3f;genTB(wsDirection,&T,&B);var DitherXY: vec2f=sqrt(DitherNoise.x)* vec2f(cos(2.0*PI*DitherNoise.y),
sin(2.0*PI*DitherNoise.y));var Dithering: vec3f =
(2.0*wsNormal+3.0*wsDirection+DitherXY.x*T+DitherXY.y*B) /
vxResolution;var O: vec3f=0.5*wsOrigin+0.5+Dithering;var ray_vs=make_ray(O,wsDirection,0.0,10.0);var voxel_aabb: AABB3f;voxel_aabb.m_min=vec3f(0);voxel_aabb.m_max=vec3f(1);var near: f32=0;var far: f32=0;if (!ray_box_intersection(voxel_aabb,ray_vs,&near,&far)) {return 0.0;}
ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
return select(0.0f,1.0f,anyHitVoxels(ray_vs,voxel_march_diagnostic_info));
#else
return select(0.0f,1.0f,anyHitVoxels(ray_vs));
#endif
}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var nbDirs=u32(SHADOWdirs);var frameId=u32(SHADOWframe);var downscale=i32(SHADOWdownscale);var envRot: f32=SHADOWenvRot;var Resolution: vec2f= vec2f(textureDimensions(depthSampler,0));var currentPixel=vec2i(fragmentInputs.vUV*Resolution);var PixelCoord=vec2i(vec2f(currentPixel*downscale)+PixelOffset.xy);var GlobalIndex =
(frameId*u32(Resolution.y)+u32(PixelCoord.y))*u32(Resolution.x) +
u32(PixelCoord.x);var N: vec3f=textureLoad(worldNormalSampler,PixelCoord,0).xyz;N=N* vec3f(2.0)-vec3f(1.0);if (length(N)<0.01) {fragmentOutputs.color=vec4f(1.0,1.0,0.0,1.0);return fragmentOutputs;}
var normalizedRotation: f32=envRot/(2.0*PI);var depth: f32=textureLoad(depthSampler,PixelCoord,0).x;
#ifndef IS_NDC_HALF_ZRANGE
depth=depth*2.0-1.0;
#endif
var temp: vec2f=(vec2f(PixelCoord)+vec2f(0.5))*2.0/Resolution-vec2f(1.0);var temp2: vec2f=fragmentInputs.vUV*vec2f(2.0)-vec2f(1.0);var VP: vec4f=uniforms.invProjMtx*vec4f(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);var noise: vec3f=textureLoad(blueNoiseSampler,PixelCoord & vec2i(0xFF),0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
var heat: f32=0.0f;
#endif
var shadowAccum: f32=0.0;for (var i: u32=0; i<nbDirs; i++) {var dirId: u32=nbDirs*GlobalIndex+i;var L: vec4f;{var r: vec2f=plasticSequence(frameId*nbDirs+i);r=fract(r+ vec2f(2.0)*abs(noise.xy- vec2f(0.5)));var T: vec2f;T.x=textureSampleLevel(icdfxSampler,icdfxSamplerSampler,vec2f(r.x,0.0),0.0).x;T.y=textureSampleLevel(icdfySampler,icdfySamplerSampler,vec2f(T.x,r.y),0.0).x;T.x-=normalizedRotation;L= vec4f(uv_to_normal(T),0);}
var edge_tint_const=-0.001;var cosNL: f32=dot(N,L.xyz);var opacity: f32=select(0.0,1.0,cosNL<edge_tint_const);if (cosNL>edge_tint_const) {var VP2: vec4f=VP;VP2.y*=-1.0;var unormWP: vec4f=uniforms.invViewMtx*VP2;var WP: vec3f=(uniforms.wsNormalizationMtx*unormWP).xyz;var vxNoise: vec2f =
vec2f(uint2float(hash(dirId*2)),uint2float(hash(dirId*2+1)));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
VoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,
uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,
voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;
#else
opacity =
max(opacity,uniforms.shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));
#endif
var VL: vec3f=(uniforms.viewMtx*L).xyz;var nearPlaneZ: f32 =
-uniforms.projMtx[3][2]/uniforms.projMtx[2][2]; 
var ssShadow: f32=uniforms.shadowOpacity.y *
screenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,
abs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);shadowAccum+=min(1.0-opacity,smoothstep(-0.1,0.2,cosNL));} else {shadowAccum+=min(1.0-opacity,smoothstep(-0.1,0.2,cosNL));}
noise.z=fract(noise.z+GOLD);}
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
fragmentOutputs.color =
vec4f(shadowAccum/ f32(nbDirs),heat/ f32(nbDirs),0.0,1.0);
#else
fragmentOutputs.color= vec4f(shadowAccum/ f32(nbDirs),0.0,0.0,1.0);
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},17434:function(e,t,i){i.r(t),i.d(t,{iblShadowsCdfxPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowsCdfxPixelShader",n=`#define PI 3.1415927
varying vUV: vec2f;var cdfy: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var cdfyRes=textureDimensions(cdfy,0);var currentPixel=vec2u(fragmentInputs.position.xy);var cdfx: f32=0.0;for (var x: u32=1; x<=currentPixel.x; x++) {cdfx+=textureLoad(cdfy, vec2u(x-1,cdfyRes.y-1),0).x;}
fragmentOutputs.color= vec4f( vec3f(cdfx),1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},94012:function(e,t,i){i.r(t),i.d(t,{iblShadowsCdfyPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowsCdfyPixelShader",n=`#define PI 3.1415927
varying vUV: vec2f;
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
uniform iblHeight: i32;
#ifdef IBL_USE_CUBE_MAP
fn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
fn fetchCube(uv: vec2f)->f32 {var direction: vec3f=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb,
vec3f(0.3,0.6,0.1));}
#else
fn fetchPanoramic(Coords: vec2i,envmapHeight: f32)->f32 {return sin(PI*( f32(Coords.y)+0.5)/envmapHeight) *
dot(textureLoad(iblSource,Coords,0).rgb, vec3f(0.3,0.6,0.1));}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var coords: vec2i= vec2i(fragmentInputs.position.xy);var cdfy: f32=0.0;for (var y: i32=1; y<=coords.y; y++) {
#ifdef IBL_USE_CUBE_MAP
var uv: vec2f= vec2f(input.vUV.x,( f32(y-1)+0.5)/ f32(uniforms.iblHeight));cdfy+=fetchCube(uv);
#else
cdfy+=fetchPanoramic( vec2i(coords.x,y-1), f32(uniforms.iblHeight));
#endif
}
fragmentOutputs.color= vec4f(cdfy,0.0,0.0,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},71493:function(e,t,i){i.r(t),i.d(t,{iblShadowsCombinePixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowsCombinePixelShader",n=`varying vUV: vec2f;var sceneTextureSampler: sampler;var sceneTexture: texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform shadowOpacity: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var color: vec3f=textureSample(sceneTexture,sceneTextureSampler,input.vUV).rgb;var shadow: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var shadowValue: f32=mix(1.0,shadow.x,uniforms.shadowOpacity);fragmentOutputs.color=vec4f(color*shadowValue,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},58742:function(e,t,i){i.r(t),i.d(t,{iblShadowsIcdfxPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowsIcdfxPixelShader",n=`#define PI 3.1415927
varying vUV: vec2f;var cdfx: texture_2d<f32>;fn fetchCDF(x: u32)->f32 {return textureLoad(cdfx, vec2u(x,0),0).x;}
fn bisect(size: u32,targetValue: f32)->f32
{var a: u32=0;var b=size-1;while (b-a>1) {var c: u32=(a+b)>>1;if (fetchCDF(c)<targetValue) {a=c;}
else {b=c;}}
return mix( f32(a), f32(b),(targetValue-fetchCDF(a))/(fetchCDF(b)-fetchCDF(a)))/ f32(size-1);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var cdfSize: vec2u=textureDimensions(cdfx,0);var cdfWidth: u32=cdfSize.x;var icdfWidth: u32=cdfWidth-1;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);if (currentPixel.x==0)
{fragmentOutputs.color= vec4f(0.0);}
else if (currentPixel.x==icdfWidth-1) {fragmentOutputs.color= vec4f(1.0);} else {var targetValue: f32=fetchCDF(cdfWidth-1)*input.vUV.x;fragmentOutputs.color= vec4f( vec3f(bisect(cdfWidth,targetValue)),1.0);}}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},90893:function(e,t,i){i.r(t),i.d(t,{iblShadowsIcdfyPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowsIcdfyPixelShader",n=`#define PI 3.1415927
varying vUV: vec2f;var cdfy: texture_2d<f32>;fn fetchCDF(y: u32,invocationId: u32)->f32 {return textureLoad(cdfy, vec2u(invocationId,y),0).x;}
fn bisect(size: u32,targetValue: f32,invocationId: u32)->f32
{var a: u32=0;var b=size-1;while (b-a>1) {var c=(a+b)>>1;if (fetchCDF(c,invocationId)<targetValue) {a=c;}
else {b=c;}}
return mix( f32(a), f32(b),(targetValue-fetchCDF(a,invocationId))/(fetchCDF(b,invocationId)-fetchCDF(a,invocationId)))/ f32(size-1);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var cdfSize: vec2u=textureDimensions(cdfy,0);var cdfHeight: u32=cdfSize.y;var currentPixel: vec2u= vec2u(fragmentInputs.position.xy);if (currentPixel.y==0) {fragmentOutputs.color= vec4f(0.0);}
else if (currentPixel.y==cdfHeight-2) {fragmentOutputs.color= vec4f(1.0);} else {var targetValue: f32=fetchCDF(cdfHeight-1,currentPixel.x)*input.vUV.y;fragmentOutputs.color= vec4f( vec3f(bisect(cdfHeight,targetValue,currentPixel.x)),1.0);}}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},83750:function(e,t,i){i.r(t),i.d(t,{iblShadowsImportanceSamplingDebugPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblShadowsImportanceSamplingDebugPixelShader",n=`#define PI 3.1415927
varying vUV: vec2f;var cdfySampler: sampler;var cdfy: texture_2d<f32>;var icdfySampler: sampler;var icdfy: texture_2d<f32>;var cdfxSampler: sampler;var cdfx: texture_2d<f32>;var icdfxSampler: sampler;var icdfx: texture_2d<f32>;
#ifdef IBL_USE_CUBE_MAP
var iblSourceSampler: sampler;var iblSource: texture_cube<f32>;
#else
var iblSourceSampler: sampler;var iblSource: texture_2d<f32>;
#endif
var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#define cdfyVSize 0.4
#define cdfxVSize 0.1
#define cdfyHSize 0.5
uniform sizeParams: vec4f;
#ifdef IBL_USE_CUBE_MAP
fn equirectangularToCubemapDirection(uv: vec2f)->vec3f {var longitude: f32=uv.x*2.0*PI-PI;var latitude: f32=PI*0.5-uv.y*PI;var direction: vec3f;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs { 
var colour: vec3f= vec3f(0.0);var uv: vec2f =
vec2f((uniforms.sizeParams.x+input.vUV.x)*uniforms.sizeParams.z,(uniforms.sizeParams.y+input.vUV.y)*uniforms.sizeParams.w);var backgroundColour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;const iblStart: f32=1.0-cdfyVSize;const cdfyStart: f32=1.0-2.0*cdfyVSize;const cdfxStart: f32=1.0-2.0*cdfyVSize-cdfxVSize;const icdfxStart: f32=1.0-2.0*cdfyVSize-2.0*cdfxVSize;
#ifdef IBL_USE_CUBE_MAP
var direction: vec3f=equirectangularToCubemapDirection(
(uv- vec2f(0.0,iblStart))* vec2f(1.0,1.0/cdfyVSize));var iblColour: vec3f=textureSampleLevel(iblSource,iblSourceSampler,direction,0.0).rgb;
#else
var iblColour: vec3f=textureSample(iblSource,iblSourceSampler,(uv- vec2f(0.0,iblStart)) *
vec2f(1.0,1.0/cdfyVSize))
.rgb;
#endif
var cdfyColour: f32 =
textureSample(cdfy,cdfySampler,(uv- vec2f(0.0,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var icdfyColour: f32 =
textureSample(icdfy,icdfySampler,(uv- vec2f(0.5,cdfyStart))* vec2f(2.0,1.0/cdfyVSize)).r;var cdfxColour: f32 =
textureSample(cdfx,cdfxSampler,(uv- vec2f(0.0,cdfxStart))* vec2f(1.0,1.0/cdfxVSize)).r;var icdfxColour: f32=textureSample(icdfx,icdfxSampler,(uv- vec2f(0.0,icdfxStart)) *
vec2f(1.0,1.0/cdfxVSize)).r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=0.003*cdfyColour;} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=0.00003*cdfxColour;} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}
fragmentOutputs.color =vec4(mix(colour,backgroundColour,0.5),1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},2338:function(e,t,i){i.r(t),i.d(t,{iblVoxelGridPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblVoxelGridPixelShader",n=`varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;if (normPos.z<uniforms.nearPlane || normPos.z>uniforms.farPlane) {discard;}
fragmentOutputs.fragData0=select(vec4f(0.0),vec4f(1.0),normPos.z<uniforms.nearPlane+uniforms.stepSize);fragmentOutputs.fragData1=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+uniforms.stepSize && normPos.z<uniforms.nearPlane+2.0*uniforms.stepSize);fragmentOutputs.fragData2=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+2.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+3.0*uniforms.stepSize);fragmentOutputs.fragData3=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+3.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+4.0*uniforms.stepSize);
#if MAX_DRAW_BUFFERS>4
fragmentOutputs.fragData4=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+4.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+5.0*uniforms.stepSize);fragmentOutputs.fragData5=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+5.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+6.0*uniforms.stepSize);fragmentOutputs.fragData6=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+6.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+7.0*uniforms.stepSize);fragmentOutputs.fragData7=select(vec4f(0.0),vec4f(1.0),normPos.z>=uniforms.nearPlane+7.0*uniforms.stepSize && normPos.z<uniforms.nearPlane+8.0*uniforms.stepSize);
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},66586:function(e,t,i){i.r(t),i.d(t,{iblVoxelGridVertexShaderWGSL:function(){return a}});var r=i(29427);let s="iblVoxelGridVertexShader",n=`attribute position: vec3f;attribute normal: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform viewMatrix: mat4x4f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.viewMatrix*uniforms.invWorldScale*uniforms.world* vec4f(input.position,1.);vertexOutputs.vNormalizedPosition=vertexOutputs.position.xyz*0.5+0.5;
#ifdef IS_NDC_HALF_ZRANGE
vertexOutputs.position=vec4f(vertexOutputs.position.x,vertexOutputs.position.y,vertexOutputs.position.z*0.5+0.5,vertexOutputs.position.w);
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},69481:function(e,t,i){i.r(t),i.d(t,{iblVoxelGrid2dArrayDebugPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblVoxelGrid2dArrayDebugPixelShader",n=`varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform slice: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var size: vec3u=textureDimensions(voxelTexture,0);var dimension: f32=sqrt( f32(size.z));var samplePos: vec2f=fract(input.vUV.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(input.vUV.x* f32(dimension))+floor(input.vUV.y* f32(dimension))*dimension);var color=textureSample(voxelTexture,voxelTextureSampler, vec3f(samplePos.xy,sampleIndex)).rrr;color+=textureSample(textureSampler,textureSamplerSampler,input.vUV.xy).rgb;fragmentOutputs.color=vec4f(color,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},34873:function(e,t,i){i.r(t),i.d(t,{iblVoxelGrid3dDebugPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblVoxelGrid3dDebugPixelShader",n=`varying vUV: vec2f;var voxelTextureSampler: sampler;var voxelTexture: texture_3d<f32>;var voxelSlabTextureSampler: sampler;var voxelSlabTexture: texture_2d<f32>;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform sizeParams: vec4f;
#define offsetX uniforms.sizeParams.x
#define offsetY uniforms.sizeParams.y
#define widthScale uniforms.sizeParams.z
#define heightScale uniforms.sizeParams.w
uniform mipNumber: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f =
vec2f((offsetX+input.vUV.x)*widthScale,(offsetY+input.vUV.y)*heightScale);var background: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var voxelSlab: vec4f=textureSample(voxelSlabTexture,voxelSlabTextureSampler,input.vUV);var size: vec3u=textureDimensions(voxelTexture, i32(uniforms.mipNumber));var dimension: f32=ceil(sqrt( f32(size.z)));var samplePos: vec2f=fract(uv.xy* vec2f(dimension));var sampleIndex: u32= u32(floor(uv.x* f32(dimension)) +
floor(uv.y* f32(dimension))*dimension);var mip_separator: f32=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}
var outBounds: bool=select(false,true,sampleIndex>size.z-1);sampleIndex=clamp(sampleIndex,0,size.z-1);var samplePosInt: vec2i= vec2i(samplePos.xy* vec2f(size.xy));var voxel: vec3f=textureLoad(voxelTexture,
vec3i(i32(samplePosInt.x),i32(samplePosInt.y),i32(sampleIndex)),
i32(uniforms.mipNumber)).rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {fragmentOutputs.color=background;} else {if (outBounds) {voxel= vec3f(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}
voxel.r+=mip_separator;}
fragmentOutputs.color=vec4f(mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel,1.0);}}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},32715:function(e,t,i){i.r(t),i.d(t,{iblVoxelSlabDebugPixelShaderWGSL:function(){return a}});var r=i(29427);let s="iblVoxelSlabDebugPixelShader",n=`varying vNormalizedPosition: vec3f;uniform nearPlane: f32;uniform farPlane: f32;uniform stepSize: f32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var normPos: vec3f=input.vNormalizedPosition.xyz;var chunkSize: f32=uniforms.stepSize* f32(MAX_DRAW_BUFFERS);var numChunks: f32=1.0/chunkSize;var positionInChunk: f32=fract(normPos.z/chunkSize);var slab: f32=floor(positionInChunk* f32(MAX_DRAW_BUFFERS)) /
f32(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||
normPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {fragmentOutputs.color= vec4f(0.0,0.0,0.0,0.0);} else {fragmentOutputs.color= vec4f(slab,0.0,0.0,0.75);}}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},89970:function(e,t,i){i.r(t),i.d(t,{iblVoxelSlabDebugVertexShaderWGSL:function(){return a}});var r=i(29427);let s="iblVoxelSlabDebugVertexShader",n=`attribute position: vec3f;varying vNormalizedPosition: vec3f;uniform world: mat4x4f;uniform invWorldScale: mat4x4f;uniform cameraViewMatrix: mat4x4f;uniform projection: mat4x4f;uniform viewMatrix: mat4x4f;@vertex
fn main(input : VertexInputs)->FragmentInputs {var worldPosition: vec4f=(uniforms.world* vec4f(input.position,1.));vertexOutputs.position=uniforms.projection*uniforms.cameraViewMatrix*worldPosition;vertexOutputs.vNormalizedPosition=(uniforms.viewMatrix*uniforms.invWorldScale*worldPosition).rgb;vertexOutputs.vNormalizedPosition=vertexOutputs.vNormalizedPosition* vec3f(0.5)+ vec3f(0.5);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},60224:function(e,t,i){i.r(t),i.d(t,{imageProcessingPixelShaderWGSL:function(){return a}});var r=i(29427);i(16693),i(42766),i(31103);let s="imageProcessingPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var result: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result=vec4f(toLinearSpaceVec3(result.rgb),result.a);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
fragmentOutputs.color=result;}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},74669:function(e,t,i){i.r(t),i.d(t,{kernelBlurPixelShaderWGSL:function(){return l}});var r=i(29427);i(84715),i(758);let s=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCoord{X})*computedWeight;
#endif
`;r.v.IncludesShadersStoreWGSL.kernelBlurFragment=s;let n=`#ifdef DOF
factor=sampleCoC(fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.sampleCenter+uniforms.delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;r.v.IncludesShadersStoreWGSL.kernelBlurFragment2=n;let a="kernelBlurPixelShader",o=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform delta: vec2f;varying sampleCenter: vec2f;
#ifdef DOF
var circleOfConfusionSamplerSampler: sampler;var circleOfConfusionSampler: texture_2d<f32>;fn sampleCoC(offset: vec2f)->f32 {var coc: f32=textureSample(circleOfConfusionSampler,circleOfConfusionSamplerSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var computedWeight: f32=0.0;
#ifdef PACKEDFLOAT
var blend: f32=0.;
#else
var blend: vec4f= vec4f(0.);
#endif
#ifdef DOF
var sumOfWeights: f32=CENTER_WEIGHT; 
var factor: f32=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(textureSample(textureSampler,textureSamplerSampler,input.sampleCenter))*CENTER_WEIGHT;
#else
blend+=textureSample(textureSampler,textureSamplerSampler,input.sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
fragmentOutputs.color=pack(blend);
#else
fragmentOutputs.color=blend;
#endif
#ifdef DOF
fragmentOutputs.color/=sumOfWeights;
#endif
}`;r.v.ShadersStoreWGSL[a]=o;let l={name:a,shader:o}},25250:function(e,t,i){i.r(t),i.d(t,{kernelBlurVertexShaderWGSL:function(){return a}});var r=i(29427);i(84715),r.v.IncludesShadersStoreWGSL.kernelBlurVertex="vertexOutputs.sampleCoord{X}=vertexOutputs.sampleCenter+uniforms.delta*KERNEL_OFFSET{X};";let s="kernelBlurVertexShader",n=`attribute position: vec2f;uniform delta: vec2f;varying sampleCenter: vec2f;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.sampleCenter=(input.position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},48407:function(e,t,i){i.r(t),i.d(t,{layerPixelShaderWGSL:function(){return a}});var r=i(29427);i(42766);let s="layerPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#ifdef LINEAR
baseColor=vec4f(toGammaSpace(baseColor.rgb),baseColor.a);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
fragmentOutputs.color=baseColor*uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},75439:function(e,t,i){i.r(t),i.d(t,{layerVertexShaderWGSL:function(){return a}});var r=i(29427);let s="layerVertexShader",n=`attribute position: vec2f;uniform scale: vec2f;uniform offset: vec2f;uniform textureMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var shiftedPosition: vec2f=input.position*uniforms.scale+uniforms.offset;vertexOutputs.vUV=(uniforms.textureMatrix* vec4f(shiftedPosition*madd+madd,1.0,0.0)).xy;vertexOutputs.position= vec4f(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},76673:function(e,t,i){i.r(t),i.d(t,{lensFlarePixelShaderWGSL:function(){return a}});var r=i(29427);let s="lensFlarePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform color: vec4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var baseColor: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);fragmentOutputs.color=baseColor*uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},15744:function(e,t,i){i.r(t),i.d(t,{lensFlareVertexShaderWGSL:function(){return a}});var r=i(29427);let s="lensFlareVertexShader",n=`attribute position: vec2f;uniform viewportMatrix: mat4x4f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position=uniforms.viewportMatrix* vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},89298:function(e,t,i){i.r(t),i.d(t,{linePixelShaderWGSL:function(){return a}});var r=i(29427);i(71030),i(50973),i(92907),i(24228);let s="linePixelShader",n=`#include<clipPlaneFragmentDeclaration>
uniform color: vec4f;
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<logDepthFragment>
#include<clipPlaneFragment>
fragmentOutputs.color=uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},87765:function(e,t,i){i.r(t),i.d(t,{lineVertexShaderWGSL:function(){return a}});var r=i(29427);i(93725),i(47659),i(74575),i(31896),i(50973),i(90860),i(46479),i(96748);let s="lineVertexShader",n=`#define ADDITIONAL_VERTEX_DECLARATION
#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
attribute position: vec3f;attribute normal: vec4f;uniform width: f32;uniform aspectRatio: f32;
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
var worldViewProjection: mat4x4f=scene.viewProjection*finalWorld;var viewPosition: vec4f=worldViewProjection* vec4f(input.position,1.0);var viewPositionNext: vec4f=worldViewProjection* vec4f(input.normal.xyz,1.0);var currentScreen: vec2f=viewPosition.xy/viewPosition.w;var nextScreen: vec2f=viewPositionNext.xy/viewPositionNext.w;currentScreen=vec2f(currentScreen.x*uniforms.aspectRatio,currentScreen.y);nextScreen=vec2f(nextScreen.x*uniforms.aspectRatio,nextScreen.y);var dir: vec2f=normalize(nextScreen-currentScreen);var normalDir: vec2f= vec2f(-dir.y,dir.x);normalDir*=uniforms.width/2.0;normalDir=vec2f(normalDir.x/uniforms.aspectRatio,normalDir.y);var offset: vec4f= vec4f(normalDir*input.normal.w,0.0,0.0);vertexOutputs.position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
var worldPos: vec4f=finalWorld*vec4f(input.position,1.0);
#include<clipPlaneVertex>
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},91511:function(e,t,i){i.r(t),i.d(t,{lodPixelShaderWGSL:function(){return a}});var r=i(29427);let s="lodPixelShader",n=`const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform lod: f32;uniform gamma: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,fragmentInputs.vUV,uniforms.lod);if (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},93148:function(e,t,i){i.r(t),i.d(t,{lodCubePixelShaderWGSL:function(){return a}});var r=i(29427);let s="lodCubePixelShader",n=`const GammaEncodePowerApprox=1.0/2.2;varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;uniform lod: f32;uniform gamma: i32;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {let uv=fragmentInputs.vUV*2.0-1.0;
#ifdef POSITIVEX
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x),uniforms.lod);
#endif
#ifdef NEGATIVEX
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x),uniforms.lod);
#endif
#ifdef POSITIVEY
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x),uniforms.lod);
#endif
#ifdef NEGATIVEY
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x),uniforms.lod);
#endif
#ifdef POSITIVEZ
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,1.001),uniforms.lod);
#endif
#ifdef NEGATIVEZ
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,vec3f(uv,-1.001),uniforms.lod);
#endif
if (uniforms.gamma==0) {fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb,vec3f(GammaEncodePowerApprox)),fragmentOutputs.color.a);}}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},96289:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererPixelShaderWGSL:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererPixelShader",n=`varying vDecalTC: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {if (input.vDecalTC.x<0. || input.vDecalTC.x>1. || input.vDecalTC.y<0. || input.vDecalTC.y>1.) {discard;}
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vDecalTC);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},56865:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererVertexShaderWGSL:function(){return a}});var r=i(29427);i(10001),i(7694),i(54394),i(31343),i(93725),i(8772),i(87696),i(90860),i(30037),i(80867);let s="meshUVSpaceRendererVertexShader",n=`attribute position: vec3f;attribute normal: vec3f;attribute uv: vec2f;uniform projMatrix: mat4x4f;varying vDecalTC: vec2f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;var normalUpdated: vec3f=input.normal;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);var vNormalW: vec3f;
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vNormalW=normalize(normWorldSM*normalUpdated);
#endif
var normalView: vec3f=normalize((uniforms.projMatrix* vec4f(vNormalW,0.0)).xyz);var decalTC: vec3f=(uniforms.projMatrix*worldPos).xyz;vertexOutputs.vDecalTC=decalTC.xy;vertexOutputs.position=vec4f(input.uv*2.0-1.0,select(decalTC.z,2.,normalView.z>0.0),1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},69364:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererFinaliserPixelShaderWGSL:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererFinaliserPixelShader",n=`#define DISABLE_UNIFORMITY_ANALYSIS
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var maskTextureSamplerSampler: sampler;var maskTextureSampler: texture_2d<f32>;uniform textureSize: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var mask: vec4f=textureSample(maskTextureSampler,maskTextureSamplerSampler,input.vUV).rgba;if (mask.r>0.5) {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);} else {var texelSize: vec2f=4.0/uniforms.textureSize;var uv_p01: vec2f=input.vUV+ vec2f(-1.0,0.0)*texelSize;var uv_p21: vec2f=input.vUV+ vec2f(1.0,0.0)*texelSize;var uv_p10: vec2f=input.vUV+ vec2f(0.0,-1.0)*texelSize;var uv_p12: vec2f=input.vUV+ vec2f(0.0,1.0)*texelSize;var mask_p01: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p01).r;var mask_p21: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p21).r;var mask_p10: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p10).r;var mask_p12: f32=textureSample(maskTextureSampler,maskTextureSamplerSampler,uv_p12).r;var col: vec4f= vec4f(0.0,0.0,0.0,0.0);var total_weight: f32=0.0;if (mask_p01>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p01);total_weight+=1.0;}
if (mask_p21>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p21);total_weight+=1.0;}
if (mask_p10>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p10);total_weight+=1.0;}
if (mask_p12>0.5) {col+=textureSample(textureSampler,textureSamplerSampler,uv_p12);total_weight+=1.0;}
if (total_weight>0.0) {fragmentOutputs.color=col/total_weight;} else {fragmentOutputs.color=col;}}}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},38547:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererFinaliserVertexShaderWGSL:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererFinaliserVertexShader",n=`attribute position: vec3f;attribute uv: vec2f;uniform worldViewProjection: mat4x4f;varying vUV: vec2f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position=uniforms.worldViewProjection* vec4f(input.position,1.0);vertexOutputs.positionvUV=input.uv;}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},51372:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererMaskerPixelShaderWGSL:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererMaskerPixelShader",n=`varying vUV: vec2f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color= vec4f(1.0,1.0,1.0,1.0);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},32400:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererMaskerVertexShaderWGSL:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererMaskerVertexShader",n=`attribute uv: vec2f;varying vUV: vec2f;@vertex
fn main(input : VertexInputs)->FragmentInputs {vertexOutputs.position= vec4f( vec2f(input.uv.x,input.uv.y)*2.0-1.0,0.,1.0);vertexOutputs.vUV=input.uv;}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},89376:function(e,t,i){i.r(t),i.d(t,{motionBlurPixelShaderWGSL:function(){return a}});var r=i(29427);let s="motionBlurPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform motionStrength: f32;uniform motionScale: f32;uniform screenSize: vec2f;
#ifdef OBJECT_BASED
var velocitySamplerSampler: sampler;var velocitySampler: texture_2d<f32>;
#else
var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;uniform inverseViewProjection: mat4x4f;uniform prevViewProjection: mat4x4f;uniform projection: mat4x4f;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
var texelSize: vec2f=1.0/uniforms.screenSize;var velocityColor: vec4f=textureSample(velocitySampler,velocitySamplerSampler,input.vUV);velocityColor=vec4f(velocityColor.rg*2.0- vec2f(1.0),velocityColor.b,velocityColor.a);var velocity: vec2f= vec2f(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var samplesCount: i32= i32(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;var hlim: f32= f32(-samplesCount)*0.5+0.5;var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++)
{if (i>=samplesCount) {break;}
var offset: vec2f=input.vUV+velocity*(hlim+ f32(i));
#if defined(WEBGPU)
result+=textureSampleLevel(textureSampler,textureSamplerSampler, offset,0.0);
#else
result+=textureSample(textureSampler,textureSamplerSampler, offset);
#endif
}
fragmentOutputs.color=vec4f(result.rgb/ f32(samplesCount),1.0);
#else
var texelSize: vec2f=1.0/uniforms.screenSize;var depth: f32=textureSample(depthSampler,depthSamplerSampler,input.vUV).r;depth=uniforms.projection[2].z+uniforms.projection[3].z/depth; 
var cpos: vec4f= vec4f(input.vUV*2.0-1.0,depth,1.0);cpos=uniforms.inverseViewProjection*cpos;cpos/=cpos.w;var ppos: vec4f=uniforms.prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;var velocity: vec2f=(ppos.xy-input.vUV)*uniforms.motionScale*uniforms.motionStrength;var speed: f32=length(velocity/texelSize);var nSamples: i32= i32(clamp(speed,1.0,SAMPLES));var result: vec4f=textureSample(textureSampler,textureSamplerSampler, input.vUV);for (var i: i32=1; i< i32(SAMPLES); i++) {if (i>=nSamples) {break;}
var offset1: vec2f=input.vUV+velocity*( f32(i)/ f32(nSamples-1)-0.5);
#if defined(WEBGPU)
result+=textureSampleLevel(textureSampler,textureSamplerSampler, offset1,0.0);
#else
result+=textureSample(textureSampler,textureSamplerSampler, offset1);
#endif
}
fragmentOutputs.color=result/ f32(nSamples);
#endif
#else
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler, input.vUV);
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},36050:function(e,t,i){i.r(t),i.d(t,{oitBackBlendPixelShaderWGSL:function(){return a}});var r=i(29427);let s="oitBackBlendPixelShader",n=`var uBackColor: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureLoad(uBackColor,vec2i(fragmentInputs.position.xy),0);if (fragmentOutputs.color.a==0.0) {discard;}}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},49407:function(e,t,i){i.r(t),i.d(t,{oitFinalPixelShaderWGSL:function(){return a}});var r=i(29427);let s="oitFinalPixelShader",n=`var uFrontColor: texture_2d<f32>;var uBackColor: texture_2d<f32>;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var fragCoord: vec2i=vec2i(fragmentInputs.position.xy);var frontColor: vec4f=textureLoad(uFrontColor,fragCoord,0);var backColor: vec4f=textureLoad(uBackColor,fragCoord,0);var alphaMultiplier: f32=1.0-frontColor.a;fragmentOutputs.color=vec4f(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},54576:function(e,t,i){i.r(t),i.d(t,{outlinePixelShaderWGSL:function(){return a}});var r=i(29427);i(71030),i(50973),i(24228),i(92907);let s="outlinePixelShader",n=`uniform color: vec4f;
#ifdef ALPHATEST
varying vUV: vec2;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV).a<0.4) {discard;}
#endif
#include<logDepthFragment>
fragmentOutputs.color=uniforms.color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},3742:function(e,t,i){i.r(t),i.d(t,{outlineVertexShaderWGSL:function(){return a}});var r=i(29427);i(10001),i(7694),i(54394),i(31343),i(47659),i(93725),i(50973),i(8772),i(87696),i(90860),i(30037),i(80867),i(46479),i(96748);let s="outlineVertexShader",n=`attribute position: vec3f;attribute normal: vec3f;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform offset: f32;
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;
#ifdef ALPHATEST
varying vUV: vec2f;uniform diffuseMatrix: mat4x4f; 
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input: VertexInputs)->FragmentInputs {var positionUpdated: vec3f=vertexInputs.position;var normalUpdated: vec3f=vertexInputs.normal;
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
var offsetPosition: vec3f=positionUpdated+(normalUpdated*uniforms.offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld*vec4f(offsetPosition,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef UV2
vertexOutputs.vUV=(uniforms.diffuseMatrix*vec4f(vertexInputs.uv2,1.0,0.0)).xy;
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},85667:function(e,t,i){i.r(t),i.d(t,{particlesPixelShaderWGSL:function(){return a}});var r=i(29427);i(71030),i(16693),i(50973),i(42766),i(31103),i(1741),i(24228),i(92907),i(33220);let s="particlesPixelShader",n=`varying vUV: vec2f;varying vColor: vec4f;uniform textureMask: vec4f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying remapRanges: vec4f;var rampSamplerSampler: sampler;var rampSampler: texture_2d<f32>;
#endif
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
var textureColor: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,input.vUV);var baseColor: vec4f=(textureColor*uniforms.textureMask+( vec4f(1.,1.,1.,1.)-uniforms.textureMask))*input.vColor;
#ifdef RAMPGRADIENT
var alpha: f32=baseColor.a;var remappedColorIndex: f32=clamp((alpha-input.remapRanges.x)/input.remapRanges.y,0.0,1.0);var rampColor: vec4f=textureSample(rampSampler,rampSamplerSampler,vec2f(1.0-remappedColorIndex,0.));baseColor=vec4f(baseColor.rgb*rampColor.rgb,baseColor.a);var finalAlpha: f32=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-input.remapRanges.z)/input.remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
var sourceAlpha: f32=input.vColor.a*textureColor.a;baseColor=vec4f(baseColor.rgb*sourceAlpha+ vec3f(1.0)*(1.0-sourceAlpha),baseColor.a);
#endif
#include<logDepthFragment>
#include<fogFragment>(color,baseColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);
#else
#ifdef IMAGEPROCESSING
baseColor=vec4f(toLinearSpaceVec3(baseColor.rgb),baseColor.a);baseColor=applyImageProcessing(baseColor);
#endif
#endif
fragmentOutputs.color=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},59089:function(e,t,i){i.r(t),i.d(t,{particlesVertexShaderWGSL:function(){return a}});var r=i(29427);i(47659),i(24398),i(50973),i(46479),i(5352),i(96748);let s="particlesVertexShader",n=`attribute position: vec3f;attribute color: vec4f;attribute angle: f32;attribute size: vec2f;
#ifdef ANIMATESHEET
attribute cellIndex: f32;
#endif
#ifndef BILLBOARD
attribute direction: vec3f;
#endif
#ifdef BILLBOARDSTRETCHED
attribute direction: vec3f;
#endif
#ifdef RAMPGRADIENT
attribute remapData: vec4f;
#endif
attribute offset: vec2f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform translationPivot: vec2f;
#ifdef ANIMATESHEET
uniform particlesInfos: vec3f; 
#endif
varying vUV: vec2f;varying vColor: vec4f;varying vPositionW: vec3f;
#ifdef RAMPGRADIENT
varying remapRanges: vec4f;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform invView: mat4x4f;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform eyePosition: vec3f;
#endif
fn rotate(yaxis: vec3f,rotatedCorner: vec3f)->vec3f {var xaxis: vec3f=normalize(cross( vec3f(0.,1.0,0.),yaxis));var zaxis: vec3f=normalize(cross(yaxis,xaxis));var row0: vec3f= vec3f(xaxis.x,xaxis.y,xaxis.z);var row1: vec3f= vec3f(yaxis.x,yaxis.y,yaxis.z);var row2: vec3f= vec3f(zaxis.x,zaxis.y,zaxis.z);var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return vertexInputs.position+alignedCorner;}
#ifdef BILLBOARDSTRETCHED
fn rotateAlign(toCamera: vec3f,rotatedCorner: vec3f)->vec3f {var normalizedToCamera: vec3f=normalize(toCamera);var normalizedCrossDirToCamera: vec3f=normalize(cross(normalize(vertexInputs.direction),normalizedToCamera));var row0: vec3f= vec3f(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);var row2: vec3f= vec3f(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
var row1: vec3f=vertexInputs.direction;
#else
var crossProduct: vec3f=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));var row1: vec3f= vec3f(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
var rotMatrix: mat3x3f= mat3x3f(row0,row1,row2);var alignedCorner: vec3f=rotMatrix*rotatedCorner;return input.position+alignedCorner;}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var cornerPos: vec2f;cornerPos=( vec2f(input.offset.x-0.5,input.offset.y -0.5)-uniforms.translationPivot)*input.size;
#ifdef BILLBOARD
var rotatedCorner: vec3f;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=input.position-uniforms.eyePosition;yaxis.y=0.;vertexOutputs.vPositionW=rotate(normalize(yaxis),rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var toCamera: vec3f=input.position-uniforms.eyePosition;vertexOutputs.vPositionW=rotateAlign(toCamera,rotatedCorner);var viewPos: vec3f=(uniforms.view* vec4f(vertexOutputs.vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.y=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.z=0.;var viewPos: vec3f=(uniforms.view* vec4f(input.position,1.0)).xyz+rotatedCorner;vertexOutputs.vPositionW=(uniforms.invView* vec4f(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
vertexOutputs.remapRanges=input.remapData;
#endif
vertexOutputs.position=uniforms.projection* vec4f(viewPos,1.0);
#else
var rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(input.angle)-cornerPos.y*sin(input.angle)+uniforms.translationPivot.x;rotatedCorner.z=cornerPos.x*sin(input.angle)+cornerPos.y*cos(input.angle)+uniforms.translationPivot.y;rotatedCorner.y=0.;var yaxis: vec3f=normalize(vertexInputs.direction);vertexOutputs.vPositionW=rotate(yaxis,rotatedCorner);vertexOutputs.position=uniforms.projection*uniforms.view* vec4f(vertexOutputs.vPositionW,1.0);
#endif
vertexOutputs.vColor=input.color;
#ifdef ANIMATESHEET
var rowOffset: f32=floor(input.cellIndex*uniforms.particlesInfos.z);var columnOffset: f32=input.cellIndex-rowOffset/uniforms.particlesInfos.z;var uvScale: vec2f=uniforms.particlesInfos.xy;var uvOffset: vec2f= vec2f(input.offset.x ,1.0-input.offset.y);vertexOutputs.vUV=(uvOffset+ vec2f(columnOffset,rowOffset))*uvScale;
#else
vertexOutputs.vUV=input.offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
var worldPos: vec4f= vec4f(vertexOutputs.vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},98974:function(e,t,i){i.r(t),i.d(t,{passPixelShaderWGSL:function(){return a}});var r=i(29427);let s="passPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},88869:function(e,t,i){i.r(t),i.d(t,{passCubePixelShaderWGSL:function(){return a}});var r=i(29427);let s="passCubePixelShader",n=`varying var vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_cube<f32>;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var uv: vec2f=input.vUV*2.0-1.0;
#ifdef POSITIVEX
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,1.001));
#endif
#ifdef NEGATIVEZ
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,vec3f(uv,-1.001));
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},77082:function(e,t,i){i.r(t),i.d(t,{pbrPixelShaderWGSL:function(){return B}});var r=i(29427);i(68117),i(76123),i(53523),i(22221);let s=`varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
`;r.v.IncludesShadersStoreWGSL.pbrFragmentExtraDeclaration=s,i(42751),i(88254);let n=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying v_VARYINGNAME_UV: vec2f;
#endif
#endif
`;r.v.IncludesShadersStoreWGSL.samplerFragmentAlternateDeclaration=n;let a=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
var clearCoatRoughnessSamplerSampler: sampler;var clearCoatRoughnessSampler: texture_2d<f32>;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
var sheenRoughnessSamplerSampler: sampler;var sheenRoughnessSampler: texture_2d<f32>;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_cube<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_cube<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_cube<f32>;
#endif
#else
var reflectionSamplerSampler: sampler;var reflectionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var reflectionLowSamplerSampler: sampler;var reflectionLowSampler: texture_2d<f32>;var reflectionHighSamplerSampler: sampler;var reflectionHighSampler: texture_2d<f32>;
#endif
#ifdef USEIRRADIANCEMAP
var irradianceSamplerSampler: sampler;var irradianceSampler: texture_2d<f32>;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
var environmentBrdfSamplerSampler: sampler;var environmentBrdfSampler: texture_2d<f32>;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
var refractionSamplerSampler: sampler;var refractionSampler: texture_cube<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_cube<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_cube<f32>;
#endif
#else
var refractionSamplerSampler: sampler;var refractionSampler: texture_2d<f32>;
#ifdef LODBASEDMICROSFURACE
#else
var refractionLowSamplerSampler: sampler;var refractionLowSampler: texture_2d<f32>;var refractionHighSamplerSampler: sampler;var refractionHighSampler: texture_2d<f32>;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
`;r.v.IncludesShadersStoreWGSL.pbrFragmentSamplersDeclaration=a,i(16693),i(71030),i(50973),i(1741),i(42766);let o=`fn testLightingForSSS(diffusionProfile: f32)->bool
{return diffusionProfile<1.;}`;r.v.IncludesShadersStoreWGSL.subSurfaceScatteringFunctions=o,i(84147);let l=`#define MINIMUMVARIANCE 0.0005
fn convertRoughnessToAverageSlope(roughness: f32)->f32
{return roughness*roughness+MINIMUMVARIANCE;}
fn fresnelGrazingReflectance(reflectance0: f32)->f32 {var reflectance90: f32=saturate(reflectance0*25.0);return reflectance90;}
fn getAARoughnessFactors(normalVector: vec3f)->vec2f {
#ifdef SPECULARAA
var nDfdx: vec3f=dpdx(normalVector.xyz);var nDfdy: vec3f=dpdy(normalVector.xyz);var slopeSquare: f32=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));var geometricRoughnessFactor: f32=pow(saturate(slopeSquare),0.333);var geometricAlphaGFactor: f32=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2f(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2f(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var anisotropicFrameDirection: vec3f=select(T,B,anisotropy>=0.0);var anisotropicFrameTangent: vec3f=cross(normalize(anisotropicFrameDirection),V);var anisotropicFrameNormal: vec3f=cross(anisotropicFrameTangent,anisotropicFrameDirection);var anisotropicNormal: vec3f=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
fn getAnisotropicRoughness(alphaG: f32,anisotropy: f32)->vec2f {var alphaT: f32=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);var alphaB: f32=max(alphaG,MINIMUMVARIANCE);return vec2f(alphaT,alphaB);}
fn getAnisotropicBentNormals(T: vec3f,B: vec3f,N: vec3f,V: vec3f,anisotropy: f32,roughness: f32)->vec3f {var bentNormal: vec3f=cross(B,V);bentNormal=normalize(cross(bentNormal,B));var sq=1.0-anisotropy*(1.0-roughness);var a: f32=sq*sq*sq*sq;bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
fn cocaLambertVec3(alpha: vec3f,distance: f32)->vec3f {return exp(-alpha*distance);}
fn cocaLambert(NdotVRefract: f32,NdotLRefract: f32,alpha: vec3f,thickness: f32)->vec3f {return cocaLambertVec3(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
fn computeColorAtDistanceInMedia(color: vec3f,distance: f32)->vec3f {return -log(color)/distance;}
fn computeClearCoatAbsorption(NdotVRefract: f32,NdotLRefract: f32,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var clearCoatAbsorption: vec3f=mix( vec3f(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
fn computeDefaultMicroSurface(microSurface: f32,reflectivityColor: vec3f)->f32
{const kReflectivityNoAlphaWorkflow_SmoothnessMax: f32=0.95;var reflectivityLuminance: f32=getLuminance(reflectivityColor);var reflectivityLuma: f32=sqrt(reflectivityLuminance);var resultMicroSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return resultMicroSurface;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrHelperFunctions=l,i(31103),i(89716),i(21514);let c=`struct preLightingInfo
{lightOffset: vec3f,
lightDistanceSquared: f32,
lightDistance: f32,
attenuation: f32,
L: vec3f,
H: vec3f,
NdotV: f32,
NdotLUnclamped: f32,
NdotL: f32,
VdotH: f32,
roughness: f32,
#ifdef IRIDESCENCE
iridescenceIntensity: f32
#endif
};fn computePointAndSpotPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f,posW: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeDirectionalPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
fn computeHemisphericPreLightingInfo(lightData: vec4f,V: vec3f,N: vec3f)->preLightingInfo {var result: preLightingInfo;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}`;r.v.IncludesShadersStoreWGSL.pbrDirectLightingSetupFunctions=c;let u=`fn computeDistanceLightFalloff_Standard(lightOffset: vec3f,range: f32)->f32
{return max(0.,1.0-length(lightOffset)/range);}
fn computeDistanceLightFalloff_Physical(lightDistanceSquared: f32)->f32
{return 1.0/maxEps(lightDistanceSquared);}
fn computeDistanceLightFalloff_GLTF(lightDistanceSquared: f32,inverseSquaredRange: f32)->f32
{var lightDistanceFalloff: f32=1.0/maxEps(lightDistanceSquared);var factor: f32=lightDistanceSquared*inverseSquaredRange;var attenuation: f32=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
fn computeDistanceLightFalloff(lightOffset: vec3f,lightDistanceSquared: f32,range: f32,inverseSquaredRange: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
fn computeDirectionalLightFalloff_Standard(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32)->f32
{var falloff: f32=0.0;var cosAngle: f32=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
fn computeDirectionalLightFalloff_Physical(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32)->f32
{const kMinusLog2ConeAngleIntensityRatio: f32=6.64385618977; 
var concentrationKappa: f32=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);var lightDirectionSpreadSG: vec4f= vec4f(-lightDirection*concentrationKappa,-concentrationKappa);var falloff: f32=exp2(dot( vec4f(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
fn computeDirectionalLightFalloff_GLTF(lightDirection: vec3f,directionToLightCenterW: vec3f,lightAngleScale: f32,lightAngleOffset: f32)->f32
{var cd: f32=dot(-lightDirection,directionToLightCenterW);var falloff: f32=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
fn computeDirectionalLightFalloff(lightDirection: vec3f,directionToLightCenterW: vec3f,cosHalfAngle: f32,exponent: f32,lightAngleScale: f32,lightAngleOffset: f32)->f32
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;r.v.IncludesShadersStoreWGSL.pbrDirectLightingFalloffFunctions=u,i(41435),i(62456);let h=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{diffuse: vec3f,
#ifdef SPECULARTERM
specular: vec3f,
#endif
#ifdef CLEARCOAT
clearCoat: vec4f,
#endif
#ifdef SHEEN
sheen: vec3f
#endif
};fn adjustRoughnessFromLightProperties(roughness: f32,lightRadius: f32,lightDistance: f32)->f32 {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
var lightRoughness: f32=lightRadius/lightDistance;var totalRoughness: f32=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
fn computeHemisphericDiffuseLighting(info: preLightingInfo,lightColor: vec3f,groundColor: vec3f)->vec3f {return mix(groundColor,lightColor,info.NdotL);}
fn computeDiffuseLighting(info: preLightingInfo,lightColor: vec3f)->vec3f {var diffuseTerm: f32=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
fn computeProjectionTextureDiffuseLighting(projectionLightTexture: texture_2d<f32>,projectionLightSampler: sampler,textureProjectionMatrix: mat4x4f,posW: vec3f)->vec3f{var strq: vec4f=textureProjectionMatrix* vec4f(posW,1.0);strq/=strq.w;var textureColor: vec3f=textureSample(projectionLightTexture,projectionLightSampler,strq.xy).rgb;return toLinearSpaceVec3(textureColor);}
#ifdef SS_TRANSLUCENCY
fn computeDiffuseAndTransmittedLighting(info: preLightingInfo,lightColor: vec3f,transmittance: vec3f)->vec3f {var NdotL: f32=absEps(info.NdotLUnclamped);var wrapNdotL: f32=computeWrappedDiffuseNdotL(NdotL,0.02);var trAdapt: f32=step(0.,info.NdotLUnclamped);var transmittanceNdotL: vec3f=mix(transmittance*wrapNdotL, vec3f(wrapNdotL),trAdapt);var diffuseTerm: f32=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
fn computeSpecularLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
var smithVisibility: f32=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
var smithVisibility: f32=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
fn computeAnisotropicSpecularLighting(info: preLightingInfo,V: vec3f,N: vec3f,T: vec3f,B: vec3f,anisotropy: f32,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var TdotH: f32=dot(T,info.H);var BdotH: f32=dot(B,info.H);var TdotV: f32=dot(T,V);var BdotV: f32=dot(B,V);var TdotL: f32=dot(T,info.L);var BdotL: f32=dot(B,info.L);var alphaG: f32=convertRoughnessToAverageSlope(info.roughness);var alphaTB: vec2f=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,vec2f(geometricRoughnessFactor*geometricRoughnessFactor));var fresnel: vec3f=fresnelSchlickGGXVec3(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
var distribution: f32=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);var smithVisibility: f32=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);var specTerm: vec3f=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
fn computeClearCoatLighting(info: preLightingInfo,Ncc: vec3f,geometricRoughnessFactor: f32,clearCoatIntensity: f32,lightColor: vec3f)->vec4f {var NccdotL: f32=saturateEps(dot(Ncc,info.L));var NccdotH: f32=saturateEps(dot(Ncc,info.H));var clearCoatRoughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);var fresnel: f32=fresnelSchlickGGX(info.VdotH,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;var distribution: f32=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);var kelemenVisibility: f32=visibility_Kelemen(info.VdotH);var clearCoatTerm: f32=fresnel*distribution*kelemenVisibility;return vec4f(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
fn computeClearCoatLightingAbsorption(NdotVRefract: f32,L: vec3f,Ncc: vec3f,clearCoatColor: vec3f,clearCoatThickness: f32,clearCoatIntensity: f32)->vec3f {var LRefract: vec3f=-refract(L,Ncc,uniforms.vClearCoatRefractionParams.y);var NdotLRefract: f32=saturateEps(dot(Ncc,LRefract));var absorption: vec3f=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
fn computeSheenLighting(info: preLightingInfo,N: vec3f,reflectance0: vec3f,reflectance90: vec3f,geometricRoughnessFactor: f32,lightColor: vec3f)->vec3f {var NdotH: f32=saturateEps(dot(N,info.H));var roughness: f32=max(info.roughness,geometricRoughnessFactor);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var fresnel: f32=1.;var distribution: f32=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
var visibility: f32=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
var visibility: f32=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
var sheenTerm: f32=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrDirectLightingFunctions=h;let d=`#if defined(REFLECTION) || defined(SS_REFRACTION)
fn getLodFromAlphaG(cubeMapDimensionPixels: f32,microsurfaceAverageSlope: f32)->f32 {var microsurfaceAverageSlopeTexels: f32=cubeMapDimensionPixels*microsurfaceAverageSlope;var lod: f32=log2(microsurfaceAverageSlopeTexels);return lod;}
fn getLinearLodFromRoughness(cubeMapDimensionPixels: f32,roughness: f32)->f32 {var lod: f32=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
fn environmentRadianceOcclusion(ambientOcclusion: f32,NdotVUnclamped: f32)->f32 {var temp: f32=NdotVUnclamped+ambientOcclusion;return saturate(temp*temp-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
fn environmentHorizonOcclusion(view: vec3f,normal: vec3f,geometricNormal: vec3f)->f32 {var reflection: vec3f=reflect(view,normal);var temp: f32=saturate(1.0+1.1*dot(reflection,geometricNormal));return temp*temp;}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
fn UNPACK_LOD(x: f32)->f32 {return (1.0-x)*255.0;}
fn getLodFromAlphaGNdotV(cubeMapDimensionPixels: f32,alphaG: f32,NdotV: f32)->f32 {var microsurfaceAverageSlope: f32=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrIBLFunctions=d,i(40373),i(6877),i(82370),i(67356);let f=`struct albedoOpacityOutParams
{surfaceAlbedo: vec3f,
alpha: f32};
#define pbr_inline
fn albedoOpacityBlock(
vAlbedoColor: vec4f
#ifdef ALBEDO
,albedoTexture: vec4f
,albedoInfos: vec2f
#endif
#ifdef OPACITY
,opacityMap: vec4f
,vOpacityInfos: vec2f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
#ifdef DECAL
,decalColor: vec4f
,vDecalInfos: vec4f
#endif
)->albedoOpacityOutParams
{var outParams: albedoOpacityOutParams;var surfaceAlbedo: vec3f=vAlbedoColor.rgb;var alpha: f32=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpaceVec3(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=fragmentInputs.vColor.rgb;
#endif
#ifdef DETAIL
var detailAlbedo: f32=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=fragmentInputs.vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST 
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE) {discard;}
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;r.v.IncludesShadersStoreWGSL.pbrBlockAlbedoOpacity=f;let p=`struct reflectivityOutParams
{microSurface: f32,
roughness: f32,
surfaceReflectivityColor: vec3f,
#ifdef METALLICWORKFLOW
surfaceAlbedo: vec3f,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
ambientOcclusionColor: vec3f,
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
metallicRoughness: vec2f,
#ifdef REFLECTIVITY
surfaceMetallicColorMap: vec4f,
#endif
#ifndef FROSTBITE_REFLECTANCE
metallicF0: vec3f,
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColorMap: vec4f,
#endif
#endif
#endif
};
#define pbr_inline
fn reflectivityBlock(
vReflectivityColor: vec4f
#ifdef METALLICWORKFLOW
,surfaceAlbedo: vec3f
,metallicReflectanceFactors: vec4f
#endif
#ifdef REFLECTIVITY
,reflectivityInfos: vec3f
,surfaceMetallicOrReflectivityColorMap: vec4f
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,ambientOcclusionColorIn: vec3f
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel: vec4f
#endif
#ifdef DETAIL
,detailColor: vec4f
,vDetailInfos: vec4f
#endif
)->reflectivityOutParams
{var outParams: reflectivityOutParams;var microSurface: f32=vReflectivityColor.a;var surfaceReflectivityColor: vec3f=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var metallicRoughness: vec2f=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
var aoStoreInMetalMap: vec3f= vec3f(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
var detailRoughness: f32=mix(0.5,detailColor.b,vDetailInfos.w);var loLerp: f32=mix(0.,metallicRoughness.g,detailRoughness*2.);var hiLerp: f32=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;var baseColor: vec3f=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
var metallicF0: vec3f=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0), vec3f(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);var roughness: f32=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}
`;r.v.IncludesShadersStoreWGSL.pbrBlockReflectivity=p;let m=`struct ambientOcclusionOutParams
{ambientOcclusionColor: vec3f,
#if DEBUGMODE>0 && defined(AMBIENT)
ambientOcclusionColorMap: vec3f
#endif
};
#define pbr_inline
fn ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap_: vec3f,
vAmbientInfos: vec4f
#endif
)->ambientOcclusionOutParams
{ 
var outParams: ambientOcclusionOutParams;var ambientOcclusionColor: vec3f= vec3f(1.,1.,1.);
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap= vec3f(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;r.v.IncludesShadersStoreWGSL.pbrBlockAmbientOcclusion=m;let _=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{alpha: f32};fn faceforward(N: vec3<f32>,I: vec3<f32>,Nref: vec3<f32>)->vec3<f32> {return select(N,-N,dot(Nref,I)>0.0);}
#define pbr_inline
fn alphaFresnelBlock(
normalW: vec3f,
viewDirectionW: vec3f,
alpha: f32,
microSurface: f32
)->alphaFresnelOutParams
{var outParams: alphaFresnelOutParams;var opacityPerceptual: f32=alpha;
#ifdef LINEARALPHAFRESNEL
var opacity0: f32=opacityPerceptual;
#else
var opacity0: f32=opacityPerceptual*opacityPerceptual;
#endif
var opacity90: f32=fresnelGrazingReflectance(opacity0);var normalForward: vec3f=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)), vec3f(opacity0), vec3f(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE) {discard;}
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockAlphaFresnel=_;let g=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{anisotropy: f32,
anisotropicTangent: vec3f,
anisotropicBitangent: vec3f,
anisotropicNormal: vec3f,
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
anisotropyMapData: vec3f
#endif
};
#define pbr_inline
fn anisotropicBlock(
vAnisotropy: vec3f,
roughness: f32,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData: vec3f,
#endif
TBN: mat3x3f,
normalW: vec3f,
viewDirectionW: vec3f
)->anisotropicOutParams
{ 
var outParams: anisotropicOutParams;var anisotropy: f32=vAnisotropy.b;var anisotropyDirection: vec3f= vec3f(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
var amd=anisotropyMapData.rg;anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
amd=amd*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection=vec3f(anisotropyDirection.xy*amd,anisotropyDirection.z);
#else
anisotropyDirection=vec3f(mat2x2f(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(amd),anisotropyDirection.z);
#endif
#endif
var anisoTBN: mat3x3f= mat3x3f(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));var anisotropicTangent: vec3f=normalize(anisoTBN*anisotropyDirection);var anisotropicBitangent: vec3f=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockAnisotropic=g;let v=`#ifdef REFLECTION
struct reflectionOutParams
{environmentRadiance: vec4f
,environmentIrradiance: vec3f
#ifdef REFLECTIONMAP_3D
,reflectionCoords: vec3f
#else
,reflectionCoords: vec2f
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector: vec3f
#endif
#endif
#endif
};
#define pbr_inline
#ifdef REFLECTIONMAP_3D
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec3f
{var reflectionCoords: vec3f;
#else
fn createReflectionCoords(
vPositionW: vec3f,
normalW: vec3f,
#ifdef ANISOTROPIC
anisotropicOut: anisotropicOutParams,
#endif
)->vec2f
{ 
var reflectionCoords: vec2f;
#endif
#ifdef ANISOTROPIC
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
var reflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
return reflectionCoords;}
#define pbr_inline
fn sampleReflectionTexture(
alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif 
)->vec4f
{var environmentRadiance: vec4f;
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
var reflectionLOD: f32=getLodFromAlphaGNdotV(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
var reflectionLOD: f32=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
var reflectionLOD: f32=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
var automaticReflectionLOD: f32=UNPACK_LOD(textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords).a);var requestedReflectionLOD: f32=max(automaticReflectionLOD,reflectionLOD);
#else
var requestedReflectionLOD: f32=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance= vec4f(radiance(alphaG,reflectionSampler,reflectionSamplerSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=textureSampleLevel(reflectionSampler,reflectionSamplerSampler,reflectionCoords,reflectionLOD);
#endif
#else
var lodReflectionNormalized: f32=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));var lodReflectionNormalizedDoubled: f32=lodReflectionNormalized*2.0;var environmentMid: vec4f=textureSample(reflectionSampler,reflectionSamplerSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
textureSample(reflectionHighSampler,reflectionHighSamplerSampler,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
textureSample(reflectionLowSampler,reflectionLowSamplerSampler,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
var envRadiance=environmentRadiance.rgb;
#ifdef RGBDREFLECTION
envRadiance=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
envRadiance=toLinearSpaceVec3(environmentRadiance.rgb);
#endif
envRadiance*=vReflectionInfos.x;envRadiance*=vReflectionColor.rgb;return vec4f(envRadiance,environmentRadiance.a);}
#define pbr_inline
fn reflectionBlock(
vPositionW: vec3f
,normalW: vec3f
,alphaG: f32
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped: f32
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness: f32
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance: vec3f
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionMatrix: mat4x4f
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler 
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler 
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
)->reflectionOutParams
{var outParams: reflectionOutParams;var environmentRadiance: vec4f= vec4f(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
var reflectionCoords: vec3f= vec3f(0.);
#else
var reflectionCoords: vec2f= vec2f(0.);
#endif
reflectionCoords=createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif 
);environmentRadiance=sampleReflectionTexture(
alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
#ifdef REFLECTIONMAP_3D
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#else
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);var environmentIrradiance: vec3f= vec3f(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
var irradianceVector: vec3f= (reflectionMatrix* vec4f(anisotropicOut.anisotropicNormal,0)).xyz;
#else
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,reflectionSamplerSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
var environmentIrradiance4: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance=toLinearSpaceVec3(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockReflection=v;let S=`#ifdef SHEEN
struct sheenOutParams
{sheenIntensity: f32
,sheenColor: vec3f
,sheenRoughness: f32
#ifdef SHEEN_LINKWITHALBEDO
,surfaceAlbedo: vec3f
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
,sheenAlbedoScaling: f32
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,finalSheenRadianceScaled: vec3f
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,sheenEnvironmentReflectance: vec3f
#endif
#endif
};
#define pbr_inline
fn sheenBlock(
vSheenColor: vec4f
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness: f32
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData: vec4f
#endif
#endif
,roughness: f32
#ifdef SHEEN_TEXTURE
,sheenMapData: vec4f
,sheenMapLevel: f32
#endif
,reflectance: f32
#ifdef SHEEN_LINKWITHALBEDO
,baseColor: vec3f
,surfaceAlbedo: vec3f
#endif
#ifdef ENVIRONMENTBRDF
,NdotV: f32
,environmentBrdf: vec3f
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors: vec2f
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec3f
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
,reflectionCoords: vec2f
#endif
,NdotVUnclamped: f32
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo: f32
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho: f32
#endif
#endif
)->sheenOutParams
{var outParams: sheenOutParams;var sheenIntensity: f32=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
var sheenFactor: f32=pow5(1.0-sheenIntensity);var sheenColor: vec3f=baseColor.rgb*(1.0-sheenFactor);var sheenRoughness: f32=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
var sheenColor: vec3f=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor*=toLinearSpaceVec3(sheenMapData.rgb);
#else
sheenColor*=sheenMapData.rgb;
#endif
sheenColor*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
var sheenRoughness: f32=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
var sheenRoughness: f32=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
var environmentSheenBrdf: vec3f= vec3f(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
var environmentSheenBrdf: vec3f=getBRDFLookup(NdotV,sheenRoughness);
#else
var environmentSheenBrdf: vec3f=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
var sheenAlphaG: f32=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
var environmentSheenRadiance: vec4f= vec4f(0.,0.,0.,0.);environmentSheenRadiance=sampleReflectionTexture(
sheenAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,sheenRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,reflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);var sheenEnvironmentReflectance: vec3f=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockSheen=S;let x=`struct clearcoatOutParams
{specularEnvironmentR0: vec3f,
conservationFactor: f32,
clearCoatNormalW: vec3f,
clearCoatAARoughnessFactors: vec2f,
clearCoatIntensity: f32,
clearCoatRoughness: f32,
#ifdef REFLECTION
finalClearCoatRadianceScaled: vec3f,
#endif
#ifdef CLEARCOAT_TINT
absorption: vec3f,
clearCoatNdotVRefract: f32,
clearCoatColor: vec3f,
clearCoatThickness: f32,
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
energyConservationFactorClearCoat: vec3f,
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
TBNClearCoat: mat3x3f,
#endif
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData: vec2f,
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
clearCoatTintMapData: vec4f,
#endif
#ifdef REFLECTION
environmentClearCoatRadiance: vec4f,
clearCoatEnvironmentReflectance: vec3f,
#endif
clearCoatNdotV: f32
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
fn clearcoatBlock(
vPositionW: vec3f
,geometricNormalW: vec3f
,viewDirectionW: vec3f
,vClearCoatParams: vec2f
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData: vec4f
#endif
,specularEnvironmentR0: vec3f
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams: vec4f
,clearCoatColorAtDistance: f32
,vClearCoatRefractionParams: vec4f
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData: vec4f
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos: vec2f
,clearCoatBumpMapData: vec4f
,vClearCoatBumpUV: vec2f
#if defined(TANGENT) && defined(NORMAL)
,vTBN: mat3x3f
#else
,vClearCoatTangentSpaceParams: vec2f
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix: mat4x4f
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal: vec3f
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos: vec3f
,vReflectionInfos: vec2f
,vReflectionColor: vec3f
,vLightingIntensity: vec4f
#ifdef REFLECTIONMAP_3D
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
#else
,reflectionSampler: texture_2d<f32>
,reflectionSamplerSampler: sampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,reflectionLowSampler: texture_cube<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_cube<f32>
,reflectionHighSamplerSampler: sampler 
#else
,reflectionLowSampler: texture_2d<f32>
,reflectionLowSamplerSampler: sampler 
,reflectionHighSampler: texture_2d<f32>
,reflectionHighSamplerSampler: sampler 
#endif
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo: vec2f
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,frontFacingMultiplier: f32
#endif 
)->clearcoatOutParams
{var outParams: clearcoatOutParams;var clearCoatIntensity: f32=vClearCoatParams.x;var clearCoatRoughness: f32=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
var clearCoatColor: vec3f=vClearCoatTintParams.rgb;var clearCoatThickness: f32=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpaceVec3(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
var specularEnvironmentR0Updated: vec3f=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
var specularEnvironmentR0Updated: vec3f=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);var clearCoatNormalW: vec3f=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
var clearCoatNormalScale: f32=1.0;
#else
var clearCoatNormalScale: f32=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
var TBNClearCoat: mat3x3f=vTBN;
#else
var TBNClearCoatUV: vec2f=vClearCoatBumpUV*frontFacingMultiplier;var TBNClearCoat: mat3x3f=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize( mat3x3f(normalMatrix[0].xyz,normalMatrix[1].xyz,normalMatrix[2].xyz)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);var clearCoatNdotVUnclamped: f32=dot(clearCoatNormalW,viewDirectionW);var clearCoatNdotV: f32=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
var clearCoatVRefract: vec3f=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
var environmentClearCoatBrdf: vec3f=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
var clearCoatAlphaG: f32=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
var environmentClearCoatRadiance: vec4f= vec4f(0.,0.,0.,0.);var clearCoatReflectionVector: vec3f=computeReflectionCoords( vec4f(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
var clearCoatReflectionCoords: vec3f=clearCoatReflectionVector;
#else
var clearCoatReflectionCoords: vec2f=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
environmentClearCoatRadiance=sampleReflectionTexture(
clearCoatAlphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,clearCoatNdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,clearCoatRoughness
#endif
,reflectionSampler
,reflectionSamplerSampler
,clearCoatReflectionCoords
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif 
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromBRDFLookup(vec3f(uniforms.vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var clearCoatEho: f32=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
var clearCoatEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV, vec3f(1.), vec3f(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
var fresnelIBLClearCoat: f32=fresnelSchlickGGX(clearCoatNdotV,uniforms.vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockClearcoat=x;let E=`struct iridescenceOutParams
{iridescenceIntensity: f32,
iridescenceIOR: f32,
iridescenceThickness: f32,
specularEnvironmentR0: vec3f};
#ifdef IRIDESCENCE
fn iridescenceBlock(
vIridescenceParams: vec4f
,viewAngle: f32
,specularEnvironmentR0: vec3f
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData: vec2f
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData: vec2f
#endif
#ifdef CLEARCOAT
,NdotVUnclamped: f32
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData: vec2f
#endif
#endif
)->iridescenceOutParams
{var outParams: iridescenceOutParams;var iridescenceIntensity: f32=vIridescenceParams.x;var iridescenceIOR: f32=vIridescenceParams.y;var iridescenceThicknessMin: f32=vIridescenceParams.z;var iridescenceThicknessMax: f32=vIridescenceParams.w;var iridescenceThicknessWeight: f32=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
var iridescenceThickness: f32=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);var topIor: f32=1.; 
#ifdef CLEARCOAT
var clearCoatIntensity: f32=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,uniforms.vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+((1.0/topIor)*(1.0/topIor))*((NdotVUnclamped*NdotVUnclamped)-1.0));
#endif
var iridescenceFresnel: vec3f=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockIridescence=E;let C=`struct subSurfaceOutParams
{specularEnvironmentReflectance: vec3f,
#ifdef SS_REFRACTION
finalRefraction: vec3f,
surfaceAlbedo: vec3f,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha: f32,
#endif
#ifdef REFLECTION
refractionFactorForIrradiance: f32,
#endif
#endif
#ifdef SS_TRANSLUCENCY
transmittance: vec3f,
translucencyIntensity: f32,
#ifdef REFLECTION
refractionIrradiance: vec3f,
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap: vec4f,
#endif
#ifdef SS_REFRACTION
environmentRefraction: vec4f,
refractionTransmittance: vec3f
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
fn sampleEnvironmentRefraction(
ior: f32
,thickness: f32
,refractionLOD: f32
,normalW: vec3f
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
)->vec4f {var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef ANISOTROPIC
var refractionVector: vec3f=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
var refractionVector: vec3f=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;var refractionCoords: vec3f=refractionVector;refractionCoords= (refractionMatrix* vec4f(refractionCoords,0)).xyz;
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*thickness,1.0))).xyz;
#else
var vRefractionUVW: vec3f= (refractionMatrix*(view* vec4f(vPositionW+refractionVector*vRefractionInfos.z,1.0))).xyz;
#endif
var refractionCoords: vec2f=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
var lod=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
var automaticRefractionLOD: f32=UNPACK_LOD(textureSample(refractionSampler,refractionSamplerSampler,refractionCoords).a);var requestedRefractionLOD: f32=max(automaticRefractionLOD,lod);
#else
var requestedRefractionLOD: f32=lod;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction= vec4f(radiance(alphaG,refractionSampler,refractionSamplerSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=textureSampleLevel(refractionSampler,refractionSamplerSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
var lodRefractionNormalized: f32=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));var lodRefractionNormalizedDoubled: f32=lodRefractionNormalized*2.0;var environmentRefractionMid: vec4f=textureSample(refractionSampler,refractionSamplerSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
textureSample(refractionHighSampler,refractionHighSamplerSampler,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
textureSample(refractionLowSampler,refractionLowSamplerSampler,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
var refraction=environmentRefraction.rgb;
#ifdef SS_RGBDREFRACTION
refraction=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
refraction=toLinearSpaceVec3(environmentRefraction.rgb);
#endif
return vec4f(refraction,environmentRefraction.a);}
#endif
#define pbr_inline
fn subSurfaceBlock(
vSubSurfaceIntensity: vec3f
,vThicknessParam: vec2f
,vTintColor: vec4f
,normalW: vec3f
,specularEnvironmentReflectance: vec3f
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap: vec4f
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap: vec4f
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap: vec4f
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix: mat4x4f
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,irradianceVector_: vec3f
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler: texture_cube<f32>
,reflectionSamplerSampler: sampler
,vReflectionFilteringInfo: vec2f
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,irradianceSampler: texture_cube<f32>
,irradianceSamplerSampler: sampler
#else
,irradianceSampler: texture_2d<f32>
,irradianceSamplerSampler: sampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo: vec3f
#endif
#ifdef SS_REFRACTION
,vPositionW: vec3f
,viewDirectionW: vec3f
,view: mat4x4f
,vRefractionInfos: vec4f
,refractionMatrix: mat4x4f
,vRefractionMicrosurfaceInfos: vec4f
,vLightingIntensity: vec4f
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha: f32
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped: f32
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness: f32
#endif
,alphaG: f32
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler: texture_cube<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_cube<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_cube<f32>
,refractionHighSamplerSampler: sampler 
#endif
#else
,refractionSampler: texture_2d<f32>
,refractionSamplerSampler: sampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler: texture_2d<f32>
,refractionLowSamplerSampler: sampler
,refractionHighSampler: texture_2d<f32>
,refractionHighSamplerSampler: sampler 
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut: anisotropicOutParams
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo: vec2f
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition: vec3f
,refractionSize: vec3f
#endif
#ifdef SS_DISPERSION
,dispersion: f32
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance: vec3f
,vTranslucencyColor: vec4f
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap: vec4f
#endif
#endif
)->subSurfaceOutParams
{var outParams: subSurfaceOutParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
var refractionIntensity: f32=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
var translucencyIntensity: f32=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
var thickness: f32=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
var thickness: f32=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
var thickness: f32=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);var translucencyColor: vec4f=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
var transmittance: vec3f=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
var environmentRefraction: vec4f= vec4f(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
var ior: f32=vRefractionInfos.y;
#else
var ior: f32=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaGNdotV(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
var refractionRoughness: f32=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
var refractionAlphaG: f32=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));var refractionLOD: f32=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
var refraction_ior: f32=vRefractionInfos.y;
#ifdef SS_DISPERSION
var realIOR: f32=1.0/refraction_ior;var iorDispersionSpread: f32=0.04*dispersion*(realIOR-1.0);var iors: vec3f= vec3f(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (var i: i32=0; i<3; i++) {refraction_ior=iors[i];
#endif
var envSample: vec4f=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#else
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction=vec4f(environmentRefraction.rgb*vRefractionInfos.x,environmentRefraction.a);
#endif
#ifdef SS_REFRACTION
var refractionTransmittance: vec3f= vec3f(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
var maxChannel: f32=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);var volumeAlbedo: vec3f=saturateVec3(maxChannel*surfaceAlbedo);environmentRefraction=vec4f(environmentRefraction.rgb*volumeAlbedo,environmentRefraction.a);
#else
var volumeAlbedo: vec3f=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambertVec3(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction=vec4f(environmentRefraction.rgb*surfaceAlbedo.rgb,environmentRefraction.a);
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
var bounceSpecularEnvironmentReflectance: vec3f=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
var irradianceVector: vec3f= (reflectionMatrix* vec4f(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
var irradianceVector: vec3f=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
var refractionIrradiance: vec3f=irradiance(reflectionSampler,reflectionSamplerSampler,-irradianceVector,vReflectionFilteringInfo);
#else
var refractionIrradiance: vec3f=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
var irradianceCoords: vec3f=irradianceVector;
#else
var irradianceCoords: vec2f=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
var temp: vec4f=textureSample(irradianceSampler,irradianceSamplerSampler,-irradianceCoords);var refractionIrradiance=temp.rgb;
#ifdef RGBDREFLECTION
refractionIrradiance=fromRGBD(temp).rgb;
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance=toLinearSpaceVec3(refractionIrradiance);
#endif
#else
var refractionIrradiance: vec3f= vec3f(0.);
#endif
refractionIrradiance*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance;
#endif
return outParams;}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockSubSurface=C,i(24228);let T=`var viewDirectionW: vec3f=normalize(scene.vEyePosition.xyz-input.vPositionW);
#ifdef NORMAL
var normalW: vec3f=normalize(input.vNormalW);
#else
var normalW: vec3f=normalize(cross(dpdx(input.vPositionW),dpdy(input.vPositionW)))*scene.vEyePosition.w;
#endif
var geometricNormalW: vec3f=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=select(-geometricNormalW,geometricNormalW,fragmentInputs.frontFacing);
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockNormalGeometric=T,i(24140);let b=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
var faceNormal: vec3f=normalize(cross(dpdx(fragmentInputs.vPositionW),dpdy(fragmentInputs.vPositionW)))*scene.vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=select(-faceNormal,faceNormal,fragmentInputs.frontFacing);
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=select(-normalW,normalW,fragmentInputs.frontFacing);
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockNormalFinal=b,i(31967);let y=`#ifdef LIGHTMAP
var lightmapColor: vec4f=textureSample(lightmapSampler,lightmapSamplerSampler,fragmentInputs.vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor=vec4f(fromRGBD(lightmapColor),lightmapColor.a);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor=vec4f(toLinearSpaceVec3(lightmapColor.rgb),lightmapColor.a);
#endif
lightmapColor=vec4f(lightmapColor.rgb*uniforms.vLightmapInfos.y,lightmapColor.a);
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockLightmapInit=y;let I=`var NdotVUnclamped: f32=dot(normalW,viewDirectionW);var NdotV: f32=absEps(NdotVUnclamped);var alphaG: f32=convertRoughnessToAverageSlope(roughness);var AARoughnessFactors: vec2f=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
var environmentBrdf: vec3f=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
var ambientMonochrome: f32=aoOut.ambientOcclusionColor.r;
#else
var ambientMonochrome: f32=getLuminance(aoOut.ambientOcclusionColor);
#endif
var seo: f32=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
var eho: f32=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockGeometryInfo=I;let P=`var reflectance: f32=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);var specularEnvironmentR0: vec3f=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
var specularEnvironmentR90: vec3f= vec3f(metallicReflectanceFactors.a);
#else 
var specularEnvironmentR90: vec3f= vec3f(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
var reflectance90: f32=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockReflectance0=P;let R=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
var specularEnvironmentReflectance: vec3f=getReflectanceFromBRDFWithEnvLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
var specularEnvironmentReflectance: vec3f=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockReflectance=R;let A=`var diffuseBase: vec3f=vec3f(0.,0.,0.);
#ifdef SPECULARTERM
var specularBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef CLEARCOAT
var clearCoatBase: vec3f=vec3f(0.,0.,0.);
#endif
#ifdef SHEEN
var sheenBase: vec3f=vec3f(0.,0.,0.);
#endif
var preInfo: preLightingInfo;var info: lightingInfo;var shadow: f32=1.; 
var aggShadow: f32=0.;var numLights: f32=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
var absorption: vec3f=vec3f(0.);
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockDirectLighting=A,i(39192);let M=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
var energyConservationFactor: vec3f=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
var finalIrradiance: vec3f=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=uniforms.vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
var finalSpecular: vec3f=specularBase;finalSpecular=max(finalSpecular,vec3f(0.0));var finalSpecularScaled: vec3f=finalSpecular*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
var finalRadiance: vec3f=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;var finalRadianceScaled: vec3f=finalRadiance*uniforms.vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
var finalSheen: vec3f=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,vec3f(0.0));var finalSheenScaled: vec3f=finalSheen*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
var finalClearCoat: vec3f=clearCoatBase;finalClearCoat=max(finalClearCoat,vec3f(0.0));var finalClearCoatScaled: vec3f=finalClearCoat*uniforms.vLightingIntensity.x*uniforms.vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
var luminanceOverAlpha: f32=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockFinalLitComponents=M;let N=`var finalDiffuse: vec3f=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,vec3f(0.0));finalDiffuse*=uniforms.vLightingIntensity.x;var finalAmbient: vec3f=uniforms.vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;var finalEmissive: vec3f=uniforms.vEmissiveColor;
#ifdef EMISSIVE
var emissiveColorTex: vec3f=textureSample(emissiveSampler,emissiveSamplerSampler,fragmentInputs.vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpaceVec3(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= uniforms.vEmissiveInfos.y;
#endif
finalEmissive*=uniforms.vLightingIntensity.y;
#ifdef AMBIENT
var ambientOcclusionForDirectDiffuse: vec3f=mix( vec3f(1.),aoOut.ambientOcclusionColor,uniforms.vAmbientInfos.w);
#else
var ambientOcclusionForDirectDiffuse: vec3f=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;r.v.IncludesShadersStoreWGSL.pbrBlockFinalUnlitComponents=N;let O=`var finalColor: vec4f= vec4f(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor=vec4f(finalColor.rgb*lightmapColor.rgb,finalColor.a);
#else
finalColor=vec4f(finalColor.rgb+lightmapColor.rgb,finalColor.a);
#endif
#endif
#endif
finalColor=vec4f(finalColor.rgb+finalEmissive,finalColor.a);
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,vec4f(0.0));
`;r.v.IncludesShadersStoreWGSL.pbrBlockFinalColorComposition=O,i(92907),i(33220);let D=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor=vec4f(clamp(finalColor.rgb,vec3f(0.),vec3f(30.0)),finalColor.a);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor=vec4f(finalColor.rgb,finalColor.a*mesh.visibility);
#ifdef PREMULTIPLYALPHA
finalColor=vec4f(finalColor.rgb*finalColor.a,finalColor.a);;
#endif
`;r.v.IncludesShadersStoreWGSL.pbrBlockImageProcessing=D,i(94598);let F=`#if DEBUGMODE>0
if (input.vClipSpacePosition.x/input.vClipSpacePosition.w>=uniforms.vDebugMode.x) {var color: vec3f;
#if DEBUGMODE==1
color=fragmentInputs.vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
color=fragmentInputs.vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
color=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
color=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
color=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
color= vec3f(input.vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
color= vec3f(input.vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
color=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
color=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
color=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
color=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
color=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
color=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
color=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
color=lightmapColor;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
color=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
color= vec3f(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
color=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
color=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
color=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
color=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
color=textureSample(bumpSampler,bumpSamplerSampler,fragmentInputs.vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
color=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
color=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
color=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
color=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
color=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
color=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
color=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
color=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
color=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
color=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
color= vec3f(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
color=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
color= vec3f(roughness);
#elif DEBUGMODE==64
color= vec3f(alphaG);
#elif DEBUGMODE==65
color= vec3f(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
color=clearcoatOut.clearCoatColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
color= vec3f(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
color=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
color=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
color= vec3f(microSurface);
#elif DEBUGMODE==73
color=uniforms.vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
color=uniforms.vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
color=uniforms.vEmissiveColor;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
color= vec3f(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
color= vec3f(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
color= vec3f(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
color=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
color=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
color= vec3f(luminanceOverAlpha);
#elif DEBUGMODE==87
color= vec3f(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
color= vec3f(albedoTexture.a);
#elif DEBUGMODE==89
color=aoOut.ambientOcclusionColor;
#else
var stripeWidth: f32=30.;var stripePos: f32=abs(floor(input.position.x/stripeWidth));var whichColor: f32=((stripePos)%(2.));var color1: vec3f= vec3f(.6,.2,.2);var color2: vec3f= vec3f(.3,.1,.1);color=mix(color1,color2,whichColor);
#endif
color*=uniforms.vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
color=normalize(color)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
color=toGammaSpaceVec3(color);
#endif
fragmentOutputs.color=vec4f(color,1.0);
#ifdef PREPASS
fragmentOutputs.fragData0=toLinearSpaceVec3(color); 
fragmentOutputs.fragData1=vec4f(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return fragmentOutputs;
#endif
}
#endif
`;r.v.IncludesShadersStoreWGSL.pbrDebug=F;let L="pbrPixelShader",w=`#define CUSTOM_FRAGMENT_BEGIN
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<pbrUboDeclaration>
#include<pbrFragmentExtraDeclaration>
#include<lightUboDeclaration>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
var albedoOpacityOut: albedoOpacityOutParams;
#ifdef ALBEDO
var albedoTexture: vec4f=textureSample(albedoSampler,albedoSamplerSampler,fragmentInputs.vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
var opacityMap: vec4f=textureSample(opacitySampler,opacitySamplerSampler,fragmentInputs.vOpacityUV+uvOffset);
#endif
#ifdef DECAL
var decalColor: vec4f=textureSample(decalSampler,decalSamplerSampler,fragmentInputs.vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
uniforms.vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,uniforms.vAlbedoInfos
#endif
#ifdef OPACITY
,opacityMap
,uniforms.vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
#ifdef DECAL
,decalColor
,uniforms.vDecalInfos
#endif
);var surfaceAlbedo: vec3f=albedoOpacityOut.surfaceAlbedo;var alpha: f32=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
var aoOut: ambientOcclusionOutParams;
#ifdef AMBIENT
var ambientOcclusionColorMap: vec3f=textureSample(ambientSampler,ambientSamplerSampler,fragmentInputs.vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
uniforms.vAmbientInfos
#endif 
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
var diffuseBase: vec3f= vec3f(1.,1.,1.);
#else
var baseColor: vec3f=surfaceAlbedo;var reflectivityOut: reflectivityOutParams;
#if defined(REFLECTIVITY)
var surfaceMetallicOrReflectivityColorMap: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,fragmentInputs.vReflectivityUV+uvOffset);var baseReflectivity: vec4f=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpaceVec4(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap=vec4f(surfaceMetallicOrReflectivityColorMap.rgb*uniforms.vReflectivityInfos.y,surfaceMetallicOrReflectivityColorMap.a);
#endif
#endif
#if defined(MICROSURFACEMAP)
var microSurfaceTexel: vec4f=textureSample(microSurfaceSampler,microSurfaceSamplerSampler,fragmentInputs.vMicroSurfaceSamplerUV+uvOffset)*uniforms.vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
var metallicReflectanceFactors: vec4f=uniforms.vMetallicReflectanceFactors;
#ifdef REFLECTANCE
var reflectanceFactorsMap: vec4f=textureSample(reflectanceSampler,reflectanceSamplerSampler,fragmentInputs.vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpaceVec4(reflectanceFactorsMap);
#endif
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
#ifdef METALLIC_REFLECTANCE
var metallicReflectanceFactorsMap: vec4f=textureSample(metallicReflectanceSampler,metallicReflectanceSamplerSampler,fragmentInputs.vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpaceVec4(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors=vec4f(metallicReflectanceFactors.rgb*reflectanceFactorsMap.rgb,metallicReflectanceFactors.a);
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
uniforms.vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,uniforms.vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,uniforms.vDetailInfos
#endif
);var microSurface: f32=reflectivityOut.microSurface;var roughness: f32=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
var alphaFresnelOut: alphaFresnelOutParams;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
var anisotropicOut: anisotropicOutParams;
#ifdef ANISOTROPIC_TEXTURE
var anisotropyMapData: vec3f=textureSample(anisotropySampler,anisotropySamplerSampler,fragmentInputs.vAnisotropyUV+uvOffset).rgb*uniforms.vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
uniforms.vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW 
);
#endif
#ifdef REFLECTION
var reflectionOut: reflectionOutParams;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
fragmentInputs.vPositionW
,normalW
,alphaG
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
,reflectionSamplerSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,fragmentInputs.vEnvironmentIrradiance
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,uniforms.reflectionMatrix
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
var sheenOut: sheenOutParams;
#ifdef SHEEN_TEXTURE
var sheenMapData: vec4f=textureSample(sheenSampler,sheenSamplerSampler,fragmentInputs.vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
var sheenMapRoughnessData: vec4f=textureSample(sheenRoughnessSampler,sheenRoughnessSamplerSampler,fragmentInputs.vSheenRoughnessUV+uvOffset)*uniforms.vSheenInfos.w;
#endif
sheenOut=sheenBlock(
uniforms.vSheenColor
#ifdef SHEEN_ROUGHNESS
,uniforms.vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,uniforms.vSheenInfos.y
#endif
,reflectance
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
var clearCoatMapData: vec2f=textureSample(clearCoatSampler,clearCoatSamplerSampler,fragmentInputs.vClearCoatUV+uvOffset).rg*uniforms.vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
var iridescenceOut: iridescenceOutParams;
#ifdef IRIDESCENCE_TEXTURE
var iridescenceMapData: vec2f=textureSample(iridescenceSampler,iridescenceSamplerSampler,fragmentInputs.vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
var iridescenceThicknessMapData: vec2f=textureSample(iridescenceThicknessSampler,iridescenceThicknessSamplerSampler,fragmentInputs.vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
uniforms.vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);var iridescenceIntensity: f32=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
var clearcoatOut: clearcoatOutParams;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
var clearCoatMapRoughnessData: vec4f=textureSample(clearCoatRoughnessSampler,clearCoatRoughnessSamplerSampler,fragmentInputs.vClearCoatRoughnessUV+uvOffset)*uniforms.vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
var clearCoatTintMapData: vec4f=textureSample(clearCoatTintSampler,clearCoatTintSamplerSampler,fragmentInputs.vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
var clearCoatBumpMapData: vec4f=textureSample(clearCoatBumpSampler,clearCoatBumpSamplerSampler,fragmentInputs.vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
fragmentInputs.vPositionW
,geometricNormalW
,viewDirectionW
,uniforms.vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,uniforms.vClearCoatTintParams
,uniforms.clearCoatColorAtDistance
,uniforms.vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,uniforms.vClearCoatBumpInfos
,clearCoatBumpMapData
,fragmentInputs.vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,uniforms.vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,uniforms.normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,uniforms.vReflectionMicrosurfaceInfos
,uniforms.vReflectionInfos
,uniforms.vReflectionColor
,uniforms.vLightingIntensity
,reflectionSampler
,reflectionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,reflectionLowSampler
,reflectionLowSamplerSampler
,reflectionHighSampler
,reflectionHighSamplerSampler
#endif
#ifdef REALTIME_FILTERING
,uniforms.vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,select(-1.,1.,fragmentInputs.frontFacing)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
var subSurfaceOut: subSurfaceOutParams;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
var thicknessMap: vec4f=textureSample(thicknessSampler,thicknessSamplerSampler,fragmentInputs.vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
var refractionIntensityMap: vec4f=textureSample(refractionIntensitySampler,refractionIntensitySamplerSampler,fragmentInputs.vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
var translucencyIntensityMap: vec4f=textureSample(translucencyIntensitySampler,translucencyIntensitySamplerSampler,fragmentInputs.vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
var translucencyColorMap: vec4f=textureSample(translucencyColorSampler,translucencyColorSamplerSampler,fragmentInputs.vTranslucencyColorUV+uvOffset);
#endif
subSurfaceOut=subSurfaceBlock(
uniforms.vSubSurfaceIntensity
,uniforms.vThicknessParam
,uniforms.vTintColor
,normalW
,specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,uniforms.reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,reflectionSamplerSampler
,vReflectionFilteringInfo
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
,irradianceSamplerSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,fragmentInputs.vPositionW
,viewDirectionW
,scene.view
,uniforms.vRefractionInfos
,uniforms.refractionMatrix
,uniforms.vRefractionMicrosurfaceInfos
,uniforms.vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
,refractionSamplerSampler
#ifndef LODBASEDMICROSFURACE
,refractionLowSampler
,refractionLowSamplerSampler
,refractionHighSampler
,refractionHighSamplerSampler
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,uniforms.vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,uniforms.vRefractionPosition
,uniforms.vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,uniforms.vDiffusionDistance
,uniforms.vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
var writeGeometryInfo: f32=select(0.0,1.0,finalColor.a>ALPHATESTVALUE);var fragData: array<vec4<f32>,SCENE_MRT_COUNT>;
#ifdef PREPASS_POSITION
fragData[PREPASS_POSITION_INDEX]= vec4f(fragmentInputs.vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
fragData[PREPASS_LOCAL_POSITION_INDEX] =
vec4f(fragmentInputs.vPosition,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
var a: vec2f=(fragmentInputs.vCurrentPosition.xy/fragmentInputs.vCurrentPosition.w)*0.5+0.5;var b: vec2f=(fragmentInputs.vPreviousPosition.xy/fragmentInputs.vPreviousPosition.w)*0.5+0.5;var velocity: vec2f=abs(a-b);velocity= vec2f(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;fragData[PREPASS_VELOCITY_INDEX]= vec4f(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
var velocity : vec2f=vec2f(0.5)*((fragmentInputs.vPreviousPosition.xy /
fragmentInputs.vPreviousPosition.w) -
(fragmentInputs.vCurrentPosition.xy /
fragmentInputs.vCurrentPosition.w));fragData[PREPASS_VELOCITY_LINEAR_INDEX] =
vec4f(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
var sqAlbedo : vec3f=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
var irradiance : vec3f=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
fragData[0]=vec4f(finalColor.rgb-irradiance,
finalColor.a); 
irradiance/=sqAlbedo;
#else
fragData[0]=finalColor; 
var scatteringDiffusionProfile : f32=255.;
#endif
fragData[PREPASS_IRRADIANCE_INDEX] =
vec4f(clamp(irradiance,vec3f(0.),vec3f(1.)),
writeGeometryInfo*scatteringDiffusionProfile /
255.); 
#else
fragData[0]=vec4f(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
fragData[PREPASS_DEPTH_INDEX]=vec4f(fragmentInputs.vViewPos.z,0.0,0.0,
writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
fragData[PREPASS_SCREENSPACE_DEPTH_INDEX] =
vec4f(fragmentInputs.position.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
fragData[PREPASS_NORMAL_INDEX] =
vec4f(normalW,writeGeometryInfo); 
#else
fragData[PREPASS_NORMAL_INDEX] =
vec4f(normalize((scene.view*vec4f(normalW,0.0)).rgb),
writeGeometryInfo); 
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
fragData[PREPASS_WORLD_NORMAL_INDEX]=vec4f(normalW*0.5+0.5,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
fragData[PREPASS_ALBEDO_SQRT_INDEX] =
vec4f(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
fragData[PREPASS_REFLECTIVITY_INDEX] =
vec4f(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
fragData[PREPASS_REFLECTIVITY_INDEX] =
vec4f(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#if SCENE_MRT_COUNT>0
fragmentOutputs.fragData0=fragData[0];
#endif
#if SCENE_MRT_COUNT>1
fragmentOutputs.fragData1=fragData[1];
#endif
#if SCENE_MRT_COUNT>2
fragmentOutputs.fragData2=fragData[2];
#endif
#if SCENE_MRT_COUNT>3
fragmentOutputs.fragData3=fragData[3];
#endif
#if SCENE_MRT_COUNT>4
fragmentOutputs.fragData4=fragData[4];
#endif
#if SCENE_MRT_COUNT>5
fragmentOutputs.fragData5=fragData[5];
#endif
#if SCENE_MRT_COUNT>6
fragmentOutputs.fragData6=fragData[6];
#endif
#if SCENE_MRT_COUNT>7
fragmentOutputs.fragData7=fragData[7];
#endif
#endif
#if !defined(PREPASS) && !defined(ORDER_INDEPENDENT_TRANSPARENCY)
fragmentOutputs.color=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {fragmentOutputs.frontColor=vec4f(fragmentOutputs.frontColor.rgb+finalColor.rgb*finalColor.a*alphaMultiplier,1.0-alphaMultiplier*(1.0-finalColor.a));} else {fragmentOutputs.backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[L]=w;let B={name:L,shader:w}},8133:function(e,t,i){i.r(t),i.d(t,{pbrVertexShaderWGSL:function(){return a}});var r=i(29427);i(53523),i(94806),i(22221),i(42766),i(10001),i(7694),i(93725),i(54220),i(81206),i(21514),i(26731),i(47659),i(24398),i(18777),i(54394),i(31343),i(50973),i(8772),i(87696),i(90860),i(30037),i(80867),i(44165),i(15991),i(295),i(39017),i(46479),i(5352),i(14413),i(16888),i(96748);let s="pbrVertexShader",n=`#include<pbrUboDeclaration>
#define CUSTOM_VERTEX_BEGIN
attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#ifdef TANGENT
attribute tangent: vec4f;
#endif
#ifdef UV1
attribute uv: vec2f;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute color: vec4f;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vPositionW: vec3f;
#if DEBUGMODE>0
varying vClipSpacePosition: vec4f;
#endif
#ifdef NORMAL
varying vNormalW: vec3f;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vEnvironmentIrradiance: vec3f;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vColor: vec4f;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<lightVxUboDeclaration>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vPositionUVW: vec3f;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vDirectionW: vec3f;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var positionUpdated: vec3f=vertexInputs.position;
#ifdef NORMAL
var normalUpdated: vec3f=vertexInputs.normal;
#endif
#ifdef TANGENT
var tangentUpdated: vec4f=vertexInputs.tangent;
#endif
#ifdef UV1
var uvUpdated: vec2f=vertexInputs.uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vertexOutputs.vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && (defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED) || defined(PREPASS_VELOCITY_LINEAR))
vertexOutputs.vCurrentPosition=scene.viewProjection*finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPreviousPosition=uniforms.previousViewProjection*finalPreviousWorld* vec4f(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);vertexOutputs.vPositionW= worldPos.xyz;
#include<prePassVertex>
#ifdef NORMAL
var normalWorld: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vertexOutputs.vNormalW=normalUpdated/ vec3f(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vertexOutputs.vNormalW=normalize(normalWorld*vertexOutputs.vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vertexOutputs.vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
var reflectionVector: vec3f= (uniforms.reflectionMatrix* vec4f(vertexOutputs.vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vertexOutputs.vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {vertexOutputs.position=scene.viewProjection*worldPos;} else {vertexOutputs.position=scene.viewProjectionR*worldPos;}
#else
vertexOutputs.position=scene.viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vertexOutputs.vClipSpacePosition=vertexOutputs.position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vertexOutputs.vDirectionW=normalize((finalWorld*vec4f(positionUpdated,0.0)).xyz);
#endif
#ifndef UV1
var uvUpdated: vec2f= vec2f(0.,0.);
#endif
#ifdef MAINUV1
vertexOutputs.vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},92374:function(e,t,i){i.r(t),i.d(t,{pickingPixelShaderWGSL:function(){return a}});var r=i(29427);let s="pickingPixelShader",n=`#if defined(INSTANCES)
varying vMeshID: vec4f;
#else
uniform meshID: vec4f;
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#if defined(INSTANCES)
fragmentOutputs.color=input.vMeshID;
#else
fragmentOutputs.color=uniforms.meshID;
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},97740:function(e,t,i){i.r(t),i.d(t,{pickingVertexShaderWGSL:function(){return a}});var r=i(29427);i(10001),i(7694),i(54394),i(31343),i(93725),i(8772),i(87696),i(90860),i(30037),i(80867);let s="pickingVertexShader",n=`attribute position: vec3f;
#if defined(INSTANCES)
attribute instanceMeshID: vec4f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform viewProjection: mat4x4f;
#if defined(INSTANCES)
varying vMeshID: vec4f;
#endif
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld*vec4f(input.position,1.0);vertexOutputs.position=uniforms.viewProjection*worldPos;
#if defined(INSTANCES)
vertexOutputs.vMeshID=input.instanceMeshID;
#endif
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},6914:function(e,t,i){i.r(t),i.d(t,{postprocessVertexShaderWGSL:function(){return a}});var r=i(29427);let s="postprocessVertexShader",n=`attribute position: vec2<f32>;uniform scale: vec2<f32>;varying vUV: vec2<f32>;const madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vUV=(vertexInputs.position*madd+madd)*uniforms.scale;vertexOutputs.position=vec4(vertexInputs.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},3509:function(e,t,i){i.r(t),i.d(t,{proceduralVertexShaderWGSL:function(){return a}});var r=i(29427);let s="proceduralVertexShader",n=`attribute position: vec2f;varying vPosition: vec2f;varying vUV: vec2f;const madd: vec2f= vec2f(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.vPosition=input.position;vertexOutputs.vUV=input.position*madd+madd;vertexOutputs.position= vec4f(input.position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},61232:function(e,t,i){i.r(t),i.d(t,{rgbdDecodePixelShaderWGSL:function(){return a}});var r=i(29427);i(42766);let s="rgbdDecodePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=vec4f(fromRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV)),1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},27881:function(e,t,i){i.r(t),i.d(t,{rgbdEncodePixelShaderWGSL:function(){return a}});var r=i(29427);i(42766);let s="rgbdEncodePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=toRGBD(textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},99640:function(e,t,i){i.r(t),i.d(t,{rsmFullGlobalIlluminationPixelShaderWGSL:function(){return a}});var r=i(29427);let s="rsmFullGlobalIlluminationPixelShader",n=`/**
* The implementation is a direct application of the formula found in http:
*/
varying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionW: texture_2d<f32>;var rsmNormalW: texture_2d<f32>;var rsmFlux: texture_2d<f32>;
#ifdef TRANSFORM_NORMAL
uniform invView: mat4x4f;
#endif
fn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var width: i32= i32(uniforms.rsmInfo.x);var height: i32= i32(uniforms.rsmInfo.y);for (var j: i32=0; j<height; j++) {for (var i: i32=0; i<width; i++) {var uv=vec2<i32>(i,j);var vplPositionW: vec3f=textureLoad(rsmPositionW,uv,0).xyz;var vplNormalW: vec3f=textureLoad(rsmNormalW,uv,0).xyz*2.0-1.0;var vplFlux: vec3f=textureLoad(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
var dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}
return clamp(indirectDiffuse*intensity,0.0,1.0);}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,fragmentInputs.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,fragmentInputs.vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(uniforms.invView* vec4f(normalW,0.)).xyz;
#endif
fragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},4009:function(e,t,i){i.r(t),i.d(t,{rsmGlobalIlluminationPixelShaderWGSL:function(){return a}});var r=i(29427);let s="rsmGlobalIlluminationPixelShader",n=`/**
* The implementation is an application of the formula found in http:
* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).
*/
varying vUV: vec2f;uniform rsmLightMatrix: mat4x4f;uniform rsmInfo: vec4f;uniform rsmInfo2: vec4f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;var rsmPositionWSampler: sampler;var rsmPositionW: texture_2d<f32>;var rsmNormalWSampler: sampler;var rsmNormalW: texture_2d<f32>;var rsmFluxSampler: sampler;var rsmFlux: texture_2d<f32>;var rsmSamples: texture_2d<f32>;
#ifdef TRANSFORM_NORMAL
uniform invView: mat4x4f;
#endif
fn mod289(x: f32)->f32{return x-floor(x*(1.0/289.0))*289.0;}
fn mod289Vec4(x: vec4f)->vec4f {return x-floor(x*(1.0/289.0))* 289.0;}
fn perm(x: vec4f)->vec4f {return mod289Vec4(((x*34.0)+1.0)*x) ;}
fn noise(p: vec3f)->f32{var a: vec3f=floor(p);var d: vec3f=p-a;d=d*d*(3.0-2.0*d);var b: vec4f=a.xxyy+ vec4f(0.0,1.0,0.0,1.0);var k1: vec4f=perm(b.xyxy);var k2: vec4f=perm(k1.xyxy+b.zzww);var c: vec4f=k2+a.zzzz;var k3: vec4f=perm(c);var k4: vec4f=perm(c+1.0);var o1: vec4f=fract(k3*(1.0/41.0));var o2: vec4f=fract(k4*(1.0/41.0));var o3: vec4f=o2*d.z+o1*(1.0-d.z);var o4: vec2f=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}
fn computeIndirect(p: vec3f,n: vec3f)->vec3f {var indirectDiffuse: vec3f= vec3f(0.);var numSamples: i32= i32(uniforms.rsmInfo.x);var radius: f32=uniforms.rsmInfo.y;var intensity: f32=uniforms.rsmInfo.z;var edgeArtifactCorrection: f32=uniforms.rsmInfo.w;var texRSM: vec4f=uniforms.rsmLightMatrix* vec4f(p,1.);texRSM=vec4f(texRSM.xy/texRSM.w,texRSM.z,texRSM.w);texRSM=vec4f(texRSM.xy*0.5+0.5,texRSM.z,texRSM.w);var angle: f32=noise(p*uniforms.rsmInfo2.x);var c: f32=cos(angle);var s: f32=sin(angle);for (var i: i32=0; i<numSamples; i++) {var rsmSample: vec3f=textureLoad(rsmSamples,vec2<i32>(i,0),0).xyz;var weightSquare: f32=rsmSample.z;if (uniforms.rsmInfo2.y==1.0){rsmSample=vec3f(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c,rsmSample.z);}
var uv: vec2f=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) {continue;}
var vplPositionW: vec3f=textureSampleLevel(rsmPositionW,rsmPositionWSampler,uv,0.).xyz;var vplNormalW: vec3f=textureSampleLevel(rsmNormalW,rsmNormalWSampler,uv,0.).xyz*2.0-1.0;var vplFlux: vec3f=textureSampleLevel(rsmFlux,rsmFluxSampler,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
var dist2: f32=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}
return clamp(indirectDiffuse*intensity,vec3f(0.0),vec3f(1.0));}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var positionW: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).xyz;var normalW: vec3f=textureSample(normalSampler,normalSamplerSampler,input.vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(uniforms.invView* vec4f(normalW,0.)).xyz;
#endif
fragmentOutputs.color=vec4f(computeIndirect(positionW,normalW),1.0);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},71714:function(e,t,i){i.r(t),i.d(t,{screenSpaceReflection2PixelShaderWGSL:function(){return a}});var r=i(29427);i(42766),i(41435),i(60015);let s="screenSpaceReflection2PixelShader",n=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;
#ifdef SSR_SUPPORTED
var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
var backDepthSampler: texture_2d<f32>;uniform backSizeFactor: f32;
#endif
#ifdef SSR_USE_ENVIRONMENT_CUBE
var envCubeSamplerSampler: sampler;var envCubeSampler: texture_cube<f32>;
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
uniform vReflectionPosition: vec3f;uniform vReflectionSize: vec3f;
#endif
#endif
uniform view: mat4x4f;uniform invView: mat4x4f;uniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;uniform projectionPixel: mat4x4f;uniform nearPlaneZ: f32;uniform farPlaneZ: f32;uniform stepSize: f32;uniform maxSteps: f32;uniform strength: f32;uniform thickness: f32;uniform roughnessFactor: f32;uniform reflectionSpecularFalloffExponent: f32;uniform maxDistance: f32;uniform selfCollisionNumSkip: f32;uniform reflectivityThreshold: f32;
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
fn hash(a: vec3f)->vec3f
{var result=fract(a*0.8);result+=dot(result,result.yxz+19.19);return fract((result.xxy+result.yxx)*result.zyx);}
fn computeAttenuationForIntersection(ihitPixel: vec2f,hitUV: vec2f,vsRayOrigin: vec3f,vsHitPoint: vec3f,reflectionVector: vec3f,maxRayDistance: f32,numIterations: f32)->f32 {var attenuation: f32=1.0;
#ifdef SSR_ATTENUATE_SCREEN_BORDERS
var dCoords: vec2f=smoothstep(vec2f(0.2),vec2f(0.6),abs( vec2f(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS
attenuation*=1.0-(numIterations/uniforms.maxSteps);
#endif
#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION
var reflectionNormal: vec3f=texelFetch(normalSampler,hitPixel,0).xyz;var directionBasedAttenuation: f32=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;
#endif
return attenuation;}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#ifdef SSR_SUPPORTED
var colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);var color: vec3f=colorFull.rgb;var reflectivity: vec4f=textureSampleLevel(reflectivitySampler,reflectivitySamplerSampler,input.vUV,0.0);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {
#ifdef SSR_USE_BLUR
fragmentOutputs.color= vec4f(0.);
#else
fragmentOutputs.color=colorFull;
#endif
return fragmentOutputs;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpaceVec3(color);
#endif
var texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz; 
#ifdef SSR_DECODE_NORMAL
csNormal=csNormal*2.0-1.0;
#endif
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
csNormal=(uniforms.view* vec4f(csNormal,0.0)).xyz;
#endif
var depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);
#endif
var csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);
#ifdef ORTHOGRAPHIC_CAMERA
var csViewDirection: vec3f= vec3f(0.,0.,1.);
#else
var csViewDirection: vec3f=normalize(csPosition);
#endif
var csReflectedVector: vec3f=reflect(csViewDirection,csNormal);
#ifdef SSR_USE_ENVIRONMENT_CUBE
var wReflectedVector: vec3f=(uniforms.invView* vec4f(csReflectedVector,0.0)).xyz;
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
var worldPos: vec4f=uniforms.invView* vec4f(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),uniforms.vReflectionSize,uniforms.vReflectionPosition);
#endif
#ifdef SSR_INVERTCUBICMAP
wReflectedVector.y*=-1.0;
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
wReflectedVector.z*=-1.0;
#endif
var envColor: vec3f=textureSampleLevel(envCubeSampler,envCubeSamplerSampler,wReflectedVector,0.0).xyz;
#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE
envColor=toLinearSpaceVec3(envColor);
#endif
#else
var envColor: vec3f=color;
#endif
var reflectionAttenuation: f32=1.0;var rayHasHit: bool=false;var startPixel: vec2f;var hitPixel: vec2f;var hitPoint: vec3f;var numIterations: f32;
#ifdef SSRAYTRACE_DEBUG
var debugColor: vec3f;
#endif
#ifdef SSR_ATTENUATE_FACING_CAMERA
reflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));
#endif
if (reflectionAttenuation>0.0) {
#ifdef SSR_USE_BLUR
var jitt: vec3f= vec3f(0.);
#else
var roughness: f32=1.0-reflectivity.a;var jitt: vec3f=mix( vec3f(0.0),hash(csPosition)- vec3f(0.5),roughness)*uniforms.roughnessFactor; 
#endif
var uv2: vec2f=input.vUV*texSize;var c: f32=(uv2.x+uv2.y)*0.25;var jitter: f32=((c)%(1.0)); 
rayHasHit=traceScreenSpaceRay1(
csPosition,
normalize(csReflectedVector+jitt),
uniforms.projectionPixel,
depthSampler,
texSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
backDepthSampler,
uniforms.backSizeFactor,
#endif
uniforms.thickness,
uniforms.nearPlaneZ,
uniforms.farPlaneZ,
uniforms.stepSize,
jitter,
uniforms.maxSteps,
uniforms.maxDistance,
uniforms.selfCollisionNumSkip,
&startPixel,
&hitPixel,
&hitPoint,
&numIterations
#ifdef SSRAYTRACE_DEBUG
,&debugColor
#endif
);}
#ifdef SSRAYTRACE_DEBUG
fragmentOutputs.color= vec4f(debugColor,1.);return fragmentOutputs;
#endif
var F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var SSR: vec3f=envColor;if (rayHasHit) {var reflectedColor: vec3f=textureLoad(textureSampler,vec2<i32>(hitPixel),0).rgb;
#ifdef SSR_INPUT_IS_GAMMA_SPACE
reflectedColor=toLinearSpaceVec3(reflectedColor);
#endif
reflectionAttenuation*=computeAttenuationForIntersection(hitPixel,hitPixel/texSize,csPosition,hitPoint,csReflectedVector,uniforms.maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}
#ifndef SSR_BLEND_WITH_FRESNEL
SSR*=fresnel;
#endif
#ifdef SSR_USE_BLUR
var blur_radius: f32=0.0;var roughness: f32=1.0-reflectivity.a*(1.0-uniforms.roughnessFactor);if (roughness>0.001) {var cone_angle: f32=min(roughness,0.999)*3.14159265*0.5;var cone_len: f32=distance(startPixel,hitPixel);var op_len: f32=2.0*tan(cone_angle)*cone_len; 
var a: f32=op_len;var h: f32=cone_len;var a2: f32=a*a;var fh2: f32=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}
fragmentOutputs.color= vec4f(SSR,blur_radius/255.0); 
#else
#ifdef SSR_BLEND_WITH_FRESNEL
var reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#else
var reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#endif
var colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpaceVec3(finalColor);
#endif
fragmentOutputs.color= vec4f(finalColor,colorFull.a);
#endif
#else
fragmentOutputs.color=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},11105:function(e,t,i){i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShaderWGSL:function(){return a}});var r=i(29427);let s="screenSpaceReflection2BlurPixelShader",n=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;varying vUV: vec2f;uniform texelOffsetScale: vec2f;const weights: array<f32,8>=array<f32,8>(0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);fn processSample(uv: vec2f,i: f32,stepSize: vec2f,accumulator: ptr<function,vec4f>,denominator: ptr<function,f32>)
{var offsetUV: vec2f=stepSize*i+uv;var coefficient: f32=weights[ i32(2.0-abs(i))];*accumulator+=textureSampleLevel(textureSampler,textureSamplerSampler,offsetUV,0.0)*coefficient;*denominator+=coefficient;}
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var colorFull: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0);if (dot(colorFull, vec4f(1.0))==0.0) {fragmentOutputs.color=colorFull;return fragmentOutputs;}
var blurRadius: f32=colorFull.a*255.0; 
var stepSize: vec2f=uniforms.texelOffsetScale.xy*blurRadius;var accumulator: vec4f=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0)*0.214607;var denominator: f32=0.214607;processSample(input.vUV,1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,1.0*2.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*0.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.2,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.4,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.6,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*1.8,stepSize,&accumulator,&denominator);processSample(input.vUV,-1.0*2.0,stepSize,&accumulator,&denominator);fragmentOutputs.color= vec4f(accumulator.rgb/denominator,colorFull.a);}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},31176:function(e,t,i){i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShaderWGSL:function(){return a}});var r=i(29427);i(42766),i(41435),i(60015);let s="screenSpaceReflection2BlurCombinerPixelShader",n=`var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>; 
var mainSamplerSampler: sampler;var mainSampler: texture_2d<f32>;var reflectivitySamplerSampler: sampler;var reflectivitySampler: texture_2d<f32>;uniform strength: f32;uniform reflectionSpecularFalloffExponent: f32;uniform reflectivityThreshold: f32;varying vUV: vec2f;
#include<helperFunctions>
#ifdef SSR_BLEND_WITH_FRESNEL
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
uniform projection: mat4x4f;uniform invProjectionMatrix: mat4x4f;var normalSampler: texture_2d<f32>;var depthSampler: texture_2d<f32>;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
uniform nearPlaneZ: f32;uniform farPlaneZ: f32;
#endif
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#ifdef SSRAYTRACE_DEBUG
fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,input.vUV);
#else
var SSR: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;var color: vec4f=textureSample(mainSampler,textureSamplerSampler,input.vUV);var reflectivity: vec4f=textureSample(reflectivitySampler,reflectivitySamplerSampler,input.vUV);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=uniforms.reflectivityThreshold) {fragmentOutputs.color=color;return fragmentOutputs;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpaceVec4(color);
#endif
#ifdef SSR_BLEND_WITH_FRESNEL
var texSize: vec2f= vec2f(textureDimensions(depthSampler,0));var csNormal: vec3f=textureLoad(normalSampler,vec2<i32>(input.vUV*texSize),0).xyz;var depth: f32=textureLoad(depthSampler,vec2<i32>(input.vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,uniforms.nearPlaneZ,uniforms.farPlaneZ);
#endif
var csPosition: vec3f=computeViewPosFromUVDepth(input.vUV,depth,uniforms.projection,uniforms.invProjectionMatrix);var csViewDirection: vec3f=normalize(csPosition);var F0: vec3f=reflectivity.rgb;var fresnel: vec3f=fresnelSchlickGGXVec3(max(dot(csNormal,-csViewDirection),0.0),F0, vec3f(1.));var reflectionMultiplier: vec3f=clamp(pow(fresnel*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#else
var reflectionMultiplier: vec3f=clamp(pow(reflectivity.rgb*uniforms.strength, vec3f(uniforms.reflectionSpecularFalloffExponent)),vec3f(0.0),vec3f(1.0));
#endif
var colorMultiplier: vec3f=1.0-reflectionMultiplier;var finalColor: vec3f=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpaceVec3(finalColor);
#endif
fragmentOutputs.color= vec4f(finalColor,color.a);
#endif
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},7434:function(e,t,i){i.r(t),i.d(t,{shadowMapPixelShaderWGSL:function(){return l}});var r=i(29427);i(758);let s=`fn bayerDither2(_P: vec2f)->f32 {return ((2.0*_P.y+_P.x+1.0)%(4.0));}
fn bayerDither4(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5*((_P)%(4.0))); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
fn bayerDither8(_P: vec2f)->f32 {var P1: vec2f=((_P)%(2.0)); 
var P2: vec2f=floor(0.5 *((_P)%(4.0))); 
var P4: vec2f=floor(0.25*((_P)%(8.0))); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;r.v.IncludesShadersStoreWGSL.bayerDitherFunctions=s;let n=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform softTransparentShadowSM: vec2f;
#endif
varying vDepthMetricSM: f32;
#if SM_USEDISTANCE==1
uniform lightDataSM: vec3f;varying vPositionWSM: vec3f;
#endif
uniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying zSM: f32;
#endif
`;r.v.IncludesShadersStoreWGSL.shadowMapFragmentExtraDeclaration=n,i(71030),i(24228),i(3342);let a="shadowMapPixelShader",o=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
var opacityMap: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,fragmentInputs.vUV);var alphaFromAlphaTexture: f32=opacityMap.a;
#if SM_SOFTTRANSPARENTSHADOW==1
if (uniforms.softTransparentShadowSM.y==1.0) {opacityMap=vec4f(opacityMap.rgb* vec3f(0.3,0.59,0.11),opacityMap.a);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}
#endif
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE) {discard;}
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x*alphaFromAlphaTexture) {discard;}
#else
if ((bayerDither8(floor(((fragmentInputs.position.xy)%(8.0)))))/64.0>=uniforms.softTransparentShadowSM.x) {discard;} 
#endif
#endif
#include<shadowMapFragment>
}`;r.v.ShadersStoreWGSL[a]=o;let l={name:a,shader:o}},48592:function(e,t,i){i.r(t),i.d(t,{shadowMapVertexShaderWGSL:function(){return l}});var r=i(29427);i(10001),i(7694),i(54394),i(31343),i(42766),i(74575),i(31896);let s=`#if SM_NORMALBIAS==1
uniform lightDataSM: vec3f;
#endif
uniform biasAndScaleSM: vec3f;uniform depthValuesSM: vec2f;varying vDepthMetricSM: f32;
#if SM_USEDISTANCE==1
varying vPositionWSM: vec3f;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying zSM: f32;
#endif
`;r.v.IncludesShadersStoreWGSL.shadowMapVertexExtraDeclaration=s,i(47659),i(8772),i(87696),i(90860),i(30037),i(80867);let n=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
var worldLightDirSM: vec3f=normalize(-uniforms.lightDataSM.xyz);
#else
var directionToLightSM: vec3f=uniforms.lightDataSM.xyz-worldPos.xyz;var worldLightDirSM: vec3f=normalize(directionToLightSM);
#endif
var ndlSM: f32=dot(vNormalW,worldLightDirSM);var sinNLSM: f32=sqrt(1.0-ndlSM*ndlSM);var normalBiasSM: f32=uniforms.biasAndScaleSM.y*sinNLSM;worldPos=vec4f(worldPos.xyz-vNormalW*normalBiasSM,worldPos.w);
#endif
`;r.v.IncludesShadersStoreWGSL.shadowMapVertexNormalBias=n,i(58530),i(46479);let a="shadowMapVertexShader",o=`attribute position: vec3f;
#ifdef NORMAL
attribute normal: vec3f;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute world0: vec4f;attribute world1: vec4f;attribute world2: vec4f;attribute world3: vec4f;
#endif
#include<helperFunctions>
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
#ifdef ALPHATEXTURE
varying vUV: vec2f;uniform diffuseMatrix: mat4x4f;
#ifdef UV1
attribute uv: vec2f;
#endif
#ifdef UV2
attribute uv2: vec2f;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {var positionUpdated: vec3f=input.position;
#ifdef UV1
var uvUpdated: vec2f=input.uv;
#endif
#ifdef NORMAL
var normalUpdated: vec3f=input.normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
var worldPos: vec4f=finalWorld* vec4f(positionUpdated,1.0);
#ifdef NORMAL
var normWorldSM: mat3x3f= mat3x3f(finalWorld[0].xyz,finalWorld[1].xyz,finalWorld[2].xyz);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
var vNormalW: vec3f=normalUpdated/ vec3f(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
var vNormalW: vec3f=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
vertexOutputs.position=scene.viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(uvUpdated,1.0,0.0)).xy;
#endif
#ifdef UV2
vertexOutputs.vUV= (uniforms.diffuseMatrix* vec4f(input.uv2,1.0,0.0)).xy;
#endif
#endif
#include<clipPlaneVertex>
}`;r.v.ShadersStoreWGSL[a]=o;let l={name:a,shader:o}},6459:function(e,t,i){i.r(t),i.d(t,{sharpenPixelShaderWGSL:function(){return a}});var r=i(29427);let s="sharpenPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform screenSize: vec2f;uniform sharpnessAmounts: vec2f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var onePixel: vec2f= vec2f(1.0,1.0)/uniforms.screenSize;var color: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV);var edgeDetection: vec4f=textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,-1)) +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(-1,0)) +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(1,0)) +
textureSample(textureSampler,textureSamplerSampler,input.vUV+onePixel*vec2f(0,1)) -
color*4.0;fragmentOutputs.color=max(vec4f(color.rgb*uniforms.sharpnessAmounts.y,color.a)-(uniforms.sharpnessAmounts.x* vec4f(edgeDetection.rgb,0)),vec4f(0.));}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},34560:function(e,t,i){i.r(t),i.d(t,{spritesPixelShaderWGSL:function(){return o}});var r=i(29427);i(1741),i(50973),i(92907),i(33220);let s=`#ifdef IMAGEPROCESSINGPOSTPROCESS
fragmentOutputs.color=vec4f(pow(fragmentOutputs.color.rgb, vec3f(2.2)),fragmentOutputs.color.a);
#endif
`;r.v.IncludesShadersStoreWGSL.imageProcessingCompatibility=s;let n="spritesPixelShader",a=`uniform alphaTest: i32;varying vColor: vec4f;varying vUV: vec2f;var diffuseSamplerSampler: sampler;var diffuseSampler: texture_2d<f32>;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
#ifdef PIXEL_PERFECT
fn uvPixelPerfect(uv: vec2f)->vec2f {var res: vec2f= vec2f(textureDimensions(diffuseSampler,0));var uvTemp=uv*res;var seam: vec2f=floor(uvTemp+0.5);uvTemp=seam+clamp((uvTemp-seam)/fwidth(uvTemp),vec2f(-0.5),vec2f(0.5));return uvTemp/res;}
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#ifdef PIXEL_PERFECT
var uv: vec2f=uvPixelPerfect(input.vUV);
#else
var uv: vec2f=input.vUV;
#endif
var color: vec4f=textureSample(diffuseSampler,diffuseSamplerSampler,uv);var fAlphaTest: f32= f32(uniforms.alphaTest);if (fAlphaTest != 0.)
{if (color.a<0.95) {discard;}}
color*=input.vColor;
#include<logDepthFragment>
#include<fogFragment>
fragmentOutputs.color=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStoreWGSL[n]=a;let o={name:n,shader:a}},39684:function(e,t,i){i.r(t),i.d(t,{spritesVertexShaderWGSL:function(){return a}});var r=i(29427);i(24398),i(50973),i(96748);let s="spritesVertexShader",n=`attribute position: vec4f;attribute options: vec2f;attribute offsets: vec2f;attribute inverts: vec2f;attribute cellInfo: vec4f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;varying vUV: vec2f;varying vColor: vec4f;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
var viewPos: vec3f=(uniforms.view* vec4f(input.position.xyz,1.0)).xyz; 
var cornerPos: vec2f;var angle: f32=input.position.w;var size: vec2f= vec2f(input.options.x,input.options.y);var offset: vec2f=input.offsets.xy;cornerPos= vec2f(offset.x-0.5,offset.y -0.5)*size;var rotatedCorner: vec3f;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0); 
vertexOutputs.vColor=input.color;var uvOffset: vec2f= vec2f(abs(offset.x-input.inverts.x),abs(1.0-offset.y-input.inverts.y));var uvPlace: vec2f=input.cellInfo.xy;var uvSize: vec2f=input.cellInfo.zw;vertexOutputs.vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vertexOutputs.vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vertexOutputs.vFogDistance=viewPos;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},33212:function(e,t,i){i.r(t),i.d(t,{ssao2PixelShaderWGSL:function(){return a}});var r=i(29427);let s="ssao2PixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;
#ifdef SSAO
const scales: array<f32,16>=array<f32,16>(
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);uniform near: f32;uniform radius: f32;var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;var randomSamplerSampler: sampler;var randomSampler: texture_2d<f32>;var normalSamplerSampler: sampler;var normalSampler: texture_2d<f32>;uniform randTextureTiles: f32;uniform samplesFactor: f32;uniform sampleSphere: array<vec3f,SAMPLES>;uniform totalStrength: f32;uniform base: f32;uniform xViewport: f32;uniform yViewport: f32;uniform depthProjection: mat3x3f;uniform maxZ: f32;uniform minZAspect: f32;uniform texelSize: vec2f;uniform projection: mat4x4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var random: vec3f=textureSampleLevel(randomSampler,randomSamplerSampler,input.vUV*uniforms.randTextureTiles,0.0).rgb;var depth: f32=textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r;var depthSign: f32=sign(depth);depth=depth*depthSign;var normal: vec3f=textureSampleLevel(normalSampler,normalSamplerSampler,input.vUV,0.0).rgb;var occlusion: f32=0.0;var correctedRadius: f32=min(uniforms.radius,uniforms.minZAspect*depth/uniforms.near);var vViewRay: vec3f= vec3f((input.vUV.x*2.0-1.0)*uniforms.xViewport,(input.vUV.y*2.0-1.0)*uniforms.yViewport,depthSign);var vDepthFactor: vec3f=uniforms.depthProjection* vec3f(1.0,1.0,depth);var origin: vec3f=vViewRay*vDepthFactor;var rvec: vec3f=random*2.0-1.0;rvec.z=0.0;var dotProduct: f32=dot(rvec,normal);rvec=select( vec3f(-rvec.y,0.0,rvec.x),rvec,1.0-abs(dotProduct)>1e-2);var tangent: vec3f=normalize(rvec-normal*dot(rvec,normal));var bitangent: vec3f=cross(normal,tangent);var tbn: mat3x3f= mat3x3f(tangent,bitangent,normal);var difference: f32;for (var i: i32=0; i<SAMPLES; i++) {var samplePosition: vec3f=scales[(i+ i32(random.x*16.0)) % 16]*tbn*uniforms.sampleSphere[(i+ i32(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;var offset: vec4f= vec4f(samplePosition,1.0);offset=uniforms.projection*offset;offset=vec4f(offset.xyz/offset.w,offset.w);offset=vec4f(offset.xy*0.5+0.5,offset.z,offset.w);if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}
var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;var rangeCheck: f32=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}
occlusion=occlusion*(1.0-smoothstep(uniforms.maxZ*0.75,uniforms.maxZ,depth));var ao: f32=1.0-uniforms.totalStrength*occlusion*uniforms.samplesFactor;var result: f32=clamp(ao+uniforms.base,0.0,1.0);fragmentOutputs.color= vec4f( vec3f(result),1.0);}
#else
#ifdef BLUR
uniform outSize: f32;uniform soften: f32;uniform tolerance: f32;uniform samples: i32;
#ifndef BLUR_BYPASS
var depthSamplerSampler: sampler;var depthSampler: texture_2d<f32>;
#ifdef BLUR_LEGACY
fn blur13Bilateral(image: texture_2d<f32>,imageSampler: sampler,uv: vec2f,step: vec2f)->f32 {var result: f32=0.0;var off1: vec2f= vec2f(1.411764705882353)*step;var off2: vec2f= vec2f(3.2941176470588234)*step;var off3: vec2f= vec2f(5.176470588235294)*step;var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv,0.0).r);var sampleDepth: f32;var weight: f32;var weightSum: f32=30.0;result+=textureSampleLevel(image,imageSampler,uv,0.0).r*30.0;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv+off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureSampleLevel(image,imageSampler,uv-off1,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off2,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv+off3,0.0).r*weight;sampleDepth=abs(textureSampleLevel(depthSampler,depthSamplerSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureSampleLevel(image,imageSampler,uv-off3,0.0).r*weight;return result/weightSum;}
#endif
#endif
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var result: f32=0.0;
#ifdef BLUR_BYPASS
result=textureSampleLevel(textureSampler,textureSamplerSampler,input.vUV,0.0).r;
#else
#ifdef BLUR_H
var step: vec2f= vec2f(1.0/uniforms.outSize,0.0);
#else
var step: vec2f= vec2f(0.0,1.0/uniforms.outSize);
#endif
#ifdef BLUR_LEGACY
result=blur13Bilateral(textureSampler,textureSamplerSampler,input.vUV,step);
#else
var compareDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,input.vUV,0.0).r);var weightSum: f32=0.0;for (var i: i32=-uniforms.samples; i<uniforms.samples; i+=2)
{var samplePos: vec2f=input.vUV+step*( f32(i)+0.5);var sampleDepth: f32=abs(textureSampleLevel(depthSampler,depthSamplerSampler,samplePos,0.0).r);var falloff: f32=smoothstep(0.0,
f32(uniforms.samples),
f32(uniforms.samples)-abs( f32(i))*uniforms.soften);var minDivider: f32=uniforms.tolerance*0.5+0.003;var weight: f32=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureSampleLevel(textureSampler,textureSamplerSampler,samplePos,0.0).r*weight;weightSum+=weight;}
result/=weightSum;
#endif
#endif
fragmentOutputs.color=vec4f(result,result,result,1.0);}
#endif
#endif
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},66393:function(e,t,i){i.r(t),i.d(t,{ssaoCombinePixelShaderWGSL:function(){return a}});var r=i(29427);let s="ssaoCombinePixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;var originalColorSampler: sampler;var originalColor: texture_2d<f32>;uniform viewport: vec4f;
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
var ssaoColor: vec4f=textureSample(textureSampler,textureSamplerSampler,uniforms.viewport.xy+input.vUV*uniforms.viewport.zw);var sceneColor: vec4f=textureSample(originalColor,originalColorSampler,input.vUV);fragmentOutputs.color=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},67169:function(e,t,i){i.r(t),i.d(t,{tonemapPixelShaderWGSL:function(){return a}});var r=i(29427);let s="tonemapPixelShader",n=`varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform _ExposureAdjustment: f32;
#if defined(HABLE_TONEMAPPING)
const A: f32=0.15;const B: f32=0.50;const C: f32=0.10;const D: f32=0.20;const E: f32=0.02;const F: f32=0.30;const W: f32=11.2;
#endif
fn Luminance(c: vec3f)->f32
{return dot(c, vec3f(0.22,0.707,0.071));}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var colour: vec3f=textureSample(textureSampler,textureSamplerSampler,input.vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
var lum: f32=Luminance(colour.rgb); 
var lumTm: f32=lum*uniforms._ExposureAdjustment;var scale: f32=lumTm/(1.0+lumTm); 
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=uniforms._ExposureAdjustment;const ExposureBias: f32=2.0;var x: vec3f=ExposureBias*colour;var curr: vec3f=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x= vec3f(W,W,W);var whiteScale: vec3f=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=uniforms._ExposureAdjustment;var X: vec3f=max( vec3f(0.0,0.0,0.0),colour-0.004);var retColor: vec3f=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour= vec3f(1.0,1.0,1.0)-exp2(-uniforms._ExposureAdjustment*colour);
#endif
fragmentOutputs.color= vec4f(colour.rgb,1.0);}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},92516:function(e,t,i){i.r(t),i.d(t,{vrDistortionCorrectionPixelShaderWGSL:function(){return a}});var r=i(29427);let s="vrDistortionCorrectionPixelShader",n=`#define DISABLE_UNIFORMITY_ANALYSIS
varying vUV: vec2f;var textureSamplerSampler: sampler;var textureSampler: texture_2d<f32>;uniform LensCenter: vec2f;uniform Scale: vec2f;uniform ScaleIn: vec2f;uniform HmdWarpParam: vec4f;fn HmdWarp(in01: vec2f)->vec2f {var theta: vec2f=(in01-uniforms.LensCenter)*uniforms.ScaleIn; 
var rSq: f32=theta.x*theta.x+theta.y*theta.y;var rvector: vec2f=theta*(uniforms.HmdWarpParam.x+uniforms.HmdWarpParam.y*rSq+uniforms.HmdWarpParam.z*rSq*rSq+uniforms.HmdWarpParam.w*rSq*rSq*rSq);return uniforms.LensCenter+uniforms.Scale*rvector;}
#define CUSTOM_FRAGMENT_DEFINITIONS
@fragment
fn main(input: FragmentInputs)->FragmentOutputs {var tc: vec2f=HmdWarp(input.vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0) {fragmentOutputs.color=vec4f(0.0,0.0,0.0,0.0);}
else{fragmentOutputs.color=textureSample(textureSampler,textureSamplerSampler,tc);}}`;r.v.ShadersStoreWGSL[s]=n;let a={name:s,shader:n}},30839:function(e,t,i){var r=i(29427);i(16282);let s=`layout(std140,column_major) uniform;uniform Material
{uniform vec4 vPrimaryColor;uniform vec4 vPrimaryColorShadow;uniform vec2 vDiffuseInfos;uniform vec2 vReflectionInfos;uniform mat4 diffuseMatrix;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;uniform float pointSize;uniform float shadowLevel;uniform float alpha;uniform vec3 vBackgroundCenter;uniform vec4 vReflectionControl;uniform vec2 projectedGroundInfos;};
#include<sceneUboDeclaration>
`;r.v.IncludesShadersStore.backgroundUboDeclaration=s},44228:function(e,t,i){var r=i(29427);let s=`#ifdef WEBGL2
uniform vec4 color;uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#else
layout(std140,column_major) uniform;uniform BoundingBoxRenderer {vec4 color;mat4 world;mat4 viewProjection;mat4 viewProjectionR;};
#endif
`;r.v.IncludesShadersStore.boundingBoxRendererUboDeclaration=s},2466:function(e,t,i){var r=i(29427);let s=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {float Nx=normal.x;float Ny=normal.y;float Nz=normal.z;vec3 C1=vSphericalZZ.rgb;vec3 Cx=vSphericalX.rgb;vec3 Cy=vSphericalY.rgb;vec3 Cz=vSphericalZ.rgb;vec3 Cxx_zz=vSphericalXX_ZZ.rgb;vec3 Cyy_zz=vSphericalYY_ZZ.rgb;vec3 Cxy=vSphericalXY.rgb;vec3 Cyz=vSphericalYZ.rgb;vec3 Czx=vSphericalZX.rgb;vec3 a1=Cyy_zz*Ny+Cy;vec3 a2=Cyz*Nz+a1;vec3 b1=Czx*Nz+Cx;vec3 b2=Cxy*Ny+b1;vec3 b3=Cxx_zz*Nx+b2;vec3 t1=Cz *Nz+C1;vec3 t2=a2 *Ny+t1;vec3 t3=b3 *Nx+t2;return t3;}
#endif
#endif
`;r.v.IncludesShadersStore.harmonicsFunctions=s},51940:function(e,t,i){var r=i(29427);let s=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
float radicalInverse_VdC(uint bits) 
{bits=(bits<<16u) | (bits>>16u);bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);return float(bits)*2.3283064365386963e-10; }
vec2 hammersley(uint i,uint N)
{return vec2(float(i)/float(N),radicalInverse_VdC(i));}
#else
float vanDerCorpus(int n,int base)
{float invBase=1.0/float(base);float denom =1.0;float result =0.0;for(int i=0; i<32; ++i)
{if(n>0)
{denom =mod(float(n),2.0);result+=denom*invBase;invBase=invBase/2.0;n =int(float(n)/2.0);}}
return result;}
vec2 hammersley(int i,int N)
{return vec2(float(i)/float(N),vanDerCorpus(i,2));}
#endif
float log4(float x) {return log2(x)/2.;}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 result=vec3(0.0);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 Ls=hemisphereCosSample(Xi);Ls=normalize(Ls);vec3 Ns=vec3(0.,0.,1.);float NoL=dot(Ns,Ls);if (NoL>0.) {float pdf_inversed=PI/NoL;float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(l,0.0,maxLevel);vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;}}
result=result*NUM_SAMPLES_FLOAT_INVERSED;return result;}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{vec3 n=normalize(inputN);vec3 c=textureCube(inputTexture,n).rgb; 
if (alphaG==0.) {
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;} else {vec3 result=vec3(0.);vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);tangent=normalize(cross(tangent,n));vec3 bitangent=cross(n,tangent);mat3 tbn=mat3(tangent,bitangent,n);float maxLevel=filteringInfo.y;float dim0=filteringInfo.x;float omegaP=(4.*PI)/(6.*dim0*dim0);float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{vec2 Xi=hammersley(i,NUM_SAMPLES);vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);float NoV=1.;float NoH=H.z;float NoH2=H.z*H.z;float NoL=2.*NoH2-1.;vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);L=normalize(L);if (NoL>0.) {float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;float l=log4(omegaS)-log4(omegaP)+log4(K);float mipLevel=clamp(float(l),0.0,maxLevel);weight+=NoL;vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;}}
result=result/weight;return result;}}
#endif
#endif
`;r.v.IncludesShadersStore.hdrFilteringFunctions=s},20577:function(e,t,i){var r=i(29427);let s=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;r.v.IncludesShadersStore.imageProcessingCompatibility=s},52540:function(e,t,i){var r=i(29427);let s=`vec3 hemisphereCosSample(vec2 u) {float phi=2.*PI*u.x;float cosTheta2=1.-u.y;float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {float phi=2.*PI*u.x;float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));float cosTheta=sqrt(cosTheta2);float sinTheta=sqrt(1.-cosTheta2);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;float sinTheta=pow(u.y,a/(2.*a+1.));float cosTheta=sqrt(1.-sinTheta*sinTheta);return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);}`;r.v.IncludesShadersStore.importanceSampling=s},18503:function(e,t,i){i(29427).v.IncludesShadersStore.kernelBlurVaryingDeclaration="varying vec2 sampleCoord{X};"},43870:function(e,t,i){i.r(t),i.d(t,{packingFunctions:function(){return a}});var r=i(29427);let s="packingFunctions",n=`vec4 pack(float depth)
{const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
float unpack(vec4 color)
{const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(color,bit_shift);}`;r.v.IncludesShadersStore[s]=n;let a={name:s,shader:n}},35825:function(e,t,i){var r=i(29427);let s=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {vec2 UV=vec2(NdotV,perceptualRoughness);vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{float c=1.0-NdotV;float c3=c*c*c;return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;return sheenEnvironmentReflectance;}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);vec3 getIORTfromAirToSurfaceR0(vec3 f0) {vec3 sqrtF0=sqrt(f0);return (1.+sqrtF0)/(1.-sqrtF0);}
vec3 getR0fromIORs(vec3 iorT,float iorI) {return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));}
float getR0fromIORs(float iorT,float iorI) {return square((iorT-iorI)/(iorT+iorI));}
vec3 evalSensitivity(float opd,vec3 shift) {float phase=2.0*PI*opd*1.0e-9;const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));xyz/=1.0685e-7;vec3 srgb=XYZ_TO_REC709*xyz;return srgb;}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {vec3 I=vec3(1.0);float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));float cosTheta2Sq=1.0-sinTheta2Sq;if (cosTheta2Sq<0.0) {return I;}
float cosTheta2=sqrt(cosTheta2Sq);float R0=getR0fromIORs(iridescenceIOR,outsideIOR);float R12=fresnelSchlickGGX(cosTheta1,R0,1.);float R21=R12;float T121=1.0-R12;float phi12=0.0;if (iridescenceIOR<outsideIOR) phi12=PI;float phi21=PI-phi12;vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));vec3 phi23=vec3(0.0);if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;vec3 phi=vec3(phi21)+phi23;vec3 R123=clamp(R12*R23,1e-5,0.9999);vec3 r123=sqrt(R123);vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);vec3 C0=R12+Rs;I=C0;vec3 Cm=Rs-T121;for (int m=1; m<=2; ++m)
{Cm*=r123;vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);I+=Cm*Sm;}
return max(I,vec3(0.0));}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{float a2=square(alphaG);float d=NdotH*NdotH*(a2-1.0)+1.0;return a2/(PI*d*d);}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{float invR=1./alphaG;float cos2h=NdotH*NdotH;float sin2h=1.-cos2h;return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {float a2=alphaTB.x*alphaTB.y;vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);float v2=dot(v,v);float w2=a2/v2;return a2*w2*w2*RECIPROCAL_PI;}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);return visibility;}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));float v=0.5/(lambdaV+lambdaL);return v;}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {return 0.25/(VdotH*VdotH); }
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{return 1./(4.*(NdotL+NdotV-NdotL*NdotV));}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);float a=mix(21.5473,25.3245,oneMinusAlphaSq);float b=mix(3.82987,3.32435,oneMinusAlphaSq);float c=mix(0.19823,0.16801,oneMinusAlphaSq);float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);return a/(1.0+b*pow(x,c))+d*x+e;}
float lambdaSheen(float cosTheta,float alphaG)
{return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));return G/(4.0*NdotV*NdotL);}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);return fresnel/PI;}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {vec3 S=1./maxEps(diffusionDistance);vec3 temp=exp((-0.333333333*thickness)*S);return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);}
float computeWrappedDiffuseNdotL(float NdotL,float w) {float t=1.0+w;float invt2=1.0/square(t);return saturate((NdotL+w)*invt2);}
#endif
`;r.v.IncludesShadersStore.pbrBRDFFunctions=s},14982:function(e,t,i){var r=i(29427);i(16282),i(33587);let s=`layout(std140,column_major) uniform;uniform Material {vec2 vAlbedoInfos;vec4 vAmbientInfos;vec2 vOpacityInfos;vec2 vEmissiveInfos;vec2 vLightmapInfos;vec3 vReflectivityInfos;vec2 vMicroSurfaceSamplerInfos;vec2 vReflectionInfos;vec2 vReflectionFilteringInfo;vec3 vReflectionPosition;vec3 vReflectionSize;vec3 vBumpInfos;mat4 albedoMatrix;mat4 ambientMatrix;mat4 opacityMatrix;mat4 emissiveMatrix;mat4 lightmapMatrix;mat4 reflectivityMatrix;mat4 microSurfaceSamplerMatrix;mat4 bumpMatrix;vec2 vTangentSpaceParams;mat4 reflectionMatrix;vec3 vReflectionColor;vec4 vAlbedoColor;vec4 vLightingIntensity;vec3 vReflectionMicrosurfaceInfos;float pointSize;vec4 vReflectivityColor;vec3 vEmissiveColor;vec3 vAmbientColor;vec2 vDebugMode;vec4 vMetallicReflectanceFactors;vec2 vMetallicReflectanceInfos;mat4 metallicReflectanceMatrix;vec2 vReflectanceInfos;mat4 reflectanceMatrix;vec3 vSphericalL00;vec3 vSphericalL1_1;vec3 vSphericalL10;vec3 vSphericalL11;vec3 vSphericalL2_2;vec3 vSphericalL2_1;vec3 vSphericalL20;vec3 vSphericalL21;vec3 vSphericalL22;vec3 vSphericalX;vec3 vSphericalY;vec3 vSphericalZ;vec3 vSphericalXX_ZZ;vec3 vSphericalYY_ZZ;vec3 vSphericalZZ;vec3 vSphericalXY;vec3 vSphericalYZ;vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.v.IncludesShadersStore.pbrUboDeclaration=s},5275:function(e,t,i){var r=i(29427);let s=`float distanceSquared(vec2 a,vec2 b) { a-=b; return dot(a,a); }
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
float linearizeDepth(float depth,float near,float far) {
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
return -(near*far)/(far-depth*(far-near));
#else
return (near*far)/(far-depth*(far-near));
#endif
}
#endif
/**
param csOrigin Camera-space ray origin,which must be 
within the view volume and must have z>0.01 and project within the valid screen rectangle
param csDirection Unit length camera-space ray direction
param projectToPixelMatrix A projection matrix that maps to **pixel** coordinates 
(**not** [-1,+1] normalized device coordinates).
param csZBuffer The camera-space Z buffer
param csZBufferSize Dimensions of csZBuffer
param csZThickness Camera space csZThickness to ascribe to each pixel in the depth buffer
param nearPlaneZ Positive number. Doesn't have to be THE actual near plane,just a reasonable value
for clipping rays headed towards the camera
param stride Step in horizontal or vertical pixels between samples. This is a float
because integer math is slow on GPUs,but should be set to an integer>=1
param jitterFraction Number between 0 and 1 for how far to bump the ray in stride units
to conceal banding artifacts,plus the stride ray offset.
param maxSteps Maximum number of iterations. Higher gives better images but may be slow
param maxRayTraceDistance Maximum camera-space distance to trace before returning a miss
param selfCollisionNumSkip Number of steps to skip at start when raytracing to avoid self collisions.
1 is a reasonable value,depending on the scene you may need to set this value to 2
param hitPixel Pixel coordinates of the first intersection with the scene
param numIterations number of iterations performed
param csHitPoint Camera space location of the ray hit
*/
#define inline
bool traceScreenSpaceRay1(
vec3 csOrigin,
vec3 csDirection,
mat4 projectToPixelMatrix,
sampler2D csZBuffer,
vec2 csZBufferSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
sampler2D csZBackBuffer,
float csZBackSizeFactor,
#endif
float csZThickness,
float nearPlaneZ,
float farPlaneZ,
float stride,
float jitterFraction,
float maxSteps,
float maxRayTraceDistance,
float selfCollisionNumSkip,
out vec2 startPixel,
out vec2 hitPixel,
out vec3 csHitPoint,
out float numIterations
#ifdef SSRAYTRACE_DEBUG
,out vec3 debugColor
#endif
)
{
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)>-nearPlaneZ ? (-nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#else
float rayLength=(csOrigin.z+csDirection.z*maxRayTraceDistance)<nearPlaneZ ? (nearPlaneZ-csOrigin.z)/csDirection.z : maxRayTraceDistance;
#endif
vec3 csEndPoint=csOrigin+csDirection*rayLength;hitPixel=vec2(-1.0,-1.0);vec4 H0=projectToPixelMatrix*vec4(csOrigin,1.0);vec4 H1=projectToPixelMatrix*vec4(csEndPoint,1.0);float k0=1.0/H0.w;float k1=1.0/H1.w;vec3 Q0=csOrigin*k0;vec3 Q1=csEndPoint*k1;vec2 P0=H0.xy*k0;vec2 P1=H1.xy*k1;
#ifdef SSRAYTRACE_CLIP_TO_FRUSTUM
float xMax=csZBufferSize.x-0.5,xMin=0.5,yMax=csZBufferSize.y-0.5,yMin=0.5;float alpha=0.0;if ((P1.y>yMax) || (P1.y<yMin)) {alpha=(P1.y-((P1.y>yMax) ? yMax : yMin))/(P1.y-P0.y);}
if ((P1.x>xMax) || (P1.x<xMin)) {alpha=max(alpha,(P1.x-((P1.x>xMax) ? xMax : xMin))/(P1.x-P0.x));}
P1=mix(P1,P0,alpha); k1=mix(k1,k0,alpha); Q1=mix(Q1,Q0,alpha);
#endif
P1+=vec2((distanceSquared(P0,P1)<0.0001) ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) { 
permute=true;delta=delta.yx;P0=P0.yx;P1=P1.yx; }
float stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=vec2(stepDirection,delta.y*invdx);vec3 dQ=(Q1-Q0)*invdx;float dk=(k1-k0)*invdx;float zMin=min(csEndPoint.z,csOrigin.z);float zMax=max(csEndPoint.z,csOrigin.z);dP*=stride; dQ*=stride; dk*=stride;P0+=dP*jitterFraction; Q0+=dQ*jitterFraction; k0+=dk*jitterFraction;vec4 pqk=vec4(P0,Q0.z,k0);vec4 dPQK=vec4(dP,dQ.z,dk);startPixel=permute ? P0.yx : P0.xy;float prevZMaxEstimate=csOrigin.z;float rayZMin=prevZMaxEstimate,rayZMax=prevZMaxEstimate;float sceneZMax=rayZMax+1e4;float end=P1.x*stepDirection;bool hit=false;float stepCount;for (stepCount=0.0;stepCount<=selfCollisionNumSkip ||
(pqk.x*stepDirection)<=end &&
stepCount<maxSteps &&
!hit &&
sceneZMax != 0.0; 
pqk+=dPQK,++stepCount)
{hitPixel=permute ? pqk.yx : pqk.xy;rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;if (rayZMin>rayZMax) { 
float t=rayZMin; rayZMin=rayZMax; rayZMax=t;}
sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
hit=(rayZMax>=sceneBackZ-csZThickness) && (rayZMin<=sceneZMax);
#else
hit=(rayZMax>=sceneZMax-csZThickness) && (rayZMin<=sceneZMax);
#endif
#else
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
float sceneBackZ=texelFetch(csZBackBuffer,ivec2(hitPixel/csZBackSizeFactor),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneBackZ=linearizeDepth(sceneBackZ,nearPlaneZ,farPlaneZ);
#endif
hit=(rayZMin<=sceneBackZ+csZThickness) && (rayZMax>=sceneZMax) && (sceneZMax != 0.0);
#else
hit=(rayZMin<=sceneZMax+csZThickness) && (rayZMax>=sceneZMax);
#endif
#endif
}
pqk-=dPQK;stepCount-=1.0;if (((pqk.x+dPQK.x)*stepDirection)>end || (stepCount+1.0)>=maxSteps || sceneZMax==0.0) {hit=false;}
#ifdef SSRAYTRACE_ENABLE_REFINEMENT
if (stride>1.0 && hit) {pqk-=dPQK;stepCount-=1.0;float invStride=1.0/stride;dPQK*=invStride;float refinementStepCount=0.0;prevZMaxEstimate=pqk.z/pqk.w;rayZMax=prevZMaxEstimate;sceneZMax=rayZMax+1e7;for (;refinementStepCount<=1.0 ||
(refinementStepCount<=stride*1.4) &&
(rayZMax<sceneZMax) && (sceneZMax != 0.0);pqk+=dPQK,refinementStepCount+=1.0)
{rayZMin=prevZMaxEstimate;rayZMax=(dPQK.z*0.5+pqk.z)/(dPQK.w*0.5+pqk.w);rayZMax=clamp(rayZMax,zMin,zMax);prevZMaxEstimate=rayZMax;rayZMax=max(rayZMax,rayZMin);hitPixel=permute ? pqk.yx : pqk.xy;sceneZMax=texelFetch(csZBuffer,ivec2(hitPixel),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
sceneZMax=linearizeDepth(sceneZMax,nearPlaneZ,farPlaneZ);
#endif
}
pqk-=dPQK;refinementStepCount-=1.0;stepCount+=refinementStepCount/stride;}
#endif
Q0.xy+=dQ.xy*stepCount;Q0.z=pqk.z;csHitPoint=Q0/pqk.w;numIterations=stepCount+1.0;
#ifdef SSRAYTRACE_DEBUG
if (((pqk.x+dPQK.x)*stepDirection)>end) {debugColor=vec3(0,0,1);} else if ((stepCount+1.0)>=maxSteps) {debugColor=vec3(1,0,0);} else if (sceneZMax==0.0) {debugColor=vec3(1,1,0);} else {debugColor=vec3(0,stepCount/maxSteps,0);}
#endif
return hit;}
/**
texCoord: in the [0,1] range
depth: depth in view space (range [znear,zfar]])
*/
vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth,mat4 projection,mat4 invProjectionMatrix) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=-projection[2].z*depth+projection[3].z;
#else
ndc.z=-projection[2].z-projection[3].z/depth;
#endif
#else
#ifdef ORTHOGRAPHIC_CAMERA
ndc.z=projection[2].z*depth+projection[3].z;
#else
ndc.z=projection[2].z+projection[3].z/depth;
#endif
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
`;r.v.IncludesShadersStore.screenSpaceRayTrace=s},69303:function(e,t,i){i.r(t),i.d(t,{shadowMapFragment:function(){return a}});var r=i(29427);let s="shadowMapFragment",n=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;r.v.IncludesShadersStore[s]=n;let a={name:s,shader:n}},820:function(e,t,i){i.r(t),i.d(t,{shadowMapFragmentSoftTransparentShadow:function(){return a}});var r=i(29427);let s="shadowMapFragmentSoftTransparentShadow",n=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alpha) discard;
#endif
`;r.v.IncludesShadersStore[s]=n;let a={name:s,shader:n}},10224:function(e,t,i){i.r(t),i.d(t,{shadowMapVertexMetric:function(){return a}});var r=i(29427);let s="shadowMapVertexMetric",n=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;r.v.IncludesShadersStore[s]=n;let a={name:s,shader:n}},59628:function(e,t,i){var r=i(29427);let s=`bool testLightingForSSS(float diffusionProfile)
{return diffusionProfile<1.;}`;r.v.IncludesShadersStore.subSurfaceScatteringFunctions=s},45147:function(e,t,i){i.r(t),i.d(t,{anaglyphPixelShader:function(){return a}});var r=i(29427);let s="anaglyphPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D leftSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 leftFrag=texture2D(leftSampler,vUV);leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);vec4 rightFrag=texture2D(textureSampler,vUV);rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},93028:function(e,t,i){i.r(t),i.d(t,{backgroundPixelShader:function(){return o}});var r=i(29427);let s=`uniform vec4 vEyePosition;uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
#ifdef PROJECTED_GROUND
uniform vec2 projectedGroundInfos;
#endif
`;r.v.IncludesShadersStore.backgroundFragmentDeclaration=s,i(30839),i(7565),i(43237),i(76909),i(72069),i(6937),i(63164),i(86507),i(25902),i(41871),i(56119),i(88004),i(81269),i(97853),i(28951),i(37387);let n="backgroundPixelShader",a=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));}
#endif
#ifdef PROJECTED_GROUND
float diskIntersectWithBackFaceCulling(vec3 ro,vec3 rd,vec3 c,float r) {float d=rd.y;if(d>0.0) { return 1e6; }
vec3 o=ro-c;float t=-o.y/d;vec3 q=o+rd*t;return (dot(q,q)<r*r) ? t : 1e6;}
float sphereIntersect(vec3 ro,vec3 rd,float ra) {float b=dot(ro,rd);float c=dot(ro,ro)-ra*ra;float h=b*b-c;if(h<0.0) { return -1.0; }
h=sqrt(h);return-b+h;}
vec3 project(vec3 viewDirectionW,vec3 eyePosition) {float radius=projectedGroundInfos.x;float height=projectedGroundInfos.y;vec3 camDir=-viewDirectionW;float skySphereDistance=sphereIntersect(eyePosition,camDir,radius);vec3 skySpherePositionW=eyePosition+camDir*skySphereDistance;vec3 p=normalize(skySpherePositionW);eyePosition.y-=height;float sIntersection=sphereIntersect(eyePosition,p,radius);vec3 h=vec3(0.0,-height,0.0);float dIntersection=diskIntersectWithBackFaceCulling(eyePosition,p,h,radius);p=(eyePosition+min(sIntersection,dIntersection)*p);return p;}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;float globalShadow=0.;float shadowLightCount=0.;float aggShadow=0.;float numLights=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
#ifdef PROJECTED_GROUND
vec3 reflectionVector=project(viewDirectionW,vEyePosition.xyz);reflectionVector=vec3(reflectionMatrix*vec4(reflectionVector,1.));
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);if(lodReflectionNormalizedDoubled<1.0){reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);} else {reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;vec3 reflectionReflectance0=vReflectionControl.yyy;vec3 reflectionReflectance90=vReflectionControl.zzz;float VdotN=dot(normalize(vEyePosition.xyz),normalW);vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);reflectionDistanceFalloff*=reflectionDistanceFalloff;reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));const float startAngle=0.1;float fadeFactor=saturate(viewAngleToFloor/startAngle);finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},37506:function(e,t,i){i.r(t),i.d(t,{backgroundVertexShader:function(){return o}});var r=i(29427);let s=`uniform mat4 view;uniform mat4 viewProjection;uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;r.v.IncludesShadersStore.backgroundVertexDeclaration=s,i(30839),i(7565),i(74910),i(96944),i(48714),i(64676),i(99115),i(87672),i(97533),i(41871),i(85814),i(27373),i(59343),i(12637),i(97059),i(77272),i(74450);let n="backgroundVertexShader",a=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*finalWorld*vec4(position,1.0);} else {gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));if (fFovMultiplier<=1.0) {vDirectionW=normalize(segment);} else {vDirectionW=normalize(vDirectionW+(vDirectionW-segment));}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));}
else
{vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},90214:function(e,t,i){i.r(t),i.d(t,{bilateralBlurPixelShader:function(){return a}});var r=i(29427);let s="bilateralBlurPixelShader",n=`uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}
vec3 normal=textureLod(normalSampler,vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
float sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec3 sampleColor=textureLod(textureSampler,vUV+coords*blurDir,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords*blurDir,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords*blurDir,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
float r=dot(coords,coords);float w=exp(-r/two_sigma2);float depthDelta=abs(sampleDepth-depth);float wd=step(depthDelta,depthThreshold);vec3 normalDelta=abs(sampleNormal-normal);float wn=step(normalDelta.x+normalDelta.y+normalDelta.z,normalThreshold);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}
glFragColor=vec4(sum/wsum,1.);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},4497:function(e,t,i){i.r(t),i.d(t,{bilateralBlurQualityPixelShader:function(){return a}});var r=i(29427);let s="bilateralBlurQualityPixelShader",n=`uniform sampler2D textureSampler;uniform sampler2D depthSampler;uniform sampler2D normalSampler;uniform int filterSize;uniform vec2 blurDir;uniform float depthThreshold;uniform float normalThreshold;varying vec2 vUV;void main(void) {vec3 color=textureLod(textureSampler,vUV,0.).rgb;float depth=textureLod(depthSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(color,1.);return;}
vec3 normal=textureLod(normalSampler,vUV,0.).rgb;
#ifdef DECODE_NORMAL
normal=normal*2.0-1.0;
#endif
float sigma=float(filterSize);float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sigmaNormal=normalThreshold;float two_sigmaNormal2=2.0*sigmaNormal*sigmaNormal;vec3 sum=vec3(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {for (int y=-filterSize; y<=filterSize; ++y) {vec2 coords=vec2(x,y)*blurDir;vec3 sampleColor=textureLod(textureSampler,vUV+coords,0.).rgb;float sampleDepth=textureLod(depthSampler,vUV+coords,0.).r;vec3 sampleNormal=textureLod(normalSampler,vUV+coords,0.).rgb;
#ifdef DECODE_NORMAL
sampleNormal=sampleNormal*2.0-1.0;
#endif
float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepth-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);float rNormal=abs(sampleNormal.x-normal.x)+abs(sampleNormal.y-normal.y)+abs(sampleNormal.z-normal.z);float wn=exp(-rNormal*rNormal/two_sigmaNormal2);sum+=sampleColor*w*wd*wn;wsum+=w*wd*wn;}}
glFragColor=vec4(sum/wsum,1.);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},20281:function(e,t,i){i.r(t),i.d(t,{blackAndWhitePixelShader:function(){return a}});var r=i(29427);let s="blackAndWhitePixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float degree;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec3 color=texture2D(textureSampler,vUV).rgb;float luminance=dot(color,vec3(0.3,0.59,0.11)); 
vec3 blackAndWhite=vec3(luminance,luminance,luminance);gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},65630:function(e,t,i){i.r(t),i.d(t,{bloomMergePixelShader:function(){return a}});var r=i(29427);let s="bloomMergePixelShader",n=`uniform sampler2D textureSampler;uniform sampler2D bloomBlur;varying vec2 vUV;uniform float bloomWeight;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(textureSampler,vUV);vec3 blurred=texture2D(bloomBlur,vUV).rgb;gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); }
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},48272:function(e,t,i){i.r(t),i.d(t,{boundingBoxRendererPixelShader:function(){return o}});var r=i(29427);let s=`uniform vec4 color;
`;r.v.IncludesShadersStore.boundingBoxRendererFragmentDeclaration=s,i(44228);let n="boundingBoxRendererPixelShader",a=`#include<__decl__boundingBoxRendererFragment>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},94359:function(e,t,i){i.r(t),i.d(t,{boundingBoxRendererVertexShader:function(){return o}});var r=i(29427);let s=`uniform mat4 world;uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
`;r.v.IncludesShadersStore.boundingBoxRendererVertexDeclaration=s,i(44228);let n="boundingBoxRendererVertexShader",a=`attribute vec3 position;
#include<__decl__boundingBoxRendererVertex>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec4 worldPos=world*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},31506:function(e,t,i){i.r(t),i.d(t,{chromaticAberrationPixelShader:function(){return a}});var r=i(29427);let s="chromaticAberrationPixelShader",n=`uniform sampler2D textureSampler; 
uniform float chromatic_aberration;uniform float radialIntensity;uniform vec2 direction;uniform vec2 centerPosition;uniform float screen_width;uniform float screen_height;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);vec2 directionOfEffect=direction;if(directionOfEffect.x==0. && directionOfEffect.y==0.){directionOfEffect=normalize(centered_screen_pos);}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;float radius=sqrt(radius2);vec3 ref_indices=vec3(-0.3,0.0,0.3);float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);vec4 r=texture2D(textureSampler,ref_coords_r);vec4 g=texture2D(textureSampler,ref_coords_g);vec4 b=texture2D(textureSampler,ref_coords_b);float a=clamp(r.a+g.a+b.a,0.,1.);gl_FragColor=vec4(r.r,g.g,b.b,a);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},87320:function(e,t,i){i.r(t),i.d(t,{circleOfConfusionPixelShader:function(){return a}});var r=i(29427);let s="circleOfConfusionPixelShader",n=`uniform sampler2D depthSampler;varying vec2 vUV;uniform vec2 cameraMinMaxZ;uniform float focusDistance;uniform float cocPrecalculation;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float depth=texture2D(depthSampler,vUV).r;
#define CUSTOM_COC_DEPTH
float pixelDistance=(cameraMinMaxZ.x+cameraMinMaxZ.y*depth)*1000.0; 
#define CUSTOM_COC_PIXELDISTANCE
float coc=abs(cocPrecalculation*((focusDistance-pixelDistance)/pixelDistance));coc=clamp(coc,0.0,1.0);gl_FragColor=vec4(coc,coc,coc,1.0);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},8860:function(e,t,i){i.r(t),i.d(t,{colorPixelShader:function(){return a}});var r=i(29427);i(56119),i(88004),i(81269),i(37387);let s="colorPixelShader",n=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#include<fogFragment>(color,gl_FragColor)
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},19948:function(e,t,i){i.r(t),i.d(t,{colorVertexShader:function(){return a}});var r=i(29427);i(74910),i(96944),i(64676),i(99115),i(48714),i(85814),i(27373),i(59343),i(12637),i(97059),i(74847);let s="colorVertexShader",n=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#ifdef FOG
uniform mat4 view;
#endif
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},84980:function(e,t,i){i.r(t),i.d(t,{colorCorrectionPixelShader:function(){return a}});var r=i(29427);let s="colorCorrectionPixelShader",n=`uniform sampler2D textureSampler; 
uniform sampler2D colorTable; 
varying vec2 vUV;const float SLICE_COUNT=16.0; 
vec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {float sliceSize=1.0/width; 
float slicePixelSize=sliceSize/width; 
float sliceInnerSize=slicePixelSize*(width-1.0); 
float zSlice0=min(floor(uv.z*width),width-1.0);float zSlice1=min(zSlice0+1.0,width-1.0);float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;float s0=xOffset+(zSlice0*sliceSize);float s1=xOffset+(zSlice1*sliceSize);vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));float zOffset=mod(uv.z*width,1.0);vec4 result=mix(slice0Color,slice1Color,zOffset);return result;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 screen_color=texture2D(textureSampler,vUV);gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},57477:function(e,t,i){i.r(t),i.d(t,{convolutionPixelShader:function(){return a}});var r=i(29427);let s="convolutionPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform float kernel[9];
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 colorSum =
texture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +
texture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +
texture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +
texture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +
texture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +
texture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +
texture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];float kernelWeight =
kernel[0] +
kernel[1] +
kernel[2] +
kernel[3] +
kernel[4] +
kernel[5] +
kernel[6] +
kernel[7] +
kernel[8];if (kernelWeight<=0.0) {kernelWeight=1.0;}
gl_FragColor=vec4((colorSum/kernelWeight).rgb,1);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},1934:function(e,t,i){i.r(t),i.d(t,{copyTexture3DLayerToTexturePixelShader:function(){return a}});var r=i(29427);let s="copyTexture3DLayerToTexturePixelShader",n=`precision highp sampler3D;uniform sampler3D textureSampler;uniform int layerNum;varying vec2 vUV;void main(void) {vec3 coord=vec3(0.0,0.0,float(layerNum));coord.xy=vec2(vUV.x,vUV.y)*vec2(textureSize(textureSampler,0).xy);vec3 color=texelFetch(textureSampler,ivec3(coord),0).rgb;gl_FragColor=vec4(color,1);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},87423:function(e,t,i){i.r(t),i.d(t,{copyTextureToTexturePixelShader:function(){return a}});var r=i(29427);i(7565);let s="copyTextureToTexturePixelShader",n=`uniform float conversion;uniform sampler2D textureSampler;varying vec2 vUV;
#include<helperFunctions>
void main(void) 
{vec4 color=texture2D(textureSampler,vUV);
#ifdef DEPTH_TEXTURE
gl_FragDepth=color.r;
#else
if (conversion==1.) {color=toLinearSpace(color);} else if (conversion==2.) {color=toGammaSpace(color);}
gl_FragColor=color;
#endif
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},51302:function(e,t,i){i.r(t),i.d(t,{depthPixelShader:function(){return a}});var r=i(29427);i(56119),i(43870),i(81269);let s="depthPixelShader",n=`#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#ifdef STORE_CAMERASPACE_Z
varying vec4 vViewPos;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef STORE_CAMERASPACE_Z
#ifdef PACKED
gl_FragColor=pack(vViewPos.z);
#else
gl_FragColor=vec4(vViewPos.z,0.0,0.0,1.0);
#endif
#else
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},69689:function(e,t,i){i.r(t),i.d(t,{depthVertexShader:function(){return o}});var r=i(29427);i(74910),i(96944),i(50731),i(43626),i(64676),i(48714);let s=`#ifdef POINTSIZE
uniform float pointSize;
#endif
`;r.v.IncludesShadersStore.pointCloudVertexDeclaration=s,i(76086),i(74436),i(85814),i(27373),i(59343),i(12637),i(27194);let n="depthVertexShader",a=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef STORE_CAMERASPACE_Z
uniform mat4 view;varying vec4 vViewPos;
#endif
#include<pointCloudVertexDeclaration>
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef STORE_CAMERASPACE_Z
vViewPos=view*worldPos;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<pointCloudVertex>
}
`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},63023:function(e,t,i){i.r(t),i.d(t,{depthBoxBlurPixelShader:function(){return a}});var r=i(29427);let s="depthBoxBlurPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 colorDepth=vec4(0.0);for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},82494:function(e,t,i){i.r(t),i.d(t,{depthOfFieldMergePixelShader:function(){return a}});var r=i(29427);let s="depthOfFieldMergePixelShader",n=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;uniform sampler2D circleOfConfusionSampler;uniform sampler2D blurStep0;
#if BLUR_LEVEL>0
uniform sampler2D blurStep1;
#endif
#if BLUR_LEVEL>1
uniform sampler2D blurStep2;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float coc=TEXTUREFUNC(circleOfConfusionSampler,vUV,0.0).r;
#if BLUR_LEVEL==0
vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);gl_FragColor=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL==1
if(coc<0.5){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(original,blurred1,coc/0.5);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);}
#endif
#if BLUR_LEVEL==2
if(coc<0.33){vec4 original=TEXTUREFUNC(textureSampler,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(original,blurred2,coc/0.33);}else if(coc<0.66){vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);vec4 blurred2=TEXTUREFUNC(blurStep2,vUV,0.0);gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);}else{vec4 blurred0=TEXTUREFUNC(blurStep0,vUV,0.0);vec4 blurred1=TEXTUREFUNC(blurStep1,vUV,0.0);gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);}
#endif
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},8983:function(e,t,i){i.r(t),i.d(t,{displayPassPixelShader:function(){return a}});var r=i(29427);let s="displayPassPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D passSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(passSampler,vUV);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},23710:function(e,t,i){i.r(t),i.d(t,{extractHighlightsPixelShader:function(){return a}});var r=i(29427);i(7565);let s="extractHighlightsPixelShader",n=`#include<helperFunctions>
varying vec2 vUV;uniform sampler2D textureSampler;uniform float threshold;uniform float exposure;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},56095:function(e,t,i){i.r(t),i.d(t,{filterPixelShader:function(){return a}});var r=i(29427);let s="filterPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform mat4 kernelMatrix;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec3 baseColor=texture2D(textureSampler,vUV).rgb;vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;gl_FragColor=vec4(updatedColor,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},54580:function(e,t,i){i.r(t),i.d(t,{fluidRenderingBilateralBlurPixelShader:function(){return a}});var r=i(29427);let s="fluidRenderingBilateralBlurPixelShader",n=`uniform sampler2D textureSampler;uniform int maxFilterSize;uniform vec2 blurDir;uniform float projectedParticleConstant;uniform float depthThreshold;varying vec2 vUV;void main(void) {float depth=textureLod(textureSampler,vUV,0.).x;if (depth>=1e6 || depth<=0.) {glFragColor=vec4(vec3(depth),1.);return;}
int filterSize=min(maxFilterSize,int(ceil(projectedParticleConstant/depth)));float sigma=float(filterSize)/3.0;float two_sigma2=2.0*sigma*sigma;float sigmaDepth=depthThreshold/3.0;float two_sigmaDepth2=2.0*sigmaDepth*sigmaDepth;float sum=0.;float wsum=0.;float sumVel=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec2 sampleDepthVel=textureLod(textureSampler,vUV+coords*blurDir,0.).rg;float r=dot(coords,coords);float w=exp(-r/two_sigma2);float rDepth=sampleDepthVel.r-depth;float wd=exp(-rDepth*rDepth/two_sigmaDepth2);sum+=sampleDepthVel.r*w*wd;sumVel+=sampleDepthVel.g*w*wd;wsum+=w*wd;}
glFragColor=vec4(sum/wsum,sumVel/wsum,0.,1.);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},59325:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleDepthPixelShader:function(){return a}});var r=i(29427);let s="fluidRenderingParticleDepthPixelShader",n=`uniform mat4 projection;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
varying float velocityNorm;
#endif
void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;normal.z=sqrt(1.0-r2);
#ifndef FLUIDRENDERING_RHS
normal.z=-normal.z;
#endif
vec4 realViewPos=vec4(viewPos+normal*sphereRadius,1.0);vec4 clipSpacePos=projection*realViewPos;
#ifdef WEBGPU
gl_FragDepth=clipSpacePos.z/clipSpacePos.w;
#else
gl_FragDepth=(clipSpacePos.z/clipSpacePos.w)*0.5+0.5;
#endif
#ifdef FLUIDRENDERING_RHS
realViewPos.z=-realViewPos.z;
#endif
#ifdef FLUIDRENDERING_VELOCITY
glFragColor=vec4(realViewPos.z,velocityNorm,0.,1.);
#else
glFragColor=vec4(realViewPos.z,0.,0.,1.);
#endif
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},15803:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleDepthVertexShader:function(){return a}});var r=i(29427);let s="fluidRenderingParticleDepthVertexShader",n=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 viewPos;varying float sphereRadius;
#ifdef FLUIDRENDERING_VELOCITY
attribute vec3 velocity;varying float velocityNorm;
#endif
void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;viewPos=(view*vec4(position,1.0)).xyz;gl_Position=projection*vec4(viewPos+cornerPos,1.0);uv=offset;sphereRadius=size.x/2.0;
#ifdef FLUIDRENDERING_VELOCITY
velocityNorm=length(velocity);
#endif
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},96739:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleDiffusePixelShader:function(){return a}});var r=i(29427);let s="fluidRenderingParticleDiffusePixelShader",n=`uniform float particleAlpha;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;glFragColor=vec4(diffuseColor,1.0);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},3977:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleThicknessPixelShader:function(){return a}});var r=i(29427);let s="fluidRenderingParticleThicknessPixelShader",n=`uniform float particleAlpha;varying vec2 uv;void main(void) {vec3 normal;normal.xy=uv*2.0-1.0;float r2=dot(normal.xy,normal.xy);if (r2>1.0) discard;float thickness=sqrt(1.0-r2);glFragColor=vec4(vec3(particleAlpha*thickness),1.0);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},95899:function(e,t,i){i.r(t),i.d(t,{fluidRenderingParticleThicknessVertexShader:function(){return a}});var r=i(29427);let s="fluidRenderingParticleThicknessVertexShader",n=`attribute vec3 position;attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},36733:function(e,t,i){i.r(t),i.d(t,{fluidRenderingRenderPixelShader:function(){return a}});var r=i(29427);let s="fluidRenderingRenderPixelShader",n=`#define DISABLE_UNIFORMITY_ANALYSIS
#define IOR 1.333
#define ETA 1.0/IOR
#define F0 0.02
uniform sampler2D textureSampler;uniform sampler2D depthSampler;
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
uniform sampler2D diffuseSampler;
#else
uniform vec3 diffuseColor;
#endif
#ifdef FLUIDRENDERING_FIXED_THICKNESS
uniform float thickness;uniform sampler2D bgDepthSampler;
#else
uniform float minimumThickness;uniform sampler2D thicknessSampler;
#endif
#ifdef FLUIDRENDERING_ENVIRONMENT
uniform samplerCube reflectionSampler;
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
uniform sampler2D debugSampler;
#endif
uniform mat4 viewMatrix;uniform mat4 projectionMatrix;uniform mat4 invProjectionMatrix;uniform vec2 texelSize;uniform vec3 dirLight;uniform float cameraFar;uniform float density;uniform float refractionStrength;uniform float fresnelClamp;uniform float specularPower;varying vec2 vUV;vec3 computeViewPosFromUVDepth(vec2 texCoord,float depth) {vec4 ndc;ndc.xy=texCoord*2.0-1.0;
#ifdef FLUIDRENDERING_RHS
ndc.z=-projectionMatrix[2].z+projectionMatrix[3].z/depth;
#else
ndc.z=projectionMatrix[2].z+projectionMatrix[3].z/depth;
#endif
ndc.w=1.0;vec4 eyePos=invProjectionMatrix*ndc;eyePos.xyz/=eyePos.w;return eyePos.xyz;}
vec3 getViewPosFromTexCoord(vec2 texCoord) {float depth=textureLod(depthSampler,texCoord,0.).x;return computeViewPosFromUVDepth(texCoord,depth);}
void main(void) {vec2 texCoord=vUV;
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_TEXTURE)
vec4 color=texture2D(debugSampler,texCoord);
#ifdef FLUIDRENDERING_DEBUG_DEPTH
glFragColor=vec4(color.rgb/vec3(2.0),1.);if (color.r>0.999 && color.g>0.999) {glFragColor=texture2D(textureSampler,texCoord);}
#else
glFragColor=vec4(color.rgb,1.);if (color.r<0.001 && color.g<0.001 && color.b<0.001) {glFragColor=texture2D(textureSampler,texCoord);}
#endif
return;
#endif
vec2 depthVel=textureLod(depthSampler,texCoord,0.).rg;float depth=depthVel.r;
#ifndef FLUIDRENDERING_FIXED_THICKNESS
float thickness=texture2D(thicknessSampler,texCoord).x;
#else
float bgDepth=texture2D(bgDepthSampler,texCoord).x;float depthNonLinear=projectionMatrix[2].z+projectionMatrix[3].z/depth;depthNonLinear=depthNonLinear*0.5+0.5;
#endif
vec4 backColor=texture2D(textureSampler,texCoord);
#ifndef FLUIDRENDERING_FIXED_THICKNESS
if (depth>=cameraFar || depth<=0. || thickness<=minimumThickness) {
#else
if (depth>=cameraFar || depth<=0. || bgDepth<=depthNonLinear) {
#endif
#ifdef FLUIDRENDERING_COMPOSITE_MODE
glFragColor.rgb=backColor.rgb*backColor.a;glFragColor.a=backColor.a;
#else
glFragColor=backColor;
#endif
return;}
vec3 viewPos=computeViewPosFromUVDepth(texCoord,depth);vec3 ddx=getViewPosFromTexCoord(texCoord+vec2(texelSize.x,0.))-viewPos;vec3 ddy=getViewPosFromTexCoord(texCoord+vec2(0.,texelSize.y))-viewPos;vec3 ddx2=viewPos-getViewPosFromTexCoord(texCoord+vec2(-texelSize.x,0.));if (abs(ddx.z)>abs(ddx2.z)) {ddx=ddx2;}
vec3 ddy2=viewPos-getViewPosFromTexCoord(texCoord+vec2(0.,-texelSize.y));if (abs(ddy.z)>abs(ddy2.z)) {ddy=ddy2;}
vec3 normal=normalize(cross(ddy,ddx));
#ifdef FLUIDRENDERING_RHS
normal=-normal;
#endif
#ifndef WEBGPU
if(isnan(normal.x) || isnan(normal.y) || isnan(normal.z) || isinf(normal.x) || isinf(normal.y) || isinf(normal.z)) {normal=vec3(0.,0.,-1.);}
#endif
#if defined(FLUIDRENDERING_DEBUG) && defined(FLUIDRENDERING_DEBUG_SHOWNORMAL)
glFragColor=vec4(normal*0.5+0.5,1.0);return;
#endif
vec3 rayDir=normalize(viewPos); 
#ifdef FLUIDRENDERING_DIFFUSETEXTURE
vec3 diffuseColor=textureLod(diffuseSampler,texCoord,0.0).rgb;
#endif
vec3 lightDir=normalize(vec3(viewMatrix*vec4(-dirLight,0.)));vec3 H =normalize(lightDir-rayDir);float specular=pow(max(0.0,dot(H,normal)),specularPower);
#ifdef FLUIDRENDERING_DEBUG_DIFFUSERENDERING
float diffuse =max(0.0,dot(lightDir,normal))*1.0;glFragColor=vec4(vec3(0.1) /*ambient*/+vec3(0.42,0.50,1.00)*diffuse+vec3(0,0,0.2)+specular,1.);return;
#endif
vec3 refractionDir=refract(rayDir,normal,ETA);vec4 transmitted=textureLod(textureSampler,vec2(texCoord+refractionDir.xy*thickness*refractionStrength),0.0);
#ifdef FLUIDRENDERING_COMPOSITE_MODE
if (transmitted.a==0.) transmitted.a=thickness;
#endif
vec3 transmittance=exp(-density*thickness*(1.0-diffuseColor)); 
vec3 refractionColor=transmitted.rgb*transmittance;
#ifdef FLUIDRENDERING_ENVIRONMENT
vec3 reflectionDir=reflect(rayDir,normal);vec3 reflectionColor=(textureCube(reflectionSampler,reflectionDir).rgb);float fresnel=clamp(F0+(1.0-F0)*pow(1.0-dot(normal,-rayDir),5.0),0.,fresnelClamp);vec3 finalColor=mix(refractionColor,reflectionColor,fresnel)+specular;
#else
vec3 finalColor=refractionColor+specular;
#endif
#ifdef FLUIDRENDERING_VELOCITY
float velocity=depthVel.g;finalColor=mix(finalColor,vec3(1.0),smoothstep(0.3,1.0,velocity/6.0));
#endif
glFragColor=vec4(finalColor,transmitted.a);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},55520:function(e,t,i){i.r(t),i.d(t,{fluidRenderingStandardBlurPixelShader:function(){return a}});var r=i(29427);let s="fluidRenderingStandardBlurPixelShader",n=`uniform sampler2D textureSampler;uniform int filterSize;uniform vec2 blurDir;varying vec2 vUV;void main(void) {vec4 s=textureLod(textureSampler,vUV,0.);if (s.r==0.) {glFragColor=vec4(0.,0.,0.,1.);return;}
float sigma=float(filterSize)/3.0;float twoSigma2=2.0*sigma*sigma;vec4 sum=vec4(0.);float wsum=0.;for (int x=-filterSize; x<=filterSize; ++x) {vec2 coords=vec2(x);vec4 sampl=textureLod(textureSampler,vUV+coords*blurDir,0.);float w=exp(-coords.x*coords.x/twoSigma2);sum+=sampl*w;wsum+=w;}
sum/=wsum;glFragColor=vec4(sum.rgb,1.);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},23798:function(e,t,i){i.r(t),i.d(t,{fxaaPixelShader:function(){return a}});var r=i(29427);let s="fxaaPixelShader",n=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
uniform sampler2D textureSampler;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const float fxaaQualitySubpix=1.0;const float fxaaQualityEdgeThreshold=0.166;const float fxaaQualityEdgeThresholdMin=0.0833;const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){vec2 posM;posM.x=vUV.x;posM.y=vUV.y;vec4 rgbyM=TEXTUREFUNC(textureSampler,vUV,0.0);float lumaM=FxaaLuma(rgbyM);float lumaS=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordS,0.0));float lumaE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordE,0.0));float lumaN=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordN,0.0));float lumaW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordW,0.0));float maxSM=max(lumaS,lumaM);float minSM=min(lumaS,lumaM);float maxESM=max(lumaE,maxSM);float minESM=min(lumaE,minSM);float maxWN=max(lumaN,lumaW);float minWN=min(lumaN,lumaW);float rangeMax=max(maxWN,maxESM);float rangeMin=min(minWN,minESM);float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;float range=rangeMax-rangeMin;float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{gl_FragColor=rgbyM;return;}
#endif
float lumaNW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNW,0.0));float lumaSE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSE,0.0));float lumaNE=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordNE,0.0));float lumaSW=FxaaLuma(TEXTUREFUNC(textureSampler,sampleCoordSW,0.0));float lumaNS=lumaN+lumaS;float lumaWE=lumaW+lumaE;float subpixRcpRange=1.0/range;float subpixNSWE=lumaNS+lumaWE;float edgeHorz1=(-2.0*lumaM)+lumaNS;float edgeVert1=(-2.0*lumaM)+lumaWE;float lumaNESE=lumaNE+lumaSE;float lumaNWNE=lumaNW+lumaNE;float edgeHorz2=(-2.0*lumaE)+lumaNESE;float edgeVert2=(-2.0*lumaN)+lumaNWNE;float lumaNWSW=lumaNW+lumaSW;float lumaSWSE=lumaSW+lumaSE;float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);float edgeHorz3=(-2.0*lumaW)+lumaNWSW;float edgeVert3=(-2.0*lumaS)+lumaSWSE;float edgeHorz=abs(edgeHorz3)+edgeHorz4;float edgeVert=abs(edgeVert3)+edgeVert4;float subpixNWSWNESE=lumaNWSW+lumaNESE;float lengthSign=texelSize.x;bool horzSpan=edgeHorz>=edgeVert;float subpixA=subpixNSWE*2.0+subpixNWSWNESE;if (!horzSpan)
{lumaN=lumaW;}
if (!horzSpan) 
{lumaS=lumaE;}
if (horzSpan) 
{lengthSign=texelSize.y;}
float subpixB=(subpixA*(1.0/12.0))-lumaM;float gradientN=lumaN-lumaM;float gradientS=lumaS-lumaM;float lumaNN=lumaN+lumaM;float lumaSS=lumaS+lumaM;bool pairN=abs(gradientN)>=abs(gradientS);float gradient=max(abs(gradientN),abs(gradientS));if (pairN)
{lengthSign=-lengthSign;}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);vec2 posB;posB.x=posM.x;posB.y=posM.y;vec2 offNP;offNP.x=(!horzSpan) ? 0.0 : texelSize.x;offNP.y=(horzSpan) ? 0.0 : texelSize.y;if (!horzSpan) 
{posB.x+=lengthSign*0.5;}
if (horzSpan)
{posB.y+=lengthSign*0.5;}
vec2 posN;posN.x=posB.x-offNP.x*1.5;posN.y=posB.y-offNP.y*1.5;vec2 posP;posP.x=posB.x+offNP.x*1.5;posP.y=posB.y+offNP.y*1.5;float subpixD=((-2.0)*subpixC)+3.0;float lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN,0.0));float subpixE=subpixC*subpixC;float lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP,0.0));if (!pairN) 
{lumaNN=lumaSS;}
float gradientScaled=gradient*1.0/4.0;float lumaMM=lumaM-lumaNN*0.5;float subpixF=subpixD*subpixE;bool lumaMLTZero=lumaMM<0.0;lumaEndN-=lumaNN*0.5;lumaEndP-=lumaNN*0.5;bool doneN=abs(lumaEndN)>=gradientScaled;bool doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) 
{posN.x-=offNP.x*3.0;}
if (!doneN) 
{posN.y-=offNP.y*3.0;}
bool doneNP=(!doneN) || (!doneP);if (!doneP) 
{posP.x+=offNP.x*3.0;}
if (!doneP)
{posP.y+=offNP.y*3.0;}
if (doneNP)
{if (!doneN) lumaEndN=FxaaLuma(TEXTUREFUNC(textureSampler,posN.xy,0.0));if (!doneP) lumaEndP=FxaaLuma(TEXTUREFUNC(textureSampler,posP.xy,0.0));if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;doneN=abs(lumaEndN)>=gradientScaled;doneP=abs(lumaEndP)>=gradientScaled;if (!doneN) posN.x-=offNP.x*12.0;if (!doneN) posN.y-=offNP.y*12.0;doneNP=(!doneN) || (!doneP);if (!doneP) posP.x+=offNP.x*12.0;if (!doneP) posP.y+=offNP.y*12.0;}
float dstN=posM.x-posN.x;float dstP=posP.x-posM.x;if (!horzSpan)
{dstN=posM.y-posN.y;}
if (!horzSpan) 
{dstP=posP.y-posM.y;}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;float spanLength=(dstP+dstN);bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;float spanLengthRcp=1.0/spanLength;bool directionN=dstN<dstP;float dst=min(dstN,dstP);bool goodSpan=directionN ? goodSpanN : goodSpanP;float subpixG=subpixF*subpixF;float pixelOffset=(dst*(-spanLengthRcp))+0.5;float subpixH=subpixG*fxaaQualitySubpix;float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);if (!horzSpan)
{posM.x+=pixelOffsetSubpix*lengthSign;}
if (horzSpan)
{posM.y+=pixelOffsetSubpix*lengthSign;}
#ifdef MALI
if(range<rangeMaxClamped) 
{gl_FragColor=rgbyM;}
else
{gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);}
#else
gl_FragColor=TEXTUREFUNC(textureSampler,posM,0.0);
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},87812:function(e,t,i){i.r(t),i.d(t,{fxaaVertexShader:function(){return a}});var r=i(29427);let s="fxaaVertexShader",n=`attribute vec2 position;uniform vec2 texelSize;varying vec2 vUV;varying vec2 sampleCoordS;varying vec2 sampleCoordE;varying vec2 sampleCoordN;varying vec2 sampleCoordW;varying vec2 sampleCoordNW;varying vec2 sampleCoordSE;varying vec2 sampleCoordNE;varying vec2 sampleCoordSW;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd);sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},21968:function(e,t,i){i.r(t),i.d(t,{geometryPixelShader:function(){return o}});var r=i(29427);i(56119);let s=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;r.v.IncludesShadersStore.mrtFragmentDeclaration=s,i(32465),i(91023),i(7565),i(81269),i(5413);let n="geometryPixelShader",a=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
uniform sampler2D reflectivitySampler;varying vec2 vReflectivityUV;
#endif
#ifdef ALBEDOTEXTURE
varying vec2 vAlbedoUV;uniform sampler2D albedoSampler;
#endif
#ifdef REFLECTIVITYCOLOR
uniform vec3 reflectivityColor;
#endif
#ifdef ALBEDOCOLOR
uniform vec3 albedoColor;
#endif
#ifdef METALLIC
uniform float metallic;
#endif
#if defined(ROUGHNESS) || defined(GLOSSINESS)
uniform float glossiness;
#endif
#endif
#if defined(ALPHATEST) && defined(NEED_UV)
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<mrtFragmentDeclaration>[SCENE_MRT_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
void main() {
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
#ifdef NORMAL_WORLDSPACE
normalOutput=normalW;
#else
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#endif
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef ENCODE_NORMAL
normalOutput=normalOutput*0.5+0.5;
#endif
#ifdef DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#ifdef SCREENSPACE_DEPTH
gl_FragData[SCREENSPACE_DEPTH_INDEX]=vec4(gl_FragCoord.z,0.0,0.0,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
vec4 reflectivity=vec4(0.0,0.0,0.0,1.0);
#ifdef METALLICWORKFLOW
float metal=1.0;float roughness=1.0;
#ifdef ORMTEXTURE
metal*=texture2D(reflectivitySampler,vReflectivityUV).b;roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-glossiness); 
#endif
reflectivity.a-=roughness;vec3 color=vec3(1.0);
#ifdef ALBEDOTEXTURE
color=texture2D(albedoSampler,vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpace(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=albedoColor.xyz;
#endif
reflectivity.rgb=mix(vec3(0.04),color,metal);
#else
#if defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#else 
#ifdef REFLECTIVITYCOLOR
reflectivity.rgb=toLinearSpace(reflectivityColor.xyz);reflectivity.a=1.0;
#endif
#endif
#ifdef GLOSSINESSS
reflectivity.a*=glossiness; 
#endif
#endif
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},90894:function(e,t,i){i.r(t),i.d(t,{geometryVertexShader:function(){return o}});var r=i(29427);i(74910),i(96944),i(50731),i(43626),i(48714),r.v.IncludesShadersStore.geometryVertexDeclaration="uniform mat4 viewProjection;uniform mat4 view;",i(16282);let s=`#include<sceneUboDeclaration>
`;r.v.IncludesShadersStore.geometryUboDeclaration=s,i(64676),i(76086),i(74436),i(85814),i(27373),i(59343),i(12637),i(74953);let n="geometryVertexShader",a=`precision highp float;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;uniform mat4 albedoMatrix;varying vec2 vReflectivityUV;varying vec2 vAlbedoUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
uniform mat4 previousViewProjection;varying vec4 vCurrentPosition;varying vec4 vPreviousPosition;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;vNormalW=normalUpdated;
#else
#ifdef NORMAL_WORLDSPACE
vNormalV=normalize(vec3(finalWorld*vec4(normalUpdated,0.0)));
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
#endif
vViewPos=view*worldPos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=worldPos.xyz/worldPos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uv;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef ALBEDO_UV1
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#else
vUV=uv2;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef ALBEDO_UV2
vAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},5899:function(e,t,i){i.r(t),i.d(t,{glowBlurPostProcessPixelShader:function(){return a}});var r=i(29427);let s="glowBlurPostProcessPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 direction;uniform float blurWidth;float getLuminance(vec3 color)
{return dot(color,vec3(0.2126,0.7152,0.0722));}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float weights[7];weights[0]=0.05;weights[1]=0.1;weights[2]=0.2;weights[3]=0.3;weights[4]=0.2;weights[5]=0.1;weights[6]=0.05;vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);vec2 texelStep=texelSize*direction*blurWidth;vec2 start=vUV-3.0*texelStep;vec4 baseColor=vec4(0.,0.,0.,0.);vec2 texelOffset=vec2(0.,0.);for (int i=0; i<7; i++)
{vec4 texel=texture2D(textureSampler,start+texelOffset);baseColor.a+=texel.a*weights[i];float luminance=getLuminance(baseColor.rgb);float luminanceTexel=getLuminance(texel.rgb);float choice=step(luminanceTexel,luminance);baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;texelOffset+=texelStep;}
gl_FragColor=baseColor;}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},20215:function(e,t,i){i.r(t),i.d(t,{glowMapGenerationPixelShader:function(){return a}});var r=i(29427);i(7565),i(56119),i(81269);let s="glowMapGenerationPixelShader",n=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform sampler2D opacitySampler;uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;uniform float glowIntensity;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
vec4 finalColor=glowColor;
#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT
finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
vec4 emissive=texture2D(emissiveSampler,vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
gl_FragColor=emissive*finalColor*glowIntensity;
#else
gl_FragColor=finalColor*glowIntensity;
#endif
#ifdef HIGHLIGHT
gl_FragColor.a=glowColor.a;
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},96884:function(e,t,i){i.r(t),i.d(t,{glowMapGenerationVertexShader:function(){return a}});var r=i(29427);i(74910),i(96944),i(50731),i(43626),i(64676),i(48714),i(76086),i(74436),i(85814),i(27373),i(59343),i(12637);let s="glowMapGenerationVertexShader",n=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef CUBEMAP
vPosition=worldPos;gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*worldPos;gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
#include<clipPlaneVertex>
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},27623:function(e,t,i){i.r(t),i.d(t,{glowMapMergePixelShader:function(){return a}});var r=i(29427);let s="glowMapMergePixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;
#ifdef EMISSIVE
uniform sampler2D textureSampler2;
#endif
uniform float offset;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef EMISSIVE
baseColor+=texture2D(textureSampler2,vUV);baseColor*=offset;
#else
baseColor.a=abs(offset-baseColor.a);
#ifdef STROKE
float alpha=smoothstep(.0,.1,baseColor.a);baseColor.a=alpha;baseColor.rgb=baseColor.rgb*alpha;
#endif
#endif
#if LDR
baseColor=clamp(baseColor,0.,1.0);
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},81442:function(e,t,i){i.r(t),i.d(t,{glowMapMergeVertexShader:function(){return a}});var r=i(29427);let s="glowMapMergeVertexShader",n=`attribute vec2 position;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},69094:function(e,t,i){i.r(t),i.d(t,{grainPixelShader:function(){return a}});var r=i(29427);i(7565);let s="grainPixelShader",n=`#include<helperFunctions>
uniform sampler2D textureSampler; 
uniform float intensity;uniform float animatedSeed;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(textureSampler,vUV);vec2 seed=vUV*(animatedSeed);float grain=dither(seed,intensity);float lum=getLuminance(gl_FragColor.rgb);float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;gl_FragColor.rgb+=grain*grainAmount;gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},35275:function(e,t,i){i.r(t),i.d(t,{hdrFilteringPixelShader:function(){return a}});var r=i(29427);i(7565),i(52540),i(35825),i(51940);let s="hdrFilteringPixelShader",n=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;uniform samplerCube inputTexture;uniform vec2 vFilteringInfo;uniform float hdrScale;varying vec3 direction;void main() {vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);gl_FragColor=vec4(color*hdrScale,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},81438:function(e,t,i){i.r(t),i.d(t,{hdrFilteringVertexShader:function(){return a}});var r=i(29427);let s="hdrFilteringVertexShader",n=`attribute vec2 position;varying vec3 direction;uniform vec3 up;uniform vec3 right;uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);direction=view*vec3(position,1.0);gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},78102:function(e,t,i){i.r(t),i.d(t,{highlightsPixelShader:function(){return a}});var r=i(29427);let s="highlightsPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 tex=texture2D(textureSampler,vUV);vec3 c=tex.rgb;float luma=dot(c.rgb,RGBLuminanceCoefficients);gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); }`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},61309:function(e,t,i){i.r(t),i.d(t,{iblCombineVoxelGridsPixelShader:function(){return a}});var r=i(29427);let s="iblCombineVoxelGridsPixelShader",n="precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelXaxisSampler;uniform sampler3D voxelYaxisSampler;uniform sampler3D voxelZaxisSampler;uniform float layer;void main(void) {vec3 coordZ=vec3(vUV.x,vUV.y,layer);float voxelZ=texture(voxelZaxisSampler,coordZ).r;vec3 coordX=vec3(1.0-layer,vUV.y,vUV.x);float voxelX=texture(voxelXaxisSampler,coordX).r;vec3 coordY=vec3(layer,vUV.x,vUV.y);float voxelY=texture(voxelYaxisSampler,coordY).r;float voxel=(voxelX>0.0 || voxelY>0.0 || voxelZ>0.0) ? 1.0 : 0.0;glFragColor=vec4(vec3(voxel),1.0);}";r.v.ShadersStore[s]=n;let a={name:s,shader:n}},56327:function(e,t,i){i.r(t),i.d(t,{iblGenerateVoxelMipPixelShader:function(){return a}});var r=i(29427);let s="iblGenerateVoxelMipPixelShader",n=`precision highp float;precision highp sampler3D;varying vec2 vUV;uniform sampler3D srcMip;uniform int layerNum;void main(void) {ivec3 Coords=ivec3(2)*ivec3(gl_FragCoord.x,gl_FragCoord.y,layerNum);uint tex =
uint(texelFetch(srcMip,Coords+ivec3(0,0,0),0).x>0.0f ? 1u : 0u)
<< 0u |
uint(texelFetch(srcMip,Coords+ivec3(1,0,0),0).x>0.0f ? 1u : 0u)
<< 1u |
uint(texelFetch(srcMip,Coords+ivec3(0,1,0),0).x>0.0f ? 1u : 0u)
<< 2u |
uint(texelFetch(srcMip,Coords+ivec3(1,1,0),0).x>0.0f ? 1u : 0u)
<< 3u |
uint(texelFetch(srcMip,Coords+ivec3(0,0,1),0).x>0.0f ? 1u : 0u)
<< 4u |
uint(texelFetch(srcMip,Coords+ivec3(1,0,1),0).x>0.0f ? 1u : 0u)
<< 5u |
uint(texelFetch(srcMip,Coords+ivec3(0,1,1),0).x>0.0f ? 1u : 0u)
<< 6u |
uint(texelFetch(srcMip,Coords+ivec3(1,1,1),0).x>0.0f ? 1u : 0u)
<< 7u;glFragColor.rgb=vec3(float(tex)/255.0f,0.0f,0.0f);glFragColor.a=1.0;}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},66839:function(e,t,i){i.r(t),i.d(t,{iblShadowAccumulationPixelShader:function(){return a}});var r=i(29427);let s="iblShadowAccumulationPixelShader",n=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform vec4 accumulationParameters;
#define remanence accumulationParameters.x
#define resetb accumulationParameters.y
uniform sampler2D motionSampler; 
uniform sampler2D localPositionSampler; 
uniform sampler2D textureSampler; 
uniform sampler2D oldAccumulationSampler; 
uniform sampler2D prevLocalPositionSampler; 
vec2 max2(vec2 v,vec2 w) { return vec2(max(v.x,w.x),max(v.y,w.y)); }
void main(void) {bool reset=bool(resetb);vec2 Resolution=vec2(textureSize(textureSampler,0));ivec2 currentPixel=ivec2(vUV*Resolution);vec4 LP=texelFetch(localPositionSampler,currentPixel,0);if (0.0==LP.w) {gl_FragColor=vec4(1.0,0.0,0.0,1.0);return;}
vec2 velocityColor=texelFetch(motionSampler,currentPixel,0).xy;vec2 prevCoord=vUV+velocityColor;vec3 PrevLP=textureLod(prevLocalPositionSampler,prevCoord,0.0).xyz;vec2 PrevShadows=textureLod(oldAccumulationSampler,prevCoord,0.0).xy;float newShadows=texelFetch(textureSampler,currentPixel,0).x;PrevShadows.y =
!reset && all(lessThan(abs(prevCoord-vec2(0.5)),vec2(0.5))) &&
distance(LP.xyz,PrevLP)<5e-2
? max(PrevShadows.y/(1.0+PrevShadows.y),1.0-remanence)
: 1.0;PrevShadows=max(vec2(0.0),PrevShadows);gl_FragColor=vec4(mix(PrevShadows.x,newShadows,PrevShadows.y),
PrevShadows.y,0,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},80188:function(e,t,i){i.r(t),i.d(t,{iblShadowDebugPixelShader:function(){return a}});var r=i(29427);let s="iblShadowDebugPixelShader",n=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D debugSampler;uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 debugColour=texture2D(debugSampler,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {gl_FragColor.rgb=mix(debugColour.rgb,background.rgb,0.0);gl_FragColor.a=1.0;}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},65608:function(e,t,i){i.r(t),i.d(t,{iblShadowGBufferDebugPixelShader:function(){return a}});var r=i(29427);let s="iblShadowGBufferDebugPixelShader",n=`#ifdef GL_ES
precision mediump float;
#endif
varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D prePass_NdcDepth;uniform sampler2D prePass_WorldNormal;uniform sampler2D prePass_Position;uniform sampler2D prePass_LocalPosition;uniform sampler2D prePass_VelocityLinear;uniform vec4 sizeParams;uniform float maxDepth;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 backgroundColour=texture2D(textureSampler,vUV).rgba;vec4 depth=texture2D(prePass_NdcDepth,vUV);vec4 worldNormal=texture2D(prePass_WorldNormal,vUV);vec4 worldPosition=texture2D(prePass_Position,vUV);vec4 localPosition=texture2D(prePass_LocalPosition,vUV);vec4 velocityLinear=texture2D(prePass_VelocityLinear,vUV);if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=backgroundColour;} else {gl_FragColor.a=1.0;if (uv.x<=0.2) { 
gl_FragColor.rgb=depth.rgb;gl_FragColor.a=1.0;} else if (uv.x<=0.4) {velocityLinear.rg=velocityLinear.rg*0.5+0.5;gl_FragColor.rgb=velocityLinear.rgb;} else if (uv.x<=0.6) {gl_FragColor.rgb=worldPosition.rgb;} else if (uv.x<=0.8) {gl_FragColor.rgb=localPosition.rgb;} else {gl_FragColor.rgb=worldNormal.rgb;}}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},93775:function(e,t,i){i.r(t),i.d(t,{iblShadowSpatialBlurPixelShader:function(){return a}});var r=i(29427);let s="iblShadowSpatialBlurPixelShader",n=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D linearDepthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D textureSampler;uniform vec4 blurParameters;
#define stridef blurParameters.x
#define worldScale blurParameters.y
const float weights[5]=float[5](0.0625,0.25,0.375,0.25,0.0625);const int nbWeights=5;vec2 max2(vec2 v,vec2 w) {return vec2(max(v.x,w.x),max(v.y,w.y));}
void main(void)
{vec2 Resolution=vec2(textureSize(linearDepthSampler,0));ivec2 PixelCoord=ivec2(vUV*Resolution);vec3 N=texelFetch(worldNormalSampler,PixelCoord,0).xyz;if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}
float depth=-texelFetch(linearDepthSampler,PixelCoord,0).x;vec2 X=vec2(0.0);for(int y=0; y<nbWeights; ++y) {for(int x=0; x<nbWeights; ++x) {ivec2 Coords=PixelCoord+ int(stridef)*ivec2(x-(nbWeights>>1),y-(nbWeights>>1));vec2 T=texelFetch(textureSampler,Coords,0).xy;float ddepth=-texelFetch(linearDepthSampler,Coords,0).x-depth;vec3 dN=texelFetch(worldNormalSampler,Coords,0).xyz-N;float w=weights[x]*weights[y] *
exp2(max(-1000.0/(worldScale*worldScale),-0.5) *
(ddepth*ddepth) -
1e1*dot(dN,dN));X+=vec2(w*T.x,w);}}
gl_FragColor=vec4(X.x/X.y,1.0,0.0,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},99221:function(e,t,i){i.r(t),i.d(t,{iblShadowVoxelTracingPixelShader:function(){return a}});var r=i(29427);let s="iblShadowVoxelTracingPixelShader",n=`precision highp sampler2D;precision highp sampler3D;
#define PI 3.1415927
varying vec2 vUV;
#define DISABLE_UNIFORMITY_ANALYSIS
uniform sampler2D depthSampler;uniform sampler2D worldNormalSampler;uniform sampler2D worldPositionSampler;uniform sampler2D blueNoiseSampler;uniform sampler2D icdfxSampler;uniform sampler2D icdfySampler;uniform sampler3D voxelGridSampler;uniform vec4 shadowParameters;
#define SHADOWdirs shadowParameters.x
#define SHADOWframe shadowParameters.y
#define SHADOWdownscale shadowParameters.z
#define SHADOWenvRot shadowParameters.w
uniform vec4 offsetDataParameters;
#define PixelOffset offsetDataParameters.xy
#define highestMipLevel offsetDataParameters.z
uniform vec4 sssParameters;
#define SSSsamples sssParameters.x
#define SSSstride sssParameters.y
#define SSSmaxDistance sssParameters.z
#define SSSthickness sssParameters.w
uniform vec4 shadowOpacity;uniform mat4 projMtx;uniform mat4 viewMtx;uniform mat4 invProjMtx;uniform mat4 invViewMtx;uniform mat4 wsNormalizationMtx;uniform mat4 invVPMtx;
#define PI 3.1415927
#define GOLD 0.618034
struct AABB3f {vec3 m_min;vec3 m_max;};struct Ray {vec3 orig;vec3 dir;vec3 dir_rcp;float t_min;float t_max;};Ray make_ray(const vec3 origin,const vec3 direction,const float tmin,
const float tmax) {Ray ray;ray.orig=origin;ray.dir=direction;ray.dir_rcp=1.0f/direction;ray.t_min=tmin;ray.t_max=tmax;return ray;}
bool ray_box_intersection(const in AABB3f aabb,const in Ray ray,
out float distance_near,out float distance_far) {vec3 tbot=ray.dir_rcp*(aabb.m_min-ray.orig);vec3 ttop=ray.dir_rcp*(aabb.m_max-ray.orig);vec3 tmin=min(ttop,tbot);vec3 tmax=max(ttop,tbot);distance_near=max(ray.t_min,max(tmin.x,max(tmin.y,tmin.z)));distance_far=min(ray.t_max,min(tmax.x,min(tmax.y,tmax.z)));return distance_near<=distance_far;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
struct VoxelMarchDiagnosticInfo {float heat;ivec3 voxel_intersect_coords;};
#endif
uint hash(uint i) {i ^= i>>16u;i*=0x7FEB352Du;i ^= i>>15u;i*=0x846CA68Bu;i ^= i>>16u;return i;}
float uint2float(uint i) {return uintBitsToFloat(0x3F800000u | (i>>9u))-1.0;}
vec3 uv_to_normal(vec2 uv) {vec3 N;vec2 uvRange=uv;float theta=uvRange.x*2.0*PI;float phi=uvRange.y*PI;N.x=cos(theta)*sin(phi);N.z=sin(theta)*sin(phi);N.y=cos(phi);return N;}
vec2 plasticSequence(const uint rstate) {return vec2(uint2float(rstate*3242174889u),
uint2float(rstate*2447445414u));}
float goldenSequence(const uint rstate) {return uint2float(rstate*2654435769u);}
float distanceSquared(vec2 a,vec2 b) {vec2 diff=a-b;return dot(diff,diff);}
void genTB(const vec3 N,out vec3 T,out vec3 B) {float s=N.z<0.0 ? -1.0 : 1.0;float a=-1.0/(s+N.z);float b=N.x*N.y*a;T=vec3(1.0+s*N.x*N.x*a,s*b,-s*N.x);B=vec3(b,s+N.y*N.y*a,-N.y);}
int stack[24]; 
#define PUSH(i) stack[stackLevel++]=i; 
#define POP() stack[--stackLevel] 
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
bool anyHitVoxels(const Ray ray_vs,
out VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {
#else
bool anyHitVoxels(const Ray ray_vs) {
#endif
vec3 invD=ray_vs.dir_rcp;vec3 D=ray_vs.dir;vec3 O=ray_vs.orig;ivec3 negD=ivec3(lessThan(D,vec3(0,0,0)));int voxel0=negD.x | negD.y<<1 | negD.z<<2;vec3 t0=-O*invD,t1=(vec3(1.0)-O)*invD;int maxLod=int(highestMipLevel);int stackLevel=0;
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
uint steps=0u;
#endif
PUSH(maxLod<<24);while (stackLevel>0) {int elem=POP();ivec4 Coords =
ivec4(elem & 0xFF,elem>>8 & 0xFF,elem>>16 & 0xFF,elem>>24);if (Coords.w==0) {
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
voxel_march_diagnostic_info.heat=float(steps)/24.0;
#endif
return true;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
++steps;
#endif
float invRes=exp2(float(Coords.w-maxLod));vec3 bbmin=invRes*vec3(Coords.xyz+negD);vec3 bbmax=invRes*vec3(Coords.xyz-negD+ivec3(1));vec3 mint=mix(t0,t1,bbmin);vec3 maxt=mix(t0,t1,bbmax);vec3 midt=0.5*(mint+maxt);mint.x=max(0.0,mint.x);midt.x=max(0.0,midt.x);int nodeMask=int(
round(texelFetch(voxelGridSampler,Coords.xyz,Coords.w).x*255.0));Coords.w--;int voxelBit=voxel0;Coords.xyz=(Coords.xyz<<1)+negD;int packedCoords =
Coords.x | Coords.y<<8 | Coords.z<<16 | Coords.w<<24;if (max(mint.x,max(mint.y,mint.z))<min(midt.x,min(midt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(mint.y,mint.z))<min(maxt.x,min(midt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(midt.y,mint.z))<min(maxt.x,min(maxt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(midt.y,mint.z))<min(midt.x,min(maxt.y,midt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x4;packedCoords ^= 0x10000;if (max(mint.x,max(midt.y,midt.z))<min(midt.x,min(maxt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(midt.x,max(midt.y,midt.z))<min(maxt.x,min(maxt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x2;packedCoords ^= 0x00100;if (max(midt.x,max(mint.y,midt.z))<min(maxt.x,min(midt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);voxelBit ^= 0x1;packedCoords ^= 0x00001;if (max(mint.x,max(mint.y,midt.z))<min(midt.x,min(midt.y,maxt.z)) &&
(1<<voxelBit & nodeMask) != 0)
PUSH(packedCoords);}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
voxel_march_diagnostic_info.heat=float(steps)/24.0;
#endif
return false;}
float screenSpaceShadow(vec3 csOrigin,vec3 csDirection,vec2 csZBufferSize,
float nearPlaneZ,float noise) {
#ifdef RIGHT_HANDED
float csZDir=-1.0;
#else 
float csZDir=1.0;
#endif
float ssSamples=SSSsamples;float ssMaxDist=SSSmaxDistance;float ssStride=SSSstride;float ssThickness=SSSthickness;float rayLength =
csZDir*(csOrigin.z+ssMaxDist*csDirection.z)<csZDir*nearPlaneZ
? 
(nearPlaneZ-csOrigin.z)/csDirection.z
: ssMaxDist;vec3 csEndPoint=csOrigin+rayLength*csDirection;vec4 H0=projMtx*vec4(csOrigin,1.0);vec4 H1=projMtx*vec4(csEndPoint,1.0);
#ifndef IS_NDC_HALF_ZRANGE
float Z0=(0.5*H0.z/H0.w+0.5);float Z1=(0.5*H1.z/H1.w+0.5);
#else
float Z0=(H0.z/H0.w);float Z1=(H1.z/H1.w);
#endif
vec2 P0=csZBufferSize*(0.5*H0.xy/H0.w+0.5);vec2 P1=csZBufferSize*(0.5*H1.xy/H1.w+0.5);P1+=vec2(distanceSquared(P0,P1)<0.0001 ? 0.01 : 0.0);vec2 delta=P1-P0;bool permute=false;if (abs(delta.x)<abs(delta.y)) {permute=true;P0=P0.yx;P1=P1.yx;delta=delta.yx;}
float stepDirection=sign(delta.x);float invdx=stepDirection/delta.x;vec2 dP=ssStride*vec2(stepDirection,invdx*delta.y);float dZ=ssStride*invdx*(Z1-Z0);float opacity=0.0;vec2 P=P0+noise*dP;float Z=Z0+noise*dZ;float end=P1.x*stepDirection;Z+=dZ;for (float stepCount=0.0;opacity<1.0 && P.x*stepDirection<end && stepCount<ssSamples;stepCount++,P+=dP,
Z+=dZ) { 
ivec2 coords=ivec2(permute ? P.yx : P);float sceneDepth=texelFetch(depthSampler,coords,0).x;float thicknessScale=pow(1.0-sceneDepth,1.6);opacity +=
max(opacity,step(Z+dZ,sceneDepth+thicknessScale*ssThickness) *
step(sceneDepth,Z));}
return opacity;}
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
float voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,
vec2 DitherNoise,
out VoxelMarchDiagnosticInfo voxel_march_diagnostic_info) {
#else
float voxelShadow(vec3 wsOrigin,vec3 wsDirection,vec3 wsNormal,
vec2 DitherNoise) {
#endif
float vxResolution=float(textureSize(voxelGridSampler,0).x);vec3 T,B;genTB(wsDirection,T,B);vec2 DitherXY=sqrt(DitherNoise.x)*vec2(cos(2.0*PI*DitherNoise.y),
sin(2.0*PI*DitherNoise.y));vec3 Dithering =
(2.0*wsNormal+3.0*wsDirection+DitherXY.x*T+DitherXY.y*B) /
vxResolution;vec3 O=0.5*wsOrigin+0.5+Dithering;Ray ray_vs=make_ray(O,wsDirection,0.0,10.0);AABB3f voxel_aabb;voxel_aabb.m_min=vec3(0);voxel_aabb.m_max=vec3(1);float near,far;if (!ray_box_intersection(voxel_aabb,ray_vs,near,far))
return 0.0;ray_vs.t_min=max(ray_vs.t_min,near);ray_vs.t_max=min(ray_vs.t_max,far);
#if VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
return anyHitVoxels(ray_vs,voxel_march_diagnostic_info) ? 1.0f : 0.0f;
#else
return anyHitVoxels(ray_vs) ? 1.0f : 0.0f;
#endif
}
void main(void) {uint nbDirs=uint(SHADOWdirs);uint frameId=uint(SHADOWframe);int downscale=int(SHADOWdownscale);float envRot=SHADOWenvRot;vec2 Resolution=vec2(textureSize(depthSampler,0));ivec2 currentPixel=ivec2(vUV*Resolution);ivec2 PixelCoord=ivec2(vec2(currentPixel*downscale)+PixelOffset.xy);uint GlobalIndex =
(frameId*uint(Resolution.y)+uint(PixelCoord.y))*uint(Resolution.x) +
uint(PixelCoord.x);vec3 N=texelFetch(worldNormalSampler,PixelCoord,0).xyz;N=N*vec3(2.0)-vec3(1.0);if (length(N)<0.01) {glFragColor=vec4(1.0,1.0,0.0,1.0);return;}
float normalizedRotation=envRot/(2.0*PI);float depth=texelFetch(depthSampler,PixelCoord,0).x;
#ifndef IS_NDC_HALF_ZRANGE
depth=depth*2.0-1.0;
#endif
vec2 temp=(vec2(PixelCoord)+vec2(0.5))*2.0/Resolution-vec2(1.0);vec2 temp2=vUV*vec2(2.0)-vec2(1.0);vec4 VP=invProjMtx*vec4(temp.x,-temp.y,depth,1.0);VP/=VP.w;N=normalize(N);vec3 noise=texelFetch(blueNoiseSampler,PixelCoord & 0xFF,0).xyz;noise.z=fract(noise.z+goldenSequence(frameId*nbDirs));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
float heat=0.0f;
#endif
float shadowAccum=0.0;for (uint i=0u; i<nbDirs; i++) {uint dirId=nbDirs*GlobalIndex+i;vec4 L;{vec2 r=plasticSequence(frameId*nbDirs+i);r=fract(r+vec2(2.0)*abs(noise.xy-vec2(0.5)));vec2 T;T.x=textureLod(icdfxSampler,vec2(r.x,0.0),0.0).x;T.y=textureLod(icdfySampler,vec2(T.x,r.y),0.0).x;T.x-=normalizedRotation;L=vec4(uv_to_normal(T),0);
#ifndef RIGHT_HANDED
L.z*=-1.0;
#endif
}
float edge_tint_const=-0.001;float cosNL=dot(N,L.xyz);float opacity=cosNL<edge_tint_const ? 1.0 : 0.0;if (cosNL>edge_tint_const) {vec4 VP2=VP;VP2.y*=-1.0;vec4 unormWP=invViewMtx*VP2;vec3 WP=(wsNormalizationMtx*unormWP).xyz;vec2 vxNoise =
vec2(uint2float(hash(dirId*2u)),uint2float(hash(dirId*2u+1u)));
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
VoxelMarchDiagnosticInfo voxel_march_diagnostic_info;opacity=max(opacity,
shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise,
voxel_march_diagnostic_info));heat+=voxel_march_diagnostic_info.heat;
#else
opacity =
max(opacity,shadowOpacity.x*voxelShadow(WP,L.xyz,N,vxNoise));
#endif
vec3 VL=(viewMtx*L).xyz;float nearPlaneZ =
-projMtx[3][2]/projMtx[2][2]; 
float ssShadow=shadowOpacity.y *
screenSpaceShadow(VP2.xyz,VL,Resolution,nearPlaneZ,
abs(2.0*noise.z-1.0));opacity=max(opacity,ssShadow);shadowAccum+=min(1.0-opacity,smoothstep(-0.1,0.2,cosNL));} else {shadowAccum+=min(1.0-opacity,smoothstep(-0.1,0.2,cosNL));}
noise.z=fract(noise.z+GOLD);}
#ifdef VOXEL_MARCH_DIAGNOSTIC_INFO_OPTION
gl_FragColor =
vec4(shadowAccum/float(nbDirs),heat/float(nbDirs),0.0,1.0);
#else
gl_FragColor=vec4(shadowAccum/float(nbDirs),0.0,0.0,1.0);
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},74001:function(e,t,i){i.r(t),i.d(t,{iblShadowsCdfxPixelShader:function(){return a}});var r=i(29427);let s="iblShadowsCdfxPixelShader",n=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfy;void main(void) {ivec2 cdfyRes=textureSize(cdfy,0);ivec2 currentPixel=ivec2(gl_FragCoord.xy);float cdfx=0.0;for (int x=1; x<=currentPixel.x; x++) {cdfx+=texelFetch(cdfy,ivec2(x-1,cdfyRes.y-1),0).x;}
gl_FragColor=vec4(vec3(cdfx),1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},69869:function(e,t,i){i.r(t),i.d(t,{iblShadowsCdfyPixelShader:function(){return a}});var r=i(29427);let s="iblShadowsCdfyPixelShader",n=`precision highp sampler2D;precision highp samplerCube;
#define PI 3.1415927
varying vec2 vUV;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform int iblHeight;
#ifdef IBL_USE_CUBE_MAP
vec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
float fetchCube(vec2 uv) {vec3 direction=equirectangularToCubemapDirection(uv);return sin(PI*uv.y)*dot(textureCubeLodEXT(iblSource,direction,0.0).rgb,
vec3(0.3,0.6,0.1));}
#else
float fetchPanoramic(ivec2 Coords,float envmapHeight) {return sin(PI*(float(Coords.y)+0.5)/envmapHeight) *
dot(texelFetch(iblSource,Coords,0).rgb,vec3(0.3,0.6,0.1));}
#endif
void main(void) {ivec2 coords=ivec2(gl_FragCoord.x,gl_FragCoord.y);float cdfy=0.0;for (int y=1; y<=coords.y; y++) {
#ifdef IBL_USE_CUBE_MAP
vec2 uv=vec2(vUV.x,(float(y-1)+0.5)/float(iblHeight));cdfy+=fetchCube(uv);
#else
cdfy+=fetchPanoramic(ivec2(coords.x,y-1),float(iblHeight));
#endif
}
gl_FragColor=vec4(cdfy,0.0,0.0,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},60398:function(e,t,i){i.r(t),i.d(t,{iblShadowsCombinePixelShader:function(){return a}});var r=i(29427);let s="iblShadowsCombinePixelShader",n=`precision highp float;varying vec2 vUV;uniform sampler2D sceneTexture;uniform sampler2D textureSampler;uniform float shadowOpacity;void main(void)
{vec3 color=texture(sceneTexture,vUV).rgb;vec3 shadow=texture(textureSampler,vUV).rgb;float shadowValue=mix(1.0,shadow.x,shadowOpacity);gl_FragColor=vec4(color*shadowValue,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},70376:function(e,t,i){i.r(t),i.d(t,{iblShadowsIcdfxPixelShader:function(){return a}});var r=i(29427);let s="iblShadowsIcdfxPixelShader",n=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfx;float fetchCDF(int x) {return texelFetch(cdfx,ivec2(x,0),0).x;}
float bisect(int size,float targetValue)
{int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDF(c)<targetValue)
a=c;else
b=c;}
return mix(float(a),float(b),(targetValue-fetchCDF(a))/(fetchCDF(b)-fetchCDF(a)))/float(size-1);}
void main(void) {ivec2 cdfSize=textureSize(cdfx,0);int cdfWidth=cdfSize.x;int icdfWidth=cdfWidth-1;ivec2 currentPixel=ivec2(gl_FragCoord.xy);if (currentPixel.x==0)
{gl_FragColor=vec4(0.0);}
else if (currentPixel.x==icdfWidth-1) {gl_FragColor=vec4(1.0);} else {float targetValue=fetchCDF(cdfWidth-1)*vUV.x;gl_FragColor=vec4(vec3(bisect(cdfWidth,targetValue)),1.0);}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},71393:function(e,t,i){i.r(t),i.d(t,{iblShadowsIcdfyPixelShader:function(){return a}});var r=i(29427);let s="iblShadowsIcdfyPixelShader",n=`precision highp sampler2D;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfy;float fetchCDF(int y,int invocationId) {return texelFetch(cdfy,ivec2(invocationId,y),0).x;}
float bisect(int size,float targetValue,int invocationId)
{int a=0,b=size-1;while (b-a>1) {int c=a+b>>1;if (fetchCDF(c,invocationId)<targetValue)
a=c;else
b=c;}
return mix(float(a),float(b),(targetValue-fetchCDF(a,invocationId))/(fetchCDF(b,invocationId)-fetchCDF(a,invocationId)))/float(size-1);}
void main(void) {ivec2 cdfSize=textureSize(cdfy,0);int cdfHeight=cdfSize.y;ivec2 currentPixel=ivec2(gl_FragCoord.xy);if (currentPixel.y==0)
{gl_FragColor=vec4(0.0);}
else if (currentPixel.y==cdfHeight-2) {gl_FragColor=vec4(1.0);} else {float targetValue=fetchCDF(cdfHeight-1,currentPixel.x)*vUV.y;gl_FragColor=vec4(vec3(bisect(cdfHeight,targetValue,currentPixel.x)),1.0);}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},83280:function(e,t,i){i.r(t),i.d(t,{iblShadowsImportanceSamplingDebugPixelShader:function(){return a}});var r=i(29427);let s="iblShadowsImportanceSamplingDebugPixelShader",n=`precision highp samplerCube;
#define PI 3.1415927
varying vec2 vUV;uniform sampler2D cdfy;uniform sampler2D icdfy;uniform sampler2D cdfx;uniform sampler2D icdfx;
#ifdef IBL_USE_CUBE_MAP
uniform samplerCube iblSource;
#else
uniform sampler2D iblSource;
#endif
uniform sampler2D textureSampler;
#define cdfyVSize 0.4
#define cdfxVSize 0.1
#define cdfyHSize 0.5
uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
#ifdef IBL_USE_CUBE_MAP
vec3 equirectangularToCubemapDirection(vec2 uv) {float longitude=uv.x*2.0*PI-PI;float latitude=PI*0.5-uv.y*PI;vec3 direction;direction.x=cos(latitude)*sin(longitude);direction.y=sin(latitude);direction.z=cos(latitude)*cos(longitude);return direction;}
#endif
void main(void) {vec3 colour=vec3(0.0);vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec3 backgroundColour=texture2D(textureSampler,vUV).rgb;const float iblStart=1.0-cdfyVSize;const float cdfyStart=1.0-2.0*cdfyVSize;const float cdfxStart=1.0-2.0*cdfyVSize-cdfxVSize;const float icdfxStart=1.0-2.0*cdfyVSize-2.0*cdfxVSize;
#ifdef IBL_USE_CUBE_MAP
vec3 direction=equirectangularToCubemapDirection(
(uv-vec2(0.0,iblStart))*vec2(1.0,1.0/cdfyVSize));vec3 iblColour=textureCubeLodEXT(iblSource,direction,0.0).rgb;
#else
vec3 iblColour=texture2D(iblSource,(uv-vec2(0.0,iblStart)) *
vec2(1.0,1.0/cdfyVSize))
.rgb;
#endif
float cdfyColour =
texture2D(cdfy,(uv-vec2(0.0,cdfyStart))*vec2(2.0,1.0/cdfyVSize))
.r;float icdfyColour =
texture2D(icdfy,(uv-vec2(0.5,cdfyStart))*vec2(2.0,1.0/cdfyVSize))
.r;float cdfxColour =
texture2D(cdfx,(uv-vec2(0.0,cdfxStart))*vec2(1.0,1.0/cdfxVSize))
.r;float icdfxColour=texture2D(icdfx,(uv-vec2(0.0,icdfxStart)) *
vec2(1.0,1.0/cdfxVSize))
.r;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {colour=backgroundColour;} else if (uv.y>iblStart) {colour+=iblColour;} else if (uv.y>cdfyStart && uv.x<0.5) {colour.r+=0.003*cdfyColour;} else if (uv.y>cdfyStart && uv.x>0.5) {colour.r+=icdfyColour;} else if (uv.y>cdfxStart) {colour.r+=0.00003*cdfxColour;} else if (uv.y>icdfxStart) {colour.r+=icdfxColour;}
gl_FragColor=vec4(colour,1.0);glFragColor.rgb=mix(gl_FragColor.rgb,backgroundColour,0.5);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},66925:function(e,t,i){i.r(t),i.d(t,{iblVoxelGridPixelShader:function(){return a}});var r=i(29427);let s="iblVoxelGridPixelShader",n=`precision highp float;layout(location=0) out highp float glFragData[MAX_DRAW_BUFFERS];varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;if (normPos.z<nearPlane || normPos.z>farPlane) {discard;}
glFragData[0]=normPos.z<nearPlane+stepSize ? 1.0 : 0.0;glFragData[1]=normPos.z>=nearPlane+stepSize && normPos.z<nearPlane+2.0*stepSize ? 1.0 : 0.0;glFragData[2]=normPos.z>=nearPlane+2.0*stepSize && normPos.z<nearPlane+3.0*stepSize ? 1.0 : 0.0;glFragData[3]=normPos.z>=nearPlane+3.0*stepSize && normPos.z<nearPlane+4.0*stepSize ? 1.0 : 0.0;
#if MAX_DRAW_BUFFERS>4
glFragData[4]=normPos.z>=nearPlane+4.0*stepSize && normPos.z<nearPlane+5.0*stepSize ? 1.0 : 0.0;glFragData[5]=normPos.z>=nearPlane+5.0*stepSize && normPos.z<nearPlane+6.0*stepSize ? 1.0 : 0.0;glFragData[6]=normPos.z>=nearPlane+6.0*stepSize && normPos.z<nearPlane+7.0*stepSize ? 1.0 : 0.0;glFragData[7]=normPos.z>=nearPlane+7.0*stepSize && normPos.z<nearPlane+8.0*stepSize ? 1.0 : 0.0;
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},34805:function(e,t,i){i.r(t),i.d(t,{iblVoxelGridVertexShader:function(){return a}});var r=i(29427);let s="iblVoxelGridVertexShader",n=`attribute vec3 position;attribute vec3 normal;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 viewMatrix;void main(void) {gl_Position=viewMatrix*invWorldScale*world*vec4(position,1.);vNormalizedPosition.xyz=gl_Position.xyz*0.5+0.5;
#ifdef IS_NDC_HALF_ZRANGE
gl_Position.z=gl_Position.z*0.5+0.5;
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},89092:function(e,t,i){i.r(t),i.d(t,{iblVoxelGrid2dArrayDebugPixelShader:function(){return a}});var r=i(29427);let s="iblVoxelGrid2dArrayDebugPixelShader",n="precision highp sampler2DArray;varying vec2 vUV;uniform sampler2DArray voxelTexture;uniform sampler2D textureSampler;uniform int slice;void main(void) {ivec3 size=textureSize(voxelTexture,0);float dimension=sqrt(float(size.z));vec2 samplePos=fract(vUV.xy*vec2(dimension));int sampleIndex=int(floor(vUV.x*float(dimension))+floor(vUV.y*float(dimension))*dimension);glFragColor.rgb=texture(voxelTexture,vec3(samplePos.xy,sampleIndex)).rrr;glFragColor.a=1.0;glFragColor.rgb+=texture(textureSampler,vUV.xy).rgb;}";r.v.ShadersStore[s]=n;let a={name:s,shader:n}},54734:function(e,t,i){i.r(t),i.d(t,{iblVoxelGrid3dDebugPixelShader:function(){return a}});var r=i(29427);let s="iblVoxelGrid3dDebugPixelShader",n=`precision highp sampler3D;varying vec2 vUV;uniform sampler3D voxelTexture;uniform sampler2D voxelSlabTexture;uniform sampler2D textureSampler;uniform vec4 sizeParams;
#define offsetX sizeParams.x
#define offsetY sizeParams.y
#define widthScale sizeParams.z
#define heightScale sizeParams.w
uniform float mipNumber;void main(void) {vec2 uv =
vec2((offsetX+vUV.x)*widthScale,(offsetY+vUV.y)*heightScale);vec4 background=texture2D(textureSampler,vUV);vec4 voxelSlab=texture2D(voxelSlabTexture,vUV);ivec3 size=textureSize(voxelTexture,int(mipNumber));float dimension=ceil(sqrt(float(size.z)));vec2 samplePos=fract(uv.xy*vec2(dimension));int sampleIndex=int(floor(uv.x*float(dimension)) +
floor(uv.y*float(dimension))*dimension);float mip_separator=0.0;if (samplePos.x<0.01 || samplePos.y<0.01) {mip_separator=1.0;}
bool outBounds=sampleIndex>size.z-1 ? true : false;sampleIndex=clamp(sampleIndex,0,size.z-1);ivec2 samplePosInt=ivec2(samplePos.xy*vec2(size.xy));vec3 voxel=texelFetch(voxelTexture,
ivec3(samplePosInt.x,samplePosInt.y,sampleIndex),
int(mipNumber))
.rgb;if (uv.x<0.0 || uv.x>1.0 || uv.y<0.0 || uv.y>1.0) {gl_FragColor.rgba=background;} else {if (outBounds) {voxel=vec3(0.15,0.0,0.0);} else {if (voxel.r>0.001) {voxel.g=1.0;}
voxel.r+=mip_separator;}
glFragColor.rgb=mix(background.rgb,voxelSlab.rgb,voxelSlab.a)+voxel;glFragColor.a=1.0;}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},78821:function(e,t,i){i.r(t),i.d(t,{iblVoxelSlabDebugPixelShader:function(){return a}});var r=i(29427);let s="iblVoxelSlabDebugPixelShader",n=`precision highp float;varying vec3 vNormalizedPosition;uniform float nearPlane;uniform float farPlane;uniform float stepSize;void main(void) {vec3 normPos=vNormalizedPosition.xyz;float chunkSize=stepSize*float(MAX_DRAW_BUFFERS);float numChunks=1.0/chunkSize;float positionInChunk=fract(normPos.z/chunkSize);float slab=floor(positionInChunk*float(MAX_DRAW_BUFFERS)) /
float(MAX_DRAW_BUFFERS);if (normPos.x<0.0 || normPos.y<0.0 || normPos.z<0.0 ||
normPos.x>1.0 || normPos.y>1.0 || normPos.z>1.0) {gl_FragColor=vec4(0.0,0.0,0.0,0.0);} else {gl_FragColor=vec4(slab,0.0,0.0,0.75);}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},28346:function(e,t,i){i.r(t),i.d(t,{iblVoxelSlabDebugVertexShader:function(){return a}});var r=i(29427);let s="iblVoxelSlabDebugVertexShader",n="attribute vec3 position;varying vec3 vNormalizedPosition;uniform mat4 world;uniform mat4 invWorldScale;uniform mat4 cameraViewMatrix;uniform mat4 projection;uniform mat4 viewMatrix;void main(void) {vec4 worldPosition=(world*vec4(position,1.));gl_Position=projection*cameraViewMatrix*worldPosition;vNormalizedPosition=(viewMatrix*invWorldScale*worldPosition).rgb;vNormalizedPosition.xyz=vNormalizedPosition.xyz*vec3(0.5)+vec3(0.5);}";r.v.ShadersStore[s]=n;let a={name:s,shader:n}},22382:function(e,t,i){i.r(t),i.d(t,{imageProcessingPixelShader:function(){return a}});var r=i(29427);i(76909),i(7565),i(25902);let s="imageProcessingPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},54378:function(e,t,i){i.r(t),i.d(t,{kernelBlurPixelShader:function(){return l}});var r=i(29427);i(18503),i(43870);let s=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;r.v.IncludesShadersStore.kernelBlurFragment=s;let n=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});computedWeight=KERNEL_DEP_WEIGHT{X}*factor;sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;r.v.IncludesShadersStore.kernelBlurFragment2=n;let a="kernelBlurPixelShader",o=`uniform sampler2D textureSampler;uniform vec2 delta;varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;float sampleCoC(in vec2 offset) {float coc=texture2D(circleOfConfusionSampler,offset).r;return coc; }
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{float computedWeight=0.0;
#ifdef PACKEDFLOAT
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;r.v.ShadersStore[a]=o;let l={name:a,shader:o}},1778:function(e,t,i){i.r(t),i.d(t,{kernelBlurVertexShader:function(){return a}});var r=i(29427);i(18503),r.v.IncludesShadersStore.kernelBlurVertex="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";let s="kernelBlurVertexShader",n=`attribute vec2 position;uniform vec2 delta;varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},94566:function(e,t,i){i.r(t),i.d(t,{layerPixelShader:function(){return a}});var r=i(29427);i(7565);let s="layerPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},14337:function(e,t,i){i.r(t),i.d(t,{layerVertexShader:function(){return a}});var r=i(29427);let s="layerVertexShader",n=`attribute vec2 position;uniform vec2 scale;uniform vec2 offset;uniform mat4 textureMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 shiftedPosition=position*scale+offset;vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));gl_Position=vec4(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},42850:function(e,t,i){i.r(t),i.d(t,{lensFlarePixelShader:function(){return a}});var r=i(29427);let s="lensFlarePixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec4 color;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},90525:function(e,t,i){i.r(t),i.d(t,{lensFlareVertexShader:function(){return a}});var r=i(29427);let s="lensFlareVertexShader",n=`attribute vec2 position;uniform mat4 viewportMatrix;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;gl_Position=viewportMatrix*vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},29688:function(e,t,i){i.r(t),i.d(t,{linePixelShader:function(){return a}});var r=i(29427);i(56119),i(41871),i(28951),i(81269);let s="linePixelShader",n=`#include<clipPlaneFragmentDeclaration>
uniform vec4 color;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<logDepthFragment>
#include<clipPlaneFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},98370:function(e,t,i){i.r(t),i.d(t,{lineVertexShader:function(){return l}});var r=i(29427);let s=`uniform mat4 viewProjection;
#define ADDITIONAL_VERTEX_DECLARATION
`;r.v.IncludesShadersStore.lineVertexDeclaration=s,i(16282),i(33587);let n=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.v.IncludesShadersStore.lineUboDeclaration=n,i(48714),i(64676),i(41871),i(85814),i(12637),i(74450);let a="lineVertexShader",o=`#include<__decl__lineVertex>
#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;attribute vec4 normal;uniform float width;uniform float aspectRatio;
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;vec4 viewPosition=worldViewProjection*vec4(position,1.0);vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);vec2 currentScreen=viewPosition.xy/viewPosition.w;vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;currentScreen.x*=aspectRatio;nextScreen.x*=aspectRatio;vec2 dir=normalize(nextScreen-currentScreen);vec2 normalDir=vec2(-dir.y,dir.x);normalDir*=width/2.0;normalDir.x/=aspectRatio;vec4 offset=vec4(normalDir*normal.w,0.0,0.0);gl_Position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<clipPlaneVertex>
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[a]=o;let l={name:a,shader:o}},44667:function(e,t,i){i.r(t),i.d(t,{lodPixelShader:function(){return a}});var r=i(29427);let s="lodPixelShader",n=`#extension GL_EXT_shader_texture_lod : enable
precision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform sampler2D textureSampler;uniform float lod;uniform vec2 texSize;uniform int gamma;void main(void)
{gl_FragColor=textureLod(textureSampler,vUV,lod);if (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},88734:function(e,t,i){i.r(t),i.d(t,{lodCubePixelShader:function(){return a}});var r=i(29427);let s="lodCubePixelShader",n=`precision highp float;const float GammaEncodePowerApprox=1.0/2.2;varying vec2 vUV;uniform samplerCube textureSampler;uniform float lod;uniform int gamma;void main(void)
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x),lod);
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x),lod);
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x),lod);
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x),lod);
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001),lod);
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001),lod);
#endif
if (gamma==0) {gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(GammaEncodePowerApprox));}}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},27498:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererPixelShader:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererPixelShader",n=`precision highp float;varying vec2 vDecalTC;uniform sampler2D textureSampler;void main(void) {if (vDecalTC.x<0. || vDecalTC.x>1. || vDecalTC.y<0. || vDecalTC.y>1.) {discard;}
gl_FragColor=texture2D(textureSampler,vDecalTC);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},65602:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererVertexShader:function(){return a}});var r=i(29427);i(74910),i(96944),i(50731),i(43626),i(48714),i(76086),i(74436),i(85814),i(27373),i(59343);let s="meshUVSpaceRendererVertexShader",n=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;uniform mat4 projMatrix;varying vec2 vDecalTC;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
void main(void) {vec3 positionUpdated=position;vec3 normalUpdated=normal;
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);mat3 normWorldSM=mat3(finalWorld);vec3 vNormalW;
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vNormalW=normalize(normWorldSM*normalUpdated);
#endif
vec3 normalView=normalize((projMatrix*vec4(vNormalW,0.0)).xyz);vec3 decalTC=(projMatrix*worldPos).xyz;vDecalTC=decalTC.xy;gl_Position=vec4(uv*2.0-1.0,normalView.z>0.0 ? 2. : decalTC.z,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},25972:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererFinaliserPixelShader:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererFinaliserPixelShader",n=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D maskTextureSampler;uniform vec2 textureSize;void main() {vec4 mask=texture2D(maskTextureSampler,vUV).rgba;if (mask.r>0.5) {gl_FragColor=texture2D(textureSampler,vUV);} else {vec2 texelSize=4.0/textureSize;vec2 uv_p01=vUV+vec2(-1.0,0.0)*texelSize;vec2 uv_p21=vUV+vec2(1.0,0.0)*texelSize;vec2 uv_p10=vUV+vec2(0.0,-1.0)*texelSize;vec2 uv_p12=vUV+vec2(0.0,1.0)*texelSize;float mask_p01=texture2D(maskTextureSampler,uv_p01).r;float mask_p21=texture2D(maskTextureSampler,uv_p21).r;float mask_p10=texture2D(maskTextureSampler,uv_p10).r;float mask_p12=texture2D(maskTextureSampler,uv_p12).r;vec4 col=vec4(0.0,0.0,0.0,0.0);float total_weight=0.0;if (mask_p01>0.5) {col+=texture2D(textureSampler,uv_p01);total_weight+=1.0;}
if (mask_p21>0.5) {col+=texture2D(textureSampler,uv_p21);total_weight+=1.0;}
if (mask_p10>0.5) {col+=texture2D(textureSampler,uv_p10);total_weight+=1.0;}
if (mask_p12>0.5) {col+=texture2D(textureSampler,uv_p12);total_weight+=1.0;}
if (total_weight>0.0) {gl_FragColor=col/total_weight;} else {gl_FragColor=col;}}}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},49111:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererFinaliserVertexShader:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererFinaliserVertexShader",n=`precision highp float;attribute vec3 position;attribute vec2 uv;uniform mat4 worldViewProjection;varying vec2 vUV;void main() {gl_Position=worldViewProjection*vec4(position,1.0);vUV=uv;}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},8022:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererMaskerPixelShader:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererMaskerPixelShader",n=`varying vec2 vUV;void main(void) {gl_FragColor=vec4(1.0,1.0,1.0,1.0);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},91118:function(e,t,i){i.r(t),i.d(t,{meshUVSpaceRendererMaskerVertexShader:function(){return a}});var r=i(29427);let s="meshUVSpaceRendererMaskerVertexShader",n="attribute vec2 uv;varying vec2 vUV;void main(void) {gl_Position=vec4(vec2(uv.x,uv.y)*2.0-1.0,0.,1.0);vUV=uv;}";r.v.ShadersStore[s]=n;let a={name:s,shader:n}},95759:function(e,t,i){i.r(t),i.d(t,{motionBlurPixelShader:function(){return a}});var r=i(29427);let s="motionBlurPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float motionStrength;uniform float motionScale;uniform vec2 screenSize;
#ifdef OBJECT_BASED
uniform sampler2D velocitySampler;
#else
uniform sampler2D depthSampler;uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform mat4 projection;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
vec2 texelSize=1.0/screenSize;vec4 velocityColor=texture2D(velocitySampler,vUV);velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;velocity*=motionScale*motionStrength;float speed=length(velocity/texelSize);int samplesCount=int(clamp(speed,1.0,SAMPLES));velocity=normalize(velocity)*texelSize;float hlim=float(-samplesCount)*0.5+0.5;vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i)
{if (i>=samplesCount)
break;vec2 offset=vUV+velocity*(hlim+float(i));
#if defined(WEBGPU)
result+=texture2DLodEXT(textureSampler,offset,0.0);
#else
result+=texture2D(textureSampler,offset);
#endif
}
gl_FragColor=result/float(samplesCount);gl_FragColor.a=1.0;
#else
vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;depth=projection[2].z+projection[3].z/depth; 
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=inverseViewProjection*cpos;cpos/=cpos.w;vec4 ppos=prevViewProjection*cpos;ppos/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(SAMPLES); ++i) {if (i>=nSamples)
break;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
#if defined(WEBGPU)
result+=texture2DLodEXT(textureSampler,offset1,0.0);
#else
result+=texture2D(textureSampler,offset1);
#endif
}
gl_FragColor=result/float(nSamples);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},50324:function(e,t,i){i.r(t),i.d(t,{oitBackBlendPixelShader:function(){return a}});var r=i(29427);let s="oitBackBlendPixelShader",n=`precision highp float;uniform sampler2D uBackColor;void main() {glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);if (glFragColor.a==0.0) { 
discard;}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},31515:function(e,t,i){i.r(t),i.d(t,{oitFinalPixelShader:function(){return a}});var r=i(29427);let s="oitFinalPixelShader",n=`precision highp float;uniform sampler2D uFrontColor;uniform sampler2D uBackColor;void main() {ivec2 fragCoord=ivec2(gl_FragCoord.xy);vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);vec4 backColor=texelFetch(uBackColor,fragCoord,0);float alphaMultiplier=1.0-frontColor.a;glFragColor=vec4(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},52478:function(e,t,i){i.r(t),i.d(t,{outlinePixelShader:function(){return a}});var r=i(29427);i(56119),i(41871),i(81269),i(28951);let s="outlinePixelShader",n=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},80962:function(e,t,i){i.r(t),i.d(t,{outlineVertexShader:function(){return a}});var r=i(29427);i(74910),i(96944),i(50731),i(43626),i(64676),i(48714),i(41871),i(76086),i(74436),i(85814),i(27373),i(59343),i(12637),i(74450);let s="outlineVertexShader",n=`attribute vec3 position;attribute vec3 normal;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(offsetPosition,1.0);gl_Position=viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},43886:function(e,t,i){i.r(t),i.d(t,{particlesPixelShader:function(){return a}});var r=i(29427);i(56119),i(76909),i(41871),i(7565),i(25902),i(88004),i(81269),i(28951),i(37387);let s="particlesPixelShader",n=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec2 vUV;varying vec4 vColor;uniform vec4 textureMask;uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;uniform sampler2D rampSampler;
#endif
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));baseColor.rgb*=rampColor.rgb;float finalAlpha=baseColor.a;baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#include<logDepthFragment>
#include<fogFragment>(color,baseColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},70670:function(e,t,i){i.r(t),i.d(t,{particlesVertexShader:function(){return a}});var r=i(29427);i(64676),i(99115),i(41871),i(12637),i(97059),i(74450);let s="particlesVertexShader",n=`attribute vec3 position;attribute vec4 color;attribute float angle;attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
#ifdef BILLBOARDSTRETCHED_LOCAL
vec3 row1=direction;
#else
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
#endif
mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;return position+alignedCorner;}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=position-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=position-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner);vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(direction);vPositionW=rotate(yaxis,rotatedCorner);gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);float columnOffset=cellIndex-rowOffset/particlesInfos.z;vec2 uvScale=particlesInfos.xy;vec2 uvOffset=vec2(offset.x ,1.0-offset.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},97534:function(e,t,i){i.r(t),i.d(t,{passPixelShader:function(){return a}});var r=i(29427);let s="passPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=texture2D(textureSampler,vUV);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},89022:function(e,t,i){i.r(t),i.d(t,{passCubePixelShader:function(){return a}});var r=i(29427);let s="passCubePixelShader",n=`varying vec2 vUV;uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},80024:function(e,t,i){i.r(t),i.d(t,{pbrPixelShader:function(){return B}});var r=i(29427);i(15346),i(49255),i(5304);let s=`uniform vec4 vEyePosition;uniform vec3 vReflectionColor;uniform vec4 vAlbedoColor;uniform vec4 vLightingIntensity;uniform vec4 vReflectivityColor;uniform vec4 vMetallicReflectanceFactors;uniform vec3 vEmissiveColor;uniform float visibility;uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform vec2 vClearCoatTangentSpaceParams;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#ifdef SS_DISPERSION
uniform float dispersion;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;uniform vec3 vDiffusionDistance;uniform vec4 vTintColor;uniform vec3 vSubSurfaceIntensity;uniform vec4 vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#include<decalFragmentDeclaration>
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;r.v.IncludesShadersStore.pbrFragmentDeclaration=s,i(14982),i(95571);let n=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;r.v.IncludesShadersStore.pbrFragmentExtraDeclaration=n,i(72069),i(6937),i(89008);let a=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;r.v.IncludesShadersStore.samplerFragmentAlternateDeclaration=a;let o=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_SAMPLERNAME_,decal)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_SAMPLERNAME_,translucencyColor)
#endif
`;r.v.IncludesShadersStore.pbrFragmentSamplersDeclaration=o,i(76909),i(56119),i(41871),i(88004),i(7565),i(59628),i(52540);let l=`#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{return square(roughness)+MINIMUMVARIANCE;}
float fresnelGrazingReflectance(float reflectance0) {float reflectance90=saturate(reflectance0*25.0);return reflectance90;}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);vec3 nDfdy=dFdy(normalVector.xyz);float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);float geometricAlphaGFactor=sqrt(slopeSquare);geometricAlphaGFactor*=0.75;return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_LEGACY
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 anisotropicFrameDirection;if (anisotropy>=0.0) {anisotropicFrameDirection=B;} else {anisotropicFrameDirection=T;}
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));return anisotropicNormal;}
#else
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {float alphaT=max(mix(alphaG,1.0,anisotropy*anisotropy),MINIMUMVARIANCE);float alphaB=max(alphaG,MINIMUMVARIANCE);return vec2(alphaT,alphaB);}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy,float roughness) {vec3 bentNormal=cross(B,V);bentNormal=normalize(cross(bentNormal,B));float a=square(square(1.0-anisotropy*(1.0-roughness)));bentNormal=normalize(mix(bentNormal,N,a));return bentNormal;}
#endif
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {return exp(-alpha*distance);}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {return -log(color)/distance;}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);return clearCoatAbsorption;}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;float reflectivityLuminance=getLuminance(reflectivityColor);float reflectivityLuma=sqrt(reflectivityLuminance);microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;return microSurface;}
#endif
`;r.v.IncludesShadersStore.pbrHelperFunctions=l,i(25902),i(86507),i(2466);let c=`struct preLightingInfo
{vec3 lightOffset;float lightDistanceSquared;float lightDistance;float attenuation;vec3 L;vec3 H;float NdotV;float NdotLUnclamped;float NdotL;float VdotH;float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N,vec3 posW) {preLightingInfo result;result.lightOffset=lightData.xyz-posW;result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);result.lightDistance=sqrt(result.lightDistanceSquared);result.L=normalize(result.lightOffset);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.lightDistance=length(-lightData.xyz);result.L=normalize(-lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));result.NdotLUnclamped=dot(N,result.L);result.NdotL=saturateEps(result.NdotLUnclamped);return result;}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {preLightingInfo result;result.NdotL=dot(N,lightData.xyz)*0.5+0.5;result.NdotL=saturateEps(result.NdotL);result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);result.H=normalize(V+result.L);result.VdotH=saturate(dot(V,result.H));
#endif
return result;}`;r.v.IncludesShadersStore.pbrDirectLightingSetupFunctions=c;let u=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{return max(0.,1.0-length(lightOffset)/range);}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{return 1.0/maxEps(lightDistanceSquared);}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);float factor=lightDistanceSquared*inverseSquaredRange;float attenuation=saturate(1.0-factor*factor);attenuation*=attenuation;lightDistanceFalloff*=attenuation;return lightDistanceFalloff;}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{float falloff=0.0;float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));if (cosAngle>=cosHalfAngle)
{falloff=max(0.,pow(cosAngle,exponent));}
return falloff;}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));return falloff;}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{float cd=dot(-lightDirection,directionToLightCenterW);float falloff=saturate(cd*lightAngleScale+lightAngleOffset);falloff*=falloff;return falloff;}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;r.v.IncludesShadersStore.pbrDirectLightingFalloffFunctions=u,i(35825),i(51940);let h=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;float totalRoughness=saturate(lightRoughness+roughness);return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {return mix(groundColor,lightColor,info.NdotL);}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*info.attenuation*info.NdotL*lightColor;}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix,vec3 posW){vec4 strq=textureProjectionMatrix*vec4(posW,1.0);strq/=strq.w;vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;return toLinearSpace(textureColor);}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {float NdotL=absEps(info.NdotLUnclamped);float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);float trAdapt=step(0.,info.NdotLUnclamped);vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float TdotH=dot(T,info.H);float BdotH=dot(B,info.H);float TdotV=dot(T,V);float BdotV=dot(B,V);float TdotL=dot(T,info.L);float BdotL=dot(B,info.L);float alphaG=convertRoughnessToAverageSlope(info.roughness);vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);alphaTB=max(alphaTB,square(geometricRoughnessFactor));vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);vec3 specTerm=fresnel*distribution*smithVisibility;return specTerm*info.attenuation*info.NdotL*lightColor;}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {float NccdotL=saturateEps(dot(Ncc,info.L));float NccdotH=saturateEps(dot(Ncc,info.H));float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnel*=clearCoatIntensity;float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);float kelemenVisibility=visibility_Kelemen(info.VdotH);float clearCoatTerm=fresnel*distribution*kelemenVisibility;return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);float NdotLRefract=saturateEps(dot(Ncc,LRefract));vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);return absorption;}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {float NdotH=saturateEps(dot(N,info.H));float roughness=max(info.roughness,geometricRoughnessFactor);float alphaG=convertRoughnessToAverageSlope(roughness);float fresnel=1.;float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);/* #endif */
float sheenTerm=fresnel*distribution*visibility;return sheenTerm*info.attenuation*info.NdotL*lightColor;}
#endif
`;r.v.IncludesShadersStore.pbrDirectLightingFunctions=h;let d=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;float lod=log2(microsurfaceAverageSlopeTexels);return lod;}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {float lod=log2(cubeMapDimensionPixels)*roughness;return lod;}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {float temp=NdotVUnclamped+ambientOcclusion;return saturate(square(temp)-1.0+ambientOcclusion);}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {vec3 reflection=reflect(view,normal);float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));return square(temp);}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {float microsurfaceAverageSlope=alphaG;microsurfaceAverageSlope*=sqrt(abs(NdotV));return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);}
#endif
`;r.v.IncludesShadersStore.pbrIBLFunctions=d,i(32465),i(91023),i(43237),i(10493);let f=`struct albedoOpacityOutParams
{vec3 surfaceAlbedo;float alpha;};
#define pbr_inline
albedoOpacityOutParams albedoOpacityBlock(
in vec4 vAlbedoColor
#ifdef ALBEDO
,in vec4 albedoTexture
,in vec2 albedoInfos
#endif
#ifdef OPACITY
,in vec4 opacityMap
,in vec2 vOpacityInfos
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
#ifdef DECAL
,in vec4 decalColor
,in vec4 vDecalInfos
#endif 
)
{albedoOpacityOutParams outParams;vec3 surfaceAlbedo=vAlbedoColor.rgb;float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#ifndef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#ifdef DECAL_AFTER_DETAIL
#include<decalFragment>
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST 
#if DEBUGMODE != 88
if (alpha<ALPHATESTVALUE)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;outParams.alpha=alpha;return outParams;}
`;r.v.IncludesShadersStore.pbrBlockAlbedoOpacity=f;let p=`struct reflectivityOutParams
{float microSurface;float roughness;vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
#ifdef METALLICWORKFLOW
vec2 metallicRoughness;
#ifdef REFLECTIVITY
vec4 surfaceMetallicColorMap;
#endif
#ifndef FROSTBITE_REFLECTANCE
vec3 metallicF0;
#endif
#else
#ifdef REFLECTIVITY
vec4 surfaceReflectivityColorMap;
#endif
#endif
#endif
};
#define pbr_inline
reflectivityOutParams reflectivityBlock(
in vec4 vReflectivityColor
#ifdef METALLICWORKFLOW
,in vec3 surfaceAlbedo
,in vec4 metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,in vec3 reflectivityInfos
,in vec4 surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,in vec3 ambientOcclusionColorIn
#endif
#ifdef MICROSURFACEMAP
,in vec4 microSurfaceTexel
#endif
#ifdef DETAIL
,in vec4 detailColor
,in vec4 vDetailInfos
#endif
)
{reflectivityOutParams outParams;float microSurface=vReflectivityColor.a;vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);float roughness=1.-microSurface;outParams.microSurface=microSurface;outParams.roughness=roughness;outParams.surfaceReflectivityColor=surfaceReflectivityColor;return outParams;}
`;r.v.IncludesShadersStore.pbrBlockReflectivity=p;let m=`struct ambientOcclusionOutParams
{vec3 ambientOcclusionColor;
#if DEBUGMODE>0 && defined(AMBIENT)
vec3 ambientOcclusionColorMap;
#endif
};ambientOcclusionOutParams ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos
#endif
)
{ambientOcclusionOutParams outParams;vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;return outParams;}
`;r.v.IncludesShadersStore.pbrBlockAmbientOcclusion=m;let _=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{float alpha;};
#define pbr_inline
alphaFresnelOutParams alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface
)
{alphaFresnelOutParams outParams;float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
return outParams;}
#endif
#endif
`;r.v.IncludesShadersStore.pbrBlockAlphaFresnel=_;let g=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{float anisotropy;vec3 anisotropicTangent;vec3 anisotropicBitangent;vec3 anisotropicNormal;
#if DEBUGMODE>0 && defined(ANISOTROPIC_TEXTURE)
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
anisotropicOutParams anisotropicBlock(
in vec3 vAnisotropy,
in float roughness,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW
)
{anisotropicOutParams outParams;float anisotropy=vAnisotropy.b;vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
anisotropyMapData.rg=anisotropyMapData.rg*2.0-1.0;
#ifdef ANISOTROPIC_LEGACY
anisotropyDirection.rg*=anisotropyMapData.rg;
#else
anisotropyDirection.xy=mat2(anisotropyDirection.x,anisotropyDirection.y,-anisotropyDirection.y,anisotropyDirection.x)*normalize(anisotropyMapData.rg);
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));outParams.anisotropy=anisotropy;outParams.anisotropicTangent=anisotropicTangent;outParams.anisotropicBitangent=anisotropicBitangent;outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy,roughness);return outParams;}
#endif
`;r.v.IncludesShadersStore.pbrBlockAnisotropic=g;let v=`#ifdef REFLECTION
struct reflectionOutParams
{vec4 environmentRadiance;vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);if (lodReflectionNormalizedDoubled<1.0){environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);} else {environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;environmentRadiance.rgb*=vReflectionColor.rgb;}
#define pbr_inline
#define inline
reflectionOutParams reflectionBlock(
in vec3 vPositionW
,in vec3 normalW
,in float alphaG
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,in float NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,in float roughness
#endif
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,in vec3 vEnvironmentIrradiance
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in mat4 reflectionMatrix
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
)
{reflectionOutParams outParams;vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;outParams.environmentRadiance=environmentRadiance;outParams.environmentIrradiance=environmentIrradiance;outParams.reflectionCoords=reflectionCoords;return outParams;}
#endif
`;r.v.IncludesShadersStore.pbrBlockReflection=v;let S=`#ifdef SHEEN
struct sheenOutParams
{float sheenIntensity;vec3 sheenColor;float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
#ifdef SHEEN_TEXTURE
vec4 sheenMapData;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 sheenEnvironmentReflectance;
#endif
#endif
};
#define pbr_inline
#define inline
sheenOutParams sheenBlock(
in vec4 vSheenColor
#ifdef SHEEN_ROUGHNESS
,in float vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 sheenMapRoughnessData
#endif
#endif
,in float roughness
#ifdef SHEEN_TEXTURE
,in vec4 sheenMapData
,in float sheenMapLevel
#endif
,in float reflectance
#ifdef SHEEN_LINKWITHALBEDO
,in vec3 baseColor
,in vec3 surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,in float NdotV
,in vec3 environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,in vec2 AARoughnessFactors
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
,in vec3 reflectionCoords
#else
,in sampler2D reflectionSampler
,in vec2 reflectionCoords
#endif
,in float NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,in float seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,in float eho
#endif
#endif
)
{sheenOutParams outParams;float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);float sheenRoughness=sheenIntensity;outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;outParams.sheenColor=sheenColor;outParams.sheenRoughness=sheenRoughness;return outParams;}
#endif
`;r.v.IncludesShadersStore.pbrBlockSheen=S;let x=`struct clearcoatOutParams
{vec3 specularEnvironmentR0;float conservationFactor;vec3 clearCoatNormalW;vec2 clearCoatAARoughnessFactors;float clearCoatIntensity;float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;float clearCoatNdotVRefract;vec3 clearCoatColor;float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
#ifdef CLEARCOAT_BUMP
mat3 TBNClearCoat;
#endif
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData;
#endif
#ifdef REFLECTION
vec4 environmentClearCoatRadiance;vec3 clearCoatEnvironmentReflectance;
#endif
float clearCoatNdotV;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
clearcoatOutParams clearcoatBlock(
in vec3 vPositionW
,in vec3 geometricNormalW
,in vec3 viewDirectionW
,in vec2 vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,in vec4 clearCoatMapRoughnessData
#endif
,in vec3 specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,in vec4 vClearCoatTintParams
,in float clearCoatColorAtDistance
,in vec4 vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,in vec4 clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,in vec2 vClearCoatBumpInfos
,in vec4 clearCoatBumpMapData
,in vec2 vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,in mat3 vTBN
#else
,in vec2 vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,in mat4 normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,in vec3 faceNormal
#endif
#ifdef REFLECTION
,in vec3 vReflectionMicrosurfaceInfos
,in vec2 vReflectionInfos
,in vec3 vReflectionColor
,in vec4 vLightingIntensity
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSampler
#else
,in sampler2D reflectionSampler
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
,in samplerCube reflectionSamplerLow
,in samplerCube reflectionSamplerHigh
#else
,in sampler2D reflectionSamplerLow
,in sampler2D reflectionSamplerHigh
#endif
#endif
#ifdef REALTIME_FILTERING
,in vec2 vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,in float frontFacingMultiplier
#endif
)
{clearcoatOutParams outParams;float clearCoatIntensity=vClearCoatParams.x;float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
outParams.clearCoatIntensity=clearCoatIntensity;outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);fresnelIBLClearCoat*=clearCoatIntensity;outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
return outParams;}
#endif
`;r.v.IncludesShadersStore.pbrBlockClearcoat=x;let E=`struct iridescenceOutParams
{float iridescenceIntensity;float iridescenceIOR;float iridescenceThickness;vec3 specularEnvironmentR0;};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
iridescenceOutParams iridescenceBlock(
in vec4 vIridescenceParams
,in float viewAngle
,in vec3 specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,in vec2 iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,in vec2 iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,in float NdotVUnclamped
#ifdef CLEARCOAT_TEXTURE
,in vec2 clearCoatMapData
#endif
#endif
)
{iridescenceOutParams outParams;float iridescenceIntensity=vIridescenceParams.x;float iridescenceIOR=vIridescenceParams.y;float iridescenceThicknessMin=vIridescenceParams.z;float iridescenceThicknessMax=vIridescenceParams.w;float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);outParams.iridescenceIntensity=iridescenceIntensity;outParams.iridescenceThickness=iridescenceThickness;outParams.iridescenceIOR=iridescenceIOR;return outParams;}
#endif
`;r.v.IncludesShadersStore.pbrBlockIridescence=E;let C=`struct subSurfaceOutParams
{vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction;vec3 refractionTransmittance;
#endif
#endif
};
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#define pbr_inline
#define inline
vec4 sampleEnvironmentRefraction(
in float ior
,in float thickness
,in float refractionLOD
,in vec3 normalW
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
) {vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,ior);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,ior);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;vec3 refractionCoords=refractionVector;refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#if defined(REALTIME_FILTERING) && defined(SS_REFRACTIONMAP_3D)
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);if (lodRefractionNormalizedDoubled<1.0){environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);} else {environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
return environmentRefraction;}
#endif
#define pbr_inline
#define inline
subSurfaceOutParams subSurfaceBlock(
in vec3 vSubSurfaceIntensity
,in vec2 vThicknessParam
,in vec4 vTintColor
,in vec3 normalW
,in vec3 specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,in vec4 thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,in vec4 refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,in vec4 translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,in mat4 reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,in vec3 irradianceVector_
#endif
#if defined(REALTIME_FILTERING)
,in samplerCube reflectionSampler
,in vec2 vReflectionFilteringInfo
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
,in samplerCube irradianceSampler
#else
,in sampler2D irradianceSampler
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,in vec3 surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,in vec3 vPositionW
,in vec3 viewDirectionW
,in mat4 view
,in vec4 vRefractionInfos
,in mat4 refractionMatrix
,in vec4 vRefractionMicrosurfaceInfos
,in vec4 vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,in float alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,in float NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,in float roughness
#endif
,in float alphaG
#ifdef SS_REFRACTIONMAP_3D
,in samplerCube refractionSampler
#ifndef LODBASEDMICROSFURACE
,in samplerCube refractionSamplerLow
,in samplerCube refractionSamplerHigh
#endif
#else
,in sampler2D refractionSampler
#ifndef LODBASEDMICROSFURACE
,in sampler2D refractionSamplerLow
,in sampler2D refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,in anisotropicOutParams anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,in vec2 vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,in vec3 refractionPosition
,in vec3 refractionSize
#endif
#ifdef SS_DISPERSION
,in float dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,in vec3 vDiffusionDistance
,in vec4 vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,in vec4 translucencyColorMap
#endif
#endif
)
{subSurfaceOutParams outParams;outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_THICKNESS)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=thicknessMap.a;
#else
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#if defined(SS_REFRACTION) && defined(SS_REFRACTIONINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCYINTENSITY_TEXTURE)
#ifdef SS_USE_GLTF_TEXTURES
translucencyIntensity*=translucencyIntensityMap.a;
#else
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);vec4 translucencyColor=vTranslucencyColor;
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
translucencyColor*=translucencyColorMap;
#endif
vec3 transmittance=transmittanceBRDF_Burley(translucencyColor.rgb,vDiffusionDistance,thickness);transmittance*=translucencyIntensity;outParams.transmittance=transmittance;outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
float refraction_ior=vRefractionInfos.y;
#ifdef SS_DISPERSION
float realIOR=1.0/refraction_ior;float iorDispersionSpread=0.04*dispersion*(realIOR-1.0);vec3 iors=vec3(1.0/(realIOR-iorDispersionSpread),refraction_ior,1.0/(realIOR+iorDispersionSpread));for (int i=0; i<3; i++) {refraction_ior=iors[i];
#endif
vec4 envSample=sampleEnvironmentRefraction(refraction_ior,thickness,refractionLOD,normalW,vPositionW,viewDirectionW,view,vRefractionInfos,refractionMatrix,vRefractionMicrosurfaceInfos,alphaG
#ifdef SS_REFRACTIONMAP_3D
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#else
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,refractionPosition
,refractionSize
#endif
);
#ifdef SS_DISPERSION
environmentRefraction[i]=envSample[i];}
#else
environmentRefraction=envSample;
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
return outParams;}
#endif
`;r.v.IncludesShadersStore.pbrBlockSubSurface=C,i(81269);let T=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;r.v.IncludesShadersStore.pbrBlockNormalGeometric=T,i(5413);let b=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;r.v.IncludesShadersStore.pbrBlockNormalFinal=b,i(43351);let y=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;r.v.IncludesShadersStore.pbrBlockLightmapInit=y;let I=`float NdotVUnclamped=dot(normalW,viewDirectionW);float NdotV=absEps(NdotVUnclamped);float alphaG=convertRoughnessToAverageSlope(roughness);vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;r.v.IncludesShadersStore.pbrBlockGeometryInfo=I;let P=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;r.v.IncludesShadersStore.pbrBlockReflectance0=P;let R=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;r.v.IncludesShadersStore.pbrBlockReflectance=R;let A=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;lightingInfo info;float shadow=1.; 
float aggShadow=0.;float numLights=0.;
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;r.v.IncludesShadersStore.pbrBlockDirectLighting=A,i(97853);let M=`aggShadow=aggShadow/numLights;
#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;finalIrradiance*=vLightingIntensity.z;finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;finalSpecular=max(finalSpecular,0.0);vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;finalSheen=max(finalSheen,0.0);vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;finalClearCoat=max(finalClearCoat,0.0);vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;r.v.IncludesShadersStore.pbrBlockFinalLitComponents=M;let N=`vec3 finalDiffuse=diffuseBase;finalDiffuse*=surfaceAlbedo.rgb;finalDiffuse=max(finalDiffuse,0.0);finalDiffuse*=vLightingIntensity.x;vec3 finalAmbient=vAmbientColor;finalAmbient*=surfaceAlbedo.rgb;vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;r.v.IncludesShadersStore.pbrBlockFinalUnlitComponents=N;let O=`vec4 finalColor=vec4(
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalAmbient +
finalDiffuse,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
finalColor.rgb+=finalEmissive;
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;r.v.IncludesShadersStore.pbrBlockFinalColorComposition=O,i(28951),i(37387);let D=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;r.v.IncludesShadersStore.pbrBlockImageProcessing=D,i(35876);let F=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#ifndef GAMMAALBEDO
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#ifndef GAMMAEMISSIVE
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#ifndef GAMMALIGHTMAP
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==32 && defined(BUMP)
gl_FragColor.rgb=texture2D(bumpSampler,vBumpUV).rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#ifndef GAMMAREFLECTION
#define DEBUGMODE_GAMMA
#endif
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==72
gl_FragColor.rgb=vec3(microSurface);
#elif DEBUGMODE==73
gl_FragColor.rgb=vAlbedoColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==74 && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=vReflectivityColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==75
gl_FragColor.rgb=vEmissiveColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#elif DEBUGMODE==88 && defined(ALBEDO)
gl_FragColor.rgb=vec3(albedoTexture.a);
#elif DEBUGMODE==89
gl_FragColor.rgb=aoOut.ambientOcclusionColor.rgb;
#else
float stripeWidth=30.;float stripePos=floor(gl_FragCoord.x/stripeWidth);float whichColor=mod(stripePos,2.);vec3 color1=vec3(.6,.2,.2);vec3 color2=vec3(.3,.1,.1);gl_FragColor.rgb=mix(color1,color2,whichColor);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
#ifdef DEBUGMODE_FORCERETURN
return;
#endif
}
#endif
`;r.v.IncludesShadersStore.pbrDebug=F;let L="pbrPixelShader",w=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
#ifdef DECAL
vec4 decalColor=texture2D(decalSampler,vDecalUV+uvOffset);
#endif
albedoOpacityOut=albedoOpacityBlock(
vAlbedoColor
#ifdef ALBEDO
,albedoTexture
,vAlbedoInfos
#endif
#ifdef OPACITY
,opacityMap
,vOpacityInfos
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
#ifdef DECAL
,decalColor
,vDecalInfos
#endif
);vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
aoOut=ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos
#endif 
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityOut=reflectivityBlock(
vReflectivityColor
#ifdef METALLICWORKFLOW
,surfaceAlbedo
,metallicReflectanceFactors
#endif
#ifdef REFLECTIVITY
,vReflectivityInfos
,surfaceMetallicOrReflectivityColorMap
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
,aoOut.ambientOcclusionColor
#endif
#ifdef MICROSURFACEMAP
,microSurfaceTexel
#endif
#ifdef DETAIL
,detailColor
,vDetailInfos
#endif
);float microSurface=reflectivityOut.microSurface;float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;alphaFresnelOut=alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface
);alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicOut=anisotropicBlock(
vAnisotropy,
roughness,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW 
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionOut=reflectionBlock(
vPositionW
,normalW
,alphaG
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
,NdotVUnclamped
#endif
#ifdef LINEARSPECULARREFLECTION
,roughness
#endif
,reflectionSampler
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
,vEnvironmentIrradiance
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionMatrix
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenOut=sheenBlock(
vSheenColor
#ifdef SHEEN_ROUGHNESS
,vSheenRoughness
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
,sheenMapRoughnessData
#endif
#endif
,roughness
#ifdef SHEEN_TEXTURE
,sheenMapData
,vSheenInfos.y
#endif
,reflectance
#ifdef SHEEN_LINKWITHALBEDO
,baseColor
,surfaceAlbedo
#endif
#ifdef ENVIRONMENTBRDF
,NdotV
,environmentBrdf
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
,AARoughnessFactors
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
,reflectionOut.reflectionCoords
,NdotVUnclamped
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
,seo
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
,eho
#endif
#endif
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceOut=iridescenceBlock(
vIridescenceParams
,NdotV
,specularEnvironmentR0
#ifdef IRIDESCENCE_TEXTURE
,iridescenceMapData
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
,iridescenceThicknessMapData
#endif
#ifdef CLEARCOAT
,NdotVUnclamped
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#endif
);float iridescenceIntensity=iridescenceOut.iridescenceIntensity;specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatOut=clearcoatBlock(
vPositionW
,geometricNormalW
,viewDirectionW
,vClearCoatParams
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
,clearCoatMapRoughnessData
#endif
,specularEnvironmentR0
#ifdef CLEARCOAT_TEXTURE
,clearCoatMapData
#endif
#ifdef CLEARCOAT_TINT
,vClearCoatTintParams
,clearCoatColorAtDistance
,vClearCoatRefractionParams
#ifdef CLEARCOAT_TINT_TEXTURE
,clearCoatTintMapData
#endif
#endif
#ifdef CLEARCOAT_BUMP
,vClearCoatBumpInfos
,clearCoatBumpMapData
,vClearCoatBumpUV
#if defined(TANGENT) && defined(NORMAL)
,vTBN
#else
,vClearCoatTangentSpaceParams
#endif
#ifdef OBJECTSPACE_NORMALMAP
,normalMatrix
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
,faceNormal
#endif
#ifdef REFLECTION
,vReflectionMicrosurfaceInfos
,vReflectionInfos
,vReflectionColor
,vLightingIntensity
,reflectionSampler
#ifndef LODBASEDMICROSFURACE
,reflectionSamplerLow
,reflectionSamplerHigh
#endif
#ifdef REALTIME_FILTERING
,vReflectionFilteringInfo
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
,(gl_FrontFacing ? 1. : -1.)
#endif
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
vec4 translucencyColorMap=texture2D(translucencyColorSampler,vTranslucencyColorUV+uvOffset);
#endif
subSurfaceOut=subSurfaceBlock(
vSubSurfaceIntensity
,vThicknessParam
,vTintColor
,normalW
,specularEnvironmentReflectance
#ifdef SS_THICKNESSANDMASK_TEXTURE
,thicknessMap
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
,refractionIntensityMap
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
,translucencyIntensityMap
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
,reflectionMatrix
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
,reflectionOut.irradianceVector
#endif
#if defined(REALTIME_FILTERING)
,reflectionSampler
,vReflectionFilteringInfo
#endif
#endif
#ifdef USEIRRADIANCEMAP
,irradianceSampler
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
,surfaceAlbedo
#endif
#ifdef SS_REFRACTION
,vPositionW
,viewDirectionW
,view
,vRefractionInfos
,refractionMatrix
,vRefractionMicrosurfaceInfos
,vLightingIntensity
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
,alpha
#endif
#ifdef SS_LODINREFRACTIONALPHA
,NdotVUnclamped
#endif
#ifdef SS_LINEARSPECULARREFRACTION
,roughness
#endif
,alphaG
,refractionSampler
#ifndef LODBASEDMICROSFURACE
,refractionSamplerLow
,refractionSamplerHigh
#endif
#ifdef ANISOTROPIC
,anisotropicOut
#endif
#ifdef REALTIME_FILTERING
,vRefractionFilteringInfo
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
,vRefractionPosition
,vRefractionSize
#endif
#ifdef SS_DISPERSION
,dispersion
#endif
#endif
#ifdef SS_TRANSLUCENCY
,vDiffusionDistance
,vTranslucencyColor
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
,translucencyColorMap
#endif
#endif
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>ALPHATESTVALUE ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_LOCAL_POSITION
gl_FragData[PREPASS_LOCAL_POSITION_INDEX] =
vec4(vPosition,writeGeometryInfo);
#endif
#if defined(PREPASS_VELOCITY)
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;vec2 velocity=abs(a-b);velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0)) *
sign(a-b)*0.5 +
0.5;gl_FragData[PREPASS_VELOCITY_INDEX] =
vec4(velocity,0.0,writeGeometryInfo);
#elif defined(PREPASS_VELOCITY_LINEAR)
vec2 velocity=vec2(0.5)*((vPreviousPosition.xy/vPreviousPosition.w) -
(vCurrentPosition.xy/vCurrentPosition.w));gl_FragData[PREPASS_VELOCITY_LINEAR_INDEX] =
vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,
finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX] =
vec4(clamp(irradiance,vec3(0.),vec3(1.)),
writeGeometryInfo*scatteringDiffusionProfile /
255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX] =
vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_SCREENSPACE_DEPTH
gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] =
vec4(gl_FragCoord.z,0.0,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_NORMAL
#ifdef PREPASS_NORMAL_WORLDSPACE
gl_FragData[PREPASS_NORMAL_INDEX] =
vec4(normalW,writeGeometryInfo); 
#else
gl_FragData[PREPASS_NORMAL_INDEX] =
vec4(normalize((view*vec4(normalW,0.0)).rgb),
writeGeometryInfo); 
#endif
#endif
#ifdef PREPASS_WORLD_NORMAL
gl_FragData[PREPASS_WORLD_NORMAL_INDEX]=vec4(normalW*0.5+0.5,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularEnvironmentR0,microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);} else {backColor+=finalColor;}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.v.ShadersStore[L]=w;let B={name:L,shader:w}},98296:function(e,t,i){i.r(t),i.d(t,{pbrVertexShader:function(){return o}});var r=i(29427);i(31360);let s=`uniform mat4 view;uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;uniform mat4 translucencyIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
uniform vec2 vTranslucencyColorInfos;uniform mat4 translucencyColorMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;uniform vec3 vSphericalL1_1;uniform vec3 vSphericalL10;uniform vec3 vSphericalL11;uniform vec3 vSphericalL2_2;uniform vec3 vSphericalL2_1;uniform vec3 vSphericalL20;uniform vec3 vSphericalL21;uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;uniform vec3 vSphericalY;uniform vec3 vSphericalZ;uniform vec3 vSphericalXX_ZZ;uniform vec3 vSphericalYY_ZZ;uniform vec3 vSphericalZZ;uniform vec3 vSphericalXY;uniform vec3 vSphericalYZ;uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;uniform mat4 detailMatrix;
#endif
#include<decalVertexDeclaration>
#define ADDITIONAL_VERTEX_DECLARATION
`;r.v.IncludesShadersStore.pbrVertexDeclaration=s,i(14982),i(89624),i(95571),i(7565),i(74910),i(96944),i(48714),i(50551),i(47017),i(2466),i(40733),i(64676),i(99115),i(87672),i(97533),i(50731),i(43626),i(41871),i(76086),i(74436),i(85814),i(27373),i(59343),i(24029),i(43234),i(79660),i(74953),i(12637),i(97059),i(77272),i(74847),i(74450);let n="pbrVertexShader",a=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#include<samplerVertexDeclaration>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && \
(defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED) || \
defined(PREPASS_VELOCITY_LINEAR))
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {gl_Position=viewProjection*worldPos;} else {gl_Position=viewProjectionR*worldPos;}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DECAL,_VARYINGNAME_,Decal,_MATRIXNAME_,decal,_INFONAME_,DecalInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheenRoughness,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYCOLOR_TEXTURE,_VARYINGNAME_,TranslucencyColor,_MATRIXNAME_,translucencyColor,_INFONAME_,TranslucencyColorInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[n]=a;let o={name:n,shader:a}},75313:function(e,t,i){i.r(t),i.d(t,{pickingPixelShader:function(){return a}});var r=i(29427);let s="pickingPixelShader",n=`#if defined(INSTANCES)
varying vec4 vMeshID;
#else
uniform vec4 meshID;
#endif
void main(void) {
#if defined(INSTANCES)
gl_FragColor=vMeshID;
#else
gl_FragColor=meshID;
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},60588:function(e,t,i){i.r(t),i.d(t,{pickingVertexShader:function(){return a}});var r=i(29427);i(74910),i(96944),i(50731),i(43626),i(48714),i(76086),i(74436),i(85814),i(27373),i(59343);let s="pickingVertexShader",n=`attribute vec3 position;
#if defined(INSTANCES)
attribute vec4 instanceMeshID;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;
#if defined(INSTANCES)
varying vec4 vMeshID;
#endif
void main(void) {
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);gl_Position=viewProjection*worldPos;
#if defined(INSTANCES)
vMeshID=instanceMeshID;
#endif
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},29653:function(e,t,i){i.r(t),i.d(t,{proceduralVertexShader:function(){return a}});var r=i(29427);let s="proceduralVertexShader",n=`attribute vec2 position;varying vec2 vPosition;varying vec2 vUV;const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;vUV=position*madd+madd;gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},85974:function(e,t,i){i.r(t),i.d(t,{rgbdDecodePixelShader:function(){return a}});var r=i(29427);i(7565);let s="rgbdDecodePixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},49587:function(e,t,i){i.r(t),i.d(t,{rgbdEncodePixelShader:function(){return a}});var r=i(29427);i(7565);let s="rgbdEncodePixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},61354:function(e,t,i){i.r(t),i.d(t,{rsmFullGlobalIlluminationPixelShader:function(){return a}});var r=i(29427);let s="rsmFullGlobalIlluminationPixelShader",n=`/**
* The implementation is a direct application of the formula found in http:
*/
precision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;
#ifdef TRANSFORM_NORMAL
uniform mat4 invView;
#endif
vec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;int width=int(rsmInfo.x);int height=int(rsmInfo.y);for (int j=0; j<height; j++) {for (int i=0; i<width; i++) {ivec2 uv=ivec2(i,j);vec3 vplPositionW=texelFetch(rsmPositionW,uv,0).xyz;vec3 vplNormalW=texelFetch(rsmNormalW,uv,0).xyz*2.0-1.0;vec3 vplFlux=texelFetch(rsmFlux,uv,0).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
float dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}}
return clamp(indirectDiffuse*intensity,0.0,1.0);}
void main(void) 
{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(invView*vec4(normalW,0.)).xyz;
#endif
gl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},47036:function(e,t,i){i.r(t),i.d(t,{rsmGlobalIlluminationPixelShader:function(){return a}});var r=i(29427);let s="rsmGlobalIlluminationPixelShader",n=`/**
* The implementation is an application of the formula found in http:
* For better results,it also adds a random (noise) rotation to the RSM samples (the noise artifacts are easier to remove than the banding artifacts).
*/
precision highp float;varying vec2 vUV;uniform mat4 rsmLightMatrix;uniform vec4 rsmInfo;uniform vec4 rsmInfo2;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform sampler2D rsmPositionW;uniform sampler2D rsmNormalW;uniform sampler2D rsmFlux;uniform sampler2D rsmSamples;
#ifdef TRANSFORM_NORMAL
uniform mat4 invView;
#endif
float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}
vec4 perm(vec4 x){return mod289(((x*34.0)+1.0)*x);}
float noise(vec3 p){vec3 a=floor(p);vec3 d=p-a;d=d*d*(3.0-2.0*d);vec4 b=a.xxyy+vec4(0.0,1.0,0.0,1.0);vec4 k1=perm(b.xyxy);vec4 k2=perm(k1.xyxy+b.zzww);vec4 c=k2+a.zzzz;vec4 k3=perm(c);vec4 k4=perm(c+1.0);vec4 o1=fract(k3*(1.0/41.0));vec4 o2=fract(k4*(1.0/41.0));vec4 o3=o2*d.z+o1*(1.0-d.z);vec2 o4=o3.yw*d.x+o3.xz*(1.0-d.x);return o4.y*d.y+o4.x*(1.0-d.y);}
vec3 computeIndirect(vec3 p,vec3 n) {vec3 indirectDiffuse=vec3(0.);int numSamples=int(rsmInfo.x);float radius=rsmInfo.y;float intensity=rsmInfo.z;float edgeArtifactCorrection=rsmInfo.w;vec4 texRSM=rsmLightMatrix*vec4(p,1.);texRSM.xy/=texRSM.w;texRSM.xy=texRSM.xy*0.5+0.5;float angle=noise(p*rsmInfo2.x);float c=cos(angle);float s=sin(angle);for (int i=0; i<numSamples; i++) {vec3 rsmSample=texelFetch(rsmSamples,ivec2(i,0),0).xyz;float weightSquare=rsmSample.z;if (rsmInfo2.y==1.0) rsmSample.xy=vec2(rsmSample.x*c+rsmSample.y*s,-rsmSample.x*s+rsmSample.y*c);vec2 uv=texRSM.xy+rsmSample.xy*radius;if (uv.x<0. || uv.x>1. || uv.y<0. || uv.y>1.) continue;vec3 vplPositionW=textureLod(rsmPositionW,uv,0.).xyz;vec3 vplNormalW=textureLod(rsmNormalW,uv,0.).xyz*2.0-1.0;vec3 vplFlux=textureLod(rsmFlux,uv,0.).rgb;vplPositionW-=vplNormalW*edgeArtifactCorrection; 
float dist2=dot(vplPositionW-p,vplPositionW-p);indirectDiffuse+=vplFlux*weightSquare*max(0.,dot(n,vplPositionW-p))*max(0.,dot(vplNormalW,p-vplPositionW))/(dist2*dist2);}
return clamp(indirectDiffuse*intensity,0.0,1.0);}
void main(void) 
{vec3 positionW=texture2D(textureSampler,vUV).xyz;vec3 normalW=texture2D(normalSampler,vUV).xyz;
#ifdef DECODE_NORMAL
normalW=normalW*2.0-1.0;
#endif
#ifdef TRANSFORM_NORMAL
normalW=(invView*vec4(normalW,0.)).xyz;
#endif
gl_FragColor.rgb=computeIndirect(positionW,normalW);gl_FragColor.a=1.0;}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},29336:function(e,t,i){i.r(t),i.d(t,{screenSpaceReflection2PixelShader:function(){return a}});var r=i(29427);i(7565),i(35825),i(5275);let s="screenSpaceReflection2PixelShader",n=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#define TEXTURECUBEFUNC(s,c,lod) textureLod(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#define TEXTURECUBEFUNC(s,c,bias) textureCube(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D depthSampler;
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
uniform sampler2D backDepthSampler;uniform float backSizeFactor;
#endif
#ifdef SSR_USE_ENVIRONMENT_CUBE
uniform samplerCube envCubeSampler;
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
uniform vec3 vReflectionPosition;uniform vec3 vReflectionSize;
#endif
#endif
uniform mat4 view;uniform mat4 invView;uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform mat4 projectionPixel;uniform float nearPlaneZ;uniform float farPlaneZ;uniform float stepSize;uniform float maxSteps;uniform float strength;uniform float thickness;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;uniform float maxDistance;uniform float selfCollisionNumSkip;uniform float reflectivityThreshold;
#include<helperFunctions>
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
vec3 hash(vec3 a)
{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}
float computeAttenuationForIntersection(ivec2 hitPixel,vec2 hitUV,vec3 vsRayOrigin,vec3 vsHitPoint,vec3 reflectionVector,float maxRayDistance,float numIterations) {float attenuation=1.0;
#ifdef SSR_ATTENUATE_SCREEN_BORDERS
vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-hitUV.xy));attenuation*=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_DISTANCE
attenuation*=1.0-clamp(distance(vsRayOrigin,vsHitPoint)/maxRayDistance,0.0,1.0);
#endif
#ifdef SSR_ATTENUATE_INTERSECTION_NUMITERATIONS
attenuation*=1.0-(numIterations/maxSteps);
#endif
#ifdef SSR_ATTENUATE_BACKFACE_REFLECTION
vec3 reflectionNormal=texelFetch(normalSampler,hitPixel,0).xyz;float directionBasedAttenuation=smoothstep(-0.17,0.0,dot(reflectionNormal,-reflectionVector));attenuation*=directionBasedAttenuation;
#endif
return attenuation;}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);vec3 color=colorFull.rgb;vec4 reflectivity=TEXTUREFUNC(reflectivitySampler,vUV,0.0);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {
#ifdef SSR_USE_BLUR
gl_FragColor=vec4(0.);
#else
gl_FragColor=colorFull;
#endif
return;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpace(color);
#endif
vec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz; 
#ifdef SSR_DECODE_NORMAL
csNormal=csNormal*2.0-1.0;
#endif
#ifdef SSR_NORMAL_IS_IN_WORLDSPACE
csNormal=(view*vec4(csNormal,0.0)).xyz;
#endif
float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);
#endif
vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);
#ifdef ORTHOGRAPHIC_CAMERA
vec3 csViewDirection=vec3(0.,0.,1.);
#else
vec3 csViewDirection=normalize(csPosition);
#endif
vec3 csReflectedVector=reflect(csViewDirection,csNormal);
#ifdef SSR_USE_ENVIRONMENT_CUBE
vec3 wReflectedVector=vec3(invView*vec4(csReflectedVector,0.0));
#ifdef SSR_USE_LOCAL_REFLECTIONMAP_CUBIC
vec4 worldPos=invView*vec4(csPosition,1.0);wReflectedVector=parallaxCorrectNormal(worldPos.xyz,normalize(wReflectedVector),vReflectionSize,vReflectionPosition);
#endif
#ifdef SSR_INVERTCUBICMAP
wReflectedVector.y*=-1.0;
#endif
#ifdef SSRAYTRACE_RIGHT_HANDED_SCENE
wReflectedVector.z*=-1.0;
#endif
vec3 envColor=TEXTURECUBEFUNC(envCubeSampler,wReflectedVector,0.0).xyz;
#ifdef SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE
envColor=toLinearSpace(envColor);
#endif
#else
vec3 envColor=color;
#endif
float reflectionAttenuation=1.0;bool rayHasHit=false;vec2 startPixel;vec2 hitPixel;vec3 hitPoint;float numIterations;
#ifdef SSRAYTRACE_DEBUG
vec3 debugColor;
#endif
#ifdef SSR_ATTENUATE_FACING_CAMERA
reflectionAttenuation*=1.0-smoothstep(0.25,0.5,dot(-csViewDirection,csReflectedVector));
#endif
if (reflectionAttenuation>0.0) {
#ifdef SSR_USE_BLUR
vec3 jitt=vec3(0.);
#else
float roughness=1.0-reflectivity.a;vec3 jitt=mix(vec3(0.0),hash(csPosition)-vec3(0.5),roughness)*roughnessFactor; 
#endif
vec2 uv2=vUV*texSize;float c=(uv2.x+uv2.y)*0.25;float jitter=mod(c,1.0); 
rayHasHit=traceScreenSpaceRay1(
csPosition,
normalize(csReflectedVector+jitt),
projectionPixel,
depthSampler,
texSize,
#ifdef SSRAYTRACE_USE_BACK_DEPTHBUFFER
backDepthSampler,
backSizeFactor,
#endif
thickness,
nearPlaneZ,
farPlaneZ,
stepSize,
jitter,
maxSteps,
maxDistance,
selfCollisionNumSkip,
startPixel,
hitPixel,
hitPoint,
numIterations
#ifdef SSRAYTRACE_DEBUG
,debugColor
#endif
);}
#ifdef SSRAYTRACE_DEBUG
gl_FragColor=vec4(debugColor,1.);return;
#endif
vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 SSR=envColor;if (rayHasHit) {vec3 reflectedColor=texelFetch(textureSampler,ivec2(hitPixel),0).rgb;
#ifdef SSR_INPUT_IS_GAMMA_SPACE
reflectedColor=toLinearSpace(reflectedColor);
#endif
reflectionAttenuation*=computeAttenuationForIntersection(ivec2(hitPixel),hitPixel/texSize,csPosition,hitPoint,csReflectedVector,maxDistance,numIterations);SSR=reflectedColor*reflectionAttenuation+(1.0-reflectionAttenuation)*envColor;}
#ifndef SSR_BLEND_WITH_FRESNEL
SSR*=fresnel;
#endif
#ifdef SSR_USE_BLUR
float blur_radius=0.0;float roughness=1.0-reflectivity.a*(1.0-roughnessFactor);if (roughness>0.001) {float cone_angle=min(roughness,0.999)*3.14159265*0.5;float cone_len=distance(startPixel,hitPixel);float op_len=2.0*tan(cone_angle)*cone_len; 
float a=op_len;float h=cone_len;float a2=a*a;float fh2=4.0f*h*h;blur_radius=(a*(sqrt(a2+fh2)-a))/(4.0f*h);}
gl_FragColor=vec4(SSR,blur_radius/255.0); 
#else
#ifdef SSR_BLEND_WITH_FRESNEL
vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#else
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#endif
vec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpace(finalColor);
#endif
gl_FragColor=vec4(finalColor,colorFull.a);
#endif
#else
gl_FragColor=TEXTUREFUNC(textureSampler,vUV,0.0);
#endif
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},23397:function(e,t,i){i.r(t),i.d(t,{screenSpaceReflection2BlurPixelShader:function(){return a}});var r=i(29427);let s="screenSpaceReflection2BlurPixelShader",n=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,lod) texture2DLodEXT(s,c,lod)
#else
#define TEXTUREFUNC(s,c,bias) texture2D(s,c,bias)
#endif
uniform sampler2D textureSampler;varying vec2 vUV;uniform vec2 texelOffsetScale;const float weights[8]=float[8] (0.071303,0.131514,0.189879,0.321392,0.452906, 0.584419,0.715932,0.847445);void processSample(vec2 uv,float i,vec2 stepSize,inout vec4 accumulator,inout float denominator)
{vec2 offsetUV=stepSize*i+uv;float coefficient=weights[int(2.0-abs(i))];accumulator+=TEXTUREFUNC(textureSampler,offsetUV,0.0)*coefficient;denominator+=coefficient;}
void main()
{vec4 colorFull=TEXTUREFUNC(textureSampler,vUV,0.0);if (dot(colorFull,vec4(1.0))==0.0) {gl_FragColor=colorFull;return;}
float blurRadius=colorFull.a*255.0; 
vec2 stepSize=texelOffsetScale.xy*blurRadius;vec4 accumulator=TEXTUREFUNC(textureSampler,vUV,0.0)*0.214607;float denominator=0.214607;processSample(vUV,1.0,stepSize,accumulator,denominator);processSample(vUV,1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,1.0*2.0,stepSize,accumulator,denominator);processSample(vUV,-1.0,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*0.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.2,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.4,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.6,stepSize,accumulator,denominator);processSample(vUV,-1.0*1.8,stepSize,accumulator,denominator);processSample(vUV,-1.0*2.0,stepSize,accumulator,denominator);gl_FragColor=vec4(accumulator.rgb/denominator,colorFull.a);}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},74881:function(e,t,i){i.r(t),i.d(t,{screenSpaceReflection2BlurCombinerPixelShader:function(){return a}});var r=i(29427);i(7565),i(35825),i(5275);let s="screenSpaceReflection2BlurCombinerPixelShader",n=`uniform sampler2D textureSampler; 
uniform sampler2D mainSampler;uniform sampler2D reflectivitySampler;uniform float strength;uniform float reflectionSpecularFalloffExponent;uniform float reflectivityThreshold;varying vec2 vUV;
#include<helperFunctions>
#ifdef SSR_BLEND_WITH_FRESNEL
#include<pbrBRDFFunctions>
#include<screenSpaceRayTrace>
uniform mat4 projection;uniform mat4 invProjectionMatrix;uniform sampler2D normalSampler;uniform sampler2D depthSampler;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
uniform float nearPlaneZ;uniform float farPlaneZ;
#endif
#endif
void main()
{
#ifdef SSRAYTRACE_DEBUG
gl_FragColor=texture2D(textureSampler,vUV);
#else
vec3 SSR=texture2D(textureSampler,vUV).rgb;vec4 color=texture2D(mainSampler,vUV);vec4 reflectivity=texture2D(reflectivitySampler,vUV);
#ifndef SSR_DISABLE_REFLECTIVITY_TEST
if (max(reflectivity.r,max(reflectivity.g,reflectivity.b))<=reflectivityThreshold) {gl_FragColor=color;return;}
#endif
#ifdef SSR_INPUT_IS_GAMMA_SPACE
color=toLinearSpace(color);
#endif
#ifdef SSR_BLEND_WITH_FRESNEL
vec2 texSize=vec2(textureSize(depthSampler,0));vec3 csNormal=texelFetch(normalSampler,ivec2(vUV*texSize),0).xyz;float depth=texelFetch(depthSampler,ivec2(vUV*texSize),0).r;
#ifdef SSRAYTRACE_SCREENSPACE_DEPTH
depth=linearizeDepth(depth,nearPlaneZ,farPlaneZ);
#endif
vec3 csPosition=computeViewPosFromUVDepth(vUV,depth,projection,invProjectionMatrix);vec3 csViewDirection=normalize(csPosition);vec3 F0=reflectivity.rgb;vec3 fresnel=fresnelSchlickGGX(max(dot(csNormal,-csViewDirection),0.0),F0,vec3(1.));vec3 reflectionMultiplier=clamp(pow(fresnel*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#else
vec3 reflectionMultiplier=clamp(pow(reflectivity.rgb*strength,vec3(reflectionSpecularFalloffExponent)),0.0,1.0);
#endif
vec3 colorMultiplier=1.0-reflectionMultiplier;vec3 finalColor=(color.rgb*colorMultiplier)+(SSR*reflectionMultiplier);
#ifdef SSR_OUTPUT_IS_GAMMA_SPACE
finalColor=toGammaSpace(finalColor);
#endif
gl_FragColor=vec4(finalColor,color.a);
#endif
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},76720:function(e,t,i){i.r(t),i.d(t,{shadowMapPixelShader:function(){return l}});var r=i(29427);i(43870);let s=`float bayerDither2(vec2 _P) {return mod(2.0*_P.y+_P.x+1.0,4.0);}
float bayerDither4(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);}
float bayerDither8(vec2 _P) {vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);}
`;r.v.IncludesShadersStore.bayerDitherFunctions=s;let n=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform vec2 softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;r.v.IncludesShadersStore.shadowMapFragmentExtraDeclaration=n,i(56119),i(81269),i(69303);let a="shadowMapPixelShader",o=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEXTURE
vec4 opacityMap=texture2D(diffuseSampler,vUV);float alphaFromAlphaTexture=opacityMap.a;
#if SM_SOFTTRANSPARENTSHADOW==1
if (softTransparentShadowSM.y==1.0) {opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);alphaFromAlphaTexture=opacityMap.x+opacityMap.y+opacityMap.z;}
#endif
#ifdef ALPHATESTVALUE
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEXTURE
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM.x) discard;
#endif
#endif
#include<shadowMapFragment>
}`;r.v.ShadersStore[a]=o;let l={name:a,shader:o}},17791:function(e,t,i){i.r(t),i.d(t,{shadowMapVertexShader:function(){return d}});var r=i(29427);i(74910),i(96944),i(50731),i(43626),i(7565);let s=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;uniform mat4 projection;uniform vec4 vEyePosition;
`;r.v.IncludesShadersStore.sceneVertexDeclaration=s;let n=`uniform mat4 world;uniform float visibility;
`;r.v.IncludesShadersStore.meshVertexDeclaration=n;let a=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;r.v.IncludesShadersStore.shadowMapVertexDeclaration=a,i(16282),i(33587);let o=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;r.v.IncludesShadersStore.shadowMapUboDeclaration=o;let l=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;uniform vec2 depthValuesSM;varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;r.v.IncludesShadersStore.shadowMapVertexExtraDeclaration=l,i(64676),i(76086),i(74436),i(85814),i(27373),i(59343);let c=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);float sinNLSM=sqrt(1.0-ndlSM*ndlSM);float normalBiasSM=biasAndScaleSM.y*sinNLSM;worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;r.v.IncludesShadersStore.shadowMapVertexNormalBias=c,i(10224),i(12637);let u="shadowMapVertexShader",h=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;attribute vec4 world1;attribute vec4 world2;attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEXTURE
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEXTURE
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;r.v.ShadersStore[u]=h;let d={name:u,shader:h}},230:function(e,t,i){i.r(t),i.d(t,{sharpenPixelShader:function(){return a}});var r=i(29427);let s="sharpenPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 screenSize;uniform vec2 sharpnessAmounts;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 onePixel=vec2(1.0,1.0)/screenSize;vec4 color=texture2D(textureSampler,vUV);vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},5566:function(e,t,i){i.r(t),i.d(t,{spritesPixelShader:function(){return a}});var r=i(29427);i(88004),i(41871),i(28951),i(37387),i(20577);let s="spritesPixelShader",n=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform bool alphaTest;varying vec4 vColor;varying vec2 vUV;uniform sampler2D diffuseSampler;
#include<fogFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
#ifdef PIXEL_PERFECT
vec2 uvPixelPerfect(vec2 uv) {vec2 res=vec2(textureSize(diffuseSampler,0));uv=uv*res;vec2 seam=floor(uv+0.5);uv=seam+clamp((uv-seam)/fwidth(uv),-0.5,0.5);return uv/res;}
#endif
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#ifdef PIXEL_PERFECT
vec2 uv=uvPixelPerfect(vUV);
#else
vec2 uv=vUV;
#endif
vec4 color=texture2D(diffuseSampler,uv);float fAlphaTest=float(alphaTest);if (fAlphaTest != 0.)
{if (color.a<0.95)
discard;}
color*=vColor;
#include<logDepthFragment>
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},12199:function(e,t,i){i.r(t),i.d(t,{spritesVertexShader:function(){return a}});var r=i(29427);i(99115),i(41871),i(74450);let s="spritesVertexShader",n=`attribute vec4 position;attribute vec2 options;attribute vec2 offsets;attribute vec2 inverts;attribute vec4 cellInfo;attribute vec4 color;uniform mat4 view;uniform mat4 projection;varying vec2 vUV;varying vec4 vColor;
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; 
vec2 cornerPos;float angle=position.w;vec2 size=vec2(options.x,options.y);vec2 offset=offsets.xy;cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;viewPos+=rotatedCorner;gl_Position=projection*vec4(viewPos,1.0); 
vColor=color;vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));vec2 uvPlace=cellInfo.xy;vec2 uvSize=cellInfo.zw;vUV.x=uvPlace.x+uvSize.x*uvOffset.x;vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vFogDistance=viewPos;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},23210:function(e,t,i){i.r(t),i.d(t,{ssao2PixelShader:function(){return a}});var r=i(29427);let s="ssao2PixelShader",n=`precision highp float;uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);uniform float near;uniform float radius;uniform sampler2D depthSampler;uniform sampler2D randomSampler;uniform sampler2D normalSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float base;uniform float xViewport;uniform float yViewport;uniform mat3 depthProjection;uniform float maxZ;uniform float minZAspect;uniform vec2 texelSize;uniform mat4 projection;void main()
{vec3 random=textureLod(randomSampler,vUV*randTextureTiles,0.0).rgb;float depth=textureLod(depthSampler,vUV,0.0).r;float depthSign=sign(depth);depth=depth*depthSign;vec3 normal=textureLod(normalSampler,vUV,0.0).rgb;float occlusion=0.0;float correctedRadius=min(radius,minZAspect*depth/near);vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);vec3 origin=vViewRay*vDepthFactor;vec3 rvec=random*2.0-1.0;rvec.z=0.0;float dotProduct=dot(rvec,normal);rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);vec3 tangent=normalize(rvec-normal*dot(rvec,normal));vec3 bitangent=cross(normal,tangent);mat3 tbn=mat3(tangent,bitangent,normal);float difference;for (int i=0; i<SAMPLES; ++i) {vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];samplePosition=samplePosition*correctedRadius+origin;vec4 offset=vec4(samplePosition,1.0);offset=projection*offset;offset.xyz/=offset.w;offset.xy=offset.xy*0.5+0.5;if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {continue;}
float sampleDepth=abs(textureLod(depthSampler,offset.xy,0.0).r);difference=depthSign*samplePosition.z-sampleDepth;float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);occlusion+=step(EPSILON,difference)*rangeCheck;}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor=vec4(vec3(result),1.0);}
#endif
#ifdef BLUR
uniform float outSize;uniform float soften;uniform float tolerance;uniform int samples;
#ifndef BLUR_BYPASS
uniform sampler2D depthSampler;
#ifdef BLUR_LEGACY
#define inline
float blur13Bilateral(sampler2D image,vec2 uv,vec2 step) {float result=0.0;vec2 off1=vec2(1.411764705882353)*step;vec2 off2=vec2(3.2941176470588234)*step;vec2 off3=vec2(5.176470588235294)*step;float compareDepth=abs(textureLod(depthSampler,uv,0.0).r);float sampleDepth;float weight;float weightSum=30.0;result+=textureLod(image,uv,0.0).r*30.0;sampleDepth=abs(textureLod(depthSampler,uv+off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv+off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off1,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+= weight;result+=textureLod(image,uv-off1,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off2,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off2,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv+off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv+off3,0.0).r*weight;sampleDepth=abs(textureLod(depthSampler,uv-off3,0.0).r);weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);weightSum+=weight;result+=textureLod(image,uv-off3,0.0).r*weight;return result/weightSum;}
#endif
#endif
void main()
{float result=0.0;
#ifdef BLUR_BYPASS
result=textureLod(textureSampler,vUV,0.0).r;
#else
#ifdef BLUR_H
vec2 step=vec2(1.0/outSize,0.0);
#else
vec2 step=vec2(0.0,1.0/outSize);
#endif
#ifdef BLUR_LEGACY
result=blur13Bilateral(textureSampler,vUV,step);
#else
float compareDepth=abs(textureLod(depthSampler,vUV,0.0).r);float weightSum=0.0;for (int i=-samples; i<samples; i+=2)
{vec2 samplePos=vUV+step*(float(i)+0.5);float sampleDepth=abs(textureLod(depthSampler,samplePos,0.0).r);float falloff=smoothstep(0.0,
float(samples),
float(samples)-abs(float(i))*soften);float minDivider=tolerance*0.5+0.003;float weight=falloff/( minDivider+abs(compareDepth-sampleDepth));result+=textureLod(textureSampler,samplePos,0.0).r*weight;weightSum+=weight;}
result/=weightSum;
#endif
#endif
gl_FragColor.rgb=vec3(result);gl_FragColor.a=1.0;}
#endif
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},35729:function(e,t,i){i.r(t),i.d(t,{ssaoCombinePixelShader:function(){return a}});var r=i(29427);let s="ssaoCombinePixelShader",n=`uniform sampler2D textureSampler;uniform sampler2D originalColor;uniform vec4 viewport;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);vec4 sceneColor=texture2D(originalColor,vUV);gl_FragColor=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},99154:function(e,t,i){i.r(t),i.d(t,{tonemapPixelShader:function(){return a}});var r=i(29427);let s="tonemapPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform float _ExposureAdjustment;
#if defined(HABLE_TONEMAPPING)
const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;const float W=11.2;
#endif
float Luminance(vec3 c)
{return dot(c,vec3(0.22,0.707,0.071));}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec3 colour=texture2D(textureSampler,vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
float lum=Luminance(colour.rgb); 
float lumTm=lum*_ExposureAdjustment;float scale=lumTm/(1.0+lumTm); 
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=_ExposureAdjustment;const float ExposureBias=2.0;vec3 x=ExposureBias*colour;vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;x=vec3(W,W,W);vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=_ExposureAdjustment;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);
#endif
gl_FragColor=vec4(colour.rgb,1.0);}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},57196:function(e,t,i){i.r(t),i.d(t,{vrDistortionCorrectionPixelShader:function(){return a}});var r=i(29427);let s="vrDistortionCorrectionPixelShader",n=`varying vec2 vUV;uniform sampler2D textureSampler;uniform vec2 LensCenter;uniform vec2 Scale;uniform vec2 ScaleIn;uniform vec4 HmdWarpParam;vec2 HmdWarp(vec2 in01) {vec2 theta=(in01-LensCenter)*ScaleIn; 
float rSq=theta.x*theta.x+theta.y*theta.y;vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);return LensCenter+Scale*rvector;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec2 tc=HmdWarp(vUV);if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);else{gl_FragColor=texture2D(textureSampler,tc);}}`;r.v.ShadersStore[s]=n;let a={name:s,shader:n}},34362:function(e,t,i){i.d(t,{b:function(){return s},d:function(){return n}});var r=i(4224);class s{}s.ANCHOR_SYSTEM="xr-anchor-system",s.BACKGROUND_REMOVER="xr-background-remover",s.HIT_TEST="xr-hit-test",s.MESH_DETECTION="xr-mesh-detection",s.PHYSICS_CONTROLLERS="xr-physics-controller",s.PLANE_DETECTION="xr-plane-detection",s.POINTER_SELECTION="xr-controller-pointer-selection",s.TELEPORTATION="xr-controller-teleportation",s.FEATURE_POINTS="xr-feature-points",s.HAND_TRACKING="xr-hand-tracking",s.IMAGE_TRACKING="xr-image-tracking",s.NEAR_INTERACTION="xr-near-interaction",s.DOM_OVERLAY="xr-dom-overlay",s.MOVEMENT="xr-controller-movement",s.LIGHT_ESTIMATION="xr-light-estimation",s.EYE_TRACKING="xr-eye-tracking",s.WALKING_LOCOMOTION="xr-walking-locomotion",s.LAYERS="xr-layers",s.DEPTH_SENSING="xr-depth-sensing",s.SPACE_WARP="xr-space-warp",s.RAW_CAMERA_ACCESS="xr-raw-camera-access";class n{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(e=>{let t=this._features[e];!t.enabled||t.featureImplementation.attached||t.featureImplementation.disableAutoAttach||this.attachFeature(e)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(e=>{let t=this._features[e];t.enabled&&t.featureImplementation.attached&&this.detachFeature(e)})})}static AddWebXRFeature(e,t,i=1,r=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),r&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,r){let s=this._AvailableFeatures[e][t];if(!s)throw Error("feature not found");return s(i,r)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){let t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&!t.featureImplementation.attach()&&r.w1.Warn(`Feature ${e} failed to attach`)}detachFeature(e){let t=this._features[e];t&&t.featureImplementation.attached&&!t.featureImplementation.detach()&&r.w1.Warn(`Feature ${e} failed to detach`)}disableFeature(e){let t="string"==typeof e?e:e.Name,i=this._features[t];return!!i&&!!i.enabled&&(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0)}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,t="latest",i={},s=!0,a=!0){let o="string"==typeof e?e:e.Name,l=0;if("string"==typeof t){if(!t)throw Error(`Error in provided version - ${o} (${t})`);if(-1===(l="stable"===t?n.GetStableVersionOfFeature(o):"latest"===t?n.GetLatestVersionOfFeature(o):+t)||isNaN(l))throw Error(`feature not found - ${o} (${t})`)}else l=t;let c=n._ConflictingFeatures[o];if(void 0!==c&&-1!==this.getEnabledFeatures().indexOf(c))throw Error(`Feature ${o} cannot be enabled while ${c} is enabled.`);let u=this._features[o],h=n.ConstructFeature(o,l,this._xrSessionManager,i);if(!h)throw Error(`feature not found - ${o}`);u&&this.disableFeature(o);let d=h();if(d.dependsOn&&!d.dependsOn.every(e=>!!this._features[e]))throw Error(`Dependant features missing. Make sure the following features are enabled - ${d.dependsOn.join(", ")}`);if(d.isCompatible())return this._features[o]={featureImplementation:d,enabled:!0,version:l,required:a},s?this._xrSessionManager.session&&!this._features[o].featureImplementation.attached&&this.attachFeature(o):this._features[o].featureImplementation.disableAutoAttach=!0,this._features[o].featureImplementation;if(!a)return r.w1.Warn(`Feature ${o} not compatible with the current environment/browser and was not enabled.`),d;throw Error("required feature not compatible")}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){for(let t of this.getEnabledFeatures()){let i=this._features[t],r=i.featureImplementation.xrNativeFeatureName;if(r&&(i.required?(e.requiredFeatures=e.requiredFeatures||[],-1===e.requiredFeatures.indexOf(r)&&e.requiredFeatures.push(r)):(e.optionalFeatures=e.optionalFeatures||[],-1===e.optionalFeatures.indexOf(r)&&e.optionalFeatures.push(r))),i.featureImplementation.getXRSessionInitExtension){let t=await i.featureImplementation.getXRSessionInitExtension();e={...e,...t}}}return e}}n._AvailableFeatures={},n._ConflictingFeatures={[s.TELEPORTATION]:s.MOVEMENT,[s.MOVEMENT]:s.TELEPORTATION}},29723:function(e,t,i){i.d(t,{x23:function(){return rA.x},kOu:function(){return rf},SpM:function(){return m3},V1s:function(){return rO.V},Wot:function(){return aN.Wo},HEv:function(){return aN.HE},NRF:function(){return nX.NR},$6X:function(){return nv.$6},pTP:function(){return oY.pT},QkU:function(){return n$.Qk},voY:function(){return f4},eiL:function(){return pZ},Ox3:function(){return oq},Qmf:function(){return n1.Q},D4V:function(){return sJ.D},fQC:function(){return rc},cEJ:function(){return sE.c},cMO:function(){return ca.c},frz:function(){return m7},ezm:function(){return o$.e},Kj0:function(){return rP.Kj},VO7:function(){return nZ.V},Oie:function(){return lZ},_8k:function(){return um._},YVB:function(){return la.Y},pcH:function(){return ps.p},Dso:function(){return sD.D},xNJ:function(){return cX},_iX:function(){return s2._},xsS:function(){return rH.x},n0n:function(){return lh.n0},GY9:function(){return _n},ywH:function(){return _s},uXA:function(){return cm},Jyq:function(){return pg},PMe:function(){return oZ},jyi:function(){return cj},ZmM:function(){return cZ},KuD:function(){return nn.K},xEZ:function(){return rZ.x},YOI:function(){return rR.Y},xcu:function(){return sM.x},FM8:function(){return aN.FM},Pa4:function(){return aN.P},oZy:function(){return st.o}});var r,s,n,a,o,l,c,u,h,d,f,p,m,_,g,v,S,x,E,C,T,b,y,I,P,R,A,M,N,O,D,F,L,w,B,V,U,k,G,z,H,W,Y,X,$,j,q,Q,K,Z,J,ee,et,ei,er,es,en,ea,eo,el,ec,eu,eh,ed,ef,ep,em,e_,eg,ev,eS,ex,eE,eC,eT,eb,ey,eI,eP,eR,eA,eM,eN,eO,eD,eF,eL,ew,eB,eV,eU,ek,eG,ez,eH,eW,eY,eX,e$,ej,eq,eQ,eK,eZ,eJ,e0,e1,e2,e3,e4,e5,e7,e6,e8,e9,te,tt,ti,tr,ts,tn,ta,to,tl,tc,tu,th,td,tf,tp,tm,t_,tg,tv,tS,tx,tE,tC,tT,tb,ty,tI,tP,tR,tA,tM,tN,tO,tD,tF,tL,tw,tB,tV,tU,tk,tG,tz,tH,tW,tY,tX,t$,tj,tq,tQ,tK,tZ,tJ,t0,t1,t2,t3,t4,t5,t7,t6,t8,t9,ie,it,ii,ir,is,ia,io,il,ic,iu,ih,id,ip,im,i_,ig,iv,iS,ix,iE,iC,iT,ib,iy,iI,iP,iR,iA,iM,iN,iO,iD,iF,iL,iw,iB,iV,iU,ik,iG,iz,iH,iW,iY,iX,i$,ij,iq,iQ,iK,iZ,iJ=i(10035),i0=i(82877),i1=i(39884),i2=i(57449),i3=i(7724);class i4{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new i0.y$,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){let e=this._condition;if(!e)return!0;let t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){this._evaluateConditionForCurrentFrame()&&(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){return null}_serialize(e,t){let i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){let e=this._condition.serialize();return e.children.push(i),t&&t.children.push(e),e}return t&&t.children.push(i),i}}i4._SerializeValueAsString=e=>"number"==typeof e?e.toString():"boolean"==typeof e?e?"true":"false":e instanceof i1.FM?e.x+", "+e.y:e instanceof i1.P?e.x+", "+e.y+", "+e.z:e instanceof i2.Wo?e.r+", "+e.g+", "+e.b:e instanceof i2.HE?e.r+", "+e.g+", "+e.b+", "+e.a:e,i4._GetTargetProperty=e=>({name:"target",targetType:e._isMesh?"MeshProperties":e._isLight?"LightProperties":e._isCamera?"CameraProperties":e._isMaterial?"MaterialProperties":"SceneProperties",value:e._isScene?"Scene":e.name}),(0,i3.H7)("BABYLON.Action",i4);var i5=i(68361);class i7{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class i6 extends i7{static get IsEqual(){return i6._IsEqual}static get IsDifferent(){return i6._IsDifferent}static get IsGreater(){return i6._IsGreater}static get IsLesser(){return i6._IsLesser}constructor(e,t,i,r,s=i6.IsEqual){super(e),this.propertyPath=i,this.value=r,this.operator=s,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}isValid(){switch(this.operator){case i6.IsGreater:return this._effectiveTarget[this._property]>this.value;case i6.IsLesser:return this._effectiveTarget[this._property]<this.value;case i6.IsEqual:case i6.IsDifferent:{let e;return e=this.value.equals?this.value.equals(this._effectiveTarget[this._property]):this.value===this._effectiveTarget[this._property],this.operator===i6.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[i4._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:i4._SerializeValueAsString(this.value)},{name:"operator",value:i6.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case i6._IsEqual:return"IsEqual";case i6._IsDifferent:return"IsDifferent";case i6._IsGreater:return"IsGreater";case i6._IsLesser:return"IsLesser";default:return""}}}i6._IsEqual=0,i6._IsDifferent=1,i6._IsGreater=2,i6._IsLesser=3;class i8 extends i7{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class i9 extends i7{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[i4._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}(0,i3.H7)("BABYLON.ValueCondition",i6),(0,i3.H7)("BABYLON.PredicateCondition",i8),(0,i3.H7)("BABYLON.StateCondition",i9);var re=i(9719);class rt extends i4{constructor(e,t,i,r){super(e,r),this.propertyPath=i,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=!this._effectiveTarget[this._property]}serialize(e){return super._serialize({name:"SwitchBooleanAction",properties:[i4._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath}]},e)}}class ri extends i4{constructor(e,t,i,r){super(e,r),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[i4._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class rr extends i4{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[i4._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:i4._SerializeValueAsString(this.value)}]},e)}}class rs extends i4{constructor(e,t,i,r,s){super(e,s),this.propertyPath=i,this.value=r,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),"number"!=typeof this._effectiveTarget[this._property]&&re.Y.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[i4._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:i4._SerializeValueAsString(this.value)}]},e)}}class rn extends i4{constructor(e,t,i,r,s,n){super(e,n),this.from=i,this.to=r,this.loop=s,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[i4._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:i4._SerializeValueAsString(this.loop)||!1}]},e)}}class ra extends i4{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[i4._GetTargetProperty(this._target)]},e)}}class ro extends i4{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class rl extends i4{constructor(e,t,i,r=!0){super(e,i),this.children=t,this.enableChildrenConditions=r}_prepare(){for(let e=0;e<this.children.length;e++)this.children[e]._actionManager=this._actionManager,this.children[e]._prepare()}execute(e){for(let t of this.children)(!this.enableChildrenConditions||t._evaluateConditionForCurrentFrame())&&t.execute(e)}serialize(e){let t=super._serialize({name:"CombineAction",properties:[],combine:[]},e);for(let e=0;e<this.children.length;e++)t.combine.push(this.children[e].serialize(null));return t}}class rc extends i4{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class ru extends i4{constructor(e,t,i,r){super(e,r),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;let e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=i1.P.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[i4._GetTargetProperty(this._target),i4._GetTargetProperty(this._parent)]},e)}}(0,i3.H7)("BABYLON.SetParentAction",ru),(0,i3.H7)("BABYLON.ExecuteCodeAction",rc),(0,i3.H7)("BABYLON.DoNothingAction",ro),(0,i3.H7)("BABYLON.StopAnimationAction",ra),(0,i3.H7)("BABYLON.PlayAnimationAction",rn),(0,i3.H7)("BABYLON.IncrementValueAction",rs),(0,i3.H7)("BABYLON.SetValueAction",rr),(0,i3.H7)("BABYLON.SetStateAction",ri),(0,i3.H7)("BABYLON.SetParentAction",ru),(0,i3.H7)("BABYLON.SwitchBooleanAction",rt),(0,i3.H7)("BABYLON.CombineAction",rl);var rh=i(51092),rd=i(31642);class rf extends iJ.O{constructor(e){if(super(),!(e=e||rh.l.LastCreatedScene))return;this._scene=e,e.actionManagers.push(this)}dispose(){let e=this._scene.actionManagers.indexOf(this);for(let e=0;e<this.actions.length;e++){let t=this.actions[e];rf.Triggers[t.trigger]--,0===rf.Triggers[t.trigger]&&delete rf.Triggers[t.trigger]}for(let t of(this.actions.length=0,e>-1&&this._scene.actionManagers.splice(e,1),this._scene.meshes.filter(e=>e.actionManager===this)))t.actionManager=null}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){let i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){let r=this.actions[i];if(e==r.trigger||t==r.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){let r=this.actions[i];if(r.trigger===e&&(!t||t(r.getTriggerParameter())))return!0}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){let t=this.actions[e];if(t.trigger>=rf.OnPickTrigger&&t.trigger<=rf.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){let t=this.actions[e];if(t.trigger>=rf.OnPickTrigger&&t.trigger<=rf.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===rf.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(re.Y.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),this.getScene()._registeredActions++,rf.Triggers[e.trigger]?rf.Triggers[e.trigger]++:rf.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){let t=this.actions.indexOf(e);return -1!==t&&(this.actions.splice(t,1),rf.Triggers[e.trigger]-=1,0===rf.Triggers[e.trigger]&&delete rf.Triggers[e.trigger],e._actionManager=null,this.getScene()._registeredActions--,!0)}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){let r=this.actions[i];if(r.trigger===e){if(t&&(e===rf.OnKeyUpTrigger||e===rf.OnKeyDownTrigger)){let e=r.getTriggerParameter();if("function"==typeof e){if(!e(t))continue}else if(e&&e!==t.sourceEvent.keyCode){if(!e.toLowerCase)continue;let i=e.toLowerCase();if(i!==t.sourceEvent.key&&String.fromCharCode(t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode).toLowerCase()!==i)continue}}r._executeCurrent(t)}}}_getEffectiveTarget(e,t){let i=t.split(".");for(let t=0;t<i.length-1;t++)e=e[i[t]];return e}_getProperty(e){let t=e.split(".");return t[t.length-1]}serialize(e){let t={children:[],name:e,type:3,properties:[]};for(let e=0;e<this.actions.length;e++){let i={type:0,children:[],name:rf.GetTriggerName(this.actions[e].trigger),properties:[]},r=this.actions[e].triggerOptions;if(r&&"number"!=typeof r){if(r.parameter instanceof Node)i.properties.push(i4._GetTargetProperty(r.parameter));else if("object"==typeof r.parameter){let e={};rd.j.DeepCopy(r.parameter,e,["mesh"]),r.parameter&&r.parameter.mesh&&(e._meshId=r.parameter.mesh.id),i.properties.push({name:"parameter",targetType:null,value:e})}else i.properties.push({name:"parameter",targetType:null,value:r.parameter})}this.actions[e].serialize(i),t.children.push(i)}return t}static Parse(e,t,i){let r=new rf(i);null===t?i.actionManager=r:t.actionManager=r;let s=(e,t)=>{let i=(0,i3.qw)("BABYLON."+e);return i&&new i(...t)},n=(e,t,i,r)=>{if(null===r){let e=parseFloat(t);return"true"===t||"false"===t?"true"===t:isNaN(e)?t:e}let s=r.split("."),n=t.split(",");for(let e=0;e<s.length;e++)i=i[s[e]];if("boolean"==typeof i)return"true"===n[0];if("string"==typeof i)return n[0];let a=[];for(let e=0;e<n.length;e++)a.push(parseFloat(n[e]));return i instanceof i1.P?i1.P.FromArray(a):i instanceof i1.Lt?i1.Lt.FromArray(a):i instanceof i2.Wo?i2.Wo.FromArray(a):i instanceof i2.HE?i2.HE.FromArray(a):parseFloat(n[0])},a=(e,t,o,l,c=null)=>{if(e.detached)return;let u=[],h=null,d=null,f=e.combine&&e.combine.length>0;if(2===e.type?u.push(r):u.push(t),f){let t=[];for(let i=0;i<e.combine.length;i++)a(e.combine[i],rf.NothingTrigger,o,l,t);u.push(t)}else for(let t=0;t<e.properties.length;t++){let r=e.properties[t].value,s=e.properties[t].name,a=e.properties[t].targetType;"target"===s?r=h="SceneProperties"===a?i:"MaterialProperties"===a?i.getMaterialByName(r):i.getNodeByName(r):"parent"===s?r=i.getNodeByName(r):"sound"===s?i.getSoundByName&&(r=i.getSoundByName(r)):"propertyPath"!==s?r=2===e.type&&"operator"===s?i6[r]:n(s,r,h,"value"===s?d:null):d=r,u.push(r)}if(null===c?u.push(o):u.push(null),"InterpolateValueAction"===e.name){let e=u[u.length-2];u[u.length-1]=e,u[u.length-2]=o}let p=s(e.name,u);if(p instanceof i7&&null!==o){let e=new ro(t,o);l?l.then(e):r.registerAction(e),l=e}null===c?p instanceof i7?(o=p,p=l):(o=null,l?l.then(p):r.registerAction(p)):c.push(p);for(let i=0;i<e.children.length;i++)a(e.children[i],t,o,p,null)};for(let t=0;t<e.children.length;t++){let r;let s=e.children[t];if(s.properties.length>0){let e=s.properties[0].value,t=null===s.properties[0].targetType?e:i.getMeshByName(e);t._meshId&&(t.mesh=i.getMeshById(t._meshId)),r={trigger:rf[s.name],parameter:t}}else r=rf[s.name];for(let e=0;e<s.children.length;e++)s.detached||a(s.children[e],r,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnDoublePickTrigger";case 7:return"OnPickUpTrigger";case 8:return"OnLongPressTrigger";case 9:return"OnPointerOverTrigger";case 10:return"OnPointerOutTrigger";case 11:return"OnEveryFrameTrigger";case 12:return"OnIntersectionEnterTrigger";case 13:return"OnIntersectionExitTrigger";case 14:return"OnKeyDownTrigger";case 15:return"OnKeyUpTrigger";case 16:return"OnPickOutTrigger";default:return""}}}rf.NothingTrigger=0,rf.OnPickTrigger=1,rf.OnLeftPickTrigger=2,rf.OnRightPickTrigger=3,rf.OnCenterPickTrigger=4,rf.OnPickDownTrigger=5,rf.OnDoublePickTrigger=6,rf.OnPickUpTrigger=7,rf.OnPickOutTrigger=16,rf.OnLongPressTrigger=8,rf.OnPointerOverTrigger=9,rf.OnPointerOutTrigger=10,rf.OnEveryFrameTrigger=11,rf.OnIntersectionEnterTrigger=12,rf.OnIntersectionExitTrigger=13,rf.OnKeyDownTrigger=14,rf.OnKeyUpTrigger=15;class rp extends i4{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}class rm extends i4{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){void 0!==this._sound&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}(0,i3.H7)("BABYLON.PlaySoundAction",rp),(0,i3.H7)("BABYLON.StopSoundAction",rm);var r_=i(90247);class rg extends i4{constructor(e,t,i,r,s=1e3,n,a,o){super(e,n),this.duration=1e3,this.onInterpolationDoneObservable=new i0.y$,this.propertyPath=i,this.value=r,this.duration=s,this.stopOtherAnimations=a,this.onInterpolationDone=o,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){let e;let t=this._actionManager.getScene(),i=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];if("number"==typeof this.value)e=r_.fw.ANIMATIONTYPE_FLOAT;else if(this.value instanceof i2.Wo)e=r_.fw.ANIMATIONTYPE_COLOR3;else if(this.value instanceof i1.P)e=r_.fw.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof i1.y3)e=r_.fw.ANIMATIONTYPE_MATRIX;else if(this.value instanceof i1._f)e=r_.fw.ANIMATIONTYPE_QUATERNION;else{re.Y.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}let r=new r_.fw("InterpolateValueAction",this._property,1e3/this.duration*100,e,r_.fw.ANIMATIONLOOPMODE_CONSTANT);r.setKeys(i),this.stopOtherAnimations&&t.stopAnimation(this._effectiveTarget),t.beginDirectAnimation(this._effectiveTarget,[r],0,100,!1,1,()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()})}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[i4._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:i4._SerializeValueAsString(this.value)},{name:"duration",value:i4._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:i4._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}}(0,i3.H7)("BABYLON.InterpolateValueAction",rg),i(35488);var rv=i(83798);class rS{constructor(){this._easingMode=rS.EASINGMODE_EASEIN}setEasingMode(e){this._easingMode=Math.min(Math.max(e,0),2)}getEasingMode(){return this._easingMode}easeInCore(e){throw Error("You must implement this method")}ease(e){switch(this._easingMode){case rS.EASINGMODE_EASEIN:return this.easeInCore(e);case rS.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:.5*this.easeInCore(2*e)}}rS.EASINGMODE_EASEIN=0,rS.EASINGMODE_EASEOUT=1,rS.EASINGMODE_EASEINOUT=2;class rx extends rS{easeInCore(e){return 1-Math.sqrt(1-(e=Math.max(0,Math.min(1,e)))*e)}}class rE extends rS{constructor(e=1){super(),this.amplitude=e}easeInCore(e){return Math.pow(e,3)-e*Math.max(0,this.amplitude)*Math.sin(3.141592653589793*e)}}class rC extends rS{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class rT extends rS{easeInCore(e){return e*e}}class rb extends rS{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}i(28116);var ry=i(18003);(r=e9||(e9={}))[r.NONE=0]="NONE",r[r.STEP=1]="STEP";var rI=i(22170);(s=te||(te={}))[s.Include=0]="Include",s[s.Exclude=1]="Exclude";var rP=i(35823),rR=i(3860),rA=i(98396),rM=i(50356),rN=i(59744),rO=i(35910),rD=i(4224);class rF{constructor(){this.rootNodes=[],this.cameras=[],this.lights=[],this.meshes=[],this.skeletons=[],this.particleSystems=[],this.animations=[],this.animationGroups=[],this.multiMaterials=[],this.materials=[],this.morphTargetManagers=[],this.geometries=[],this.transformNodes=[],this.actionManagers=[],this.textures=[],this._environmentTexture=null,this.postProcesses=[],this.sounds=null,this.effectLayers=[],this.layers=[],this.reflectionProbes=[]}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=[];return e=(e=(e=(e=e.concat(this.meshes)).concat(this.lights)).concat(this.cameras)).concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}class rL extends rF{}class rw{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}dispose(){this.rootNodes.slice(0).forEach(e=>{e.dispose()}),this.rootNodes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0}}class rB extends rF{constructor(e){if(super(),this._wasAddedToScene=!1,!(e=e||rh.l.LastCreatedScene))return;this.scene=e,this.proceduralTextures=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(let e of this.geometries)e._rebuild();for(let e of this.meshes)e._rebuild();for(let e of this.particleSystems)e.rebuild();for(let e of this.textures)e._rebuild()})}_topologicalSort(e){let t=new Map;for(let i of e)t.set(i.uniqueId,i);let i={dependsOn:new Map,dependedBy:new Map};for(let t of e){let e=t.uniqueId;i.dependsOn.set(e,new Set),i.dependedBy.set(e,new Set)}for(let r of e){let e=r.uniqueId,s=i.dependsOn.get(e);if(r instanceof rM.S){let n=r.sourceMesh;t.has(n.uniqueId)&&(s.add(n.uniqueId),i.dependedBy.get(n.uniqueId).add(e))}let n=i.dependedBy.get(e);for(let s of r.getDescendants()){let r=s.uniqueId;t.has(r)&&(n.add(r),i.dependsOn.get(r).add(e))}}let r=[],s=[];for(let r of e){let e=r.uniqueId;0===i.dependsOn.get(e).size&&(s.push(r),t.delete(e))}for(;s.length>0;){let e=s.shift();for(let n of(r.push(e),Array.from(i.dependedBy.get(e.uniqueId).values()))){let r=i.dependsOn.get(n);r.delete(e.uniqueId),0===r.size&&t.get(n)&&(s.push(t.get(n)),t.delete(n))}}return t.size>0&&(re.Y.Error("SceneSerializer._topologicalSort: There were unvisited nodes:"),t.forEach(e=>re.Y.Error(e.name))),r}_addNodeAndDescendantsToList(e,t,i,r){if(!(!i||r&&!r(i)||t.has(i.uniqueId)))for(let s of(e.push(i),t.add(i.uniqueId),i.getDescendants(!0)))this._addNodeAndDescendantsToList(e,t,s,r)}_isNodeInContainer(e){return e instanceof rA.x&&-1!==this.meshes.indexOf(e)||e instanceof rR.Y&&-1!==this.transformNodes.indexOf(e)||e instanceof rN._&&-1!==this.lights.indexOf(e)||e instanceof rO.V&&-1!==this.cameras.indexOf(e)}_isValidHierarchy(){for(let e of this.meshes)if(e.parent&&!this._isNodeInContainer(e.parent))return re.Y.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.transformNodes)if(e.parent&&!this._isNodeInContainer(e.parent))return re.Y.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.lights)if(e.parent&&!this._isNodeInContainer(e.parent))return re.Y.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;for(let e of this.cameras)if(e.parent&&!this._isNodeInContainer(e.parent))return re.Y.Warn(`Node ${e.name} has a parent that is not in the container.`),!1;return!0}instantiateModelsToScene(e,t=!1,i){this._isValidHierarchy()||rD.w1.Warn("SceneSerializer.InstantiateModelsToScene: The Asset Container hierarchy is not valid.");let r={},s={},n=new rw,a=[],o=[],l={doNotInstantiate:!0,...i},c=(t,i)=>{if(r[t.uniqueId]=i.uniqueId,s[i.uniqueId]=i,e&&(i.name=e(t.name)),i instanceof rP.Kj&&i.morphTargetManager){let e=t.morphTargetManager;i.morphTargetManager=e.clone();for(let t=0;t<e.numTargets;t++){let n=e.getTarget(t),a=i.morphTargetManager.getTarget(t);r[n.uniqueId]=a.uniqueId,s[a.uniqueId]=a}}},u=[],h=new Set;for(let e of this.transformNodes)null===e.parent&&this._addNodeAndDescendantsToList(u,h,e,l.predicate);for(let e of this.meshes)null===e.parent&&this._addNodeAndDescendantsToList(u,h,e,l.predicate);let d=this._topologicalSort(u),f=(i,a)=>{if(c(i,a),i.parent){let e=s[r[i.parent.uniqueId]];e?a.parent=e:a.parent=i.parent}if(a.position&&i.position&&a.position.copyFrom(i.position),a.rotationQuaternion&&i.rotationQuaternion&&a.rotationQuaternion.copyFrom(i.rotationQuaternion),a.rotation&&i.rotation&&a.rotation.copyFrom(i.rotation),a.scaling&&i.scaling&&a.scaling.copyFrom(i.scaling),a.material&&a.material){if(t){let t=i.material;if(-1===o.indexOf(t)){let i=t.clone(e?e(t.name):"Clone of "+t.name);if(o.push(t),r[t.uniqueId]=i.uniqueId,s[i.uniqueId]=i,"MultiMaterial"===t.getClassName()){for(let n of t.subMaterials)n&&(i=n.clone(e?e(n.name):"Clone of "+n.name),o.push(n),r[n.uniqueId]=i.uniqueId,s[i.uniqueId]=i);t.subMaterials=t.subMaterials.map(e=>e&&s[r[e.uniqueId]])}}"InstancedMesh"!==a.getClassName()&&(a.material=s[r[t.uniqueId]])}else"MultiMaterial"===a.material.getClassName()?-1===this.scene.multiMaterials.indexOf(a.material)&&this.scene.addMultiMaterial(a.material):-1===this.scene.materials.indexOf(a.material)&&this.scene.addMaterial(a.material)}null===a.parent&&n.rootNodes.push(a)};return d.forEach(e=>{if("InstancedMesh"===e.getClassName()){let t=e.sourceMesh,i=r[t.uniqueId],n=("number"==typeof i?s[i]:t).createInstance(e.name);f(e,n)}else{let t=!0;"TransformNode"===e.getClassName()||"Node"===e.getClassName()||e.skeleton||!e.getTotalVertices||0===e.getTotalVertices()?t=!1:l.doNotInstantiate&&(t="function"==typeof l.doNotInstantiate?!l.doNotInstantiate(e):!l.doNotInstantiate);let i=t?e.createInstance(`instance of ${e.name}`):e.clone(`Clone of ${e.name}`,null,!0);if(!i)throw Error(`Could not clone or instantiate node on Asset Container ${e.name}`);f(e,i)}}),this.skeletons.forEach(t=>{if(l.predicate&&!l.predicate(t))return;let i=t.clone(e?e(t.name):"Clone of "+t.name);for(let e of this.meshes)if(e.skeleton===t&&!e.isAnInstance){let t=s[r[e.uniqueId]];if(!t||t.isAnInstance||(t.skeleton=i,-1!==a.indexOf(i)))continue;for(let e of(a.push(i),i.bones))e._linkedTransformNode&&(e._linkedTransformNode=s[r[e._linkedTransformNode.uniqueId]])}n.skeletons.push(i)}),this.animationGroups.forEach(t=>{if(l.predicate&&!l.predicate(t))return;let i=t.clone(e?e(t.name):"Clone of "+t.name,e=>s[r[e.uniqueId]]||e);n.animationGroups.push(i)}),n}addAllToScene(){if(!this._wasAddedToScene){for(let e of(this._isValidHierarchy()||rD.w1.Warn("SceneSerializer.addAllToScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture),this.scene._serializableComponents))e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){let t=[];for(let i of(this.cameras.forEach(i=>{(!e||e(i))&&(this.scene.addCamera(i),t.push(i))}),this.lights.forEach(i=>{(!e||e(i))&&(this.scene.addLight(i),t.push(i))}),this.meshes.forEach(i=>{(!e||e(i))&&(this.scene.addMesh(i),t.push(i))}),this.skeletons.forEach(t=>{(!e||e(t))&&this.scene.addSkeleton(t)}),this.animations.forEach(t=>{(!e||e(t))&&this.scene.addAnimation(t)}),this.animationGroups.forEach(t=>{(!e||e(t))&&this.scene.addAnimationGroup(t)}),this.multiMaterials.forEach(t=>{(!e||e(t))&&this.scene.addMultiMaterial(t)}),this.materials.forEach(t=>{(!e||e(t))&&this.scene.addMaterial(t)}),this.morphTargetManagers.forEach(t=>{(!e||e(t))&&this.scene.addMorphTargetManager(t)}),this.geometries.forEach(t=>{(!e||e(t))&&this.scene.addGeometry(t)}),this.transformNodes.forEach(i=>{(!e||e(i))&&(this.scene.addTransformNode(i),t.push(i))}),this.actionManagers.forEach(t=>{(!e||e(t))&&this.scene.addActionManager(t)}),this.textures.forEach(t=>{(!e||e(t))&&this.scene.addTexture(t)}),this.reflectionProbes.forEach(t=>{(!e||e(t))&&this.scene.addReflectionProbe(t)}),t))i.parent&&-1===this.scene.getNodes().indexOf(i.parent)&&(i.setParent?i.setParent(null):i.parent=null)}removeAllFromScene(){for(let e of(this._isValidHierarchy()||rD.w1.Warn("SceneSerializer.removeAllFromScene: The Asset Container hierarchy is not valid."),this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null),this.scene._serializableComponents))e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{(!e||e(t))&&this.scene.removeCamera(t)}),this.lights.forEach(t=>{(!e||e(t))&&this.scene.removeLight(t)}),this.meshes.forEach(t=>{(!e||e(t))&&this.scene.removeMesh(t,!0)}),this.skeletons.forEach(t=>{(!e||e(t))&&this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{(!e||e(t))&&this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{(!e||e(t))&&this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{(!e||e(t))&&this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{(!e||e(t))&&this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{(!e||e(t))&&this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{(!e||e(t))&&this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{(!e||e(t))&&this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{(!e||e(t))&&this.scene.removeActionManager(t)}),this.textures.forEach(t=>{(!e||e(t))&&this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{(!e||e(t))&&this.scene.removeReflectionProbe(t)})}dispose(){for(let e of(this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.morphTargetManagers.slice(0).forEach(e=>{e.dispose()}),this.morphTargetManagers.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null),this.scene._serializableComponents))e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(e&&t)for(let r of e){let e=!0;if(i){for(let t of i)if(r===t){e=!1;break}}e&&(t.push(r),r._parentContainer=this)}}moveAllFromScene(e){for(let t in this._wasAddedToScene=!1,void 0===e&&(e=new rL),this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||("_environmentTexture"===t?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){let e=new rP.Kj("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=rh.l.LastCreatedScene,t,i=null){if(!e)return re.Y.Error("No scene available to merge animations to"),[];let r=i||(t=>{let i=null,r=t.animations.length?t.animations[0].targetProperty:"",s=t.name.split(".").join("").split("_primitive")[0];switch(r){case"position":case"rotationQuaternion":i=e.getTransformNodeByName(t.name)||e.getTransformNodeByName(s);break;case"influence":i=e.getMorphTargetByName(t.name)||e.getMorphTargetByName(s);break;default:i=e.getNodeByName(t.name)||e.getNodeByName(s)}return i});this.getNodes().forEach(e=>{let t=r(e);if(null!==t){for(let i of e.animations)for(let e of t.animations.filter(e=>e.targetProperty===i.targetProperty)){let i=t.animations.indexOf(e,0);i>-1&&t.animations.splice(i,1)}t.animations=t.animations.concat(e.animations)}});let s=[];return this.animationGroups.slice().forEach(e=>{s.push(e.clone(e.name,r)),e.animatables.forEach(e=>{e.stop()})}),t.forEach(t=>{let i=r(t.target);i&&(e.beginAnimation(i,t.fromFrame,t.toFrame,t.loopAnimation,t.speedRatio,t.onAnimationEnd?t.onAnimationEnd:void 0,void 0,!0,void 0,t.onAnimationLoop?t.onAnimationLoop:void 0),e.stopAnimation(t.target))}),s}populateRootNodes(){this.rootNodes.length=0,this.meshes.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}),this.transformNodes.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}),this.lights.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)}),this.cameras.forEach(e=>{e.parent||-1!==this.rootNodes.indexOf(e)||this.rootNodes.push(e)})}addAllAssetsToContainer(e){if(!e)return;let t=[],i=new Set;for(t.push(e);t.length>0;){let e=t.pop();if(e instanceof rP.Kj?(e.geometry&&-1===this.geometries.indexOf(e.geometry)&&this.geometries.push(e.geometry),this.meshes.push(e)):e instanceof rR.Y?this.transformNodes.push(e):e instanceof rN._?this.lights.push(e):e instanceof rO.V&&this.cameras.push(e),e instanceof rA.x){if(e.material&&-1===this.materials.indexOf(e.material))for(let t of(this.materials.push(e.material),e.material.getActiveTextures()))-1===this.textures.indexOf(t)&&this.textures.push(t);e.skeleton&&-1===this.skeletons.indexOf(e.skeleton)&&this.skeletons.push(e.skeleton),e.morphTargetManager&&-1===this.morphTargetManagers.indexOf(e.morphTargetManager)&&this.morphTargetManagers.push(e.morphTargetManager)}for(let r of e.getChildren())i.has(r)||t.push(r);i.add(e)}this.populateRootNodes()}}var rV=i(3176);i(70701);var rU=i(10633);class rk{get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;if(rV.a.audioEngine?.audioContext&&(this.isPlaying||this.isPaused)){let e=this.isPaused?0:rV.a.audioEngine.audioContext.currentTime-this._startTime;return this._currentTime+e}return 0}get spatialSound(){return this._spatialSound}set spatialSound(e){if(e==this._spatialSound)return;let t=this.isPlaying;this.pause(),e?(this._spatialSound=e,this._updateSpatialParameters()):this._disableSpatialSound(),t&&this.play()}constructor(e,t,i,r=null,s){if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new i0.y$,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._currentTime=0,this._position=i1.P.Zero(),this._localDirection=new i1.P(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,!(i=i||rh.l.LastCreatedScene))return;if(this._scene=i,rk._SceneComponentInitialization(i),this._readyToPlayCallback=r,this._customAttenuationFunction=(e,t,i,r,s)=>t<i?e*(1-t/i):0,s&&(this.autoplay=s.autoplay||!1,this._loop=s.loop||!1,void 0!==s.volume&&(this._volume=s.volume),this._spatialSound=s.spatialSound??!1,this.maxDistance=s.maxDistance??100,this.useCustomAttenuation=s.useCustomAttenuation??!1,this.rolloffFactor=s.rolloffFactor||1,this.refDistance=s.refDistance||1,this.distanceModel=s.distanceModel||"linear",this._playbackRate=s.playbackRate||1,this._streaming=s.streaming??!1,this._length=s.length,this._offset=s.offset),rV.a.audioEngine?.canUseWebAudio&&rV.a.audioEngine.audioContext){this._soundGain=rV.a.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let e=!0;if(t)try{"string"==typeof t?(this._urlType="String",this._url=t):t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let i=[],r=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=rV.a.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=rV.a.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(r=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":i.push(t);case"Array":0===i.length&&(i=t);for(let e=0;e<i.length;e++){let t=i[e];if(r=s&&s.skipCodecCheck||-1!==t.indexOf(".mp3",t.length-4)&&rV.a.audioEngine.isMP3supported||-1!==t.indexOf(".ogg",t.length-4)&&rV.a.audioEngine.isOGGsupported||-1!==t.indexOf(".wav",t.length-4)||-1!==t.indexOf(".m4a",t.length-4)||-1!==t.indexOf(".mp4",t.length-4)||-1!==t.indexOf("blob:")){this._streaming?(this._htmlAudioElement=new Audio(t),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,rD.w1.SetCorsBehavior(t,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()},{once:!0}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(t,e=>{this._soundLoaded(e)},void 0,!0,!0,e=>{e&&re.Y.Error("XHR "+e.status+" error on: "+t+"."),re.Y.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:e=!1}e?!r&&(this._isReadyToPlay=!0,this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):re.Y.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch(e){re.Y.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),rV.a.audioEngine&&!rV.a.audioEngine.WarnedWebAudioUnsupported&&(re.Y.Error("Web Audio is not supported by your browser."),rV.a.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}dispose(){rV.a.audioEngine?.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement),this._htmlAudioElement=null),this._streamingSource&&(this._streamingSource.disconnect(),this._streamingSource=null),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._clearTimeoutsAndObservers())}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){rV.a.audioEngine?.audioContext&&(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){rV.a.audioEngine?.audioContext&&rV.a.audioEngine.audioContext.decodeAudioData(e,e=>{this._audioBufferLoaded(e)},e=>{re.Y.Error("Error while decoding audio data for: "+this.name+" / Error: "+e)})}setAudioBuffer(e){rV.a.audioEngine?.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){e&&(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,this._playbackRate=e.playbackRate??this._playbackRate,this._length=e.length??void 0,this.spatialSound=e.spatialSound??this._spatialSound,this._setOffset(e.offset??void 0),this.setVolume(e.volume??this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),void 0!==this._offset&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),void 0!==this._length&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(0|this._offset)+this._length))))}_createSpatialParameters(){rV.a.audioEngine?.canUseWebAudio&&rV.a.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=this._soundPanner??rV.a.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_disableSpatialSound(){this._spatialSound&&(this._inputAudioNode=this._soundGain,this._soundPanner?.disconnect(),this._soundPanner=null,this._spatialSound=!1)}_updateSpatialParameters(){this._spatialSound&&(this._soundPanner?(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor),this._soundPanner.panningModel=this._panningModel):this._createSpatialParameters())}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){rV.a.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){rV.a.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){re.Y.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){re.Y.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,rV.a.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){re.Y.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,rV.a.audioEngine?.canUseWebAudio&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){e.equals(this._position)||(this._position.copyFrom(e),!rV.a.audioEngine?.canUseWebAudio||!this._spatialSound||!this._soundPanner||isNaN(this._position.x)||isNaN(this._position.y)||isNaN(this._position.z)||(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){this._localDirection=e,rV.a.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;let e=this._connectedTransformNode.getWorldMatrix(),t=i1.P.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){if(rV.a.audioEngine?.canUseWebAudio&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){let e=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){if(this._isReadyToPlay&&this._scene.audioEnabled&&rV.a.audioEngine?.audioContext)try{this._clearTimeoutsAndObservers();let r=e?rV.a.audioEngine?.audioContext.currentTime+e:rV.a.audioEngine?.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(isNaN(this._position.x)||isNaN(this._position.y)||isNaN(this._position.z)||(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(!this._streamingSource&&this._htmlAudioElement&&(this._streamingSource=rV.a.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource&&(this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode)),this._htmlAudioElement){let e=()=>{if(rV.a.audioEngine?.unlocked){if(!this._htmlAudioElement)return;this._htmlAudioElement.currentTime=t??0;let i=this._htmlAudioElement.play();void 0!==i&&i.catch(()=>{rV.a.audioEngine?.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=rV.a.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{e()}))})}else(this.loop||this.autoplay)&&(this._audioUnlockedObserver=rV.a.audioEngine?.onAudioUnlockedObservable.addOnce(()=>{e()}))};e()}}else{let s=()=>{if(rV.a.audioEngine?.audioContext){if(i=i||this._length,void 0!==t&&this._setOffset(t),this._soundSource){let e=this._soundSource;e.onended=()=>{e.disconnect()}}if(this._soundSource=rV.a.audioEngine?.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,void 0!==t&&(this._soundSource.loopStart=t),void 0!==i&&(this._soundSource.loopEnd=(0|t)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},r=e?rV.a.audioEngine?.audioContext.currentTime+e:rV.a.audioEngine.audioContext.currentTime;let s=((this.isPaused?this.currentTime:0)+(this._offset??0))%this._soundSource.buffer.duration;this._soundSource.start(r,s,this.loop?void 0:i)}}};rV.a.audioEngine?.audioContext.state==="suspended"?this._tryToPlayTimeout=setTimeout(()=>{rV.a.audioEngine?.audioContext.state==="suspended"?(rV.a.audioEngine.lock(),(this.loop||this.autoplay)&&(this._audioUnlockedObserver=rV.a.audioEngine.onAudioUnlockedObservable.addOnce(()=>{s()}))):s()},500):s()}this._startTime=r,this.isPlaying=!0,this.isPaused=!1}catch(e){re.Y.Error("Error while trying to play audio: "+this.name+", "+e.message)}}_onended(){this.isPlaying=!1,this._startTime=0,this._currentTime=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){if(this.isPlaying){if(this._clearTimeoutsAndObservers(),this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource?.disconnect(),this.isPlaying=!1;else if(rV.a.audioEngine?.audioContext&&this._soundSource){let t=e?rV.a.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.onended=()=>{this.isPlaying=!1,this.isPaused=!1,this._startTime=0,this._currentTime=0,this._soundSource&&(this._soundSource.onended=()=>void 0),this._onended()},this._soundSource.stop(t)}else this.isPlaying=!1}else this.isPaused&&(this.isPaused=!1,this._startTime=0,this._currentTime=0)}pause(){this.isPlaying&&(this._clearTimeoutsAndObservers(),this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource?.disconnect(),this.isPlaying=!1,this.isPaused=!0):rV.a.audioEngine?.audioContext&&this._soundSource&&(this._soundSource.onended=()=>void 0,this._soundSource.stop(),this.isPlaying=!1,this.isPaused=!0,this._currentTime+=rV.a.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){rV.a.audioEngine?.canUseWebAudio&&this._soundGain&&(t&&rV.a.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(rV.a.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,rV.a.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,rV.a.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getPlaybackRate(){return this._playbackRate}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,!this._spatialSound&&(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=e=>this._onRegisterAfterWorldMatrixUpdate(e),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){if(e.getBoundingInfo){let t=e.getBoundingInfo();this.setPosition(t.boundingSphere.centerWorld)}else this.setPosition(e.absolutePosition);rV.a.audioEngine?.canUseWebAudio&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{let e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new rk(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){let e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,r){let s,n;let a=e.name;s=e.url?i+e.url:i+a;let o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};if(r){let e=()=>{r._isReadyToPlay?(n._audioBuffer=r.getAudioBuffer(),n._isReadyToPlay=!0,n.autoplay&&n.play(0,n._offset,n._length)):setTimeout(e,300)};n=new rk(a,new ArrayBuffer(0),t,null,o),e()}else n=new rk(a,s,t,()=>{t.removePendingData(n)},o),t.addPendingData(n);if(e.position){let t=i1.P.FromArray(e.position);n.setPosition(t)}if(e.isDirectional&&(n.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){let t=i1.P.FromArray(e.localDirectionToMesh);n.setLocalDirectionToMesh(t)}if(e.connectedMeshId){let i=t.getMeshById(e.connectedMeshId);i&&n.attachToMesh(i)}return e.metadata&&(n.metadata=e.metadata),n}_setOffset(e){this._offset!==e&&(this.isPaused&&(this.stop(),this.isPaused=!1),this._offset=e)}_clearTimeoutsAndObservers(){this._tryToPlayTimeout&&(clearTimeout(this._tryToPlayTimeout),this._tryToPlayTimeout=null),this._audioUnlockedObserver&&(rV.a.audioEngine?.onAudioUnlockedObservable.remove(this._audioUnlockedObserver),this._audioUnlockedObserver=null)}}rk._SceneComponentInitialization=e=>{throw(0,rU.S)("AudioSceneComponent")},(0,i3.H7)("BABYLON.Sound",rk);class rG{constructor(e,t={}){if(this.id=-1,this._isInitialized=!1,!(e=e||rh.l.LastCreatedScene))return;this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1)}_initializeSoundTrackAudioGraph(){rV.a.audioEngine?.canUseWebAudio&&rV.a.audioEngine.audioContext&&(this._outputAudioNode=rV.a.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(rV.a.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(rV.a.audioEngine&&rV.a.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),rV.a.audioEngine?.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),void 0!==e.soundTrackId&&(-1===e.soundTrackId?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){let t=this.soundCollection.indexOf(e);-1!==t&&this.soundCollection.splice(t,1)}setVolume(e){rV.a.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){if(rV.a.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(rV.a.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,rV.a.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,rV.a.audioEngine.masterGain))}}var rz=i(32253),rH=i(44755),rW=i(94551),rY=i(10430);(0,rY.PS)(rz.l.NAME_AUDIO,(e,t,i,r)=>{let s,n=[];if(i.sounds=i.sounds||[],void 0!==e.sounds&&null!==e.sounds)for(let a=0,o=e.sounds.length;a<o;a++){let o=e.sounds[a];rV.a.audioEngine?.canUseWebAudio?(o.url||(o.url=o.name),n[o.url]?i.sounds.push(rk.Parse(o,t,r,n[o.url])):(s=rk.Parse(o,t,r),n[o.url]=s,i.sounds.push(s))):i.sounds.push(new rk(o.name,null,t))}n=[]}),Object.defineProperty(rH.x.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(rz.l.NAME_AUDIO);return e||(e=new rX(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new rG(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),rH.x.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks){for(let i=0;i<this.soundTracks.length;i++)for(t=0;t<this.soundTracks[i].soundCollection.length;t++)if(this.soundTracks[i].soundCollection[t].name===e)return this.soundTracks[i].soundCollection[t]}return null},Object.defineProperty(rH.x.prototype,"audioEnabled",{get:function(){let e=this._getComponent(rz.l.NAME_AUDIO);return e||(e=new rX(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(rz.l.NAME_AUDIO);t||(t=new rX(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(rH.x.prototype,"headphone",{get:function(){let e=this._getComponent(rz.l.NAME_AUDIO);return e||(e=new rX(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(rz.l.NAME_AUDIO);t||(t=new rX(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(rH.x.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(rz.l.NAME_AUDIO);return e||(e=new rX(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(rz.l.NAME_AUDIO);if(t||(t=new rX(this),this._addComponent(t)),e&&"function"!=typeof e)throw Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(rH.x.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(rz.l.NAME_AUDIO);return e||(e=new rX(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(rz.l.NAME_AUDIO);if(t||(t=new rX(this),this._addComponent(t)),e&&"function"!=typeof e)throw Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(rH.x.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(rz.l.NAME_AUDIO);return e||(e=new rX(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(rz.l.NAME_AUDIO);t||(t=new rX(this),this._addComponent(t)),t.audioPositioningRefreshRate=e},enumerable:!0,configurable:!0});class rX{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){if(this.name=rz.l.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new i1.P,this._cachedCameraPosition=new i1.P,this._lastCheck=0,this._invertMatrixTemp=new i1.y3,this._cameraDirectionTemp=new i1.P,!(e=e||rh.l.LastCreatedScene))return;this.scene=e,e.soundTracks=[],e.sounds=[]}register(){this.scene._afterRenderStage.registerStep(rz.l.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){let i=this.scene.soundTracks[t];for(let t=0;t<i.soundCollection.length;t++)e.sounds.push(i.soundCollection[t].serialize())}}addFromContainer(e){e.sounds&&e.sounds.forEach(e=>{e.play(),e.autoplay=!0,this.scene.mainSoundTrack.addSound(e)})}removeFromContainer(e,t=!1){e.sounds&&e.sounds.forEach(e=>{e.stop(),e.autoplay=!1,this.scene.mainSoundTrack.removeSound(e),t&&e.dispose()})}dispose(){let e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){let e;let t=this.scene;for(this._audioEnabled=!1,rV.a.audioEngine&&rV.a.audioEngine.audioContext&&rV.a.audioEngine.audioContext.suspend(),e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].pause();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].pause()}enableAudio(){let e;let t=this.scene;for(this._audioEnabled=!0,rV.a.audioEngine&&rV.a.audioEngine.audioContext&&rV.a.audioEngine.audioContext.resume(),e=0;e<t.mainSoundTrack.soundCollection.length;e++)t.mainSoundTrack.soundCollection[e].isPaused&&t.mainSoundTrack.soundCollection[e].play();if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++)t.soundTracks[e].soundCollection[i].isPaused&&t.soundTracks[e].soundCollection[i].play()}switchAudioModeForHeadphones(){let e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){let e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){let e=rW.F.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;let t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;let i=rV.a.audioEngine;if(i&&i.audioContext){let e,r=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(r=t.activeCameras[0]),this.audioListenerPositionProvider){let e=this.audioListenerPositionProvider();i.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0)}else r?this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)):i.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){let e=this.audioListenerRotationProvider();i.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0)}else r?(r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),i1.P.TransformNormalToRef(rX._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):i.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<t.mainSoundTrack.soundCollection.length;e++){let i=t.mainSoundTrack.soundCollection[e];i.useCustomAttenuation&&i.updateDistanceFromListener()}if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let i=0;i<t.soundTracks[e].soundCollection.length;i++){let r=t.soundTracks[e].soundCollection[i];r.useCustomAttenuation&&r.updateDistanceFromListener()}}}}rX._CameraDirection=new i1.P(0,0,-1),rk._SceneComponentInitialization=e=>{let t=e._getComponent(rz.l.NAME_AUDIO);t||(t=new rX(e),e._addComponent(t))};var r$=i(46456),rj=i(22287),rq=i(90212);class rQ{constructor(e){if(this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,!(e=e||rh.l.LastCreatedScene))return;this._scene=e,this.animationParameters=new i1.Lt(0,0,0,30)}_markSubMeshesAsAttributesDirty(){for(let e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;let i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){let e=new rQ(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,r=30){this.animationParameters=new i1.Lt(e,t,i,r)}dispose(e){e&&this._texture?.dispose()}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){rq.p.Clone(()=>e,this)}serialize(){return rq.p.Serialize(this)}parse(e,t,i){rq.p.Parse(()=>this,e,t,i)}}(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markSubMeshesAsAttributesDirty")],rQ.prototype,"texture",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markSubMeshesAsAttributesDirty")],rQ.prototype,"isEnabled",void 0),(0,r$.gn)([(0,rj.qC)()],rQ.prototype,"animationParameters",void 0),(0,r$.gn)([(0,rj.qC)()],rQ.prototype,"time",void 0);var rK=i(87117),rZ=i(81209);i(72786);var rJ=i(6132);class r0{get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}constructor(e,t,i){this.name=e,this.id=t,this.bones=[],this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=[],this._identity=i1.y3.Identity(),this._currentRenderId=-1,this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new i0.y$,this.bones=[],this._scene=i||rh.l.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;let r=this._scene.getEngine().getCaps();this._canUseTextureForBones=r.textureFloat&&r.maxVertexTextureImageUnits>0}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){if(this.needInitialSkinMatrix){if(!e)throw Error("getTransformMatrices: When using the needInitialSkinMatrix flag, a mesh must be provided");return e._bonesTransformMatrices||this.prepare(!0),e._bonesTransformMatrices}return(!this._transformMatrices||this._isDirty)&&this.prepare(!this._transformMatrices),this._transformMatrices}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let e=!0;for(let i in this._ranges)e&&(t+=", ",e=!1),t+=i;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return -1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new rI.X(e,t,i);for(let r=0,s=this.bones.length;r<s;r++)this.bones[r].animations[0]&&this.bones[r].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,r=this.bones.length;i<r;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){let e;let t=[];for(e in this._ranges)t.push(this._ranges[e]);return t}copyAnimationRange(e,t,i=!1){let r,s;if(this._ranges[t]||!e.getAnimationRange(t))return!1;let n=!0,a=this._getHighestAnimationFrame()+1,o={},l=e.bones;for(s=0,r=l.length;s<r;s++)o[l[s].name]=l[s];this.bones.length!==l.length&&(re.Y.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${l.length}`),n=!1);let c=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(s=0,r=this.bones.length;s<r;s++){let e=this.bones[s].name,r=o[e];r?n=n&&this.bones[s].copyAnimationRange(r,t,a,i,c):(re.Y.Warn("copyAnimationRange: not same rig, missing source bone "+e),n=!1)}let u=e.getAnimationRange(t);return u&&(this._ranges[t]=new rI.X(t,u.from+a,u.to+a)),n}returnToRest(){for(let e of this.bones)-1!==e._index&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){let i=this.bones[t].animations[0].getHighestFrame();e<i&&(e=i)}return e}beginAnimation(e,t,i,r){let s=this.getAnimationRange(e);return s?this._scene.beginAnimation(this,s.from,s.to,t,i,r):null}static MakeAnimationAdditive(e,t=0,i){let r=e.getAnimationRange(i);if(!r)return null;let s=e._scene.getAllAnimatablesByTarget(e),n=null;for(let e=0;e<s.length;e++){let t=s[e];if(t.fromFrame===r?.from&&t.toFrame===r?.to){n=t;break}}let a=e.getAnimatables();for(let e=0;e<a.length;e++){let r=a[e].animations;if(r)for(let e=0;e<r.length;e++)r_.fw.MakeAnimationAdditive(r[e],t,i)}return n&&(n.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){let t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){let r=this.bones[i];r._childUpdateId++;let s=r.getParent();if(s?r.getLocalMatrix().multiplyToRef(s.getFinalMatrix(),r.getFinalMatrix()):t?r.getLocalMatrix().multiplyToRef(t,r.getFinalMatrix()):r.getFinalMatrix().copyFrom(r.getLocalMatrix()),-1!==r._index){let t=null===r._index?i:r._index;r.getAbsoluteInverseBindMatrix().multiplyToArray(r.getFinalMatrix(),e,16*t)}}this._identity.copyToArray(e,16*this.bones.length)}prepare(e=!1){if(!e){let e=this.getScene().getRenderId();if(this._currentRenderId===e)return;this._currentRenderId=e}if(this._numBonesWithLinkedTransformNode>0){for(let e of this.bones)if(e._linkedTransformNode){let t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}}if(this.needInitialSkinMatrix)for(let e of this._meshesWithPoseMatrix){let t=e.getPoseMatrix(),i=this._isDirty;if(e._bonesTransformMatrices&&e._bonesTransformMatrices.length===16*(this.bones.length+1)||(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),i){if(this._synchronizedWithMesh!==e){for(let i of(this._synchronizedWithMesh=e,this.bones))i.getParent()||(i.getBindMatrix().multiplyToRef(t,i1.jp.Matrix[1]),i._updateAbsoluteBindMatrices(i1.jp.Matrix[1]));if(this.isUsingTextureForMatrices){let t=(this.bones.length+1)*4;e._transformMatrixTexture&&e._transformMatrixTexture.getSize().width===t||(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=rK.l.CreateRGBATexture(e._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=rK.l.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){let i=new r0(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let e=0;e<this.bones.length;e++){let t=this.bones[e],r=null,s=t.getParent();if(s){let e=this.bones.indexOf(s);r=i.bones[e]}let n=new rJ.N(t.name,i,r,t.getBindMatrix().clone(),t.getRestMatrix().clone());n._index=t._index,t._linkedTransformNode&&n.linkTransformNode(t._linkedTransformNode),rd.j.DeepCopy(t.animations,n.animations)}if(this._ranges)for(let e in i._ranges={},this._ranges){let t=this._ranges[e];t&&(i._ranges[e]=t.clone())}return this._isDirty=!0,i.prepare(!0),i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(t=>{t.enableBlending=!0,t.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){let e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){let e={};e.name=this.name,e.id=this.id,this.dimensionsAtRest&&(e.dimensionsAtRest=this.dimensionsAtRest.asArray()),e.bones=[],e.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let t=0;t<this.bones.length;t++){let i=this.bones[t],r=i.getParent(),s={parentBoneIndex:r?this.bones.indexOf(r):-1,index:i.getIndex(),name:i.name,id:i.id,matrix:i.getBindMatrix().asArray(),rest:i.getRestMatrix().asArray(),linkedTransformNodeId:i.getTransformNode()?.id};for(let t in e.bones.push(s),i.length&&(s.length=i.length),i.metadata&&(s.metadata=i.metadata),i.animations&&i.animations.length>0&&(s.animation=i.animations[0].serialize()),e.ranges=[],this._ranges){let i=this._ranges[t];if(!i)continue;let r={};r.name=t,r.from=i.from,r.to=i.to,e.ranges.push(r)}}return e}static Parse(e,t){let i;let r=new r0(e.name,e.id,t);for(e.dimensionsAtRest&&(r.dimensionsAtRest=i1.P.FromArray(e.dimensionsAtRest)),r.needInitialSkinMatrix=e.needInitialSkinMatrix,i=0;i<e.bones.length;i++){let t=e.bones[i],s=e.bones[i].index,n=null;t.parentBoneIndex>-1&&(n=r.bones[t.parentBoneIndex]);let a=t.rest?i1.y3.FromArray(t.rest):null,o=new rJ.N(t.name,r,n,i1.y3.FromArray(t.matrix),a,null,s);void 0!==t.id&&null!==t.id&&(o.id=t.id),t.length&&(o.length=t.length),t.metadata&&(o.metadata=t.metadata),t.animation&&o.animations.push(r_.fw.Parse(t.animation)),void 0!==t.linkedTransformNodeId&&null!==t.linkedTransformNodeId&&(r._hasWaitingData=!0,o._waitingTransformNodeId=t.linkedTransformNodeId)}if(e.ranges)for(i=0;i<e.ranges.length;i++){let t=e.ranges[i];r.createAnimationRange(t.name,t.from,t.to)}return r}computeAbsoluteMatrices(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteMatrices(),this._absoluteTransformIsDirty=!1)}computeAbsoluteTransforms(e=!1){this.computeAbsoluteMatrices(e)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){let e=[],t=Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;let r=this.bones[e];if(!r)return;void 0===r._index&&(r._index=e);let s=r.getParent();s&&this._sortBones(this.bones.indexOf(s),t,i),t.push(r)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}var r1=i(74909),r2=i(31644);class r3{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(e=>{if(e.type===r1.kD.POINTERDOWN){this._isPointerDown=!0;return}e.type===r1.kD.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;let e=rW.F.Now,t=0;null!=this._lastFrameTime&&(t=e-this._lastFrameTime),this._lastFrameTime=e,this._applyUserInteraction();let i=Math.max(Math.min((e-this._lastInteractionTime-this._idleRotationWaitTime)/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*i,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(t/1e3))})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e??rW.F.Now}_reachTargetAlpha(){return!!this._attachedCamera&&!!this.targetAlpha&&Math.abs(this._attachedCamera.alpha-this.targetAlpha)<r2.kn}_userIsZooming(){return!!this._attachedCamera&&0!==this._attachedCamera.inertialRadiusOffset}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&0!==this._attachedCamera.inertialRadiusOffset&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=rW.F.Now)}_userIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}class r4{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=[]}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;let t=this._attachedCamera;t&&(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(e=>{if(e&&(e.computeWorldMatrix(!0),e.getBoundingInfo)){let t=e.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=.05*t,this.upperRadiusTransitionRange=.05*t}}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._attachedCamera&&(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){this._attachedCamera&&(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return!!this._attachedCamera&&this._attachedCamera.radius===e&&!this._radiusIsAnimating}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(r4.EasingFunction.setEasingMode(r4.EasingMode),this._radiusBounceTransition=r_.fw.CreateAnimation("radius",r_.fw.ANIMATIONTYPE_FLOAT,60,r4.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;let t=r_.fw.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}r4.EasingFunction=new rE(.3),r4.EasingMode=rS.EASINGMODE_EASEOUT;class r5{constructor(){this.onTargetFramingAnimationEndObservable=new i0.y$,this._mode=r5.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=[],this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;let t=this._attachedCamera.getScene();r5.EasingFunction.setEasingMode(r5.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(e=>{if(e.type===r1.kD.POINTERDOWN){this._isPointerDown=!0;return}e.type===r1.kD.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(e=>{e&&e.getBoundingInfo&&this.zoomOnMesh(e,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;let e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(r.minimumWorld,r.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);let r=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(r.min,r.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){let r=new i1.P(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new i1.P(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let t=0;t<e.length;t++){let i=e[t].getHierarchyBoundingVectors(!0);i1.P.CheckExtends(i.min,r,s),i1.P.CheckExtends(i.max,r,s)}this.zoomOnBoundingInfo(r,s,t,i)}zoomOnBoundingInfo(e,t,i=!1,r=null){let s;if(!this._attachedCamera)return!1;let n=e.y,a=n+(t.y-n)*this._positionScale,o=t.subtract(e).scale(.5);if(i)s=new i1.P(0,a,0);else{let t=e.add(o);s=new i1.P(t.x,a,t.z)}this._vectorTransition||(this._vectorTransition=r_.fw.CreateAnimation("target",r_.fw.ANIMATIONTYPE_VECTOR3,60,r5.EasingFunction)),this._betaIsAnimating=!0;let l=r_.fw.TransitionTo("target",s,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);l&&this._animatables.push(l);let c=0;if(this._mode===r5.FitFrustumSidesMode){let i=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=o.length()+this._attachedCamera.minZ),c=i}else this._mode===r5.IgnoreBoundsSizeMode&&(c=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&null===this._attachedCamera.lowerRadiusLimit&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){let i=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/i,this._attachedCamera.wheelPrecision=100/c}return this._radiusTransition||(this._radiusTransition=r_.fw.CreateAnimation("radius",r_.fw.ANIMATIONTYPE_FLOAT,60,r5.EasingFunction)),(l=r_.fw.TransitionTo("radius",c,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),r&&r(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}))&&this._animatables.push(l),!0}_calculateLowerRadiusFromModelBoundingSphere(e,t){let i=this._attachedCamera;if(!i)return 0;let r=i._calculateLowerRadiusFromModelBoundingSphere(e,t,this._radiusScale);return i.lowerRadiusLimit&&this._mode===r5.IgnoreBoundsSizeMode&&(r=r<i.lowerRadiusLimit?i.lowerRadiusLimit:r),i.upperRadiusLimit&&(r=r>i.upperRadiusLimit?i.upperRadiusLimit:r),r}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;let e=rW.F.Now-this._lastInteractionTime,t=.5*Math.PI-this._defaultElevation;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>.5*Math.PI&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=r_.fw.CreateAnimation("beta",r_.fw.ANIMATIONTYPE_FLOAT,60,r5.EasingFunction));let e=r_.fw.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});e&&this._animatables.push(e)}}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=rW.F.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return!!this._attachedCamera&&(0!==this._attachedCamera.inertialAlphaOffset||0!==this._attachedCamera.inertialBetaOffset||0!==this._attachedCamera.inertialRadiusOffset||0!==this._attachedCamera.inertialPanningX||0!==this._attachedCamera.inertialPanningY||this._isPointerDown)}}r5.EasingFunction=new rC,r5.EasingMode=rS.EASINGMODE_EASEINOUT,r5.IgnoreBoundsSizeMode=0,r5.FitFrustumSidesMode=1,i(96937);var r7=i(80783);i(98547),i(14814),i(84903),i(90224),i(53320);class r6{get maxAngle(){return this._maxAngle}set maxAngle(e){this._setMaxAngle(e)}constructor(e,t,i){this.targetPosition=i1.P.Zero(),this.poleTargetPosition=i1.P.Zero(),this.poleTargetLocalOffset=i1.P.Zero(),this.poleAngle=0,this.slerpAmount=1,this._bone1Quat=i1._f.Identity(),this._bone1Mat=i1.y3.Identity(),this._bone2Ang=Math.PI,this._maxAngle=Math.PI,this._rightHandedSystem=!1,this._bendAxis=i1.P.Right(),this._slerping=!1,this._adjustRoll=0,this._notEnoughInformation=!1,this._bone2=t;let r=t.getParent();if(!r){this._notEnoughInformation=!0,re.Y.Error("BoneIKController: bone must have a parent for IK to work.");return}if(this._bone1=r,0===this._bone2.children.length&&!this._bone2.length){this._notEnoughInformation=!0,re.Y.Error("BoneIKController: bone must not be a leaf or it should have a length for IK to work.");return}this.mesh=e,t.getSkeleton().computeAbsoluteMatrices();let s=t.getPosition();if(t.getAbsoluteMatrix().determinant()>0&&(this._rightHandedSystem=!0,this._bendAxis.x=0,this._bendAxis.y=0,this._bendAxis.z=-1,s.x>s.y&&s.x>s.z&&(this._adjustRoll=.5*Math.PI,this._bendAxis.z=1)),this._bone1.length&&this._bone2.length){let e=this._bone1.getScale(),t=this._bone2.getScale();this._bone1Length=this._bone1.length*e.y*this.mesh.scaling.y,this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y}else if(this._bone2.children[0]){e.computeWorldMatrix(!0);let t=this._bone2.children[0].getAbsolutePosition(e),i=this._bone2.getAbsolutePosition(e),r=this._bone1.getAbsolutePosition(e);this._bone2Length=i1.P.Distance(t,i),this._bone1Length=i1.P.Distance(i,r)}else{e.computeWorldMatrix(!0);let t=this._bone2.getScale();this._bone2Length=this._bone2.length*t.y*this.mesh.scaling.y;let i=this._bone2.getAbsolutePosition(e),r=this._bone1.getAbsolutePosition(e);this._bone1Length=i1.P.Distance(i,r)}this._bone1.getRotationMatrixToRef(1,e,this._bone1Mat),this.maxAngle=Math.PI,i&&(i.targetMesh&&(this.targetMesh=i.targetMesh,this.targetMesh.computeWorldMatrix(!0)),i.poleTargetMesh?(this.poleTargetMesh=i.poleTargetMesh,this.poleTargetMesh.computeWorldMatrix(!0)):i.poleTargetBone?this.poleTargetBone=i.poleTargetBone:this._bone1.getParent()&&(this.poleTargetBone=this._bone1.getParent()),i.poleTargetLocalOffset&&this.poleTargetLocalOffset.copyFrom(i.poleTargetLocalOffset),i.poleAngle&&(this.poleAngle=i.poleAngle),i.bendAxis&&this._bendAxis.copyFrom(i.bendAxis),i.maxAngle&&(this.maxAngle=i.maxAngle),i.slerpAmount&&(this.slerpAmount=i.slerpAmount))}_setMaxAngle(e){e<0&&(e=0),(e>Math.PI||void 0==e)&&(e=Math.PI),this._maxAngle=e;let t=this._bone1Length,i=this._bone2Length;this._maxReach=Math.sqrt(t*t+i*i-2*t*i*Math.cos(e))}update(){if(this._notEnoughInformation)return;let e=this.targetPosition,t=this.poleTargetPosition,i=r6._TmpMats[0],r=r6._TmpMats[1];this.targetMesh&&e.copyFrom(this.targetMesh.getAbsolutePosition()),this.poleTargetBone?this.poleTargetBone.getAbsolutePositionFromLocalToRef(this.poleTargetLocalOffset,this.mesh,t):this.poleTargetMesh&&i1.P.TransformCoordinatesToRef(this.poleTargetLocalOffset,this.poleTargetMesh.getWorldMatrix(),t);let s=r6._TmpVecs[0],n=r6._TmpVecs[1],a=r6._TmpVecs[2],o=r6._TmpVecs[3],l=r6._TmpVecs[4],c=r6._TmpQuat;this._bone1.getAbsolutePositionToRef(this.mesh,s),t.subtractToRef(s,l),0==l.x&&0==l.y&&0==l.z?l.y=1:l.normalize(),e.subtractToRef(s,o),o.normalize(),i1.P.CrossToRef(o,l,n),n.normalize(),i1.P.CrossToRef(o,n,a),a.normalize(),i1.y3.FromXYZAxesToRef(a,o,n,i);let u=this._bone1Length,h=this._bone2Length,d=i1.P.Distance(s,e);this._maxReach>0&&(d=Math.min(this._maxReach,d));let f=(h*h+d*d-u*u)/(2*h*d),p=(d*d+u*u-h*h)/(2*d*u);f>1&&(f=1),p>1&&(p=1),f<-1&&(f=-1),p<-1&&(p=-1);let m=Math.acos(p),_=-Math.acos(f)-m;if(this._rightHandedSystem)i1.y3.RotationYawPitchRollToRef(0,0,this._adjustRoll,r),r.multiplyToRef(i,i),i1.y3.RotationAxisToRef(this._bendAxis,m,r),r.multiplyToRef(i,i);else{let e=r6._TmpVecs[5];e.copyFrom(this._bendAxis),e.x*=-1,i1.y3.RotationAxisToRef(e,-m,r),r.multiplyToRef(i,i)}this.poleAngle&&(i1.y3.RotationAxisToRef(o,this.poleAngle,r),i.multiplyToRef(r,i)),this._bone1&&(this.slerpAmount<1?(this._slerping||i1._f.FromRotationMatrixToRef(this._bone1Mat,this._bone1Quat),i1._f.FromRotationMatrixToRef(i,c),i1._f.SlerpToRef(this._bone1Quat,c,this.slerpAmount,this._bone1Quat),_=this._bone2Ang*(1-this.slerpAmount)+_*this.slerpAmount,this._bone1.setRotationQuaternion(this._bone1Quat,1,this.mesh),this._slerping=!0):(this._bone1.setRotationMatrix(i,1,this.mesh),this._bone1Mat.copyFrom(i),this._slerping=!1),this._updateLinkedTransformRotation(this._bone1)),this._bone2.setAxisAngle(this._bendAxis,_,0),this._updateLinkedTransformRotation(this._bone2),this._bone2Ang=_}_updateLinkedTransformRotation(e){e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new i1._f),e.getRotationQuaternionToRef(0,null,e._linkedTransformNode.rotationQuaternion))}}r6._TmpVecs=[i1.P.Zero(),i1.P.Zero(),i1.P.Zero(),i1.P.Zero(),i1.P.Zero(),i1.P.Zero()],r6._TmpQuat=i1._f.Identity(),r6._TmpMats=[i1.y3.Identity(),i1.y3.Identity()];var r8=i(178),r9=i(50154);class se{get minYaw(){return this._minYaw}set minYaw(e){this._minYaw=e,this._minYawSin=Math.sin(e),this._minYawCos=Math.cos(e),null!=this._maxYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get maxYaw(){return this._maxYaw}set maxYaw(e){this._maxYaw=e,this._maxYawSin=Math.sin(e),this._maxYawCos=Math.cos(e),null!=this._minYaw&&(this._midYawConstraint=.5*this._getAngleDiff(this._minYaw,this._maxYaw)+this._minYaw,this._yawRange=this._maxYaw-this._minYaw)}get minPitch(){return this._minPitch}set minPitch(e){this._minPitch=e,this._minPitchTan=Math.tan(e)}get maxPitch(){return this._maxPitch}set maxPitch(e){this._maxPitch=e,this._maxPitchTan=Math.tan(e)}constructor(e,t,i,r){if(this.upAxis=i1.P.Up(),this.upAxisSpace=0,this.adjustYaw=0,this.adjustPitch=0,this.adjustRoll=0,this.slerpAmount=1,this._boneQuat=i1._f.Identity(),this._slerping=!1,this._firstFrameSkipped=!1,this._fowardAxis=i1.P.Forward(),this.useAbsoluteValueForYaw=!1,this.mesh=e,this.bone=t,this.target=i,r){if(r.adjustYaw&&(this.adjustYaw=r.adjustYaw),r.adjustPitch&&(this.adjustPitch=r.adjustPitch),r.adjustRoll&&(this.adjustRoll=r.adjustRoll),null!=r.maxYaw?this.maxYaw=r.maxYaw:this.maxYaw=Math.PI,null!=r.minYaw?this.minYaw=r.minYaw:this.minYaw=-Math.PI,null!=r.maxPitch?this.maxPitch=r.maxPitch:this.maxPitch=Math.PI,null!=r.minPitch?this.minPitch=r.minPitch:this.minPitch=-Math.PI,null!=r.slerpAmount&&(this.slerpAmount=r.slerpAmount),null!=r.upAxis&&(this.upAxis=r.upAxis),null!=r.upAxisSpace&&(this.upAxisSpace=r.upAxisSpace),null!=r.yawAxis||null!=r.pitchAxis){let e=r9.RD.Y,t=r9.RD.X;null!=r.yawAxis&&(e=r.yawAxis.clone()).normalize(),null!=r.pitchAxis&&(t=r.pitchAxis.clone()).normalize();let i=i1.P.Cross(t,e);this._transformYawPitch=i1.y3.Identity(),i1.y3.FromXYZAxesToRef(t,e,i,this._transformYawPitch),this._transformYawPitchInv=this._transformYawPitch.clone(),this._transformYawPitch.invert()}void 0!==r.useAbsoluteValueForYaw&&(this.useAbsoluteValueForYaw=r.useAbsoluteValueForYaw)}t.getParent()||2!=this.upAxisSpace||(this.upAxisSpace=0)}update(){if(this.slerpAmount<1&&!this._firstFrameSkipped){this._firstFrameSkipped=!0;return}let e=this.bone,t=se._TmpVecs[0];e.getAbsolutePositionToRef(this.mesh,t);let i=this.target,r=se._TmpMats[0],s=se._TmpMats[1],n=this.mesh,a=e.getParent(),o=se._TmpVecs[1];o.copyFrom(this.upAxis),2==this.upAxisSpace&&a?(this._transformYawPitch&&i1.P.TransformCoordinatesToRef(o,this._transformYawPitchInv,o),a.getDirectionToRef(o,this.mesh,o)):0==this.upAxisSpace&&(n.getDirectionToRef(o,o),(1!=n.scaling.x||1!=n.scaling.y||1!=n.scaling.z)&&o.normalize());let l=!1,c=!1;if((this._maxYaw!=Math.PI||this._minYaw!=-Math.PI)&&(l=!0),(this._maxPitch!=Math.PI||this._minPitch!=-Math.PI)&&(c=!0),l||c){let e=se._TmpMats[2],r=se._TmpMats[3];if(2==this.upAxisSpace&&1==o.y&&a)a.getRotationMatrixToRef(1,this.mesh,e);else if(0!=this.upAxisSpace||1!=o.y||a){let t=se._TmpVecs[2];t.copyFrom(this._fowardAxis),this._transformYawPitch&&i1.P.TransformCoordinatesToRef(t,this._transformYawPitchInv,t),a?a.getDirectionToRef(t,this.mesh,t):n.getDirectionToRef(t,t);let i=i1.P.Cross(o,t);i.normalize(),t=i1.P.Cross(i,o),i1.y3.FromXYZAxesToRef(i,o,t,e)}else e.copyFrom(n.getWorldMatrix());e.invertToRef(r);let s=null;if(c){let n=se._TmpVecs[3];i.subtractToRef(t,n),i1.P.TransformCoordinatesToRef(n,r,n),s=Math.sqrt(n.x*n.x+n.z*n.z);let a=Math.atan2(n.y,s),o=a;a>this._maxPitch?(n.y=this._maxPitchTan*s,o=this._maxPitch):a<this._minPitch&&(n.y=this._minPitchTan*s,o=this._minPitch),a!=o&&(i1.P.TransformCoordinatesToRef(n,e,n),n.addInPlace(t),i=n)}if(l){let n=se._TmpVecs[4];i.subtractToRef(t,n),i1.P.TransformCoordinatesToRef(n,r,n);let a=Math.atan2(n.x,n.z),o=this.useAbsoluteValueForYaw?Math.abs(a):a,l=a;if((o>this._maxYaw||o<this._minYaw)&&(null==s&&(s=Math.sqrt(n.x*n.x+n.z*n.z)),this._yawRange>Math.PI?this._isAngleBetween(a,this._maxYaw,this._midYawConstraint)?(n.z=this._maxYawCos*s,n.x=this._maxYawSin*s,l=this._maxYaw):this._isAngleBetween(a,this._midYawConstraint,this._minYaw)&&(n.z=this._minYawCos*s,n.x=this._minYawSin*s,l=this._minYaw):o>this._maxYaw?(n.z=this._maxYawCos*s,n.x=this._maxYawSin*s,a<0&&this.useAbsoluteValueForYaw&&(n.x*=-1),l=this._maxYaw):o<this._minYaw&&(n.z=this._minYawCos*s,n.x=this._minYawSin*s,a<0&&this.useAbsoluteValueForYaw&&(n.x*=-1),l=this._minYaw)),this._slerping&&this._yawRange>Math.PI){let e=se._TmpVecs[8];e.copyFrom(r9.RD.Z),this._transformYawPitch&&i1.P.TransformCoordinatesToRef(e,this._transformYawPitchInv,e);let t=se._TmpMats[4];this._boneQuat.toRotationMatrix(t),this.mesh.getWorldMatrix().multiplyToRef(t,t),i1.P.TransformCoordinatesToRef(e,t,e),i1.P.TransformCoordinatesToRef(e,r,e);let i=Math.atan2(e.x,e.z);if(this._getAngleBetween(i,a)>this._getAngleBetween(i,this._midYawConstraint)){null==s&&(s=Math.sqrt(n.x*n.x+n.z*n.z));let e=this._getAngleBetween(i,this._maxYaw);l=this._getAngleBetween(i,this._minYaw)<e?i+.75*Math.PI:i-.75*Math.PI,n.z=Math.cos(l)*s,n.x=Math.sin(l)*s}}a!=l&&(i1.P.TransformCoordinatesToRef(n,e,n),n.addInPlace(t),i=n)}}let u=se._TmpVecs[5],h=se._TmpVecs[6],d=se._TmpVecs[7],f=se._TmpQuat,p=se._TmpVecs[9];i.subtractToRef(t,u),u.normalize(),i1.P.CrossToRef(o,u,h),h.normalize(),i1.P.CrossToRef(u,h,d),d.normalize(),i1.y3.FromXYZAxesToRef(h,d,u,r),(0!==h.x||0!==h.y||0!==h.z)&&(0!==d.x||0!==d.y||0!==d.z)&&(0!==u.x||0!==u.y||0!==u.z)&&((this.adjustYaw||this.adjustPitch||this.adjustRoll)&&(i1.y3.RotationYawPitchRollToRef(this.adjustYaw,this.adjustPitch,this.adjustRoll,s),s.multiplyToRef(r,r)),p.copyFrom(this.bone.getScale()),this.slerpAmount<1?(this._slerping||this.bone.getRotationQuaternionToRef(1,this.mesh,this._boneQuat),this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),i1._f.FromRotationMatrixToRef(r,f),i1._f.SlerpToRef(this._boneQuat,f,this.slerpAmount,this._boneQuat),this.bone.setRotationQuaternion(this._boneQuat,1,this.mesh),this._slerping=!0):(this._transformYawPitch&&this._transformYawPitch.multiplyToRef(r,r),this.bone.setRotationMatrix(r,1,this.mesh),this._slerping=!1),this.bone.setScale(p),this._updateLinkedTransformRotation())}_getAngleDiff(e,t){let i=t-e;return(i%=2*Math.PI)>Math.PI?i-=2*Math.PI:i<-Math.PI&&(i+=2*Math.PI),i}_getAngleBetween(e,t){e%=2*Math.PI,e=e<0?e+2*Math.PI:e,t%=2*Math.PI;let i=0;return(i=e<(t=t<0?t+2*Math.PI:t)?t-e:e-t)>Math.PI&&(i=2*Math.PI-i),i}_isAngleBetween(e,t,i){if(e%=2*Math.PI,e=e<0?e+2*Math.PI:e,t%=2*Math.PI,t=t<0?t+2*Math.PI:t,i%=2*Math.PI,t<(i=i<0?i+2*Math.PI:i)){if(e>t&&e<i)return!0}else if(e>i&&e<t)return!0;return!1}_updateLinkedTransformRotation(){let e=this.bone;e._linkedTransformNode&&(e._linkedTransformNode.rotationQuaternion||(e._linkedTransformNode.rotationQuaternion=new i1._f),e.getRotationQuaternionToRef(0,null,e._linkedTransformNode.rotationQuaternion))}}se._TmpVecs=(0,r8.$G)(10,i1.P.Zero),se._TmpQuat=i1._f.Identity(),se._TmpMats=(0,r8.$G)(5,i1.y3.Identity);var st=i(93954);i(94677);var si=i(17909),sr=i(91867);let ss=(()=>{let e=new Uint8Array(4);return!!((new Uint32Array(e.buffer)[0]=1)&e[0])})();Object.defineProperty(st.o.prototype,"effectiveByteStride",{get:function(){return this._alignedBuffer&&this._alignedBuffer.byteStride||this.byteStride},enumerable:!0,configurable:!0}),Object.defineProperty(st.o.prototype,"effectiveByteOffset",{get:function(){return this._alignedBuffer?0:this.byteOffset},enumerable:!0,configurable:!0}),Object.defineProperty(st.o.prototype,"effectiveBuffer",{get:function(){return this._alignedBuffer&&this._alignedBuffer.getBuffer()||this._buffer.getBuffer()},enumerable:!0,configurable:!0}),st.o.prototype._rebuild=function(){this._buffer?._rebuild(),this._alignedBuffer?._rebuild()},st.o.prototype.dispose=function(){this._ownsBuffer&&this._buffer.dispose(),this._alignedBuffer?.dispose(),this._alignedBuffer=void 0,this._isDisposed=!0},st.o.prototype.getWrapperBuffer=function(){return this._alignedBuffer||this._buffer},st.o.prototype._alignBuffer=function(){let e,t;let i=this._buffer.getData();if(!this.engine._features.forceVertexBufferStrideAndOffsetMultiple4Bytes||this.byteStride%4==0&&this.byteOffset%4==0||!i)return;let r=st.o.GetTypeByteLength(this.type),s=this.byteStride+3&-4,n=s/r,a=this._maxVerticesCount,o=a*s/r;if(Array.isArray(i)){let t=new Float32Array(i);e=new DataView(t.buffer,t.byteOffset,t.byteLength)}else e=i instanceof ArrayBuffer?new DataView(i,0,i.byteLength):new DataView(i.buffer,i.byteOffset,i.byteLength);t=this.type===st.o.BYTE?new Int8Array(o):this.type===st.o.UNSIGNED_BYTE?new Uint8Array(o):this.type===st.o.SHORT?new Int16Array(o):this.type===st.o.UNSIGNED_SHORT?new Uint16Array(o):this.type===st.o.INT?new Int32Array(o):this.type===st.o.UNSIGNED_INT?new Uint32Array(o):new Float32Array(o);let l=this.getSize(),c=this.byteOffset;for(let i=0;i<a;++i){for(let r=0;r<l;++r)switch(this.type){case st.o.BYTE:t[i*n+r]=e.getInt8(c+r);break;case st.o.UNSIGNED_BYTE:t[i*n+r]=e.getUint8(c+r);break;case st.o.SHORT:t[i*n+r]=e.getInt16(c+2*r,ss);break;case st.o.UNSIGNED_SHORT:t[i*n+r]=e.getUint16(c+2*r,ss);break;case st.o.INT:t[i*n+r]=e.getInt32(c+4*r,ss);break;case st.o.UNSIGNED_INT:t[i*n+r]=e.getUint32(c+4*r,ss);break;case st.o.FLOAT:t[i*n+r]=e.getFloat32(c+4*r,ss)}c+=this.byteStride}this._alignedBuffer?.dispose(),this._alignedBuffer=new st.l(this.engine,t,!1,s,!1,this.getIsInstanced(),!0,this.instanceDivisor,(this._label??"VertexBuffer")+"_aligned")},i(98038);var sn=i(9521);i(35558),i(98934),i(55364),i(30103);var sa=i(94656),so=i(87431);so.$.prototype.addVRDeviceOrientation=function(){return this.add(new sl),this};class sl{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=e=>this._onOrientationEvent(e)}attachControl(e){e=rD.w1.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);let t=this.camera.getScene().getEngine().getHostWindow();t&&("undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"===e?t.addEventListener("deviceorientation",this._deviceOrientationHandler):rD.w1.Warn("Permission not granted.")}).catch(e=>{rD.w1.Error(e)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){null!==e.alpha&&(this._alpha=(0|+e.alpha)*this.alphaCorrection),null!==e.gamma&&(this._gamma=(0|+e.gamma)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}sa.u.ArcRotateCameraVRDeviceOrientationInput=sl;var sc=i(22710);class su{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=[]}attachControl(e){e=rD.w1.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(t.type===sc.OG.KEYDOWN)-1===this.keysForward.indexOf(i.keyCode)&&-1===this.keysBackward.indexOf(i.keyCode)&&-1===this.keysUp.indexOf(i.keyCode)&&-1===this.keysDown.indexOf(i.keyCode)&&-1===this.keysLeft.indexOf(i.keyCode)&&-1===this.keysRight.indexOf(i.keyCode)||(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),e||i.preventDefault());else if(-1!==this.keysForward.indexOf(i.keyCode)||-1!==this.keysBackward.indexOf(i.keyCode)||-1!==this.keysUp.indexOf(i.keyCode)||-1!==this.keysDown.indexOf(i.keyCode)||-1!==this.keysLeft.indexOf(i.keyCode)||-1!==this.keysRight.indexOf(i.keyCode)){let t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){let e=this.camera;for(let t=0;t<this._keys.length;t++){let i=this._keys[t],r=e._computeLocalCameraSpeed();-1!==this.keysForward.indexOf(i)?e._localDirection.copyFromFloats(0,0,r):-1!==this.keysBackward.indexOf(i)?e._localDirection.copyFromFloats(0,0,-r):-1!==this.keysUp.indexOf(i)?e._localDirection.copyFromFloats(0,r,0):-1!==this.keysDown.indexOf(i)?e._localDirection.copyFromFloats(0,-r,0):-1!==this.keysRight.indexOf(i)?e._localDirection.copyFromFloats(r,0,0):-1!==this.keysLeft.indexOf(i)&&e._localDirection.copyFromFloats(-r,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),i1.P.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}(0,r$.gn)([(0,rj.qC)()],su.prototype,"keysForward",void 0),(0,r$.gn)([(0,rj.qC)()],su.prototype,"keysBackward",void 0),(0,r$.gn)([(0,rj.qC)()],su.prototype,"keysUp",void 0),(0,r$.gn)([(0,rj.qC)()],su.prototype,"keysDown",void 0),(0,r$.gn)([(0,rj.qC)()],su.prototype,"keysRight",void 0),(0,r$.gn)([(0,rj.qC)()],su.prototype,"keysLeft",void 0),sa.u.FlyCameraKeyboardInput=su;class sh{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=rD.w1.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(e=>{this._pointerInput(e)},r1.kD.POINTERDOWN|r1.kD.POINTERUP|r1.kD.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)})}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){let t=e.event,i=this.camera.getEngine();if(!this.touchEnabled&&"touch"===t.pointerType||e.type!==r1.kD.POINTERMOVE&&-1===this.buttons.indexOf(t.button))return;let r=t.target;if(e.type===r1.kD.POINTERDOWN){try{r?.setPointerCapture(t.pointerId)}catch(e){}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||t.preventDefault(),i.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===r1.kD.POINTERUP){try{r?.releasePointerCapture(t.pointerId)}catch(e){}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===r1.kD.POINTERMOVE){if(!this._previousPosition){i.isPointerLock&&this._onMouseMove(e.event);return}let r=t.clientX-this._previousPosition.x,s=t.clientY-this._previousPosition.y;this._rotateCamera(r,s),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){if(!this.camera.getEngine().isPointerLock)return;let t=e.movementX,i=e.movementY;this._rotateCamera(t,i),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){let i;let r=this.camera,s=r._calculateHandednessMultiplier(),n=(e*=s)/this.angularSensibility,a=t/this.angularSensibility,o=i1._f.RotationYawPitchRoll(r.rotation.y,r.rotation.x,r.rotation.z);if(this.buttonsPitch.some(e=>e===this.activeButton)&&(i=i1._f.RotationAxis(r9.RD.X,a),o.multiplyInPlace(i)),this.buttonsYaw.some(e=>e===this.activeButton)){i=i1._f.RotationAxis(r9.RD.Y,n),o.multiplyInPlace(i);let e=r.bankedTurnLimit+r._trackRoll;if(r.bankedTurn&&-e<r.rotation.z&&r.rotation.z<e){let e=-(r.bankedTurnMultiplier*n);i=i1._f.RotationAxis(r9.RD.Z,e),o.multiplyInPlace(i)}}this.buttonsRoll.some(e=>e===this.activeButton)&&(i=i1._f.RotationAxis(r9.RD.Z,-n),r._trackRoll-=n,o.multiplyInPlace(i)),o.toEulerAnglesToRef(r.rotation)}}(0,r$.gn)([(0,rj.qC)()],sh.prototype,"buttons",void 0),(0,r$.gn)([(0,rj.qC)()],sh.prototype,"angularSensibility",void 0),sa.u.FlyCameraMouseInput=sh;class sd{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=[]}attachControl(e){e=rD.w1.BackCompatCameraNoPreventDefault(arguments),this._onCanvasBlurObserver||(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{let i=t.event;if(!i.metaKey){if(t.type===sc.OG.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode))&&(-1===this._keys.indexOf(i.keyCode)&&this._keys.push(i.keyCode),i.preventDefault&&!e&&i.preventDefault());else if(-1!==this.keysHeightOffsetIncr.indexOf(i.keyCode)||-1!==this.keysHeightOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetIncr.indexOf(i.keyCode)||-1!==this.keysRotationOffsetDecr.indexOf(i.keyCode)||-1!==this.keysRadiusIncr.indexOf(i.keyCode)||-1!==this.keysRadiusDecr.indexOf(i.keyCode)){let t=this._keys.indexOf(i.keyCode);t>=0&&this._keys.splice(t,1),i.preventDefault&&!e&&i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach(e=>{-1!==this.keysHeightOffsetIncr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:-1!==this.keysHeightOffsetDecr.indexOf(e)&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:-1!==this.keysRotationOffsetIncr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRotationOffsetDecr.indexOf(e)&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):-1!==this.keysRadiusIncr.indexOf(e)&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:-1!==this.keysRadiusDecr.indexOf(e)&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)})}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysHeightOffsetIncr",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysHeightOffsetDecr",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysHeightOffsetModifierAlt",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysHeightOffsetModifierCtrl",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysHeightOffsetModifierShift",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRotationOffsetIncr",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRotationOffsetDecr",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRotationOffsetModifierAlt",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRotationOffsetModifierCtrl",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRotationOffsetModifierShift",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRadiusIncr",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRadiusDecr",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRadiusModifierAlt",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRadiusModifierCtrl",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"keysRadiusModifierShift",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"heightSensibility",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"rotationSensibility",void 0),(0,r$.gn)([(0,rj.qC)()],sd.prototype,"radiusSensibility",void 0),sa.u.FollowCameraKeyboardMoveInput=sd;class sf{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=rD.w1.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==r1.kD.POINTERWHEEL)return;let i=t.event,r=0,s=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(+this.axisControlRadius+ +this.axisControlHeight+ +this.axisControlRotation&&re.Y.Warn("wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?r=.01*s*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?r=.01*s*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(r=.01*s*this.wheelDeltaPercentage*this.camera.rotationOffset)):r=s*this.wheelPrecision,r&&(this.axisControlRadius?this.camera.radius+=r:this.axisControlHeight?this.camera.heightOffset-=r:this.axisControlRotation&&(this.camera.rotationOffset-=r)),i.preventDefault&&!e&&i.preventDefault()},this._observer=this.camera.getScene()._inputManager._addCameraPointerObserver(this._wheel,r1.kD.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene()._inputManager._removeCameraPointerObserver(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}(0,r$.gn)([(0,rj.qC)()],sf.prototype,"axisControlRadius",void 0),(0,r$.gn)([(0,rj.qC)()],sf.prototype,"axisControlHeight",void 0),(0,r$.gn)([(0,rj.qC)()],sf.prototype,"axisControlRotation",void 0),(0,r$.gn)([(0,rj.qC)()],sf.prototype,"wheelPrecision",void 0),(0,r$.gn)([(0,rj.qC)()],sf.prototype,"wheelDeltaPercentage",void 0),sa.u.FollowCameraMouseWheelInput=sf;class sp extends sn.O{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,r,s,n){if(0===i&&null===s||0===r&&null===n)return;let a=(r-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(a*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=a*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=a*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=a*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=a),this.axisPinchControlHeight&&(this.camera.heightOffset+=a),this.axisPinchControlRadius&&(this.camera.radius-=a))}_warning(){if(!this.warningEnable||this._warningCounter++%100!=0)return;let e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";+this.axisXControlRotation+ +this.axisXControlHeight+ +this.axisXControlRadius<=1&&re.Y.Warn(e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),+this.axisYControlRotation+ +this.axisYControlHeight+ +this.axisYControlRadius<=1&&re.Y.Warn(e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),+this.axisPinchControlRotation+ +this.axisPinchControlHeight+ +this.axisPinchControlRadius<=1&&re.Y.Warn(e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}(0,r$.gn)([(0,rj.qC)()],sp.prototype,"angularSensibilityX",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"angularSensibilityY",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"pinchPrecision",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"pinchDeltaPercentage",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisXControlRadius",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisXControlHeight",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisXControlRotation",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisYControlRadius",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisYControlHeight",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisYControlRotation",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisPinchControlRadius",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisPinchControlHeight",void 0),(0,r$.gn)([(0,rj.qC)()],sp.prototype,"axisPinchControlRotation",void 0),sa.u.FollowCameraPointersInput=sp;var sm=i(7603);sm.a.prototype.addDeviceOrientation=function(e){return this._deviceOrientationInput||(this._deviceOrientationInput=new s_,e&&(this._deviceOrientationInput.smoothFactor=e),this.add(this._deviceOrientationInput)),this};class s_{static WaitForOrientationChangeAsync(e){return new Promise((t,i)=>{let r=!1,s=()=>{window.removeEventListener("deviceorientation",s),r=!0,t()};e&&setTimeout(()=>{r||(window.removeEventListener("deviceorientation",s),i("WaitForOrientationChangeAsync timed out"))},e),"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"==e?window.addEventListener("deviceorientation",s):rD.w1.Warn("Permission not granted.")}).catch(e=>{rD.w1.Error(e)}):window.addEventListener("deviceorientation",s)})}constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new i1._f,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new i0.y$,this._orientationChanged=()=>{this._screenOrientationAngle=void 0!==window.orientation?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-rD.w1.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=null!==e.alpha?rD.w1.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=null!==e.beta?rD.w1.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=null!==e.gamma?rD.w1.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=null!==e.alpha?e.alpha:0,this._beta=null!==e.beta?e.beta:0,this._gamma=null!==e.gamma?e.gamma:0),null!==e.alpha&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTransform=new i1._f(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}get camera(){return this._camera}set camera(e){this._camera=e,null==this._camera||this._camera.rotationQuaternion||(this._camera.rotationQuaternion=new i1._f),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){let e=this.camera.getScene().getEngine().getHostWindow();if(e){let t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"===e?t():rD.w1.Warn("Permission not granted.")}).catch(e=>{rD.w1.Error(e)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){this._alpha&&(i1._f.RotationYawPitchRollToRef(rD.w1.ToRadians(this._alpha),rD.w1.ToRadians(this._beta),-rD.w1.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTransform),this._camera.getScene().useRightHandedSystem?this._camera.rotationQuaternion.y*=-1:this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}sa.u.FreeCameraDeviceOrientationInput=s_,i(57982),i(32067),i(42523),i(46611),i(84374);var sg=i(87676);(n=tt||(tt={}))[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z";class sv{static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}constructor(e,t){this._released=!1;let i={...sv._GetDefaultOptions(),...t};if(e?this._leftJoystick=!0:this._leftJoystick=!1,sv._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=0,this._axisTargetedByUpAndDown=1,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new sg.x,this.deltaPosition=i1.P.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{sv._VJCanvasWidth=window.innerWidth,sv._VJCanvasHeight=window.innerHeight,sv.Canvas&&(sv.Canvas.width=sv._VJCanvasWidth,sv.Canvas.height=sv._VJCanvasHeight),sv._HalfWidth=sv._VJCanvasWidth/2},!sv.Canvas){window.addEventListener("resize",this._onResize,!1),sv.Canvas=document.createElement("canvas"),sv._VJCanvasWidth=window.innerWidth,sv._VJCanvasHeight=window.innerHeight,sv.Canvas.width=window.innerWidth,sv.Canvas.height=window.innerHeight,sv.Canvas.style.width="100%",sv.Canvas.style.height="100%",sv.Canvas.style.position="absolute",sv.Canvas.style.backgroundColor="transparent",sv.Canvas.style.top="0px",sv.Canvas.style.left="0px",sv.Canvas.style.zIndex="5",sv.Canvas.style.touchAction="none",sv.Canvas.setAttribute("touch-action","none");let e=sv.Canvas.getContext("2d");if(!e)throw Error("Unable to create canvas for virtual joystick");sv._VJCanvasContext=e,sv._VJCanvasContext.strokeStyle="#ffffff",sv._VJCanvasContext.lineWidth=2,document.body.appendChild(sv.Canvas)}sv._HalfWidth=sv.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&sv._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new i1.FM(0,0),this._joystickPreviousPointerPos=new i1.FM(0,0),this._joystickPointerStartPos=new i1.FM(0,0),this._deltaJoystickVector=new i1.FM(0,0),this._onPointerDownHandlerRef=e=>{this._onPointerDown(e)},this._onPointerMoveHandlerRef=e=>{this._onPointerMove(e)},this._onPointerUpHandlerRef=e=>{this._onPointerUp(e)},sv.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),sv.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),sv.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),sv.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),sv.Canvas.addEventListener("contextmenu",e=>{e.preventDefault()},!1),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){e.preventDefault(),(!0===this._leftJoystick?e.clientX<sv._HalfWidth:e.clientX>sv._HalfWidth)&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):sv._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){let t=new i1.FM(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),i=t.length();i>this.containerSize&&t.scaleInPlace(this.containerSize/i),this._joystickPointerPos.x=this._joystickPointerStartPos.x+t.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+t.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<sv._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(sv._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(sv._HalfWidth,this._joystickPointerPos.x));let t=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,t));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,t));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,t))}let i=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case 0:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case 1:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case 2:this.deltaPosition.z=Math.min(1,Math.max(-1,i))}}else{let t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{let t=this._touches.get(e.pointerId.toString());t&&sv._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(2.1*this._joystickContainerSize),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(2.1*this._joystickPuckSize),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(sv._AlwaysVisibleSticks++,this._alwaysVisible=!0):(sv._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new i1.FM(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case 0:case 1:case 2:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=0}}setAxisForUpDown(e){switch(e){case 0:case 1:case 2:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=1}}_clearPreviousDraw(){let e=this._joystickPosition||this._joystickPointerStartPos;sv._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),sv._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset-1,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset-1,this._clearPuckSize+2,this._clearPuckSize+2)}setContainerImage(e){let t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){let t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){let e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?sv._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,2*this.containerSize,2*this.containerSize):(sv._VJCanvasContext.beginPath(),sv._VJCanvasContext.strokeStyle=this._joystickColor,sv._VJCanvasContext.lineWidth=2,sv._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,2*Math.PI,!0),sv._VJCanvasContext.stroke(),sv._VJCanvasContext.closePath(),sv._VJCanvasContext.beginPath(),sv._VJCanvasContext.lineWidth=6,sv._VJCanvasContext.strokeStyle=this._joystickColor,sv._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,2*Math.PI,!0),sv._VJCanvasContext.stroke(),sv._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?sv._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,2*this.puckSize,2*this.puckSize):(sv._VJCanvasContext.beginPath(),sv._VJCanvasContext.strokeStyle=this._joystickColor,sv._VJCanvasContext.lineWidth=2,sv._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,2*Math.PI,!0),sv._VJCanvasContext.stroke(),sv._VJCanvasContext.closePath())}_drawVirtualJoystick(){this._released||(this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(sv._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),sv._VJCanvasContext.beginPath(),sv._VJCanvasContext.fillStyle="white",sv._VJCanvasContext.beginPath(),sv._VJCanvasContext.strokeStyle="red",sv._VJCanvasContext.lineWidth=6,sv._VJCanvasContext.arc(t.x,t.y,40,0,2*Math.PI,!0),sv._VJCanvasContext.stroke(),sv._VJCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)}),requestAnimationFrame(()=>{this._drawVirtualJoystick()}))}releaseCanvas(){sv.Canvas&&(sv.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),sv.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),sv.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),sv.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(sv.Canvas),sv.Canvas=null),this._released=!0}}sv._GlobalJoystickIndex=0,sv._AlwaysVisibleSticks=0,sm.a.prototype.addVirtualJoystick=function(){return this.add(new sS),this};class sS{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){let e=this.camera,t=50*e._computeLocalCameraSpeed(),i=i1.y3.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),r=i1.P.TransformCoordinates(new i1.P(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(r),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new sv(!0),this._leftjoystick.setAxisForUpDown(2),this._leftjoystick.setAxisForLeftRight(0),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new sv(!1),this._rightjoystick.setAxisForUpDown(0),this._rightjoystick.setAxisForLeftRight(1),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}sa.u.FreeCameraVirtualJoystickInput=sS;var sx=i(91420),sE=i(16606);i(45637);var sC=i(67020);sC.N.AddNodeConstructor("ArcRotateCamera",(e,t)=>()=>new sT(e,0,0,1,i1.P.Zero(),t));class sT extends sx.C{get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new i1.y3,this._upToYMatrix=new i1.y3,this._upVector=i1.P.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){i1.y3.RotationAlignToRef(i1.P.UpReadOnly,this._upVector,this._yToUpMatrix),i1.y3.RotationAlignToRef(this._upVector,i1.P.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){let e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){let t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){let e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){let t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){let e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){let t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){let e=this.inputs.attached.pointers;return!!e&&e.useNaturalPinchZoom}set useNaturalPinchZoom(e){let t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){let e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){let t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){let e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){let e=this.inputs.attached.mousewheel;return!!e&&e.zoomToMouseLocation}set zoomToMouseLocation(e){let t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){let e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){let t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return null!=this._bouncingBehavior}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new r4,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return null!=this._framingBehavior}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new r5,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return null!=this._autoRotationBehavior}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new r3,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}constructor(e,t,i,r,s,n,a=!0){super(e,i1.P.Zero(),n,a),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=i1.P.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=i1.FM.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this.restoreStateInterpolationFactor=0,this._viewMatrix=new i1.y3,this.panningAxis=new i1.P(1,1,0),this._transformedDirection=new i1.P,this.mapPanning=!1,this._progressiveRestore=!1,this.onMeshTargetChangedObservable=new i0.y$,this.checkCollisions=!1,this.collisionRadius=new i1.P(.5,.5,.5),this._previousPosition=i1.P.Zero(),this._collisionVelocity=i1.P.Zero(),this._newPosition=i1.P.Zero(),this._computationVector=i1.P.Zero(),this._onCollisionPositionChange=(e,t,i=null)=>{i?(this.setPosition(t),this.onCollide&&this.onCollide(i)):this._previousPosition.copyFrom(this._position);let r=Math.cos(this.alpha),s=Math.sin(this.alpha),n=Math.cos(this.beta),a=Math.sin(this.beta);0===a&&(a=1e-4);let o=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*r*a,this.radius*n,this.radius*s*a),o.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let l=this.upVector;this.allowUpsideDown&&this.beta<0&&(l=(l=l.clone()).negate()),this._computeViewMatrix(this._position,o,l),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=i1.P.Zero(),s&&this.setTarget(s),this.alpha=t,this.beta=i,this.radius=r,this.getViewMatrix(),this.inputs=new so.$(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_initCache(){super._initCache(),this._cache._target=new i1.P(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=i1.FM.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){let e=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?e.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(e)}return this._getLockedTargetPosition()||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return this.hasStateStored()&&this.restoreStateInterpolationFactor>r2.kn&&this.restoreStateInterpolationFactor<1?(this._progressiveRestore=!0,this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!!super._restoreStateValues()&&(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0)}_isSynchronizedViewMatrix(){return!!super._isSynchronizedViewMatrix()&&this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset)}attachControl(e,t,i=!0,r=2){let s=arguments;t=rD.w1.BackCompatCameraNoPreventDefault(s),this._useCtrlForPanning=i,this._panningMouseButton=r,"boolean"==typeof s[0]&&(s.length>1&&(this._useCtrlForPanning=s[1]),s.length>2&&(this._panningMouseButton=s[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this._progressiveRestore){let e=1-Math.pow(2,-(this._scene.getEngine().getDeltaTime()/1e3)/this.restoreStateInterpolationFactor);this.setTarget(i1.P.Lerp(this.getTarget(),this._storedTarget,e)),i1._f.RotationAlphaBetaGammaToRef(this._storedAlpha,this._storedBeta,0,i1.jp.Quaternion[0]),i1._f.RotationAlphaBetaGammaToRef(this.alpha,this.beta,0,i1.jp.Quaternion[1]),i1._f.SlerpToRef(i1.jp.Quaternion[1],i1.jp.Quaternion[0],e,i1.jp.Quaternion[2]),i1.jp.Quaternion[2].normalize(),i1.jp.Quaternion[2].toAlphaBetaGammaToRef(i1.jp.Vector3[0]),this.alpha=i1.jp.Vector3[0].x,this.beta=i1.jp.Vector3[0].y,this.radius+=(this._storedRadius-this.radius)*e,i1.FM.LerpToRef(this.targetScreenOffset,this._storedTargetScreenOffset,e,this.targetScreenOffset),(i1.P.DistanceSquared(this.getTarget(),this._storedTarget)<r2.kn&&i1.jp.Quaternion[2].equalsWithEpsilon(i1.jp.Quaternion[0])&&Math.pow(this._storedRadius-this.radius,2)<r2.kn&&i1.FM.Distance(this.targetScreenOffset,this._storedTargetScreenOffset)<r2.kn||0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset||0!==this.inertialPanningX||0!==this.inertialPanningY)&&(this._progressiveRestore=!1)}if(0!==this.inertialAlphaOffset||0!==this.inertialBetaOffset||0!==this.inertialRadiusOffset){let e=this.invertRotation?-1:1,t=this._calculateHandednessMultiplier(),i=this.inertialAlphaOffset*t;this.beta<0&&(i*=-1),this.alpha+=i*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<r2.kn&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<r2.kn&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*r2.kn&&(this.inertialRadiusOffset=0)}if(0!==this.inertialPanningX||0!==this.inertialPanningY){let e=new i1.P(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);if(this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),i1.P.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),this.mapPanning){let e=this.upVector,t=i1.P.CrossToRef(this._transformedDirection,e,this._transformedDirection);i1.P.CrossToRef(e,t,this._transformedDirection)}else this.panningAxis.y||(this._transformedDirection.y=0);if(!this._targetHost){if(this.panningDistanceLimit)this._transformedDirection.addInPlace(this._target),i1.P.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection);else{if(this.parent){let e=i1.jp.Matrix[0];this.parent.getWorldMatrix().getRotationMatrixToRef(e),e.transposeToRef(e),i1.P.TransformCoordinatesToRef(this._transformedDirection,e,this._transformedDirection)}this._target.addInPlace(this._transformedDirection)}}this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*r2.kn&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*r2.kn&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){null===this.lowerBetaLimit||void 0===this.lowerBetaLimit?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),null===this.upperBetaLimit||void 0===this.upperBetaLimit?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),null!==this.lowerAlphaLimit&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),null!==this.upperAlphaLimit&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(0!==this._upVector.x||1!==this._upVector.y||0!==this._upVector.z)&&i1.P.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),0===this.radius&&(this.radius=1e-4);let e=this.alpha;0===this._computationVector.x&&0===this._computationVector.z?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);let t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=2*t*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,r=!1){if(r=this.overrideCloneAlphaBetaRadius??r,e.computeWorldMatrix)t&&e.getBoundingInfo?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{let t=this._getTargetPosition();if(t&&!i&&t.equals(e))return;this._targetHost=null,this._target=e,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}r||this.rebuildAnglesAndRadius()}_getViewMatrix(){let e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta),r=Math.sin(this.beta);0===r&&(r=1e-4),0===this.radius&&(this.radius=1e-4);let s=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*r,this.radius*i,this.radius*t*r),(0!==this._upVector.x||1!==this._upVector.y||0!==this._upVector.z)&&i1.P.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),s.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){let e=this.getScene().collisionCoordinator;this._collider||(this._collider=e.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,e.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let e=this.upVector;this.allowUpsideDown&&r<0&&(e=e.negate()),this._computeViewMatrix(this._position,s,e),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=s,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;let i=rP.Kj.MinMax(e),r=this._calculateLowerRadiusFromModelBoundingSphere(i.min,i.max);r=Math.max(Math.min(r,this.upperRadiusLimit||Number.MAX_VALUE),this.lowerRadiusLimit||0),this.radius=r*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:r},t)}focusOn(e,t=!1){let i,r;if(void 0===e.min){let t=e||this.getScene().meshes;i=rP.Kj.MinMax(t),r=i1.P.Distance(i.min,i.max)}else i=e,r=e.distance;this._target=rP.Kj.Center(i),t||(this.maxZ=2*r)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case rO.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case rO.V.RIG_MODE_STEREOSCOPIC_OVERUNDER:case rO.V.RIG_MODE_STEREOSCOPIC_INTERLACED:case rO.V.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(0===t?1:-1);break;case rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(0===t?-1:1)}let r=new sT(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return r._cameraRigParams={},r.isRigCamera=!0,r.rigParent=this,r.upVector=this.upVector,r.mode=this.mode,r.orthoLeft=this.orthoLeft,r.orthoRight=this.orthoRight,r.orthoBottom=this.orthoBottom,r.orthoTop=this.orthoTop,r}_updateRigCameras(){let e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case rO.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case rO.V.RIG_MODE_STEREOSCOPIC_OVERUNDER:case rO.V.RIG_MODE_STEREOSCOPIC_INTERLACED:case rO.V.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle}super._updateRigCameras()}_calculateLowerRadiusFromModelBoundingSphere(e,t,i=1){let r=i1.P.Distance(e,t),s=this.getScene().getEngine().getAspectRatio(this),n=Math.tan(this.fov/2),a=n*s,o=.5*r*i;return Math.max(o*Math.sqrt(1+1/(a*a)),o*Math.sqrt(1+1/(n*n)))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}(0,r$.gn)([(0,rj.qC)()],sT.prototype,"alpha",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"beta",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"radius",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"overrideCloneAlphaBetaRadius",void 0),(0,r$.gn)([(0,rj.hd)("target")],sT.prototype,"_target",void 0),(0,r$.gn)([(0,rj.RR)("targetHost")],sT.prototype,"_targetHost",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"inertialAlphaOffset",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"inertialBetaOffset",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"inertialRadiusOffset",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"lowerAlphaLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"upperAlphaLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"lowerBetaLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"upperBetaLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"lowerRadiusLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"upperRadiusLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"inertialPanningX",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"inertialPanningY",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"pinchToPanMaxDistance",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"panningDistanceLimit",void 0),(0,r$.gn)([(0,rj.hd)()],sT.prototype,"panningOriginTarget",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"panningInertia",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"zoomToMouseLocation",null),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"zoomOnFactor",void 0),(0,r$.gn)([(0,rj.QC)()],sT.prototype,"targetScreenOffset",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"allowUpsideDown",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"useInputToRestoreState",void 0),(0,r$.gn)([(0,rj.qC)()],sT.prototype,"restoreStateInterpolationFactor",void 0),(0,i3.H7)("BABYLON.ArcRotateCamera",sT),sC.N.AddNodeConstructor("DeviceOrientationCamera",(e,t)=>()=>new sb(e,i1.P.Zero(),t));class sb extends sE.c{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new i1._f,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new i1._f,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(e=>{0!=this._dragFactor&&(this._initialQuaternion||(this._initialQuaternion=new i1._f),i1._f.FromEulerAnglesToRef(0,e.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=r9.RD.Y){this.rotationQuaternion&&(this._initialQuaternion||(this._initialQuaternion=new i1._f),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class sy extends sa.p{constructor(e){super(e)}addKeyboard(){return this.add(new su),this}addMouse(){return this.add(new sh),this}}class sI extends sx.C{get angularSensibility(){let e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){let t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){let e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){let t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){let e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){let t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){let e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){let t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){let e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){let t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){let e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){let t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){let e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){let t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}constructor(e,t,i,r=!0){super(e,t,i,r),this.ellipsoid=new i1.P(1,1,1),this.ellipsoidOffset=new i1.P(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=i1.P.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=i1.P.Zero(),this._diffPosition=i1.P.Zero(),this._newPosition=i1.P.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(e,t,i=null)=>{(e=>{this._newPosition.copyFrom(e),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>rV.a.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&i&&this.onCollide(i))})(t)},this.inputs=new sy(this),this.inputs.addKeyboard().addMouse()}attachControl(e,t){t=rD.w1.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new i1.P(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){(this.parent?i1.P.TransformCoordinates(this.position,this.parent.getWorldMatrix()):this.position).subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);let t=this.getScene().collisionCoordinator;this._collider||(this._collider=t.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let i=e;this.applyGravity&&(i=e.add(this.getScene().gravity)),t.getNewPosition(this._oldPosition,i,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=i1.P.Zero(),this._transformedDirection=i1.P.Zero()),this.inputs.checkInputs(),super._checkInputs()}set needMoveForGravity(e){this._needMoveForGravity=e}get needMoveForGravity(){return this._needMoveForGravity}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){let t=this._trackRoll,i=t-this.rotation.z;Math.abs(i)>=.001&&(this.rotation.z+=i/e,.001>=Math.abs(t-this.rotation.z)&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}(0,r$.gn)([(0,rj.hd)()],sI.prototype,"ellipsoid",void 0),(0,r$.gn)([(0,rj.hd)()],sI.prototype,"ellipsoidOffset",void 0),(0,r$.gn)([(0,rj.qC)()],sI.prototype,"checkCollisions",void 0),(0,r$.gn)([(0,rj.qC)()],sI.prototype,"applyGravity",void 0),(0,i3.H7)("BABYLON.FlyCamera",sI);class sP extends sa.p{constructor(e){super(e)}addKeyboard(){return this.add(new sd),this}addMouseWheel(){return this.add(new sf),this}addPointers(){return this.add(new sp),this}addVRDeviceOrientation(){return re.Y.Warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}sC.N.AddNodeConstructor("FollowCamera",(e,t)=>()=>new sR(e,i1.P.Zero(),t)),sC.N.AddNodeConstructor("ArcFollowCamera",(e,t)=>()=>new sA(e,0,0,1,null,t));class sR extends sx.C{constructor(e,t,i,r=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=r,this.inputs=new sP(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;let t=i1.jp.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);let i=Math.atan2(t.m[8],t.m[10]),r=rD.w1.ToRadians(this.rotationOffset)+i,s=e.getAbsolutePosition(),n=s.x+Math.sin(r)*this.radius,a=s.z+Math.cos(r)*this.radius,o=n-this.position.x,l=s.y+this.heightOffset-this.position.y,c=a-this.position.z,u=o*this.cameraAcceleration*2,h=l*this.cameraAcceleration,d=c*this.cameraAcceleration*2;(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(h>this.maxCameraSpeed||h<-this.maxCameraSpeed)&&(h=h<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new i1.P(this.position.x+u,this.position.y+h,this.position.z+d),this.setTarget(s)}attachControl(e,t){t=rD.w1.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){null!==this.lowerRadiusLimit&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),null!==this.upperRadiusLimit&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),null!==this.lowerHeightOffsetLimit&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),null!==this.upperHeightOffsetLimit&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),null!==this.lowerRotationOffsetLimit&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),null!==this.upperRotationOffsetLimit&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}(0,r$.gn)([(0,rj.qC)()],sR.prototype,"radius",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"lowerRadiusLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"upperRadiusLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"rotationOffset",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"lowerRotationOffsetLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"upperRotationOffsetLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"heightOffset",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"lowerHeightOffsetLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"upperHeightOffsetLimit",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"cameraAcceleration",void 0),(0,r$.gn)([(0,rj.qC)()],sR.prototype,"maxCameraSpeed",void 0),(0,r$.gn)([(0,rj.RR)("lockedTargetId")],sR.prototype,"lockedTarget",void 0);class sA extends sx.C{constructor(e,t,i,r,s,n){super(e,i1.P.Zero(),n),this.alpha=t,this.beta=i,this.radius=r,this._cartesianCoordinates=i1.P.Zero(),this.setMeshTarget(s)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);let e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}(0,i3.H7)("BABYLON.FollowCamera",sR),(0,i3.H7)("BABYLON.ArcFollowCamera",sA);var sM=i(64765);sC.N.AddNodeConstructor("GamepadCamera",(e,t)=>()=>new sN(e,i1.P.Zero(),t));class sN extends sM.x{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}var sO=i(70214),sD=i(49727);class sF extends sD.D{getClassName(){return"AnaglyphPostProcess"}constructor(e,t,i,r,s,n){super(e,"anaglyph",null,["leftSampler"],t,i[1],r,s,n),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add(e=>{e.setTextureFromPostProcess("leftSampler",this._passedProcess)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,18034)))):t.push(Promise.resolve().then(i.bind(i,45147))),super._gatherImports(e,t)}}function sL(e){e._rigCameras[0]._rigPostProcess=new sO.Q(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new sF(e.name+"_anaglyph",1,e._rigCameras)}(0,i3.H7)("BABYLON.AnaglyphPostProcess",sF),sC.N.AddNodeConstructor("AnaglyphArcRotateCamera",(e,t,i)=>()=>new sw(e,0,0,1,i1.P.Zero(),i.interaxial_distance,t));class sw extends sT{constructor(e,t,i,r,s,n,a){super(e,t,i,r,s,a),this._setRigMode=()=>sL(this),this.interaxialDistance=n,this.setCameraRigMode(rO.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}getClassName(){return"AnaglyphArcRotateCamera"}}sC.N.AddNodeConstructor("AnaglyphFreeCamera",(e,t,i)=>()=>new sB(e,i1.P.Zero(),i.interaxial_distance,t));class sB extends sE.c{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>sL(this),this.interaxialDistance=i,this.setCameraRigMode(rO.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}sC.N.AddNodeConstructor("AnaglyphGamepadCamera",(e,t,i)=>()=>new sV(e,i1.P.Zero(),i.interaxial_distance,t));class sV extends sN{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>sL(this),this.interaxialDistance=i,this.setCameraRigMode(rO.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}sC.N.AddNodeConstructor("AnaglyphUniversalCamera",(e,t,i)=>()=>new sU(e,i1.P.Zero(),i.interaxial_distance,t));class sU extends sM.x{constructor(e,t,i,r){super(e,t,r),this._setRigMode=()=>sL(this),this.interaxialDistance=i,this.setCameraRigMode(rO.V.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}var sk=i(52721),sG=i(29427);let sz=`const vec3 TWO=vec3(2.0,2.0,2.0);varying vec2 vUV;uniform sampler2D camASampler;uniform sampler2D textureSampler;uniform vec2 stepSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{bool useCamA;bool useCamB;vec2 texCoord1;vec2 texCoord2;vec3 frag1;vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;useCamA=!useCamB;texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);useCamA=mod(rowNum,2.0)==1.0;useCamB=mod(rowNum,2.0)==0.0;texCoord1=vec2(vUV.x,vUV.y);texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;useCamA=!useCamB;texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif
if (useCamB){frag1=texture2D(textureSampler,texCoord1).rgb;frag2=texture2D(textureSampler,texCoord2).rgb;}else if (useCamA){frag1=texture2D(camASampler ,texCoord1).rgb;frag2=texture2D(camASampler ,texCoord2).rgb;}else {discard;}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);}
`;sG.v.ShadersStore.stereoscopicInterlacePixelShader=sz;class sH extends sD.D{getClassName(){return"StereoscopicInterlacePostProcessI"}constructor(e,t,i,r,s,n,a){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],s,n,a,r?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new i1.FM(1/this.width,1/this.height),this.onSizeChangedObservable.add(()=>{this._stepSize=new i1.FM(1/this.width,1/this.height)}),this.onApplyObservable.add(e=>{e.setTextureFromPostProcess("camASampler",this._passedProcess),e.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)})}}function sW(e){let t=e.cameraRigMode===rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||e.cameraRigMode===rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,i=e.cameraRigMode===rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;e.cameraRigMode===rO.V.RIG_MODE_STEREOSCOPIC_INTERLACED?(e._rigCameras[0]._rigPostProcess=new sO.Q(e.name+"_passthru",1,e._rigCameras[0]),e._rigCameras[1]._rigPostProcess=new sH(e.name+"_stereoInterlace",e._rigCameras,!1,!0)):(e._rigCameras[i?1:0].viewport=new sk.l(0,0,t?.5:1,t?1:.5),e._rigCameras[i?0:1].viewport=new sk.l(t?.5:0,t?0:.5,t?.5:1,t?1:.5))}sC.N.AddNodeConstructor("StereoscopicArcRotateCamera",(e,t,i)=>()=>new sY(e,0,0,1,i1.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t));class sY extends sT{constructor(e,t,i,r,s,n,a,o){super(e,t,i,r,s,o),this._setRigMode=()=>sW(this),this.interaxialDistance=n,this.isStereoscopicSideBySide=a,this.setCameraRigMode(a?rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:rO.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}getClassName(){return"StereoscopicArcRotateCamera"}}sC.N.AddNodeConstructor("StereoscopicFreeCamera",(e,t,i)=>()=>new sX(e,i1.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t));class sX extends sE.c{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>sW(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:rO.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}sC.N.AddNodeConstructor("StereoscopicGamepadCamera",(e,t,i)=>()=>new s$(e,i1.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t));class s$ extends sN{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>sW(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:rO.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}sC.N.AddNodeConstructor("StereoscopicFreeCamera",(e,t,i)=>()=>new sj(e,i1.P.Zero(),i.interaxial_distance,i.isStereoscopicSideBySide,t));class sj extends sM.x{constructor(e,t,i,r,s){super(e,t,s),this._setRigMode=()=>sW(this),this.interaxialDistance=i,this.isStereoscopicSideBySide=r,this.setCameraRigMode(r?rO.V.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:rO.V.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}sC.N.AddNodeConstructor("VirtualJoysticksCamera",(e,t)=>()=>new sq(e,i1.P.Zero(),t));class sq extends sE.c{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class sQ{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){let e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return i1.y3.Translation(e,0,0)}get rightHMatrix(){let e=4*(this.hScreenSize/4-this.lensSeparationDistance/2)/this.hScreenSize;return i1.y3.Translation(-e,0,0)}get leftPreViewMatrix(){return i1.y3.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return i1.y3.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){let e=new sQ;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}class sK extends sD.D{getClassName(){return"VRDistortionCorrectionPostProcess"}constructor(e,t,i,r){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,r.postProcessScaleFactor,t,rZ.x.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=r.distortionK,this._postProcessScaleFactor=r.postProcessScaleFactor,this._lensCenterOffset=r.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new i1.FM(2,2/this.aspectRatio),this._scaleFactor=new i1.FM(1/this._postProcessScaleFactor*.5,1/this._postProcessScaleFactor*.5*this.aspectRatio),this._lensCenter=new i1.FM(this._isRightEye?.5-.5*this._lensCenterOffset:.5+.5*this._lensCenterOffset,.5)}),this.onApplyObservable.add(e=>{e.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),e.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),e.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),e.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,92516)))):t.push(Promise.resolve().then(i.bind(i,57196))),super._gatherImports(e,t)}}let sZ=`precision mediump sampler2DArray;varying vec2 vUV;uniform sampler2DArray multiviewSampler;uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));}`;sG.v.ShadersStore.vrMultiviewToSingleviewPixelShader=sZ;var sJ=i(89936),s0=i(9520),s1=i(76608),s2=i(6507);class s3 extends s2._{set samples(e){this._samples=e}get samples(){return this._samples}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}var s4=i(75300);function s5(e,t){let i=new s1.M(e,void 0,!0,t);return i.addUniform("viewProjection",16),i.addUniform("viewProjectionR",16),i.addUniform("view",16),i.addUniform("projection",16),i.addUniform("vEyePosition",4),i}sJ.D.prototype.createMultiviewRenderTargetTexture=function(e,t,i,r){let s=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";let n=this._createHardwareRenderTargetWrapper(!1,!1,{width:e,height:t});n._framebuffer=s.createFramebuffer();let a=new s0.l(this,0,!0);return a.width=e,a.height=t,a.isMultiview=!0,i||(i=s.createTexture(),s.bindTexture(s.TEXTURE_2D_ARRAY,i),s.texStorage3D(s.TEXTURE_2D_ARRAY,1,s.RGBA8,e,t,2)),n._colorTextureArray=i,r||(r=s.createTexture(),s.bindTexture(s.TEXTURE_2D_ARRAY,r),s.texStorage3D(s.TEXTURE_2D_ARRAY,1,s.DEPTH24_STENCIL8,e,t,2)),n._depthStencilTextureArray=r,a.isReady=!0,n.setTextures(a),n._depthStencilTexture=a,n},sJ.D.prototype.bindMultiviewFramebuffer=function(e){let t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"},sJ.D.prototype.bindSpaceWarpFramebuffer=function(e){let t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_ATTACHMENT,e._depthStencilTextureArray,0,0,2);else throw Error("Invalid Space Warp framebuffer")},rO.V.prototype._useMultiviewToSingleView=!1,rO.V.prototype._multiviewTexture=null,rO.V.prototype._resizeOrCreateMultiviewTexture=function(e,t){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=e||this._multiviewTexture.getRenderHeight()!=t)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new s3(this.getScene(),{width:e,height:t})):this._multiviewTexture=new s3(this.getScene(),{width:e,height:t})};let s7=rH.x.prototype.createSceneUniformBuffer;rH.x.prototype._transformMatrixR=i1.y3.Zero(),rH.x.prototype._multiviewSceneUbo=null,rH.x.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=s5(this.getEngine(),"scene_multiview")},rH.x.prototype.createSceneUniformBuffer=function(e){return this._multiviewSceneUbo?s5(this.getEngine(),e):s7.bind(this)(e)},rH.x.prototype._updateMultiviewUbo=function(e,t){e&&t&&e.multiplyToRef(t,this._transformMatrixR),e&&t&&(e.multiplyToRef(t,i1.jp.Matrix[0]),s4.i.GetRightPlaneToRef(i1.jp.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))},rH.x.prototype._renderMultiviewToSingleView=function(e){e._resizeOrCreateMultiviewTexture(e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.width>0?e._rigPostProcess.width:this.getEngine().getRenderWidth(!0),e._rigPostProcess&&e._rigPostProcess&&e._rigPostProcess.height>0?e._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),e.outputRenderTarget=e._multiviewTexture,this._renderForCamera(e),e.outputRenderTarget=null;for(let t=0;t<e._rigCameras.length;t++){let i=this.getEngine();this._activeCamera=e._rigCameras[t],i.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class s6 extends sD.D{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,rZ.x.BILINEAR_SAMPLINGMODE);let r=t??this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(e=>{r._scene.activeCamera&&r._scene.activeCamera.isLeftCamera?e.setInt("imageIndex",0):e.setInt("imageIndex",1),e.setTexture("multiviewSampler",r._multiviewTexture)})}}function s8(e,t){let i=t.vrCameraMetrics||sQ.GetDefault();e._rigCameras[0]._cameraRigParams.vrMetrics=i,e._rigCameras[0].viewport=new sk.l(0,0,.5,1),e._rigCameras[0]._cameraRigParams.vrWorkMatrix=new i1.y3,e._rigCameras[0]._cameraRigParams.vrHMatrix=i.leftHMatrix,e._rigCameras[0]._cameraRigParams.vrPreViewMatrix=i.leftPreViewMatrix,e._rigCameras[0].getProjectionMatrix=e._rigCameras[0]._getVRProjectionMatrix,e._rigCameras[1]._cameraRigParams.vrMetrics=i,e._rigCameras[1].viewport=new sk.l(.5,0,.5,1),e._rigCameras[1]._cameraRigParams.vrWorkMatrix=new i1.y3,e._rigCameras[1]._cameraRigParams.vrHMatrix=i.rightHMatrix,e._rigCameras[1]._cameraRigParams.vrPreViewMatrix=i.rightPreViewMatrix,e._rigCameras[1].getProjectionMatrix=e._rigCameras[1]._getVRProjectionMatrix,i.multiviewEnabled&&(e.getScene().getEngine().getCaps().multiview?(e._useMultiviewToSingleView=!0,e._rigPostProcess=new s6("VRMultiviewToSingleview",e,i.postProcessScaleFactor)):(re.Y.Warn("Multiview is not supported, falling back to standard rendering"),i.multiviewEnabled=!1)),i.compensateDistortion&&(e._rigCameras[0]._rigPostProcess=new sK("VR_Distort_Compensation_Left",e._rigCameras[0],!1,i),e._rigCameras[1]._rigPostProcess=new sK("VR_Distort_Compensation_Right",e._rigCameras[1],!0,i))}sC.N.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",(e,t)=>()=>new s9(e,0,0,1,i1.P.Zero(),t));class s9 extends sT{constructor(e,t,i,r,s,n,a=!0,o=sQ.GetDefault()){super(e,t,i,r,s,n),this._setRigMode=e=>s8(this,e),o.compensateDistortion=a,this.setCameraRigMode(rO.V.RIG_MODE_VR,{vrCameraMetrics:o}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}sC.N.AddNodeConstructor("VRDeviceOrientationFreeCamera",(e,t)=>()=>new ne(e,i1.P.Zero(),t));class ne extends sb{constructor(e,t,i,r=!0,s=sQ.GetDefault()){super(e,t,i),this._setRigMode=e=>s8(this,e),s.compensateDistortion=r,this.setCameraRigMode(rO.V.RIG_MODE_VR,{vrCameraMetrics:s})}getClassName(){return"VRDeviceOrientationFreeCamera"}}i(99632),sC.N.AddNodeConstructor("VRDeviceOrientationGamepadCamera",(e,t)=>()=>new nt(e,i1.P.Zero(),t));class nt extends ne{constructor(e,t,i,r=!0,s=sQ.GetDefault()){super(e,t,i,r,s),this._setRigMode=e=>s8(this,e),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}var ni=i(49109),nr=i(7981),ns=i(91176),nn=i(90404),na=i(30115);class no{get isFixedFoveationSupported(){return"XRWebGLLayer"==this.layerType&&"number"==typeof this.layer.fixedFoveation}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){this.isFixedFoveationSupported&&(this.layer.fixedFoveation=Math.max(0,Math.min(1,e||0)))}createRenderTargetTextureProvider(e){return this._rttWrapper=this._createRenderTargetTextureProvider(e),this._rttWrapper}dispose(){this._rttWrapper&&(this._rttWrapper.dispose(),this._rttWrapper=null)}constructor(e,t,i,r,s){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this._createRenderTargetTextureProvider=s,this._rttWrapper=null}}var nl=i(74387);class nc{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=[],this._engine=e.getEngine()}_createInternalTexture(e,t){let i=new s0.l(this._engine,0,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new nl.B(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,r,s,n){if(!this._engine)throw Error("Engine is disposed");let a={width:e,height:t},o=n?new s3(this._scene,a):new s2._("XR renderTargetTexture",a,this._scene),l=o.renderTarget;if(l._samples=o.samples,(i||!r)&&(l._framebuffer=i),r){if(n)l._colorTextureArray=r;else{let e=this._createInternalTexture(a,r);l.setTexture(e,0),o._texture=e}}return s&&(n?l._depthStencilTextureArray=s:l._depthStencilTexture=this._createInternalTexture(a,s)),o.disableRescaling(),this._renderTargetTextures.push(o),o}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.length=0}}class nu extends no{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",e=>new nh(e.scene,this)),this.layer=e}}class nh extends nc{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){let i=this._layer.getViewport(t);if(!i)return!1;let r=this._framebufferDimensions.framebufferWidth,s=this._framebufferDimensions.framebufferHeight;return e.x=i.x/r,e.y=i.y/s,e.width=i.width/r,e.height=i.height/s,!0}getRenderTargetTextureForEye(e){let t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,r=this._layer.framebuffer;return this._rtt&&t===this._framebufferDimensions.framebufferWidth&&i===this._framebufferDimensions.framebufferHeight&&r===this._framebuffer||(this._rtt=this._createRenderTargetTexture(t,i,r),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=r),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class nd{static GetDefaults(e){let t=new nd;return t.canvasOptions={antialias:!0,depth:!0,stencil:!e||e.isStencilEnable,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class nf{constructor(e,t=nd.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new i0.y$,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{let e=document.createElement("canvas");e.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(e)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()}),this._makeCanvasCompatibleAsync()}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}_makeCanvasCompatibleAsync(){this._canvasCompatiblePromise=new Promise((e,t)=>{try{this.canvasContext&&this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{e()},()=>{rD.w1.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly."),e()}):e()}catch(e){t(e)}})}async initializeXRLayerAsync(e){let t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new nu(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this._canvasCompatiblePromise.then(()=>{},()=>{}).then(()=>t())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){this._canvas&&this._engine&&(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class np extends no{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",e=>new nm(e,this)),this.layer=e}}class nm extends nc{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class n_{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class ng{get worldScalingFactor(){return this._worldScalingFactor}set worldScalingFactor(e){let t=this._worldScalingFactor;this._worldScalingFactor=e,this.onWorldScaleFactorChangedObservable.notifyObservers({previousScaleFactor:t,newScaleFactor:e})}constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new i0.y$,this.onXRReferenceSpaceChanged=new i0.y$,this.onXRSessionEnded=new i0.y$,this.onXRSessionInit=new i0.y$,this.onXRReferenceSpaceInitialized=new i0.y$,this.onXRReady=new i0.y$,this.inXRFrameLoop=!1,this.inXRSession=!1,this._worldScalingFactor=1,this.onWorldScaleFactorChangedObservable=new i0.y$(void 0,!0),this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),this.onWorldScaleFactorChangedObservable.clear(),this._engine?.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}async exitXRAsync(){if(this.session&&this.inXRSession){this.inXRSession=!1;try{return await this.session.end()}catch{re.Y.Warn("Could not end XR session.")}}return Promise.resolve()}trySetViewportForView(e,t){return this._baseLayerRTTProvider?.trySetViewportForView(e,t)||!1}getRenderTargetTextureForEye(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForEye(e)||null}getRenderTargetTextureForView(e){return this._baseLayerRTTProvider?.getRenderTargetTextureForView(e)||null}getWebXRRenderTarget(e){let t=this.scene.getEngine();return this._xrNavigator.xr.native?new n_(this):((e=e||nd.GetDefaults(t)).canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new nf(this,e))}initializeAsync(){return(this._xrNavigator=navigator,this._xrNavigator.xr)?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then(t=>(this.session=t,this._sessionMode=e,this.inXRSession=!0,this.onXRSessionInit.notifyObservers(t),this.session.addEventListener("end",()=>{this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session))}isSessionSupportedAsync(e){return ng.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){this.inXRSession&&this._engine&&(this._engine.customAnimationFrameRequester={requestAnimationFrame:e=>this.session.requestAnimationFrame(e),renderFunction:(e,t)=>{if(this.inXRSession&&this._engine&&(this.currentFrame=t,this.currentTimestamp=e,t)){this.inXRFrameLoop=!0;let e=this._baseLayerRTTProvider?.getFramebufferDimensions()||null;this._engine.framebufferDimensionsObject!==e&&(this._engine.framebufferDimensionsObject=e),this.onXRFrameObservable.notifyObservers(t),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1}}},this._engine.framebufferDimensionsObject=this._baseLayerRTTProvider?.getFramebufferDimensions()||null,this.onXRFrameObservable.addOnce(()=>{this.onXRReady.notifyObservers(this)}),"undefined"!=typeof window&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then(e=>e,e=>(re.Y.Error("XR.requestReferenceSpace failed for the following reason: "),re.Y.Error(e),re.Y.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then(e=>{let t=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return e.getOffsetReferenceSpace(t)},e=>{throw re.Y.Error(e),'XR initialization failed: required "viewer" reference space type not supported.'}))).then(e=>this.session.requestReferenceSpace("viewer").then(t=>(this.viewerReferenceSpace=t,e))).then(e=>(this.referenceSpace=this.baseReferenceSpace=e,this.onXRReferenceSpaceInitialized.notifyObservers(e),this.referenceSpace))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){this.isNative&&this._baseLayerRTTProvider?.dispose(),this._baseLayerWrapper=e,this._baseLayerRTTProvider=this._baseLayerWrapper?.createRenderTargetTextureProvider(this)||null}_getBaseLayerWrapper(){return this._baseLayerWrapper}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new np(e.baseLayer):new nu(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);let t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then(e=>Promise.resolve(void 0===e||e)).catch(e=>(re.Y.Warn(e),Promise.resolve(!1))):Promise.resolve(!1)}get isNative(){return this._xrNavigator.xr.native??!1}get currentFrameRate(){return this.session?.frameRate}get supportedFrameRates(){return this.session?.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){return this._baseLayerWrapper?.isFixedFoveationSupported||!1}get fixedFoveation(){return this._baseLayerWrapper?.fixedFoveation||null}set fixedFoveation(e){this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=Math.max(0,Math.min(1,e||0)))}get enabledFeatures(){return this.session?.enabledFeatures??null}}var nv=i(96366),nS=i(77958);class nx{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=nx._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=(0,nS.eu)("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;let t=new nn.K("targetMat",e);t.specularColor=i2.Wo.Black(),t.emissiveColor=new i2.Wo(.7,.7,.7),t.backFaceCulling=!1,this._gazeTracker.material=t}}_getForwardRay(e){return new nr.zH(i1.P.Zero(),new i1.P(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}nx._IdCounter=0;class nE extends nx{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){let t=this._getCamera();return t?t.getForwardRay(e):new nr.zH(i1.P.Zero(),i1.P.Forward())}}class nC{get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker")}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1)}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._scene.activeCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated}constructor(e,t={}){if(this.webVROptions=t,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new i0.y$,this.onAfterEnteringVRObservable=new i0.y$,this.onExitingVRObservable=new i0.y$,this._useCustomVRButton=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=nC.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new i1.P(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new i1.P(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._pickedLaserColor=new i2.Wo(.2,.2,1),this._pickedGazeColor=new i2.Wo(0,0,1),this.onNewMeshSelected=new i0.y$,this.onNewMeshPicked=new i0.y$,this.onBeforeCameraTeleport=new i0.y$,this.onAfterCameraTeleport=new i0.y$,this.onSelectedMeshUnselected=new i0.y$,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock||(this._cameraGazer._gazeTracker.isVisible=!1)},this._onNewGamepadConnected=e=>{e.type!==ni.nJ.POSE_ENABLED&&(e.leftStick&&e.onleftstickchanged(e=>{this._teleportationInitialized&&this.teleportationEnabled&&(this._checkTeleportWithRay(e,this._cameraGazer),this._checkTeleportBackwards(e,this._cameraGazer))}),e.rightStick&&e.onrightstickchanged(e=>{this._teleportationInitialized&&this._checkRotate(e,this._cameraGazer)}),e.type===ni.nJ.XBOX&&(e.onbuttondown(e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerDown()}),e.onbuttonup(e=>{this._interactionsEnabled&&0===e&&this._cameraGazer._selectionPointerUp()})))},this._workingVector=i1.P.Zero(),this._workingQuaternion=i1._f.Identity(),this._workingMatrix=i1.y3.Identity(),re.Y.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),"getVRDisplays"in navigator||void 0!==t.useXR||(t.useXR=!0),void 0===t.createFallbackVRDeviceOrientationFreeCamera&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),void 0===t.createDeviceOrientationCamera&&(t.createDeviceOrientationCamera=!0),void 0===t.laserToggle&&(t.laserToggle=!0),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new i1.P(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new sb("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof sx.C&&this._scene.activeCamera.rotation)){let e=this._scene.activeCamera;e.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(e.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(i1._f.RotationYawPitchRoll(e.rotation.y,e.rotation.x,e.rotation.z)),this._deviceOrientationCamera.rotation=e.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?ng.IsSessionSupportedAsync("immersive-vr").then(i=>{i?(re.Y.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then(t=>{this.xr=t,this.xrTestDone=!0,this._cameraGazer=new nE(()=>this.xr.baseExperience.camera,e),this.xr.baseExperience.onStateChangedObservable.add(e=>{switch(e){case 0:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case 1:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case 2:this._hasEnteredVR=!0;break;case 3:this._hasEnteredVR=!1}})})):this._completeVRInit(e,t)}):this._completeVRInit(e,t)}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(this._vrDeviceOrientationCamera=new ne("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._cameraGazer=new nE(()=>this.currentVRCamera,e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";let e=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";e+=".babylonVRicon.vrdisplaypresenting { display: none; }";let t=document.createElement("style");t.appendChild(document.createTextNode(e)),document.getElementsByTagName("head")[0].appendChild(t),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode||this.enterVR()});let i=this._scene.getEngine().getHostWindow();i&&(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera&&this._displayVRButton(),this._onKeyDown=e=>{27===e.keyCode&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},r1.kD.POINTERDOUBLETAP,!1),e.onDisposeObservable.add(()=>{this.dispose()}),this._updateButtonVisibility(),this._circleEase=new rx,this._circleEase.setEasingMode(rS.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add(t=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&"mouse"===t.event.pointerType&&(t.type===r1.kD.POINTERDOWN?this._cameraGazer._selectionPointerDown():t.type===r1.kD.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&2===this.xr.baseExperience.state||this._fullscreenVRpresenting}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){let e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){this._useCustomVRButton||this._btnVRDisplayed||!this._btnVR||(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){this._btnVR&&!this._useCustomVRButton&&(this._btnVR.className="babylonVRicon",this.isInVRMode&&(this._btnVR.className+=" vrdisplaypresenting"))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){re.Y.Warn("Error in your custom logic onEnteringVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=i1._f.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)),this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._hasEnteredVR=!0}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(e){re.Y.Warn("Error in your custom logic onExitingVR: "+e)}this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1),this._scene.getEngine().resize(),this._hasEnteredVR=!1}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this.xr){2===this.xr.baseExperience.state&&this.xr.pointerSelection.attach();return}this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>(!!this._isTeleportationFloor(e)||-1===e.name.indexOf("gazeTracker")&&-1===e.name.indexOf("teleportationTarget")&&-1===e.name.indexOf("torusTeleportation"))&&this.raySelectionPredicate(e),this._interactionsEnabled=!0}}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!!this._floorMeshName&&e.name===this._floorMeshName}addFloorMesh(e){!this._floorMeshesCollection||this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e)}removeFloorMesh(e){if(!this._floorMeshesCollection)return;let t=this._floorMeshesCollection.indexOf(e);-1!==t&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){let t=e.floorMeshes||[];if(!t.length){let i=this._scene.getMeshByName(e.floorMeshName);i&&t.push(i)}if(this.xr){t.forEach(e=>{this.xr.teleportation.addFloorMesh(e)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}if(!this.xrTestDone){let t=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(t),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};this._scene.registerBeforeRender(t);return}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),void 0!==e.easingFunction&&(this._teleportationEasing=e.easingFunction);let t=new ns.$;t.vignetteColor=new i2.HE(0,0,0,0),t.vignetteEnabled=!0,this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&this._createTeleportationCircles()}}_checkTeleportWithRay(e,t){(!this._teleportationRequestInitiated||t._teleportationRequestInitiated)&&(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){!t._teleportationRequestInitiated&&(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated){if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let e=i1._f.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),i=this.currentVRCamera.position;e.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,i1._f.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),i1.P.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);let r=new nr.zH(i,this._workingVector),s=this._scene.pickWithRay(r,this._raySelectionPredicate);s&&s.pickedPoint&&s.pickedMesh&&this._isTeleportationFloor(s.pickedMesh)&&s.distance<5&&this.teleportCamera(s.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}}_createTeleportationCircles(){this._teleportationTarget=(0,nv.$6)("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;let e=new na.c("DynamicTexture",512,this._scene,!0);e.hasAlpha=!0;let t=e.getContext();t.beginPath(),t.arc(256,256,200,0,2*Math.PI,!1),t.fillStyle=this._teleportationFillColor,t.fill(),t.lineWidth=10,t.strokeStyle=this._teleportationBorderColor,t.stroke(),t.closePath(),e.update();let i=new nn.K("TextPlaneMaterial",this._scene);i.diffuseTexture=e,this._teleportationTarget.material=i;let r=(0,nS.eu)("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);r.isPickable=!1,r.parent=this._teleportationTarget;let s=new r_.fw("animationInnerCircle","position.y",30,r_.fw.ANIMATIONTYPE_FLOAT,r_.fw.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),s.setKeys(n);let a=new rb;a.setEasingMode(rS.EASINGMODE_EASEINOUT),s.setEasingFunction(a),r.animations=[],r.animations.push(s),this._scene.beginAnimation(r,0,60,!0),this._hideTeleportationTarget()}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof sE.c))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];let t=i1._f.FromRotationMatrix(i1.y3.RotationY(Math.PI/4*this._rotationAngle)),i=new r_.fw("animationRotation","rotationQuaternion",90,r_.fw.ANIMATIONTYPE_QUATERNION,r_.fw.ANIMATIONLOOPMODE_CONSTANT),r=[];r.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),r.push({frame:6,value:t}),i.setKeys(r),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];let s=new r_.fw("animationPP","vignetteWeight",90,r_.fw.ANIMATIONTYPE_FLOAT,r_.fw.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:0}),n.push({frame:3,value:4}),n.push({frame:6,value:0}),s.setKeys(n),s.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(s);let a=new r_.fw("animationPP2","vignetteStretch",90,r_.fw.ANIMATIONTYPE_FLOAT,r_.fw.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:3,value:10}),o.push({frame:6,value:0}),a.setKeys(o),a.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(a),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}teleportCamera(e){let t,i;if(!(this.currentVRCamera instanceof sE.c))return;if(this._workingVector.copyFrom(e),this.isInVRMode||(this._workingVector.y+=this._defaultHeight),this.onBeforeCameraTeleport.notifyObservers(this._workingVector),this._teleportationMode==nC.TELEPORTATIONMODE_CONSTANTSPEED){i=90;let e=i1.P.Distance(this.currentVRCamera.position,this._workingVector);t=this._teleportationSpeed/e}else i=Math.round(90*this._teleportationTime/1e3),t=1;this.currentVRCamera.animations=[];let r=new r_.fw("animationCameraTeleportation","position",90,r_.fw.ANIMATIONTYPE_VECTOR3,r_.fw.ANIMATIONLOOPMODE_CONSTANT),s=[{frame:0,value:this.currentVRCamera.position},{frame:i,value:this._workingVector}];r.setKeys(s),r.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];let n=Math.round(i/2),a=new r_.fw("animationPP","vignetteWeight",90,r_.fw.ANIMATIONTYPE_FLOAT,r_.fw.ANIMATIONLOOPMODE_CONSTANT),o=[];o.push({frame:0,value:0}),o.push({frame:n,value:8}),o.push({frame:i,value:0}),a.setKeys(o),this._postProcessMove.animations.push(a);let l=new r_.fw("animationPP2","vignetteStretch",90,r_.fw.ANIMATIONTYPE_FLOAT,r_.fw.ANIMATIONLOOPMODE_CONSTANT),c=[];c.push({frame:0,value:0}),c.push({frame:n,value:10}),c.push({frame:i,value:0}),l.setKeys(c),this._postProcessMove.animations.push(l),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._scene.beginAnimation(this.currentVRCamera,0,i,!1,t,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}setLaserColor(e,t=this._pickedLaserColor){this._pickedLaserColor=t}setLaserLightingState(e=!0){}setGazeColor(e,t=this._pickedGazeColor){this._pickedGazeColor=t}changeLaserColor(e){if(!this.updateControllerLaserColor)return}changeGazeColor(e){this.updateGazeTrackerColor&&this._cameraGazer._gazeTracker.material&&(this._cameraGazer._gazeTracker.material.emissiveColor=e)}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}nC.TELEPORTATIONMODE_CONSTANTTIME=0,nC.TELEPORTATIONMODE_CONSTANTSPEED=1;var nT=i(47941);let nb=(e,t,i,r)=>!(e.x>i.x+r)&&!(i.x-r>t.x)&&!(e.y>i.y+r)&&!(i.y-r>t.y)&&!(e.z>i.z+r)&&!(i.z-r>t.z),ny=function(){let e={root:0,found:!1};return function(t,i,r,s){e.root=0,e.found=!1;let n=i*i-4*t*r;if(n<0)return e;let a=Math.sqrt(n),o=(-i-a)/(2*t),l=(-i+a)/(2*t);if(o>l){let e=l;l=o,o=e}return o>0&&o<s?(e.root=o,e.found=!0):l>0&&l<s&&(e.root=l,e.found=!0),e}}();class nI{constructor(){this._collisionPoint=i1.P.Zero(),this._planeIntersectionPoint=i1.P.Zero(),this._tempVector=i1.P.Zero(),this._tempVector2=i1.P.Zero(),this._tempVector3=i1.P.Zero(),this._tempVector4=i1.P.Zero(),this._edge=i1.P.Zero(),this._baseToVertex=i1.P.Zero(),this._destinationPoint=i1.P.Zero(),this._slidePlaneNormal=i1.P.Zero(),this._displacementVector=i1.P.Zero(),this._radius=i1.P.One(),this._retry=0,this._basePointWorld=i1.P.Zero(),this._velocityWorld=i1.P.Zero(),this._normalizedVelocity=i1.P.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();let r=Math.sqrt(this._velocitySquaredLength);0===r||1===r?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/r,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,r,s){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),i1.P.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let n=i1.P.Dot(this._tempVector4,s);return!(n<0)&&(r.subtractToRef(e,this._tempVector3),i1.P.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),!((n=i1.P.Dot(this._tempVector4,s))<0)&&(i1.P.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),(n=i1.P.Dot(this._tempVector4,s))>=0))}_canDoCollision(e,t,i,r){let s=i1.P.Distance(this._basePointWorld,e),n=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(s>this._velocityWorldLength+n+t)&&!!nb(i,r,this._basePointWorld,this._velocityWorldLength+n)}_testTriangle(e,t,i,r,s,n,a){let o;let l=!1;t||(t=[]),t[e]||(t[e]=new nT.J(0,0,0,0),t[e].copyFromPoints(i,r,s));let c=t[e];if(!n&&!c.isFrontFacingTo(this._normalizedVelocity,0))return;let u=c.signedDistanceTo(this._basePoint),h=i1.P.Dot(c.normal,this._velocity);if(nI.DoubleSidedCheck&&h>1e-4)return;if(0==h){if(Math.abs(u)>=1)return;l=!0,o=0}else{o=(-1-u)/h;let e=(1-u)/h;if(o>e){let t=e;e=o,o=t}if(o>1||e<0)return;o<0&&(o=0),o>1&&(o=1)}this._collisionPoint.copyFromFloats(0,0,0);let d=!1,f=1;if(!l&&(this._basePoint.subtractToRef(c.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(o,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,r,s,c.normal)&&(d=!0,f=o,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!d){let e=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let t=2*i1.P.Dot(this._velocity,this._tempVector),n=this._tempVector.lengthSquared()-1,a=ny(e,t,n,f);a.found&&(f=a.root,d=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(r,this._tempVector),(a=ny(e,t=2*i1.P.Dot(this._velocity,this._tempVector),n=this._tempVector.lengthSquared()-1,f)).found&&(f=a.root,d=!0,this._collisionPoint.copyFrom(r)),this._basePoint.subtractToRef(s,this._tempVector),(a=ny(e,t=2*i1.P.Dot(this._velocity,this._tempVector),n=this._tempVector.lengthSquared()-1,f)).found&&(f=a.root,d=!0,this._collisionPoint.copyFrom(s)),r.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let o=this._edge.lengthSquared(),l=i1.P.Dot(this._edge,this._velocity),c=i1.P.Dot(this._edge,this._baseToVertex);if((a=ny(e=-(o*this._velocitySquaredLength)+l*l,t=2*(o*i1.P.Dot(this._velocity,this._baseToVertex)-l*c),n=o*(1-this._baseToVertex.lengthSquared())+c*c,f)).found){let e=(l*a.root-c)/o;e>=0&&e<=1&&(f=a.root,d=!0,this._edge.scaleInPlace(e),i.addToRef(this._edge,this._collisionPoint))}if(s.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),o=this._edge.lengthSquared(),l=i1.P.Dot(this._edge,this._velocity),c=i1.P.Dot(this._edge,this._baseToVertex),(a=ny(e=-(o*this._velocitySquaredLength)+l*l,t=2*(o*i1.P.Dot(this._velocity,this._baseToVertex)-l*c),n=o*(1-this._baseToVertex.lengthSquared())+c*c,f)).found){let e=(l*a.root-c)/o;e>=0&&e<=1&&(f=a.root,d=!0,this._edge.scaleInPlace(e),r.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex),o=this._edge.lengthSquared(),l=i1.P.Dot(this._edge,this._velocity),c=i1.P.Dot(this._edge,this._baseToVertex),(a=ny(e=-(o*this._velocitySquaredLength)+l*l,t=2*(o*i1.P.Dot(this._velocity,this._baseToVertex)-l*c),n=o*(1-this._baseToVertex.lengthSquared())+c*c,f)).found){let e=(l*a.root-c)/o;e>=0&&e<=1&&(f=a.root,d=!0,this._edge.scaleInPlace(e),s.addToRef(this._edge,this._collisionPoint))}}if(d){let e=f*f*this._velocitySquaredLength;(!this.collisionFound||e<this._nearestDistanceSquared)&&(a.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=e,this._nearestDistance=Math.sqrt(e),this.collisionFound=!0),this.collidedMesh=a)}}_collide(e,t,i,r,s,n,a,o,l,c=!1){if(c){if(i&&0!==i.length)for(let n=r;n<s-2;n+=1){let r=i[n],s=i[n+1],c=i[n+2];if(4294967295===c){n+=2;continue}let u=t[r],h=t[s],d=t[c];u&&h&&d&&((l?1:0)^n%2?this._testTriangle(n,e,u,h,d,a,o):this._testTriangle(n,e,h,u,d,a,o))}else for(let i=0;i<t.length-2;i+=1){let r=t[i],s=t[i+1],n=t[i+2];r&&s&&n&&((l?1:0)^i%2?this._testTriangle(i,e,r,s,n,a,o):this._testTriangle(i,e,s,r,n,a,o))}}else if(i&&0!==i.length)for(let c=r;c<s;c+=3){let r=t[i[c]-n],s=t[i[c+1]-n],u=t[i[c+2]-n];l?this._testTriangle(c,e,r,s,u,a,o):this._testTriangle(c,e,u,s,r,a,o)}else for(let i=0;i<t.length;i+=3){let r=t[i],s=t[i+1],n=t[i+2];l?this._testTriangle(i,e,r,s,n,a,o):this._testTriangle(i,e,n,s,r,a,o)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(nT.J.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}nI.DoubleSidedCheck=!1;class nP{constructor(){this._scaledPosition=i1.P.Zero(),this._scaledVelocity=i1.P.Zero(),this._finalPosition=i1.P.Zero()}getNewPosition(e,t,i,r,s,n,a){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,r,this._finalPosition,s),this._finalPosition.multiplyInPlace(i._radius),n(a,this._finalPosition,i.collidedMesh)}createCollider(){return new nI}init(e){this._scene=e}_collideWithWorld(e,t,i,r,s,n=null){let a=10*rV.a.CollisionsEpsilon;if(i._retry>=r){s.copyFrom(e);return}let o=n?n.collisionMask:i.collisionMask;i._initialize(e,t,a);let l=n&&n.surroundingMeshes||this._scene.meshes;for(let e=0;e<l.length;e++){let t=l[e];t.isEnabled()&&t.checkCollisions&&t.subMeshes&&t!==n&&(o&t.collisionGroup)!=0&&t._checkCollision(i)}if(!i.collisionFound){e.addToRef(t,s);return}if((0!==t.x||0!==t.y||0!==t.z)&&i._getResponse(e,t),t.length()<=a){s.copyFrom(e);return}i._retry++,this._collideWithWorld(e,t,i,r,s,n)}}rH.x.CollisionCoordinatorFactory=()=>new nP;var nR=i(88251);i(13306),i(40515);var nA=i(5377);class nM{constructor(){this._pickingTexture=null,this._idMap=[],this._thinIdMap=[],this._idColors=[],this._meshMaterialMap=new Map,this._meshRenderingCount=0,this._attributeName="instanceMeshID",this._shaderLanguage=0,this._pickingInProgress=!1}get shaderLanguage(){return this._shaderLanguage}get pickingInProgress(){return this._pickingInProgress}static _IdToRgb(e){nM._TempColor.r=(16711680&e)>>16,nM._TempColor.g=(65280&e)>>8,nM._TempColor.b=(255&e)>>0}_getColorIdFromReadBuffer(e){return(this._readbuffer[e]<<16)+(this._readbuffer[e+1]<<8)+this._readbuffer[e+2]}static _SetColorData(e,t,i,r,s){e[t]=i/255,e[t+1]=r/255,e[t+2]=s/255,e[t+3]=1}_createRenderTarget(e,t,i){this._pickingTexture&&this._pickingTexture.dispose(),this._pickingTexture=new s2._("pickingTexure",{width:t,height:i},e,!1,void 0,0,!1,1)}async _createColorMaterialAsync(e){this._defaultRenderMaterial&&this._defaultRenderMaterial.dispose(),this._defaultRenderMaterial=null,e.getEngine().isWebGPU&&(this._shaderLanguage=1);let t={attributes:[st.o.PositionKind,this._attributeName,"bakedVertexAnimationSettingsInstanced"],uniforms:["world","viewProjection","meshID"],needAlphaBlending:!1,defines:[],useClipPlane:null,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,92374)),Promise.resolve().then(i.bind(i,97740))]):await Promise.all([Promise.resolve().then(i.bind(i,75313)),Promise.resolve().then(i.bind(i,60588))])}};this._defaultRenderMaterial=new nA.j("pickingShader",e,"picking",t,!1),this._defaultRenderMaterial.onBindObservable.add(this._materialBindCallback,void 0,void 0,this)}_materialBindCallback(e){if(!e)return;let t=this._meshMaterialMap.get(e).getEffect();e.hasInstances||e.isAnInstance||e.hasThinInstances||t.setColor4("meshID",this._idColors[e.uniqueId],1),this._meshRenderingCount++}_generateColorData(e,t,i,r,s,n,a){let o=new Float32Array(4*(e+1));nM._SetColorData(o,0,r,s,n);for(let i=0;i<e;i++)nM._IdToRgb(t),a(i,t),nM._SetColorData(o,(i+1)*4,nM._TempColor.r,nM._TempColor.g,nM._TempColor.b),t++;return o}_generateThinInstanceColorData(e,t,i){let r=new Float32Array(4*e);for(let s=0;s<e;s++)nM._IdToRgb(t),i(s,t),nM._SetColorData(r,4*s,nM._TempColor.r,nM._TempColor.g,nM._TempColor.b),t++;return r}setPickingList(e){if(this._pickableMeshes){for(let e=0;e<this._pickableMeshes.length;e++){let t=this._pickableMeshes[e];t.hasInstances&&t.removeVerticesData(this._attributeName),t.hasThinInstances&&t.thinInstanceSetBuffer(this._attributeName,null),this._pickingTexture&&this._pickingTexture.setMaterialForRendering(t,void 0);let i=this._meshMaterialMap.get(t);i!==this._defaultRenderMaterial&&i.onBindObservable.removeCallback(this._materialBindCallback)}this._pickableMeshes.length=0,this._meshMaterialMap.clear(),this._idMap.length=0,this._thinIdMap.length=0,this._idColors.length=0,this._pickingTexture&&(this._pickingTexture.renderList=[])}if(!e||0===e.length)return;this._pickableMeshes=e;let t=("mesh"in e[0]?e[0].mesh:e[0]).getScene(),i=t.getEngine(),r=i.getRenderWidth(),s=i.getRenderHeight();if(this._pickingTexture){let e=this._pickingTexture.getSize();(e.width!==r||e.height!==s||this._cachedScene!==t)&&this._createRenderTarget(t,r,s)}else this._createRenderTarget(t,r,s);this._cachedScene&&this._cachedScene===t||this._createColorMaterialAsync(t),this._cachedScene=t,this._engine=t.getEngine();for(let t=0;t<e.length;t++){let i=e[t];"mesh"in i?(this._meshMaterialMap.set(i.mesh,i.material),e[t]=i.mesh):this._meshMaterialMap.set(i,this._defaultRenderMaterial)}this._pickingTexture.renderList=[];let n=1;for(let e=0;e<this._pickableMeshes.length;e++){let t=this._pickableMeshes[e],i=this._meshMaterialMap.get(t);if(i!==this._defaultRenderMaterial&&i.onBindObservable.add(this._materialBindCallback,void 0,void 0,this),this._pickingTexture.setMaterialForRendering(t,i),this._pickingTexture.renderList.push(t),!t.isAnInstance){if(nM._IdToRgb(n),t.hasThinInstances){let i=this._generateThinInstanceColorData(t.thinInstanceCount,n,(t,i)=>{this._thinIdMap[i]={meshId:e,thinId:t}});n+=t.thinInstanceCount,t.thinInstanceSetBuffer(this._attributeName,i,4)}else if(this._idMap[n]=e,n++,t.hasInstances){let i=t.instances,r=this._generateColorData(i.length,n,e,nM._TempColor.r,nM._TempColor.g,nM._TempColor.b,(e,t)=>{let r=i[e];this._idMap[t]=this._pickableMeshes.indexOf(r)});n+=i.length;let s=t.getEngine(),a=new st.o(s,r,this._attributeName,!1,!1,4,!0);t.setVerticesBuffer(a,!0)}else this._idColors[t.uniqueId]=i2.Wo.FromInts(nM._TempColor.r,nM._TempColor.g,nM._TempColor.b)}}}async pickAsync(e,t,i=!1){if(this._pickingInProgress||!this._pickableMeshes||0===this._pickableMeshes.length)return null;let{x:r,y:s,rttSizeW:n,rttSizeH:a}=this._prepareForPicking(e,t);if(r<0||s<0||r>=n||s>=a)return null;this._pickingInProgress=!0;let o=a-s-1;return this._preparePickingBuffer(this._engine,n,a,r,o),this._executePicking(r,o,i)}async multiPickAsync(e,t=!1){if(this._pickingInProgress||!this._pickableMeshes||0===this._pickableMeshes.length||0===e.length)return null;if(1===e.length){let i=await this.pickAsync(e[0].x,e[0].y,t);return{meshes:[i?.mesh??null],thinInstanceIndexes:i?.thinInstanceIndex?[i.thinInstanceIndex]:void 0}}this._pickingInProgress=!0;let i=e[0].x,r=e[0].x,s=e[0].y,n=e[0].y;for(let t=1;t<e.length;t++){let{x:a,y:o}=e[t];i=Math.min(i,a),r=Math.max(r,a),s=Math.min(s,o),n=Math.max(n,o)}let{rttSizeW:a,rttSizeH:o}=this._prepareForPicking(i,s),l=Math.max(r-i,1),c=Math.max(n-s,1),u=o-n-1;return this._preparePickingBuffer(this._engine,a,o,i,u,l,c),this._executeMultiPicking(e,i,n,o,l,c,t)}_prepareForPicking(e,t){let i=this._cachedScene.getEngine(),r=i.getRenderWidth(),s=i.getRenderHeight(),n=1/i._hardwareScalingLevel;return{x:n*e>>0,y:n*t>>0,rttSizeW:r,rttSizeH:s}}_preparePickingBuffer(e,t,i,r,s,n=1,a=1){this._meshRenderingCount=0;let o=e.isWebGPU?4*n*a+255&-256:4*n*a;(!this._readbuffer||this._readbuffer.length<o)&&(this._readbuffer=new Uint8Array(o));let l=this._pickingTexture.getSize();(l.width!==t||l.height!==i)&&(this._createRenderTarget(this._cachedScene,t,i),this._updateRenderList()),this._pickingTexture.clearColor=new i2.HE(0,0,0,0),this._pickingTexture.onBeforeRender=()=>{this._enableScissor(r,s,n,a)},this._cachedScene.customRenderTargets.push(this._pickingTexture)}_executePicking(e,t,i){return new Promise((r,s)=>{if(!this._pickingTexture){this._pickingInProgress=!1,s();return}this._pickingTexture.onAfterRender=async()=>{if(this._disableScissor(),this._checkRenderStatus()){let s;this._pickingTexture.onAfterRender=null;let n=null,a=this._cachedScene.customRenderTargets.indexOf(this._pickingTexture);if(a>-1&&this._cachedScene.customRenderTargets.splice(a,1),await this._readTexturePixelsAsync(e,t)){let e=this._getColorIdFromReadBuffer(0);this._thinIdMap[e]?(n=this._pickableMeshes[this._thinIdMap[e].meshId],s=this._thinIdMap[e].thinId):n=this._pickableMeshes[this._idMap[e]]}i&&this.dispose(),this._pickingInProgress=!1,n?r({mesh:n,thinInstanceIndex:s}):r(null)}}})}_executeMultiPicking(e,t,i,r,s,n,a){return new Promise((o,l)=>{if(!this._pickingTexture){this._pickingInProgress=!1,l();return}this._pickingTexture.onAfterRender=async()=>{if(this._disableScissor(),this._checkRenderStatus()){this._pickingTexture.onAfterRender=null;let l=[],c=[];if(await this._readTexturePixelsAsync(t,r-i-1,s,n))for(let r=0;r<e.length;r++){let{pickedMesh:n,thinInstanceIndex:a}=this._getMeshFromMultiplePoints(e[r].x,e[r].y,t,i,s);l.push(n),c.push(a??0)}a&&this.dispose(),this._pickingInProgress=!1,o({meshes:l,thinInstanceIndexes:c})}}})}_enableScissor(e,t,i=1,r=1){this._engine.enableScissor&&this._engine.enableScissor(e,t,i,r)}_disableScissor(){this._engine.disableScissor&&this._engine.disableScissor()}_checkRenderStatus(){if(this._meshRenderingCount>0){let e=this._cachedScene.customRenderTargets.indexOf(this._pickingTexture);return e>-1&&this._cachedScene.customRenderTargets.splice(e,1),!0}return this._meshRenderingCount=0,!1}_getMeshFromMultiplePoints(e,t,i,r,s){let n,a=(e-i-1)*4,o=(r-t-1)*s*4;a=Math.max(a,0),o=Math.max(o,0);let l=this._getColorIdFromReadBuffer(a+o),c=null;return l>0&&(this._thinIdMap[l]?(c=this._pickableMeshes[this._thinIdMap[l].meshId],n=this._thinIdMap[l].thinId):c=this._pickableMeshes[this._idMap[l]]),{pickedMesh:c,thinInstanceIndex:n}}_updateRenderList(){for(let e of(this._pickingTexture.renderList=[],this._pickableMeshes))this._pickingTexture.setMaterialForRendering(e,this._meshMaterialMap.get(e)),this._pickingTexture.renderList.push(e)}async _readTexturePixelsAsync(e,t,i=1,r=1){if(!this._cachedScene||!this._pickingTexture?._texture)return!1;let s=this._cachedScene.getEngine();return await s._readTexturePixels(this._pickingTexture._texture,i,r,-1,0,this._readbuffer,!0,!0,e,t),!0}dispose(){this.setPickingList(null),this._cachedScene=null,this._pickingTexture?.dispose(),this._pickingTexture=null,this._defaultRenderMaterial?.dispose(),this._defaultRenderMaterial=null}}nM._TempColor={r:0,g:0,b:0},i(75313),i(60588),i(92374),i(97740);var nN=i(28143),nO=i(96305);class nD{constructor(e,t,i,r=""){let s;this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new i0.y$,this.onErrorObservable=new i0.y$,this.onBindObservable=new i0.y$,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=1,this.name=e,this._key=r,this._engine=i,this.uniqueId=nD._UniqueIdSeed++,this.defines=t.defines??"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=t.entryPoint??"main",this._shaderStore=sG.v.GetShadersStore(this._shaderLanguage),this._shaderRepository=sG.v.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=sG.v.GetIncludesShadersStore(this._shaderLanguage);let n=(0,nN.CG)()?this._engine.getHostDocument():null;s="string"==typeof e?e:e.computeSource?"source:"+e.computeSource:e.computeElement?n?.getElementById(e.computeElement)||e.computeElement:e.compute||e;let a={defines:this.defines.split("\n"),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:(e,t,i)=>{if(!i)return t;for(let e of i){let i=e.replace("#define","").replace(";","").trim().split(" ");if(2===i.length){let e=i[0],r=i[1];isNaN(parseInt(r))&&isNaN(parseFloat(r))||(t=`const ${e} = ${r};
`+t)}}return t}};this._loadShader(s,"Compute","",i=>{(0,nO.wz)(a),(0,nO.aK)(i,a,r=>{this._rawComputeSourceCode=i,t.processFinalCode&&(r=t.processFinalCode(r));let s=(0,nO.Ku)(r,"",a);this._useFinalCode(s.vertexCode,e)},this._engine)})}_useFinalCode(e,t){if(t){let i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+"\n"+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return!!this._isReady||!!this._pipelineContext&&this._pipelineContext.isReady}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,r){let s;if("undefined"!=typeof HTMLElement&&e instanceof HTMLElement){r((0,nN.v)(e));return}if("source:"===e.substring(0,7)){r(e.substring(7));return}if("base64:"===e.substring(0,7)){r(window.atob(e.substring(7)));return}if(this._shaderStore[e+t+"Shader"]){r(this._shaderStore[e+t+"Shader"]);return}if(i&&this._shaderStore[e+i+"Shader"]){r(this._shaderStore[e+i+"Shader"]);return}s="."===e[0]||"/"===e[0]||e.indexOf("http")>-1?e:this._shaderRepository+e,this._engine._loadFile(s+"."+t.toLowerCase()+".fx",r)}get computeSourceCode(){return this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._pipelineContext?._getComputeShaderCode()??this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){let e=this.defines,t=this._pipelineContext;this._isReady=!1;try{let i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,e=>{if(e&&e.numErrors>0){this._processCompilationErrors(e,t);return}this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t)}),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(e){this._processCompilationErrors(e,t)}}_processCompilationErrors(e,t=null){if(this._compilationError="",re.Y.Error("Unable to compile compute effect:"),this.defines&&re.Y.Error("Defines:\n"+this.defines),nD.LogShaderCodeOnCompilationError){let e=this._pipelineContext?._getComputeShaderCode();e&&(re.Y.Error("Compute code:"),re.Y.Error(e))}if("string"==typeof e)this._compilationError=e,re.Y.Error("Error: "+this._compilationError);else for(let t of e.messages){let e="";void 0!==t.line&&(e+="Line "+t.line+", "),void 0!==t.offset&&(e+="Offset "+t.offset+", "),void 0!==t.length&&(e+="Length "+t.length+", "),e+=t.type+": "+t.text,this._compilationError&&(this._compilationError+="\n"),this._compilationError+=e,re.Y.Error(e)}t&&(this._pipelineContext=t,this._isReady=!0),this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){sG.v.GetShadersStore(1)[`${e}ComputeShader`]=t}}nD._UniqueIdSeed=0,nD.LogShaderCodeOnCompilationError=!0;var nF=i(87868),nL=i(58044),nw=i(29892);i(58093),i(91166);var nB=i(9939),nV=i(93287);class nU{constructor(e,t,i,r,s,n){this.entries=[],this._boundingVectors=[],this._capacity=i,this._depth=r,this._maxDepth=s,this._creationFunc=n,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);return}this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e);return}let t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){let i=e[t];this.addEntry(i)}}select(e,t,i){if(nL.k.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,r){if(nL.k.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let s=0;s<this.blocks.length;s++)this.blocks[s].intersects(e,t,i,r);return}r?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){nU._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,r,s,n,a,o){a.blocks=[];let l=new i1.P((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let t=0;t<2;t++)for(let c=0;c<2;c++)for(let u=0;u<2;u++){let h=new nU(e.add(l.multiplyByFloats(t,c,u)),e.add(l.multiplyByFloats(t+1,c+1,u+1)),r,s+1,n,o);h.addEntries(i),a.blocks.push(h)}}}class nk{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=[],this._maxBlockCapacity=t||64,this._selectionContent=new nV.f(1024),this._creationFunc=e}update(e,t,i){nU._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e)}removeMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e)}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].select(e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let r=0;r<this.blocks.length;r++)this.blocks[r].intersects(e,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(e,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}nk.CreationFuncForMeshes=(e,t)=>{let i=e.getBoundingInfo();!e.isBlocked&&i.boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},nk.CreationFuncForSubMeshes=(e,t)=>{e.getBoundingInfo().boundingBox.intersectsMinMax(t.minPoint,t.maxPoint)&&t.entries.push(e)},rH.x.prototype.createOrUpdateSelectionOctree=function(e=64,t=2){let i=this._getComponent(rz.l.NAME_OCTREE);i||(i=new nG(this),this._addComponent(i)),this._selectionOctree||(this._selectionOctree=new nk(nk.CreationFuncForMeshes,e,t));let r=this.getWorldExtends();return this._selectionOctree.update(r.min,r.max,this.meshes),this._selectionOctree},Object.defineProperty(rH.x.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0}),rA.x.prototype.createOrUpdateSubmeshesOctree=function(e=64,t=2){let i=this.getScene(),r=i._getComponent(rz.l.NAME_OCTREE);r||(r=new nG(i),i._addComponent(r)),this._submeshesOctree||(this._submeshesOctree=new nk(nk.CreationFuncForSubMeshes,e,t)),this.computeWorldMatrix(!0);let s=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(s.minimumWorld,s.maximumWorld,this.subMeshes),this._submeshesOctree};class nG{constructor(e){if(this.name=rz.l.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new nr.zH(i1.P.Zero(),new i1.P(1,1,1)),!(e=e||rh.l.LastCreatedScene))return;this.scene=e,this.scene.getActiveMeshCandidates=()=>this.getActiveMeshCandidates(),this.scene.getActiveSubMeshCandidates=e=>this.getActiveSubMeshCandidates(e),this.scene.getCollidingSubMeshCandidates=(e,t)=>this.getCollidingSubMeshCandidates(e,t),this.scene.getIntersectingSubMeshCandidates=(e,t)=>this.getIntersectingSubMeshCandidates(e,t)}register(){this.scene.onMeshRemovedObservable.add(e=>{let t=this.scene.selectionOctree;if(null!=t){let i=t.dynamicContent.indexOf(e);-1!==i&&t.dynamicContent.splice(i,1)}}),this.scene.onMeshImportedObservable.add(e=>{let t=this.scene.selectionOctree;null!=t&&t.addMesh(e)})}getActiveMeshCandidates(){return this.scene._selectionOctree?.select(this.scene.frustumPlanes)||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?(nr.zH.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){let i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}var nz=i(53413),nH=i(82076),nW=i(38018);Object.defineProperty(rH.x.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new nY(this)),this._debugLayer},enumerable:!0,configurable:!0}),(a=ti||(ti={}))[a.Properties=0]="Properties",a[a.Debug=1]="Debug",a[a.Statistics=2]="Statistics",a[a.Tools=3]="Tools",a[a.Settings=4]="Settings";class nY{get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new i0.y$),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new i0.y$),this._onSelectionChangedObservable)}constructor(e){if(this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||rh.l.LastCreatedScene,!this._scene)return;this._scene.onDisposeObservable.add(()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()})}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(let e of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(e);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(let e of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(e);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}let t={...nY.Config,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&("[object String]"==Object.prototype.toString.call(t)?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){return"undefined"!=typeof INSPECTOR?INSPECTOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.Inspector?BABYLON:void 0}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}popupSceneExplorer(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupSceneExplorer()}popupInspector(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupInspector()}popupEmbed(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.PopupEmbed()}show(e){return new Promise(t=>{if(void 0===this.BJSINSPECTOR){let i=e&&e.inspectorURL?e.inspectorURL:nY.InspectorURL;rD.w1.LoadBabylonScript(i,()=>{this._createInspector(e),t(this)})}else this._createInspector(e),t(this)})}}nY.InspectorURL=`${rD.w1._DefaultCdnUrl}/v${rV.a.Version}/inspector/babylon.inspector.bundle.js`,nY.Config={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0};var nX=i(63647),n$=i(85017);class nj{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}nj.DistanceJoint=0,nj.HingeJoint=1,nj.BallAndSocketJoint=2,nj.WheelJoint=3,nj.SliderJoint=4,nj.PrismaticJoint=5,nj.UniversalJoint=6,nj.Hinge2Joint=nj.WheelJoint,nj.PointToPointJoint=8,nj.SpringJoint=9,nj.LockJoint=10,rP.Kj._PhysicsImpostorParser=function(e,t,i){return new nq(t,i.physicsImpostor,{mass:i.physicsMass,friction:i.physicsFriction,restitution:i.physicsRestitution},e)};class nq{get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPressure&&t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyStiffness&&t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyVelocityIterations&&t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;let e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;let t=this._physicsEngine.getPhysicsPlugin();t.setBodyPositionIterations&&t.setBodyPositionIterations(this,e)}constructor(e,t,i={mass:0},r){if(this.object=e,this.type=t,this._options=i,this._scene=r,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=[],this._onAfterPhysicsStepCallbacks=[],this._onPhysicsCollideCallbacks=[],this._deltaPosition=i1.P.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new i1._f,this._tmpQuat2=new i1._f,this.beforeStep=()=>{this._physicsEngine&&(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new i1._f),!this._options.disableBidirectionalTransformation&&this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(e=>{e(this)}))},this.afterStep=()=>{this._physicsEngine&&(this._onAfterPhysicsStepCallbacks.forEach(e=>{e(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,nq._TmpVecs[0]),this.object.translate(nq._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=e=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;let t=this._physicsEngine.getImpostorWithPhysicsBody(e.body);t&&(this.onCollideEvent&&this.onCollideEvent(this,t),this._onPhysicsCollideCallbacks.filter(e=>-1!==e.otherImpostors.indexOf(t)).forEach(i=>{i.callback(this,t,e.point,e.distance,e.impulse,e.normal)}))},!this.object){re.Y.Error("No object was provided. A physics object is obligatory");return}if(this.object.parent&&0!==i.mass&&re.Y.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),!this._scene)return;this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=i1._f.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new i1._f),this._options.mass=void 0===i.mass?0:i.mass,this._options.friction=void 0===i.friction?.2:i.friction,this._options.restitution=void 0===i.restitution?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=void 0===i.pressure?200:i.pressure,this._options.stiffness=void 0===i.stiffness?1:i.stiffness,this._options.velocityIterations=void 0===i.velocityIterations?20:i.velocityIterations,this._options.positionIterations=void 0===i.positionIterations?20:i.positionIterations,this._options.fixedPoints=void 0===i.fixedPoints?0:i.fixedPoints,this._options.margin=void 0===i.margin?0:i.margin,this._options.damping=void 0===i.damping?0:i.damping,this._options.path=void 0===i.path?null:i.path,this._options.shape=void 0===i.shape?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&re.Y.Warn("You must affect impostors to children before affecting impostor to parent.")):re.Y.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors.")}_init(){this._physicsEngine&&(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),this._isDisposed||this.parent&&!this._options.ignoreParent||this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof rA.x?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(!this.object.getBoundingInfo)return nq.DEFAULT_OBJECT_SIZE;{let e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=nq.IDENTITY_QUATERNION;let i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);let r=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),r}}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):i1.P.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):i1.P.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){let t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):re.Y.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){let t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):re.Y.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:e instanceof Array?e:[e]})}unregisterOnPhysicsCollide(e,t){let i=e instanceof Array?e:[e],r=-1;this._onPhysicsCollideCallbacks.some((e,s)=>{if(e.callback===t&&e.otherImpostors.length===i.length){let t=e.otherImpostors.every(e=>i.indexOf(e)>-1);return t&&(r=s),t}return!1})?this._onPhysicsCollideCallbacks.splice(r,1):re.Y.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):i1._f.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){let r=new nj(t,i);return this.addJoint(e,r),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,r,s){if(!this._physicsEngine)return this;let n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor&&this._physicsEngine&&n.appendAnchor(this,e,t,i,r,s),this}addHook(e,t,i,r){if(!this._physicsEngine)return this;let s=this._physicsEngine.getPhysicsPlugin();return s.appendAnchor&&this._physicsEngine&&s.appendHook(this,e,t,i,r),this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new nq(e,this.type,this._options,this._scene):null}dispose(){this._physicsEngine&&(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new i1._f),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,r,s){let n=nq._TmpVecs[0],a=this.object;if(a.rotationQuaternion){if(s){let i=nq._TmpQuat;a.rotationQuaternion.multiplyToRef(s,i),e.setRotationQuaternion(i,1,t)}else e.setRotationQuaternion(a.rotationQuaternion,1,t)}n.x=0,n.y=0,n.z=0,i&&(n.x=i.x,n.y=i.y,n.z=i.z,e.getDirectionToRef(n,t,n),null==r&&(r=i.length()),n.x*=r,n.y*=r,n.z*=r),e.getParent()?(n.addInPlace(a.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(a.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)}syncImpostorWithBone(e,t,i,r,s,n){let a=this.object;if(a.rotationQuaternion){if(s){let i=nq._TmpQuat;e.getRotationQuaternionToRef(1,t,i),i.multiplyToRef(s,a.rotationQuaternion)}else e.getRotationQuaternionToRef(1,t,a.rotationQuaternion)}let o=nq._TmpVecs[0],l=nq._TmpVecs[1];n||((n=nq._TmpVecs[2]).x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,l),e.getAbsolutePositionToRef(t,o),null==r&&i&&(r=i.length()),null!=r&&(o.x+=l.x*r,o.y+=l.y*r,o.z+=l.z*r),a.setAbsolutePosition(o)}}nq.DEFAULT_OBJECT_SIZE=new i1.P(1,1,1),nq.IDENTITY_QUATERNION=i1._f.Identity(),nq._TmpVecs=(0,r8.$G)(3,i1.P.Zero),nq._TmpQuat=i1._f.Identity(),nq.NoImpostor=0,nq.SphereImpostor=1,nq.BoxImpostor=2,nq.PlaneImpostor=3,nq.MeshImpostor=4,nq.CapsuleImpostor=6,nq.CylinderImpostor=7,nq.ParticleImpostor=8,nq.HeightmapImpostor=9,nq.ConvexHullImpostor=10,nq.CustomImpostor=100,nq.RopeImpostor=101,nq.ClothImpostor=102,nq.SoftbodyImpostor=103;var nQ=i(37542),nK=i(89754),nZ=i(62115),nJ=i(23596),n0=i(5848),n1=i(97937),n2=i(52821);class n3{static CreateBoneWeightShader(e,t){let i=e.skeleton,r=e.colorBase??i2.Wo.Black(),s=e.colorZero??i2.Wo.Blue(),n=e.colorQuarter??i2.Wo.Green(),a=e.colorHalf??i2.Wo.Yellow(),o=e.colorFull??i2.Wo.Red(),l=e.targetBoneIndex??0;n1.Q.ShadersStore["boneWeights:"+i.name+"VertexShader"]=`precision highp float;

        attribute vec3 position;
        attribute vec2 uv;

        uniform mat4 view;
        uniform mat4 projection;
        uniform mat4 worldViewProjection;

        #include<bonesDeclaration>
        #if NUM_BONE_INFLUENCERS == 0
            attribute vec4 matricesIndices;
            attribute vec4 matricesWeights;
        #endif
        #include<bakedVertexAnimationDeclaration>

        #include<instancesDeclaration>

        varying vec3 vColor;

        uniform vec3 colorBase;
        uniform vec3 colorZero;
        uniform vec3 colorQuarter;
        uniform vec3 colorHalf;
        uniform vec3 colorFull;

        uniform float targetBoneIndex;

        void main() {
            vec3 positionUpdated = position;

            #include<instancesVertex>
            #include<bonesVertex>
            #include<bakedVertexAnimation>

            vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

            vec3 color = colorBase;
            float totalWeight = 0.;
            if(matricesIndices[0] == targetBoneIndex && matricesWeights[0] > 0.){
                totalWeight += matricesWeights[0];
            }
            if(matricesIndices[1] == targetBoneIndex && matricesWeights[1] > 0.){
                totalWeight += matricesWeights[1];
            }
            if(matricesIndices[2] == targetBoneIndex && matricesWeights[2] > 0.){
                totalWeight += matricesWeights[2];
            }
            if(matricesIndices[3] == targetBoneIndex && matricesWeights[3] > 0.){
                totalWeight += matricesWeights[3];
            }

            color = mix(color, colorZero, smoothstep(0., 0.25, totalWeight));
            color = mix(color, colorQuarter, smoothstep(0.25, 0.5, totalWeight));
            color = mix(color, colorHalf, smoothstep(0.5, 0.75, totalWeight));
            color = mix(color, colorFull, smoothstep(0.75, 1.0, totalWeight));
            vColor = color;

        gl_Position = projection * view * worldPos;
        }`,n1.Q.ShadersStore["boneWeights:"+i.name+"FragmentShader"]=`
            precision highp float;
            varying vec3 vPosition;

            varying vec3 vColor;

            void main() {
                vec4 color = vec4(vColor, 1.0);
                gl_FragColor = color;
            }
        `;let c=new nA.j("boneWeight:"+i.name,t,{vertex:"boneWeights:"+i.name,fragment:"boneWeights:"+i.name},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorBase","colorZero","colorQuarter","colorHalf","colorFull","targetBoneIndex"]});return c.setColor3("colorBase",r),c.setColor3("colorZero",s),c.setColor3("colorQuarter",n),c.setColor3("colorHalf",a),c.setColor3("colorFull",o),c.setFloat("targetBoneIndex",l),c.getClassName=()=>"BoneWeightShader",c.transparencyMode=n0.F.MATERIAL_OPAQUE,c}static CreateSkeletonMapShader(e,t){let i=e.skeleton,r=e.colorMap??[{color:new i2.Wo(1,.38,.18),location:0},{color:new i2.Wo(.59,.18,1),location:.2},{color:new i2.Wo(.59,1,.18),location:.4},{color:new i2.Wo(1,.87,.17),location:.6},{color:new i2.Wo(1,.17,.42),location:.8},{color:new i2.Wo(.17,.68,1),location:1}],s=i.bones.length+1,n=n3._CreateBoneMapColorBuffer(s,r,t),a=new nA.j("boneWeights:"+i.name,t,{vertexSource:`precision highp float;

            attribute vec3 position;
            attribute vec2 uv;

            uniform mat4 view;
            uniform mat4 projection;
            uniform mat4 worldViewProjection;
            uniform float colorMap[`+4*i.bones.length+`];

            #include<bonesDeclaration>
            #if NUM_BONE_INFLUENCERS == 0
                attribute vec4 matricesIndices;
                attribute vec4 matricesWeights;
            #endif
            #include<bakedVertexAnimationDeclaration>
            #include<instancesDeclaration>

            varying vec3 vColor;

            void main() {
                vec3 positionUpdated = position;

                #include<instancesVertex>
                #include<bonesVertex>
                #include<bakedVertexAnimation>

                vec3 color = vec3(0.);
                bool first = true;

                for (int i = 0; i < 4; i++) {
                    int boneIdx = int(matricesIndices[i]);
                    float boneWgt = matricesWeights[i];

                    vec3 c = vec3(colorMap[boneIdx * 4 + 0], colorMap[boneIdx * 4 + 1], colorMap[boneIdx * 4 + 2]);

                    if (boneWgt > 0.) {
                        if (first) {
                            first = false;
                            color = c;
                        } else {
                            color = mix(color, c, boneWgt);
                        }
                    }
                }

                vColor = color;

                vec4 worldPos = finalWorld * vec4(positionUpdated, 1.0);

                gl_Position = projection * view * worldPos;
            }`,fragmentSource:`
            precision highp float;
            varying vec3 vColor;

            void main() {
                vec4 color = vec4( vColor, 1.0 );
                gl_FragColor = color;
            }
            `},{attributes:["position","normal","matricesIndices","matricesWeights"],uniforms:["world","worldView","worldViewProjection","view","projection","viewProjection","colorMap"]});return a.setFloats("colorMap",n),a.getClassName=()=>"SkeletonMapShader",a.transparencyMode=n0.F.MATERIAL_OPAQUE,a}static _CreateBoneMapColorBuffer(e,t,i){let r=new na.c("temp",{width:e,height:1},i,!1),s=r.getContext(),n=s.createLinearGradient(0,0,e,0);t.forEach(e=>{n.addColorStop(e.location,e.color.toHexString())}),s.fillStyle=n,s.fillRect(0,0,e,1),r.update();let a=[],o=s.getImageData(0,0,e,1).data,l=1/255;for(let e=0;e<o.length;e++)a.push(o[e]*l);return r.dispose(),a}get scene(){return this._scene}get utilityLayer(){return this._utilityLayer}get isReady(){return this._ready}set ready(e){this._ready=e}get debugMesh(){return this._debugMesh}set debugMesh(e){this._debugMesh=e}get displayMode(){return this.options.displayMode||n3.DISPLAY_LINES}set displayMode(e){e>n3.DISPLAY_SPHERE_AND_SPURS&&(e=n3.DISPLAY_LINES),this.options.displayMode=e}constructor(e,t,i,r=!0,s=3,n={}){if(this.skeleton=e,this.mesh=t,this.autoUpdateBonesMatrices=r,this.renderingGroupId=s,this.options=n,this.color=i2.Wo.White(),this._debugLines=[],this._localAxes=null,this._isEnabled=!0,this._obs=null,this._scene=i,this._ready=!1,n.pauseAnimations=n.pauseAnimations??!0,n.returnToRest=n.returnToRest??!1,n.displayMode=n.displayMode??n3.DISPLAY_LINES,n.displayOptions=n.displayOptions??{},n.displayOptions.midStep=n.displayOptions.midStep??.235,n.displayOptions.midStepFactor=n.displayOptions.midStepFactor??.155,n.displayOptions.sphereBaseSize=n.displayOptions.sphereBaseSize??.15,n.displayOptions.sphereScaleUnit=n.displayOptions.sphereScaleUnit??2,n.displayOptions.sphereFactor=n.displayOptions.sphereFactor??.865,n.displayOptions.spurFollowsChild=n.displayOptions.spurFollowsChild??!1,n.displayOptions.showLocalAxes=n.displayOptions.showLocalAxes??!1,n.displayOptions.localAxesSize=n.displayOptions.localAxesSize??.075,n.computeBonesUsingShaders=n.computeBonesUsingShaders??!0,n.useAllBones=n.useAllBones??!0,this._boneIndices=new Set,!n.useAllBones){let e=t?.getVerticesData(st.o.MatricesIndicesKind),i=t?.getVerticesData(st.o.MatricesWeightsKind);if(e&&i)for(let t=0;t<e.length;++t){let r=e[t];0!==i[t]&&this._boneIndices.add(r)}}this._utilityLayer=new nW.x(this._scene,!1),this._utilityLayer.pickUtilitySceneFirst=!1,this._utilityLayer.utilityLayerScene.autoClearDepthAndStencil=!0;let a=this.options.displayMode||0;a>n3.DISPLAY_SPHERE_AND_SPURS&&(a=n3.DISPLAY_LINES),this.displayMode=a,this.update(),this._bindObs()}_bindObs(){this.displayMode===n3.DISPLAY_LINES&&(this._obs=this.scene.onBeforeRenderObservable.add(()=>{this._displayLinesUpdate()}))}update(){switch(this.displayMode){case n3.DISPLAY_LINES:this._displayLinesUpdate();break;case n3.DISPLAY_SPHERES:this._buildSpheresAndSpurs(!0);break;case n3.DISPLAY_SPHERE_AND_SPURS:this._buildSpheresAndSpurs(!1)}this._buildLocalAxes()}set isEnabled(e){this.isEnabled!==e&&(this._isEnabled=e,this.debugMesh&&this.debugMesh.setEnabled(e),e&&!this._obs?this._bindObs():!e&&this._obs&&(this.scene.onBeforeRenderObservable.remove(this._obs),this._obs=null))}get isEnabled(){return this._isEnabled}_getBonePosition(e,t,i,r=0,s=0,n=0){let a=i1.jp.Matrix[0],o=t.getParent();if(a.copyFrom(t.getLocalMatrix()),0!==r||0!==s||0!==n){let e=i1.jp.Matrix[1];i1.y3.IdentityToRef(e),e.setTranslationFromFloats(r,s,n),e.multiplyToRef(a,a)}o&&a.multiplyToRef(o.getAbsoluteMatrix(),a),a.multiplyToRef(i,a),e.x=a.m[12],e.y=a.m[13],e.z=a.m[14]}_getLinesForBonesWithLength(e,t){let i,r;let s=e.length;t?(i=t.getWorldMatrix(),r=t.position):(i=new i1.y3,r=e[0].position);let n=0;for(let t=0;t<s;t++){let s=e[t],a=this._debugLines[n];-1!==s._index&&(this._boneIndices.has(s.getIndex())||this.options.useAllBones)&&(a||(a=[i1.P.Zero(),i1.P.Zero()],this._debugLines[n]=a),this._getBonePosition(a[0],s,i),this._getBonePosition(a[1],s,i,0,s.length,0),a[0].subtractInPlace(r),a[1].subtractInPlace(r),n++)}}_getLinesForBonesNoLength(e){let t,i;let r=e.length,s=0,n=this.mesh;n?(t=n,i=n.position):(t=new rR.Y(""),i=e[0].position);for(let n=r-1;n>=0;n--){let r=e[n],a=r.getParent();if(!a||!this._boneIndices.has(r.getIndex())&&!this.options.useAllBones)continue;let o=this._debugLines[s];o||(o=[i1.P.Zero(),i1.P.Zero()],this._debugLines[s]=o),r.getAbsolutePositionToRef(t,o[0]),a.getAbsolutePositionToRef(t,o[1]),o[0].subtractInPlace(i),o[1].subtractInPlace(i),s++}n||t.dispose()}_revert(e){this.options.pauseAnimations&&(this.scene.animationsEnabled=e,this.utilityLayer.utilityLayerScene.animationsEnabled=e)}_getAbsoluteBindPoseToRef(e,t){if(null===e||-1===e._index){t.copyFrom(i1.y3.Identity());return}this._getAbsoluteBindPoseToRef(e.getParent(),t),e.getBindMatrix().multiplyToRef(t,t)}_createSpur(e,t,i,r,s,n){let a=i.subtract(e),o=a.length(),l=a.normalize().scale(o),c=s.midStep||.165,u=s.midStepFactor||.215,h=l.scale(c),d=(0,n2.bC)("skeletonViewer",{shape:[new i1.P(1,-1,0),new i1.P(1,1,0),new i1.P(-1,1,0),new i1.P(-1,-1,0),new i1.P(1,-1,0)],path:[i1.P.Zero(),h,l],scaleFunction:e=>{switch(e){case 0:case 2:break;case 1:return o*u}return 0},sideOrientation:rP.Kj.DEFAULTSIDE,updatable:!1},n),f=d.getTotalVertices(),p=[],m=[];for(let e=0;e<f;e++)p.push(1,0,0,0),r&&s.spurFollowsChild&&e>9?m.push(r.getIndex(),0,0,0):m.push(t.getIndex(),0,0,0);return d.position=e.clone(),d.setVerticesData(st.o.MatricesWeightsKind,p,!1),d.setVerticesData(st.o.MatricesIndicesKind,m,!1),d.convertToFlatShadedMesh(),d}_getBoundingSphereForBone(e){if(!this.mesh)return null;let t=this.mesh.getVerticesData(st.o.PositionKind),i=this.mesh.getIndices(),r=this.mesh.getVerticesData(st.o.MatricesWeightsKind),s=this.mesh.getVerticesData(st.o.MatricesIndicesKind);if(!t||!i||!r||!s)return null;let n=new i1.P(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),a=new i1.P(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),o=0;for(let l=0;l<i.length;++l){let c=i[l];for(let i=0;i<4;++i){let l=s[4*c+i],u=r[4*c+i];if(l===e&&u>1e-5){i1.P.FromArrayToRef(t,3*c,i1.jp.Vector3[0]),n.minimizeInPlace(i1.jp.Vector3[0]),a.maximizeInPlace(i1.jp.Vector3[0]),o++;break}}}return o>1?{center:i1.P.Center(n,a),radius:i1.P.Distance(n,a)/2}:null}_buildSpheresAndSpurs(e=!0){this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this._ready=!1;let t=this.utilityLayer?.utilityLayerScene,i=this.skeleton.bones,r=[],s=[],n=this.scene.animationsEnabled;try{this.options.pauseAnimations&&(this.scene.animationsEnabled=!1,t.animationsEnabled=!1),this.options.returnToRest&&this.skeleton.returnToRest(),this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices();let a=Number.NEGATIVE_INFINITY,o=this.options.displayOptions||{};for(let n=0;n<i.length;n++){let l=i[n];if(-1===l._index||!this._boneIndices.has(l.getIndex())&&!this.options.useAllBones)continue;let c=new i1.y3;this._getAbsoluteBindPoseToRef(l,c);let u=new i1.P;if(c.decompose(void 0,void 0,u),l.children.length>0)l.children.forEach(i=>{let r=new i1.y3;i.getLocalMatrix().multiplyToRef(c,r);let n=new i1.P;r.decompose(void 0,void 0,n);let h=i1.P.Distance(u,n);h>a&&(a=h),e||s.push(this._createSpur(u,l,n,i,o,t))});else{let i=this._getBoundingSphereForBone(l.getIndex());if(i&&(i.radius>a&&(a=i.radius),!e)){let e;let r=l.getParent();r?(this._getAbsoluteBindPoseToRef(r,c),c.decompose(void 0,void 0,i1.jp.Vector3[0]),e=u.subtract(i1.jp.Vector3[0]).normalize().scale(i.radius).add(u)):e=i.center.subtract(u).normalize().scale(i.radius).add(u),s.push(this._createSpur(u,l,e,null,o,t))}}let h=o.sphereBaseSize||.2,d=(0,n$.Qk)("skeletonViewer",{segments:6,diameter:h,updatable:!0},t),f=d.getTotalVertices(),p=[],m=[];for(let e=0;e<f;e++)p.push(1,0,0,0),m.push(l.getIndex(),0,0,0);d.setVerticesData(st.o.MatricesWeightsKind,p,!1),d.setVerticesData(st.o.MatricesIndicesKind,m,!1),d.position=u.clone(),r.push([d,l])}let l=o.sphereScaleUnit||2,c=o.sphereFactor||.85,u=[];for(let e=0;e<r.length;e++){let[t,i]=r[e],s=1/(l/a),n=0,o=i;for(;o.getParent()&&-1!==o.getParent().getIndex();)n++,o=o.getParent();t.scaling.scaleInPlace(s*Math.pow(c,n)),u.push(t)}this.debugMesh=rP.Kj.MergeMeshes(u.concat(s),!0,!0),this.debugMesh&&(this.debugMesh.renderingGroupId=this.renderingGroupId,this.debugMesh.skeleton=this.skeleton,this.debugMesh.parent=this.mesh,this.debugMesh.computeBonesUsingShaders=this.options.computeBonesUsingShaders??!0,this.debugMesh.alwaysSelectAsActiveMesh=!0),this.utilityLayer._getSharedGizmoLight().intensity=.7,this._revert(n),this.ready=!0}catch(e){re.Y.Error(e),this._revert(n),this.dispose()}}_buildLocalAxes(){this._localAxes&&this._localAxes.dispose(),this._localAxes=null;let e=this.options.displayOptions||{};if(!e.showLocalAxes)return;let t=this._utilityLayer.utilityLayerScene,i=e.localAxesSize||.075,r=[],s=[],n=new i2.HE(1,0,0,1),a=new i2.HE(0,1,0,1),o=new i2.HE(0,0,1,1),l=[],c=[];for(let e in this.skeleton.bones){let t=this.skeleton.bones[e];if(-1===t._index||!this._boneIndices.has(t.getIndex())&&!this.options.useAllBones)continue;let u=new i1.y3,h=new i1.P;this._getAbsoluteBindPoseToRef(t,u),u.decompose(void 0,i1.jp.Quaternion[0],h);let d=new i1.y3;i1.jp.Quaternion[0].toRotationMatrix(d);let f=i1.P.TransformCoordinates(new i1.P(0+i,0,0),d),p=i1.P.TransformCoordinates(new i1.P(0,0+i,0),d),m=i1.P.TransformCoordinates(new i1.P(0,0,0+i),d),_=[[h,h.add(f)],[h,h.add(p)],[h,h.add(m)]],g=[[n,n],[a,a],[o,o]];r.push(..._),s.push(...g);for(let e=0;e<6;e++)l.push(1,0,0,0),c.push(t.getIndex(),0,0,0)}this._localAxes=(0,nJ.xW)("localAxes",{lines:r,colors:s,updatable:!0},t),this._localAxes.setVerticesData(st.o.MatricesWeightsKind,l,!1),this._localAxes.setVerticesData(st.o.MatricesIndicesKind,c,!1),this._localAxes.skeleton=this.skeleton,this._localAxes.renderingGroupId=this.renderingGroupId+1,this._localAxes.parent=this.mesh,this._localAxes.computeBonesUsingShaders=this.options.computeBonesUsingShaders??!0}_displayLinesUpdate(){if(!this._utilityLayer)return;this.autoUpdateBonesMatrices&&this.skeleton.computeAbsoluteMatrices(),void 0===this.skeleton.bones[0].length?this._getLinesForBonesNoLength(this.skeleton.bones):this._getLinesForBonesWithLength(this.skeleton.bones,this.mesh);let e=this._utilityLayer.utilityLayerScene;e&&(this._debugMesh?(0,nJ.xW)("",{lines:this._debugLines,updatable:!0,instance:this._debugMesh},e):(this._debugMesh=(0,nJ.xW)("",{lines:this._debugLines,updatable:!0,instance:null},e),this._debugMesh.renderingGroupId=this.renderingGroupId),this.mesh?this._debugMesh.position.copyFrom(this.mesh.position):this._debugMesh.position.copyFrom(this.skeleton.bones[0].position),this._debugMesh.color=this.color)}changeDisplayMode(e){let t=!!this.isEnabled;this.displayMode!==e&&(this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.displayMode=e,this.update(),this._bindObs(),this.isEnabled=t)}changeDisplayOptions(e,t){let i=!!this.isEnabled;this.options.displayOptions[e]=t,this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null,this.ready=!1),this.update(),this._bindObs(),this.isEnabled=i}dispose(){this.isEnabled=!1,this._debugMesh&&(this._debugMesh.dispose(),this._debugMesh=null),this._utilityLayer&&(this._utilityLayer.dispose(),this._utilityLayer=null),this.ready=!1}}n3.DISPLAY_LINES=0,n3.DISPLAY_SPHERES=1,n3.DISPLAY_SPHERE_AND_SPURS=2,i(78383),i(1244),i(14286),i(58535);var n4=i(46263);i(29281);var n5=i(22265),n7=i(44673);i(34995),i(94140),i(97531),i(8821);class n6{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=rA.x.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=rA.x.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}rV.a.prototype.getGPUFrameTimeCounter=function(){return null},rV.a.prototype.captureGPUFrameTime=function(e){},rV.a.prototype.createQuery=function(){return null},rV.a.prototype.deleteQuery=function(e){return this},rV.a.prototype.isQueryResultAvailable=function(e){return!1},rV.a.prototype.getQueryResult=function(e){return 0},rV.a.prototype.beginOcclusionQuery=function(e,t){return!1},rV.a.prototype.endOcclusionQuery=function(e){return this},Object.defineProperty(rA.x.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(e){this._occlusionDataStorage.isOcclusionQueryInProgress=e},enumerable:!1,configurable:!0}),Object.defineProperty(rA.x.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new n6),this.__occlusionDataStorage},enumerable:!1,configurable:!0}),Object.defineProperty(rA.x.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(e){this._occlusionDataStorage.isOccluded=e},enumerable:!0,configurable:!0}),Object.defineProperty(rA.x.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(e){this._occlusionDataStorage.occlusionQueryAlgorithmType=e},enumerable:!0,configurable:!0}),Object.defineProperty(rA.x.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(e){this._occlusionDataStorage.occlusionType=e},enumerable:!0,configurable:!0}),Object.defineProperty(rA.x.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(e){this._occlusionDataStorage.occlusionRetryCount=e},enumerable:!0,configurable:!0}),Object.defineProperty(rA.x.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(e){this._occlusionDataStorage.forceRenderingWhenOccluded=e},enumerable:!0,configurable:!0}),rA.x.prototype._checkOcclusionQuery=function(){let e=this._occlusionDataStorage;if(e.occlusionType===rA.x.OCCLUSION_TYPE_NONE)return e.isOccluded=!1,!1;let t=this.getEngine();if(!t.getCaps().supportOcclusionQuery||!t.isQueryResultAvailable)return e.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&null!==this._occlusionQuery&&void 0!==this._occlusionQuery){if(t.isQueryResultAvailable(this._occlusionQuery)){let i=t.getQueryResult(this._occlusionQuery);e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=!(i>0)}else{if(e.occlusionInternalRetryCounter++,-1===e.occlusionRetryCount||!(e.occlusionInternalRetryCounter>e.occlusionRetryCount))return e.occlusionType!==rA.x.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded;e.isOcclusionQueryInProgress=!1,e.occlusionInternalRetryCounter=0,e.isOccluded=e.occlusionType!==rA.x.OCCLUSION_TYPE_OPTIMISTIC&&e.isOccluded}}let i=this.getScene();if(i.getBoundingBoxRenderer){let r=i.getBoundingBoxRenderer();null===this._occlusionQuery&&(this._occlusionQuery=t.createQuery()),this._occlusionQuery&&t.beginOcclusionQuery(e.occlusionQueryAlgorithmType,this._occlusionQuery)&&(r.renderOcclusionBoundingBox(this),t.endOcclusionQuery(e.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return e.isOccluded},i(80123),i(89399),i(82045);let n8=new i0.y$,n9=new i0.y$;Object.defineProperty(rV.a.prototype,"onBeforeViewRenderObservable",{get:function(){return n8}}),Object.defineProperty(rV.a.prototype,"onAfterViewRenderObservable",{get:function(){return n9}}),Object.defineProperty(rV.a.prototype,"inputElement",{get:function(){return this._inputElement},set:function(e){this._inputElement!==e&&(this._inputElement=e,this._onEngineViewChanged?.())}}),rV.a.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()},rV.a.prototype.registerView=function(e,t,i){for(let t of(this.views||(this.views=[]),this.views))if(t.target===e)return t;let r=this.getRenderingCanvas();r&&(e.width=r.width,e.height=r.height);let s={target:e,camera:t,clearBeforeCopy:i,enabled:!0,id:(1e5*Math.random()).toFixed()};return this.views.push(s),t&&!Array.isArray(t)&&t.onDisposeObservable.add(()=>{this.unRegisterView(e)}),s},rV.a.prototype.unRegisterView=function(e){if(!this.views||0===this.views.length)return this;for(let t of this.views)if(t.target===e){let e=this.views.indexOf(t);-1!==e&&this.views.splice(e,1);break}return this},rV.a.prototype._renderViewStep=function(e){let t=e.target,i=t.getContext("2d");if(!i)return!0;let r=this.getRenderingCanvas();n8.notifyObservers(e);let s=e.camera,n=null,a=null,o=null;if(s&&(n=(o=Array.isArray(s)?s[0].getScene():s.getScene()).activeCamera,a=o.activeCameras,Array.isArray(s)?o.activeCameras=s:(o.activeCamera=s,o.activeCameras=null)),this.activeView=e,e.customResize)e.customResize(t);else{let e=Math.floor(t.clientWidth/this._hardwareScalingLevel),i=Math.floor(t.clientHeight/this._hardwareScalingLevel),s=e!==t.width||r.width!==t.width||i!==t.height||r.height!==t.height;t.clientWidth&&t.clientHeight&&s&&(t.width=e,t.height=i,this.setSize(e,i))}return!!r.width&&!!r.height&&(this._renderFrame(),this.flushFramebuffer(),e.clearBeforeCopy&&i.clearRect(0,0,r.width,r.height),i.drawImage(r,0,0),o&&(o.activeCameras=a,o.activeCamera=n),n9.notifyObservers(e),!0)},rV.a.prototype._renderViews=function(){let e;if(!this.views||0===this.views.length||!this.getRenderingCanvas())return!1;for(let t of this.views)if(t.enabled){if(t.target===this.inputElement){e=t;continue}if(!this._renderViewStep(t))return!1}return(!e||!!this._renderViewStep(e))&&(this.activeView=null,!0)},i(95330),rV.a.prototype._debugPushGroup=function(e,t){},rV.a.prototype._debugPopGroup=function(e){},rV.a.prototype._debugInsertMarker=function(e,t){},rV.a.prototype._debugFlushPendingCommands=function(){};class ae{constructor(){this._timeElapsedQueryEnded=!1}}var at=i(51366);function ai(e){if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(t=>e&&(e===t||e.match(RegExp("\\b"+t+"\\b","g")))))return e;let t=e.lastIndexOf("."),i=e.lastIndexOf("?"),r=i>-1?e.substring(i,e.length):"";return(t>-1?e.substring(0,t):e)+this._textureFormatInUse+r}sJ.D.prototype.createQuery=function(){let e=this._gl.createQuery();if(!e)throw Error("Unable to create Occlusion Query");return e},sJ.D.prototype.deleteQuery=function(e){return this._gl.deleteQuery(e),this},sJ.D.prototype.isQueryResultAvailable=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT_AVAILABLE)},sJ.D.prototype.getQueryResult=function(e){return this._gl.getQueryParameter(e,this._gl.QUERY_RESULT)},sJ.D.prototype.beginOcclusionQuery=function(e,t){let i=this._getGlAlgorithmType(e);return this._gl.beginQuery(i,t),!0},sJ.D.prototype.endOcclusionQuery=function(e){let t=this._getGlAlgorithmType(e);return this._gl.endQuery(t),this},sJ.D.prototype._createTimeQuery=function(){let e=this.getCaps().timerQuery;return e.createQueryEXT?e.createQueryEXT():this.createQuery()},sJ.D.prototype._deleteTimeQuery=function(e){let t=this.getCaps().timerQuery;if(t.deleteQueryEXT){t.deleteQueryEXT(e);return}this.deleteQuery(e)},sJ.D.prototype._getTimeQueryResult=function(e){let t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_EXT):this.getQueryResult(e)},sJ.D.prototype._getTimeQueryAvailability=function(e){let t=this.getCaps().timerQuery;return t.getQueryObjectEXT?t.getQueryObjectEXT(e,t.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(e)},sJ.D.prototype.startTimeQuery=function(){let e=this.getCaps(),t=e.timerQuery;if(!t)return null;let i=new ae;if(this._gl.getParameter(t.GPU_DISJOINT_EXT),e.canUseTimestampForTimerQuery)i._startTimeQuery=this._createTimeQuery(),i._startTimeQuery&&t.queryCounterEXT(i._startTimeQuery,t.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;i._timeElapsedQuery=this._createTimeQuery(),i._timeElapsedQuery&&(t.beginQueryEXT?t.beginQueryEXT(t.TIME_ELAPSED_EXT,i._timeElapsedQuery):this._gl.beginQuery(t.TIME_ELAPSED_EXT,i._timeElapsedQuery)),this._currentNonTimestampToken=i}return i},sJ.D.prototype.endTimeQuery=function(e){let t=this.getCaps(),i=t.timerQuery;if(!i||!e)return -1;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery)return -1;!e._endTimeQuery&&(e._endTimeQuery=this._createTimeQuery(),e._endTimeQuery&&i.queryCounterEXT(e._endTimeQuery,i.TIMESTAMP_EXT))}else if(!e._timeElapsedQueryEnded){if(!e._timeElapsedQuery)return -1;i.endQueryEXT?i.endQueryEXT(i.TIME_ELAPSED_EXT):(this._gl.endQuery(i.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),e._timeElapsedQueryEnded=!0}let r=this._gl.getParameter(i.GPU_DISJOINT_EXT),s=!1;if(e._endTimeQuery?s=this._getTimeQueryAvailability(e._endTimeQuery):e._timeElapsedQuery&&(s=this._getTimeQueryAvailability(e._timeElapsedQuery)),s&&!r){let i=0;if(t.canUseTimestampForTimerQuery){if(!e._startTimeQuery||!e._endTimeQuery)return -1;let t=this._getTimeQueryResult(e._startTimeQuery);i=this._getTimeQueryResult(e._endTimeQuery)-t,this._deleteTimeQuery(e._startTimeQuery),this._deleteTimeQuery(e._endTimeQuery),e._startTimeQuery=null,e._endTimeQuery=null}else{if(!e._timeElapsedQuery)return -1;i=this._getTimeQueryResult(e._timeElapsedQuery),this._deleteTimeQuery(e._timeElapsedQuery),e._timeElapsedQuery=null,e._timeElapsedQueryEnded=!1}return i}return -1},sJ.D.prototype._captureGPUFrameTime=!1,sJ.D.prototype._gpuFrameTime=new at.z,sJ.D.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime},sJ.D.prototype.captureGPUFrameTime=function(e){e!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=e,e?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;let e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))},sJ.D.prototype._getGlAlgorithmType=function(e){return e===rA.x.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED},sJ.D.prototype.createTransformFeedback=function(){let e=this._gl.createTransformFeedback();if(!e)throw Error("Unable to create Transform Feedback");return e},sJ.D.prototype.deleteTransformFeedback=function(e){this._gl.deleteTransformFeedback(e)},sJ.D.prototype.bindTransformFeedback=function(e){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,e)},sJ.D.prototype.beginTransformFeedback=function(e=!0){this._gl.beginTransformFeedback(e?this._gl.POINTS:this._gl.TRIANGLES)},sJ.D.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()},sJ.D.prototype.setTranformFeedbackVaryings=function(e,t){this._gl.transformFeedbackVaryings(e,t,this._gl.INTERLEAVED_ATTRIBS)},sJ.D.prototype.bindTransformFeedbackBuffer=function(e){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e?e.underlyingResource:null)},sJ.D.prototype.readTransformFeedbackBuffer=function(e){this._gl.getBufferSubData(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,e)},i(40067),i(91410),n4.ThinEngine.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;let r=this._getInternalFormat(e.format),s=this._getRGBABufferInternalSizedFormat(0,e.format),n=this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0);this._unpackFlipY(!i);try{if(void 0===this._videoTextureSupported&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,r,this._gl.UNSIGNED_BYTE,t),0!==this._gl.getError()?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,r,this._gl.UNSIGNED_BYTE,t);else{if(!e._workingCanvas){e._workingCanvas=this.createCanvas(e.width,e.height);let t=e._workingCanvas.getContext("2d");if(!t)throw Error("Unable to get 2d context");e._workingContext=t,e._workingCanvas.width=e.width,e._workingCanvas.height=e.height}e._workingContext.clearRect(0,0,e.width,e.height),e._workingContext.drawImage(t,0,0,t.videoWidth,t.videoHeight,0,0,e.width,e.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,s,r,this._gl.UNSIGNED_BYTE,e._workingCanvas)}e.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),n||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),e.isReady=!0}catch(t){e._isDisabled=!0}},n4.ThinEngine.prototype.restoreSingleAttachment=function(){let e=this._gl;this.bindAttachments([e.BACK])},n4.ThinEngine.prototype.restoreSingleAttachmentForRenderTarget=function(){let e=this._gl;this.bindAttachments([e.COLOR_ATTACHMENT0])},n4.ThinEngine.prototype.buildTextureLayout=function(e){let t=this._gl,i=[];for(let r=0;r<e.length;r++)e[r]?i.push(t["COLOR_ATTACHMENT"+r]):i.push(t.NONE);return i},n4.ThinEngine.prototype.bindAttachments=function(e){this._gl.drawBuffers(e)},n4.ThinEngine.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){this._currentRenderTarget=null;let r=this._gl,s=e._attachments,n=s.length;if(e._MSAAFramebuffer){r.bindFramebuffer(r.READ_FRAMEBUFFER,e._MSAAFramebuffer),r.bindFramebuffer(r.DRAW_FRAMEBUFFER,e._framebuffer);for(let t=0;t<n;t++){let i=e.textures[t];for(let e=0;e<n;e++)s[e]=r.NONE;s[t]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],r.readBuffer(s[t]),r.drawBuffers(s),r.blitFramebuffer(0,0,i.width,i.height,0,0,i.width,i.height,r.COLOR_BUFFER_BIT,r.NEAREST)}for(let e=0;e<n;e++)s[e]=r[this.webGLVersion>1?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];r.drawBuffers(s)}for(let i=0;i<n;i++){let s=e.textures[i];!s?.generateMipMaps||t||s?.isCube||s?.is3D||(this._bindTextureDirectly(r.TEXTURE_2D,s,!0),r.generateMipmap(r.TEXTURE_2D),this._bindTextureDirectly(r.TEXTURE_2D,null))}i&&(e._MSAAFramebuffer&&this._bindUnboundFramebuffer(e._framebuffer),i()),this._bindUnboundFramebuffer(null)},n4.ThinEngine.prototype.createMultipleRenderTarget=function(e,t,i=!0){let r=!1,s=!0,n=!1,a=!1,o=15,l=1,c=[],u=[],h=[],d=[],f=[],p=[],m=[],_=[],g=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(r=void 0!==t.generateMipMaps&&t.generateMipMaps,s=void 0===t.generateDepthBuffer||t.generateDepthBuffer,n=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,a=void 0!==t.generateDepthTexture&&t.generateDepthTexture,l=t.textureCount||1,t.types&&(c=t.types),t.samplingModes&&(u=t.samplingModes),t.useSRGBBuffers&&(h=t.useSRGBBuffers),t.formats&&(d=t.formats),t.targetTypes&&(f=t.targetTypes),t.faceIndex&&(p=t.faceIndex),t.layerIndex&&(m=t.layerIndex),t.layerCounts&&(_=t.layerCounts),this.webGLVersion>1&&(13===t.depthTextureFormat||17===t.depthTextureFormat||16===t.depthTextureFormat||14===t.depthTextureFormat||18===t.depthTextureFormat)&&(o=t.depthTextureFormat)),g.label=t?.label??"MultiRenderTargetWrapper";let v=this._gl,S=v.createFramebuffer();this._bindUnboundFramebuffer(S);let x=e.width||e,E=e.height||e,C=[],T=[],b=this.webGLVersion>1&&a&&(13===t.depthTextureFormat||17===t.depthTextureFormat||18===t.depthTextureFormat),y=this._setupFramebufferDepthAttachments(!b&&n,!a&&s,x,E);g._framebuffer=S,g._depthStencilBuffer=y,g._generateDepthBuffer=!a&&s,g._generateStencilBuffer=!b&&n,g._attachments=T;for(let e=0;e<l;e++){let t=u[e]||3,i=c[e]||0,s=h[e]||!1,n=d[e]||5,a=f[e]||3553,o=_[e]??1;(1!==i||this._caps.textureFloatLinearFiltering)&&(2!==i||this._caps.textureHalfFloatLinearFiltering)||(t=1);let l=this._getSamplingParameters(t,r);1!==i||this._caps.textureFloat||(i=0,re.Y.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),s=s&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);let p=this.webGLVersion>1,m=v[p?"COLOR_ATTACHMENT"+e:"COLOR_ATTACHMENT"+e+"_WEBGL"];if(T.push(m),-1===a)continue;let g=new s0.l(this,6);C[e]=g,v.activeTexture(v["TEXTURE"+e]),v.bindTexture(a,g._hardwareTexture.underlyingResource),v.texParameteri(a,v.TEXTURE_MAG_FILTER,l.mag),v.texParameteri(a,v.TEXTURE_MIN_FILTER,l.min),v.texParameteri(a,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(a,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE);let S=this._getRGBABufferInternalSizedFormat(i,n,s),b=this._getInternalFormat(n),y=this._getWebGLTextureType(i);if(p&&(35866===a||32879===a))35866===a?g.is2DArray=!0:g.is3D=!0,g.baseDepth=g.depth=o,v.texImage3D(a,0,S,x,E,o,0,b,y,null);else if(34067===a){for(let e=0;e<6;e++)v.texImage2D(v.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,S,x,E,0,b,y,null);g.isCube=!0}else v.texImage2D(v.TEXTURE_2D,0,S,x,E,0,b,y,null);r&&v.generateMipmap(a),this._bindTextureDirectly(a,null),g.baseWidth=x,g.baseHeight=E,g.width=x,g.height=E,g.isReady=!0,g.samples=1,g.generateMipMaps=r,g.samplingMode=t,g.type=i,g._useSRGBBuffer=s,g.format=n,this._internalTexturesCache.push(g)}if(a&&this._caps.depthTextureExtension){let e=new s0.l(this,14),t=5,i=v.DEPTH_COMPONENT16,s=v.DEPTH_COMPONENT,n=v.UNSIGNED_SHORT,a=v.DEPTH_ATTACHMENT;this.webGLVersion<2?i=v.DEPTH_COMPONENT:14===o?(t=1,n=v.FLOAT,i=v.DEPTH_COMPONENT32F):18===o?(t=0,n=v.FLOAT_32_UNSIGNED_INT_24_8_REV,i=v.DEPTH32F_STENCIL8,s=v.DEPTH_STENCIL,a=v.DEPTH_STENCIL_ATTACHMENT):16===o?(t=0,n=v.UNSIGNED_INT,i=v.DEPTH_COMPONENT24,a=v.DEPTH_ATTACHMENT):(13===o||17===o)&&(t=12,n=v.UNSIGNED_INT_24_8,i=v.DEPTH24_STENCIL8,s=v.DEPTH_STENCIL,a=v.DEPTH_STENCIL_ATTACHMENT),v.activeTexture(v.TEXTURE0),v.bindTexture(v.TEXTURE_2D,e._hardwareTexture.underlyingResource),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.NEAREST),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.NEAREST),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),v.texImage2D(v.TEXTURE_2D,0,i,x,E,0,s,n,null),v.framebufferTexture2D(v.FRAMEBUFFER,a,v.TEXTURE_2D,e._hardwareTexture.underlyingResource,0),e.baseWidth=x,e.baseHeight=E,e.width=x,e.height=E,e.isReady=!0,e.samples=1,e.generateMipMaps=r,e.samplingMode=1,e.format=o,e.type=t,C[l]=e,this._internalTexturesCache.push(e)}return g.setTextures(C),i&&v.drawBuffers(T),this._bindUnboundFramebuffer(null),g.setLayerAndFaceIndices(m,p),this.resetTextureCache(),g},n4.ThinEngine.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t,i=!0){if(this.webGLVersion<2||!e||!e.texture)return 1;if(e.samples===t)return t;let r=e._attachments.length;if(0===r)return 1;let s=this._gl;t=Math.min(t,this.getCaps().maxMSAASamples);let n=!!e._depthStencilBuffer;if(n&&(s.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=null),e._MSAAFramebuffer&&(s.deleteFramebuffer(e._MSAAFramebuffer),e._MSAAFramebuffer=null),t>1&&"function"==typeof s.renderbufferStorageMultisample){let n=s.createFramebuffer();if(!n)throw Error("Unable to create multi sampled framebuffer");e._MSAAFramebuffer=n,this._bindUnboundFramebuffer(n);let a=[];for(let t=0;t<r;t++)e.textures[t]._hardwareTexture.releaseMSAARenderBuffers();for(let i=0;i<r;i++){let r=e.textures[i],n=r._hardwareTexture,o=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+i:"COLOR_ATTACHMENT"+i+"_WEBGL"],l=this._createRenderBuffer(r.width,r.height,t,-1,this._getRGBABufferInternalSizedFormat(r.type,r.format,r._useSRGBBuffer),o);if(!l)throw Error("Unable to create multi sampled framebuffer");n.addMSAARenderBuffer(l),r.samples=t,a.push(o)}i&&s.drawBuffers(a)}else this._bindUnboundFramebuffer(e._framebuffer);return n&&(e._depthStencilBuffer=this._setupFramebufferDepthAttachments(e._generateStencilBuffer,e._generateDepthBuffer,e.texture.width,e.texture.height,t)),this._bindUnboundFramebuffer(null),t},i(38679),i(27344),i(39936),i(57694),i(69662),i(15732),i(63296),i(77102),(o=tr||(tr={}))[o.Texture=0]="Texture",o[o.StorageTexture=1]="StorageTexture",o[o.UniformBuffer=2]="UniformBuffer",o[o.StorageBuffer=3]="StorageBuffer",o[o.TextureWithoutSampler=4]="TextureWithoutSampler",o[o.Sampler=5]="Sampler",o[o.ExternalTexture=6]="ExternalTexture",o[o.DataBuffer=7]="DataBuffer",n4.ThinEngine.prototype.createComputeEffect=function(e,t){throw Error("createComputeEffect: This engine does not support compute shaders!")},n4.ThinEngine.prototype.createComputePipelineContext=function(){throw Error("createComputePipelineContext: This engine does not support compute shaders!")},n4.ThinEngine.prototype.createComputeContext=function(){},n4.ThinEngine.prototype.computeDispatch=function(e,t,i,r,s,n,a){throw Error("computeDispatch: This engine does not support compute shaders!")},n4.ThinEngine.prototype.computeDispatchIndirect=function(e,t,i,r,s,n){throw Error("computeDispatchIndirect: This engine does not support compute shaders!")},n4.ThinEngine.prototype.areAllComputeEffectsReady=function(){return!0},n4.ThinEngine.prototype.releaseComputeEffects=function(){},n4.ThinEngine.prototype._prepareComputePipelineContext=function(e,t,i,r,s){},n4.ThinEngine.prototype._rebuildComputeEffects=function(){},rV.a.prototype._executeWhenComputeStateIsCompiled=function(e,t){t(null)},n4.ThinEngine.prototype._releaseComputeEffect=function(e){},n4.ThinEngine.prototype._deleteComputePipelineContext=function(e){},Object.defineProperty(sJ.D.prototype,"texturesSupported",{get:function(){let e=[];return this._caps.astc&&e.push("-astc.ktx"),this._caps.s3tc&&e.push("-dxt.ktx"),this._caps.pvrtc&&e.push("-pvrtc.ktx"),this._caps.etc2&&e.push("-etc2.ktx"),this._caps.etc1&&e.push("-etc1.ktx"),e},enumerable:!0,configurable:!0}),Object.defineProperty(sJ.D.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0}),sJ.D.prototype.setCompressedTextureExclusions=function(e){this._excludedCompressedTextures=e},sJ.D.prototype.setTextureFormatToUse=function(e){let t=this.texturesSupported;for(let i=0,r=t.length;i<r;i++)for(let r=0,s=e.length;r<s;r++)if(t[i]===e[r].toLowerCase())return this._transformTextureUrl=ai.bind(this),this._textureFormatInUse=t[i];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class ar{constructor(){let e=new ArrayBuffer(ar.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=ar.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}ar.DEFAULT_BUFFER_SIZE=65536;var as=i(56959),an=i(32985),aa=i(2463);let ao=/(flat\s)?\s*varying\s*.*/;class al{constructor(){this.shaderLanguage=0}initializeShaders(e){this._nativeProcessingContext=e,this._nativeProcessingContext&&(this._nativeProcessingContext.remappedAttributeNames={},this._nativeProcessingContext.injectInVertexMain="")}attributeProcessor(e){if(!this._nativeProcessingContext)return e.replace("attribute","in");let t=/\s*(?:attribute|in)\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==t){let i=t[1],r=t[2],s=this._nativeProcessingContext.vertexBufferKindToNumberOfComponents[r];if(void 0!==s){let n=`_int_${r}_`;e=e.replace(t[0],`in ${s<0?-1===s?"int":"ivec"+-s:1===s?"uint":"uvec"+s} ${n}; ${i} ${r};`),this._nativeProcessingContext.injectInVertexMain+=`${r} = ${i}(${n});
`,this._nativeProcessingContext.remappedAttributeNames[r]=n}else e=e.replace(t[0],`in ${i} ${r};`)}return e}varyingCheck(e,t){return ao.test(e)}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){let r=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){let t=-1!==e.search(/layout *\(location *= *0\) *out/g);e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/void\s+?main\s*\(/g,(r||t?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(")}else if(this._nativeProcessingContext?.injectInVertexMain&&(e=(0,aa.e0)(e,"void main",this._nativeProcessingContext.injectInVertexMain)),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;return e}}class ac{get isReady(){if(this.compilationError){let e=this.compilationError.message;throw Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return this.isCompiled}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}constructor(e,t,i){this.isCompiled=!1,this.vertexBufferKindToType={},this._valueCache={},this._engine=e,this.isAsync=t,this.shaderProcessingContext=i}_fillEffectInformation(e,t,i,r,s,n,a,o){let l;let c=this._engine;if(c.supportsUniformBuffers)for(let i in t)e.bindUniformBlock(i,t[i]);for(this._engine.getUniforms(this,i).forEach((e,t)=>{r[i[t]]=e}),this._uniforms=r,l=0;l<s.length;l++)null==e.getUniform(s[l])&&(s.splice(l,1),l--);s.forEach((e,t)=>{n[e]=t}),o.push(...c.getAttributes(this,a))}setEngine(e){this._engine=e}dispose(){this._uniforms={}}_cacheMatrix(e,t){let i=this._valueCache[e],r=t.updateFlag;return(void 0===i||i!==r)&&(this._valueCache[e]=r,!0)}_cacheFloat2(e,t,i){let r=this._valueCache[e];if(!r)return r=[t,i],this._valueCache[e]=r,!0;let s=!1;return r[0]!==t&&(r[0]=t,s=!0),r[1]!==i&&(r[1]=i,s=!0),s}_cacheFloat3(e,t,i,r){let s=this._valueCache[e];if(!s)return s=[t,i,r],this._valueCache[e]=s,!0;let n=!1;return s[0]!==t&&(s[0]=t,n=!0),s[1]!==i&&(s[1]=i,n=!0),s[2]!==r&&(s[2]=r,n=!0),n}_cacheFloat4(e,t,i,r,s){let n=this._valueCache[e];if(!n)return n=[t,i,r,s],this._valueCache[e]=n,!0;let a=!1;return n[0]!==t&&(n[0]=t,a=!0),n[1]!==i&&(n[1]=i,a=!0),n[2]!==r&&(n[2]=r,a=!0),n[3]!==s&&(n[3]=s,a=!0),a}setInt(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&!this._engine.setInt2(this._uniforms[e],t,i)&&(this._valueCache[e]=null)}setInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&!this._engine.setInt3(this._uniforms[e],t,i,r)&&(this._valueCache[e]=null)}setInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&!this._engine.setInt4(this._uniforms[e],t,i,r,s)&&(this._valueCache[e]=null)}setIntArray(e,t){this._valueCache[e]=null,this._engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this._engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this._engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this._engine.setIntArray4(this._uniforms[e],t)}setUInt(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setUInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setUInt2(e,t,i){this._cacheFloat2(e,t,i)&&!this._engine.setUInt2(this._uniforms[e],t,i)&&(this._valueCache[e]=null)}setUInt3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&!this._engine.setUInt3(this._uniforms[e],t,i,r)&&(this._valueCache[e]=null)}setUInt4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&!this._engine.setUInt4(this._uniforms[e],t,i,r,s)&&(this._valueCache[e]=null)}setUIntArray(e,t){this._valueCache[e]=null,this._engine.setUIntArray(this._uniforms[e],t)}setUIntArray2(e,t){this._valueCache[e]=null,this._engine.setUIntArray2(this._uniforms[e],t)}setUIntArray3(e,t){this._valueCache[e]=null,this._engine.setUIntArray3(this._uniforms[e],t)}setUIntArray4(e,t){this._valueCache[e]=null,this._engine.setUIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this._engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this._engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this._engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this._engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this._engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this._engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this._engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this._engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){t&&(this._valueCache[e]=null,this._engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&!this._engine.setMatrices(this._uniforms[e],t.asArray())&&(this._valueCache[e]=null)}setMatrix3x3(e,t){this._valueCache[e]=null,this._engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this._engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){let i=this._valueCache[e];(void 0===i||i!==t)&&this._engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&!this._engine.setFloat2(this._uniforms[e],t.x,t.y)&&(this._valueCache[e]=null)}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&!this._engine.setFloat2(this._uniforms[e],t,i)&&(this._valueCache[e]=null)}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&!this._engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)&&(this._valueCache[e]=null)}setFloat3(e,t,i,r){this._cacheFloat3(e,t,i,r)&&!this._engine.setFloat3(this._uniforms[e],t,i,r)&&(this._valueCache[e]=null)}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&!this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)&&(this._valueCache[e]=null)}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&!this._engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)&&(this._valueCache[e]=null)}setFloat4(e,t,i,r,s){this._cacheFloat4(e,t,i,r,s)&&!this._engine.setFloat4(this._uniforms[e],t,i,r,s)&&(this._valueCache[e]=null)}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&!this._engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)&&(this._valueCache[e]=null)}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&!this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)&&(this._valueCache[e]=null)}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&!this._engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)&&(this._valueCache[e]=null)}}class au extends n5.r{get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}constructor(e,t,i,r){super(e,t,i,r),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=r}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class ah{get underlyingResource(){return this._nativeTexture}constructor(e,t){this._engine=t,this.set(e)}setUsage(){}set(e){this._nativeTexture=e}reset(){this._nativeTexture=null}release(){this._nativeTexture&&this._engine.deleteTexture(this._nativeTexture),this.reset()}}var ad=i(77669);function af(e,t){switch(e){case 15:return _native.Engine.TEXTURE_FORMAT_D16;case 16:return _native.Engine.TEXTURE_FORMAT_D24;case 13:return _native.Engine.TEXTURE_FORMAT_D24S8;case 14:return _native.Engine.TEXTURE_FORMAT_D32F;case 36492:return _native.Engine.TEXTURE_FORMAT_BC7;case 36494:return _native.Engine.TEXTURE_FORMAT_BC6H;case 33779:return _native.Engine.TEXTURE_FORMAT_BC3;case 33778:return _native.Engine.TEXTURE_FORMAT_BC2;case 33777:case 33776:return _native.Engine.TEXTURE_FORMAT_BC1;case 37808:return _native.Engine.TEXTURE_FORMAT_ASTC4x4;case 36196:return _native.Engine.TEXTURE_FORMAT_ETC1;case 37492:return _native.Engine.TEXTURE_FORMAT_ETC2;case 37496:return _native.Engine.TEXTURE_FORMAT_ETC2A;case 4:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGB8;case 3:return _native.Engine.TEXTURE_FORMAT_RGB8S;case 6:return _native.Engine.TEXTURE_FORMAT_RGB8I;case 7:return _native.Engine.TEXTURE_FORMAT_RGB8U}break;case 5:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RGBA8;case 1:return _native.Engine.TEXTURE_FORMAT_RGBA32F;case 2:return _native.Engine.TEXTURE_FORMAT_RGBA16F;case 3:return _native.Engine.TEXTURE_FORMAT_RGBA8S;case 4:return _native.Engine.TEXTURE_FORMAT_RGBA16I;case 5:return _native.Engine.TEXTURE_FORMAT_RGBA16U;case 6:return _native.Engine.TEXTURE_FORMAT_RGBA32I;case 7:return _native.Engine.TEXTURE_FORMAT_RGBA32U}break;case 6:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_R8;case 1:return _native.Engine.TEXTURE_FORMAT_R32F;case 2:return _native.Engine.TEXTURE_FORMAT_R16F;case 3:return _native.Engine.TEXTURE_FORMAT_R8S;case 4:return _native.Engine.TEXTURE_FORMAT_R16S;case 5:return _native.Engine.TEXTURE_FORMAT_R16U;case 6:return _native.Engine.TEXTURE_FORMAT_R32I;case 7:return _native.Engine.TEXTURE_FORMAT_R32U}break;case 7:switch(t){case 0:return _native.Engine.TEXTURE_FORMAT_RG8;case 1:return _native.Engine.TEXTURE_FORMAT_RG32F;case 2:return _native.Engine.TEXTURE_FORMAT_RG16F;case 3:return _native.Engine.TEXTURE_FORMAT_RG8S;case 4:return _native.Engine.TEXTURE_FORMAT_RG16S;case 5:return _native.Engine.TEXTURE_FORMAT_RG16U;case 6:return _native.Engine.TEXTURE_FORMAT_RG32I;case 7:return _native.Engine.TEXTURE_FORMAT_RG32U}break;case 12:if(0===t)return _native.Engine.TEXTURE_FORMAT_BGRA8}throw new ad.LH(`Unsupported texture format or type: format ${e}, type ${t}.`,ad.SM.UnsupportedTextureError)}function ap(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw Error(`Unsupported sampling mode: ${e}.`)}}function am(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw Error("Unexpected wrap mode: "+e+".")}}let a_={[st.o.PositionKind]:!0,[st.o.NormalKind]:!0,[st.o.TangentKind]:!0,[st.o.UVKind]:!0,[st.o.UV2Kind]:!0,[st.o.UV3Kind]:!0,[st.o.UV4Kind]:!0,[st.o.UV5Kind]:!0,[st.o.UV6Kind]:!0,[st.o.ColorKind]:!0,[st.o.ColorInstanceKind]:!0,[st.o.MatricesIndicesKind]:!0,[st.o.MatricesWeightsKind]:!0,[st.o.MatricesIndicesExtraKind]:!0,[st.o.MatricesWeightsExtraKind]:!0};function ag(e,t){let i=t.getEngine(),r=t._pipelineContext;if(!r?.vertexBufferKindToType)return;let s=null;for(let n in e){let a=e[n];if(!a||!a_[n])continue;let o=a.normalized?st.o.FLOAT:a.type,l=r.vertexBufferKindToType[n];(o!==st.o.FLOAT&&void 0===l||void 0!==l&&l!==o)&&(s||(s=i._getShaderProcessingContext(t.shaderLanguage,!1)),r.vertexBufferKindToType[n]=o,o!==st.o.FLOAT&&(s.vertexBufferKindToNumberOfComponents[n]=st.o.DeduceStride(n),function(e){switch(e){case st.o.BYTE:case st.o.SHORT:case st.o.INT:case st.o.FLOAT:return!0;case st.o.UNSIGNED_BYTE:case st.o.UNSIGNED_SHORT:case st.o.UNSIGNED_INT:return!1;default:throw Error(`Invalid type '${e}'`)}}(o)&&(s.vertexBufferKindToNumberOfComponents[n]*=-1)))}if(s){let e=i._caps.parallelShaderCompile;i._caps.parallelShaderCompile=void 0,t._processShaderCodeAsync(null,i._features._checkNonFloatVertexBuffersDontRecreatePipelineContext,s),i._caps.parallelShaderCompile=e}}class av{constructor(){this.vertexBufferKindToNumberOfComponents={},this.remappedAttributeNames={},this.injectInVertexMain=""}}var aS=i(93733);let ax=new i0.y$;if("undefined"!=typeof self&&!Object.prototype.hasOwnProperty.call(self,"_native")){let e;Object.defineProperty(self,"_native",{get:()=>e,set:t=>{(e=t)&&ax.notifyObservers(e)}})}async function aE(e,t){(await new Promise(e=>{"undefined"==typeof _native?ax.addOnce(t=>e(t)):e(_native)}))[e]=t}class aC extends si.h{}class aT{constructor(e){this._engine=e,this._pending=[],this._isCommandBufferScopeActive=!1,this._commandStream=ay._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}let ab=[];class ay extends sJ.D{setHardwareScalingLevel(e){super.setHardwareScalingLevel(e),this._engine.setHardwareScalingLevel(e)}constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine({version:sJ.D.Version,nonFloatVertexBuffers:!0}),this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new aT(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,this._fillModeWarningDisplayed=!1,_native.Engine.PROTOCOL_VERSION!==ay.PROTOCOL_VERSION)throw Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${ay.PROTOCOL_VERSION} (JS)`);this._engine.setDeviceLostCallback&&this._engine.setDeviceLostCallback(()=>{this.onContextLostObservable.notifyObservers(this),this._contextWasLost=!0,this._restoreEngineAfterContextLost()}),this._webGLVersion=2,this.disableUniformBuffers=!0,this._shaderPlatformName="NATIVE",this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxDrawBuffers:8,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:!1,textureFloat:!0,textureFloatLinearFiltering:!0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!1,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:16,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS,disableMorphTargetTexture:!1,parallelShaderCompile:{COMPLETION_STATUS_KHR:0}},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!0,supportSSAO2:!1,supportIBLShadows:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!1,_collectUbosUpdatedInFrame:!1},rD.w1.Log("Babylon Native (v"+sJ.D.Version+") launched"),rD.w1.LoadScript=function(e,t,i,r){rD.w1.LoadFile(e,e=>{Function(e).apply(null),t&&t()},void 0,void 0,!1,(e,t)=>{i&&i("LoadScript Error",t)})},"undefined"==typeof URL&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),"undefined"==typeof Blob&&(window.Blob=function(e){return e}),Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function e(){let t=isNaN(arguments[0])?1:Number(arguments[0]);return t?Array.prototype.reduce.call(this,function(i,r){return Array.isArray(r)?i.push.apply(i,e.call(r,t-1)):i.push(r),i},[]):Array.prototype.slice.call(this)},writable:!0});let t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?1/t:1,this._engine.setHardwareScalingLevel(this._hardwareScalingLevel),this._lastDevicePixelRatio=t,this.resize();let i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new al,this.onNewSceneAddedObservable.add(e=>{let t=e.render;e.render=(...i)=>{this._commandBufferEncoder.beginCommandScope(),t.apply(e,i),this._commandBufferEncoder.endCommandScope()}})}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new ar}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_restoreEngineAfterContextLost(){this._clearEmptyResources();let e=this._depthCullingState.depthTest,t=this._depthCullingState.depthFunc,i=this._depthCullingState.depthMask,r=this._stencilState.stencilTest;this._rebuildGraphicsResources(),this._depthCullingState.depthTest=e,this._depthCullingState.depthFunc=t,this._depthCullingState.depthMask=i,this._stencilState.stencilTest=r,this._flagContextRestored()}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,r=!1){if(this.useReverseDepthBuffer)throw Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t,i){let r=this._normalizeIndexData(e),s=new aC;return s.references=1,s.is32Bits=4===r.BYTES_PER_ELEMENT,r.byteLength&&(s.nativeIndexBuffer=this._engine.createIndexBuffer(r.buffer,r.byteOffset,r.byteLength,s.is32Bits,t??!1)),s}createVertexBuffer(e,t,i){let r=ArrayBuffer.isView(e)?e:new Float32Array(e),s=new aC;return s.references=1,r.byteLength&&(s.nativeVertexBuffer=this._engine.createVertexBuffer(r.buffer,r.byteOffset,r.byteLength,t??!1)),s}_recordVertexArrayObject(e,t,i,r,s){r._checkedNonFloatVertexBuffers||(ag(t,r),r._checkedNonFloatVertexBuffers=!0),i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);let n=r.getAttributesNames();for(let i=0;i<n.length;i++){let a=r.getAttributeLocation(i);if(a>=0){let r=n[i],o=null;if(s&&(o=s[r]),o||(o=t[r]),o){let t=o.effectiveBuffer;t&&t.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,t.nativeVertexBuffer,a,o.effectiveByteOffset,o.effectiveByteStride,o.getSize(),function(e){switch(e){case st.o.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case st.o.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case st.o.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case st.o.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case st.o.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw Error(`Unsupported attribute type: ${e}.`)}}(o.type),o.normalized,o.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,r){let s=this._engine.createVertexArray();return this._recordVertexArrayObject(s,e,t,i,r),s}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){let i=e.shaderProcessingContext;ab.length=0;for(let e=0;e<t.length;e++){let r=t[e],s=i.remappedAttributeNames[r]??r;ab[e]=s}return this._engine.getAttributes(e.program,ab)}_checkSupportedFillMode(e){return 5!=e&&8!=e||(this._fillModeWarningDisplayed||(re.Y.Warn("Line Loop and Triangle Fan are not supported fill modes with Babylon Native. Elements with these fill mode will not be visible."),this._fillModeWarningDisplayed=!0),!1)}drawElementsType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINDEXEDINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXEDINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}drawArraysType(e,t,i,r){this._checkSupportedFillMode(e)&&(this._drawCalls.addCount(1,!1),r&&_native.Engine.COMMAND_DRAWINSTANCED?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINSTANCED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r)):(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i)),this._commandBufferEncoder.finishEncodingCommand())}createPipelineContext(e){return new ac(this,!!(this._caps.parallelShaderCompile&&this._engine.createProgramAsync),e)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,r,s,n,a,o,l,c,u){r?this.createRawShaderProgram():this.createShaderProgram(e,t,i,o),u()}_getShaderProcessingContext(e){return new av}_executeWhenRenderingStateIsCompiled(e,t){if(e.isAsync){if(e.onCompiled){let i=e.onCompiled;e.onCompiled=()=>{i(),t()}}else e.onCompiled=t}else t()}createRawShaderProgram(){throw Error("Not Supported")}createShaderProgram(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);let s=new an.Z(t);s.processCode(),t=s.code;let n=new an.Z(i);n.processCode(),i=n.code,t=n4.ThinEngine._ConcatenateShader(t,r),i=n4.ThinEngine._ConcatenateShader(i,r);let a=()=>{e.isCompiled=!0,e.onCompiled?.(),this.onAfterShaderCompilationObservable.notifyObservers(this)};if(e.isAsync)e.program=this._engine.createProgramAsync(t,i,a,t=>{e.compilationError=t});else try{e.program=this._engine.createProgram(t,i),a()}catch(t){let e=t?.message;throw Error("SHADER ERROR"+("string"==typeof e?"\n"+e:""))}return e.program}inlineShaderCode(e){let t=new an.Z(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){e&&e.program&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.program),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){return this._engine.getUniforms(e.program,t)}bindUniformBlock(e,t,i){throw Error("Not Implemented")}bindSamplers(e){let t=e.getPipelineContext();this._setProgram(t.program);let i=e.getSamplers();for(let t=0;t<i.length;t++){let r=e.getUniform(i[t]);r&&(this._boundUniforms[t]=r)}this._currentEffect=null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETVIEWPORT),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.x),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.y),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.width),this._commandBufferEncoder.encodeCommandArgAsFloat32(e.height),this._commandBufferEncoder.finishEncodingCommand()}enableScissor(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand()}disableScissor(){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSCISSOR),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.encodeCommandArgAsFloat32(0),this._commandBufferEncoder.finishEncodingCommand()}setState(e,t=0,i,r=!1,s,n,a=0){this._zOffset=t,this._zOffsetUnits=a,0!==this._zOffset&&rD.w1.Warn("zOffset is not supported in Native engine."),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(a),this._commandBufferEncoder.encodeCommandArgAsUInt32(this.cullBackFaces??s??!0?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(r?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw Error(`Unsupported stencil OpFail mode: ${e}.`)}}(this._stencilOpStencilFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw Error(`Unsupported stencil depthFail mode: ${e}.`)}}(this._stencilOpDepthFail),function(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw Error(`Unsupported stencil opPass mode: ${e}.`)}}(this._stencilOpStencilDepthPass),function(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw Error(`Unsupported stencil func mode: ${e}.`)}}(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,r,s,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,r){throw Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;let i=function(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw Error(`Unsupported alpha mode: ${e}.`)}}(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(0===e),this._alphaMode=e}setInt(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setIntArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloatArray4(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setArray(e,t){return!!e&&this.setFloatArray(e,new Float32Array(t))}setArray2(e,t){return!!e&&this.setFloatArray2(e,new Float32Array(t))}setArray3(e,t){return!!e&&this.setFloatArray3(e,new Float32Array(t))}setArray4(e,t){return!!e&&this.setFloatArray4(e,new Float32Array(t))}setMatrices(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix3x3(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setMatrix2x2(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat(e,t){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat2(e,t,i){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat3(e,t,i,r){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0)}setFloat4(e,t,i,r,s){return!!e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0)}setColor3(e,t){return!!e&&(this.setFloat3(e,t.r,t.g,t.b),!0)}setColor4(e,t,i){return!!e&&(this.setFloat4(e,t.r,t.g,t.b,i),!0)}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e.underlyingResource)}updateDynamicTexture(e,t,i,r=!1,s){if(void 0===r&&(r=!1),e&&e._hardwareTexture){let i=t.getCanvasTexture(),r=e._hardwareTexture.underlyingResource;this._engine.copyTexture(r,i),e.isReady=!0}}createDynamicTexture(e,t,i,r){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,r)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){let r=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(r,t,i)}}createRawTexture(e,t,i,r,s,n,a,o=null,l=0,c=0,u=!1){let h=new s0.l(this,3);if(h.format=r,h.generateMipMaps=s,h.samplingMode=a,h.invertY=n,h.baseWidth=t,h.baseHeight=i,h.width=h.baseWidth,h.height=h.baseHeight,h._compression=o,h.type=l,h._useSRGBBuffer=this._getUseSRGBBuffer(u,!s),this.updateRawTexture(h,e,r,n,o,l,h._useSRGBBuffer),h._hardwareTexture){let e=h._hardwareTexture.underlyingResource,t=ap(a);this._setTextureSampling(e,t)}return this._internalTexturesCache.push(h),h}createRawTexture2DArray(e,t,i,r,s,n,a,o,l=null,c=0){let u=new s0.l(this,11);if(u.baseWidth=t,u.baseHeight=i,u.baseDepth=r,u.width=t,u.height=i,u.depth=r,u.format=s,u.type=c,u.generateMipMaps=n,u.samplingMode=o,u.is2DArray=!0,u._hardwareTexture){let l=u._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(l,e,t,i,r,af(s,c),n,a);let h=ap(o);this._setTextureSampling(l,h)}return u.isReady=!0,this._internalTexturesCache.push(u),u}updateRawTexture(e,t,i,r,s=null,n=0,a=!1){if(e){if(t&&e._hardwareTexture){let r=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(r,t,e.width,e.height,af(i,n),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,r,s=3,n=null,a=null,o=null,l=null,c=null,u=null,h,d,f,p=!1){let m="data:"===(e=e||"").substring(0,5),_=m&&-1!==e.indexOf(";base64,"),g=l||new s0.l(this,1),v=e;!this._transformTextureUrl||_||l||o||(e=this._transformTextureUrl(e));let S=e.lastIndexOf("."),x=u||(S>-1?e.substring(S).toLowerCase():""),E=null;(x.endsWith(".basis")||x.endsWith(".ktx")||x.endsWith(".ktx2")||"image/ktx"===h||"image/ktx2"===h)&&(E=(0,aS.qr)(x)),r&&r.addPendingData(g),g.url=e,g.generateMipMaps=!t,g.samplingMode=s,g.invertY=i,g._useSRGBBuffer=this._getUseSRGBBuffer(p,t),this.doNotHandleContextLost||(g._buffer=o);let C=null;n&&!l&&(C=g.onLoadedObservable.add(n)),l||this._internalTexturesCache.push(g);let T=(i,l)=>{r&&r.removePendingData(g),e===v?(C&&g.onLoadedObservable.remove(C),rh.l.UseFallbackTexture&&this.createTexture(rh.l.FallbackTexture,t,g.invertY,r,s,null,a,o,g),a&&a((i||"Unknown error")+(rh.l.UseFallbackTexture?" - Fallback texture was used":""),l)):(re.Y.Warn(`Failed to load ${e}, falling back to ${v}`),this.createTexture(v,t,g.invertY,r,s,n,a,o,g,c,u,h,d))};if(E)throw Error("Loading textures from IInternalTextureLoader not yet implemented.");{let n=e=>{if(!g._hardwareTexture){r&&r.removePendingData(g);return}let n=g._hardwareTexture.underlyingResource;this._engine.loadTexture(n,e,!t,i,g._useSRGBBuffer,()=>{g.baseWidth=this._engine.getTextureWidth(n),g.baseHeight=this._engine.getTextureHeight(n),g.width=g.baseWidth,g.height=g.baseHeight,g.isReady=!0;let e=ap(s);this._setTextureSampling(n,e),r&&r.removePendingData(g),g.onLoadedObservable.notifyObservers(g),g.onLoadedObservable.clear()},()=>{throw Error("Could not load a native texture.")})};if(m&&o){if(o instanceof ArrayBuffer)n(new Uint8Array(o));else if(ArrayBuffer.isView(o))n(o);else if("string"==typeof o)n(new Uint8Array(rD.w1.DecodeBase64(o)));else throw Error("Unsupported buffer type")}else _?n(new Uint8Array(rD.w1.DecodeBase64(e))):this._loadFile(e,e=>n(new Uint8Array(e)),void 0,void 0,!0,(e,t)=>{T("Unable to load "+(e&&e.responseURL,t))})}return g}wrapNativeTexture(e,t=!1,i=3){let r=new ah(e,this._engine),s=new s0.l(this,0,!0);return s._hardwareTexture=r,s.baseWidth=this._engine.getTextureWidth(e),s.baseHeight=this._engine.getTextureHeight(e),s.width=s.baseWidth,s.height=s.baseHeight,s.isReady=!0,s.useMipMaps=t,this.updateTextureSamplingMode(i,s),s}wrapWebGLTexture(){throw Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){let r=t.generateStencil||!1,s=t.samples||1,n=new s0.l(this,12),a=e.width??e,o=e.height??e,l=this._engine.createFrameBuffer(n._hardwareTexture.underlyingResource,a,o,r,!0,s);return i._framebufferDepthStencil=l,n}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){return new Promise((t,i)=>{let r=this.createCanvasImage();r.onload=()=>{try{let e=this._engine.createImageBitmap(r);t(e)}catch(e){i(`Error loading image ${r.src} with exception: ${e}`)}},r.onerror=e=>{i(`Error loading image ${r.src} with exception: ${e}`)},r.src=e})}createImageBitmap(e,t){return new Promise((t,i)=>{if(Array.isArray(e)&&e.length){let i=this._engine.createImageBitmap(e[0]);if(i){t(i);return}}i("Unsupported data for createImageBitmap.")})}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,r,s=null,n=null,a,o=null,l=!1,c=0,u=0,h=null,d,f=!1,p=null){let m=h||new s0.l(this,7);m.isCube=!0,m.url=e,m.generateMipMaps=!r,m._lodGenerationScale=c,m._lodGenerationOffset=u,m._useSRGBBuffer=this._getUseSRGBBuffer(f,!!r),this._doNotHandleContextLost||(m._extension=o,m._files=i,m._buffer=p);let _=e.lastIndexOf(".");if(".env"===(o||(_>-1?e.substring(_).toLowerCase():""))){let t=e=>{let t=(0,as.qJ)(e);m.width=t.width,m.height=t.width,(0,as.qC)(m,t);let i=t.specular;if(!i)throw Error("Nothing else parsed so far");m._lodGenerationScale=i.lodGenerationScale;let r=(0,as.Do)(e,t);m.format=5,m.type=0,m.generateMipMaps=!0,m.getEngine().updateTextureSamplingMode(rZ.x.TRILINEAR_SAMPLINGMODE,m),m._isRGBD=!0,m.invertY=!0,this._engine.loadCubeTextureWithMips(m._hardwareTexture.underlyingResource,r,!1,m._useSRGBBuffer,()=>{m.isReady=!0,s&&s()},()=>{throw Error("Could not load a native cube texture.")})};if(p)t(p);else if(i&&6===i.length)throw Error("Multi-file loading not allowed on env files.");else this._loadFile(e,e=>{t(new Uint8Array(e,0,e.byteLength))},void 0,void 0,!0,(e,t)=>{n&&e&&n(e.status+" "+e.statusText,t)})}else{if(!i||6!==i.length)throw Error("Cannot load cubemap because 6 files were not defined");Promise.all([i[0],i[3],i[1],i[4],i[2],i[5]].map(e=>this._loadFileAsync(e,void 0,!0).then(e=>new Uint8Array(e,0,e.byteLength)))).then(e=>new Promise((t,i)=>{this._engine.loadCubeTexture(m._hardwareTexture.underlyingResource,e,!r,!0,m._useSRGBBuffer,t,i)})).then(()=>{m.isReady=!0,s&&s()},e=>{n&&n(`Failed to load cubemap: ${e.message}`,e)})}return this._internalTexturesCache.push(m),m}_createHardwareTexture(){return new ah(this._createTexture(),this._engine)}_createHardwareRenderTargetWrapper(e,t,i){let r=new au(e,t,i,this);return this._renderTargetWrapperCache.push(r),r}_createInternalTexture(e,t,i=!0,r=0){let s,n=!1,a=0,o=3,l=5,c=!1,u=1;void 0!==t&&"object"==typeof t?(n=!!t.generateMipMaps,a=void 0===t.type?0:t.type,o=void 0===t.samplingMode?3:t.samplingMode,l=void 0===t.format?5:t.format,c=void 0!==t.useSRGBBuffer&&t.useSRGBBuffer,u=t.samples??1,s=t.label):n=!!t,c=this._getUseSRGBBuffer(c,!n),(1!==a||this._caps.textureFloatLinearFiltering)&&(2!==a||this._caps.textureHalfFloatLinearFiltering)||(o=1),1!==a||this._caps.textureFloat||(a=0,re.Y.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let h=new s0.l(this,r),d=e.width??e,f=e.height??e,p=e.layers||0;if(0!==p)throw Error("Texture layers are not supported in Babylon Native");let m=h._hardwareTexture.underlyingResource,_=af(l,a);return this._engine.initializeTexture(m,d,f,n,_,!0,c,u),this._setTextureSampling(m,ap(o)),h._useSRGBBuffer=c,h.baseWidth=d,h.baseHeight=f,h.width=d,h.height=f,h.depth=p,h.isReady=!0,h.samples=u,h.generateMipMaps=n,h.samplingMode=o,h.type=a,h.format=l,h.label=s,this._internalTexturesCache.push(h),h}createRenderTargetTexture(e,t){let i;let r=this._createHardwareRenderTargetWrapper(!1,!1,e),s=!0,n=!1,a=!1,o=1;void 0!==t&&"object"==typeof t&&(s=t.generateDepthBuffer??!0,n=!!t.generateStencilBuffer,a=!!t.noColorAttachment,i=t.colorAttachment,o=t.samples??1);let l=i||(a?null:this._createInternalTexture(e,t,!0,5)),c=e.width??e,u=e.height??e,h=this._engine.createFrameBuffer(l?l._hardwareTexture.underlyingResource:null,c,u,n,s,o);return r._framebuffer=h,r._generateDepthBuffer=s,r._generateStencilBuffer=n,r._samples=o,r.setTextures(l),r}updateRenderTargetTextureSampleCount(e,t){return re.Y.Warn("Updating render target sample count is not currently supported"),e.samples}updateTextureSamplingMode(e,t){if(t._hardwareTexture){let i=ap(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,r,s){if(this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,t)throw Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||r)throw Error("Required width/height for frame buffers not yet supported in NativeEngine.");e._framebufferDepthStencil?this._bindUnboundFramebuffer(e._framebufferDepthStencil):this._bindUnboundFramebuffer(e._framebuffer)}unBindFramebuffer(e,t=!1,i){this._currentRenderTarget=null,i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){let r=this._normalizeIndexData(t);e.is32Bits=4===r.BYTES_PER_ELEMENT,this._engine.updateDynamicIndexBuffer(e.nativeIndexBuffer,r.buffer,r.byteOffset,r.byteLength,i)}updateDynamicVertexBuffer(e,t,i=0,r){let s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,n=new Uint8Array(s.buffer,s.byteOffset,r??s.byteLength);this._engine.updateDynamicVertexBuffer(e.nativeVertexBuffer,n.buffer,n.byteOffset,n.byteLength,i)}_setTexture(e,t,i=!1,r=!1){let s;let n=this._boundUniforms[e];if(!n)return!1;if(!t)return null!=this._boundTexturesCache[e]&&(this._activeChannel=e,this._boundTexturesCache[e]=null,this._unsetNativeTexture(n)),!1;if(t.video)this._activeChannel=e,t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;return s=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture,this._activeChannel=e,!!s&&!!s._hardwareTexture&&(this._setTextureWrapMode(s._hardwareTexture.underlyingResource,am(t.wrapU),am(t.wrapV),am(t.wrapR)),this._updateAnisotropicLevel(t),this._setNativeTexture(n,s._hardwareTexture.underlyingResource),!0)}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,r){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.finishEncodingCommand()}_setNativeTexture(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_unsetNativeTexture(e){_native.Engine.COMMAND_UNSETTEXTURE&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNSETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_updateAnisotropicLevel(e){let t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;t&&t._hardwareTexture&&t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_bindTexture(e,t){let i=this._boundUniforms[e];if(i){if(t&&t._hardwareTexture){let e=t._hardwareTexture.underlyingResource;this._setNativeTexture(i,e)}else this._unsetNativeTexture(i)}}unbindAllTextures(){_native.Engine.COMMAND_DISCARDALLTEXTURES&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DISCARDALLTEXTURES),this._commandBufferEncoder.finishEncodingCommand())}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw Error("Native Canvas plugin not available.");let i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(e,t,i,r,s,n,a=0,o=0,l=!1){throw Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,a=0){throw Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,r=0){throw Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){throw Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,r=0){throw Error("_uploadArrayBufferViewToTexture not implemented.")}getFontOffset(e){return{ascent:0,height:0,descent:0}}flushFramebuffer(){}_readTexturePixels(e,t,i,r,s,n,a,o,l,c){if(void 0!==r&&-1!==r)throw Error(`Reading cubemap faces is not supported, but faceIndex is ${r}.`);return this._engine.readTexture(e._hardwareTexture?.underlyingResource,s??0,l??0,c??0,t,i,n?.buffer??null,n?.byteOffset??0,n?.byteLength??0).then(e=>(n||(n=new Uint8Array(e)),n))}}ay.PROTOCOL_VERSION=8,ay._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new aI:new ar};class aI extends ar{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}var aP=i(65330);class aR{static ComputeNumMipmapLevels(e,t){return(0,aP.ILog2)(Math.max(e,t))+1}static GetTextureTypeFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"rgb9e5ufloat":case"rg11b10ufloat":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":case"stencil8":break;case"r16uint":case"r16sint":case"rg16uint":case"rg16sint":case"rgba16uint":case"rgba16sint":case"depth16unorm":return 5;case"r16float":case"rg16float":case"rgba16float":return 2;case"r32uint":case"r32sint":case"rg32uint":case"rg32sint":case"rgba32uint":case"rgba32sint":return 7;case"r32float":case"rg32float":case"rgba32float":case"depth32float":case"depth32float-stencil8":case"depth24plus":case"depth24plus-stencil8":return 1}return 0}static GetBlockInformationFromFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth16unorm":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2uint":case"rgb10a2unorm":case"rg11b10ufloat":case"depth32float":break;case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw"No fixed size for Stencil8 format!";case"depth24plus":throw"No fixed size for Depth24Plus format!";case"depth24plus-stencil8":throw"No fixed size for Depth24PlusStencil8 format!";case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc5-rg-unorm":case"bc5-rg-snorm":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":return{width:4,height:4,length:8};case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":return{width:5,height:4,length:16};case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":return{width:5,height:5,length:16};case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":return{width:6,height:5,length:16};case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":return{width:6,height:6,length:16};case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":return{width:8,height:5,length:16};case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":return{width:8,height:6,length:16};case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":return{width:8,height:8,length:16};case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":return{width:10,height:5,length:16};case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":return{width:10,height:6,length:16};case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":return{width:10,height:8,length:16};case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":return{width:10,height:10,length:16};case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":return{width:12,height:10,length:16};case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static IsHardwareTexture(e){return!!e.release}static IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return void 0!==e.close}static IsImageBitmapArray(e){return Array.isArray(e)&&void 0!==e[0].close}static IsCompressedFormat(e){switch(e){case"bc7-rgba-unorm-srgb":case"bc7-rgba-unorm":case"bc6h-rgb-float":case"bc6h-rgb-ufloat":case"bc5-rg-snorm":case"bc5-rg-unorm":case"bc4-r-snorm":case"bc4-r-unorm":case"bc3-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc1-rgba-unorm-srgb":case"bc1-rgba-unorm":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"eac-r11unorm":case"eac-r11snorm":case"eac-rg11unorm":case"eac-rg11snorm":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return"depth16unorm";case 16:return"depth24plus";case 13:return"depth24plus-stencil8";case 14:return"depth32float";case 18:return"depth32float-stencil8";case 19:return"stencil8";case 36492:return i?"bc7-rgba-unorm-srgb":"bc7-rgba-unorm";case 36495:return"bc6h-rgb-ufloat";case 36494:return"bc6h-rgb-float";case 33779:return i?"bc3-rgba-unorm-srgb":"bc3-rgba-unorm";case 33778:return i?"bc2-rgba-unorm-srgb":"bc2-rgba-unorm";case 33777:case 33776:return i?"bc1-rgba-unorm-srgb":"bc1-rgba-unorm";case 37808:return i?"astc-4x4-unorm-srgb":"astc-4x4-unorm";case 36196:case 37492:return i?"etc2-rgb8unorm-srgb":"etc2-rgb8unorm";case 37496:return i?"etc2-rgba8unorm-srgb":"etc2-rgba8unorm"}switch(e){case 3:switch(t){case 6:return"r8snorm";case 7:return"rg8snorm";case 4:throw"RGB format not supported in WebGPU";case 8:return"r8sint";case 9:return"rg8sint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8sint";default:return"rgba8snorm"}case 0:switch(t){case 6:return"r8unorm";case 7:return"rg8unorm";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?"rgba8unorm-srgb":"rgba8unorm";case 12:return i?"bgra8unorm-srgb":"bgra8unorm";case 8:return"r8uint";case 9:return"rg8uint";case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return"rgba8uint";case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return"rgba8unorm"}case 4:switch(t){case 8:return"r16sint";case 9:return"rg16sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16sint"}case 5:switch(t){case 8:return"r16uint";case 9:return"rg16uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba16uint"}case 6:switch(t){case 8:return"r32sint";case 9:return"rg32sint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32sint"}case 7:switch(t){case 8:return"r32uint";case 9:return"rg32uint";case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";default:return"rgba32uint"}case 1:switch(t){case 6:return"r32float";case 7:return"rg32float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba32float"}case 2:switch(t){case 6:return"r16float";case 7:return"rg16float";case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";default:return"rgba16float"}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:switch(t){case 5:default:return"rg11b10ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV"}case 14:switch(t){case 5:default:return"rgb9e5ufloat";case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV"}case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:default:return"rgb10a2unorm";case 11:return"rgb10a2uint"}}return i?"rgba8unorm-srgb":"rgba8unorm"}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":case"bc4-r-unorm":case"bc4-r-snorm":case"r16uint":case"r16sint":case"depth16unorm":case"r16float":case"r32uint":case"r32sint":case"r32float":case"depth32float":case"stencil8":case"depth24plus":case"eac-r11unorm":case"eac-r11snorm":return 1;case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth32float-stencil8":case"bc5-rg-unorm":case"bc5-rg-snorm":case"rg16uint":case"rg16sint":case"rg16float":case"rg32uint":case"rg32sint":case"rg32float":case"depth24plus-stencil8":case"eac-rg11unorm":case"eac-rg11snorm":return 2;case"rgb9e5ufloat":case"rg11b10ufloat":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"etc2-rgb8unorm":case"etc2-rgb8unorm-srgb":return 3;case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb10a2uint":case"rgb10a2unorm":case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":case"rgba16uint":case"rgba16sint":case"rgba16float":case"rgba32uint":case"rgba32sint":case"rgba32float":case"etc2-rgb8a1unorm":case"etc2-rgb8a1unorm-srgb":case"etc2-rgba8unorm":case"etc2-rgba8unorm-srgb":case"astc-4x4-unorm":case"astc-4x4-unorm-srgb":case"astc-5x4-unorm":case"astc-5x4-unorm-srgb":case"astc-5x5-unorm":case"astc-5x5-unorm-srgb":case"astc-6x5-unorm":case"astc-6x5-unorm-srgb":case"astc-6x6-unorm":case"astc-6x6-unorm-srgb":case"astc-8x5-unorm":case"astc-8x5-unorm-srgb":case"astc-8x6-unorm":case"astc-8x6-unorm-srgb":case"astc-8x8-unorm":case"astc-8x8-unorm-srgb":case"astc-10x5-unorm":case"astc-10x5-unorm-srgb":case"astc-10x6-unorm":case"astc-10x6-unorm-srgb":case"astc-10x8-unorm":case"astc-10x8-unorm-srgb":case"astc-10x10-unorm":case"astc-10x10-unorm-srgb":case"astc-12x10-unorm":case"astc-12x10-unorm-srgb":case"astc-12x12-unorm":case"astc-12x12-unorm-srgb":return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case"stencil8":case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case"depth32float-stencil8":case"depth24plus-stencil8":return!0}return!1}static GetDepthFormatOnly(e){switch(e){case"depth16unorm":return"depth16unorm";case"depth24plus":case"depth24plus-stencil8":return"depth24plus";case"depth32float":case"depth32float-stencil8":return"depth32float"}return e}static GetSample(e){return e>1?4:1}}var aA=i(64525);class aM extends rV.a{constructor(){super(...arguments),this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this.dbgVerboseLogsForFirstFrames=!1,this._currentRenderPass=null,this._snapshotRenderingMode=0,this._timestampIndex=0}get enableGPUTimingMeasurements(){return this._timestampQuery.enable}set enableGPUTimingMeasurements(e){this._timestampQuery.enable!==e&&(this.gpuTimeInFrameForMainPass=e?new aA.Q:void 0,this._timestampQuery.enable=e)}_currentPassIsMainPass(){return null===this._currentRenderTarget}_endCurrentRenderPass(){if(!this._currentRenderPass)return 0;let e=this._currentPassIsMainPass()?2:1;return this._snapshotRendering.endRenderPass(this._currentRenderPass)||this.compatibilityMode||(this._bundleList.run(this._currentRenderPass),this._bundleList.reset()),this._currentRenderPass.end(),this._timestampQuery.endPass(this._timestampIndex,this._currentRenderTarget&&this._currentRenderTarget.gpuTimeInFrame?this._currentRenderTarget.gpuTimeInFrame:this.gpuTimeInFrameForMainPass),this._timestampIndex+=2,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log("frame #"+this._count+" - "+(2===e?"main":"render target")+" end pass"+(1===e?" - internalTexture.uniqueId="+this._currentRenderTarget?.texture?.uniqueId:""))),this._debugPopGroup?.(0),this._currentRenderPass=null,e}_generateMipmaps(e,t){t=t??this._renderEncoder;let i=e._hardwareTexture;if(!i)return;t===this._renderEncoder&&this._endCurrentRenderPass();let r=e._hardwareTexture.format,s=aR.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log("frame #"+this._count+" - generate mipmaps - width="+e.width+", height="+e.height+", isCube="+e.isCube+", command encoder="+(t===this._renderEncoder?"render":"copy"))),e.isCube?this._textureHelper.generateCubeMipmaps(i,r,s,t):this._textureHelper.generateMipmaps(i,r,s,0,e.is3D,t)}}aM.prototype.setAlphaMode=function(e,t=!1){if(this._alphaMode===e&&(0===e&&!this._alphaState.alphaBlend||0!==e&&this._alphaState.alphaBlend)){if(!t){let t=0===e;this.depthCullingState.depthMask!==t&&(this.setDepthWrite(t),this._cacheRenderPipeline.setDepthWriteEnabled(t))}return}switch(e){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0}t||(this.setDepthWrite(0===e),this._cacheRenderPipeline.setDepthWriteEnabled(0===e)),this._alphaMode=e,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)},aM.prototype.setAlphaEquation=function(e){rV.a.prototype.setAlphaEquation.call(this,e),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};var aN=i(78875);(l=ts||(ts={})).LowPower="low-power",l.HighPerformance="high-performance",(c=tn||(tn={})).DepthClipControl="depth-clip-control",c.Depth32FloatStencil8="depth32float-stencil8",c.TextureCompressionBC="texture-compression-bc",c.TextureCompressionETC2="texture-compression-etc2",c.TextureCompressionASTC="texture-compression-astc",c.TimestampQuery="timestamp-query",c.IndirectFirstInstance="indirect-first-instance",c.ShaderF16="shader-f16",c.RG11B10UFloatRenderable="rg11b10ufloat-renderable",c.BGRA8UnormStorage="bgra8unorm-storage",c.Float32Filterable="float32-filterable",(u=ta||(ta={})).Unmapped="unmapped",u.Pending="pending",u.Mapped="mapped",(h=to||(to={}))[h.MapRead=1]="MapRead",h[h.MapWrite=2]="MapWrite",h[h.CopySrc=4]="CopySrc",h[h.CopyDst=8]="CopyDst",h[h.Index=16]="Index",h[h.Vertex=32]="Vertex",h[h.Uniform=64]="Uniform",h[h.Storage=128]="Storage",h[h.Indirect=256]="Indirect",h[h.QueryResolve=512]="QueryResolve",(d=tl||(tl={}))[d.Read=1]="Read",d[d.Write=2]="Write",(f=tc||(tc={})).E1d="1d",f.E2d="2d",f.E3d="3d",(p=tu||(tu={}))[p.CopySrc=1]="CopySrc",p[p.CopyDst=2]="CopyDst",p[p.TextureBinding=4]="TextureBinding",p[p.StorageBinding=8]="StorageBinding",p[p.RenderAttachment=16]="RenderAttachment",(m=th||(th={})).E1d="1d",m.E2d="2d",m.E2dArray="2d-array",m.Cube="cube",m.CubeArray="cube-array",m.E3d="3d",(_=td||(td={})).All="all",_.StencilOnly="stencil-only",_.DepthOnly="depth-only",(g=tf||(tf={})).R8Unorm="r8unorm",g.R8Snorm="r8snorm",g.R8Uint="r8uint",g.R8Sint="r8sint",g.R16Uint="r16uint",g.R16Sint="r16sint",g.R16Float="r16float",g.RG8Unorm="rg8unorm",g.RG8Snorm="rg8snorm",g.RG8Uint="rg8uint",g.RG8Sint="rg8sint",g.R32Uint="r32uint",g.R32Sint="r32sint",g.R32Float="r32float",g.RG16Uint="rg16uint",g.RG16Sint="rg16sint",g.RG16Float="rg16float",g.RGBA8Unorm="rgba8unorm",g.RGBA8UnormSRGB="rgba8unorm-srgb",g.RGBA8Snorm="rgba8snorm",g.RGBA8Uint="rgba8uint",g.RGBA8Sint="rgba8sint",g.BGRA8Unorm="bgra8unorm",g.BGRA8UnormSRGB="bgra8unorm-srgb",g.RGB9E5UFloat="rgb9e5ufloat",g.RGB10A2UINT="rgb10a2uint",g.RGB10A2Unorm="rgb10a2unorm",g.RG11B10UFloat="rg11b10ufloat",g.RG32Uint="rg32uint",g.RG32Sint="rg32sint",g.RG32Float="rg32float",g.RGBA16Uint="rgba16uint",g.RGBA16Sint="rgba16sint",g.RGBA16Float="rgba16float",g.RGBA32Uint="rgba32uint",g.RGBA32Sint="rgba32sint",g.RGBA32Float="rgba32float",g.Stencil8="stencil8",g.Depth16Unorm="depth16unorm",g.Depth24Plus="depth24plus",g.Depth24PlusStencil8="depth24plus-stencil8",g.Depth32Float="depth32float",g.BC1RGBAUnorm="bc1-rgba-unorm",g.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",g.BC2RGBAUnorm="bc2-rgba-unorm",g.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",g.BC3RGBAUnorm="bc3-rgba-unorm",g.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",g.BC4RUnorm="bc4-r-unorm",g.BC4RSnorm="bc4-r-snorm",g.BC5RGUnorm="bc5-rg-unorm",g.BC5RGSnorm="bc5-rg-snorm",g.BC6HRGBUFloat="bc6h-rgb-ufloat",g.BC6HRGBFloat="bc6h-rgb-float",g.BC7RGBAUnorm="bc7-rgba-unorm",g.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",g.ETC2RGB8Unorm="etc2-rgb8unorm",g.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",g.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",g.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",g.ETC2RGBA8Unorm="etc2-rgba8unorm",g.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",g.EACR11Unorm="eac-r11unorm",g.EACR11Snorm="eac-r11snorm",g.EACRG11Unorm="eac-rg11unorm",g.EACRG11Snorm="eac-rg11snorm",g.ASTC4x4Unorm="astc-4x4-unorm",g.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",g.ASTC5x4Unorm="astc-5x4-unorm",g.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",g.ASTC5x5Unorm="astc-5x5-unorm",g.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",g.ASTC6x5Unorm="astc-6x5-unorm",g.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",g.ASTC6x6Unorm="astc-6x6-unorm",g.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",g.ASTC8x5Unorm="astc-8x5-unorm",g.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",g.ASTC8x6Unorm="astc-8x6-unorm",g.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",g.ASTC8x8Unorm="astc-8x8-unorm",g.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",g.ASTC10x5Unorm="astc-10x5-unorm",g.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",g.ASTC10x6Unorm="astc-10x6-unorm",g.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",g.ASTC10x8Unorm="astc-10x8-unorm",g.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",g.ASTC10x10Unorm="astc-10x10-unorm",g.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",g.ASTC12x10Unorm="astc-12x10-unorm",g.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",g.ASTC12x12Unorm="astc-12x12-unorm",g.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",g.Depth32FloatStencil8="depth32float-stencil8",(v=tp||(tp={})).ClampToEdge="clamp-to-edge",v.Repeat="repeat",v.MirrorRepeat="mirror-repeat",(S=tm||(tm={})).Nearest="nearest",S.Linear="linear",(x=t_||(t_={})).Nearest="nearest",x.Linear="linear",(E=tg||(tg={})).Never="never",E.Less="less",E.Equal="equal",E.LessEqual="less-equal",E.Greater="greater",E.NotEqual="not-equal",E.GreaterEqual="greater-equal",E.Always="always",(C=tv||(tv={}))[C.Vertex=1]="Vertex",C[C.Fragment=2]="Fragment",C[C.Compute=4]="Compute",(T=tS||(tS={})).Uniform="uniform",T.Storage="storage",T.ReadOnlyStorage="read-only-storage",(b=tx||(tx={})).Filtering="filtering",b.NonFiltering="non-filtering",b.Comparison="comparison",(y=tE||(tE={})).Float="float",y.UnfilterableFloat="unfilterable-float",y.Depth="depth",y.Sint="sint",y.Uint="uint",(I=tC||(tC={})).WriteOnly="write-only",I.ReadOnly="read-only",I.ReadWrite="read-write",(P=tT||(tT={})).Error="error",P.Warning="warning",P.Info="info",(R=tb||(tb={})).Validation="validation",R.Internal="internal",(ty||(ty={})).Auto="auto",(A=tI||(tI={})).PointList="point-list",A.LineList="line-list",A.LineStrip="line-strip",A.TriangleList="triangle-list",A.TriangleStrip="triangle-strip",(M=tP||(tP={})).CCW="ccw",M.CW="cw",(N=tR||(tR={})).None="none",N.Front="front",N.Back="back",(O=tA||(tA={}))[O.Red=1]="Red",O[O.Green=2]="Green",O[O.Blue=4]="Blue",O[O.Alpha=8]="Alpha",O[O.All=15]="All",(D=tM||(tM={})).Zero="zero",D.One="one",D.Src="src",D.OneMinusSrc="one-minus-src",D.SrcAlpha="src-alpha",D.OneMinusSrcAlpha="one-minus-src-alpha",D.Dst="dst",D.OneMinusDst="one-minus-dst",D.DstAlpha="dst-alpha",D.OneMinusDstAlpha="one-minus-dst-alpha",D.SrcAlphaSaturated="src-alpha-saturated",D.Constant="constant",D.OneMinusConstant="one-minus-constant",(F=tN||(tN={})).Add="add",F.Subtract="subtract",F.ReverseSubtract="reverse-subtract",F.Min="min",F.Max="max",(L=tO||(tO={})).Keep="keep",L.Zero="zero",L.Replace="replace",L.Invert="invert",L.IncrementClamp="increment-clamp",L.DecrementClamp="decrement-clamp",L.IncrementWrap="increment-wrap",L.DecrementWrap="decrement-wrap",(w=tD||(tD={})).Uint16="uint16",w.Uint32="uint32",(B=tF||(tF={})).Uint8x2="uint8x2",B.Uint8x4="uint8x4",B.Sint8x2="sint8x2",B.Sint8x4="sint8x4",B.Unorm8x2="unorm8x2",B.Unorm8x4="unorm8x4",B.Snorm8x2="snorm8x2",B.Snorm8x4="snorm8x4",B.Uint16x2="uint16x2",B.Uint16x4="uint16x4",B.Sint16x2="sint16x2",B.Sint16x4="sint16x4",B.Unorm16x2="unorm16x2",B.Unorm16x4="unorm16x4",B.Snorm16x2="snorm16x2",B.Snorm16x4="snorm16x4",B.Float16x2="float16x2",B.Float16x4="float16x4",B.Float32="float32",B.Float32x2="float32x2",B.Float32x3="float32x3",B.Float32x4="float32x4",B.Uint32="uint32",B.Uint32x2="uint32x2",B.Uint32x3="uint32x3",B.Uint32x4="uint32x4",B.Sint32="sint32",B.Sint32x2="sint32x2",B.Sint32x3="sint32x3",B.Sint32x4="sint32x4",B.UNORM10x10x10x2="unorm10-10-10-2",(V=tL||(tL={})).Vertex="vertex",V.Instance="instance",(U=tw||(tw={})).Beginning="beginning",U.End="end",(k=tB||(tB={})).Beginning="beginning",k.End="end",(G=tV||(tV={})).Load="load",G.Clear="clear",(z=tU||(tU={})).Store="store",z.Discard="discard",(H=tk||(tk={})).Occlusion="occlusion",H.Timestamp="timestamp",(W=tG||(tG={})).Opaque="opaque",W.Premultiplied="premultiplied",(Y=tz||(tz={})).Unknown="unknown",Y.Destroyed="destroyed",(X=tH||(tH={})).Validation="validation",X.OutOfMemory="out-of-memory",X.Internal="internal";class aO{constructor(){this.shaderLanguage=0}_addUniformToLeftOverUBO(e,t,i){let r=0;[e,t,r]=this._getArraySize(e,t,i);for(let t=0;t<this._webgpuProcessingContext.leftOverUniforms.length;t++)if(this._webgpuProcessingContext.leftOverUniforms[t].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:r})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";let e=aO.LeftOvertUBOName,t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,"uniform",!0),this._addBufferBindingDescription(e,t,"uniform",!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){let t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(void 0===t){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(let i=0;i<t.length;i++){let t=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],r=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].name,s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][t.binding].nameInArrayOfTexture;t&&(t.texture||t.externalTexture||t.storageTexture?this._webgpuProcessingContext.textureNames.push(s):t.sampler?this._webgpuProcessingContext.samplerNames.push(r):t.buffer&&this._webgpuProcessingContext.bufferNames.push(r))}}}_preCreateBindGroupEntries(){let e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){let i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],r=[];for(let e=0;e<i.length;e++){let i=this._webgpuProcessingContext.bindGroupLayoutEntries[t][e];i.sampler||i.texture||i.storageTexture||i.externalTexture?r.push({binding:i.binding,resource:void 0}):i.buffer&&r.push({binding:i.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=r}}_addTextureBindingDescription(e,t,i,r,s,n){let{groupIndex:a,bindingIndex:o}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[a]||(this._webgpuProcessingContext.bindGroupLayoutEntries[a]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]){let n;n=null===r?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,externalTexture:{}}):s?this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,storageTexture:{access:"write-only",format:s,viewDimension:r}}):this._webgpuProcessingContext.bindGroupLayoutEntries[a].push({binding:o,visibility:0,texture:{sampleType:t.sampleType,viewDimension:r,multisampled:!1}});let l=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o]={name:e,index:n-1,nameInArrayOfTexture:l}}o=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[a][o].index,n?this._webgpuProcessingContext.bindGroupLayoutEntries[a][o].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[a][o].visibility|=2}_addSamplerBindingDescription(e,t,i){let{groupIndex:r,bindingIndex:s}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]){let i=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:s,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s]={name:e,index:i-1}}s=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][s].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[r][s].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[r][s].visibility|=2}_addBufferBindingDescription(e,t,i,r){let{groupIndex:s,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]){let t=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:n,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n]={name:e,index:t-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][n].index,r?this._webgpuProcessingContext.bindGroupLayoutEntries[s][n].visibility|=1:this._webgpuProcessingContext.bindGroupLayoutEntries[s][n].visibility|=2}}aO.LeftOvertUBOName="LeftOver",aO.InternalsUBOName="Internals",aO.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,uvec2:2,vec3:3,ivec3:3,uvec3:3,vec4:4,ivec4:4,uvec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16,mat2x2f:4,mat3x3f:12,mat4x4f:16,vec2i:2,vec3i:3,vec4i:4,vec2u:2,vec3u:3,vec4u:4,vec2f:2,vec3f:3,vec4f:4,vec2h:1,vec3h:2,vec4h:2},aO._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"},aO._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"},aO._GpuTextureViewDimensionByWebGPUTextureType={textureCube:"cube",textureCubeArray:"cube-array",texture2D:"2d",texture2DArray:"2d-array",texture3D:"3d"},aO._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"},aO._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class aD{get isAsync(){return!1}get isReady(){return!!this.stages}constructor(e,t){this.bindGroupLayouts={},this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t,this.vertexBufferKindToType={}}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,r,s,n,a,o){let l;let c=this.engine;c._doNotHandleContextLost&&(e._fragmentSourceCode="",e._vertexSourceCode="");let u=this.shaderProcessingContext.availableTextures;for(l=0;l<s.length;l++){let e=s[l],t=u[s[l]];null==t||void 0==t?(s.splice(l,1),l--):n[e]=l}for(let e of c.getAttributes(this,a))o.push(e);this.buildUniformLayout();let h=[],d=[];for(l=0;l<a.length;l++){let e=o[l];e>=0&&(h.push(a[l]),d.push(e))}this.shaderProcessingContext.attributeNamesFromEffect=h,this.shaderProcessingContext.attributeLocationsFromEffect=d}buildUniformLayout(){if(this.shaderProcessingContext.leftOverUniforms.length){for(let e of(this.uniformBuffer?.dispose(),this.uniformBuffer=new s1.M(this.engine,void 0,void 0,"leftOver-"+this._name),this.shaderProcessingContext.leftOverUniforms)){let t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=aO.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}setEngine(e){this.engine=e}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt3(e,t,i,r)}setInt4(e,t,i,r,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateInt4(e,t,i,r,s)}setIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setUInt(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt(e,t)}setUInt2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt2(e,t,i)}setUInt3(e,t,i,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt3(e,t,i,r)}setUInt4(e,t,i,r,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUInt4(e,t,i,r,s)}setUIntArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateUIntArray(e,t)}setUIntArray2(e,t){this.setUIntArray(e,t)}setUIntArray3(e,t){this.setUIntArray(e,t)}setUIntArray4(e,t){this.setUIntArray(e,t)}setArray(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,r){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat3(e,t,i,r)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,r,s){this.uniformBuffer&&this._leftOverUniformsByName[e]&&this.uniformBuffer.updateFloat4(e,t,i,r,s)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.sources?.vertex}_getFragmentShaderCode(){return this.sources?.fragment}}let aF={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class aL{static get KnownUBOs(){return aL._SimplifiedKnownBindings?aL._SimplifiedKnownUBOs:aL._KnownUBOs}constructor(e,t=!1){this.vertexBufferKindToNumberOfComponents={},this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],t||this._findStartingGroupBinding()}_findStartingGroupBinding(){let e=aL.KnownUBOs,t=[];for(let i in e){let r=e[i].binding;-1!==r.groupIndex&&(void 0===t[r.groupIndex]?t[r.groupIndex]=r.bindingIndex:t[r.groupIndex]=Math.max(t[r.groupIndex],r.bindingIndex))}this.freeGroupIndex=t.length-1,0===this.freeGroupIndex?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){let i=this._attributeNextLocation;return this._attributeNextLocation+=(aF[e]??1)*(t||1),i}getVaryingNextLocation(e,t=0){let i=this._varyingNextLocation;return this._varyingNextLocation+=(aF[e]??1)*(t||1),i}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>65536-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),4===this.freeGroupIndex)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";let t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}aL._SimplifiedKnownBindings=!0,aL._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}},aL._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class aw extends aO{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this._vertexIsGLES3=!1,this._fragmentIsGLES3=!1,this.shaderLanguage=0,this.parseGLES3=!0}_getArraySize(e,t,i){let r=0,s=e.indexOf("["),n=e.indexOf("]");if(s>0&&n>0){let t=e.substring(s+1,n);isNaN(r=+t)&&(r=+i[t.trim()]),e=e.substring(0,s)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0,this.attributeKeywordName=void 0,this.varyingVertexKeywordName=void 0,this.varyingFragmentKeywordName=void 0}preProcessShaderCode(e,t){let i=`// Internals UBO
uniform ${aO.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`,r=-1!==e.indexOf("// Internals UBO");return t?(this._fragmentIsGLES3=-1!==e.indexOf("#version 3"),this._fragmentIsGLES3&&(this.varyingFragmentKeywordName="in"),r?e:i+"##INJECTCODE##\n"+e):(this._vertexIsGLES3=-1!==e.indexOf("#version 3"),this._vertexIsGLES3&&(this.attributeKeywordName="in",this.varyingVertexKeywordName="out"),r?e:i+e)}varyingCheck(e,t){return(t&&this._fragmentIsGLES3?/(flat\s)?\s*\bin\b/:!t&&this._vertexIsGLES3?/(flat\s)?\s*\bout\b/:/(flat\s)?\s*\bvarying\b/).test(e)}varyingProcessor(e,t,i){this._preProcessors=i;let r=(t&&this._fragmentIsGLES3?/\s*(flat)?\s*in\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:!t&&this._vertexIsGLES3?/\s*(flat)?\s*out\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm:/\s*(flat)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==r){let s;let n=r[1]??"",a=r[2],o=r[3];t?(s=this._webgpuProcessingContext.availableVaryings[o],this._missingVaryings[s]="",void 0===s&&re.Y.Warn(`Invalid fragment shader: The varying named "${o}" is not declared in the vertex shader! This declaration will be ignored.`)):(s=this._webgpuProcessingContext.getVaryingNextLocation(a,this._getArraySize(o,a,i)[2]),this._webgpuProcessingContext.availableVaryings[o]=s,this._missingVaryings[s]=`layout(location = ${s}) ${n} in ${a} ${o};`),e=e.replace(r[0],void 0===s?"":`layout(location = ${s}) ${n} ${t?"in":"out"} ${a} ${o};`)}return e}attributeProcessor(e,t){this._preProcessors=t;let i=(this._vertexIsGLES3?/\s*in\s+(\S+)\s+(\S+)\s*;/gm:/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm).exec(e);if(null!==i){let r=i[1],s=i[2],n=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(s,r,t)[2]);this._webgpuProcessingContext.availableAttributes[s]=n,this._webgpuProcessingContext.orderedAttributes[n]=s;let a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[s];if(void 0!==a){let t=`_int_${s}_`;e=e.replace(i[0],`layout(location = ${n}) in ${a<0?-1===a?"int":"ivec"+-a:1===a?"uint":"uvec"+a} ${t}; ${r} ${s} = ${r}(${t});`)}else e=e.replace(i[0],`layout(location = ${n}) in ${r} ${s};`)}return e}uniformProcessor(e,t,i){this._preProcessors=i;let r=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(null!==r){let s=r[1],n=r[2];if(0===s.indexOf("sampler")||1===s.indexOf("sampler")){let r=0;[n,s,r]=this._getArraySize(n,s,i);let a=this._webgpuProcessingContext.availableTextures[n];if(!a){a={autoBindSampler:!0,isTextureArray:r>0,isStorageTexture:!1,textures:[],sampleType:"float"};for(let e=0;e<(r||1);++e)a.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}let o=aO._SamplerTypeByWebGLSamplerType[s]??"sampler",l=!!aO._IsComparisonSamplerByWebGPUSamplerType[o],c=n+"Sampler",u=this._webgpuProcessingContext.availableSamplers[c];u||(u={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l?"comparison":"filtering"});let h="u"===s.charAt(0)?"u":"i"===s.charAt(0)?"i":"";h&&(s=s.substring(1)),a.sampleType=l?"depth":"u"===h?"uint":"i"===h?"sint":"float";let d=r>0,f=u.binding.groupIndex,p=u.binding.bindingIndex,m=aO._SamplerFunctionByWebGLSamplerType[s],_=aO._TextureTypeByWebGLSamplerType[s],g=aO._GpuTextureViewDimensionByWebGPUTextureType[_];if(d){let t=[];t.push(`layout(set = ${f}, binding = ${p}) uniform ${h}${o} ${c};`),e=`
`;for(let i=0;i<r;++i){let r=a.textures[i].groupIndex,s=a.textures[i].bindingIndex;t.push(`layout(set = ${r}, binding = ${s}) uniform ${_} ${n}Texture${i};`),e+=`${i>0?"\n":""}#define ${n}${i} ${h}${m}(${n}Texture${i}, ${c})`}e=t.join("\n")+e,this._textureArrayProcessing.push(n)}else r=1,e=`layout(set = ${f}, binding = ${p}) uniform ${o} ${c};
                        layout(set = ${a.textures[0].groupIndex}, binding = ${a.textures[0].bindingIndex}) uniform ${h}${_} ${n}Texture;
                        #define ${n} ${h}${m}(${n}Texture, ${c})`;this._webgpuProcessingContext.availableTextures[n]=a,this._webgpuProcessingContext.availableSamplers[c]=u,this._addSamplerBindingDescription(c,u,!t);for(let e=0;e<r;++e)this._addTextureBindingDescription(n,a,e,g,null,!t)}else this._addUniformToLeftOverUBO(n,s,i),e=""}return e}uniformBufferProcessor(e,t){let i=/uniform\s+(\w+)/gm.exec(e);if(null!==i){let r=i[1],s=this._webgpuProcessingContext.availableBuffers[r];if(!s){let e=aL.KnownUBOs[r];s={binding:e&&-1!==e.binding.groupIndex?e.binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[r]=s}this._addBufferBindingDescription(r,s,"uniform",!t),e=e.replace("uniform",`layout(set = ${s.binding.groupIndex}, binding = ${s.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,r,s){let n=-1!==e.search(/#extension.+GL_EXT_draw_buffers.+require/);if(e=(e=e.replace(/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g,"")).replace(/texture2D\s*\(/g,"texture("),i){let t=e.indexOf("gl_FragCoord")>=0,i=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,r=-1!==e.search(/layout *\(location *= *0\) *out/g);if(e=(e=(e=(e=(e=(e=(e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod(")).replace(/textureCubeLodEXT\s*\(/g,"textureLod(")).replace(/textureCube\s*\(/g,"texture(")).replace(/gl_FragDepthEXT/g,"gl_FragDepth")).replace(/gl_FragColor/g,"glFragColor")).replace(/gl_FragData/g,"glFragData")).replace(/gl_FragCoord/g,"glFragCoord_"),this._fragmentIsGLES3){let t=/^\s*out\s+\S+\s+\S+\s*;/gm.exec(e);null!==t&&(e=e.substring(0,t.index)+"layout(location = 0) "+e.substring(t.index))}else e=e.replace(/void\s+?main\s*\(/g,(n||r?"":"layout(location = 0) out vec4 glFragColor;\n")+"void main(");e=(e=e.replace(/dFdy/g,"(-yFactor_)*dFdy")).replace("##INJECTCODE##",t?"vec4 glFragCoord_;\n":""),t&&(e=(0,aa.e0)(e,"void main",i))}else if(e=(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex")).replace(/gl_VertexID/g,"gl_VertexIndex"),-1!==t.indexOf("#define MULTIVIEW"))return"#extension GL_OVR_multiview2 : require\nlayout (num_views = 2) in;\n"+e;if(!i){let t=e.lastIndexOf("}");e=e.substring(0,t)+"gl_Position.y *= yFactor_;\n}"}return e}_applyTextureArrayProcessing(e,t){let i=RegExp(t+"\\s*\\[(.+)?\\]","gm"),r=i.exec(e);for(;null!==r;){let s=r[1],n=+s;this._preProcessors&&isNaN(n)&&(n=+this._preProcessors[s.trim()]),e=e.replace(r[0],t+n),r=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(let e of this._webgpuProcessingContext.leftOverUniforms)e.length>0?i+=`    ${e.type} ${e.name}[${e.length}];
`:i+=`    ${e.type} ${e.name};
`;return i+"};\n\n"}finalizeShaders(e,t){for(let i=0;i<this._textureArrayProcessing.length;++i){let r=this._textureArrayProcessing[i];e=this._applyTextureArrayProcessing(e,r),t=this._applyTextureArrayProcessing(t,r)}for(let e=0;e<this._missingVaryings.length;++e){let i=this._missingVaryings[e];i&&i.length>0&&(t=i+"\n"+t)}let i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}}i(7694),i(80867),i(93725),i(90860),i(42766),i(53176),i(31896),i(74575),i(67356);let aB="fragmentOutputs.fragDepth",aV={texture_1d:"1d",texture_2d:"2d",texture_2d_array:"2d-array",texture_3d:"3d",texture_cube:"cube",texture_cube_array:"cube-array",texture_multisampled_2d:"2d",texture_depth_2d:"2d",texture_depth_2d_array:"2d-array",texture_depth_cube:"cube",texture_depth_cube_array:"cube-array",texture_depth_multisampled_2d:"2d",texture_storage_1d:"1d",texture_storage_2d:"2d",texture_storage_2d_array:"2d-array",texture_storage_3d:"3d",texture_external:null};class aU extends aO{constructor(){super(...arguments),this.shaderLanguage=1,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0,this.pureMode=!1}preProcessor(e,t,i,r,s){for(let t in i){if("__VERSION__"===t)continue;let r=i[t];isNaN(parseInt(r))&&isNaN(parseFloat(r))||(e=`const ${t} = ${r};
`+e)}return e}_getArraySize(e,t,i){let r=0,s=t.lastIndexOf(">");if(t.indexOf("array")>=0&&s>0){let e=s;for(;e>0&&" "!==t.charAt(e)&&","!==t.charAt(e);)e--;let n=t.substring(e+1,s);for(isNaN(r=+n)&&(r=+i[n.trim()]);e>0&&(" "===t.charAt(e)||","===t.charAt(e));)e--;t=t.substring(t.indexOf("<")+1,e+1)}return[e,t,r]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesInputWGSL=[],this._attributesWGSL=[],this._attributesConversionCodeWGSL=[],this._hasNonFloatAttribute=!1,this._varyingsWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){let t=this.pureMode?"":`struct ${aO.InternalsUBOName} {
  yFactor_: f32,
  textureOutputHeight_: f32,
};
var<uniform> internals : ${aO.InternalsUBOName};
`;return -1!==e.indexOf(t)?e:t+(0,aa.Kt)(e)}varyingCheck(e){return/(flat|linear|perspective)?\s*(center|centroid|sample)?\s*\bvarying\b/.test(e)}varyingProcessor(e,t,i){let r=/\s*(flat|linear|perspective)?\s*(center|centroid|sample)?\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==r){let s;let n=r[1]??"perspective",a=r[2]??"center",o=r[4],l=r[3],c="flat"===n?`@interpolate(${n})`:`@interpolate(${n}, ${a})`;t?void 0===(s=this._webgpuProcessingContext.availableVaryings[l])&&re.Y.Warn(`Invalid fragment shader: The varying named "${l}" is not declared in the vertex shader! This declaration will be ignored.`):(s=this._webgpuProcessingContext.getVaryingNextLocation(o,this._getArraySize(l,o,i)[2]),this._webgpuProcessingContext.availableVaryings[l]=s,this._varyingsWGSL.push(`  @location(${s}) ${c} ${l} : ${o},`),this._varyingNamesWGSL.push(l)),e=""}return e}attributeProcessor(e,t){let i=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(null!==i){let r=i[2],s=i[1],n=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(s,r,t)[2]);this._webgpuProcessingContext.availableAttributes[s]=n,this._webgpuProcessingContext.orderedAttributes[n]=s;let a=this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents[s];if(void 0!==a){let e=`_int_${s}_`;this._attributesInputWGSL.push(`@location(${n}) ${e} : ${a<0?-1===a?"i32":"vec"+-a+"<i32>":1===a?"u32":"vec"+a+"<u32>"},`),this._attributesWGSL.push(`${s} : ${r},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${s} = ${r}(vertexInputs_.${e});`),this._hasNonFloatAttribute=!0}else this._attributesInputWGSL.push(`@location(${n}) ${s} : ${r},`),this._attributesWGSL.push(`${s} : ${r},`),this._attributesConversionCodeWGSL.push(`vertexInputs.${s} = vertexInputs_.${s};`);e=""}return e}uniformProcessor(e,t,i){let r=this.uniformRegexp.exec(e);if(null!==r){let t=r[2],s=r[1];this._addUniformToLeftOverUBO(s,t,i),e=""}return e}textureProcessor(e,t,i){let r=this.textureRegexp.exec(e);if(null!==r){let s=r[1],n=r[2],a=!!r[3],o=r[4],l=o.indexOf("storage")>0,c=r[6],u=l?c.substring(0,c.indexOf(",")).trim():null,h=a?this._getArraySize(s,n,i)[2]:0,d=this._webgpuProcessingContext.availableTextures[s];if(d)h=d.textures.length;else{d={isTextureArray:h>0,isStorageTexture:l,textures:[],sampleType:"float"},h=h||1;for(let e=0;e<h;++e)d.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[s]=d;let f=o.indexOf("depth")>0,p=aV[o];if(d.sampleType=f?"depth":"u32"===c?"uint":"i32"===c?"sint":"float",void 0===p)throw`Can't get the texture dimension corresponding to the texture function "${o}"!`;for(let i=0;i<h;++i){let{groupIndex:r,bindingIndex:n}=d.textures[i];0===i&&(e=`@group(${r}) @binding(${n}) ${e}`),this._addTextureBindingDescription(s,d,i,p,u,!t)}}return e}postProcessor(e){let t;let i=/#define (.+?) (.+?)$/gm;for(;null!==(t=i.exec(e));)e=e.replace(RegExp(t[1],"g"),t[2]);return e}finalizeShaders(e,t){let i=t.indexOf("fragmentInputs.position")>=0&&!this.pureMode?`
            if (internals.yFactor_ == 1.) {
                fragmentInputs.position.y = internals.textureOutputHeight_ - fragmentInputs.position.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);let r=this._buildLeftOverUBO();e=r+e,t=r+t,e=(e=e.replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;")).replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);let s="struct VertexInputs {\n  @builtin(vertex_index) vertexIndex : u32,\n  @builtin(instance_index) instanceIndex : u32,\n";this._attributesInputWGSL.length>0&&(s+=this._attributesInputWGSL.join("\n")),s+="\n};\nvar<private> vertexInputs"+(this._hasNonFloatAttribute?"_":"")+" : VertexInputs;\n",this._hasNonFloatAttribute&&(s+="struct VertexInputs_ {\n  vertexIndex : u32, instanceIndex : u32,\n"+this._attributesWGSL.join("\n")+"\n};\nvar<private> vertexInputs : VertexInputs_;\n");let n="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n";this._varyingsWGSL.length>0&&(n+=this._varyingsWGSL.join("\n")),n+="\n};\nvar<private> vertexOutputs : FragmentInputs;\n",e=s+n+e;let a=`
  vertexInputs${this._hasNonFloatAttribute?"_":""} = input;
`;this._hasNonFloatAttribute&&(a+="vertexInputs.vertexIndex = vertexInputs_.vertexIndex;\nvertexInputs.instanceIndex = vertexInputs_.instanceIndex;\n"+this._attributesConversionCodeWGSL.join("\n")+"\n");let o=this.pureMode?"  return vertexOutputs;":`  vertexOutputs.position.y = vertexOutputs.position.y * internals.yFactor_;
  return vertexOutputs;`,l=-1!==e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS");e=(l?"diagnostic(off, derivative_uniformity);\n":"")+(0,aa.e0)(e,"fn main",a,o),t=(t=t.replace(/#define (\w+)\s+(\d+\.?\d*)/g,"const $1 = $2;")).replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),this.pureMode||(t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy"));let c="struct FragmentInputs {\n  @builtin(position) position : vec4<f32>,\n  @builtin(front_facing) frontFacing : bool,\n";this._varyingsWGSL.length>0&&(c+=this._varyingsWGSL.join("\n")),c+="\n};\nvar<private> fragmentInputs : FragmentInputs;\n";let u="struct FragmentOutputs {\n",h="fragmentOutputs\\.fragData",d=t.match(RegExp(h+"0","g")),f=0;if(d){u+=` @location(${f}) fragData0 : vec4<f32>,
`,f++;for(let e=1;e<8;e++)(d=t.match(RegExp(h+e,"g")))&&(u+=` @location(${f}) fragData${f} : vec4<f32>,
`,f++);-1!==t.indexOf("MRT_AND_COLOR")&&(u+=`  @location(${f}) color : vec4<f32>,
`,f++)}(d=t.match(/oitDepthSampler/))&&(u+=` @location(${f++}) depth : vec2<f32>,
 @location(${f++}) frontColor : vec4<f32>,
 @location(${f++}) backColor : vec4<f32>,
`),0===f&&(u+="  @location(0) color : vec4<f32>,\n",f++);let p=!1,m=0;for(;!p&&!((m=t.indexOf(aB,m))<0);){let e=m;for(p=!0;m>1&&"\n"!==t.charAt(m);){if("/"===t.charAt(m)&&"/"===t.charAt(m-1)){p=!1;break}m--}m=e+aB.length}return p&&(u+="  @builtin(frag_depth) fragDepth: f32,\n"),u+="};\nvar<private> fragmentOutputs : FragmentOutputs;\n",t=((l=-1!==(t=c+u+t).indexOf("#define DISABLE_UNIFORMITY_ANALYSIS"))?"diagnostic(off, derivative_uniformity);\n":"")+(0,aa.e0)(t,"fn main","  fragmentInputs = input;\n  "+i,"  return fragmentOutputs;"),this._collectBindingNames(),this._preCreateBindGroupEntries(),this._webgpuProcessingContext.vertexBufferKindToNumberOfComponents={},{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",r=`struct ${e} {
`;for(let t of this._webgpuProcessingContext.leftOverUniforms){let s=t.type.replace(/^(.*?)(<.*>)?$/,"$1"),n=aO.UniformSizes[s];if(t.length>0){if(n<=2){let n=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${n} {
                        @size(16)
                        el: ${s},
                    }`,this._stridedUniformArrays.push(t.name),r+=` @align(16) ${t.name} : array<${n}, ${t.length}>,
`}else r+=` ${t.name} : array<${t.type}, ${t.length}>,
`}else r+=`  ${t.name} : ${t.type},
`}return r+="};\n",r=`${i}
${r}@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> uniforms : ${e};
`}_processSamplers(e,t){let i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){let r=i.exec(e);if(null===r)break;let s=r[1],n=r[2],a=s.length-7,o=s.lastIndexOf("Sampler")===a?s.substring(0,a):null,l="sampler_comparison"===n?"comparison":"filtering";if(o){let e=this._webgpuProcessingContext.availableTextures[o];e&&(e.autoBindSampler=!0)}let c=this._webgpuProcessingContext.availableSamplers[s];c||(c={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[s]=c),this._addSamplerBindingDescription(s,c,t);let u=e.substring(0,r.index),h=`@group(${c.binding.groupIndex}) @binding(${c.binding.bindingIndex}) `;e=u+h+e.substring(r.index),i.lastIndex+=h.length}return e}_processCustomBuffers(e,t){let i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){let r=i.exec(e);if(null===r)break;let s=r[1],n=r[3],a=r[4],o=r[5],l=this._webgpuProcessingContext.availableBuffers[a];if(!l){let e;let t="uniform"===s?aL.KnownUBOs[o]:null;t?(a=o,-1!==(e=t.binding).groupIndex||(e=this._webgpuProcessingContext.availableBuffers[a]?.binding)||(e=this._webgpuProcessingContext.getNextFreeUBOBinding())):e=this._webgpuProcessingContext.getNextFreeUBOBinding(),l={binding:e},this._webgpuProcessingContext.availableBuffers[a]=l}this._addBufferBindingDescription(a,this._webgpuProcessingContext.availableBuffers[a],"read_write"===n?"storage":"storage"===s?"read-only-storage":"uniform",t);let c=l.binding.groupIndex,u=l.binding.bindingIndex,h=e.substring(0,r.index),d=`@group(${c}) @binding(${u}) `;e=h+d+e.substring(r.index),i.lastIndex+=d.length}return e}_processStridedUniformArrays(e){for(let t of this._stridedUniformArrays)e=e.replace(RegExp(`${t}\\s*\\[(.*?)\\]`,"g"),`${t}[$1].el`);return e}}class ak{get underlyingResource(){return this._webgpuTexture}getMSAATexture(e=0){return this._webgpuMSAATexture?.[e]??null}setMSAATexture(e,t=-1){this._webgpuMSAATexture||(this._webgpuMSAATexture=[]),-1===t&&(t=this._webgpuMSAATexture.length),this._webgpuMSAATexture[t]=e}releaseMSAATexture(){if(this._webgpuMSAATexture){for(let e of this._webgpuMSAATexture)e?.destroy();this._webgpuMSAATexture=null}}constructor(e=null){this._originalFormatIsRGB=!1,this.format="rgba8unorm",this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}set(e){this._webgpuTexture=e}setUsage(e,t,i,r,s,n,a,o){let l="2d",c=1;r?(l=i?"cube-array":"cube",c=6*(o||1)):s?(l="3d",c=1):i&&(l="2d-array",c=o);let u=aR.GetDepthFormatOnly(this.format),h=aR.HasDepthAndStencilAspects(this.format)?"depth-only":"all";this.createView({label:`TextureView${s?"3D":r?"Cube":"2D"}${i?"_Array"+c:""}_${n}x${a}_${t?"wmips":"womips"}_${this.format}_${l}`,format:u,dimension:l,mipLevelCount:t?(0,aP.ILog2)(Math.max(n,a))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:c,aspect:h})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){let t=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=t}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){this._webgpuTexture?.destroy(),this.releaseMSAATexture(),this._copyInvertYTempTexture?.destroy(),this.reset()}}let aG=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    varying vTex: vec2f;

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.vTex = tex[input.vertexIndex];
        vertexOutputs.position = vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,az=`
    var imgSampler: sampler;
    var img: texture_2d<f32>;

    varying vTex: vec2f;

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = textureSample(img, imgSampler, input.vTex);
    }
    `,aH=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));
    const tex = array<vec2<f32>, 4>( vec2f(0.0f, 0.0f),  vec2f(1.0f, 0.0f),  vec2f(0.0f, 1.0f),  vec2f(1.0f, 1.0f));

    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        #ifdef INVERTY
            vertexOutputs.vTextureSize = vec2f(textureDimensions(img, 0));
        #endif
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,aW=`
    var img: texture_2d<f32>;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(input.vTextureSize.y - input.position.y)), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        fragmentOutputs.color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,aY=`
    var img: texture_2d<f32>;
    uniform ofstX: f32;
    uniform ofstY: f32;
    uniform width: f32;
    uniform height: f32;

    #ifdef INVERTY
        varying vTextureSize: vec2f;
    #endif

    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        if (input.position.x < uniforms.ofstX || input.position.x >= uniforms.ofstX + uniforms.width) {
            discard;
        }
        if (input.position.y < uniforms.ofstY || input.position.y >= uniforms.ofstY + uniforms.height) {
            discard;
        }
    #ifdef INVERTY
        var color: vec4f = textureLoad(img, vec2i(i32(input.position.x), i32(uniforms.ofstY + uniforms.height - (input.position.y - uniforms.ofstY))), 0);
    #else
        var color: vec4f = textureLoad(img, vec2i(input.position.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color = vec4f(color.rgb * color.a, color.a);
    #endif
        fragmentOutputs.color = color;
    }
    `,aX=`
    const pos = array<vec2<f32>, 4>( vec2f(-1.0f, 1.0f),  vec2f(1.0f, 1.0f),  vec2f(-1.0f, -1.0f),  vec2f(1.0f, -1.0f));

    @vertex
    fn main(input : VertexInputs) -> FragmentInputs {
        vertexOutputs.position =  vec4f(pos[input.vertexIndex], 0.0, 1.0);
    }
    `,a$=`
    uniform color: vec4f;


    @fragment
    fn main(input: FragmentInputs) -> FragmentOutputs {
        fragmentOutputs.color = uniforms.color;
    }
    `,aj=`
    struct VertexOutput {
        @builtin(position) Position : vec4<f32>,
        @location(0) fragUV : vec2<f32>
    }

    @vertex
    fn main(
        @builtin(vertex_index) VertexIndex : u32
    ) -> VertexOutput {
        var pos = array<vec2<f32>, 4>(
            vec2(-1.0,  1.0),
            vec2( 1.0,  1.0),
            vec2(-1.0, -1.0),
            vec2( 1.0, -1.0)
        );
        var tex = array<vec2<f32>, 4>(
            vec2(0.0, 0.0),
            vec2(1.0, 0.0),
            vec2(0.0, 1.0),
            vec2(1.0, 1.0)
        );

        var output: VertexOutput;

        output.Position = vec4<f32>(pos[VertexIndex], 0.0, 1.0);
        output.fragUV = tex[VertexIndex];

        return output;
    }
    `,aq=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, fragUV);
    }
    `,aQ=`
    @group(0) @binding(0) var videoSampler: sampler;
    @group(0) @binding(1) var videoTexture: texture_external;

    @fragment
    fn main(
        @location(0) fragUV: vec2<f32>
    ) -> @location(0) vec4<f32> {
        return textureSampleBaseClampToEdge(videoTexture, videoSampler, vec2<f32>(fragUV.x, 1.0 - fragUV.y));
    }
    `;($=tW||(tW={}))[$.MipMap=0]="MipMap",$[$.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",$[$.Clear=2]="Clear",$[$.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst",(j=tY||(tY={}))[j.DontInvertY=0]="DontInvertY",j[j.InvertY=1]="InvertY";let aK=[{vertex:aG,fragment:az},{vertex:aH,fragment:aW},{vertex:aX,fragment:a$},{vertex:aH,fragment:aY}],aZ={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2uint:22,rgb10a2unorm:23,rg32uint:24,rg32sint:25,rg32float:26,rgba16uint:27,rgba16sint:28,rgba16float:29,rgba32uint:30,rgba32sint:31,rgba32float:32,stencil8:33,depth16unorm:34,depth24plus:35,"depth24plus-stencil8":36,depth32float:37,"depth32float-stencil8":38};class aJ{constructor(e,t,i,r){if(this._pipelines={},this._compiledShaders=[],this._videoPipelines={},this._videoCompiledShaders=[],this._deferredReleaseTextures=[],this._engine=e,this._device=t,this._bufferManager=i,-1!==r.indexOf("rg11b10ufloat-renderable")){let e=Object.keys(aZ);aZ.rg11b10ufloat=aZ[e[e.length-1]]+1}this._mipmapSampler=t.createSampler({minFilter:"linear"}),this._videoSampler=t.createSampler({minFilter:"linear"}),this._ubCopyWithOfst=this._bufferManager.createBuffer(16,to.Uniform|to.CopyDst,"UBCopyWithOffset").underlyingResource,this._getPipeline("rgba8unorm"),this._getVideoPipeline("rgba8unorm")}_getPipeline(e,t=tW.MipMap,i){let r=t===tW.MipMap?1:t===tW.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===tW.Clear?8:t===tW.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let s=this._pipelines[e][r];if(!s){let n="";(t===tW.InvertYPremultiplyAlpha||t===tW.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(n+="#define INVERTY\n"),i.premultiplyAlpha&&(n+="#define PREMULTIPLYALPHA\n"));let a=this._compiledShaders[r];if(!a){let e=aK[t].vertex,i=aK[t].fragment,s={defines:n.split("\n"),indexParameters:null,isFragment:!1,shouldUseHighPrecisionShader:!0,processor:this._engine._getShaderProcessor(1),supportsUniformBuffers:!0,shadersRepository:"",includesShadersStore:{},version:(100*this._engine.version).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._engine._getShaderProcessingContext(1,!0),isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};(0,nO.wz)(s),s.processor.pureMode=!0,(0,nO.An)(e,s,t=>{e=t},this._engine),s.isFragment=!0,(0,nO.An)(i,s,e=>{i=e},this._engine);let o=(0,nO.Ku)(e,i,s);s.processor.pureMode=!1;let l=this._device.createShaderModule({code:o.vertexCode}),c=this._device.createShaderModule({code:o.fragmentCode});a=this._compiledShaders[r]=[l,c]}let o=this._device.createRenderPipeline({layout:"auto",vertex:{module:a[0],entryPoint:"main"},fragment:{module:a[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});s=this._pipelines[e][r]=[o,o.getBindGroupLayout(0)]}return s}_getVideoPipeline(e,t=tY.DontInvertY){let i=t===tY.InvertY?1:0;this._videoPipelines[e]||(this._videoPipelines[e]=[]);let r=this._videoPipelines[e][i];if(!r){let t=this._videoCompiledShaders[i];if(!t){let e=this._device.createShaderModule({code:aj}),r=this._device.createShaderModule({code:0===i?aq:aQ});t=this._videoCompiledShaders[i]=[e,r]}let s=this._device.createRenderPipeline({label:`BabylonWebGPUDevice${this._engine.uniqueId}_CopyVideoToTexture_${e}_${0===i?"DontInvertY":"InvertY"}`,layout:"auto",vertex:{module:t[0],entryPoint:"main"},fragment:{module:t[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"}});r=this._videoPipelines[e][i]=[s,s.getBindGroupLayout(0)]}return r}setCommandEncoder(e){this._commandEncoderForCreation=e}copyVideoToTexture(e,t,i,r=!1,s){let n=void 0===s,[a,o]=this._getVideoPipeline(i,r?tY.InvertY:tY.DontInvertY);n&&(s=this._device.createCommandEncoder({})),s.pushDebugGroup?.(`copy video to texture - invertY=${r}`);let l=t._hardwareTexture,c={label:`BabylonWebGPUDevice${this._engine.uniqueId}_copyVideoToTexture_${i}_${r?"InvertY":"DontInvertY"}${t.label?"_"+t.label:""}`,colorAttachments:[{view:l.underlyingResource.createView({format:i,dimension:"2d",mipLevelCount:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"}),loadOp:"load",storeOp:"store"}]},u=s.beginRenderPass(c),h={layout:o,entries:[{binding:0,resource:this._videoSampler},{binding:1,resource:this._device.importExternalTexture({source:e.underlyingResource})}]},d=this._device.createBindGroup(h);u.setPipeline(a),u.setBindGroup(0,d),u.draw(4,1,0,0),u.end(),s.popDebugGroup?.(),n&&(this._device.queue.submit([s.finish()]),s=null)}invertYPreMultiplyAlpha(e,t,i,r,s=!1,n=!1,a=0,o=0,l=1,c=0,u=0,h=0,d=0,f,p){let m;let _=0!==h,g=void 0===f,[v,S]=this._getPipeline(r,_?tW.InvertYPremultiplyAlphaWithOfst:tW.InvertYPremultiplyAlpha,{invertY:s,premultiplyAlpha:n});if(a=Math.max(a,0),g&&(f=this._device.createCommandEncoder({})),f.pushDebugGroup?.(`internal process texture - invertY=${s} premultiplyAlpha=${n}`),aR.IsHardwareTexture(e)?(m=e.underlyingResource,s&&!n&&1===l&&0===a||(e=void 0)):(m=e,e=void 0),!m)return;_&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([c,u,h,d]),0,16);let x=e,E=x?._copyInvertYTempTexture??this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,r,1,f,21,void 0,"TempTextureForCopyWithInvertY"),C=x?._copyInvertYRenderPassDescr??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_invertYPreMultiplyAlpha_${r}_${s?"InvertY":"DontInvertY"}_${n?"PremultiplyAlpha":"DontPremultiplyAlpha"}`,colorAttachments:[{view:E.createView({format:r,dimension:"2d",baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:"load",storeOp:"store"}]},T=f.beginRenderPass(C),b=_?x?._copyInvertYBindGroupWithOfst:x?._copyInvertYBindGroup;if(!b){let e={layout:S,entries:[{binding:0,resource:m.createView({format:r,dimension:"2d",baseMipLevel:o,mipLevelCount:1,arrayLayerCount:l,baseArrayLayer:a})}]};_&&e.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),b=this._device.createBindGroup(e)}T.setPipeline(v),T.setBindGroup(0,b),T.draw(4,1,0,0),T.end(),f.copyTextureToTexture({texture:E},{texture:m,mipLevel:o,origin:{x:0,y:0,z:a}},{width:t,height:i,depthOrArrayLayers:1}),x?(x._copyInvertYTempTexture=E,x._copyInvertYRenderPassDescr=C,_?x._copyInvertYBindGroupWithOfst=b:x._copyInvertYBindGroup=b):this._deferredReleaseTextures.push([E,null]),f.popDebugGroup?.(),g&&(this._device.queue.submit([f.finish()]),f=null)}copyWithInvertY(e,t,i,r){let s=void 0===r,[n,a]=this._getPipeline(t,tW.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});s&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup?.("internal copy texture with invertY");let o=r.beginRenderPass(i),l=this._device.createBindGroup({layout:a,entries:[{binding:0,resource:e}]});o.setPipeline(n),o.setBindGroup(0,l),o.draw(4,1,0,0),o.end(),r.popDebugGroup?.(),s&&(this._device.queue.submit([r.finish()]),r=null)}createTexture(e,t=!1,i=!1,r=!1,s=!1,n=!1,a="rgba8unorm",o=1,l,c=-1,u=0,h){o=aR.GetSample(o);let d=e.layers||1,f={width:e.width,height:e.height,depthOrArrayLayers:d},p=aZ[a]?16:0,m=aR.IsCompressedFormat(a),_=t?aR.ComputeNumMipmapLevels(e.width,e.height):1;u|=t&&!m?1|p:0,m||n||(u|=2|p);let g=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_Texture${n?"3D":"2D"}_${h?h+"_":""}${f.width}x${f.height}x${f.depthOrArrayLayers}_${t?"wmips":"womips"}_${a}_samples${o}`,size:f,dimension:n?"3d":"2d",format:a,usage:(c>=0?c:7)|u,sampleCount:o,mipLevelCount:_});return aR.IsImageBitmap(e)&&(this.updateTexture(e,g,e.width,e.height,d,a,0,0,r,s,0,0),t&&i&&this.generateMipmaps(g,a,_,0,n,l)),g}createCubeTexture(e,t=!1,i=!1,r=!1,s=!1,n="rgba8unorm",a=1,o,l=-1,c=0,u){a=aR.GetSample(a);let h=aR.IsImageBitmapArray(e)?e[0].width:e.width,d=aR.IsImageBitmapArray(e)?e[0].height:e.height,f=aZ[n]?16:0,p=aR.IsCompressedFormat(n),m=t?aR.ComputeNumMipmapLevels(h,d):1;c|=t&&!p?1|f:0,p||(c|=2|f);let _=this._device.createTexture({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureCube_${u?u+"_":""}${h}x${d}x6_${t?"wmips":"womips"}_${n}_samples${a}`,size:{width:h,height:d,depthOrArrayLayers:6},dimension:"2d",format:n,usage:(l>=0?l:7)|c,sampleCount:a,mipLevelCount:m});return aR.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,_,h,d,n,r,s,0,0),t&&i&&this.generateCubeMipmaps(_,n,m,o)),_}generateCubeMipmaps(e,t,i,r){let s=void 0===r;s&&(r=this._device.createCommandEncoder({})),r.pushDebugGroup?.(`create cube mipmaps - ${i} levels`);for(let s=0;s<6;++s)this.generateMipmaps(e,t,i,s,!1,r);r.popDebugGroup?.(),s&&(this._device.queue.submit([r.finish()]),r=null)}generateMipmaps(e,t,i,r=0,s=!1,n){let a;let o=void 0===n,[l,c]=this._getPipeline(t);if(r=Math.max(r,0),o&&(n=this._device.createCommandEncoder({})),n.pushDebugGroup?.(`create mipmaps for face #${r} - ${i} levels`),aR.IsHardwareTexture(e)?(a=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(a=e,e=void 0),!a)return;let u=e;for(let e=1;e<i;++e){let i=u?._mipmapGenRenderPassDescr[r]?.[e-1]??{label:`BabylonWebGPUDevice${this._engine.uniqueId}_generateMipmaps_${t}_faceIndex${r}_level${e}`,colorAttachments:[{view:a.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:e,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r}),loadOp:"load",storeOp:"store"}]};u&&(u._mipmapGenRenderPassDescr[r]=u._mipmapGenRenderPassDescr[r]||[],u._mipmapGenRenderPassDescr[r][e-1]=i);let o=n.beginRenderPass(i),h=u?._mipmapGenBindGroup[r]?.[e-1]??this._device.createBindGroup({layout:c,entries:[{binding:0,resource:a.createView({format:t,dimension:s?"3d":"2d",baseMipLevel:e-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:r})},{binding:1,resource:this._mipmapSampler}]});u&&(u._mipmapGenBindGroup[r]=u._mipmapGenBindGroup[r]||[],u._mipmapGenBindGroup[r][e-1]=h),o.setPipeline(l),o.setBindGroup(0,h),o.draw(4,1,0,0),o.end()}n.popDebugGroup?.(),o&&(this._device.queue.submit([n.finish()]),n=null)}createGPUTextureForInternalTexture(e,t,i,r,s){let n;e._hardwareTexture||(e._hardwareTexture=new ak),void 0===t&&(t=e.width),void 0===i&&(i=e.height),void 0===r&&(r=e.depth);let a=e._hardwareTexture,o=((s??0)&1)!=0;a.format=aR.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),a.textureUsages=5===e._source||6===e.source?21:12===e._source?20:-1,a.textureAdditionalUsages=o?8:0;let l=e.generateMipMaps,c=r||1;if(n=null!==e._maxLodLevel?e._maxLodLevel:l?aR.ComputeNumMipmapLevels(t,i):1,e.isCube){let r=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,a.format,1,this._commandEncoderForCreation,a.textureUsages,a.textureAdditionalUsages,e.label);a.set(r);let s=e.is3D?1:c,u=aR.GetDepthFormatOnly(a.format),h=aR.HasDepthAndStencilAspects(a.format)?"depth-only":"all",d=e.is2DArray?"cube-array":"cube";a.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureViewCube${e.is2DArray?"_Array"+s:""}_${t}x${i}_${l?"wmips":"womips"}_${u}_${d}_${h}_${e.label??"noname"}`,format:u,dimension:d,mipLevelCount:n,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:h},o)}else{let r=this.createTexture({width:t,height:i,layers:c},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,a.format,1,this._commandEncoderForCreation,a.textureUsages,a.textureAdditionalUsages,e.label);a.set(r);let s=e.is3D?1:c,u=aR.GetDepthFormatOnly(a.format),h=aR.HasDepthAndStencilAspects(a.format)?"depth-only":"all",d=e.is2DArray?"2d-array":e.is3D?"3d":"2d";a.createView({label:`BabylonWebGPUDevice${this._engine.uniqueId}_TextureView${e.is3D?"3D":"2D"}${e.is2DArray?"_Array"+s:""}_${t}x${i}${e.is3D?"x"+c:""}_${l?"wmips":"womips"}_${u}_${d}_${h}_${e.label??"noname"}`,format:u,dimension:d,mipLevelCount:n,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:s,aspect:h},o)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=r,this.createMSAATexture(e,e.samples),a}createMSAATexture(e,t,i=!0,r=-1){let s=e._hardwareTexture;if(i&&s?.releaseMSAATexture(),!s||(t??1)<=1)return;let n=e.width,a=e.height,o=this.createTexture({width:n,height:a,layers:1},!1,!1,!1,!1,!1,s.format,t,this._commandEncoderForCreation,16,0,e.label?"MSAA"+e.label:void 0);s.setMSAATexture(o,r)}updateCubeTextures(e,t,i,r,s,n=!1,a=!1,o=0,l=0){let c=[0,3,1,4,2,5];for(let u=0;u<c.length;++u){let h=e[c[u]];this.updateTexture(h,t,i,r,1,s,u,0,n,a,o,l)}}updateTexture(e,t,i,r,s,n,a=0,o=0,l=!1,c=!1,u=0,h=0,d){let f=aR.IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,p=aR.GetBlockInformationFromFormat(n),m=aR.IsInternalTexture(t)?t._hardwareTexture:t,_={texture:f,origin:{x:u,y:h,z:Math.max(a,0)},mipLevel:o,premultipliedAlpha:c},g={width:Math.ceil(i/p.width)*p.width,height:Math.ceil(r/p.height)*p.height,depthOrArrayLayers:s||1};if(void 0!==e.byteLength){let v=Math.ceil(i/p.width)*p.length;if(256*Math.ceil(v/256)===v){let t=this._device.createCommandEncoder({}),i=this._bufferManager.createRawBuffer(e.byteLength,to.MapWrite|to.CopySrc,!0,"TempBufferForUpdateTexture"+(f?"_"+f.label:""));new Uint8Array(i.getMappedRange()).set(e),i.unmap(),t.copyBufferToTexture({buffer:i,offset:0,bytesPerRow:v,rowsPerImage:r},_,g),this._device.queue.submit([t.finish()]),this._bufferManager.releaseBuffer(i)}else this._device.queue.writeTexture(_,e,{offset:0,bytesPerRow:v,rowsPerImage:r},g);if(l||c){if(aR.IsInternalTexture(t)){let e=0===u&&0===h&&i===t.width&&r===t.height;this.invertYPreMultiplyAlpha(m,t.width,t.height,n,l,c,a,o,s||1,u,h,e?0:i,e?0:r,void 0,d)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}}else if(l){if(_.premultipliedAlpha=!1,aR.IsInternalTexture(t)&&0===u&&0===h&&i===t.width&&r===t.height)this._device.queue.copyExternalImageToTexture({source:e},_,g),this.invertYPreMultiplyAlpha(m,i,r,n,l,c,a,o,s||1,0,0,0,0,void 0,d);else{let t=this._device.createCommandEncoder({}),u=this.createTexture({width:i,height:r,layers:1},!1,!1,!1,!1,!1,n,1,t,5,void 0,"TempTextureForUpdateTexture");this._deferredReleaseTextures.push([u,null]),g.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:u},g),g.depthOrArrayLayers=s||1,this.invertYPreMultiplyAlpha(u,i,r,n,l,c,a,o,s||1,0,0,0,0,t,d),t.copyTextureToTexture({texture:u},_,g),this._device.queue.submit([t.finish()])}}else this._device.queue.copyExternalImageToTexture({source:e},_,g)}readPixels(e,t,i,r,s,n,a=0,o=0,l=null,c=!1){let u=aR.GetBlockInformationFromFormat(n),h=Math.ceil(r/u.width)*u.length,d=256*Math.ceil(h/256),f=d*s,p=this._bufferManager.createRawBuffer(f,to.MapRead|to.CopyDst,void 0,"TempBufferForReadPixels"+(e.label?"_"+e.label:"")),m=this._device.createCommandEncoder({});return m.copyTextureToBuffer({texture:e,mipLevel:o,origin:{x:t,y:i,z:Math.max(a,0)}},{buffer:p,offset:0,bytesPerRow:d},{width:r,height:s,depthOrArrayLayers:1}),this._device.queue.submit([m.finish()]),this._bufferManager.readDataFromBuffer(p,f,r,s,h,d,aR.GetTextureTypeFromFormat(n),0,l,!0,c)}releaseTexture(e){if(aR.IsInternalTexture(e)){let t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){let[t,i]=this._deferredReleaseTextures[e];t&&(aR.IsHardwareTexture(t)?t.release():t.destroy()),i?.dispose()}this._deferredReleaseTextures.length=0}}class a0 extends si.h{set buffer(e){this._buffer=e}constructor(e,t=0){super(),this.engineId=-1,this.capacity=t,e&&(this._buffer=e)}get underlyingResource(){return this._buffer}}var a1=i(15096),a2=i(56172);class a3{static _IsGPUBuffer(e){return void 0===e.underlyingResource}static _FlagsToString(e,t=""){let i=t;for(let t=0;t<=9;++t)e&1<<t&&(i&&(i+="_"),i+=to[1<<t]);return i}constructor(e,t){this._deferredReleaseBuffers=[],this._engine=e,this._device=t}createRawBuffer(e,t,i=!1,r){let s=void 0!==e.byteLength?e.byteLength+3&-4:e+3&-4,n={label:"BabylonWebGPUDevice"+this._engine.uniqueId+"_"+a3._FlagsToString(t,r??"Buffer")+"_size"+s,mappedAtCreation:i,size:s,usage:t};return this._device.createBuffer(n)}createBuffer(e,t,i){let r=void 0!==e.byteLength,s=new a0,n="DataBufferUniqueId="+s.uniqueId;return s.buffer=this.createRawBuffer(e,t,void 0,i?n+"-"+i:n),s.references=1,s.capacity=r?e.byteLength:e,s.engineId=this._engine.uniqueId,r&&this.setSubData(s,0,e),s}setRawData(e,t,i,r,s){this._device.queue.writeBuffer(e,t,i.buffer,r,s)}setSubData(e,t,i,r=0,s=0){let n=e.underlyingResource;s=Math.min(s=s||i.byteLength,e.capacity-t);let a=i.byteOffset+r,o=a+s,l=s+3&-4;if(l!==s){let e=new Uint8Array(i.buffer.slice(a,o));(i=new Uint8Array(l)).set(e),r=0,a=0,o=l,s=l}let c=0;for(;o-(a+c)>15728640;)this._device.queue.writeBuffer(n,t+c,i.buffer,a+c,15728640),c+=15728640;this._device.queue.writeBuffer(n,t+c,i.buffer,a+c,s-c)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));let r=new Uint16Array(t);for(;e--;)i[e]=(0,a1.qZ)(r[e]);return i}readDataFromBuffer(e,t,i,r,s,n,a=0,o=0,l=null,c=!0,u=!1){let h=1===a?2:2===a?1:0,d=this._engine.uniqueId;return new Promise((i,f)=>{e.mapAsync(1,o,t).then(()=>{let d=e.getMappedRange(o,t),f=l;if(u)f=null===f?(0,a2.A8)(a,t,!0,d):(0,a2.A8)(a,f.buffer,void 0,d);else if(null===f)switch(h){case 0:(f=new Uint8Array(t)).set(new Uint8Array(d));break;case 1:f=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d);break;case 2:(f=new Float32Array(t/4)).set(new Float32Array(d))}else switch(h){case 0:(f=new Uint8Array(f.buffer)).set(new Uint8Array(d));break;case 1:f=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,d,l);break;case 2:(f=new Float32Array(f.buffer)).set(new Float32Array(d))}if(s!==n){1!==h||u||(s*=2,n*=2);let e=new Uint8Array(f.buffer),t=s,i=0;for(let a=1;a<r;++a){i=a*n;for(let r=0;r<s;++r)e[t++]=e[i++]}f=0===h||u?new Uint8Array(e.buffer,0,t):new Float32Array(e.buffer,0,t/4)}e.unmap(),c&&this.releaseBuffer(e),i(f)},e=>{this._engine.isDisposed||this._engine.uniqueId!==d?i(new Uint8Array):f(e)})})}releaseBuffer(e){return a3._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,0===e.references&&(this._deferredReleaseBuffers.push(e.underlyingResource),!0))}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}let a4=[0,0,3,7,0,2,6,2,4,1,5,3,1],a5=[0,64,32,96,16,80,48,112,8],a7=[0,128,128,0,0,0,0,128,0,0,0,0,128];class a6{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){let t=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1;return a4[e.samplingMode]+a5[(e._comparisonFunction||514)-512+1]+a7[e.samplingMode]+((e._cachedWrapU??1)<<8)+((e._cachedWrapV??1)<<10)+((e._cachedWrapR??1)<<12)+((e.useMipMaps?1:0)<<14)+(t<<15)}static _GetSamplerFilterDescriptor(e,t){let i,r,s,n,a;let o=e.useMipMaps;switch(e.samplingMode){case 11:i="linear",r="linear",s="nearest",o||(n=a=0);break;case 3:case 3:i="linear",r="linear",o?s="linear":(s="nearest",n=a=0);break;case 8:i="nearest",r="nearest",o?s="linear":(s="nearest",n=a=0);break;case 4:i="nearest",r="nearest",s="nearest",o||(n=a=0);break;case 5:i="nearest",r="linear",s="nearest",o||(n=a=0);break;case 6:i="nearest",r="linear",o?s="linear":(s="nearest",n=a=0);break;case 7:i="nearest",r="linear",s="nearest",n=a=0;break;case 1:case 1:default:i="nearest",r="nearest",s="nearest",n=a=0;break;case 9:i="linear",r="nearest",s="nearest",o||(n=a=0);break;case 10:i="linear",r="nearest",o?s="linear":(s="nearest",n=a=0);break;case 2:case 2:i="linear",r="linear",s="nearest",n=a=0;break;case 12:i="linear",r="nearest",s="nearest",n=a=0}return t>1&&(0!==n||0!==a)&&"nearest"!==s?{magFilter:"linear",minFilter:"linear",mipmapFilter:"linear",anisotropyEnabled:!0}:{magFilter:i,minFilter:r,mipmapFilter:s,lodMinClamp:n,lodMaxClamp:a}}static _GetWrappingMode(e){switch(e){case 1:break;case 0:return"clamp-to-edge";case 2:return"mirror-repeat"}return"repeat"}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e,t){let i=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,r=this._GetSamplerFilterDescriptor(e,i);return{label:t,...r,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?a6.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:r.anisotropyEnabled?i:1}}static GetCompareFunction(e){switch(e){case 519:return"always";case 514:return"equal";case 516:return"greater";case 518:return"greater-equal";case 513:default:return"less";case 515:return"less-equal";case 512:return"never";case 517:return"not-equal"}}getSampler(e,t=!1,i=0,r){if(this.disabled)return this._device.createSampler(a6._GetSamplerDescriptor(e,r));t?i=0:0===i&&(i=a6.GetSamplerHashCode(e));let s=t?void 0:this._samplers[i];return s||(s=this._device.createSampler(a6._GetSamplerDescriptor(e,r)),t||(this._samplers[i]=s)),s}}(q=tX||(tX={}))[q.StencilReadMask=0]="StencilReadMask",q[q.StencilWriteMask=1]="StencilWriteMask",q[q.DepthBias=2]="DepthBias",q[q.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",q[q.DepthStencilState=4]="DepthStencilState",q[q.MRTAttachments1=5]="MRTAttachments1",q[q.MRTAttachments2=6]="MRTAttachments2",q[q.RasterizationState=7]="RasterizationState",q[q.ColorStates=8]="ColorStates",q[q.ShaderStage=9]="ShaderStage",q[q.TextureStage=10]="TextureStage",q[q.VertexState=11]="VertexState",q[q.NumStates=12]="NumStates";let a8={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},a9={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};class oe{constructor(e,t){this.mrtTextureCount=0,this._device=e,this._useTextureStage=!0,this._states=Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=["bgra8unorm"],this.setColorFormat("bgra8unorm"),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat("depth24plus-stencil8"),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,r=0){if(i=aR.GetSample(i),this.disabled){let s=oe._GetTopology(e);return this._setVertexState(t),this._setTextureState(r),this._parameter.pipeline=this._createRenderPipeline(t,s,i),oe.NumCacheMiss++,oe._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(r),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,oe.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return oe.NumCacheHitWithHash++,this._parameter.pipeline;let s=oe._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,s,i),this._setRenderPipeline(this._parameter),oe.NumCacheMiss++,oe._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){oe.NumPipelineCreationLastFrame=oe._NumPipelineCreationCurrentFrame,oe._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,r,s,n,a,o){this._depthWriteEnabled=a,this._depthTestEnabled=n,this._depthCompare=(o??519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(r),this.setDepthBias(s)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[tX.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[tX.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=aZ[e??""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)0!==e[i]&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.MRTAttachments1))}setMRT(e,t){if((t=t??e.length)>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;let i=[0,0],r=0,s=0,n=0;for(let a=0;a<t;++a){let t=e[a],o=t?._hardwareTexture;this._mrtFormats[n]=o?.format??this._webgpuColorFormat[0],i[r]+=aZ[this._mrtFormats[n]??""]<<s,s+=6,n++,s>=32&&(s=0,r++)}this._mrtFormats.length=n,(this._mrtAttachments1!==i[0]||this._mrtAttachments2!==i[1])&&(this._mrtAttachments1=i[0],this._mrtAttachments2=i[1],this._states[tX.MRTAttachments1]=i[0],this._states[tX.MRTAttachments2]=i[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.MRTAttachments1))}setAlphaBlendEnabled(e){this._alphaBlendEnabled=e}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=void 0===e?0:aZ[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e??519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e??519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=null===e?1:a9[e]}setStencilPassOp(e){this._stencilFrontPassOp=null===e?2:a9[e]}setStencilFailOp(e){this._stencilFrontFailOp=null===e?1:a9[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[tX.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[tX.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,r,s,n,a){this._stencilEnabled=e,this._stencilFrontCompare=(t??519)-512,this._stencilFrontDepthFailOp=null===i?1:a9[i],this._stencilFrontPassOp=null===r?2:a9[r],this._stencilFrontFailOp=null===s?1:a9[s],this.setStencilReadMask(n),this.setStencilWriteMask(a)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this._indexBuffer=t}static _GetTopology(e){switch(e){case 0:default:return"triangle-list";case 2:case 3:return"point-list";case 1:case 4:return"line-list";case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return"line-strip";case 7:return"triangle-strip";case 8:throw"TriangleFan is an unsupported fillmode in WebGPU"}}static _GetAphaBlendOperation(e){switch(e){case 32774:default:return"add";case 32778:return"subtract";case 32779:return"reverse-subtract";case 32775:return"min";case 32776:return"max"}}static _GetAphaBlendFactor(e){switch(e){case 0:return"zero";case 1:default:return"one";case 768:return"src";case 769:return"one-minus-src";case 770:return"src-alpha";case 771:return"one-minus-src-alpha";case 772:return"dst-alpha";case 773:return"one-minus-dst-alpha";case 774:return"dst";case 775:return"one-minus-dst";case 776:return"src-alpha-saturated";case 32769:case 32771:return"constant";case 32770:case 32772:return"one-minus-constant"}}static _GetCompareFunction(e){switch(e){case 0:break;case 1:return"less";case 2:return"equal";case 3:return"less-equal";case 4:return"greater";case 5:return"not-equal";case 6:return"greater-equal";case 7:return"always"}return"never"}static _GetStencilOpFunction(e){switch(e){case 0:return"zero";case 1:break;case 2:return"replace";case 3:return"increment-clamp";case 4:return"decrement-clamp";case 5:return"invert";case 6:return"increment-wrap";case 7:return"decrement-wrap"}return"keep"}static _GetVertexInputDescriptorFormat(e){let t=e.type,i=e.normalized,r=e.getSize();switch(t){case st.o.BYTE:switch(r){case 1:case 2:return i?"snorm8x2":"sint8x2";case 3:case 4:return i?"snorm8x4":"sint8x4"}break;case st.o.UNSIGNED_BYTE:switch(r){case 1:case 2:return i?"unorm8x2":"uint8x2";case 3:case 4:return i?"unorm8x4":"uint8x4"}break;case st.o.SHORT:switch(r){case 1:case 2:return i?"snorm16x2":"sint16x2";case 3:case 4:return i?"snorm16x4":"sint16x4"}break;case st.o.UNSIGNED_SHORT:switch(r){case 1:case 2:return i?"unorm16x2":"uint16x2";case 3:case 4:return i?"unorm16x4":"uint16x4"}break;case st.o.INT:switch(r){case 1:return"sint32";case 2:return"sint32x2";case 3:return"sint32x3";case 4:return"sint32x4"}break;case st.o.UNSIGNED_INT:switch(r){case 1:return"uint32";case 2:return"uint32x2";case 3:return"uint32x3";case 4:return"uint32x4"}break;case st.o.FLOAT:switch(r){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4"}}throw Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${r}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:oe._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:oe._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:oe._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:oe._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:oe._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:oe._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[tX.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.ShaderStage))}_setRasterizationState(e,t){let i=this._frontFace,r=i-1+((this._cullEnabled?this._cullFace:0)<<1)+((this._clampDepth?1:0)<<3)+((this._alphaToCoverageEnabled?1:0)<<4)+(e<<5)+(t<<8);this._rasterizationState!==r&&(this._rasterizationState=r,this._states[tX.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.RasterizationState))}_setColorStates(){let e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=((null===this._alphaBlendFuncParams[0]?2:a8[this._alphaBlendFuncParams[0]])<<0)+((null===this._alphaBlendFuncParams[1]?2:a8[this._alphaBlendFuncParams[1]])<<4)+((null===this._alphaBlendFuncParams[2]?2:a8[this._alphaBlendFuncParams[2]])<<8)+((null===this._alphaBlendFuncParams[3]?2:a8[this._alphaBlendFuncParams[3]])<<12)+((null===this._alphaBlendEqParams[0]?1:this._alphaBlendEqParams[0]-32773)<<16)+((null===this._alphaBlendEqParams[1]?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[tX.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.ColorStates))}_setDepthStencilState(){let e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[tX.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.DepthStencilState))}_setVertexState(e){let t;let i=this._statesLength,r=tX.VertexState,s=e._pipelineContext,n=s.shaderProcessingContext.attributeNamesFromEffect,a=s.shaderProcessingContext.attributeLocationsFromEffect,o=0;for(let e=0;e<n.length;e++){let i=a[e],s=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[e]])??this._vertexBuffers[n[e]];s||(s=this._emptyVertexBuffer);let l=s.effectiveBuffer?.underlyingResource;if(void 0===s._validOffsetRange){let e=s.effectiveByteOffset,t=s.getSize(!0),i=s.effectiveByteStride;s._validOffsetRange=e+t<=this._kMaxVertexBufferStride&&0===i||0!==i&&e+t<=i}t&&t===l&&s._validOffsetRange||(this.vertexBuffers[o++]=s,t=s._validOffsetRange?l:null);let c=s.hashCode+(i<<7);this._isDirty=this._isDirty||this._states[r]!==c,this._states[r++]=c}this.vertexBuffers.length=o,this._statesLength=r,this._isDirty=this._isDirty||r!==i,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[tX.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,tX.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);let t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let e=0;e<i.length;e++){let r=i[e];t[e]=this._device.createBindGroupLayout({entries:r})}return e.bindGroupLayouts[0]=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){let t=e.shaderProcessingContext,i=t.bindGroupLayoutEntries,r=1;for(let e=0;e<i.length;e++){let s=i[e];for(let n=0;n<s.length;n++){let s=i[e][n];if(s.texture){let n=t.bindGroupLayoutEntryInfo[e][s.binding].name,a=t.availableTextures[n],o=a.autoBindSampler?t.availableSamplers[n+"Sampler"]:null,l=a.sampleType,c=o?.type??"filtering";if(this._textureState&r&&"depth"!==l&&(a.autoBindSampler&&(c="non-filtering"),l="unfilterable-float"),s.texture.sampleType=l,o){let e=t.bindGroupLayoutEntryInfo[o.binding.groupIndex][o.binding.bindingIndex].index;i[o.binding.groupIndex][e].sampler.type=c}r<<=1}}}let s=[];for(let e=0;e<i.length;++e)s[e]=this._device.createBindGroupLayout({entries:i[e]});return e.bindGroupLayouts[this._textureState]=s,this._device.createPipelineLayout({bindGroupLayouts:s})}_getVertexInputDescriptor(e){let t,i;let r=[],s=e._pipelineContext,n=s.shaderProcessingContext.attributeNamesFromEffect,a=s.shaderProcessingContext.attributeLocationsFromEffect;for(let e=0;e<n.length;e++){let s=a[e],o=(this._overrideVertexBuffers&&this._overrideVertexBuffers[n[e]])??this._vertexBuffers[n[e]];o||(o=this._emptyVertexBuffer);let l=o.effectiveBuffer?.underlyingResource,c=o.effectiveByteOffset,u=!o._validOffsetRange;if(!(t&&i&&t===l)||u){let e={arrayStride:o.effectiveByteStride,stepMode:o.getIsInstanced()?"instance":"vertex",attributes:[]};r.push(e),i=e.attributes,u&&(c=0,l=null)}i.push({shaderLocation:s,offset:c,format:oe._GetVertexInputDescriptorFormat(o)}),t=l}return r}_createRenderPipeline(e,t,i){let r;let s=e._pipelineContext,n=this._getVertexInputDescriptor(e),a=this._createPipelineLayout(s),o=[],l=this._getAphaBlendState(),c=this._getColorBlendState();if(this._vertexBuffers&&ag(this._vertexBuffers,e),this._mrtAttachments1>0)for(let e=0;e<this._mrtFormats.length;++e){let t=this._mrtFormats[e];if(t){let i={format:t,writeMask:(this._mrtEnabledMask&1<<e)!=0?this._writeMask:0};l&&c&&(i.blend={alpha:l,color:c}),o.push(i)}else o.push(null)}else if(this._webgpuColorFormat[0]){let e={format:this._webgpuColorFormat[0],writeMask:this._writeMask};l&&c&&(e.blend={alpha:l,color:c}),o.push(e)}else o.push(null);let u={compare:oe._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:oe._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:oe._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:oe._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};("line-strip"===t||"triangle-strip"===t)&&(r=!this._indexBuffer||this._indexBuffer.is32Bits?"uint32":"uint16");let h=!!this._webgpuDepthStencilFormat&&aR.HasStencilAspect(this._webgpuDepthStencilFormat);return this._device.createRenderPipeline({label:`RenderPipeline_${o[0]?.format??"nooutput"}_${this._webgpuDepthStencilFormat??"nodepth"}_samples${i}_textureState${this._textureState}`,layout:a,vertex:{module:s.stages.vertexStage.module,entryPoint:s.stages.vertexStage.entryPoint,buffers:n},primitive:{topology:t,stripIndexFormat:r,frontFace:1===this._frontFace?"ccw":"cw",cullMode:this._cullEnabled?2===this._cullFace?"front":"back":"none"},fragment:s.stages.fragmentStage?{module:s.stages.fragmentStage.module,entryPoint:s.stages.fragmentStage.entryPoint,targets:o}:void 0,multisample:{count:i},depthStencil:void 0===this._webgpuDepthStencilFormat?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?oe._GetCompareFunction(this._depthCompare):"always",format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&h?u:void 0,stencilBack:this._stencilEnabled&&h?u:void 0,stencilReadMask:this._stencilEnabled&&h?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&h?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}oe.NumCacheHitWithoutHash=0,oe.NumCacheHitWithHash=0,oe.NumCacheMiss=0,oe.NumPipelineCreationLastFrame=0,oe._NumPipelineCreationCurrentFrame=0;class ot{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(let i in this.values){let[r,s]=this.values[i].count();e+=r,t+=s,e++}return[e,t]}}class oi extends oe{static GetNodeCounts(){let e=oi._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,r){if(e.pipeline){let e=i.slice();e.length=r,t.push(e)}for(let s in e.values){let n=e.values[s];i[r]=parseInt(s),oi._GetPipelines(n,t,i,r+1)}}static GetPipelines(){let e=[];return oi._GetPipelines(oi._Cache,e,[],0),e}static ResetCache(){oi._Cache=new ot}reset(){this._nodeStack=[],this._nodeStack[0]=oi._Cache,super.reset()}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let e=this._stateDirtyLowestIndex;e<this._statesLength;++e){let i=t.values[this._states[e]];i||(i=new ot,t.values[this._states[e]]=i),t=i,this._nodeStack[e+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}oi._Cache=new ot;var or=i(89681);class os extends or.C{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){let e=this.stencilMaterial?.enabled;this.enabled=e?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=e?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=e?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=e?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=e?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=e?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=e?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=e?this.stencilMaterial.mask:this.stencilGlobal.mask)}}var on=i(91887);class oa extends on.k{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e??1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e??2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class oo{static IsExternalTexture(e){return void 0!==e.underlyingResource}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}constructor(e){this.useMipMaps=!1,this.type=16,this.format=4294967295,this._video=e,this.uniqueId=s0.l._Counter++}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class ol{get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatOrDepthTextures(){return this._numFloatOrDepthTextures>0}constructor(){this.uniqueId=ol._Counter++,this.updateId=0,this.textureState=0,this.reset()}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatOrDepthTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],r=-1;i?r=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?a6.GetSamplerHashCode(t):0;let s=r!==i.hashCode;s&&this.updateId++,this.isDirty||(this.isDirty=s)}setTexture(e,t){let i=this.textures[e],r=-1;i?r=i.texture?.uniqueId??-1:this.textures[e]=i={texture:t,isFloatOrDepthTexture:!1,isExternalTexture:!1},i.isExternalTexture&&this._numExternalTextures--,i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures--,t?(i.isFloatOrDepthTexture=1===t.type||t.format>=13&&t.format<=18,i.isExternalTexture=oo.IsExternalTexture(t),i.isFloatOrDepthTexture&&this._numFloatOrDepthTextures++,i.isExternalTexture&&this._numExternalTextures++):(i.isFloatOrDepthTexture=!1,i.isExternalTexture=!1),i.texture=t;let s=r!==(t?.uniqueId??-1);s&&this.updateId++,this.isDirty||(this.isDirty=s)}}ol._Counter=0;class oc{isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get useInstancing(){return this._useInstancing}set useInstancing(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(20,to.CopyDst|to.Indirect|to.Storage,void 0,"IndirectDrawBuffer"),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)}constructor(e){this._bufferManager=e,this.uniqueId=oc._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(e,t){this._isDirty||(this._isDirty=t?.uniqueId!==this.buffers[e]?.uniqueId),this.buffers[e]=t}setIndirectData(e,t,i){t!==this._currentInstanceCount&&this.indirectDrawBuffer&&this._indirectDrawData&&(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}oc._Counter=0;class ou{constructor(){this.values={}}}class oh{static get Statistics(){return{totalCreated:oh.NumBindGroupsCreatedTotal,lastFrameCreated:oh.NumBindGroupsCreatedLastFrame,lookupLastFrame:oh.NumBindGroupsLookupLastFrame,noLookupLastFrame:oh.NumBindGroupsNoLookupLastFrame}}static ResetCache(){oh._Cache=new ou,oh.NumBindGroupsCreatedTotal=0,oh.NumBindGroupsCreatedLastFrame=0,oh.NumBindGroupsLookupLastFrame=0,oh.NumBindGroupsNoLookupLastFrame=0,oh._NumBindGroupsCreatedCurrentFrame=0,oh._NumBindGroupsLookupCurrentFrame=0,oh._NumBindGroupsNoLookupCurrentFrame=0}constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}endFrame(){oh.NumBindGroupsCreatedLastFrame=oh._NumBindGroupsCreatedCurrentFrame,oh.NumBindGroupsLookupLastFrame=oh._NumBindGroupsLookupCurrentFrame,oh.NumBindGroupsNoLookupLastFrame=oh._NumBindGroupsNoLookupCurrentFrame,oh._NumBindGroupsCreatedCurrentFrame=0,oh._NumBindGroupsLookupCurrentFrame=0,oh._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){let r;let s=oh._Cache,n=this.disabled||i.forceBindGroupCreation;if(!n){if(!t.isDirty(i.updateId)&&!i.isDirty)return oh._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(let i of e.shaderProcessingContext.bufferNames){let e=t.buffers[i]?.uniqueId??0,r=s.values[e];r||(r=new ou,s.values[e]=r),s=r}for(let t of e.shaderProcessingContext.samplerNames){let e=i.samplers[t]?.hashCode??0,r=s.values[e];r||(r=new ou,s.values[e]=r),s=r}for(let t of e.shaderProcessingContext.textureNames){let e=i.textures[t]?.texture?.uniqueId??0,r=s.values[e];r||(r=new ou,s.values[e]=r),s=r}r=s.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,r)return t.bindGroups=r,oh._NumBindGroupsLookupCurrentFrame++,r;r=[],t.bindGroups=r,n||(s.bindGroups=r),oh.NumBindGroupsCreatedTotal++,oh._NumBindGroupsCreatedCurrentFrame++;let a=e.bindGroupLayouts[i.textureState];for(let s=0;s<e.shaderProcessingContext.bindGroupLayoutEntries.length;s++){let n=e.shaderProcessingContext.bindGroupLayoutEntries[s],o=e.shaderProcessingContext.bindGroupEntries[s];for(let r=0;r<n.length;r++){let n=e.shaderProcessingContext.bindGroupLayoutEntries[s][r],a=e.shaderProcessingContext.bindGroupLayoutEntryInfo[s][n.binding],l=a.nameInArrayOfTexture??a.name;if(n.sampler){let e=i.samplers[l];if(e){let t=e.sampler;if(!t){this._engine.dbgSanityChecks&&re.Y.Error(`Trying to bind a null sampler! entry=${JSON.stringify(n)}, name=${l}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}o[r].resource=this._cacheSampler.getSampler(t,!1,e.hashCode,t.label)}else re.Y.Error(`Sampler "${l}" could not be bound. entry=${JSON.stringify(n)}, materialContext=${JSON.stringify(i,(e,t)=>"texture"===e||"sampler"===e?"<no dump>":t)}`,50)}else if(n.texture||n.storageTexture){let e=i.textures[l];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){re.Y.Error(`Trying to bind a null texture! entry=${JSON.stringify(n)}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let t=e.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!t||n.texture&&!t.view||n.storageTexture&&!t.viewForWriting)){re.Y.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(n)}, name=${l}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}o[r].resource=n.storageTexture?t.viewForWriting:t.view}else re.Y.Error(`Texture "${l}" could not be bound. entry=${JSON.stringify(n)}, materialContext=${JSON.stringify(i,(e,t)=>"texture"===e||"sampler"===e?"<no dump>":t)}`,50)}else if(n.externalTexture){let e=i.textures[l];if(e){if(this._engine.dbgSanityChecks&&null===e.texture){re.Y.Error(`Trying to bind a null external texture! entry=${JSON.stringify(n)}, name=${l}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}let t=e.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!t){re.Y.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(n)}, name=${l}, bindingInfo=${JSON.stringify(e,(e,t)=>"texture"===e?"<no dump>":t)}, isReady=${e.texture?.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}o[r].resource=this._device.importExternalTexture({source:t})}else re.Y.Error(`Texture "${l}" could not be bound. entry=${JSON.stringify(n)}, materialContext=${JSON.stringify(i,(e,t)=>"texture"===e||"sampler"===e?"<no dump>":t)}`,50)}else if(n.buffer){let e=t.buffers[l];if(e){let t=e.underlyingResource;o[r].resource.buffer=t,o[r].resource.size=e.capacity}else re.Y.Error(`Can't find buffer "${l}". entry=${JSON.stringify(n)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}let l=a[s];r[s]=this._device.createBindGroup({layout:l,entries:o})}return r}}oh.NumBindGroupsCreatedTotal=0,oh.NumBindGroupsCreatedLastFrame=0,oh.NumBindGroupsLookupLastFrame=0,oh.NumBindGroupsNoLookupLastFrame=0,oh._Cache=new ou,oh._NumBindGroupsCreatedCurrentFrame=0,oh._NumBindGroupsLookupCurrentFrame=0,oh._NumBindGroupsNoLookupCurrentFrame=0;let od=`uniform depthValue: f32;const pos=array(
vec2f(-1.0,1.0),
vec2f(1.0,1.0),
vec2f(-1.0,-1.0),
vec2f(1.0,-1.0)
);
#define CUSTOM_VERTEX_DEFINITIONS
@vertex
fn main(input : VertexInputs)->FragmentInputs {
#define CUSTOM_VERTEX_MAIN_BEGIN
vertexOutputs.position=vec4f(pos[input.vertexIndex],uniforms.depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;sG.v.ShadersStoreWGSL.clearQuadVertexShader=od;let of=`uniform color: vec4f;@fragment
fn main(input: FragmentInputs)->FragmentOutputs {fragmentOutputs.color=uniforms.color;}
`;sG.v.ShadersStoreWGSL.clearQuadPixelShader=of;class op{setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new oi(this._device,i),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"],void 0,void 0,void 0,void 0,void 0,void 0,1)}clear(e,t,i,r,s=1){let n,a;let o=null,l=!!this._engine._currentRenderTarget;if(e)n=e;else{let e=0;this._keyTemp.length=0;for(let t=0;t<this._cacheRenderPipeline.colorFormats.length;++t)this._keyTemp[e++]=aZ[this._cacheRenderPipeline.colorFormats[t]??""];let c=aZ[this._depthTextureFormat??0];if(this._keyTemp[e]=(t?t.r+256*t.g+65536*t.b+16777216*t.a:0)+(i?4294967296:0)+(r?8589934592:0)+(this._engine.useReverseDepthBuffer?17179869184:0)+(l?34359738368:0)+(s>1?68719476736:0)+137438953472*c,a=this._keyTemp.join("_"),o=this._bundleCache[a])return o;n=this._device.createRenderBundleEncoder({label:"clearQuadRenderBundle",colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:aR.GetSample(s)})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!r&&!!this._depthTextureFormat&&aR.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(r?255:0),this._cacheRenderPipeline.setStencilCompare(r?519:512),this._cacheRenderPipeline.setStencilPassOp(r?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);let c=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,s),u=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),u.uniformBuffer.update();let h=l?this._engine._ubInvertY:this._engine._ubDontInvertY,d=u.uniformBuffer.getBuffer(),f=d.uniqueId+"-"+h.uniqueId,p=this._bindGroups[f];if(!p){let e=u.bindGroupLayouts[0];(p=this._bindGroups[f]=[]).push(this._device.createBindGroup({label:`clearQuadBindGroup0-${f}`,layout:e[0],entries:[]})),aL._SimplifiedKnownBindings||p.push(this._device.createBindGroup({label:`clearQuadBindGroup1-${f}`,layout:e[1],entries:[]})),p.push(this._device.createBindGroup({label:`clearQuadBindGroup${aL._SimplifiedKnownBindings?1:2}-${f}`,layout:e[aL._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:h.underlyingResource,size:h.capacity}},{binding:1,resource:{buffer:d.underlyingResource,size:d.capacity}}]}))}n.setPipeline(c);for(let e=0;e<p.length;++e)n.setBindGroup(e,p[e]);return n.draw(4,1,0,0),e||(o=n.finish(),this._bundleCache[a]=o),o}}class om{constructor(e,t,i,r){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(r)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new om(this.x,this.y,this.w,this.h)}}class o_{constructor(e,t,i,r){this.x=e,this.y=t,this.w=i,this.h=r}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new o_(this.x,this.y,this.w,this.h)}}class og{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new og(this.ref)}}class ov{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new ov(this.color)}}class oS{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new oS(this.query)}}class ox{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new ox}}class oE{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){let e=new oE;return e.bundles=this.bundles,e}}class oC{constructor(e){this.numDrawCalls=0,this._device=e,this._list=Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){let e=new oE;this._list[this._listLength++]=e,this._currentBundleList=e.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:aR.GetSample(i)})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();let e=new oC(this._device);e._list=Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class oT{get querySet(){return this._querySet}constructor(e,t,i,r,s,n=!0,a){this._dstBuffers=[],this._engine=e,this._device=r,this._bufferManager=s,this._count=t,this._canUseMultipleBuffers=n,this._querySet=r.createQuerySet({label:a??"QuerySet",type:i,count:t}),this._queryBuffer=s.createRawBuffer(8*t,to.QueryResolve|to.CopySrc,void 0,"QueryBuffer"),n||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,to.MapRead|to.CopyDst,void 0,"QueryBufferNoMultipleBuffers"))}_getBuffer(e,t){let i;if(!this._canUseMultipleBuffers&&0===this._dstBuffers.length)return null;let r=this._device.createCommandEncoder();return 0===this._dstBuffers.length?i=this._bufferManager.createRawBuffer(8*this._count,to.MapRead|to.CopyDst,void 0,"QueryBufferAdditionalBuffer"):(i=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),r.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),r.copyBufferToBuffer(this._queryBuffer,0,i,0,8*t),this._device.queue.submit([r.finish()]),i}async readValues(e=0,t=1){let i=this._getBuffer(e,t);if(null===i)return null;let r=this._engine.uniqueId;return i.mapAsync(1).then(()=>{let e=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,e},e=>{if(this._engine.isDisposed||this._engine.uniqueId!==r)return null;throw e})}async readValue(e=0){let t=this._getBuffer(e,1);if(null===t)return null;let i=this._engine.uniqueId;return t.mapAsync(1).then(()=>{let e=Number(new BigUint64Array(t.getMappedRange())[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,e},e=>{if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw e})}async readTwoValuesAndSubtract(e=0){let t=this._getBuffer(e,2);if(null===t)return null;let i=this._engine.uniqueId;return t.mapAsync(1).then(()=>{let e=new BigUint64Array(t.getMappedRange()),i=Number(e[1]-e[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,i},e=>{if(this._engine.isDisposed||this._engine.uniqueId!==i)return 0;throw e})}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class ob{get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}constructor(e,t,i){this._enabled=!1,this._gpuFrameTimeCounter=new at.z,this._measureDurationState=0,this._engine=e,this._device=t,this._bufferManager=i}get enable(){return this._enabled}set enable(e){if(this._enabled!==e){if(this._enabled=e,this._measureDurationState=0,e)try{this._measureDuration=new oy(this._engine,this._device,this._bufferManager,2e3,"QuerySet_TimestampQuery")}catch(e){this._enabled=!1,re.Y.Error("Could not create a WebGPUDurationMeasure!\nError: "+e.message+"\nMake sure timestamp query is supported and enabled in your browser.");return}else this._measureDuration.dispose()}}startFrame(e){this._enabled&&0===this._measureDurationState&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){1===this._measureDurationState&&(this._measureDurationState=2,this._measureDuration.stop(e).then(e=>{null!==e&&e>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(e,!0)),this._measureDurationState=0}))}startPass(e,t){this._enabled?this._measureDuration.startPass(e,t):e.timestampWrites=void 0}endPass(e,t){if(!this._enabled||!t)return;let i=this._engine.frameId;this._measureDuration.stopPass(e).then(e=>{t._addDuration(i,null!==e&&e>0?e:0)})}dispose(){this._measureDuration?.dispose()}}class oy{constructor(e,t,i,r=2,s){this._count=r,this._querySet=new oT(e,r,"timestamp",t,i,!0,s)}start(e){e.writeTimestamp?.(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp?.(this._querySet.querySet,1),e.writeTimestamp?this._querySet.readTwoValuesAndSubtract(0):0}startPass(e,t){if(t+3>this._count)throw Error("WebGPUDurationMeasure: index out of range ("+t+")");e.timestampWrites={querySet:this._querySet.querySet,beginningOfPassWriteIndex:t+2,endOfPassWriteIndex:t+3}}async stopPass(e){return this._querySet.readTwoValuesAndSubtract(e+2)}dispose(){this._querySet.dispose()}}class oI{get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}canBeginQuery(e){if(this._frameQuerySetIsDirty===this._engine.frameId||this._queryFrameId[e]===this._engine.frameId)return!1;let t=void 0!==this._engine._getCurrentRenderPassWrapper().renderPassDescriptor.occlusionQuerySet;return t&&(this._queryFrameId[e]=this._engine.frameId),t}constructor(e,t,i,r=50,s=100){this._availableIndices=[],this._frameQuerySetIsDirty=-1,this._queryFrameId=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=s,this._allocateNewIndices(r)}createQuery(){0===this._availableIndices.length&&this._allocateNewIndices();let e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){return Number(this._lastBuffer?.[e]??-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer===this._engine.frameId||(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e??this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new oT(this._engine,this._currentTotalIndices,"occlusion",this._device,this._bufferManager,!1,"QuerySet_OcclusionQuery_count_"+this._currentTotalIndices),this._frameQuerySetIsDirty=this._engine.frameId}_delayQuerySetDispose(){let e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){this._querySet?.dispose(),this._availableIndices.length=0}}class oP{async initTwgsl(e){return oP._Twgsl?void 0:(e=e||{},(e={...oP._TWgslDefaultOptions,...e}).twgsl)?(oP._Twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&await rD.w1.LoadBabylonScriptAsync(e.jsPath),self.twgsl)?(oP._Twgsl=await self.twgsl(rD.w1.GetBabylonScriptURL(e.wasmPath)),Promise.resolve()):Promise.reject("twgsl is not available.")}convertSpirV2WGSL(e,t=!1){let i=oP._Twgsl.convertSpirV2WGSL(e,oP.DisableUniformityAnalysis||t);return oP.ShowWGSLShaderCode&&(re.Y.Log(i),re.Y.Log("***********************************************")),oP.DisableUniformityAnalysis||t?"diagnostic(off, derivative_uniformity);\n"+i:i}}oP._TWgslDefaultOptions={jsPath:`${rD.w1._DefaultCdnUrl}/twgsl/twgsl.js`,wasmPath:`${rD.w1._DefaultCdnUrl}/twgsl/twgsl.wasm`},oP.ShowWGSLShaderCode=!1,oP.DisableUniformityAnalysis=!1,oP._Twgsl=null;class oR{constructor(e,t,i){this._record=!1,this._play=!1,this._playBundleListIndex=0,this._allBundleLists=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._allBundleLists.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endRenderPass(e){let t;if(!this._record&&!this._play)return!1;if(this._record)t=this._bundleList.clone(),this._allBundleLists.push(t),this._bundleList.reset();else{if(this._playBundleListIndex>=this._allBundleLists.length)throw Error(`Invalid playBundleListIndex! Your snapshot is no longer valid for the current frame, you should recreate a new one. playBundleListIndex=${this._playBundleListIndex}, allBundleLists.length=${this._allBundleLists.length}}`);t=this._allBundleLists[this._playBundleListIndex++]}return t.run(e),1===this._mode&&this._engine._reportDrawCall(t.numDrawCalls),!0}endFrame(){this._record&&(this._record=!1,this._play=!0,this._mode=this._modeSaved),this._playBundleListIndex=0}reset(){this._record&&(this._mode=this._modeSaved),this.enabled=!1,this.enabled=!0}}var oA=i(8937),oM=i(99558),oN=i(74800),oO=i(97827);class oD extends oo{constructor(e){super(e)}}function oF(e,t,i,r){let s;let n=1;1===r?s=new Float32Array(t*i*4):2===r?(s=new Uint16Array(t*i*4),n=15360):s=7===r?new Uint32Array(t*i*4):new Uint8Array(t*i*4);for(let r=0;r<t;r++)for(let a=0;a<i;a++){let i=(a*t+r)*3,o=(a*t+r)*4;s[o+0]=e[i+0],s[o+1]=e[i+1],s[o+2]=e[i+2],s[o+3]=n}return s}aM.prototype.createRawTexture=function(e,t,i,r,s,n,a,o=null,l=0,c=0,u=!1){let h=new s0.l(this,3);return h.baseWidth=t,h.baseHeight=i,h.width=t,h.height=i,h.format=r,h.generateMipMaps=s,h.samplingMode=a,h.invertY=n,h._compression=o,h.type=l,h._creationFlags=c,h._useSRGBBuffer=u,this._doNotHandleContextLost||(h._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(h,t,i,void 0,c),this.updateRawTexture(h,e,r,n,o,l,u),this._internalTexturesCache.push(h),h},aM.prototype.updateRawTexture=function(e,t,i,r,s=null,n=0,a=!1){if(e){if(this._doNotHandleContextLost||(e._bufferView=t,e.invertY=r,e._compression=s,e._useSRGBBuffer=a),t){let s=e._hardwareTexture;4===i&&(t=oF(t,e.width,e.height,n));let a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0}},aM.prototype.createRawCubeTexture=function(e,t,i,r,s,n,a,o=null){let l=new s0.l(this,8);return 1!==r||this._caps.textureFloatLinearFiltering?2!==r||this._caps.textureHalfFloatLinearFiltering?1!==r||this._caps.textureFloatRender?2!==r||this._caps.colorBufferFloat||(s=!1,re.Y.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")):(s=!1,re.Y.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):(s=!1,a=1,re.Y.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):(s=!1,a=1,re.Y.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")),l.isCube=!0,l._originalFormat=i,l.format=4===i?5:i,l.type=r,l.generateMipMaps=s,l.width=t,l.height=t,l.samplingMode=a,this._doNotHandleContextLost||(l._bufferViewArray=e),l.invertY=n,l._compression=o,l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),4===i&&(l._hardwareTexture._originalFormatIsRGB=!0),e&&this.updateRawCubeTexture(l,e,i,r,n,o),l.isReady=!0,l},aM.prototype.updateRawCubeTexture=function(e,t,i,r,s,n=null){e._bufferViewArray=t,e.invertY=s,e._compression=n;let a=e._hardwareTexture,o=a._originalFormatIsRGB,l=[0,2,4,1,3,5],c=[];for(let i=0;i<t.length;++i){let s=t[l[i]];o&&(s=oF(s,e.width,e.height,r)),c.push(new Uint8Array(s.buffer,s.byteOffset,s.byteLength))}this._textureHelper.updateCubeTextures(c,a.underlyingResource,e.width,e.height,a.format,s,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0},aM.prototype.createRawCubeTextureFromUrl=function(e,t,i,r,s,n,a,o,l=null,c=null,u=3,h=!1){let d=this.createRawCubeTexture(null,i,r,s,!n,h,u,null);t?.addPendingData(d),d.url=e,d.isReady=!1,this._internalTexturesCache.push(d);let f=e=>{let i=d.width,n=a(e);if(n){if(o){let e=4===r,t=o(n),a=d._hardwareTexture,l=[0,1,2,3,4,5];for(let r=0;r<t.length;r++){let n=i>>r,o=[];for(let i=0;i<6;i++){let a=t[r][l[i]];e&&(a=oF(a,n,n,s)),o.push(new Uint8Array(a.buffer,a.byteOffset,a.byteLength))}this._textureHelper.updateCubeTextures(o,a.underlyingResource,n,n,a.format,h,!1,0,0)}}else this.updateRawCubeTexture(d,n,r,s,h);d.isReady=!0,t?.removePendingData(d),l&&l()}};return this._loadFile(e,e=>{f(e)},void 0,t?.offlineProvider,!0,(e,i)=>{t?.removePendingData(d),c&&e&&c(e.status+" "+e.statusText,i)}),d},aM.prototype.createRawTexture3D=function(e,t,i,r,s,n,a,o,l=null,c=0,u=0){let h=new s0.l(this,10);return h.baseWidth=t,h.baseHeight=i,h.baseDepth=r,h.width=t,h.height=i,h.depth=r,h.format=s,h.type=c,h.generateMipMaps=n,h.samplingMode=o,h.is3D=!0,h._creationFlags=u,this._doNotHandleContextLost||(h._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(h,t,i,void 0,u),this.updateRawTexture3D(h,e,s,a,l,c),this._internalTexturesCache.push(h),h},aM.prototype.updateRawTexture3D=function(e,t,i,r,s=null,n=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=s),t){let s=e._hardwareTexture;4===i&&(t=oF(t,e.width,e.height,n));let a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},aM.prototype.createRawTexture2DArray=function(e,t,i,r,s,n,a,o,l=null,c=0,u=0){let h=new s0.l(this,11);return h.baseWidth=t,h.baseHeight=i,h.baseDepth=r,h.width=t,h.height=i,h.depth=r,h.format=s,h.type=c,h.generateMipMaps=n,h.samplingMode=o,h.is2DArray=!0,h._creationFlags=u,this._doNotHandleContextLost||(h._bufferView=e),this._textureHelper.createGPUTextureForInternalTexture(h,t,i,r,u),this.updateRawTexture2DArray(h,e,s,a,l,c),this._internalTexturesCache.push(h),h},aM.prototype.updateRawTexture2DArray=function(e,t,i,r,s=null,n=0){if(this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=r,e._compression=s),t){let s=e._hardwareTexture;4===i&&(t=oF(t,e.width,e.height,n));let a=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(a,e,e.width,e.height,e.depth,s.format,0,0,r,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e,this._uploadEncoder)}e.isReady=!0},aM.prototype._readTexturePixels=function(e,t,i,r=-1,s=0,n=null,a=!0,o=!1,l=0,c=0){let u=e._hardwareTexture;return a&&this.flushFramebuffer(),this._textureHelper.readPixels(u.underlyingResource,l,c,t,i,u.format,r,s,n,o)},aM.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"},aM.prototype._createDepthStencilCubeTexture=function(e,t){let i=new s0.l(this,t.generateStencil?12:14);i.isCube=!0,i.label=t.label;let r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t};i.format=r.depthTextureFormat,this._setupDepthStencilTexture(i,e,r.bilinearFiltering,r.comparisonFunction,r.samples),this._textureHelper.createGPUTextureForInternalTexture(i);let s=i._hardwareTexture;return i.type=aR.GetTextureTypeFromFormat(s.format),this._internalTexturesCache.push(i),i},aM.prototype.createCubeTexture=function(e,t,i,r,s=null,n=null,a,o=null,l=!1,c=0,u=0,h=null,d,f=!1,p=null){return this.createCubeTextureBase(e,t,i,!!r,s,n,a,o,l,c,u,h,null,(e,t)=>{let i=t[0].width;this._setCubeMapTextureParams(e,!r),e.format=a??-1;let n=this._textureHelper.createGPUTextureForInternalTexture(e,i,i);this._textureHelper.updateCubeTextures(t,n.underlyingResource,i,i,n.format,!1,!1,0,0),r||this._generateMipmaps(e,this._uploadEncoder),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear(),s&&s()},!!f,p)},aM.prototype._setCubeMapTextureParams=function(e,t,i){e.samplingMode=t?3:2,e._cachedWrapU=0,e._cachedWrapV=0,i&&(e._maxLodLevel=i)},aM.prototype.generateMipMapsForCubemap=function(e){e.generateMipMaps&&(e._hardwareTexture?.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e))};class oL extends n5.r{constructor(e,t,i,r,s){super(e,t,i,r,s),r.enableGPUTimingMeasurements&&(this.gpuTimeInFrame=new aA.Q)}}aM.prototype._createHardwareRenderTargetWrapper=function(e,t,i){let r=new oL(e,t,i,this);return this._renderTargetWrapperCache.push(r),r},aM.prototype.createRenderTargetTexture=function(e,t){let i=this._createHardwareRenderTargetWrapper(!1,!1,e),r={};void 0!==t&&"object"==typeof t?(r.generateMipMaps=t.generateMipMaps,r.generateDepthBuffer=void 0===t.generateDepthBuffer||t.generateDepthBuffer,r.generateStencilBuffer=r.generateDepthBuffer&&t.generateStencilBuffer,r.samplingMode=void 0===t.samplingMode?3:t.samplingMode,r.creationFlags=t.creationFlags??0,r.noColorAttachment=!!t.noColorAttachment,r.colorAttachment=t.colorAttachment,r.samples=t.samples,r.label=t.label):(r.generateMipMaps=t,r.generateDepthBuffer=!0,r.generateStencilBuffer=!1,r.samplingMode=3,r.creationFlags=0,r.noColorAttachment=!1);let s=r.colorAttachment||(r.noColorAttachment?null:this._createInternalTexture(e,t,!0,5));return i.label=r.label??"RenderTargetWrapper",i._samples=r.samples??1,i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=!!r.generateStencilBuffer,i.setTextures(s),(i._generateDepthBuffer||i._generateStencilBuffer)&&i.createDepthStencilTexture(0,!1,i._generateStencilBuffer,i.samples,r.generateStencilBuffer?13:14,r.label?r.label+"-DepthStencil":void 0),s&&(void 0!==t&&"object"==typeof t&&t.createMipMaps&&!r.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s,void 0,void 0,void 0,r.creationFlags),void 0!==t&&"object"==typeof t&&t.createMipMaps&&!r.generateMipMaps&&(s.generateMipMaps=!1)),i},aM.prototype._createDepthStencilTexture=function(e,t,i){let r={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:t.generateStencil?13:14,...t},s=17===r.depthTextureFormat||13===r.depthTextureFormat||18===r.depthTextureFormat;i._depthStencilTextureWithStencil=s;let n=new s0.l(this,s?12:14);n.label=t.label,n.format=r.depthTextureFormat,this._setupDepthStencilTexture(n,e,r.bilinearFiltering,r.comparisonFunction,r.samples),this._textureHelper.createGPUTextureForInternalTexture(n);let a=n._hardwareTexture;return n.type=aR.GetTextureTypeFromFormat(a.format),this._internalTexturesCache.push(n),n},aM.prototype._setupDepthStencilTexture=function(e,t,i,r,s=1){let n=t.width||t,a=t.height||t,o=t.layers||0,l=t.depth||0;e.baseWidth=n,e.baseHeight=a,e.width=n,e.height=a,e.is2DArray=o>0,e.is3D=l>0,e.depth=o||l,e.isReady=!0,e.samples=s,e.generateMipMaps=!1,e.samplingMode=i?2:1,e.type=1,e._comparisonFunction=r,e._cachedWrapU=0,e._cachedWrapV=0},aM.prototype.updateRenderTargetTextureSampleCount=function(e,t){return e&&e.texture&&e.samples!==t&&(t=Math.min(t,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(e.texture,t),e._depthStencilTexture&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),e._samples=t,e.texture.samples=t),t},aM.prototype.setDepthStencilTexture=function(e,t,i,r){i&&i.depthStencilTexture?this._setTexture(e,i,!1,!0,r):this._setTexture(e,null,void 0,void 0,r)},aM.prototype.createRenderTargetCubeTexture=function(e,t){let i=this._createHardwareRenderTargetWrapper(!1,!0,e),r={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...t};r.generateStencilBuffer=r.generateDepthBuffer&&r.generateStencilBuffer,i.label=r.label??"RenderTargetWrapper",i._generateDepthBuffer=r.generateDepthBuffer,i._generateStencilBuffer=r.generateStencilBuffer;let s=new s0.l(this,5);return s.width=e,s.height=e,s.depth=0,s.isReady=!0,s.isCube=!0,s.samples=r.samples,s.generateMipMaps=r.generateMipMaps,s.samplingMode=r.samplingMode,s.type=r.type,s.format=r.format,this._internalTexturesCache.push(s),i.setTextures(s),(i._generateDepthBuffer||i._generateStencilBuffer)&&i.createDepthStencilTexture(0,void 0===r.samplingMode||2===r.samplingMode||2===r.samplingMode||3===r.samplingMode||3===r.samplingMode||5===r.samplingMode||6===r.samplingMode||7===r.samplingMode||11===r.samplingMode,i._generateStencilBuffer,i.samples),t&&t.createMipMaps&&!r.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s),t&&t.createMipMaps&&!r.generateMipMaps&&(s.generateMipMaps=!1),i};let ow={label:"TextureView_SwapChain_ResolveTarget",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},oB={label:"TextureView_SwapChain",dimension:"2d",format:void 0,mipLevelCount:1,arrayLayerCount:1},oV=new aN.HE;class oU extends aM{get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return!!this._cacheSampler&&this._cacheSampler.disabled}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return!!this._cacheRenderPipeline&&this._cacheRenderPipeline.disabled}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return!!this._cacheBindGroups&&this._cacheBindGroups.disabled}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}areAllEffectsReady(){return!0}getFontOffset(e){return(0,oN.RB)(e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return re.Y.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get supportedLimits(){return this._adapterSupportedLimits}get currentLimits(){return this._deviceLimits}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:this._adapterInfo.vendor||"unknown vendor",renderer:this._adapterInfo.architecture||"unknown renderer",version:this._adapterInfo.description||"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){let i=new oU(e,t);return new Promise(e=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>e(i))})}constructor(e,t={}){if(super(t.antialias??!0,t),this.uniqueId=-1,this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._glslangAndTintAreFullyLoaded=!1,this._adapterInfo={vendor:"",architecture:"",device:"",description:""},this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this.scenes=[],this._virtualScenes=[],this._commandBuffers=[null,null],this._mainRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._rttRenderPassWrapper={renderPassDescriptor:null,colorAttachmentViewDescriptor:null,depthAttachmentViewDescriptor:null,colorAttachmentGPUTextures:[],depthTextureFormat:void 0},this._pendingDebugCommands=[],this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,this._workingGlslangAndTintPromise=null,this._viewportsCurrent={x:0,y:0,w:0,h:0},this._scissorsCurrent={x:0,y:0,w:0,h:0},this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=-1,this._blendColorsCurrent=[null,null,null,null],this._performanceMonitor=new oM.A,this._name="WebGPU",this._drawCalls=new at.z,t.deviceDescriptor=t.deviceDescriptor||{},t.enableGPUDebugMarkers=t.enableGPUDebugMarkers??!1,re.Y.Log(`Babylon.js v${rV.a.Version} - ${this.description} engine`),!navigator.gpu){re.Y.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",this._renderingCanvas=e,this._options=t,this._mainPassSampleCount=t.antialias?this._defaultSampleCount:1,navigator&&navigator.userAgent&&this._setupMobileChecks(),this._sharedInit(this._renderingCanvas),this._shaderProcessor=new aw,this._shaderProcessorWGSL=new aU}prepareGlslangAndTintAsync(){return this._workingGlslangAndTintPromise||(this._workingGlslangAndTintPromise=new Promise(e=>{this._initGlslang(this._glslangOptions??this._options?.glslangOptions).then(t=>{this._glslang=t,this._tintWASM=new oP,this._tintWASM.initTwgsl(this._twgslOptions??this._options?.twgslOptions).then(()=>{this._glslangAndTintAreFullyLoaded=!0,e()})})})),this._workingGlslangAndTintPromise}initAsync(e,t){return this.uniqueId=oU._InstanceId++,this._glslangOptions=e,this._twgslOptions=t,navigator.gpu.requestAdapter(this._options).then(e=>{if(e){this._adapter=e,this._adapterSupportedExtensions=[],this._adapter.features?.forEach(e=>this._adapterSupportedExtensions.push(e)),this._adapterSupportedLimits=this._adapter.limits,this._adapter.requestAdapterInfo().then(e=>{this._adapterInfo=e});let t=this._options.deviceDescriptor??{},i=t?.requiredFeatures??(this._options.enableAllFeatures?this._adapterSupportedExtensions:void 0);if(i){let e=[];for(let t of i)-1!==this._adapterSupportedExtensions.indexOf(t)&&e.push(t);t.requiredFeatures=e}if(this._options.setMaximumLimits&&!t.requiredLimits)for(let e in t.requiredLimits={},this._adapterSupportedLimits)"minSubgroupSize"!==e&&"maxSubgroupSize"!==e&&(t.requiredLimits[e]=this._adapterSupportedLimits[e]);return t.label=`BabylonWebGPUDevice${this.uniqueId}`,this._adapter.requestDevice(t)}throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(e=>{this._device=e,this._deviceEnabledExtensions=[],this._device.features?.forEach(e=>this._deviceEnabledExtensions.push(e)),this._deviceLimits=e.limits;let t=-1;this._device.addEventListener("uncapturederror",e=>{++t<this.numMaxUncapturedErrors?re.Y.Warn(`WebGPU uncaptured error (${t+1}): ${e.error} - ${e.error.message}`):t++===this.numMaxUncapturedErrors&&re.Y.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||this._device.lost?.then(e=>{this._isDisposed||(this._contextWasLost=!0,re.Y.Warn("WebGPU context lost. "+e),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(async()=>{let e=this.snapshotRenderingMode,t=this.snapshotRendering,i=this.disableCacheSamplers,r=this.disableCacheRenderPipelines,s=this.disableCacheBindGroups,n=this.enableGPUTimingMeasurements;await this.initAsync(this._glslangOptions??this._options?.glslangOptions,this._twgslOptions??this._options?.twgslOptions),this.snapshotRenderingMode=e,this.snapshotRendering=t,this.disableCacheSamplers=i,this.disableCacheRenderPipelines=r,this.disableCacheBindGroups=s,this.enableGPUTimingMeasurements=n,this._currentRenderPass=null}))})}).then(()=>{this._initializeLimits(),this._bufferManager=new a3(this,this._device),this._textureHelper=new aJ(this,this._device,this._bufferManager,this._deviceEnabledExtensions),this._cacheSampler=new a6(this._device),this._cacheBindGroups=new oh(this._device,this._cacheSampler,this),this._timestampQuery=new ob(this,this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new oI(this,this._device,this._bufferManager):void 0,this._bundleList=new oC(this._device),this._snapshotRendering=new oR(this,this._snapshotRenderingMode,this._bundleList),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),to.Uniform|to.CopyDst,"UBInvertY"),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),to.Uniform|to.CopyDst,"UBDontInvertY"),this.dbgVerboseLogsForFirstFrames&&void 0===this._count&&(this._count=0,re.Y.Log(["%c frame #"+this._count+" - begin","background: #ffff00"])),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._emptyVertexBuffer=new st.o(this,[0],"",{stride:1,offset:0,size:1,label:"EmptyVertexBuffer"}),this._cacheRenderPipeline=new oi(this._device,this._emptyVertexBuffer),this._depthCullingState=new oa(this._cacheRenderPipeline),this._stencilStateComposer=new os(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new op(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(e=>{throw re.Y.Error("A fatal error occurred during WebGPU creation/initialization."),e})}_initGlslang(e){return(e=e||{},(e={...oU._GlslangDefaultOptions,...e}).glslang)?Promise.resolve(e.glslang):self.glslang?self.glslang(e.wasmPath):e.jsPath&&e.wasmPath?rD.w1.LoadBabylonScriptAsync(e.jsPath).then(()=>self.glslang(rD.w1.GetBabylonScriptURL(e.wasmPath))):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxVertexTextureImageUnits:this._deviceLimits.maxSampledTexturesPerShaderStage,maxCombinedTexturesImageUnits:2*this._deviceLimits.maxSampledTexturesPerShaderStage,maxTextureSize:this._deviceLimits.maxTextureDimension2D,maxCubemapTextureSize:this._deviceLimits.maxTextureDimension2D,maxRenderTextureSize:this._deviceLimits.maxTextureDimension2D,maxVertexAttribs:this._deviceLimits.maxVertexAttributes,maxDrawBuffers:8,maxVaryingVectors:this._deviceLimits.maxInterStageShaderVariables,maxFragmentUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),maxVertexUniformVectors:Math.floor(this._deviceLimits.maxUniformBufferBindingSize/4),standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf("texture-compression-astc")>=0||void 0,s3tc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0||void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf("texture-compression-etc2")>=0||void 0,bptc:this._deviceEnabledExtensions.indexOf("texture-compression-bc")>=0||void 0,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,supportFloatTexturesResolve:!1,rg11b10ufColorRenderable:this._deviceEnabledExtensions.indexOf("rg11b10ufloat-renderable")>=0,textureFloat:!0,textureFloatLinearFiltering:this._deviceEnabledExtensions.indexOf("float32-filterable")>=0,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,texelFetch:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:"undefined"!=typeof BigUint64Array&&-1!==this._deviceEnabledExtensions.indexOf("timestamp-query")||void 0,supportOcclusionQuery:"undefined"!=typeof BigUint64Array,canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:this._deviceLimits.maxTextureArrayLayers,disableMorphTargetTexture:!1},this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportIBLShadows:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,forceVertexBufferStrideAndOffsetMultiple4Bytes:!0,_checkNonFloatVertexBuffersDontRecreatePipelineContext:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){if(!this._renderingCanvas)throw"The rendering canvas has not been set!";this._context=this._renderingCanvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new ak],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat,this._setColorFormat(this._mainRenderPassWrapper)}_initializeMainAttachments(){let e;if(!this._bufferManager)return;this.flushFramebuffer(),this._mainTextureExtends={width:this.getRenderWidth(!0),height:this.getRenderHeight(!0),depthOrArrayLayers:1};let t=new Float32Array([this.getRenderHeight(!0)]);if(this._bufferManager.setSubData(this._ubInvertY,4,t),this._bufferManager.setSubData(this._ubDontInvertY,4,t),this._options.antialias){let t={label:`Texture_MainColor_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}_antialiasing`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._options.swapChainFormat,usage:16};this._mainTexture&&this._textureHelper.releaseTexture(this._mainTexture),this._mainTexture=this._device.createTexture(t),e=[{view:this._mainTexture.createView({label:"TextureView_MainColor_antialiasing",dimension:"2d",format:this._options.swapChainFormat,mipLevelCount:1,arrayLayerCount:1}),clearValue:new aN.HE(0,0,0,1),loadOp:"clear",storeOp:"store"}]}else e=[{view:void 0,clearValue:new aN.HE(0,0,0,1),loadOp:"clear",storeOp:"store"}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?"depth24plus-stencil8":"depth32float",this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper);let i={label:`Texture_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:"2d",format:this._mainRenderPassWrapper.depthTextureFormat,usage:16};this._depthTexture&&this._textureHelper.releaseTexture(this._depthTexture),this._depthTexture=this._device.createTexture(i);let r={view:this._depthTexture.createView({label:`TextureView_MainDepthStencil_${this._mainTextureExtends.width}x${this._mainTextureExtends.height}`,dimension:"2d",format:this._depthTexture.format,mipLevelCount:1,arrayLayerCount:1}),depthClearValue:this._clearDepthValue,depthLoadOp:"clear",depthStoreOp:"store",stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?"clear":void 0,stencilStoreOp:this.isStencilEnable?"store":void 0};this._mainRenderPassWrapper.renderPassDescriptor={label:"MainRenderPass",colorAttachments:e,depthStencilAttachment:r}}_sharedInit(e){super._sharedInit(e),(0,oN.$5)(this,e,this._creationOptions)}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:17,alphaMode:this.premultipliedAlpha?"premultiplied":"opaque"})}resizeImageBitmap(e,t,i){return(0,oN.AY)(this,e,t,i)}_createImageBitmapFromSource(e,t){return(0,oN.pp)(this,e,t)}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){!this.isFullscreen&&(this._pointerLockRequested=e,this._renderingCanvas&&(0,oN.RD)(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&(0,oN.F9)()}enterPointerlock(){this._renderingCanvas&&(0,oN.$Y)(this._renderingCanvas)}exitPointerlock(){(0,oN.uu)()}_rebuildBuffers(){for(let e of(super._rebuildBuffers(),this._storageBuffers))e.getBuffer().engineId!==this.uniqueId&&e._rebuild()}_restoreEngineAfterContextLost(e){oi.ResetCache(),oh.ResetCache();let t=e=>{for(let t of e){for(let e of t.meshes){let t=e.subMeshes;if(t)for(let e of t)e._drawWrappers=[]}for(let e of t.materials)e._materialContext?.reset()}};t(this.scenes),t(this._virtualScenes);let i=[];for(let e of this._uniformBuffers)0>e.name.indexOf("leftOver")&&i.push(e);this._uniformBuffers=i,super._restoreEngineAfterContextLost(e)}setSize(e,t,i=!1){return!!super.setSize(e,t,i)&&(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log(["frame #"+this._count+" - setSize -",e,t])),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0)}_getShaderProcessor(e){return 1===e?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e,t){return new aL(e,t)}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassWrapper(){return this._currentRenderTarget?this._rttRenderPassWrapper:this._mainRenderPassWrapper}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(e){(!this.preventCacheWipeBetweenFrames||e)&&(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_mustUpdateViewport(){let e=this._viewportCached.x,t=this._viewportCached.y,i=this._viewportCached.z,r=this._viewportCached.w,s=this._viewportsCurrent.x!==e||this._viewportsCurrent.y!==t||this._viewportsCurrent.w!==i||this._viewportsCurrent.h!==r;return s&&(this._viewportsCurrent.x=this._viewportCached.x,this._viewportsCurrent.y=this._viewportCached.y,this._viewportsCurrent.w=this._viewportCached.z,this._viewportsCurrent.h=this._viewportCached.w),s}_applyViewport(e){let t=Math.floor(this._viewportCached.x),i=Math.floor(this._viewportCached.z),r=Math.floor(this._viewportCached.w),s=Math.floor(this._viewportCached.y);this._currentRenderTarget||(s=this.getRenderHeight(!0)-s-r),e?e.addItem(new om(t,s,i,r)):this._getCurrentRenderPass().setViewport(t,s,i,r,0,1),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log(["frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_viewport(e,t,i,r){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=r}_mustUpdateScissor(){let e=this._scissorCached.x,t=this._scissorCached.y,i=this._scissorCached.z,r=this._scissorCached.w,s=this._scissorsCurrent.x!==e||this._scissorsCurrent.y!==t||this._scissorsCurrent.w!==i||this._scissorsCurrent.h!==r;return s&&(this._scissorsCurrent.x=this._scissorCached.x,this._scissorsCurrent.y=this._scissorCached.y,this._scissorsCurrent.w=this._scissorCached.z,this._scissorsCurrent.h=this._scissorCached.w),s}_applyScissor(e){let t=this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y;e?e.addItem(new o_(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w)):this._getCurrentRenderPass().setScissorRect(this._scissorCached.x,t,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log(["frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+this._currentPassIsMainPass()]))}_scissorIsActive(){return 0!==this._scissorCached.x||0!==this._scissorCached.y||0!==this._scissorCached.z||0!==this._scissorCached.w}enableScissor(e,t,i,r){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=r}disableScissor(){this._scissorCached.x=this._scissorCached.y=this._scissorCached.z=this._scissorCached.w=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0}_mustUpdateStencilRef(){let e=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent;return e&&(this._stencilRefsCurrent=this._stencilStateComposer.funcRef),e}_applyStencilRef(e){e?e.addItem(new og(this._stencilStateComposer.funcRef??0)):this._getCurrentRenderPass().setStencilReference(this._stencilStateComposer.funcRef??0)}_mustUpdateBlendColor(){let e=this._alphaState._blendConstants,t=e[0]!==this._blendColorsCurrent[0]||e[1]!==this._blendColorsCurrent[1]||e[2]!==this._blendColorsCurrent[2]||e[3]!==this._blendColorsCurrent[3];return t&&(this._blendColorsCurrent[0]=e[0],this._blendColorsCurrent[1]=e[1],this._blendColorsCurrent[2]=e[2],this._blendColorsCurrent[3]=e[3]),t}_applyBlendColor(e){e?e.addItem(new ov(this._alphaState._blendConstants.slice())):this._getCurrentRenderPass().setBlendConstant(this._alphaState._blendConstants)}_resetRenderPassStates(){this._viewportsCurrent.x=this._viewportsCurrent.y=this._viewportsCurrent.w=this._viewportsCurrent.h=0,this._scissorsCurrent.x=this._scissorsCurrent.y=this._scissorsCurrent.w=this._scissorsCurrent.h=0,this._stencilRefsCurrent=-1,this._blendColorsCurrent[0]=this._blendColorsCurrent[1]=this._blendColorsCurrent[2]=this._blendColorsCurrent[3]=null}clear(e,t,i,r=!1){e&&void 0===e.a&&(e.a=1);let s=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log(["frame #"+this._count+" - clear - backBuffer=",t," depth=",i," stencil=",r," scissor is active=",s])),this._currentRenderTarget?s?(this._currentRenderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,r),this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)):(this._currentRenderPass&&this._endCurrentRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,r)):(this._currentRenderPass&&s||this._startMainRenderPass(!s,t?e:null,i,r),s&&(this._applyScissor(this.compatibilityMode?null:this._bundleList),this._clearFullQuad(t?e:null,i,r)))}_clearFullQuad(e,t,i){let r=this.compatibilityMode?this._getCurrentRenderPass():null;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments(this._cacheRenderPipeline.mrtAttachments??[],this._cacheRenderPipeline.mrtTextureArray??[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?r.setStencilReference(this._clearStencilValue):this._bundleList.addItem(new og(this._clearStencilValue));let s=this._clearQuad.clear(r,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(null):(this._bundleList.addBundle(s),this._applyStencilRef(this._bundleList),this._reportDrawCall())}createVertexBuffer(e,t,i){let r;return r=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e,this._bufferManager.createBuffer(r,to.Vertex|to.CopyDst,i)}createDynamicVertexBuffer(e,t){return this.createVertexBuffer(e,void 0,t)}createIndexBuffer(e,t,i){let r,s=!0;e instanceof Uint32Array||e instanceof Int32Array?r=e:e instanceof Uint16Array?(r=e,s=!1):e.length>65535?r=new Uint32Array(e):(r=new Uint16Array(e),s=!1);let n=this._bufferManager.createBuffer(r,to.Index|to.CopyDst,i);return n.is32Bits=s,n}updateDynamicIndexBuffer(e,t,i=0){let r;r=e.is32Bits?t instanceof Uint32Array?t:new Uint32Array(t):t instanceof Uint16Array?t:new Uint16Array(t),this._bufferManager.setSubData(e,i,r)}updateDynamicVertexBuffer(e,t,i,r){let s;void 0===i&&(i=0),void 0===r?r=(s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t).byteLength:s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(e,i,s,0,r)}_createBuffer(e,t,i){let r;r=e instanceof Array?new Float32Array(e):e instanceof ArrayBuffer?new Uint8Array(e):e;let s=0;return 1&t&&(s|=to.CopySrc),2&t&&(s|=to.CopyDst),4&t&&(s|=to.Uniform),8&t&&(s|=to.Vertex),16&t&&(s|=to.Index),32&t&&(s|=to.Storage),64&t&&(s|=to.Indirect),this._bufferManager.createBuffer(r,s,i)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}unbindInstanceAttributes(){}bindBuffers(e,t,i,r){this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=r??null,this._cacheRenderPipeline.setBuffers(e,t,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createUniformBuffer(e,t){let i;return i=e instanceof Array?new Float32Array(e):e,this._bufferManager.createBuffer(i,to.Uniform|to.CopyDst,t)}createDynamicUniformBuffer(e,t){return this.createUniformBuffer(e,t)}updateUniformBuffer(e,t,i,r){let s;void 0===i&&(i=0),void 0===r?(t instanceof Float32Array?s=t:s=new Float32Array(t),r=s.byteLength):t instanceof Float32Array?s=t:s=new Float32Array(t),this._bufferManager.setSubData(e,i,s,0,r)}bindUniformBufferBase(e,t,i){this._currentDrawContext.setBuffer(i,e)}bindUniformBlock(){}createEffect(e,t,i,r,s,n,a,o,l,c=0,u){let h="string"==typeof e?e:e.vertexToken||e.vertexSource||e.vertexElement||e.vertex,d="string"==typeof e?e:e.fragmentToken||e.fragmentSource||e.fragmentElement||e.fragment,f=this._getGlobalDefines(),p=s??t.defines??"";f&&(p+="\n"+f);let m=h+"+"+d+"@"+p;if(this._compiledEffects[m]){let e=this._compiledEffects[m];return a&&e.isReady()&&a(e),e._refCount++,e}let _=new n1.Q(e,t,i,r,this,s,n,a,o,l,m,t.shaderLanguage??c,t.extraInitializationsAsync??u);return this._compiledEffects[m]=_,_}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,r){return this._compileRawShaderToSpirV(r+(i?i+"\n":"")+e,t)}_getWGSLShader(e,t,i){return(i=i?"//"+i.split("\n").join("\n//")+"\n":"")+e}_createPipelineStageDescriptor(e,t,i,r,s){return this._tintWASM&&0===i&&(e=this._tintWASM.convertSpirV2WGSL(e,r),t=this._tintWASM.convertSpirV2WGSL(t,s)),{vertexStage:{module:this._device.createShaderModule({label:"vertex",code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({label:"fragment",code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){let r=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,s=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,n=0===i?this._compileRawShaderToSpirV(e,"vertex"):e,a=0===i?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(n,a,i,r,s)}_compilePipelineStageDescriptor(e,t,i,r){this.onBeforeShaderCompilationObservable.notifyObservers(this);let s=e.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,n=t.indexOf("#define DISABLE_UNIFORMITY_ANALYSIS")>=0,a="#version 450\n",o=0===r?this._compileShaderToSpirV(e,"vertex",i,a):this._getWGSLShader(e,"vertex",i),l=0===r?this._compileShaderToSpirV(t,"fragment",i,a):this._getWGSLShader(t,"fragment",i),c=this._createPipelineStageDescriptor(o,l,r,s,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),c}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){let t=new an.Z(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new aD(e,this)}createMaterialContext(){return new ol}createDrawContext(){return new oc(this._bufferManager)}async _preparePipelineContext(e,t,i,r,s,n,a,o,l,c,u){let h=e.shaderProcessingContext.shaderLanguage;0!==h||this._glslangAndTintAreFullyLoaded||await this.prepareGlslangAndTintAsync(),this.dbgShowShaderCode&&(re.Y.Log(["defines",o]),re.Y.Log(t),re.Y.Log(i),re.Y.Log("***********************************************")),e.sources={fragment:i,vertex:t,rawVertex:s,rawFragment:n},r?e.stages=this._compileRawPipelineStageDescriptor(t,i,h):e.stages=this._compilePipelineStageDescriptor(t,i,o,h),u()}getAttributes(e,t){let i=Array(t.length);for(let r=0;r<t.length;r++){let s=t[r],n=e.shaderProcessingContext.availableAttributes[s];void 0!==n&&(i[r]=n)}return i}enableEffect(e){if(e){if((0,n7.A)(e)){if(e.effect&&(e.effect!==this._currentEffect||e.materialContext!==this._currentMaterialContext||e.drawContext!==this._currentDrawContext||this._forceEnableEffect)){if(this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw re.Y.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the materialContext property is empty!"}else{if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw re.Y.Log(["drawWrapper=",e]),"Invalid call to enableEffect: the effect property is empty!";return}}else this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&re.Y.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${"string"==typeof e.name?"":e.name.vertex}, effect.name.fragment=${"string"==typeof e.name?"":e.name.fragment}`,10);this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=!1,this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect)}}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(let e in this._compiledEffects){let t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}_deletePipelineContext(e){e&&(0,oO.ZI)(e)}get needPOTTextures(){return!1}_createHardwareTexture(){return new ak}_releaseTexture(e){let t=this._internalTexturesCache.indexOf(e);-1!==t&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,r=0){let s={};void 0!==t&&"object"==typeof t?(s.generateMipMaps=t.generateMipMaps,s.type=void 0===t.type?0:t.type,s.samplingMode=void 0===t.samplingMode?3:t.samplingMode,s.format=void 0===t.format?5:t.format,s.samples=t.samples??1,s.creationFlags=t.creationFlags??0,s.useSRGBBuffer=t.useSRGBBuffer??!1,s.label=t.label):(s.generateMipMaps=t,s.type=0,s.samplingMode=3,s.format=5,s.samples=1,s.creationFlags=0,s.useSRGBBuffer=!1),(1!==s.type||this._caps.textureFloatLinearFiltering)&&(2!==s.type||this._caps.textureHalfFloatLinearFiltering)||(s.samplingMode=1),1!==s.type||this._caps.textureFloat||(s.type=0,re.Y.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));let n=new s0.l(this,r),a=e.width||e,o=e.height||e,l=e.depth||0,c=e.layers||0;return n.baseWidth=a,n.baseHeight=o,n.width=a,n.height=o,n.depth=l||c,n.isReady=!0,n.samples=s.samples,n.generateMipMaps=!!s.generateMipMaps,n.samplingMode=s.samplingMode,n.type=s.type,n.format=s.format,n.is2DArray=c>0,n.is3D=l>0,n._cachedWrapU=0,n._cachedWrapV=0,n._useSRGBBuffer=s.useSRGBBuffer,n.label=s.label,this._internalTexturesCache.push(n),i||this._textureHelper.createGPUTextureForInternalTexture(n,a,o,c||1,s.creationFlags),n}createTexture(e,t,i,r,s=3,n=null,a=null,o=null,l=null,c=null,u=null,h,d,f,p){return this._createTextureBase(e,t,i,r,s,n,a,(e,t,i,r,s,n,a,o)=>{if(e.baseWidth=r.width,e.baseHeight=r.height,e.width=r.width,e.height=r.height,e.format=-1!==e.format?e.format:c??5,e.type=-1!==e.type?e.type:0,e._creationFlags=f??0,o(e.width,e.height,r,t,e,()=>{}),e._hardwareTexture?.underlyingResource)n||a||this._generateMipmaps(e,this._uploadEncoder);else{let t=this._textureHelper.createGPUTextureForInternalTexture(e,r.width,r.height,void 0,f);!aR.IsImageBitmap(r)||(this._textureHelper.updateTexture(r,e,r.width,r.height,e.depth,t.format,0,0,s,!1,0,0),n||a||this._generateMipmaps(e,this._uploadEncoder))}i&&i.removePendingData(e),e.isReady=!0,e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()},()=>!1,o,l,c,u,h,d,p)}wrapWebGPUTexture(e){let t=new ak(e),i=new s0.l(this,0,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers}_unpackFlipY(e){}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,r=null){null!==t&&(e._cachedWrapU=t),null!==i&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&null!==r&&(e._cachedWrapR=r)}updateTextureDimensions(e,t,i,r=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===r)return;let s=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,r,s)}_setInternalTexture(e,t,i){if(i=i??e,this._currentEffect){let r=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),r&&r.autoBindSampler){let e=i+"Sampler";this._currentMaterialContext.setSampler(e,t)}}}createPrefilteredCubeTexture(e,t,i,r,s=null,n=null,a,o=null,l=!0){return this.createCubeTexture(e,t,null,!1,e=>{if(!e){s&&s(null);return}let t=e.texture;l?e.info.sphericalPolynomial&&(t._sphericalPolynomial=e.info.sphericalPolynomial):t._sphericalPolynomial=new oA.i,t._source=9,s&&s(t)},n,a,o,l,i,r)}setTexture(e,t,i,r){this._setTexture(e,i,!1,!1,r,r)}setTextureArray(e,t,i,r){for(let e=0;e<i.length;e++)this._setTexture(-1,i[e],!0,!1,r+e.toString(),r)}_setTexture(e,t,i=!1,r=!1,s="",n){if(n=n??s,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(s,null),!1;if(t.video)t.update();else if(4===t.delayLoadState)return t.delayLoad(),!1;let e=null;if((e=r?t.depthStencilTexture:t.isReady()?t.getInternalTexture():t.isCube?this.emptyCubeTexture:t.is3D?this.emptyTexture3D:t.is2DArray?this.emptyTexture2DArray:this.emptyTexture)&&!e.isMultiview){if(e.isCube&&e._cachedCoordinatesMode!==t.coordinatesMode){e._cachedCoordinatesMode=t.coordinatesMode;let i=3!==t.coordinatesMode&&5!==t.coordinatesMode?1:0;t.wrapU=i,t.wrapV=i}e._cachedWrapU=t.wrapU,e._cachedWrapV=t.wrapV,e.is3D&&(e._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,e,t.anisotropicFilteringLevel)}this._setInternalTexture(s,e,n)}else this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log(["frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t]));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){void 0!==e&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e)}updateTextureData(e,t,i,r,s,n,a=0,o=0,l=!1){let c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e));let u=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(u,e,s,n,e.depth,c.format,a,o,e.invertY,!1,i,r),l&&this._generateMipmaps(e)}_uploadCompressedDataToTextureDirectly(e,t,i,r,s,n=0,a=0){let o=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(e.format=t,o=this._textureHelper.createGPUTextureForInternalTexture(e,i,r));let l=new Uint8Array(s.buffer,s.byteOffset,s.byteLength);this._textureHelper.updateTexture(l,e,i,r,e.depth,o.format,n,a,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,r=0,s,n=!1){let a=Math.round(Math.log(e.width)*Math.LOG2E),o=Math.round(Math.log(e.height)*Math.LOG2E),l=n?e.width:Math.pow(2,Math.max(a-r,0)),c=n?e.height:Math.pow(2,Math.max(o-r,0)),u=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(u=this._textureHelper.createGPUTextureForInternalTexture(e,l,c));let h=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(h,e,l,c,e.depth,u.format,i,r,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,r=0){this._uploadDataToTextureDirectly(e,t,i,r)}_uploadImageToTexture(e,t,i=0,r=0){let s=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(s=this._textureHelper.createGPUTextureForInternalTexture(e)),t instanceof HTMLImageElement)throw"WebGPU engine: HTMLImageElement not supported in _uploadImageToTexture!";let n=Math.ceil(e.width/(1<<r)),a=Math.ceil(e.height/(1<<r));this._textureHelper.updateTexture(t,e,n,a,e.depth,s.format,i,r,e.invertY,!1,0,0)}readPixels(e,t,i,r,s=!0,n=!0){let a=this._getCurrentRenderPassWrapper().colorAttachmentGPUTextures[0];if(!a)return Promise.resolve(new Uint8Array(0));let o=a.underlyingResource,l=a.format;return o?(n&&this.flushFramebuffer(),this._textureHelper.readPixels(o,e,t,i,r,l)):Promise.resolve(new Uint8Array(0))}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}get performanceMonitor(){return this._performanceMonitor}beginFrame(){this._measureFps(),super.beginFrame()}endFrame(){if(this._endCurrentRenderPass(),this._snapshotRendering.endFrame(),this._timestampQuery.endFrame(this._renderEncoder),this._timestampIndex=0,this.flushFramebuffer(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let e=[];for(let t in s1.M._UpdatedUbosInFrame)e.push(t+":"+s1.M._UpdatedUbosInFrame[t]);re.Y.Log(["frame #"+this._count+" - updated ubos -",e.join(", ")])}s1.M._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&re.Y.Log(["%c frame #"+this._count+" - end","background: #ffff00"]),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&re.Y.Log(["%c frame #"+this._count+" - begin","background: #ffff00"]))),super.endFrame()}extractDriverInfo(){return""}flushFramebuffer(){this._endCurrentRenderPass(),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset()}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentPassIsMainPass()}_startRenderTargetRenderPass(e,t,i,r,s){this._endCurrentRenderPass();let n=e._depthStencilTexture,a=n?._hardwareTexture,o=a?.underlyingResource,l=a?.getMSAATexture(),c=o?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),u=l?.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),h=!!a&&aR.HasStencilAspect(a.format),d=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual(),i&&(oV.r=255*i.r,oV.g=255*i.g,oV.b=255*i.b,oV.a=255*i.a);let f=t&&i,p=t&&r,m=t&&s;if(e._attachments&&e.isMulti){this._mrtAttachments&&0!==this._mrtAttachments.length||(this._mrtAttachments=e._defaultAttachments);for(let t=0;t<this._mrtAttachments.length;++t){let r=this._mrtAttachments[t],s=e.textures[t],n=s?._hardwareTexture,a=n?.underlyingResource;if(n&&a){let o=n.getMSAATexture(t),l=e.layerIndices?.[t]??0,c=e.faceIndices?.[t]??0,u={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:s.is3D?"3d":"2d",format:n.format,baseArrayLayer:s.isCube?6*l+c:s.is3D?0:l},h={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,dimension:s.is3D?"3d":"2d",format:n.format,baseArrayLayer:0},p=7===s.type||5===s.type,m=a.createView(u),_=o?.createView(h);d.push({view:_||m,resolveTarget:o?m:void 0,depthSlice:s.is3D?l:void 0,clearValue:0!==r&&f?p?oV:i:void 0,loadOp:0!==r&&f?"clear":"load",storeOp:"store"})}}this._cacheRenderPipeline.setMRT(e.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{let t=e.texture;if(t){let r;let s=t._hardwareTexture,n=s.underlyingResource;e.is3D&&(r=this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer,this._rttRenderPassWrapper.colorAttachmentViewDescriptor.baseArrayLayer=0);let a=s.getMSAATexture(),o=n.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),l=a?.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),c=7===t.type||5===t.type;d.push({view:l||o,resolveTarget:a?o:void 0,depthSlice:r,clearValue:f?c?oV:i:void 0,loadOp:f?"clear":"load",storeOp:"store"})}else d.push(null)}if(this._debugPushGroup?.("render target pass"+(e.label?" ("+e.label+")":""),1),this._rttRenderPassWrapper.renderPassDescriptor={label:(e.label??"RTT")+"RenderPass",colorAttachments:d,depthStencilAttachment:n&&o?{view:u||c,depthClearValue:p?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:p?"clear":"load",depthStoreOp:"store",stencilClearValue:e._depthStencilTextureWithStencil&&m?this._clearStencilValue:void 0,stencilLoadOp:h?e._depthStencilTextureWithStencil&&m?"clear":"load":void 0,stencilStoreOp:h?"store":void 0}:void 0,occlusionQuerySet:this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0},this._timestampQuery.startPass(this._rttRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){let i=e.texture;re.Y.Log(["frame #"+this._count+" - render target begin pass - rtt name="+e.label+", internalTexture.uniqueId="+i.uniqueId+", width="+i.width+", height="+i.height+", setClearStates="+t,"renderPassDescriptor=",this._rttRenderPassWrapper.renderPassDescriptor])}this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),a&&aR.HasStencilAspect(a.format)||(this._stencilStateComposer.enabled=!1)}_startMainRenderPass(e,t,i,r){this._endCurrentRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();let s=e&&t,n=e&&i,a=e&&r;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=s?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=s?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=n?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=n?"clear":"load",this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=a?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?a?"clear":"load":void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=this._occlusionQuery?.hasQueries?this._occlusionQuery.querySet:void 0;let o=this._context.getCurrentTexture();this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(o),this._options.antialias?(ow.format=o.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=o.createView(ow)):(oB.format=o.format,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=o.createView(oB)),this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log(["frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height+", setClearStates="+e,"renderPassDescriptor=",this._mainRenderPassWrapper.renderPassDescriptor])),this._debugPushGroup?.("main pass",0),this._timestampQuery.startPass(this._mainRenderPassWrapper.renderPassDescriptor,this._timestampIndex),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper),this._debugFlushPendingCommands?.(),this._resetRenderPassStates(),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}bindFramebuffer(e,t=0,i,r,s,n=0,a=0){let o=e.texture?._hardwareTexture;this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._endCurrentRenderPass(),this._currentRenderTarget=e;let l=this._currentRenderTarget._depthStencilTexture;this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=o,this._rttRenderPassWrapper.depthTextureFormat=l?aR.GetWebGPUTextureFormat(-1,l.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:e.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:e.isCube?6*a+t:a,baseMipLevel:n,arrayLayerCount:1,aspect:"all"},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:l&&l.is3D?"3d":"2d",mipLevelCount:1,baseArrayLayer:l?l.isCube?6*a+t:a:0,baseMipLevel:0,arrayLayerCount:1,aspect:"all"},this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log(["frame #"+this._count+" - bindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId="+e.texture?.uniqueId+", face="+t+", lodLevel="+n+", layer="+a,"colorAttachmentViewDescriptor=",this._rttRenderPassWrapper.colorAttachmentViewDescriptor,"depthAttachmentViewDescriptor=",this._rttRenderPassWrapper.depthAttachmentViewDescriptor])),this._cachedViewport&&!s?this.setViewport(this._cachedViewport,i,r):(!i&&(i=e.width,n&&(i/=Math.pow(2,n))),!r&&(r=e.height,n&&(r/=Math.pow(2,n))),this._viewport(0,0,i,r)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){let r=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=r,this._endCurrentRenderPass(),!e.texture?.generateMipMaps||t||e.isCube||this._generateMipmaps(e.texture),this._currentRenderTarget=null,this.dbgVerboseLogsForFirstFrames&&(void 0===this._count&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&re.Y.Log("frame #"+this._count+" - unBindFramebuffer - rtt name="+e.label+", internalTexture.uniqueId=",e.texture?.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._currentRenderPass||this._startMainRenderPass(!1),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){let t=e.colorAttachmentGPUTextures[0]?.format??null;this._cacheRenderPipeline.setColorFormat(t),this._colorFormat!==t&&(this._colorFormat=t)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}_executeWhenRenderingStateIsCompiled(e,t){t()}bindSamplers(){}_getUnpackAlignement(){return 1}_bindTextureDirectly(){return!1}setState(e,t=0,i,r=!1,s,n,a=0){(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);let o=this.cullBackFaces??s??!0?1:2;(this._depthCullingState.cullFace!==o||i)&&(this._depthCullingState.cullFace=o),this.setZOffset(t),this.setZOffsetUnits(a);let l=r?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==l||i)&&(this._depthCullingState.frontFace=l),this._stencilStateComposer.stencilMaterial=n}_applyRenderPassChanges(e){let t=!!this._stencilStateComposer.enabled&&this._mustUpdateStencilRef(),i=!!this._alphaState.alphaBlend&&this._mustUpdateBlendColor();this._mustUpdateViewport()&&this._applyViewport(e),this._mustUpdateScissor()&&this._applyScissor(e),t&&this._applyStencilRef(e),i&&this._applyBlendColor(e)}_draw(e,t,i,r,s){let n=this._getCurrentRenderPass(),a=this._bundleList;this.applyStates();let o=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,aO.InternalsUBOName),o.uniformBuffer&&(o.uniformBuffer.update(),this.bindUniformBufferBase(o.uniformBuffer.getBuffer(),0,aO.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);let l=!this.compatibilityMode&&this._currentDrawContext.fastBundle,c=n;if(l||this._snapshotRendering.record){if(this._applyRenderPassChanges(a),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(r,s||1,i),a.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}c=a.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),a.numDrawCalls++}let u=0;if(this._currentMaterialContext.hasFloatOrDepthTextures){let e=1;for(let t=0;t<o.shaderProcessingContext.textureNames.length;++t){let i=o.shaderProcessingContext.textureNames[t],r=this._currentMaterialContext.textures[i]?.texture,s=r&&r.format>=13&&r.format<=18;(r?.type===1&&!this._caps.textureFloatLinearFiltering||s)&&(u|=e),e<<=1}}this._currentMaterialContext.textureState=u;let h=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,u),d=this._cacheBindGroups.getBindGroups(o,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(this.compatibilityMode?null:a),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,c=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:aR.GetSample(this.currentSampleCount)}))),c.setPipeline(h),this._currentIndexBuffer&&c.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?"uint32":"uint16",0);let f=this._cacheRenderPipeline.vertexBuffers;for(let e=0;e<f.length;e++){let t=f[e],i=t.effectiveBuffer;i&&c.setVertexBuffer(e,i.underlyingResource,t._validOffsetRange?0:t.byteOffset)}for(let e=0;e<d.length;e++)c.setBindGroup(e,d[e]);let p=!this.compatibilityMode&&!this._snapshotRendering.record;p&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(r,s||1,i),0===e?c.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):c.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):0===e?c.drawIndexed(r,s||1,i,0,0):c.draw(r,s||1,i,0),p&&(this._currentDrawContext.fastBundle=c.finish(),a.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,r=1){this._draw(0,e,t,i,r)}drawArraysType(e,t,i,r=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,r)}dispose(){this._isDisposed=!0,this.hideLoadingUI(),this._timestampQuery.dispose(),this._mainTexture?.destroy(),this._depthTexture?.destroy(),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._device.destroy(),(0,oN.ih)(this,this._renderingCanvas),super.dispose()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._renderingCanvas?.width??0}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._renderingCanvas?.height??0}getError(){return 0}createExternalTexture(e){return new oD(e)}setExternalTexture(e,t){if(!t){this._currentMaterialContext.setTexture(e,null);return}this._setInternalTexture(e,t)}setTextureSampler(e,t){this._currentMaterialContext?.setSampler(e,t)}createStorageBuffer(e,t,i){return this._createBuffer(e,32|t,i)}updateStorageBuffer(e,t,i,r){let s;void 0===i&&(i=0),void 0===r?r=(s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t).byteLength:s=t instanceof Array?new Float32Array(t):t instanceof ArrayBuffer?new Uint8Array(t):t,this._bufferManager.setSubData(e,i,s,0,r)}_readFromGPUBuffer(e,t,i,r){return new Promise((s,n)=>{let a=()=>{e.mapAsync(1,0,t).then(()=>{let r=e.getMappedRange(0,t),n=i;if(void 0===n)(n=new Uint8Array(t)).set(new Uint8Array(r));else{let e=n.constructor;(n=new e(n.buffer)).set(new e(r))}e.unmap(),this._bufferManager.releaseBuffer(e),s(n)},e=>{this.isDisposed?s(new Uint8Array):n(e)})};r?(this.flushFramebuffer(),a()):this.onEndFrameObservable.addOnce(()=>{a()})})}readFromStorageBuffer(e,t,i,r,s){i=i||e.capacity;let n=this._bufferManager.createRawBuffer(i,to.MapRead|to.CopyDst,void 0,"TempReadFromStorageBuffer");return this._renderEncoder.copyBufferToBuffer(e.underlyingResource,t??0,n,0,i),this._readFromGPUBuffer(n,i,r,s)}readFromMultipleStorageBuffers(e,t,i,r,s){i=i||e[0].capacity;let n=this._bufferManager.createRawBuffer(i*e.length,to.MapRead|to.CopyDst,void 0,"TempReadFromMultipleStorageBuffers");for(let r=0;r<e.length;r++)this._renderEncoder.copyBufferToBuffer(e[r].underlyingResource,t??0,n,r*i,i);return this._readFromGPUBuffer(n,i*e.length,r,s)}setStorageBuffer(e,t){this._currentDrawContext?.setBuffer(e,t?.getBuffer()??null)}}oU._GlslangDefaultOptions={jsPath:`${rD.w1._DefaultCdnUrl}/glslang/glslang.js`,wasmPath:`${rD.w1._DefaultCdnUrl}/glslang/glslang.wasm`},oU._InstanceId=0;class ok{getBindGroups(e,t,i){if(!i)throw Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(0===this._bindGroups.length){let r=this._bindGroupEntries.length>0;for(let t in e){let s=e[t],n=i[t],a=n.group,o=n.binding,l=s.type,c=s.object,u=s.indexInGroupEntries,h=this._bindGroupEntries[a];switch(h||(h=this._bindGroupEntries[a]=[]),l){case 5:void 0!==u&&r?h[u].resource=this._cacheSampler.getSampler(c):(s.indexInGroupEntries=h.length,h.push({binding:o,resource:this._cacheSampler.getSampler(c)}));break;case 0:case 4:{let e=c._texture._hardwareTexture;void 0!==u&&r?(0===l&&(h[u++].resource=this._cacheSampler.getSampler(c._texture)),h[u].resource=e.view):(s.indexInGroupEntries=h.length,0===l&&h.push({binding:o-1,resource:this._cacheSampler.getSampler(c._texture)}),h.push({binding:o,resource:e.view}));break}case 1:{let e=c._texture._hardwareTexture;(8&e.textureAdditionalUsages)==0&&re.Y.Error(`computeDispatch: The texture (name=${c.name}, uniqueId=${c.uniqueId}) is not a storage texture!`,50),void 0!==u&&r?h[u].resource=e.viewForWriting:(s.indexInGroupEntries=h.length,h.push({binding:o,resource:e.viewForWriting}));break}case 6:{let e=c.underlyingResource;void 0!==u&&r?h[u].resource=this._device.importExternalTexture({source:e}):(s.indexInGroupEntries=h.length,h.push({binding:o,resource:this._device.importExternalTexture({source:e})}));break}case 2:case 3:case 7:{let e=7===l?c:c.getBuffer(),t=e.underlyingResource;void 0!==u&&r?(h[u].resource.buffer=t,h[u].resource.size=e.capacity):(s.indexInGroupEntries=h.length,h.push({binding:o,resource:{buffer:t,offset:0,size:e.capacity}}))}}}for(let e=0;e<this._bindGroupEntries.length;++e){let i=this._bindGroupEntries[e];if(!i){this._bindGroups[e]=void 0;continue}this._bindGroups[e]=this._device.createBindGroup({layout:t.getBindGroupLayout(e),entries:i})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=ok._Counter++,this._bindGroupEntries=[],this.clear()}clear(){this._bindGroups=[]}}ok._Counter=0;class oG{get isAsync(){return!1}get isReady(){return this.isAsync,!1}constructor(e){this._name="unnamed",this.engine=e}_getComputeShaderCode(){return this.sources?.compute}dispose(){}}let oz={};oU.prototype.createComputeContext=function(){return new ok(this._device,this._cacheSampler)},oU.prototype.createComputeEffect=function(e,t){let i=("string"==typeof e?e:e.computeToken||e.computeSource||e.computeElement||e.compute)+"@"+t.defines;if(this._compiledComputeEffects[i]){let e=this._compiledComputeEffects[i];return t.onCompiled&&e.isReady()&&t.onCompiled(e),e}let r=new nD(e,t,this,i);return this._compiledComputeEffects[i]=r,r},oU.prototype.createComputePipelineContext=function(){return new oG(this)},oU.prototype.areAllComputeEffectsReady=function(){for(let e in this._compiledComputeEffects)if(!this._compiledComputeEffects[e].isReady())return!1;return!0},oU.prototype.computeDispatch=function(e,t,i,r,s=1,n=1,a,o){this._computeDispatch(e,t,i,r,s,n,void 0,void 0,a,o)},oU.prototype.computeDispatchIndirect=function(e,t,i,r,s=0,n,a){this._computeDispatch(e,t,i,void 0,void 0,void 0,r,s,n,a)},oU.prototype._computeDispatch=function(e,t,i,r,s,n,a,o,l,c){this._endCurrentRenderPass();let u=e._pipelineContext;u.computePipeline||(u.computePipeline=this._device.createComputePipeline({layout:"auto",compute:u.stage})),c&&this._timestampQuery.startPass(oz,this._timestampIndex);let h=this._renderEncoder.beginComputePass(oz);h.setPipeline(u.computePipeline);let d=t.getBindGroups(i,u.computePipeline,l);for(let e=0;e<d.length;++e){let t=d[e];t&&h.setBindGroup(e,t)}void 0!==a?h.dispatchWorkgroupsIndirect(a.underlyingResource,o):r+s+n>0&&h.dispatchWorkgroups(r,s,n),h.end(),c&&(this._timestampQuery.endPass(this._timestampIndex,c),this._timestampIndex+=2)},oU.prototype.releaseComputeEffects=function(){for(let e in this._compiledComputeEffects){let t=this._compiledComputeEffects[e].getPipelineContext();this._deleteComputePipelineContext(t)}this._compiledComputeEffects={}},oU.prototype._prepareComputePipelineContext=function(e,t,i,r,s){this.dbgShowShaderCode&&(re.Y.Log(r),re.Y.Log(t)),e.sources={compute:t,rawCompute:i},e.stage=this._createComputePipelineStageDescriptor(t,r,s)},oU.prototype._releaseComputeEffect=function(e){this._compiledComputeEffects[e._key]&&(delete this._compiledComputeEffects[e._key],this._deleteComputePipelineContext(e.getPipelineContext()))},oU.prototype._rebuildComputeEffects=function(){for(let e in this._compiledComputeEffects){let t=this._compiledComputeEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}},oU.prototype._executeWhenComputeStateIsCompiled=function(e,t){e.stage.module.getCompilationInfo().then(e=>{let i={numErrors:0,messages:[]};for(let t of e.messages)"error"===t.type&&i.numErrors++,i.messages.push({type:t.type,text:t.message,line:t.lineNum,column:t.linePos,length:t.length,offset:t.offset});t(i)})},oU.prototype._deleteComputePipelineContext=function(e){e&&e.dispose()},oU.prototype._createComputePipelineStageDescriptor=function(e,t,i){return t=t?"//"+t.split("\n").join("\n//")+"\n":"",{module:this._device.createShaderModule({code:t+e}),entryPoint:i}},oU.prototype._debugPushGroup=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?this._renderEncoder.pushDebugGroup(e):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(e):this._pendingDebugCommands.push(["push",e]))},oU.prototype._debugPopGroup=function(e){this._options.enableGPUDebugMarkers&&(0===e||1===e?this._renderEncoder.popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))},oU.prototype._debugInsertMarker=function(e,t){this._options.enableGPUDebugMarkers&&(0===t||1===t?this._renderEncoder.insertDebugMarker(e):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(e):this._pendingDebugCommands.push(["insert",e]))},oU.prototype._debugFlushPendingCommands=function(){for(let e=0;e<this._pendingDebugCommands.length;++e){let[t,i]=this._pendingDebugCommands[e];switch(t){case"push":this._debugPushGroup(i);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(i)}}this._pendingDebugCommands.length=0};var oH=i(61146);oU.prototype.createDynamicTexture=function(e,t,i,r){let s=new s0.l(this,4);return s.baseWidth=e,s.baseHeight=t,i&&(e=this.needPOTTextures?(0,oH.p7)(e,this._caps.maxTextureSize):e,t=this.needPOTTextures?(0,oH.p7)(t,this._caps.maxTextureSize):t),s.width=e,s.height=t,s.isReady=!1,s.generateMipMaps=i,s.samplingMode=r,this.updateTextureSamplingMode(r,s),this._internalTexturesCache.push(s),e&&t&&this._textureHelper.createGPUTextureForInternalTexture(s,e,t),s},oU.prototype.updateDynamicTexture=function(e,t,i,r=!1,s,n,a){if(!e)return;let o=t.width,l=t.height,c=e._hardwareTexture;e._hardwareTexture?.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(e,o,l)),this._textureHelper.updateTexture(t,e,o,l,e.depth,c.format,0,0,i,r,0,0,a),e.generateMipMaps&&this._generateMipmaps(e),e._dynamicTextureSource=t,e._premulAlpha=r,e.invertY=i||!1,e.isReady=!0},oU.prototype.unBindMultiColorAttachmentFramebuffer=function(e,t=!1,i){i&&i();let r=e._attachments.length;this._endCurrentRenderPass();for(let i=0;i<r;i++){let r=e.textures[i];!r.generateMipMaps||t||r.isCube||r.is3D||this._generateMipmaps(r)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)},oU.prototype.createMultipleRenderTarget=function(e,t,i){let r=!1,s=!0,n=!1,a=!1,o=15,l=1,c=[],u=[],h=[],d=[],f=[],p=[],m=[],_=[],g=[],v=this._createHardwareRenderTargetWrapper(!0,!1,e);void 0!==t&&(r=void 0!==t.generateMipMaps&&t.generateMipMaps,s=void 0===t.generateDepthBuffer||t.generateDepthBuffer,n=void 0!==t.generateStencilBuffer&&t.generateStencilBuffer,a=void 0!==t.generateDepthTexture&&t.generateDepthTexture,l=t.textureCount||1,o=t.depthTextureFormat??15,t.types&&(c=t.types),t.samplingModes&&(u=t.samplingModes),t.useSRGBBuffers&&(h=t.useSRGBBuffers),t.formats&&(d=t.formats),t.targetTypes&&(f=t.targetTypes),t.faceIndex&&(p=t.faceIndex),t.layerIndex&&(m=t.layerIndex),t.layerCounts&&(_=t.layerCounts),g=t.labels??g),v.label=t?.label??"MultiRenderTargetWrapper";let S=e.width||e,x=e.height||e,E=null;(s||n||a)&&(a||(o=s&&n?13:s?14:19),E=v.createDepthStencilTexture(0,!1,n,1,o,"MultipleRenderTargetDepthStencil"));let C=[],T=[],b=[];v._generateDepthBuffer=s,v._generateStencilBuffer=n,v._attachments=T,v._defaultAttachments=b;for(let e=0;e<l;e++){let t=u[e]||3,s=c[e]||0,n=d[e]||5,a=(h[e]||!1)&&this._caps.supportSRGBBuffers,o=f[e]||3553,l=_[e]??1;if((1!==s||this._caps.textureFloatLinearFiltering)&&(2!==s||this._caps.textureHalfFloatLinearFiltering)||(t=1),1!==s||this._caps.textureFloat||(s=0,re.Y.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),T.push(e+1),b.push(i?e+1:0===e?1:0),-1===o)continue;let p=new s0.l(this,6);switch(C[e]=p,o){case 34067:p.isCube=!0;break;case 32879:p.is3D=!0,p.baseDepth=p.depth=l;break;case 35866:p.is2DArray=!0,p.baseDepth=p.depth=l}p.baseWidth=S,p.baseHeight=x,p.width=S,p.height=x,p.isReady=!0,p.samples=1,p.generateMipMaps=r,p.samplingMode=t,p.type=s,p._cachedWrapU=0,p._cachedWrapV=0,p._useSRGBBuffer=a,p.format=n,p.label=g[e],this._internalTexturesCache.push(p),this._textureHelper.createGPUTextureForInternalTexture(p)}return E&&(E.incrementReferences(),C[l]=E,this._internalTexturesCache.push(E)),v.setTextures(C),v.setLayerAndFaceIndices(m,p),v},oU.prototype.updateMultipleRenderTargetTextureSampleCount=function(e,t){if(!e||!e.textures||e.textures[0].samples===t)return t;let i=e.textures.length;if(0===i)return 1;t=Math.min(t,this.getCaps().maxMSAASamples);for(let t=0;t<i;++t){let i=e.textures[t]._hardwareTexture;i?.releaseMSAATexture()}let r=e._depthStencilTexture===e.textures[i-1];for(let s=0;s<i;++s){let n=e.textures[s];this._textureHelper.createMSAATexture(n,t,!1,s===i-1&&r?0:s),n.samples=t}return e._depthStencilTexture&&!r&&(this._textureHelper.createMSAATexture(e._depthStencilTexture,t),e._depthStencilTexture.samples=t),t},oU.prototype.bindAttachments=function(e){0!==e.length&&this._currentRenderTarget&&(this._mrtAttachments=e,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(e))},oU.prototype.buildTextureLayout=function(e){let t=[];for(let i=0;i<e.length;i++)e[i]?t.push(i+1):t.push(0);return t},oU.prototype.restoreSingleAttachment=function(){},oU.prototype.restoreSingleAttachmentForRenderTarget=function(){},oU.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter},oU.prototype.captureGPUFrameTime=function(e){this._timestampQuery.enable=e&&!!this._caps.timerQuery},oU.prototype.createQuery=function(){return this._occlusionQuery.createQuery()},oU.prototype.deleteQuery=function(e){return this._occlusionQuery.deleteQuery(e),this},oU.prototype.isQueryResultAvailable=function(e){return this._occlusionQuery.isQueryResultAvailable(e)},oU.prototype.getQueryResult=function(e){return this._occlusionQuery.getQueryResult(e)},oU.prototype.beginOcclusionQuery=function(e,t){return this.compatibilityMode?!!this._occlusionQuery.canBeginQuery(t)&&(this._currentRenderPass?.beginOcclusionQuery(t),!0):(this._bundleList.addItem(new oS(t)),!0)},oU.prototype.endOcclusionQuery=function(){return this.compatibilityMode?this._currentRenderPass?.endOcclusionQuery():this._bundleList.addItem(new ox),this},oU.prototype.updateVideoTexture=function(e,t,i){if(!e||e._isDisabled)return;void 0===this._videoTextureSupported&&(this._videoTextureSupported=!0);let r=e._hardwareTexture;if(e._hardwareTexture?.underlyingResource||(r=this._textureHelper.createGPUTextureForInternalTexture(e)),t&&void 0!==t.underlyingResource){if(t.isReady()){try{this._textureHelper.copyVideoToTexture(t,e,r.format,!i),e.generateMipMaps&&this._generateMipmaps(e)}catch(e){}e.isReady=!0}}else t&&this.createImageBitmap(t).then(t=>{this._textureHelper.updateTexture(t,e,e.width,e.height,e.depth,r.format,0,0,!i,!1,0,0),e.generateMipMaps&&this._generateMipmaps(e),e.isReady=!0}).catch(()=>{e.isReady=!0})},i(17949),i(99091),i(21204),i(66508),i(30990),i(8434),i(52111);class oW extends nH.tb{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}get disableMaterial(){return this._disableMaterial}constructor(e,t=i2.Wo.Gray(),i=nW.x.DefaultUtilityLayer,r=null,s=1,n=i2.Wo.Yellow(),a=i2.Wo.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new i0.y$,this.uniformScaling=!1,this.sensitivity=1,this.dragScale=1,this.incrementalSnap=!1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._tmpVector=new i1.P(0,0,0),this._incrementalStartupValue=i1.P.Zero(),this._parent=r,this._coloredMaterial=new nn.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new i2.Wo(.1,.1,.1)),this._hoverMaterial=new nn.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=n,this._disableMaterial=new nn.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=a,this._disableMaterial.alpha=.4,this._gizmoMesh=new rP.Kj("axis",i.utilityLayerScene);let{arrowMesh:o,arrowTail:l}=this._createGizmoMesh(this._gizmoMesh,s),c=this._createGizmoMesh(this._gizmoMesh,s+4,!0);this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,nH.tb.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3);let u=o.position.clone(),h=l.position.clone(),d=l.scaling.clone(),f=e=>{let t=3/this._rootMesh.scaling.length()*e*6;o.position.z+=t/3.5,l.scaling.y+=t,this.dragScale=l.scaling.y,l.position.z=o.position.z/2},p=()=>{o.position.set(u.x,u.y,u.z),l.position.set(h.x,h.y,h.z),l.scaling.set(d.x,d.y,d.z),this.dragScale=l.scaling.y,this._dragging=!1};this.dragBehavior=new r7.M({dragAxis:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.updateDragPlane=!1,this._rootMesh.addBehavior(this.dragBehavior);let m=0,_=0,g={snapDistance:0};this.dragBehavior.onDragObservable.add(t=>{if(this.attachedNode){let i=this.sensitivity*t.dragDistance*(3*this.scaleRatio/this._rootMesh.scaling.length()),r=this._tmpVector,s=!1,n=0;if(this.uniformScaling?r.setAll(.57735):r.copyFrom(e),0==this.snapDistance)r.scaleToRef(i,r);else{m+=i,_+=i;let e=this.incrementalSnap?_:m;Math.abs(e)>this.snapDistance?(n=Math.floor(Math.abs(e)/this.snapDistance),e<0&&(n*=-1),m%=this.snapDistance,r.scaleToRef(this.snapDistance*n,r),s=!0):r.scaleInPlace(0)}r.addInPlaceFromFloats(1,1,1),r.x=Math.abs(r.x)<oW.MinimumAbsoluteScale?oW.MinimumAbsoluteScale*(r.x<0?-1:1):r.x,r.y=Math.abs(r.y)<oW.MinimumAbsoluteScale?oW.MinimumAbsoluteScale*(r.y<0?-1:1):r.y,r.z=Math.abs(r.z)<oW.MinimumAbsoluteScale?oW.MinimumAbsoluteScale*(r.z<0?-1:1):r.z;let a=this.attachedNode._isMesh?this.attachedNode:void 0;Math.abs(this.snapDistance)>0&&this.incrementalSnap?(this.attachedNode.getWorldMatrix().decompose(void 0,i1.jp.Quaternion[0],i1.jp.Vector3[2],nH.tb.PreserveScaling?a:void 0),r.addInPlace(this._incrementalStartupValue),r.addInPlaceFromFloats(-1,-1,-1),r.x=Math.abs(r.x)*(this._incrementalStartupValue.x>0?1:-1),r.y=Math.abs(r.y)*(this._incrementalStartupValue.y>0?1:-1),r.z=Math.abs(r.z)*(this._incrementalStartupValue.z>0?1:-1),i1.y3.ComposeToRef(r,i1.jp.Quaternion[0],i1.jp.Vector3[2],i1.jp.Matrix[1])):(i1.y3.ScalingToRef(r.x,r.y,r.z,i1.jp.Matrix[2]),i1.jp.Matrix[2].multiplyToRef(this.attachedNode.getWorldMatrix(),i1.jp.Matrix[1])),i1.jp.Matrix[1].decompose(i1.jp.Vector3[1],void 0,void 0,nH.tb.PreserveScaling?a:void 0),1e5>Math.abs(i1.jp.Vector3[1].x)&&1e5>Math.abs(i1.jp.Vector3[1].y)&&1e5>Math.abs(i1.jp.Vector3[1].z)&&this.attachedNode.getWorldMatrix().copyFrom(i1.jp.Matrix[1]),s&&(g.snapDistance=this.snapDistance*n,this.onSnapObservable.notifyObservers(g)),this._matrixChanged()}}),this.dragBehavior.onDragStartObservable.add(()=>{this._dragging=!0;let e=this.attachedNode._isMesh?this.attachedNode:void 0;this.attachedNode?.getWorldMatrix().decompose(this._incrementalStartupValue,void 0,void 0,nH.tb.PreserveScaling?e:void 0),m=0,_=0}),this.dragBehavior.onDragObservable.add(e=>f(e.dragDistance)),this.dragBehavior.onDragEndObservable.add(p),r?.uniformScaleGizmo?.dragBehavior?.onDragObservable?.add(e=>f(e.delta.y)),r?.uniformScaleGizmo?.dragBehavior?.onDragEndObservable?.add(p);let v={gizmoMeshes:[o,l],colliderMeshes:[c.arrowMesh,c.arrowTail],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,v),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(e=>{if(this._customMeshSet)return;let t=this._parent?.getAxisCache(this._gizmoMesh);if(this._isHovered=!!t&&-1!=t.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh),t=this._parent?.getAxisCache(this._rootMesh),this._isHovered||(this._isHovered=!!t&&-1!=t.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh)),!this._parent){let e=this.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(v.gizmoMeshes,e)}}),this.dragBehavior.onEnabledObservable.add(e=>{this._setGizmoMeshMaterial(v.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)});let S=i._getSharedGizmoLight();S.includedOnlyMeshes=S.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes())}_createGizmoMesh(e,t,i=!1){let r=(0,nX.NR)("yPosMesh",{size:.4*(1+(t-1)/4)},this.gizmoLayer.utilityLayerScene),s=(0,nz.wf)("cylinder",{diameterTop:.005*t,height:.275,diameterBottom:.005*t,tessellation:96},this.gizmoLayer.utilityLayerScene);return r.scaling.scaleInPlace(.1),r.material=this._coloredMaterial,r.rotation.x=Math.PI/2,r.position.z+=.3,s.material=this._coloredMaterial,s.position.z+=.1375,s.rotation.x=Math.PI/2,i&&(r.visibility=0,s.visibility=0),e.addChild(r),e.addChild(s),{arrowMesh:r,arrowTail:s}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh,this.attachedNode=this._parent.attachedNode):(this.attachedMesh=null,this.attachedNode=null)}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()}),super.dispose()}setCustomMesh(e,t=!1){super.setCustomMesh(e),t&&(this._rootMesh.getChildMeshes().forEach(e=>{e.material=this._coloredMaterial,e.color&&(e.color=this._coloredMaterial.diffuseColor)}),this._customMeshSet=!1)}}oW.MinimumAbsoluteScale=r2.kn,i(73030);var oY=i(74591);class oX extends nH.tb{get coloredMaterial(){return this._coloredMaterial}get hoverMaterial(){return this._hoverMaterial}set rotationColor(e){this._rotationShaderMaterial.setColor3("rotationColor",e)}get disableMaterial(){return this._disableMaterial}constructor(e,t=i2.Wo.Gray(),i=nW.x.DefaultUtilityLayer,r=32,s=null,n=!1,a=1,o=i2.Wo.Yellow(),l=i2.Wo.Gray()){super(i),this._pointerObserver=null,this.snapDistance=0,this.onSnapObservable=new i0.y$,this.angle=0,this.sensitivity=1,this._isEnabled=!0,this._parent=null,this._dragging=!1,this._angles=new i1.P,this._parent=s,this._coloredMaterial=new nn.K("",i.utilityLayerScene),this._coloredMaterial.diffuseColor=t,this._coloredMaterial.specularColor=t.subtract(new i2.Wo(.1,.1,.1)),this._hoverMaterial=new nn.K("",i.utilityLayerScene),this._hoverMaterial.diffuseColor=o,this._hoverMaterial.specularColor=o,this._disableMaterial=new nn.K("",i.utilityLayerScene),this._disableMaterial.diffuseColor=l,this._disableMaterial.alpha=.4,this._gizmoMesh=new rP.Kj("",i.utilityLayerScene);let{rotationMesh:c,collider:u}=this._createGizmoMesh(this._gizmoMesh,a,r);this._rotationDisplayPlane=(0,oY.pT)("rotationDisplay",{size:.6,updatable:!1},this.gizmoLayer.utilityLayerScene),this._rotationDisplayPlane.rotation.z=.5*Math.PI,this._rotationDisplayPlane.parent=this._gizmoMesh,this._rotationDisplayPlane.setEnabled(!1),n1.Q.ShadersStore.rotationGizmoVertexShader=oX._RotationGizmoVertexShader,n1.Q.ShadersStore.rotationGizmoFragmentShader=oX._RotationGizmoFragmentShader,this._rotationShaderMaterial=new nA.j("shader",this.gizmoLayer.utilityLayerScene,{vertex:"rotationGizmo",fragment:"rotationGizmo"},{attributes:["position","uv"],uniforms:["worldViewProjection","angles","rotationColor"]}),this._rotationShaderMaterial.backFaceCulling=!1,this.rotationColor=o,this._rotationDisplayPlane.material=this._rotationShaderMaterial,this._rotationDisplayPlane.visibility=.999,this._gizmoMesh.lookAt(this._rootMesh.position.add(e)),this._rootMesh.addChild(this._gizmoMesh,nH.tb.PreserveScaling),this._gizmoMesh.scaling.scaleInPlace(1/3),this.dragBehavior=new r7.M({dragPlaneNormal:e}),this.dragBehavior.moveAttached=!1,this.dragBehavior.maxDragAngle=oX.MaxDragAngle,this.dragBehavior._useAlternatePickedPointAboveMaxDragAngle=!0,this._rootMesh.addBehavior(this.dragBehavior);let h=new i1.P,d=new i1.y3,f=new i1.P,p=new i1.P;this.dragBehavior.onDragStartObservable.add(e=>{this.attachedNode&&(h.copyFrom(e.dragPlanePoint),this._rotationDisplayPlane.setEnabled(!0),this._rotationDisplayPlane.getWorldMatrix().invertToRef(d),i1.P.TransformCoordinatesToRef(e.dragPlanePoint,d,h),this._angles.x=Math.atan2(h.y,h.x)+Math.PI,this._angles.y=0,this._angles.z=this.updateGizmoRotationToMatchAttachedMesh?1:0,this._dragging=!0,h.copyFrom(e.dragPlanePoint),this._rotationShaderMaterial.setVector3("angles",this._angles),this.angle=0)}),this.dragBehavior.onDragEndObservable.add(()=>{this._dragging=!1,this._rotationDisplayPlane.setEnabled(!1)});let m={snapDistance:0},_=0,g=new i1.y3,v=new i1._f;this.dragBehavior.onDragObservable.add(t=>{if(this.attachedNode){let r=new i1.P(1,1,1),s=new i1._f(0,0,0,1),n=new i1.P(0,0,0);if(this.attachedNode.getWorldMatrix().decompose(r,s,n),!(Math.abs(Math.abs(r.x)-Math.abs(r.y))<=r2.kn&&Math.abs(Math.abs(r.x)-Math.abs(r.z))<=r2.kn)&&this.updateGizmoRotationToMatchAttachedMesh){re.Y.Warn("Unable to use a rotation gizmo matching mesh rotation with non uniform scaling. Use uniform scaling or set updateGizmoRotationToMatchAttachedMesh to false.");return}s.normalize();let a=this.updateGizmoPositionToMatchAttachedMesh?n:this._rootMesh.absolutePosition,o=t.dragPlanePoint.subtract(a).normalize(),l=h.subtract(a).normalize(),c=i1.P.Cross(o,l),u=i1.P.Dot(o,l),S=Math.atan2(c.length(),u)*this.sensitivity;f.copyFrom(e),p.copyFrom(e),this.updateGizmoRotationToMatchAttachedMesh&&(s.toRotationMatrix(d),p=i1.P.TransformCoordinates(f,d));let x=!1;if(i.utilityLayerScene.activeCamera){let e=i.utilityLayerScene.activeCamera.position.subtract(a).normalize();i1.P.Dot(e,p)>0&&(f.scaleInPlace(-1),p.scaleInPlace(-1),x=!0)}i1.P.Dot(p,c)>0&&(S=-S),i1.jp.Vector3[0].set(S,0,0),this.dragBehavior.validateDrag(i1.jp.Vector3[0])||(S=0);let E=!1;if(0!=this.snapDistance){if(Math.abs(_+=S)>this.snapDistance){let e=Math.floor(Math.abs(_)/this.snapDistance);_<0&&(e*=-1),_%=this.snapDistance,S=this.snapDistance*e,E=!0}else S=0}let C=Math.sin(S/2);if(v.set(f.x*C,f.y*C,f.z*C,Math.cos(S/2)),g.determinant()>0){let e=new i1.P;v.toEulerAnglesToRef(e),i1._f.RotationYawPitchRollToRef(e.y,-e.x,-e.z,v)}if(this.updateGizmoRotationToMatchAttachedMesh)s.multiplyToRef(v,s),s.normalize(),i1.y3.ComposeToRef(r,s,n,this.attachedNode.getWorldMatrix());else{v.toRotationMatrix(i1.jp.Matrix[0]);let e=this.attachedNode.getWorldMatrix().getTranslation();this.attachedNode.getWorldMatrix().multiplyToRef(i1.jp.Matrix[0],this.attachedNode.getWorldMatrix()),this.attachedNode.getWorldMatrix().setTranslation(e)}h.copyFrom(t.dragPlanePoint),E&&(m.snapDistance=S,this.onSnapObservable.notifyObservers(m)),this._angles.y+=S,this.angle+=x?-S:S,this._rotationShaderMaterial.setVector3("angles",this._angles),this._matrixChanged()}});let S=i._getSharedGizmoLight();S.includedOnlyMeshes=S.includedOnlyMeshes.concat(this._rootMesh.getChildMeshes(!1));let x={colliderMeshes:[u],gizmoMeshes:[c],material:this._coloredMaterial,hoverMaterial:this._hoverMaterial,disableMaterial:this._disableMaterial,active:!1,dragBehavior:this.dragBehavior};this._parent?.addToAxisCache(this._gizmoMesh,x),this._pointerObserver=i.utilityLayerScene.onPointerObservable.add(e=>{if(!this._customMeshSet&&(this.dragBehavior.maxDragAngle=oX.MaxDragAngle,this._isHovered=-1!=x.colliderMeshes.indexOf(e?.pickInfo?.pickedMesh),!this._parent)){let e=x.dragBehavior.enabled?this._isHovered||this._dragging?this._hoverMaterial:this._coloredMaterial:this._disableMaterial;this._setGizmoMeshMaterial(x.gizmoMeshes,e)}}),this.dragBehavior.onEnabledObservable.add(e=>{this._setGizmoMeshMaterial(x.gizmoMeshes,e?this._coloredMaterial:this._disableMaterial)})}_createGizmoMesh(e,t,i){let r=(0,nS.eu)("ignore",{diameter:.6,thickness:.03*t,tessellation:i},this.gizmoLayer.utilityLayerScene);r.visibility=0;let s=(0,nS.eu)("",{diameter:.6,thickness:.005*t,tessellation:i},this.gizmoLayer.utilityLayerScene);return s.material=this._coloredMaterial,s.rotation.x=Math.PI/2,r.rotation.x=Math.PI/2,e.addChild(s,nH.tb.PreserveScaling),e.addChild(r,nH.tb.PreserveScaling),{rotationMesh:s,collider:r}}_attachedNodeChanged(e){this.dragBehavior&&(this.dragBehavior.enabled=!!e)}set isEnabled(e){this._isEnabled=e,e?this._parent&&(this.attachedMesh=this._parent.attachedMesh):this.attachedMesh=null}get isEnabled(){return this._isEnabled}dispose(){this.onSnapObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this.dragBehavior.detach(),this._gizmoMesh&&this._gizmoMesh.dispose(),this._rotationDisplayPlane&&this._rotationDisplayPlane.dispose(),this._rotationShaderMaterial&&this._rotationShaderMaterial.dispose(),[this._coloredMaterial,this._hoverMaterial,this._disableMaterial].forEach(e=>{e&&e.dispose()}),super.dispose()}}oX.MaxDragAngle=9*Math.PI/20,oX._RotationGizmoVertexShader=`
        precision highp float;
        attribute vec3 position;
        attribute vec2 uv;
        uniform mat4 worldViewProjection;
        varying vec3 vPosition;
        varying vec2 vUV;

        void main(void) {
            gl_Position = worldViewProjection * vec4(position, 1.0);
            vUV = uv;
        }`,oX._RotationGizmoFragmentShader=`
        precision highp float;
        varying vec2 vUV;
        varying vec3 vPosition;
        uniform vec3 angles;
        uniform vec3 rotationColor;

        #define twopi 6.283185307

        void main(void) {
            vec2 uv = vUV - vec2(0.5);
            float angle = atan(uv.y, uv.x) + 3.141592;
            float delta = gl_FrontFacing ? angles.y : -angles.y;
            float begin = angles.x - delta * angles.z;
            float start = (begin < (begin + delta)) ? begin : (begin + delta);
            float end = (begin > (begin + delta)) ? begin : (begin + delta);
            float len = sqrt(dot(uv,uv));
            float opacity = 1. - step(0.5, len);

            float base = abs(floor(start / twopi)) * twopi;
            start += base;
            end += base;

            float intensity = 0.;
            for (int i = 0; i < 5; i++)
            {
                intensity += max(step(start, angle) - step(end, angle), 0.);
                angle += twopi;
            }
            gl_FragColor = vec4(rotationColor, min(intensity * 0.25, 0.8)) * opacity;
        }
    `,i(617);var o$=i(97375);class oj extends rN._{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0,this._viewMatrix=i1.y3.Identity(),this._projectionMatrix=i1.y3.Identity()}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return!!this.parent&&!!this.parent.getWorldMatrix&&(this.transformedPosition||(this.transformedPosition=i1.P.Zero()),i1.P.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=i1.P.Zero()),i1.P.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0)}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=i1.P.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();let e=i1.P.Cross(this.direction,r9.RD.Y),t=i1.P.Cross(e,this.direction);return i1.P.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=i1.P.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?this._currentRenderId=this.getScene().getRenderId():(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=i1.y3.Identity()),i1.y3.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0),this._worldMatrix}getDepthMinZ(e){return void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),this.parent&&this.parent.getWorldMatrix||(this.transformedPosition=null,this.transformedDirection=null)}getViewMatrix(e){let t=i1.jp.Vector3[0],i=this.position;this.computeTransformedInformation()&&(i=this.transformedPosition),i1.P.NormalizeToRef(this.getShadowDirection(e),t),1===Math.abs(i1.P.Dot(t,i1.P.Up()))&&(t.z=1e-13);let r=i1.jp.Vector3[1];return i.addToRef(t,r),i1.y3.LookAtLHToRef(i,r,i1.P.Up(),this._viewMatrix),this._viewMatrix}getProjectionMatrix(e,t){return this.setShadowProjectionMatrix(this._projectionMatrix,e??this._viewMatrix,t??[]),this._projectionMatrix}}(0,r$.gn)([(0,rj.hd)()],oj.prototype,"position",null),(0,r$.gn)([(0,rj.hd)()],oj.prototype,"direction",null),(0,r$.gn)([(0,rj.qC)()],oj.prototype,"shadowMinZ",null),(0,r$.gn)([(0,rj.qC)()],oj.prototype,"shadowMaxZ",null),sC.N.AddNodeConstructor("Light_Type_1",(e,t)=>()=>new oq(e,i1.P.Zero(),t));class oq extends oj{get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}getClassName(){return"DirectionalLight"}getTypeID(){return rN._.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){let t=this.getScene().activeCamera;t&&i1.y3.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,void 0!==this.shadowMinZ?this.shadowMinZ:t.minZ,void 0!==this.shadowMaxZ?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){let e=i1.P.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=-Number.MAX_VALUE,this._orthoTop=-Number.MAX_VALUE,this._orthoBottom=Number.MAX_VALUE;let r=Number.MAX_VALUE,s=-Number.MAX_VALUE;for(let n=0;n<i.length;n++){let a=i[n];if(!a)continue;let o=a.getBoundingInfo().boundingBox;for(let i=0;i<o.vectorsWorld.length;i++)i1.P.TransformCoordinatesToRef(o.vectorsWorld[i],t,e),e.x<this._orthoLeft&&(this._orthoLeft=e.x),e.y<this._orthoBottom&&(this._orthoBottom=e.y),e.x>this._orthoRight&&(this._orthoRight=e.x),e.y>this._orthoTop&&(this._orthoTop=e.y),this.autoCalcShadowZBounds&&(e.z<r&&(r=e.z),e.z>s&&(s=e.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=r,this._shadowMaxZ=s)}let s=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,a=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,o=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;i1.y3.OrthoOffCenterLHToRef(this._orthoLeft-s*this.shadowOrthoScale,this._orthoRight+s*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,l?o:a,l?a:o,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t):this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z):e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this}getDepthMinZ(e){let t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){let t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}(0,r$.gn)([(0,rj.qC)()],oq.prototype,"shadowFrustumSize",null),(0,r$.gn)([(0,rj.qC)()],oq.prototype,"shadowOrthoScale",null),(0,r$.gn)([(0,rj.qC)()],oq.prototype,"autoUpdateExtends",void 0),(0,r$.gn)([(0,rj.qC)()],oq.prototype,"autoCalcShadowZBounds",void 0),(0,r$.gn)([(0,rj.qC)("orthoLeft")],oq.prototype,"_orthoLeft",void 0),(0,r$.gn)([(0,rj.qC)("orthoRight")],oq.prototype,"_orthoRight",void 0),(0,r$.gn)([(0,rj.qC)("orthoTop")],oq.prototype,"_orthoTop",void 0),(0,r$.gn)([(0,rj.qC)("orthoBottom")],oq.prototype,"_orthoBottom",void 0),(0,i3.H7)("BABYLON.DirectionalLight",oq);var oQ=i(21947);function oK(e,t={},i){t.diameter||(t.diameter=1),t.segments||(t.segments=16);let r=(0,n$.Qk)("",{slice:.5,diameter:t.diameter,segments:t.segments},i),s=(0,oQ.uH)("",{radius:t.diameter/2,tessellation:3*t.segments+(4-t.segments)},i);s.rotation.x=-Math.PI/2,s.parent=r;let n=rP.Kj.MergeMeshes([s,r],!0);return n.name=e,n}rP.Kj.CreateHemisphere=(e,t,i,r)=>oK(e,{segments:t,diameter:i},r),sC.N.AddNodeConstructor("Light_Type_2",(e,t)=>()=>new oZ(e,i1.P.Zero(),i1.P.Zero(),0,0,t));class oZ extends oj{get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(.5*e),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(oZ._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):oZ._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return void 0!==e.onGeneratedObservable}static _IsTexture(e){return void 0!==e.onLoadObservable}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}constructor(e,t,i,r,s,n){super(e,n),this._innerAngle=0,this._projectionTextureMatrix=i1.y3.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=i1.P.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=i1.P.Zero(),this._projectionTextureViewLightMatrix=i1.y3.Zero(),this._projectionTextureProjectionLightMatrix=i1.y3.Zero(),this._projectionTextureScalingMatrix=i1.y3.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=r,this.exponent=s}getClassName(){return"SpotLight"}getTypeID(){return rN._.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;this._shadowAngleScale=this._shadowAngleScale||1;let s=this._shadowAngleScale*this._angle,n=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,a=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;i1.y3.PerspectiveFovLHToRef(s,1,o?a:n,o?n:a,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.getAbsolutePosition().addToRef(this.getShadowDirection(),this._projectionTextureViewTargetVector),i1.y3.LookAtLHToRef(this.getAbsolutePosition(),this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;let e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),r=1/Math.tan(this._angle/2);i1.y3.FromValuesToRef(r/1,0,0,0,0,r,0,0,0,0,i,1,0,0,-i*t,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof rZ.x){let e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;i1.y3.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(.5*this._innerAngle)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightTexture"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=i1.P.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=i1.P.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return i=this.computeTransformedInformation()?i1.P.Normalize(this.transformedDirection):i1.P.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){let t=this._scene.getEngine(),i=void 0!==this.shadowMinZ?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){let t=this._scene.getEngine(),i=void 0!==this.shadowMaxZ?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}(0,r$.gn)([(0,rj.qC)()],oZ.prototype,"angle",null),(0,r$.gn)([(0,rj.qC)()],oZ.prototype,"innerAngle",null),(0,r$.gn)([(0,rj.qC)()],oZ.prototype,"shadowAngleScale",null),(0,r$.gn)([(0,rj.qC)()],oZ.prototype,"exponent",void 0),(0,r$.gn)([(0,rj.qC)()],oZ.prototype,"projectionTextureLightNear",null),(0,r$.gn)([(0,rj.qC)()],oZ.prototype,"projectionTextureLightFar",null),(0,r$.gn)([(0,rj.qC)()],oZ.prototype,"projectionTextureUpDirection",null),(0,r$.gn)([(0,rj.oU)("projectedLightTexture")],oZ.prototype,"_projectionTexture",void 0),(0,i3.H7)("BABYLON.SpotLight",oZ);class oJ extends nH.tb{constructor(e=nW.x.DefaultUtilityLayer){super(e),this._cachedPosition=new i1.P,this._cachedForward=new i1.P(0,0,1),this._pointerObserver=null,this.onClickedObservable=new i0.y$,this._light=null,this.attachedMesh=new rP.Kj("",this.gizmoLayer.utilityLayerScene),this._attachedMeshParent=new rR.Y("parent",this.gizmoLayer.utilityLayerScene),this.attachedMesh.parent=this._attachedMeshParent,this._material=new nn.K("light",this.gizmoLayer.utilityLayerScene),this._material.diffuseColor=new i2.Wo(.5,.5,.5),this._material.specularColor=new i2.Wo(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add(e=>{this._light&&(this._isHovered=!!(e.pickInfo&&-1!=this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._light))},r1.kD.POINTERDOWN)}get attachedNode(){return this.attachedMesh}set attachedNode(e){re.Y.Warn("Nodes cannot be attached to LightGizmo. Attach to a mesh instead.")}set light(e){if(this._light=e,e){this._lightMesh&&this._lightMesh.dispose(),e instanceof o$.e?this._lightMesh=oJ._CreateHemisphericLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof oq?this._lightMesh=oJ._CreateDirectionalLightMesh(this.gizmoLayer.utilityLayerScene):e instanceof oZ?this._lightMesh=oJ._CreateSpotLightMesh(this.gizmoLayer.utilityLayerScene):this._lightMesh=oJ._CreatePointLightMesh(this.gizmoLayer.utilityLayerScene),this._lightMesh.getChildMeshes(!1).forEach(e=>{e.material=this._material}),this._lightMesh.parent=this._rootMesh;let t=this.gizmoLayer._getSharedGizmoLight();if(t.includedOnlyMeshes=t.includedOnlyMeshes.concat(this._lightMesh.getChildMeshes(!1)),this._lightMesh.rotationQuaternion=new i1._f,this.attachedMesh.reservedDataStore||(this.attachedMesh.reservedDataStore={}),this.attachedMesh.reservedDataStore.lightGizmo=this,e.parent&&this._attachedMeshParent.freezeWorldMatrix(e.parent.getWorldMatrix()),e.position&&(this.attachedMesh.position.copyFrom(e.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position)),e.direction){this.attachedMesh.setDirection(e.direction),this.attachedMesh.computeWorldMatrix(!0);let t=this._getMeshForward();this._cachedForward.copyFrom(t)}this._update()}}get light(){return this._light}get material(){return this._material}_getMeshForward(){let e=this.attachedMesh.forward;return this.attachedMesh.getScene().useRightHandedSystem&&(e.negateToRef(i1.jp.Vector3[0]),e=i1.jp.Vector3[0]),e}_update(){if(super._update(),this._light){if(this._light.parent&&this._attachedMeshParent.freezeWorldMatrix(this._light.parent.getWorldMatrix()),this._light.position){if(this.attachedMesh.position.equals(this._cachedPosition))this.attachedMesh.position.copyFrom(this._light.position),this.attachedMesh.computeWorldMatrix(!0),this._cachedPosition.copyFrom(this.attachedMesh.position);else{let e=this.attachedMesh.position;this._light.position=new i1.P(e.x,e.y,e.z),this._cachedPosition.copyFrom(this.attachedMesh.position)}}if(this._light.direction){let e=this._getMeshForward();i1.P.DistanceSquared(e,this._cachedForward)>1e-4?(this._light.direction=new i1.P(e.x,e.y,e.z),this._cachedForward.copyFrom(e)):i1.P.DistanceSquared(e,this._light.direction)>1e-4&&(this.attachedMesh.setDirection(this._light.direction),this.attachedMesh.computeWorldMatrix(!0),this._cachedForward.copyFrom(e))}}}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._material.dispose(),super.dispose(),this._attachedMeshParent.dispose()}static _CreateHemisphericLightMesh(e){let t=new rP.Kj("hemisphereLight",e),i=oK(t.name,{segments:10,diameter:1},e);return i.position.z=-.15,i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(3,e).parent=t,t.scaling.scaleInPlace(oJ._Scale),t.rotation.x=Math.PI/2,t}static _CreatePointLightMesh(e){let t=new rP.Kj("pointLight",e),i=(0,n$.Qk)(t.name,{segments:10,diameter:1},e);return i.rotation.x=Math.PI/2,i.parent=t,this._CreateLightLines(5,e).parent=t,t.scaling.scaleInPlace(oJ._Scale),t.rotation.x=Math.PI/2,t}static _CreateSpotLightMesh(e){let t=new rP.Kj("spotLight",e);(0,n$.Qk)(t.name,{segments:10,diameter:1},e).parent=t;let i=oK(t.name,{segments:10,diameter:2},e);return i.parent=t,i.rotation.x=-Math.PI/2,this._CreateLightLines(2,e).parent=t,t.scaling.scaleInPlace(oJ._Scale),t.rotation.x=Math.PI/2,t}static _CreateDirectionalLightMesh(e){let t=new rP.Kj("directionalLight",e),i=new rP.Kj(t.name,e);i.parent=t,(0,n$.Qk)(t.name,{diameter:1.2,segments:10},e).parent=i;let r=(0,nz.wf)(t.name,{updatable:!1,height:6,diameterTop:.3,diameterBottom:.3,tessellation:6,subdivisions:1},e);r.parent=i;let s=r.clone(t.name);s.scaling.y=.5,s.position.x+=1.25;let n=r.clone(t.name);n.scaling.y=.5,n.position.x+=-1.25;let a=(0,nz.wf)(t.name,{updatable:!1,height:1,diameterTop:0,diameterBottom:.6,tessellation:6,subdivisions:1},e);return a.position.y+=3,a.parent=i,(s=a.clone(t.name)).position.y=1.5,s.position.x+=1.25,(n=a.clone(t.name)).position.y=1.5,n.position.x+=-1.25,i.scaling.scaleInPlace(oJ._Scale),i.rotation.z=Math.PI/2,i.rotation.y=Math.PI/2,t}}oJ._Scale=.007,oJ._CreateLightLines=(e,t)=>{let i=new rP.Kj("root",t);i.rotation.x=Math.PI/2;let r=new rP.Kj("linePivot",t);r.parent=i;let s=(0,nz.wf)("line",{updatable:!1,height:2,diameterTop:.2,diameterBottom:.3,tessellation:6,subdivisions:1},t);if(s.position.y=s.scaling.y/2+1.2,s.parent=r,e<2)return r;for(let e=0;e<4;e++){let t=r.clone("lineParentClone");t.rotation.z=Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}if(e<3)return i;for(let e=0;e<4;e++){let t=r.clone("linePivotClone");t.rotation.z=Math.PI/2,t.rotation.y=Math.PI/2*e}if(e<4)return i;for(let e=0;e<4;e++){let t=r.clone("linePivotClone");t.rotation.z=Math.PI+Math.PI/4,t.rotation.y=Math.PI/2+Math.PI/2*e,t.getChildMeshes()[0].scaling.y=.5,t.getChildMeshes()[0].scaling.x=t.getChildMeshes()[0].scaling.z=.8,t.getChildMeshes()[0].position.y=t.getChildMeshes()[0].scaling.y/2+1.2}return e<5||(r.clone("linePivotClone").rotation.z=Math.PI),i};class o0 extends nH.tb{constructor(e=nW.x.DefaultUtilityLayer,t,i){super(e),this._pointerObserver=null,this.onClickedObservable=new i0.y$,this._camera=null,this._invProjection=new aN.y3,this._material=new nn.K("cameraGizmoMaterial",this.gizmoLayer.utilityLayerScene),this._frustumLinesColor=i,this._material.diffuseColor=t??new i2.Wo(.5,.5,.5),this._material.specularColor=new i2.Wo(.1,.1,.1),this._pointerObserver=e.utilityLayerScene.onPointerObservable.add(e=>{this._camera&&(this._isHovered=!!(e.pickInfo&&-1!=this._rootMesh.getChildMeshes().indexOf(e.pickInfo.pickedMesh)),this._isHovered&&0===e.event.button&&this.onClickedObservable.notifyObservers(this._camera))},r1.kD.POINTERDOWN)}get displayFrustum(){return this._cameraLinesMesh.isEnabled()}set displayFrustum(e){this._cameraLinesMesh.setEnabled(e)}set camera(e){if(this._camera=e,this.attachedNode=e,e){this._customMeshSet||(this._cameraMesh&&this._cameraMesh.dispose(),this._cameraMesh=o0._CreateCameraMesh(this.gizmoLayer.utilityLayerScene),this._cameraMesh.getChildMeshes(!1).forEach(e=>{e.material=this._material}),this._cameraMesh.parent=this._rootMesh),this._cameraLinesMesh&&this._cameraLinesMesh.dispose();let t=this._frustumLinesColor?.toColor4(1)??new i2.HE(1,1,1,1);this._cameraLinesMesh=o0._CreateCameraFrustum(this.gizmoLayer.utilityLayerScene,t),this._cameraLinesMesh.parent=this._rootMesh,this.gizmoLayer.utilityLayerScene.activeCamera&&this.gizmoLayer.utilityLayerScene.activeCamera.maxZ<1.5*e.maxZ&&(this.gizmoLayer.utilityLayerScene.activeCamera.maxZ=1.5*e.maxZ),this.attachedNode.reservedDataStore||(this.attachedNode.reservedDataStore={}),this.attachedNode.reservedDataStore.cameraGizmo=this;let i=this.gizmoLayer._getSharedGizmoLight();i.includedOnlyMeshes=i.includedOnlyMeshes.concat(this._cameraMesh.getChildMeshes(!1)),this._update()}}get camera(){return this._camera}get material(){return this._material}_update(){super._update(),this._camera&&(this._camera.getProjectionMatrix().invertToRef(this._invProjection),this._cameraLinesMesh.setPivotMatrix(this._invProjection,!1),this._cameraLinesMesh.scaling.x=1/this._rootMesh.scaling.x,this._cameraLinesMesh.scaling.y=1/this._rootMesh.scaling.y,this._cameraLinesMesh.scaling.z=1/this._rootMesh.scaling.z,this._cameraMesh.parent=null,this._cameraMesh.rotation.y=.5*Math.PI*(this._camera.getScene().useRightHandedSystem?1:-1),this._cameraMesh.parent=this._rootMesh)}setCustomMesh(e){if(e.getScene()!=this.gizmoLayer.utilityLayerScene)throw"When setting a custom mesh on a gizmo, the custom meshes scene must be the same as the gizmos (eg. gizmo.gizmoLayer.utilityLayerScene)";this._cameraMesh&&this._cameraMesh.dispose(),this._cameraMesh=e,this._cameraMesh.parent=this._rootMesh,this._customMeshSet=!0}dispose(){this.onClickedObservable.clear(),this.gizmoLayer.utilityLayerScene.onPointerObservable.remove(this._pointerObserver),this._cameraMesh&&this._cameraMesh.dispose(),this._cameraLinesMesh&&this._cameraLinesMesh.dispose(),this._material.dispose(),super.dispose()}static _CreateCameraMesh(e){let t=new rP.Kj("rootCameraGizmo",e),i=new rP.Kj(t.name,e);i.parent=t,(0,nX.NR)(t.name,{width:1,height:.8,depth:.5},e).parent=i;let r=(0,nz.wf)(t.name,{height:.5,diameterTop:.8,diameterBottom:.8},e);r.parent=i,r.position.y=.3,r.position.x=-.6,r.rotation.x=.5*Math.PI;let s=(0,nz.wf)(t.name,{height:.5,diameterTop:.6,diameterBottom:.6},e);s.parent=i,s.position.y=.5,s.position.x=.4,s.rotation.x=.5*Math.PI;let n=(0,nz.wf)(t.name,{height:.5,diameterTop:.5,diameterBottom:.5},e);return n.parent=i,n.position.y=0,n.position.x=.6,n.rotation.z=.5*Math.PI,t.scaling.scaleInPlace(o0._Scale),i.position.x=-.9,t}static _CreateCameraFrustum(e,t){let i=new rP.Kj("rootCameraGizmo",e),r=new rP.Kj(i.name,e);r.parent=i;for(let i=0;i<4;i+=2)for(let s=0;s<4;s+=2){let n=(0,nJ.nL)("lines",{points:[new i1.P(-1+s,-1+i,-1),new i1.P(-1+s,-1+i,1)],colors:[t,t]},e);n.parent=r,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1,(n=(0,nJ.nL)("lines",{points:[new i1.P(-1,-1+s,-1+i),new i1.P(1,-1+s,-1+i)],colors:[t,t]},e)).parent=r,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1,(n=(0,nJ.nL)("lines",{points:[new i1.P(-1+s,-1,-1+i),new i1.P(-1+s,1,-1+i)],colors:[t,t]},e)).parent=r,n.alwaysSelectAsActiveMesh=!0,n.isPickable=!1}return i}}o0._Scale=.05;var o1=i(76019),o2=i(23891);class o3 extends s2._{set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){let e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){let e=this.getScene();e&&(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}constructor(e,t,i,r,s=0,n=rZ.x.BILINEAR_SAMPLINGMODE,a=!0){let o;if(super(e,t,i,r,!0,s,!1,n,a),this.mirrorPlane=new nT.J(0,1,0,1),this._transformMatrix=i1.y3.Zero(),this._mirrorMatrix=i1.y3.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,!(i=this.getScene()))return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()});let l=i.getEngine();l.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add(()=>{l._debugPushGroup?.(`mirror generation for ${e}`,1)}),this.onAfterUnbindObservable.add(()=>{l._debugPopGroup?.(1)}),this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),i1.y3.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),o=i.clipPlane,i.clipPlane=this.mirrorPlane,i._mirroredCameraPosition=i1.P.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i._mirroredCameraPosition=null,i.clipPlane=o})}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){let e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new o2.i("horizontal blur",new i1.FM(1,0),this._blurKernelX,this._blurRatio,null,rZ.x.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,1===this._blurRatio&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new o2.i("vertical blur",new i1.FM(0,1),this._blurKernelY,this._blurRatio,null,rZ.x.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=1!==this._blurRatio,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){let e=this.getScene();if(!e)return this;let t=this.getSize(),i=new o3(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;let e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){super.dispose();let e=this.getScene();e&&e.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),this._sceneUBO?.dispose()}}rZ.x._CreateMirror=(e,t,i,r)=>new o3(e,t,i,r);class o4 extends o1.V{set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(i1.y3.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let r="";return e.forEach(e=>r+=e),new o4(r,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,r=!0){let s=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;let n=new o4(e,t,null,!1,null,null,null,void 0,!0,i,r);return t.useDelayedTextureLoading=s,n}constructor(e,t,i=null,r=!1,s=null,n=null,a=null,o=5,l=!1,c=null,u=!1,h=.8,d=0,f,p){super(t),this.onLoadObservable=new i0.y$,this.boundingBoxPosition=i1.P.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this._textureMatrixRefraction=new i1.y3,this._buffer=null,this.name=e,this.url=e,this._noMipmap=r,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=i1.y3.Identity(),this.coordinatesMode=rZ.x.CUBIC_MODE;let m=null,_=null;if(null===i||Array.isArray(i)?(this._noMipmap=r,this._format=o,this._createPolynomials=u,m=i,this._loaderOptions=f,this._useSRGBBuffer=p,this._lodScale=h,this._lodOffset=d):(m=i.extensions??null,this._noMipmap=i.noMipmap??!1,s=i.files??null,_=i.buffer??null,this._format=i.format??5,l=i.prefiltered??!1,c=i.forcedExtension??null,this._createPolynomials=i.createPolynomials??!1,this._lodScale=i.lodScale??.8,this._lodOffset=i.lodOffset??0,this._loaderOptions=i.loaderOptions,this._useSRGBBuffer=i.useSRGBBuffer,n=i.onLoad??null,a=i.onError??null),!e&&!s)return;this.updateURL(e,c,n,l,a,m,this.getScene()?.useDelayedTextureLoading,s,_)}getClassName(){return"CubeTexture"}updateURL(e,t=null,i=null,r=!1,s=null,n=null,a=!1,o=null,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);let c=e.lastIndexOf("."),u=t||(c>-1?e.substring(c).toLowerCase():""),h=0===u.indexOf(".dds"),d=0===u.indexOf(".env"),f=0===u.indexOf(".basis");if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=r,r&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),o)this._files=o;else if(f||d||h||n||(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let t=0;t<n.length;t++)this._files.push(e+n[t]);this._extensions=n}this._buffer=l,a?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=s):this._loadTexture(i,s)}delayLoad(e){4===this.delayLoadState&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){if(e.updateFlag===this._textureMatrix.updateFlag||(e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,e=>e.getActiveTextures().indexOf(this)!==-1),this._textureMatrix=e,!this.getScene()?.useRightHandedSystem))return;let t=i1.jp.Vector3[0],i=i1.jp.Quaternion[0],r=i1.jp.Vector3[1];this._textureMatrix.decompose(t,i,r),i.z*=-1,i.w*=-1,i1.y3.ComposeToRef(t,i,r,this._textureMatrixRefraction)}getRefractionTextureMatrix(){return this.getScene()?.useRightHandedSystem?this._textureMatrixRefraction:this._textureMatrix}_loadTexture(e=null,t=null){let i=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);let s=()=>{this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),this.getScene()?.markAllMaterialsAsDirty(1)),e&&e()},n=(e,i)=>{this._loadingError=!0,this._errorObject={message:e,exception:i},t&&t(e,i),rZ.x.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?rD.w1.SetImmediate(()=>s()):this._texture.onLoadedObservable.add(()=>s()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,i,this._lodScale,this._lodOffset,e,n,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,i,this._files,this._noMipmap,e,n,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer,this._buffer),this._texture?.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){let r=rq.p.Parse(()=>{let r=!1;return e.prefiltered&&(r=e.prefiltered),new o4(i+(e.url??e.name),t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(r.boundingBoxPosition=i1.P.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=i1.P.FromArray(e.boundingBoxSize)),e.animations)for(let t=0;t<e.animations.length;t++){let i=e.animations[t],s=(0,i3.qw)("BABYLON.Animation");s&&r.animations.push(s.Parse(i))}return r}clone(){let e=0,t=rq.p.Clone(()=>{let t=new o4(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=t.uniqueId,t},this);return t.uniqueId=e,t}}(0,r$.gn)([(0,rj.qC)()],o4.prototype,"url",void 0),(0,r$.gn)([(0,rj.hd)()],o4.prototype,"boundingBoxPosition",void 0),(0,r$.gn)([(0,rj.hd)()],o4.prototype,"boundingBoxSize",null),(0,r$.gn)([(0,rj.qC)("rotationY")],o4.prototype,"rotationY",null),(0,r$.gn)([(0,rj.qC)("files")],o4.prototype,"_files",void 0),(0,r$.gn)([(0,rj.qC)("forcedExtension")],o4.prototype,"_forcedExtension",void 0),(0,r$.gn)([(0,rj.qC)("extensions")],o4.prototype,"_extensions",void 0),(0,r$.gn)([(0,rj.oQ)("textureMatrix")],o4.prototype,"_textureMatrix",void 0),(0,r$.gn)([(0,rj.oQ)("textureMatrixRefraction")],o4.prototype,"_textureMatrixRefraction",void 0),rZ.x._CubeTextureParser=o4.Parse,(0,i3.H7)("BABYLON.CubeTexture",o4);var o5=i(16188),o7=i(31786),o6=i(50953),o8=i(34634),o9=i(49449),le=i(3609);class lt extends o5.H{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.PROJECTED_GROUND=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class li extends o7.a{get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t*=2,this.reflectionReflectance0=li.StandardReflectance0*t,this.reflectionReflectance90=li.StandardReflectance90*t):(t=2*t-1,this.reflectionReflectance0=li.StandardReflectance0+(1-li.StandardReflectance0)*t,this.reflectionReflectance90=li.StandardReflectance90+(1-li.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}constructor(e,t,i=!1){super(e,t),this.primaryColor=i2.Wo.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=i1.P.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._enableGroundProjection=!1,this.enableGroundProjection=!1,this.projectedGroundRadius=1e3,this.projectedGroundHeight=10,this._renderTargets=new nV.t(16),this._reflectionControls=i1.Lt.Zero(),this._white=i2.Wo.White(),this._primaryShadowColor=i2.Wo.Black(),this._primaryHighlightColor=i2.Wo.Black(),this._shadersLoaded=!1;let r=this.getScene().getEngine();r.isWebGPU&&!i&&(this._uniformBuffer&&this._uniformBuffer.dispose(),this._uniformBuffer=new s1.M(r,void 0,void 0,this.name,!0),this._shaderLanguage=1),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get hasRenderTargetTextures(){return!!this._diffuseTexture&&!!this._diffuseTexture.isRenderTarget||!!this._reflectionTexture&&!!this._reflectionTexture.isRenderTarget}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||null!=this._diffuseTexture&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,r=!1){let s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===r)return!0;t.materialDefines||(t.materialDefines=new lt);let n=this.getScene(),a=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let o=n.getEngine();if((0,le.UX)(n,e,a,!1,this._maxSimultaneousLights),a._needNormals=!0,(0,le.Z7)(n,a),a._areTexturesDirty){if(a._needUVs=!1,n.texturesEnabled){if(n.getEngine().getCaps().textureLOD&&(a.TEXTURELODSUPPORT=!0),this._diffuseTexture&&o6.k.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;(0,le.lw)(this._diffuseTexture,a,"DIFFUSE"),a.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,a.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,a.OPACITYFRESNEL=this._opacityFresnel}else a.DIFFUSE=!1,a.DIFFUSEDIRECTUV=0,a.DIFFUSEHASALPHA=!1,a.GAMMADIFFUSE=!1,a.OPACITYFRESNEL=!1;let e=this._reflectionTexture;if(e&&o6.k.ReflectionTextureEnabled){if(!e.isReadyOrNotBlocking())return!1;switch(a.REFLECTION=!0,a.GAMMAREFLECTION=e.gammaSpace,a.RGBDREFLECTION=e.isRGBD,a.REFLECTIONBLUR=this._reflectionBlur>0,a.LODINREFLECTIONALPHA=e.lodLevelInAlpha,a.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,a.REFLECTIONBGR=this.switchToBGR,e.coordinatesMode===rZ.x.INVCUBIC_MODE&&(a.INVERTCUBICMAP=!0),a.REFLECTIONMAP_3D=e.isCube,a.REFLECTIONMAP_OPPOSITEZ=a.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!e.invertZ:e.invertZ,e.coordinatesMode){case rZ.x.EXPLICIT_MODE:a.REFLECTIONMAP_EXPLICIT=!0;break;case rZ.x.PLANAR_MODE:a.REFLECTIONMAP_PLANAR=!0;break;case rZ.x.PROJECTION_MODE:a.REFLECTIONMAP_PROJECTION=!0;break;case rZ.x.SKYBOX_MODE:a.REFLECTIONMAP_SKYBOX=!0;break;case rZ.x.SPHERICAL_MODE:a.REFLECTIONMAP_SPHERICAL=!0;break;case rZ.x.EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case rZ.x.FIXED_EQUIRECTANGULAR_MODE:a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case rZ.x.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case rZ.x.CUBIC_MODE:case rZ.x.INVCUBIC_MODE:default:a.REFLECTIONMAP_CUBIC=!0}this.reflectionFresnel?(a.REFLECTIONFRESNEL=!0,a.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1)}else a.REFLECTION=!1,a.REFLECTIONFRESNEL=!1,a.REFLECTIONFALLOFF=!1,a.REFLECTIONBLUR=!1,a.REFLECTIONMAP_3D=!1,a.REFLECTIONMAP_SPHERICAL=!1,a.REFLECTIONMAP_PLANAR=!1,a.REFLECTIONMAP_CUBIC=!1,a.REFLECTIONMAP_PROJECTION=!1,a.REFLECTIONMAP_SKYBOX=!1,a.REFLECTIONMAP_EXPLICIT=!1,a.REFLECTIONMAP_EQUIRECTANGULAR=!1,a.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,a.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,a.INVERTCUBICMAP=!1,a.REFLECTIONMAP_OPPOSITEZ=!1,a.LODINREFLECTIONALPHA=!1,a.GAMMAREFLECTION=!1,a.RGBDREFLECTION=!1}a.PREMULTIPLYALPHA=7===this.alphaMode||8===this.alphaMode,a.USERGBCOLOR=this._useRGBColor,a.NOISE=this._enableNoise}if(a._areLightsDirty&&(a.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel),a.BACKMAT_SHADOWONLY=this._shadowOnly),a._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(a)}if(a._areMiscDirty&&(a.REFLECTIONMAP_3D&&this._enableGroundProjection?(a.PROJECTED_GROUND=!0,a.REFLECTIONMAP_SKYBOX=!0):a.PROJECTED_GROUND=!1),(0,le.BV)(e,n,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),a),(0,le.vG)(n,o,this,a,r,null,t.getRenderingMesh().hasThinInstances),(0,le.wJ)(e,a,!1,!0,!1)&&e&&!n.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(st.o.NormalKind)&&(e.createNormals(!0),re.Y.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),a.isDirty){a.markAsProcessed(),n.resetCachedMaterial();let r=new o8.L;a.FOG&&r.addFallback(0,"FOG"),a.POINTSIZE&&r.addFallback(1,"POINTSIZE"),a.MULTIVIEW&&r.addFallback(0,"MULTIVIEW"),(0,le.Lh)(a,r,this._maxSimultaneousLights);let s=[st.o.PositionKind];a.NORMAL&&s.push(st.o.NormalKind),a.UV1&&s.push(st.o.UVKind),a.UV2&&s.push(st.o.UV2Kind),(0,le.TD)(s,e,a,r),(0,le.od)(s,a);let l=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix","projectedGroundInfos","logarithmicDepthConstant"];(0,o9.qx)(l);let c=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],u=["Material","Scene"];ns.$&&(ns.$.PrepareUniforms(l,a),ns.$.PrepareSamplers(c,a)),(0,le.DI)({uniformsNames:l,uniformBuffersNames:u,samplers:c,defines:a,maxSimultaneousLights:this._maxSimultaneousLights});let h=a.toString(),d=n.getEngine().createEffect("background",{attributes:s,uniformsNames:l,uniformBuffersNames:u,samplers:c,defines:h,fallbacks:r,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:this._shadersLoaded?void 0:async()=>{1===this.shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,95538)),Promise.resolve().then(i.bind(i,50131))]):await Promise.all([Promise.resolve().then(i.bind(i,37506)),Promise.resolve().then(i.bind(i,93028))]),this._shadersLoaded=!0}},o);t.setEffect(d,a,this._materialContext),this.buildUniformLayout()}return!!(t.effect&&t.effect.isReady())&&(a._renderId=n.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=r,this._checkScenePerformancePriority(),!0)}_computePrimaryColorFromPerceptualColor(){this.__perceptualColor&&(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor,this.getScene().getEngine().useExactSrgbConversions),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){(0!==this._primaryColorShadowLevel||0!==this._primaryColorHighlightLevel)&&(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.addUniform("projectedGroundInfos",2),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.materialDefines;if(!s)return;let n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),(0,le.qx)(t,this._activeEffect);let a=this._mustRebind(r,n,i,t.visibility);if(a){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);let e=this._reflectionTexture;this._uniformBuffer.useUbo&&this.isFrozen&&this._uniformBuffer.isSync&&!i._drawWrapper._forceRebindOnNextCall||(r.texturesEnabled&&(this._diffuseTexture&&o6.k.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),(0,le.NL)(this._diffuseTexture,this._uniformBuffer,"diffuse")),e&&o6.k.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",e.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",e.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",e.getSize().width,e.lodGenerationScale,e.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),s.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),r.texturesEnabled&&(this._diffuseTexture&&o6.k.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),e&&o6.k.ReflectionTextureEnabled&&(s.REFLECTIONBLUR&&s.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",e):s.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",e._lodTextureMid||e),this._uniformBuffer.setTexture("reflectionSamplerLow",e._lodTextureLow||e),this._uniformBuffer.setTexture("reflectionSamplerHigh",e._lodTextureHigh||e)):this._uniformBuffer.setTexture("reflectionSampler",e),s.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w))),s.PROJECTED_GROUND&&this._uniformBuffer.updateFloat2("projectedGroundInfos",this.projectedGroundRadius,this.projectedGroundHeight)),(0,o9.an)(this._activeEffect,this,r),r.bindEyePosition(n)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);(a||!this.isFrozen)&&(r.lightsEnabled&&(0,le.VX)(r,t,this._activeEffect,s,this._maxSimultaneousLights),this.bindView(n),(0,le.D1)(r,t,this._activeEffect,!0),this._useLogarithmicDepth&&(0,le.gz)(s,n,r),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect,i),this._uniformBuffer.update()}hasTexture(e){return!!super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return rq.p.Clone(()=>new li(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return rq.p.Parse(()=>new li(e.name,t),e,t,i)}}li.StandardReflectance0=.05,li.StandardReflectance90=.5,(0,r$.gn)([(0,rj.n9)()],li.prototype,"_primaryColor",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsLightsDirty")],li.prototype,"primaryColor",void 0),(0,r$.gn)([(0,rj.n9)()],li.prototype,"__perceptualColor",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_primaryColorShadowLevel",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_primaryColorHighlightLevel",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsLightsDirty")],li.prototype,"primaryColorHighlightLevel",null),(0,r$.gn)([(0,rj.oU)()],li.prototype,"_reflectionTexture",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"reflectionTexture",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_reflectionBlur",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"reflectionBlur",void 0),(0,r$.gn)([(0,rj.oU)()],li.prototype,"_diffuseTexture",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"diffuseTexture",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"shadowLights",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_shadowLevel",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"shadowLevel",void 0),(0,r$.gn)([(0,rj.hd)()],li.prototype,"_sceneCenter",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"sceneCenter",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_opacityFresnel",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"opacityFresnel",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_reflectionFresnel",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"reflectionFresnel",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_reflectionFalloffDistance",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"reflectionFalloffDistance",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_reflectionAmount",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"reflectionAmount",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_reflectionReflectance0",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"reflectionReflectance0",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_reflectionReflectance90",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"reflectionReflectance90",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_useRGBColor",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"useRGBColor",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_enableNoise",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"enableNoise",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_maxSimultaneousLights",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],li.prototype,"maxSimultaneousLights",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"_shadowOnly",void 0),(0,r$.gn)([(0,rj.wz)("_markAllSubMeshesAsLightsDirty")],li.prototype,"shadowOnly",void 0),(0,r$.gn)([(0,rj.rX)()],li.prototype,"_imageProcessingConfiguration",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsMiscDirty")],li.prototype,"enableGroundProjection",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"projectedGroundRadius",void 0),(0,r$.gn)([(0,rj.qC)()],li.prototype,"projectedGroundHeight",void 0),(0,i3.H7)("BABYLON.BackgroundMaterial",li);class lr{static _GetDefaultOptions(e){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new i2.Wo(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new i2.Wo(.2,.2,.3).toLinearSpace(e.getEngine().useExactSrgbConversions).scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:i1.P.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}constructor(e,t){this._errorHandler=(e,t)=>{this.onErrorObservable.notifyObservers({message:e,exception:t})},this._options={...lr._GetDefaultOptions(t),...e},this._scene=t,this.onErrorObservable=new i0.y$,this._setupBackground(),this._setupImageProcessing()}updateOptions(e){let t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new i2.HE(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof o1.V){this._scene.environmentTexture=this._options.environmentTexture;return}let e=o4.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new rP.Kj("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;let e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||1===this._scene.meshes.length)return{groundSize:e,skyboxSize:t,rootPosition:i};let r=this._scene.getWorldExtends(e=>e!==this._ground&&e!==this._rootMesh&&e!==this._skybox),s=r.max.subtract(r.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof sT&&this._scene.activeCamera.upperRadiusLimit&&(t=e=2*this._scene.activeCamera.upperRadiusLimit);let n=s.length();n>e&&(t=e=2*n),e*=1.1,t*=1.5,(i=r.min.add(s.scale(.5))).y=r.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){(!this._ground||this._ground.isDisposed())&&(this._ground=(0,oY.pT)("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.isPickable=!1,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new li("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof o1.V){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new rZ.x(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(e){let t=rZ.x.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new o3("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,rZ.x.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new nT.J(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let e=0;e<this._scene.meshes.length;e++){let t=this._scene.meshes[e];t!==this._ground&&t!==this._skybox&&t!==this._rootMesh&&this._groundMirror.renderList.push(t)}let i=this._options.groundColor.toGammaSpace(this._scene.getEngine().useExactSrgbConversions);this._groundMirror.clearColor=new i2.HE(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=(0,nX.NR)("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:rP.Kj.BACKSIDE},this._scene),this._skybox.isPickable=!1,this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){this._skybox&&(this._skyboxMaterial||(this._skyboxMaterial=new li("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof o1.V){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new o4(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=rZ.x.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}lr._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png",lr._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds",lr._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env";class ls extends rR.Y{get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._texture.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=rZ.x.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}constructor(e,t,i,r,s=null){super(e,r),this.onError=s,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=ls.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new i0.y$,this.onLoadObservable=new i0.y$,r=this.getScene(),e=e||"textureDome",i.resolution=0|Math.abs(i.resolution)||32,i.clickToPlay=!!i.clickToPlay,i.autoPlay=void 0===i.autoPlay||!!i.autoPlay,i.loop=void 0===i.loop||!!i.loop,i.size=Math.abs(i.size)||(r.activeCamera?.48*r.activeCamera.maxZ:1e3),void 0===i.useDirectMapping?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,void 0===i.faceForward&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=(0,n$.Qk)(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:rP.Kj.BACKSIDE},r);let n=this._material=new li(e+"_material",r);n.useEquirectangularFOV=!0,n.fovMultiplier=1,n.opacityFresnel=!1;let a=this._initTexture(t,r,i);if(this.texture=a,this._mesh.material=n,this._mesh.parent=this,this._halfDomeMask=(0,n$.Qk)("",{slice:.5,diameter:.98*i.size,segments:2*i.resolution,sideOrientation:rP.Kj.BACKSIDE},r),this._halfDomeMask.rotate(aN.RD.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce(()=>{this._setReady(!0)}),i.faceForward&&r.activeCamera){let e=r.activeCamera,t=i1.P.Forward(),i=i1.P.TransformNormal(t,e.getViewMatrix());i.normalize(),this.rotation.y=Math.acos(i1.P.Dot(t,i))}this._changeTextureMode(this._textureMode)}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case ls.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case ls.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;let e=this._halfDome?0:.5,t=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(i=>{let r=i.isRightCamera;this._crossEye&&(r=!r),r?this._texture.uOffset=e:this._texture.uOffset=t});break}case ls.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(e=>{let t=e.isRightCamera;this._crossEye&&(t=!t),this._texture.vOffset=t?.5:0})}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}ls.MODE_MONOSCOPIC=0,ls.MODE_TOPBOTTOM=1,ls.MODE_SIDEBYSIDE=2;class ln extends ls{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new rZ.x(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,()=>{this.onLoadObservable.notifyObservers()},(e,t)=>{this.onLoadErrorObservable.notifyObservers(e||"Unknown error occured"),this.onError&&this.onError(e,t)})}}ln.MODE_MONOSCOPIC=ls.MODE_MONOSCOPIC,ln.MODE_TOPBOTTOM=ls.MODE_TOPBOTTOM,ln.MODE_SIDEBYSIDE=ls.MODE_SIDEBYSIDE;var la=i(49950);i(18570),i(6395),i(13751);class lo extends sE.c{constructor(e,t,i){super(e,i1.P.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=i1._f.Identity(),this._referencedPosition=new i1.P,this._trackingState=0,this.onXRCameraInitializedObservable=new i0.y$,this.onBeforeCameraTeleport=new i0.y$,this.onAfterCameraTeleport=new i0.y$,this.onTrackingStateChanged=new i0.y$,this.compensateOnFirstFrame=!0,this._rotate180=new i1._f(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new i1._f,this.cameraRigMode=rO.V.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._deferOnly=!0,this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame,this._xrSessionManager.onWorldScaleFactorChangedObservable.add(()=>{this._xrSessionManager.currentFrame&&this._updateDepthNearFar()})}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this.onXRCameraInitializedObservable.hasObservers()&&(this.onXRCameraInitializedObservable.notifyObservers(this),this.onXRCameraInitializedObservable.clear()),this._deferredUpdated&&(this.position.copyFrom(this._deferredPositionUpdate),this.rotationQuaternion.copyFrom(this._deferredRotationQuaternionUpdate)),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y*this._xrSessionManager.worldScalingFactor:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new sk.l(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new sk.l(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){e&&e!==this&&(e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,i1._f.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace())}getClassName(){return"WebXRCamera"}setTarget(e){let t=i1.jp.Vector3[1];e.subtractToRef(this.position,t),t.y=0,t.normalize();let i=Math.atan2(t.x,t.z);this.rotationQuaternion.toEulerAnglesToRef(t),i1._f.FromEulerAnglesToRef(t.x,i,t.z,this.rotationQuaternion)}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateDepthNearFar(){let e=(this.maxZ||1e4)*this._xrSessionManager.worldScalingFactor,t={depthFar:e,depthNear:this.minZ};this._xrSessionManager.updateRenderState(t),this._cache.minZ=this.minZ,this._cache.maxZ=e}_updateFromXRSession(){let e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(0);return}let t=e.emulatedPosition?1:2;if(this._setTrackingState(t),(this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ)&&this._updateDepthNearFar(),e.transform){let t=e.transform.orientation;if(void 0===e.transform.orientation.x)return;let i=e.transform.position;this._referencedPosition.set(i.x,i.y,i.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._referenceQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach((e,t)=>{let i=this.rigCameras[t];i.isLeftCamera||i.isRightCamera||("right"===e.eye?i._isRightCamera=!0:"left"!==e.eye||(i._isLeftCamera=!0));let r=this.getScene().customRenderTargets;for(let e=0;e<r.length;e++){let t=r[e];-1===i.customRenderTargets.indexOf(t)&&i.customRenderTargets.push(t)}let s=e.transform.position,n=e.transform.orientation;i.parent=this.parent,i.position.set(s.x,s.y,s.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),i.rotationQuaternion.set(n.x,n.y,n.z,n.w),this._scene.useRightHandedSystem?i.rotationQuaternion.multiplyInPlace(this._rotate180):(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1),i1.y3.FromFloat32ArrayToRefScaled(e.projectionMatrix,0,1,i._projectionMatrix),this._scene.useRightHandedSystem||i._projectionMatrix.toggleProjectionMatrixHandInPlace();let a=2*Math.atan2(1,e.projectionMatrix[5]);i.fov=a,0===t&&(this.fov=a,this._projectionMatrix.copyFrom(i._projectionMatrix));let o=this._xrSessionManager.getRenderTargetTextureForView(e);this._renderingMultiview=o?._texture?.isMultiview||!1,this._renderingMultiview?0==t&&(this._xrSessionManager.trySetViewportForView(this.viewport,e),this.outputRenderTarget=o):(this._xrSessionManager.trySetViewportForView(i.viewport,e),i.outputRenderTarget=o||this._xrSessionManager.getRenderTargetTextureForView(e)),i.layerMask=this.layerMask})}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){let e=new sx.C("XR-RigCamera: "+this.rigCameras.length,i1.P.Zero(),this.getScene());e.minZ=.1,e.rotationQuaternion=new i1._f,e.updateUpVectorFromRotation=!0,e.isRigCamera=!0,e.rigParent=this,e.freezeProjectionMatrix(),this.rigCameras.push(e)}for(;this.rigCameras.length>e;){let e=this.rigCameras.pop();e&&e.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){let e=i1.jp.Matrix[0],t=i1.jp.Matrix[1],i=i1.jp.Matrix[2];i1.y3.ComposeToRef(lo._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),i1.y3.ComposeToRef(lo._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);let r=new XRRigidTransform({x:this._referencedPosition.x/this._xrSessionManager.worldScalingFactor,y:this._referencedPosition.y/this._xrSessionManager.worldScalingFactor,z:this._referencedPosition.z/this._xrSessionManager.worldScalingFactor},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(r)}}}lo._ScaleReadOnly=i1.P.One();var ll=i(34362);class lc{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new i0.y$,this.onStateChangedObservable=new i0.y$,this.state=3,this.sessionManager=new ng(e),this.camera=new lo("webxr",e,this.sessionManager),this.featuresManager=new ll.d(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){let t=new lc(e);return t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(e=>{throw t._setState(3),t.dispose(),e})}dispose(){this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),this._spectatorCamera?.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),r={}){if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(0),"viewer"!==t&&"local"!==t&&(r.optionalFeatures=r.optionalFeatures||[],r.optionalFeatures.push(t)),r=await this.featuresManager._extendXRSessionInitObject(r),"immersive-ar"===e&&"unbounded"!==t&&re.Y.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,r),await this.sessionManager.setReferenceSpaceTypeAsync(t);let s={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};if(!this.featuresManager.getEnabledFeature(ll.b.LAYERS)){let e=await i.initializeXRLayerAsync(this.sessionManager.session);s.baseLayer=e}return this.sessionManager.updateRenderState(s),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!this._nonVRCamera?.inputs?.attachedToElement,this._nonVRCamera?.detachControl(),this._scene.activeCamera=this.camera,"immersive-ar"!==e?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)),rV.a.audioEngine?._resumeAudioContextOnStateChange(),this.sessionManager.onXRSessionEnded.addOnce(()=>{1!==this.state&&this._setState(1),this.camera.rigCameras.forEach(e=>{e.outputRenderTarget=null}),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),"immersive-ar"!==e&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(3)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(2)}),this.sessionManager}catch(e){throw re.Y.Log(e),re.Y.Log(e.message),this._setState(3),e}}exitXRAsync(){return 2!==this.state?Promise.resolve():(this._setState(1),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){let t=1/(e?.fps?e.fps:1e3)*1e3,i=e?.preferredCameraIndex?e?.preferredCameraIndex:0,r=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=t&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[i].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[i].absoluteRotation))};if(this._spectatorMode){if(i>=this.camera.rigCameras.length)throw Error("the preferred camera index is beyond the length of rig camera array.");let e=()=>{2===this.state?(this._spectatorCamera=new sM.x("webxr-spectator",i1.P.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new i1._f,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(r),this._scene.onAfterRenderCameraObservable.add(e=>{e===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):1===this.state&&(this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=null)};this.onStateChangedObservable.add(e),e()}else this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class lu{constructor(e,t,i=-1,r=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=r,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new i0.y$,this.onButtonStateChangedObservable=new i0.y$}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return 0!==this._axesIndices.length}isButton(){return -1!==this._buttonIndex}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){let i=e.buttons[this._buttonIndex];if(!i)return;this._currentValue!==i.value&&(this.changes.value={current:i.value,previous:this._currentValue},t=!0,this._currentValue=i.value),this._touched!==i.touched&&(this.changes.touched={current:i.touched,previous:this._touched},t=!0,this._touched=i.touched),this._pressed!==i.pressed&&(this.changes.pressed={current:i.pressed,previous:this._pressed},t=!0,this._pressed=i.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}lu.BUTTON_TYPE="button",lu.SQUEEZE_TYPE="squeeze",lu.THUMBSTICK_TYPE="thumbstick",lu.TOUCHPAD_TYPE="touchpad",lu.TRIGGER_TYPE="trigger";var lh=i(89259);class ld{constructor(e,t,i,r,s=!1,n){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=r,this._doNotLoadControllerMesh=s,this._controllerCache=n,this._initComponent=e=>{if(!e)return;let t=this.layout.components[e],i=t.type,r=t.gamepadIndices.button,s=[];void 0!==t.gamepadIndices.xAxis&&void 0!==t.gamepadIndices.yAxis&&s.push(t.gamepadIndices.xAxis,t.gamepadIndices.yAxis),this.components[e]=new lu(e,i,r,s)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new i0.y$,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach(e=>this.getComponent(e).dispose()),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(e=>{e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map(e=>this.components[e]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){let e=!this._getModelLoadingConstraints(),t=this._getGenericFilenameAndPath();return e?re.Y.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise((i,r)=>{let s=t=>{e?this._getGenericParentMesh(t):this._setRootMesh(t),this._processLoadedModel(t),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){let e=this._controllerCache.filter(e=>e.filename===t.filename&&e.path===t.path);if(e[0]){e[0].meshes.forEach(e=>e.setEnabled(!0)),s(e[0].meshes);return}}lh.n0.ImportMesh("",t.path,t.filename,this.scene,e=>{this._controllerCache&&this._controllerCache.push({...t,meshes:e}),s(e)},null,(e,i)=>{re.Y.Log(i),re.Y.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),r(i)})})}updateFromXRFrame(e){this.getComponentIds().forEach(e=>this.getComponent(e).update(this.gamepadObject)),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren(e=>e.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(e=>e.name==t,!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;let r=i?.5*t+.5:t;i1._f.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,r,e.valueMesh.rotationQuaternion),i1.P.LerpToRef(e.minMesh.position,e.maxMesh.position,r,e.valueMesh.position)}updateModel(e){this._modelReady&&this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new rP.Kj(this.profileId+" "+this.handedness,this.scene),e.forEach(e=>{e.parent||(e.isPickable=!1,e.setParent(this.rootMesh))}),this.rootMesh.rotationQuaternion=i1._f.FromEulerAngles(0,Math.PI,0)}}class lf extends ld{constructor(e,t,i){super(e,lp[i],t,i),this.profileId=lf.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new rP.Kj(this.profileId+" "+this.handedness,this.scene),e.forEach(e=>{e.isPickable=!1,e.parent||e.setParent(this.rootMesh)}),this.rootMesh.rotationQuaternion=i1._f.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}lf.ProfileId="generic-trigger";let lp={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class lm extends ld{constructor(e,t,i,r,s){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,s),this._repositoryUrl=r,this.controllerCache=s,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach(e=>{this._touchDots[e].dispose()})}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){let e=lh.n0.IsPluginForExtensionAvailable(".glb");return e||re.Y.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach(e=>{let t=this.layout.components[e];this._buttonMeshMapping[e]={mainMesh:this._getChildByName(this.rootMesh,t.rootNodeName),states:{}},Object.keys(t.visualResponses).forEach(i=>{let r=t.visualResponses[i];if("transform"===r.valueNodeProperty)this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,r.valueNodeName),minMesh:this._getChildByName(this.rootMesh,r.minNodeName),maxMesh:this._getChildByName(this.rootMesh,r.maxNodeName)};else{let s=t.type===lu.TOUCHPAD_TYPE&&t.touchPointNodeName?t.touchPointNodeName:r.valueNodeName;if(this._buttonMeshMapping[e].states[i]={valueMesh:this._getChildByName(this.rootMesh,s)},t.type===lu.TOUCHPAD_TYPE&&!this._touchDots[i]){let t=(0,n$.Qk)(i+"dot",{diameter:.0015,segments:8},this.scene);t.material=new nn.K(i+"mat",this.scene),t.material.diffuseColor=i2.Wo.Red(),t.parent=this._buttonMeshMapping[e].states[i].valueMesh||null,t.isVisible=!1,this._touchDots[i]=t}}})})}_setRootMesh(e){let t;this.rootMesh=new rP.Kj(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){let r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(r9.RD.Y,Math.PI,1)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach(e=>{let t=this.getComponent(e);if(!t.hasChanges)return;let i=this._buttonMeshMapping[e],r=this.layout.components[e];Object.keys(r.visualResponses).forEach(e=>{let s=r.visualResponses[e],n=t.value;if("xAxis"===s.componentProperty?n=t.axes.x:"yAxis"===s.componentProperty&&(n=t.axes.y),"transform"===s.valueNodeProperty)this._lerpTransform(i.states[e],n,"button"!==s.componentProperty);else{let r=i.states[e].valueMesh;r&&(r.isVisible=t.touched||t.pressed),this._touchDots[e]&&(this._touchDots[e].isVisible=t.touched||t.pressed)}})})}}let l_=[];class lg{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){let t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){let r=[];i&&r.push(i),r.push(...e.profiles||[]),r.length&&!r[0]&&r.pop(),e.gamepad&&e.gamepad.id&&e.gamepad.id===(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0)&&r.push("oculus-touch-v2");let s=r.indexOf("windows-mixed-reality");if(-1!==s&&r.splice(s,0,"microsoft-mixed-reality"),r.length||r.push("generic-trigger"),!this.UseOnlineRepository)return this._LoadProfilesFromAvailableControllers(r,e,t);{let i=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,s=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return i.call(this,r,e,t).catch(()=>s.call(this,r,e,t))}}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=rD.w1.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(e=>JSON.parse(e)),this._ProfilesList}static ClearControllerCache(){l_.forEach(e=>{e.meshes.forEach(e=>{e.dispose(!1,!0)})}),l_.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then(()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList()).then(t=>{for(let i=0;i<e.length;++i)if(e[i]&&t[e[i]])return e[i];throw Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)}).then(e=>(this._ProfileLoadingPromises[e]||(this._ProfileLoadingPromises[e]=rD.w1.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${e}/profile.json`,!1).then(e=>JSON.parse(e))),this._ProfileLoadingPromises[e])).then(e=>new lm(i,t,e,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:l_))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let r=0;r<e.length;++r){if(!e[r])continue;let s=this.FindFallbackWithProfileId(e[r]);for(let e=0;e<s.length;++e){let r=this._AvailableControllers[s[e]];if(r)return Promise.resolve(r(t,i))}}throw Error("no controller requested was found in the available controllers list")}}lg._AvailableControllers={},lg._Fallbacks={},lg._ProfileLoadingPromises={},lg.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist",lg.PrioritizeOnlineRepository=!0,lg.UseOnlineRepository=!0,lg.DisableControllerCache=!0,lg.RegisterController(lf.ProfileId,(e,t)=>new lf(t,e.gamepad,e.handedness)),lg.DefaultFallbacks();let lv=0;class lS{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new i1.P,this._disposed=!1,this.onDisposeObservable=new i0.y$,this.onMeshLoadedObservable=new i0.y$,this.onMotionControllerInitObservable=new i0.y$,this._uniqueId=`controller-${lv++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new rP.Kj(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new i1._f,this.inputSource.gripSpace&&(this.grip=new rP.Kj(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new i1._f),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&"tracked-pointer"===this.inputSource.targetRayMode&&lg.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(e=>{this.motionController=e,this.onMotionControllerInitObservable.notifyObservers(e),this._options.doNotLoadControllerMesh||this.motionController._doNotLoadControllerMesh||this.motionController.loadModel().then(e=>{e&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach(e=>e.renderingGroupId=this._options.renderingGroupId)),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&this.motionController?.dispose()})},()=>{rD.w1.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){let i=t&&this.grip?this.grip:this.pointer;i1.P.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i,r){let s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){let e=s.transform.position;this.pointer.position.set(e.x,e.y,e.z).scaleInPlace(r.worldScalingFactor);let t=s.transform.orientation;this.pointer.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent,this.pointer.scaling.setAll(r.worldScalingFactor)}if(this.inputSource.gripSpace&&this.grip){let s=e.getPose(this.inputSource.gripSpace,t);if(s){let e=s.transform.position,t=s.transform.orientation;this.grip.position.set(e.x,e.y,e.z).scaleInPlace(r.worldScalingFactor),this.grip.rotationQuaternion.set(t.x,t.y,t.z,t.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent,this.grip.scaling.setAll(r.worldScalingFactor)}this.motionController&&this.motionController.updateFromXRFrame(e)}}class lx{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new i0.y$,this.onControllerRemovedObservable=new i0.y$,this._onInputSourcesChange=e=>{this._addAndRemoveControllers(e.added,e.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(e=>e.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(e=>{e.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(e=>{this.controllers.forEach(t=>{t.updateFromXRFrame(e,this.xrSessionManager.referenceSpace,this.xrCamera,this.xrSessionManager)})}),this._options.customControllersRepositoryURL&&(lg.BaseRepositoryUrl=this._options.customControllersRepositoryURL),lg.UseOnlineRepository=!this._options.disableOnlineControllerRepository,lg.UseOnlineRepository)try{lg.UpdateProfilesList().catch(()=>{lg.UseOnlineRepository=!1})}catch(e){lg.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){let i=this.controllers.map(e=>e.inputSource);for(let t of e)if(-1===i.indexOf(t)){let e=new lS(this.xrSessionManager.scene,t,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(e),this.onControllerAddedObservable.notifyObservers(e)}let r=[],s=[];this.controllers.forEach(e=>{-1===t.indexOf(e.inputSource)?r.push(e):s.push(e)}),this.controllers=r,s.forEach(e=>{this.onControllerRemovedObservable.notifyObservers(e),e.dispose()})}dispose(){this.controllers.forEach(e=>{e.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),lg.ClearControllerCache()}}class lE{get xrNativeFeatureName(){return this._xrNativeFeatureName}set xrNativeFeatureName(e){!this._xrSessionManager.isNative&&e&&this._xrSessionManager.inXRSession&&this._xrSessionManager.enabledFeatures?.indexOf(e)===-1&&re.Y.Warn(`The feature ${e} needs to be enabled before starting the XR session. Note - It is still possible it is not supported.`),this._xrNativeFeatureName=e}constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this._xrNativeFeatureName="",this.onFeatureAttachObservable=new i0.y$,this.onFeatureDetachObservable=new i0.y$}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;if(this._xrSessionManager.enabledFeatures){if(!this._xrSessionManager.isNative&&this.xrNativeFeatureName&&-1===this._xrSessionManager.enabledFeatures.indexOf(this.xrNativeFeatureName))return!1}else re.Y.Warn("session.enabledFeatures is not available on this device. It is possible that this feature is not supported.");return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,e=>this._onXRFrame(e)),this.onFeatureAttachObservable.notifyObservers(this),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),this.onFeatureDetachObservable.notifyObservers(this),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0,this.onFeatureAttachObservable.clear(),this.onFeatureDetachObservable.clear()}isCompatible(){return!0}_addNewAttachObserver(e,t,i){this._removeOnDetach.push({observable:e,observer:e.add(t,void 0,i)})}}class lC extends lE{constructor(e,t){super(e),this._options=t,this._attachController=e=>{if(this._controllers[e.uniqueId])return;let{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(this._options.forceGripIfAvailable&&e.grip?e.grip:e.pointer);switch(this._controllers[e.uniqueId]={xrController:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new nr.zH(new i1.P,new i1.P),disabledByNearInteraction:!1,id:lC._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(e);case"gaze":return this._attachGazeMode(e);case"screen":case"transient-pointer":return this._attachScreenRayMode(e)}},this._controllers={},this._tmpVectorForPickCompare=new i1.P,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new i2.Wo(.9,.9,.9),this.laserPointerDefaultColor=new i2.Wo(.7,.7,.7),this.selectionMeshDefaultColor=new i2.Wo(.8,.8,.8),this.selectionMeshPickedColor=new i2.Wo(.3,.3,1),this._identityMatrix=i1.y3.Identity(),this._screenCoordinatesRef=i1.P.Zero(),this._viewportRef=new sk.l(0,0,0,0),this._scene=this._xrSessionManager.scene,void 0===this._options.lookAndPickMode&&(this._scene.getEngine()._badDesktopOS||this._scene.getEngine()._badOS)&&(this._options.lookAndPickMode=!0),this._options.lookAndPickMode&&(this._options.enablePointerSelectionOnAllControllers=!0,this.displayLaserPointer=!1)}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController,!0),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)},!0),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){let e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new nr.zH(new i1.P,new i1.P),disabledByNearInteraction:!1,id:lC._IdCounter++},this._attachGazeMode()}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){let i=Object.keys(this._controllers);for(let r=0;r<i.length;++r)if(this._controllers[i[r]].id===e){this._controllers[i[r]].disabledByNearInteraction=t;return}}_onXRFrame(e){Object.keys(this._controllers).forEach(e=>{let t;let i=this._controllers[e];if(this._options.lookAndPickMode&&i.xrController?.inputSource.targetRayMode!=="transient-pointer")return;if(!this._options.enablePointerSelectionOnAllControllers&&e!==this._attachedController||i.disabledByNearInteraction){i.selectionMesh.isVisible=!1,i.laserPointer.isVisible=!1,i.pick=null;return}if(i.laserPointer.isVisible=this.displayLaserPointer,i.xrController)t=this._options.forceGripIfAvailable&&i.xrController.grip?i.xrController.grip.position:i.xrController.pointer.position,i.xrController.getWorldPointerRayToRef(i.tmpRay,this._options.forceGripIfAvailable);else{if(!i.webXRCamera)return;t=i.webXRCamera.position,i.webXRCamera.getForwardRayToRef(i.tmpRay)}if(this._options.maxPointerDistance&&(i.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&t){let e=this._xrSessionManager.scene,r=this._options.xrInput.xrCamera;!r||(r.viewport.toGlobalToRef(e.getEngine().getRenderWidth()/r.rigCameras.length,e.getEngine().getRenderHeight(),this._viewportRef),i1.P.ProjectToRef(t,this._identityMatrix,r.getTransformationMatrix(),this._viewportRef,this._screenCoordinatesRef),"number"!=typeof this._screenCoordinatesRef.x||"number"!=typeof this._screenCoordinatesRef.y||isNaN(this._screenCoordinatesRef.x)||isNaN(this._screenCoordinatesRef.y)||this._screenCoordinatesRef.x===1/0||this._screenCoordinatesRef.y===1/0||(e.pointerX=this._screenCoordinatesRef.x,e.pointerY=this._screenCoordinatesRef.y,i.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let r=null;this._utilityLayerScene&&(r=this._utilityLayerScene.pickWithRay(i.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));let s=this._scene.pickWithRay(i.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);r&&r.hit?s&&s.hit?r.distance<s.distance?i.pick=r:i.pick=s:i.pick=r:i.pick=s,i.pick&&i.xrController&&(i.pick.aimTransform=i.xrController.pointer,i.pick.gripTransform=i.xrController.grip||null,i.pick.originMesh=i.xrController.pointer);let n=i.pick;if(n&&n.pickedPoint&&n.hit){this._updatePointerDistance(i.laserPointer,n.distance),i.selectionMesh.position.copyFrom(n.pickedPoint),i.selectionMesh.scaling.x=Math.sqrt(n.distance),i.selectionMesh.scaling.y=Math.sqrt(n.distance),i.selectionMesh.scaling.z=Math.sqrt(n.distance);let e=this._convertNormalToDirectionOfRay(n.getNormal(!0),i.tmpRay);if(i.selectionMesh.position.copyFrom(n.pickedPoint),e){let t=i1.P.Cross(r9.RD.Y,e),r=i1.P.Cross(e,t);i1.P.RotationFromAxisToRef(r,e,t,i.selectionMesh.rotation),i.selectionMesh.position.addInPlace(e.scale(.001))}i.selectionMesh.isVisible=this.displaySelectionMesh,i.meshUnderPointer=n.pickedMesh}else i.selectionMesh.isVisible=!1,this._updatePointerDistance(i.laserPointer,1),i.meshUnderPointer=null})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||nW.x.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){let t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,r=this._options.useUtilityLayer?this._utilityLayerScene:this._scene,s=new nR.p,n=(0,nS.eu)("selection",{diameter:.0525,thickness:.015,tessellation:20},r);n.isVisible=!1,n.isPickable=!1,n.parent=t.selectionMesh;let a=0,o=!1,l={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(t.pick){if(this._augmentPointerInit(l,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,n.isVisible=!1,t.pick.hit){if(this._pickingMoved(s,t.pick))o&&!this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,l),o=!1,a=0;else if(a>i/10&&(n.isVisible=!0),(a+=this._scene.getEngine().getDeltaTime())>=i)this._scene.simulatePointerDown(t.pick,l),o=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,l),n.isVisible=!1;else{let e=1-a/i;n.scaling.set(e,e,e)}}else o=!1,a=0;this._scene.simulatePointerMove(t.pick,l),s=t.pick}}),void 0!==this._options.renderingGroupId&&(n.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&o&&(this._scene.simulatePointerUp(t.pick,l),t.finalPointerUpTriggered=!0),n.dispose()})}_attachScreenRayMode(e){let t=this._controllers[e.uniqueId],i=!1,r={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),t.pick&&(!this._options.disablePointerUpOnTouchOut||!i)&&(i?this._scene.simulatePointerMove(t.pick,r):(this._scene.simulatePointerDown(t.pick,r),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,r)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(r,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,r),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){let t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);let i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){let r=r=>{this._options.overrideButtonId&&(t.selectionComponent=r.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=r.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(r=>{if(r.changes.pressed){let s=r.changes.pressed.current;if(t.pick)(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),s?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor));else if(s&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick){let t=this._controllers[this._attachedController];t&&t.pointerDownTriggered&&!t.finalPointerUpTriggered&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(new nR.p,{pointerId:t.id,pointerType:"xr"}),t.finalPointerUpTriggered=!0),this._attachedController=e.uniqueId}}})};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{let e=e=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)})},r=e=>{this._xrSessionManager.onXRFrameObservable.addOnce(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)})};t.eventListeners={selectend:r,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",r)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(i1.P.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){let t=this._controllers[e];if(t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(e=>{let i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)}),!t.finalPointerUpTriggered&&t.pointerDownTriggered){let e={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(e,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new nR.p,e),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){let e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}catch(e){rD.w1.Warn("controller already detached.")}})}}_generateNewMeshPair(e){let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nW.x.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():(0,nz.wf)("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;let r=new nn.K("laserPointerMat",t);r.emissiveColor=this.laserPointerDefaultColor,r.alpha=.7,i.material=r,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;let s=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():(0,nS.eu)("gazeTracker",{diameter:.0105,thickness:.0075,tessellation:20},t);s.bakeCurrentTransformIntoVertices(),s.isPickable=!1,s.isVisible=!1;let n=new nn.K("targetMat",t);return n.specularColor=i2.Wo.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,s.material=n,void 0!==this._options.renderingGroupId&&(i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:s}}_pickingMoved(e,t){if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;e.pickedPoint?.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));let i=.01*(this._options.gazeModePointerMovedFactor||1)*t.distance;return this._tmpVectorForPickCompare.length()>i}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}lC._IdCounter=200,lC.Name=ll.b.POINTER_SELECTION,lC.Version=1,ll.d.AddWebXRFeature(lC.Name,(e,t)=>()=>new lC(e,t),lC.Version,!0),(Q=t$||(t$={}))[Q.Float=1]="Float",Q[Q.Int=2]="Int",Q[Q.Vector2=4]="Vector2",Q[Q.Vector3=8]="Vector3",Q[Q.Vector4=16]="Vector4",Q[Q.Color3=32]="Color3",Q[Q.Color4=64]="Color4",Q[Q.Matrix=128]="Matrix",Q[Q.Object=256]="Object",Q[Q.AutoDetect=1024]="AutoDetect",Q[Q.BasedOnInput=2048]="BasedOnInput",Q[Q.All=4095]="All",(K=tj||(tj={}))[K.Vertex=1]="Vertex",K[K.Fragment=2]="Fragment",K[K.Neutral=4]="Neutral",K[K.VertexAndFragment=3]="VertexAndFragment";class lT{constructor(){this.supportUniformBuffers=!1,this.attributes=[],this.uniforms=[],this.constants=[],this.samplers=[],this.functions={},this.extensions={},this.prePassOutput={},this.counters={},this._terminalBlocks=new Set,this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}get shaderLanguage(){return this.sharedData.nodeMaterial.shaderLanguage}get fSuffix(){return 1===this.shaderLanguage?"f":""}finalize(e){let t=e.sharedData.emitComments,i=this.target===tj.Fragment;1===this.shaderLanguage?i?this.compilationString=`
${t?"//Entry point\n":""}@fragment
fn main(input: FragmentInputs) -> FragmentOutputs {
${this.compilationString}`:this.compilationString=`
${t?"//Entry point\n":""}@vertex
fn main(input: VertexInputs) -> FragmentInputs{
${this.compilationString}`:this.compilationString=`
${t?"//Entry point\n":""}void main(void) {
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`
${t?"//Constants\n":""}${this._constantDeclaration}
${this.compilationString}`);let r="";for(let e in this.functions)r+=this.functions[e]+`
`;if(this.compilationString=`
${r}
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`
${t?"//Varyings\n":""}${this.sharedData.varyingDeclaration}
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`
${t?"//Samplers\n":""}${this._samplerDeclaration}
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`
${t?"//Uniforms\n":""}${this._uniformDeclaration}
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`
${t?"//Attributes\n":""}${this._attributeDeclaration}
${this.compilationString}`),1!==this.shaderLanguage)for(let e in this.compilationString="precision highp float;\n"+this.compilationString,this.compilationString="#if defined(WEBGL2) || defined(WEBGPU)\nprecision highp sampler2DArray;\n#endif\n"+this.compilationString,i&&(this.compilationString="#if defined(PREPASS)\r\n#extension GL_EXT_draw_buffers : require\r\nlayout(location = 0) out highp vec4 glFragData[SCENE_MRT_COUNT];\r\nhighp vec4 gl_FragColor;\r\n#endif\r\n"+this.compilationString),this.extensions){let t=this.extensions[e];this.compilationString=`
${t}
${this.compilationString}`}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return(e=e.replace(/[^a-zA-Z_]+/g,""),void 0===this.sharedData.variableNames[e])?(this.sharedData.variableNames[e]=0,"output"===e||"texture"===e)?e+this.sharedData.variableNames[e]:e:(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return void 0===this.sharedData.defineNames[e]?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e,t="",i=!1){(0>this.samplers.indexOf(e)||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_2d<f32>;
`):this._samplerDeclaration+=`uniform sampler2D ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emitCubeSampler(e,t="",i=!1){(0>this.samplers.indexOf(e)||i)&&(t&&(this._samplerDeclaration+=`#if ${t}
`),1===this.shaderLanguage?(this._samplerDeclaration+=`var ${e+"Sampler"}: sampler;
`,this._samplerDeclaration+=`var ${e}: texture_cube<f32>;
`):this._samplerDeclaration+=`uniform samplerCube ${e};
`,t&&(this._samplerDeclaration+=`#endif
`),i||this.samplers.push(e))}_emit2DArraySampler(e){0>this.samplers.indexOf(e)&&(this._samplerDeclaration+=`uniform sampler2DArray ${e};
`,this.samplers.push(e))}_getGLType(e){switch(e){case t$.Float:return"float";case t$.Int:return"int";case t$.Vector2:return"vec2";case t$.Color3:case t$.Vector3:return"vec3";case t$.Color4:case t$.Vector4:return"vec4";case t$.Matrix:return"mat4"}return""}_getShaderType(e){let t=1===this.shaderLanguage;switch(e){case t$.Float:return t?"f32":"float";case t$.Int:return t?"i32":"int";case t$.Vector2:return t?"vec2f":"vec2";case t$.Color3:case t$.Vector3:return t?"vec3f":"vec3";case t$.Color4:case t$.Vector4:return t?"vec4f":"vec4";case t$.Matrix:return t?"mat4x4f":"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}
${t}
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){let r=sG.v.GetIncludesShadersStore(this.shaderLanguage);if(i&&i.repeatKey)return`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`;let s=r[e]+"\n";if(this.sharedData.emitComments&&(s=t+`
`+s),!i)return s;if(i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){let t=i.replaceStrings[e];s=s.replace(t.search,t.replace)}return s}_emitFunctionFromInclude(e,t,i,r=""){let s=e+r;if(this.functions[s])return;let n=sG.v.GetIncludesShadersStore(this.shaderLanguage);if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[s]=`#include<${e}>${i.substitutionVars?"("+i.substitutionVars+")":""}[0..${i.repeatKey}]
`:this.functions[s]=`#include<${e}>${i?.substitutionVars?"("+i?.substitutionVars+")":""}
`,this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]);return}if(this.functions[s]=n[e],this.sharedData.emitComments&&(this.functions[s]=t+`
`+this.functions[s]),i.removeIfDef&&(this.functions[s]=this.functions[s].replace(/^\s*?#ifdef.+$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#endif.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#else.*$/gm,""),this.functions[s]=this.functions[s].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[s]=this.functions[s].replace(/\s*?attribute .+?;/g,"\n")),i.removeUniforms&&(this.functions[s]=this.functions[s].replace(/\s*?uniform .*?;/g,"\n")),i.removeVaryings&&(this.functions[s]=this.functions[s].replace(/\s*?(varying|in) .+?;/g,"\n")),i.replaceStrings)for(let e=0;e<i.replaceStrings.length;e++){let t=i.replaceStrings[e];this.functions[s]=this.functions[s].replace(t.search,t.replace)}}_registerTempVariable(e){return -1===this.sharedData.temps.indexOf(e)&&(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",r=!1){if(-1!==this.sharedData.varyings.indexOf(e))return!1;this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}
`:this.sharedData.varyingDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`);let s=this._getShaderType(t);return 1===this.shaderLanguage?this.sharedData.varyingDeclaration+=`varying ${e}: ${s};
`:this.sharedData.varyingDeclaration+=`varying ${s} ${e};
`,i&&(this.sharedData.varyingDeclaration+=`#endif
`),!0}_getVaryingName(e){return 1===this.shaderLanguage?(this.target!==tj.Fragment?"vertexOutputs.":"fragmentInputs.")+e:e}_emitUniformFromString(e,t,i="",r=!1){if(-1!==this.uniforms.indexOf(e))return;this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}
`:this._uniformDeclaration+=`${r?"#ifndef":"#ifdef"} ${i}
`);let s=this._getShaderType(t);1===this.shaderLanguage?this._uniformDeclaration+=`uniform ${e}: ${s};
`:this._uniformDeclaration+=`uniform ${s} ${e};
`,i&&(this._uniformDeclaration+=`#endif
`)}_generateTernary(e,t,i){return 1===this.shaderLanguage?`select(${t}, ${e}, ${i})`:`(${i}) ? ${e} : ${t}`}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}_declareOutput(e,t){return this._declareLocalVar(e.associatedVariableName,e.type,t)}_declareLocalVar(e,t,i){return 1===this.shaderLanguage?`${i?"const":"var"} ${e}: ${this._getShaderType(t)}`:`${this._getShaderType(t)} ${e}`}_samplerCubeFunc(){return 1===this.shaderLanguage?"textureSample":"textureCube"}_samplerFunc(){return 1===this.shaderLanguage?"textureSample":"texture2D"}_samplerLODFunc(){return 1===this.shaderLanguage?"textureSampleLevel":"texture2DLodEXT"}_toLinearSpace(e){return 1===this.shaderLanguage&&(e.type===t$.Color3||e.type===t$.Vector3)?`toLinearSpaceVec3(${e.associatedVariableName})`:`toLinearSpace(${e.associatedVariableName})`}_generateTextureSample(e,t){return 1===this.shaderLanguage?`${this._samplerFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerFunc()}(${t}, ${e})`}_generateTextureSampleLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerLODFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerLODFunc()}(${t}, ${e}, ${i})`}_generateTextureSampleCube(e,t){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e})`:`${this._samplerCubeFunc()}(${t}, ${e})`}_generateTextureSampleCubeLOD(e,t,i){return 1===this.shaderLanguage?`${this._samplerCubeFunc()}(${t},${t+"Sampler"}, ${e}, ${i})`:`${this._samplerCubeFunc()}(${t}, ${e}, ${i})`}_convertVariableDeclarationToWGSL(e,t,i){return i.replace(RegExp(`(${e})\\s+(\\w+)`,"g"),`var $2: ${t}`)}_convertVariableConstructorsToWGSL(e,t,i){return i.replace(RegExp(`(${e})\\(`,"g"),` ${t}(`)}_convertOutParametersToWGSL(e){return e.replace(RegExp("out\\s+var\\s+(\\w+)\\s*:\\s*(\\w+)","g"),"$1: ptr<function, $2>")}_convertTernaryOperandsToWGSL(e){return e.replace(RegExp("\\[(.*?)\\?(.*?):(.*)\\]","g"),(e,t,i,r)=>`select(${r}, ${i}, ${t})`)}_convertModOperatorsToWGSL(e){return e.replace(RegExp("mod\\((.+?),\\s*(.+?)\\)","g"),(e,t,i)=>`((${t})%(${i}))`)}_convertConstToWGSL(e){return e.replace(RegExp("const var","g"),"const")}_convertInnerFunctionsToWGSL(e){return e.replace(/inversesqrt/g,"inverseSqrt")}_convertFunctionsToWGSL(e){let t;let i=/var\s+(\w+)\s*:\s*(\w+)\((.*)\)/g;for(;null!==(t=i.exec(e));){let i=t[1],r=t[2],s=t[3].replace(/var\s/g,"");e=e.replace(t[0],`fn ${i}(${s}) -> ${r}`)}return e}_babylonSLtoWGSL(e){return e=this._convertVariableDeclarationToWGSL("void","voidnull",e),e=this._convertVariableDeclarationToWGSL("bool","bool",e),e=this._convertVariableDeclarationToWGSL("int","i32",e),e=this._convertVariableDeclarationToWGSL("uint","u32",e),e=this._convertVariableDeclarationToWGSL("float","f32",e),e=this._convertVariableDeclarationToWGSL("vec2","vec2f",e),e=this._convertVariableDeclarationToWGSL("vec3","vec3f",e),e=this._convertVariableDeclarationToWGSL("vec4","vec4f",e),e=this._convertVariableDeclarationToWGSL("mat2","mat2x2f",e),e=this._convertVariableDeclarationToWGSL("mat3","mat3x3f",e),e=this._convertVariableDeclarationToWGSL("mat4","mat4x4f",e),e=this._convertVariableConstructorsToWGSL("float","f32",e),e=this._convertVariableConstructorsToWGSL("vec2","vec2f",e),e=this._convertVariableConstructorsToWGSL("vec3","vec3f",e),e=this._convertVariableConstructorsToWGSL("vec4","vec4f",e),e=this._convertVariableConstructorsToWGSL("mat2","mat2x2f",e),e=this._convertVariableConstructorsToWGSL("mat3","mat3x3f",e),e=this._convertVariableConstructorsToWGSL("mat4","mat4x4f",e),e=this._convertTernaryOperandsToWGSL(e),e=this._convertModOperatorsToWGSL(e),e=this._convertConstToWGSL(e),e=this._convertInnerFunctionsToWGSL(e),e=(e=this._convertOutParametersToWGSL(e)).replace(/\[\*\]/g,"*"),e=(e=(e=(e=this._convertFunctionsToWGSL(e)).replace(/\s->\svoidnull/g,"")).replace(/dFdx/g,"dpdx")).replace(/dFdy/g,"dpdy")}_convertTernaryOperandsToGLSL(e){return e.replace(RegExp("\\[(.+?)\\?(.+?):(.+)\\]","g"),(e,t,i,r)=>`${t} ? ${i} : ${r}`)}_babylonSLtoGLSL(e){return e=e.replace(/\[\*\]/g,""),e=this._convertTernaryOperandsToGLSL(e)}}class lb{constructor(){this.temps=[],this.varyings=[],this.varyingDeclaration="",this.inputBlocks=[],this.textureBlocks=[],this.bindableBlocks=[],this.forcedBindableBlocks=[],this.blocksWithFallbacks=[],this.blocksWithDefines=[],this.repeatableContentBlocks=[],this.dynamicUniformBlocks=[],this.blockingBlocks=[],this.animatedInputs=[],this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:[]},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(e=null){let t="";for(let e of(this.checks.emitVertex||this.allowEmptyVertexProgram||(t+="NodeMaterial does not have a vertex output. You need to at least add a block that generates a position value.\n"),this.checks.emitFragment||(t+="NodeMaterial does not have a fragment output. You need to at least add a block that generates a color value.\n"),this.checks.notConnectedNonOptionalInputs))t+=`input ${e.name} from block ${e.ownerBlock.name}[${e.ownerBlock.getClassName()}] is not connected and is not optional.
`;return!t||(e&&e.notifyObservers(t),re.Y.Error("Build of NodeMaterial failed:\n"+t),!1)}}(Z=tq||(tq={}))[Z.Compatible=0]="Compatible",Z[Z.TypeIncompatible=1]="TypeIncompatible",Z[Z.TargetIncompatible=2]="TargetIncompatible",Z[Z.HierarchyIssue=3]="HierarchyIssue",(J=tQ||(tQ={}))[J.Input=0]="Input",J[J.Output=1]="Output";class ly{static AreEquivalentTypes(e,t){switch(e){case t$.Vector3:if(t===t$.Color3)return!0;break;case t$.Vector4:if(t===t$.Color4)return!0;break;case t$.Color3:if(t===t$.Vector3)return!0;break;case t$.Color4:if(t===t$.Vector4)return!0}return!1}get _connectedPoint(){return this._connectedPointBackingField}set _connectedPoint(e){this._connectedPointBackingField!==e&&(this._connectedPointTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._connectedPointBackingField=e),this._connectedPointBackingField&&(this._connectedPointTypeChangedObserver=this._connectedPointBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _typeConnectionSource(){return this._typeConnectionSourceBackingField}set _typeConnectionSource(e){this._typeConnectionSourceBackingField!==e&&(this._typeConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._typeConnectionSourceBackingField=e),this._typeConnectionSourceBackingField&&(this._typeConnectionSourceTypeChangedObserver=this._typeConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get _defaultConnectionPointType(){return this._defaultConnectionPointTypeBackingField}set _defaultConnectionPointType(e){this._updateTypeDependentState(()=>this._defaultConnectionPointTypeBackingField=e)}get _linkedConnectionSource(){return this._linkedConnectionSourceBackingField}set _linkedConnectionSource(e){this._linkedConnectionSourceBackingField!==e&&(this._linkedConnectionSourceTypeChangedObserver?.remove(),this._updateTypeDependentState(()=>this._linkedConnectionSourceBackingField=e),this._linkedConnectionSourceBackingField&&(this._linkedConnectionSourceTypeChangedObserver=this._linkedConnectionSourceBackingField.onTypeChangedObservable.add(()=>{this._notifyTypeChanged()})))}get direction(){return this._direction}get declarationVariableName(){return this._ownerBlock.isInput?this._ownerBlock.declarationVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.declarationVariableName}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:this._enforceAssociatedVariableName&&this._associatedVariableName||!this._connectedPoint?this._associatedVariableName:this._connectedPoint.associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===t$.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.connectedPoint._redirectedSource&&this._linkedConnectionSource.connectedPoint._redirectedSource.isConnected?this._linkedConnectionSource.connectedPoint._redirectedSource.type:this._linkedConnectionSource.type}if(this._type===t$.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._updateTypeDependentState(()=>this._type=e)}get target(){return this._prioritizeVertex&&this._ownerBlock&&this._target===tj.VertexAndFragment?this._ownerBlock.target===tj.Fragment?tj.Fragment:tj.Vertex:this._target}set target(e){this._target=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get isConnectedToInputBlock(){return null!==this.connectedPoint&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===tj.Vertex||(e.ownerBlock.target===tj.Neutral||e.ownerBlock.target===tj.VertexAndFragment)&&e.ownerBlock.outputs.some(e=>e.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===tj.Vertex)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===tj.Vertex||e.target===tj.Vertex||(e.ownerBlock.target===tj.Neutral||e.ownerBlock.target===tj.VertexAndFragment)&&e.ownerBlock.outputs.some(e=>e.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===tj.Fragment)return!0;if(!this.hasEndpoints)return!1;for(let e of this._endpoints)if(e.ownerBlock.target===tj.Fragment||(e.ownerBlock.target===tj.Neutral||e.ownerBlock.target===tj.VertexAndFragment)&&e.ownerBlock.isConnectedInFragmentShader())return!0;return!1}createCustomInputBlock(){return null}constructor(e,t,i){this._preventBubbleUp=!1,this._connectedPointBackingField=null,this._endpoints=[],this._redirectedSource=null,this._typeConnectionSourceBackingField=null,this._defaultConnectionPointTypeBackingField=null,this._linkedConnectionSourceBackingField=null,this._acceptedConnectionPointType=null,this._type=t$.Float,this._enforceAssociatedVariableName=!1,this._forPostBuild=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new i0.y$,this.onDisconnectionObservable=new i0.y$,this.onTypeChangedObservable=new i0.y$,this._isTypeChangeObservableNotifying=!1,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=tj.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){let t=this._ownerBlock,i=e.ownerBlock;if(t.target===tj.Fragment){if(i.target===tj.Vertex)return 2;for(let e of i.outputs)if(e.ownerBlock.target!=tj.Neutral&&e.isConnectedInVertexShader)return 2}if(this.type!==e.type&&e.innerType!==t$.AutoDetect)return ly.AreEquivalentTypes(this.type,e.type)?0:e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)||e._acceptedConnectionPointType&&ly.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,s=t;return(0===this.direction&&(r=t,s=i),r.isAnAncestorOf(s))?3:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){let t=this._endpoints.indexOf(e);return -1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<t$.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){let t={};return t.name=this.name,this.displayName&&(t.displayName=this.displayName),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear(),this.onTypeChangedObservable.clear(),this._connectedPoint=null,this._typeConnectionSource=null,this._linkedConnectionSource=null}_updateTypeDependentState(e){let t=this.type;e(),this.type!==t&&this._notifyTypeChanged()}_notifyTypeChanged(){this._isTypeChangeObservableNotifying||(this._isTypeChangeObservableNotifying=!0,this.onTypeChangedObservable.notifyObservers(this.type),this._isTypeChangeObservableNotifying=!1)}}var lI=i(73266);class lP{get name(){return this._name}get codeIsReady(){return this._codeIsReady}set name(e){this.validateBlockName(e)&&(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isLoop(){return this._isLoop}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){(this._target&e)==0&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){let t=this._inputs.filter(t=>t.name===e);return t.length?t[0]:null}getOutputByName(e){let t=this._outputs.filter(t=>t.name===e);return t.length?t[0]:null}constructor(e,t=tj.Vertex,i=!1){switch(this._isFinalMerger=!1,this._isInput=!1,this._isLoop=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._name="",this._isUnique=!1,this._codeIsReady=!0,this.onCodeIsReadyObservable=new i0.y$,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=[],this._outputs=[],this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===tj.Neutral,this._isFinalMerger=i,this.getClassName()){case"InputBlock":this._isInput=!0;break;case"NodeMaterialTeleportOutBlock":this._isTeleportOut=!0;break;case"NodeMaterialTeleportInBlock":this._isTeleportIn=!0;break;case"LoopBlock":this._isLoop=!0}this._name=e,this.uniqueId=lI.K.UniqueId}_setInitialTarget(e){this._target=e,this._originalTargetIsNeutral=e===tj.Neutral}initialize(e){}bind(e,t,i,r){}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return -1===t.indexOf(".")&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}isConnectedInFragmentShader(){return this.outputs.some(e=>e.isConnectedInFragmentShader)}registerInput(e,t,i=!1,r,s){return(s=s??new ly(e,this,0)).type=t,s.isOptional=i,r&&(s.target=r),this._inputs.push(s),this}registerOutput(e,t,i,r){return(r=r??new ly(e,this,1)).type=t,i&&(r.target=i),this._outputs.push(r),this}getFirstAvailableInput(e=null){for(let t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===t$.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(let t of this._outputs)if(!e||!e.target||e.target===tj.Neutral||(e.target&t.target)!=0)return t;return null}getSiblingOutput(e){let t=this._outputs.indexOf(e);return -1===t||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(let t of this._outputs)if(t.hasEndpoints){for(let i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(0===this._outputs.length)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),r=!0;for(;r;){let s=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&s&&i.canConnectTo(s))i.connectTo(s),r=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}_postBuildBlock(e){}updateUniformsAndSamples(e,t,i,r){}provideFallbacks(e,t){}initializeDefines(e,t,i,r=!1){}prepareDefines(e,t,i,r=!1,s){}autoConfigure(e,t=()=>!0){}replaceRepeatableContent(e,t,i,r){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return!(this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput))&&this.target!==tj.Vertex&&!!((this.target===tj.VertexAndFragment||this.target===tj.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,r=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,r){e.build(t,r);let s=null!=t._vertexState,n=e._buildTarget===tj.Vertex&&e.target!==tj.VertexAndFragment;if(s&&((e.target&e._buildTarget)==0||(e.target&i.target)==0||this.target!==tj.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){let e=i.connectedPoint;if(t._vertexState._emitVaryingFromString("v_"+e.declarationVariableName,e.type)){let i=1===t.shaderLanguage?"vertexOutputs.":"";t._vertexState.compilationString+=`${i}${"v_"+e.declarationVariableName} = ${e.associatedVariableName};
`}let r=1===t.shaderLanguage?"fragmentInputs.":"";i.associatedVariableName=r+"v_"+e.declarationVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){for(let t of["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"])if(e===t)return!1;return!0}_customBuildStep(e,t){}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(let t of this._outputs)t.associatedVariableName||(t.associatedVariableName=e._getFreeVariableName(t.name));for(let i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==tj.Neutral&&((i.target&this.target)==0||(i.target&e.target)==0))continue;let r=i.connectedPoint.ownerBlock;r&&r!==this&&this._processBuild(r,e,i,t)}if(this._customBuildStep(e,t),this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&re.Y.Log(`${e.target===tj.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case tj.Vertex:e.sharedData.checks.emitVertex=!0;break;case tj.Fragment:e.sharedData.checks.emitFragment=!0}for(let i of(!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`
//${this.name}
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target,this._outputs))if(!i._forPostBuild&&(i.target&e.target)!=0)for(let r of i.endpoints){let i=r.ownerBlock;i&&((i.target&e.target)!=0&&-1!==t.indexOf(i)||e._terminalBlocks.has(i))&&this._processBuild(i,e,r,t)}for(let i of(this._postBuildBlock(e),this._outputs))if(i._forPostBuild&&(i.target&e.target)!=0)for(let r of i.endpoints){let i=r.ownerBlock;i&&(i.target&e.target)!=0&&-1!==t.indexOf(i)&&this._processBuild(i,e,r,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){let e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};
${e}.visibleOnFrame = ${this.visibleOnFrame};
${e}.target = ${this.target};
`}_dumpCode(e,t){t.push(this);let i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do t++,this._codeVariableName=i+t;while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;for(let i of(this.comments&&(r+=`// ${this.comments}
`),r+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");
`+this._dumpPropertiesCode(),this.inputs)){if(!i.isConnected)continue;let s=i.connectedPoint.ownerBlock;-1===t.indexOf(s)&&(r+=s._dumpCode(e,t))}for(let i of this.outputs)if(i.hasEndpoints)for(let s of i.endpoints){let i=s.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;for(let i of(e.push(this),this.inputs)){if(!i.isConnected)continue;let r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e)+`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}clone(e,t=""){let i=this.serialize(),r=(0,i3.qw)(i.customType);if(r){let s=new r;return s._deserialize(i,e,t),s}return null}serialize(){let e={};for(let t of(e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[],this.inputs))e.inputs.push(t.serialize());for(let t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i,r){this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=e.target??this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){let t=e.inputs,i=e.outputs;t&&t.forEach((e,t)=>{e.displayName&&(this.inputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.inputs[t].isExposedOnFrame=e.isExposedOnFrame,this.inputs[t].exposedPortPosition=e.exposedPortPosition)}),i&&i.forEach((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)})}dispose(){for(let e of(this.onCodeIsReadyObservable.clear(),this.inputs))e.dispose();for(let e of this.outputs)e.dispose()}}class lR extends lP{constructor(e){super(e,tj.Neutral),this.complementW=1,this.complementZ=0,this.target=tj.Vertex,this.registerInput("vector",t$.AutoDetect),this.registerInput("transform",t$.Matrix),this.registerOutput("output",t$.Vector4),this.registerOutput("xyz",t$.Vector3),this._inputs[0].onConnectionObservable.add(e=>{if(e.ownerBlock.isInput){let t=e.ownerBlock;("normal"===t.name||"tangent"===t.name)&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);let t=this.vector,i=this.transform,r=e._getShaderType(t$.Vector4),s=e._getShaderType(t$.Vector3);if(t.connectedPoint){if(0===this.complementW){let n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n),e.sharedData.blocksWithDefines.push(this);let a=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(1===e.shaderLanguage?e.compilationString+=`var ${a}: mat3x3f = mat3x3f(${i.associatedVariableName}[0].xyz, ${i.associatedVariableName}[1].xyz, ${i.associatedVariableName}[2].xyz);
`:e.compilationString+=`mat3 ${a} = mat3(${i.associatedVariableName});
`,e.compilationString+=`#ifdef NONUNIFORMSCALING
`,e.compilationString+=`${a} = transposeMat3(inverseMat3(${a}));
`,e.compilationString+=`#endif
`,t.connectedPoint.type){case t$.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${s}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});
`;break;case t$.Vector3:case t$.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${r}(${a} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});
`}}else{let s=i.associatedVariableName;switch(t.connectedPoint.type){case t$.Vector2:e.compilationString+=e._declareOutput(this.output)+` = ${s} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});
`;break;case t$.Vector3:case t$.Color3:e.compilationString+=e._declareOutput(this.output)+` = ${s} * ${r}(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});
`;break;default:e.compilationString+=e._declareOutput(this.output)+` = ${s} * ${t.associatedVariableName};
`}}this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){let e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=void 0!==e.complementZ?e.complementZ:0,this.complementW=void 0!==e.complementW?e.complementW:1}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};
`+`${this._codeVariableName}.complementW = ${this.complementW};
`}}(0,i3.H7)("BABYLON.TransformBlock",lR);class lA extends lP{constructor(e){super(e,tj.Vertex,!0),this.registerInput("vector",t$.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e,t){if(t)return!0;for(let t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);let t=this.vector,i=1===e.shaderLanguage;if(1===e.shaderLanguage?e.compilationString+=`vertexOutputs.position = ${t.associatedVariableName};
`:e.compilationString+=`gl_Position = ${t.associatedVariableName};
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes,e.sharedData.nodeMaterial.useLogarithmicDepth)){e._emitUniformFromString("logarithmicDepthConstant",t$.Float),e._emitVaryingFromString("vFragmentDepth",t$.Float);let t=i?"vertexOutputs.vFragmentDepth":"vFragmentDepth",r=i?"vertexOutputs.position":"gl_Position";e.compilationString+=`${t} = 1.0 + ${r}.w;
`,e.compilationString+=`${r}.z = log2(max(0.000001, ${t})) * ${i?"uniforms.":""}logarithmicDepthConstant;
`}return this}}function lM(e,t=0,i="PROPERTIES",r){return(s,n)=>{let a=s._propStore;a||(a=[],s._propStore=a),a.push({propertyName:n,displayName:e,type:t,groupName:i,options:r??{}})}}(0,i3.H7)("BABYLON.VertexOutputBlock",lA),(ee=tK||(tK={}))[ee.Boolean=0]="Boolean",ee[ee.Float=1]="Float",ee[ee.Int=2]="Int",ee[ee.Vector2=3]="Vector2",ee[ee.List=4]="List";class lN extends lP{constructor(e){super(e,tj.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",t$.Color4,!0),this.registerInput("rgb",t$.AutoDetect,!0),this.registerInput("a",t$.Float,!0),this.rgb.addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){(this.useLogarithmicDepth||t.useLogarithmicDepth)&&i&&(0,le.gz)(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);let t=this.rgba,i=this.rgb,r=this.a,s=1===e.shaderLanguage;e.sharedData.hints.needAlphaBlending=t.isConnected||r.isConnected,e.sharedData.blocksWithDefines.push(this),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e._emitUniformFromString("logarithmicDepthConstant",t$.Float),e._emitVaryingFromString("vFragmentDepth",t$.Float),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");let n=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",n);let a="gl_FragColor";1===e.shaderLanguage&&(e.compilationString+=`var fragmentOutputsColor : vec4<f32>;\r
`,a="fragmentOutputsColor");let o=e._getShaderType(t$.Vector4);if(t.connectedPoint)r.isConnected?e.compilationString+=`${a} = ${o}(${t.associatedVariableName}.rgb, ${r.associatedVariableName});
`:e.compilationString+=`${a}  = ${t.associatedVariableName};
`;else if(i.connectedPoint){let t="1.0";r.connectedPoint&&(t=r.associatedVariableName),i.connectedPoint.type===t$.Float?e.compilationString+=`${a}  = ${o}(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${t});
`:e.compilationString+=`${a}  = ${o}(${i.associatedVariableName}, ${t});
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${a}  = toLinearSpace(${a});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${a}  = toGammaSpace(${a});
`,e.compilationString+=`#endif
`,1===e.shaderLanguage&&(e.compilationString+=`#if !defined(PREPASS)\r
`,e.compilationString+=`fragmentOutputs.color = fragmentOutputsColor;\r
`,e.compilationString+=`#endif\r
`),(this.useLogarithmicDepth||e.sharedData.nodeMaterial.useLogarithmicDepth)&&(e.compilationString+=`${s?"fragmentOutputs.fragDepth":"gl_FragDepthEXT"} = log2(${s?"input.vFragmentDepth":"vFragmentDepth"}) * ${s?"uniforms.":""}logarithmicDepthConstant * 0.5;
`),e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=`${s?"fragmentOutputs.fragData0":"gl_FragData[0]"} = ${a};\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};
`}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.useLogarithmicDepth=e.useLogarithmicDepth??!1}}(0,r$.gn)([lM("Convert to gamma space",0,"PROPERTIES",{notifiers:{update:!0}})],lN.prototype,"convertToGammaSpace",void 0),(0,r$.gn)([lM("Convert to linear space",0,"PROPERTIES",{notifiers:{update:!0}})],lN.prototype,"convertToLinearSpace",void 0),(0,r$.gn)([lM("Use logarithmic depth",0,"PROPERTIES")],lN.prototype,"useLogarithmicDepth",void 0),(0,i3.H7)("BABYLON.FragmentOutputBlock",lN),(et=tZ||(tZ={}))[et.World=1]="World",et[et.View=2]="View",et[et.Projection=3]="Projection",et[et.ViewProjection=4]="ViewProjection",et[et.WorldView=5]="WorldView",et[et.WorldViewProjection=6]="WorldViewProjection",et[et.CameraPosition=7]="CameraPosition",et[et.FogColor=8]="FogColor",et[et.DeltaTime=9]="DeltaTime",et[et.CameraParameters=10]="CameraParameters",et[et.MaterialAlpha=11]="MaterialAlpha",(ei=tJ||(tJ={}))[ei.None=0]="None",ei[ei.Time=1]="Time",ei[ei.RealTime=2]="RealTime",ei[ei.MouseInfo=3]="MouseInfo";let lO={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},lD={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},lF={particle_texturemask:!0};class lL extends lP{get type(){if(this._type===t$.AutoDetect){if(this.isUniform&&null!=this.value){if(!isNaN(this.value))return this._type=t$.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=t$.Vector2,this._type;case"Vector3":return this._type=t$.Vector3,this._type;case"Vector4":return this._type=t$.Vector4,this._type;case"Color3":return this._type=t$.Color3,this._type;case"Color4":return this._type=t$.Color4,this._type;case"Matrix":return this._type=t$.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=t$.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=t$.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"matricesIndicesExtra":case"matricesWeightsExtra":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=t$.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=t$.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case tZ.World:case tZ.WorldView:case tZ.WorldViewProjection:case tZ.View:case tZ.ViewProjection:case tZ.Projection:this._type=t$.Matrix;break;case tZ.CameraPosition:this._type=t$.Vector3;break;case tZ.FogColor:this._type=t$.Color3;break;case tZ.DeltaTime:case tZ.MaterialAlpha:this._type=t$.Float;break;case tZ.CameraParameters:this._type=t$.Vector4}}return this._type}constructor(e,t=tj.Vertex,i=t$.AutoDetect){super(e,t,!1),this._mode=3,this._animationType=tJ.None,this._prefix="",this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new i0.y$,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}validateBlockName(e){return!!this.isAttribute||super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=1,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===t$.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=0,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=0}get declarationVariableName(){return this._associatedVariableName}get associatedVariableName(){return this._prefix+this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return 3===this._mode}get isUniform(){return 0===this._mode}set isUniform(e){this._mode=e?0:3,this.associatedVariableName=""}get isAttribute(){return 1===this._mode}set isAttribute(e){this._mode=e?1:3,this.associatedVariableName=""}get isVarying(){return 2===this._mode}set isVarying(e){this._mode=e?2:3,this.associatedVariableName=""}get isSystemValue(){return null!=this._systemValue}get systemValue(){return this._systemValue}set systemValue(e){this._mode=0,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case tJ.Time:this.type===t$.Float&&(this.value+=.01*e.getAnimationRatio());break;case tJ.RealTime:this.type===t$.Float&&(this.value=(rW.F.Now-e.getEngine().startTime)/1e3);break;case tJ.MouseInfo:if(this.type===t$.Vector4){let t=e._inputManager._originMouseEvent;if(t){let e=t.offsetX,i=t.offsetY,r=(1&t.buttons)!=0?1:0,s=(2&t.buttons)!=0?1:0;this.value=new i1.Lt(e,i,r,s)}else this.value=new i1.Lt(0,0,0,0)}}}_emitDefine(e){return"!"===e[0]?`#ifndef ${e.substring(1)}
`:`#ifdef ${e}
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case t$.Float:this.value=0;break;case t$.Vector2:this.value=i1.FM.Zero();break;case t$.Vector3:this.value=i1.P.Zero();break;case t$.Vector4:this.value=i1.Lt.Zero();break;case t$.Color3:this.value=aN.Wo.White();break;case t$.Color4:this.value=new aN.HE(1,1,1,1);break;case t$.Matrix:this.value=i1.y3.Identity()}}_emitConstant(e){switch(this.type){case t$.Float:return`${e._emitFloat(this.value)}`;case t$.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case t$.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case t$.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case t$.Color3:return aN.zZ.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&aN.zZ.Color3[0].toGammaSpaceToRef(aN.zZ.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&aN.zZ.Color3[0].toLinearSpaceToRef(aN.zZ.Color3[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec3(${aN.zZ.Color3[0].r}, ${aN.zZ.Color3[0].g}, ${aN.zZ.Color3[0].b})`;case t$.Color4:return aN.zZ.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&aN.zZ.Color4[0].toGammaSpaceToRef(aN.zZ.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&aN.zZ.Color4[0].toLinearSpaceToRef(aN.zZ.Color4[0],e.sharedData.scene.getEngine().useExactSrgbConversions),`vec4(${aN.zZ.Color4[0].r}, ${aN.zZ.Color4[0].g}, ${aN.zZ.Color4[0].b}, ${aN.zZ.Color4[0].a})`}return""}get _noContextSwitch(){return lD[this.name]}_emit(e,t){if(this.isUniform){if(this._associatedVariableName||(this._associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(-1!==e.constants.indexOf(this.associatedVariableName))return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=e._declareOutput(this.output,!0)+` = ${this._emitConstant(e)};
`;return}if(-1!==e.uniforms.indexOf(this.associatedVariableName))return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t));let i=e._getShaderType(this.type);1===e.shaderLanguage?(e._uniformDeclaration+=`uniform ${this._associatedVariableName}: ${i};
`,this._prefix="uniforms."):e._uniformDeclaration+=`uniform ${i} ${this.associatedVariableName};
`,t&&(e._uniformDeclaration+=`#endif
`);let r=e.sharedData.hints;if(null!==this._systemValue&&void 0!==this._systemValue)switch(this._systemValue){case tZ.WorldView:r.needWorldViewMatrix=!0;break;case tZ.WorldViewProjection:r.needWorldViewProjectionMatrix=!0}else this._animationType!==tJ.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=lO[this.name]??this.name,this.target===tj.Vertex&&e._vertexState){lD[this.name]?lF[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="vertexInputs.")):e._emitVaryingFromString(this.declarationVariableName,this.type,t):this._emit(e._vertexState,t);return}if(-1!==e.attributes.indexOf(this.declarationVariableName))return;e.attributes.push(this.declarationVariableName),lD[this.name]?lF[this.name]?(e._emitUniformFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="uniforms.")):(e._emitVaryingFromString(this.declarationVariableName,this.type,t),1===e.shaderLanguage&&(this._prefix="fragmentInputs.")):(t&&(e._attributeDeclaration+=this._emitDefine(t)),1===e.shaderLanguage?(e._attributeDeclaration+=`attribute ${this.declarationVariableName}: ${e._getShaderType(this.type)};
`,this._prefix="vertexInputs."):e._attributeDeclaration+=`attribute ${e._getShaderType(this.type)} ${this.declarationVariableName};
`,t&&(e._attributeDeclaration+=`#endif
`))}}_transmitWorld(e,t,i,r){if(!this._systemValue)return;let s=this._associatedVariableName;switch(this._systemValue){case tZ.World:e.setMatrix(s,t);break;case tZ.WorldView:e.setMatrix(s,i);break;case tZ.WorldViewProjection:e.setMatrix(s,r)}}_transmit(e,t,i){if(this.isAttribute)return;let r=this._associatedVariableName;if(this._systemValue){switch(this._systemValue){case tZ.World:case tZ.WorldView:case tZ.WorldViewProjection:break;case tZ.View:e.setMatrix(r,t.getViewMatrix());break;case tZ.Projection:e.setMatrix(r,t.getProjectionMatrix());break;case tZ.ViewProjection:e.setMatrix(r,t.getTransformMatrix());break;case tZ.CameraPosition:t.bindEyePosition(e,r,!0);break;case tZ.FogColor:e.setColor3(r,t.fogColor);break;case tZ.DeltaTime:e.setFloat(r,t.deltaTime/1e3);break;case tZ.CameraParameters:t.activeCamera&&e.setFloat4(r,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case tZ.MaterialAlpha:e.setFloat(r,i.alpha)}return}let s=this._valueCallback?this._valueCallback():this._storedValue;if(null!==s)switch(this.type){case t$.Float:e.setFloat(r,s);break;case t$.Int:e.setInt(r,s);break;case t$.Color3:aN.zZ.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&aN.zZ.Color3[0].toGammaSpaceToRef(aN.zZ.Color3[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&aN.zZ.Color3[0].toLinearSpaceToRef(aN.zZ.Color3[0],t.getEngine().useExactSrgbConversions),e.setColor3(r,aN.zZ.Color3[0]);break;case t$.Color4:aN.zZ.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&aN.zZ.Color4[0].toGammaSpaceToRef(aN.zZ.Color4[0],t.getEngine().useExactSrgbConversions),this.convertToLinearSpace&&aN.zZ.Color4[0].toLinearSpaceToRef(aN.zZ.Color4[0],t.getEngine().useExactSrgbConversions),e.setDirectColor4(r,aN.zZ.Color4[0]);break;case t$.Vector2:e.setVector2(r,s);break;case t$.Vector3:e.setVector3(r,s);break;case t$.Vector4:e.setVector4(r,s);break;case t$.Matrix:e.setMatrix(r,s)}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){let e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${tZ[this._systemValue]});
`;if(this.isUniform){let t=[],i="";switch(this.type){case t$.Float:i=`${this.value}`;break;case t$.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case t$.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case t$.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case t$.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case t$.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case t$.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`}return t.push(`${e}.value = ${i}`),this.type===t$.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${tJ[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){let e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,null!=this._storedValue&&0===this._mode&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,"tangent"===e.name&&1===e.mode&&e.type===t$.Vector3&&(this._type=t$.Vector4),e.valueType){if("number"===e.valueType)this._storedValue=e.value;else{let t=(0,i3.qw)(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}}(0,i3.H7)("BABYLON.InputBlock",lL);class lw extends lP{constructor(e){super(e,tj.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",t$.AutoDetect,!1,tj.VertexAndFragment),this.registerOutput("rgba",t$.Color4,tj.Neutral),this.registerOutput("rgb",t$.Color3,tj.Neutral),this.registerOutput("r",t$.Float,tj.Neutral),this.registerOutput("g",t$.Float,tj.Neutral),this.registerOutput("b",t$.Float,tj.Neutral),this.registerOutput("a",t$.Float,tj.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Vector2|t$.Vector3|t$.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName(this._samplerName)}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?tj.VertexAndFragment:tj.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!this.texture||!!this.texture.isReadyOrNotBlocking()}_injectVertexCode(e){let t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&!t.connectedPoint.ownerBlock.isAttribute&&e._emitUniformFromString(t.associatedVariableName,t$.Vector2),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,t$.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,this._outputs.some(e=>e.isConnectedInVertexShader))for(let t of(this._writeTextureRead(e,!0),this._outputs))t.hasEndpoints&&this._writeOutput(e,t,t.name,!0)}_writeTextureRead(e,t=!1){let i=this.uv;if(t){if(e.target===tj.Fragment)return;let t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,r=0===e.shaderLanguage?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${t} ${i.associatedVariableName}${r});
`;return}let r=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===tj.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${r} ${i.associatedVariableName});
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===tj.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===tj.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),0>e.sharedData.blockingBlocks.indexOf(this)&&e.sharedData.blockingBlocks.push(this),0>e.sharedData.textureBlocks.indexOf(this)&&e.sharedData.textureBlocks.push(this),0>e.sharedData.blocksWithDefines.indexOf(this)&&e.sharedData.blocksWithDefines.push(this),e.target!==tj.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(e=>e.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;for(let i of(e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e),this._outputs))i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=rZ.x.Parse(e.texture,t,i))}}(0,i3.H7)("BABYLON.CurrentScreenBlock",lw);class lB extends lP{constructor(e){super(e,tj.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",t$.AutoDetect,!1,tj.VertexAndFragment),this.registerOutput("rgba",t$.Color4,tj.Neutral),this.registerOutput("rgb",t$.Color3,tj.Neutral),this.registerOutput("r",t$.Float,tj.Neutral),this.registerOutput("g",t$.Float,tj.Neutral),this.registerOutput("b",t$.Float,tj.Neutral),this.registerOutput("a",t$.Float,tj.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Vector2|t$.Vector3|t$.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"particle_uv"===e.name&&t(e));i||(i=new lL("uv")).setAsAttribute("particle_uv"),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!this.texture||!!this.texture.isReadyOrNotBlocking()}_writeOutput(e,t,i){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,e.compilationString+=`#ifdef ${this._linearDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef ${this._gammaDefineName}
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
`,e.compilationString+=`#endif
`}_buildBlock(e){if(super._buildBlock(e),e.target===tj.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");let t=`//${this.name}`;for(let i of(e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${e._generateTextureSample(this.uv.associatedVariableName,this._samplerName)};
`,this._outputs))i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=rZ.x.Parse(e.texture,t,i))}}(0,i3.H7)("BABYLON.ParticleTextureBlock",lB);class lV extends lP{constructor(e){super(e,tj.Fragment),this._isUnique=!0,this.registerInput("color",t$.Color4,!1,tj.Fragment),this.registerOutput("rampColor",t$.Color4,tj.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor")}_buildBlock(e){if(super._buildBlock(e),e.target!==tj.Vertex)return e._emit2DSampler("rampSampler","RAMPGRADIENT"),e._emitVaryingFromString("remapRanges",t$.Vector4,"RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                ${e._declareLocalVar("baseColor",t$.Vector4)} = ${this.color.associatedVariableName};
                ${e._declareLocalVar("alpha",t$.Float)} = ${this.color.associatedVariableName}.a;

                ${e._declareLocalVar("remappedColorIndex",t$.Float)} = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                ${e._declareLocalVar("rampColor",t$.Vector4)} = ${e._generateTextureSample("vec2(1.0 - remappedColorIndex, 0.)","rampSampler")};

                // Remapped alpha
                ${e._declareOutput(this.rampColor)} = vec4${e.fSuffix}(baseColor.rgb * rampColor.rgb, clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0));
            #else
                ${e._declareOutput(this.rampColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}(0,i3.H7)("BABYLON.ParticleRampGradientBlock",lV);class lU extends lP{constructor(e){super(e,tj.Fragment),this._isUnique=!0,this.registerInput("color",t$.Color4,!1,tj.Fragment),this.registerInput("alphaTexture",t$.Float,!1,tj.Fragment),this.registerInput("alphaColor",t$.Float,!1,tj.Fragment),this.registerOutput("blendColor",t$.Color4,tj.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==tj.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${e._declareOutput(this.blendColor)};
                ${e._declareLocalVar("sourceAlpha",t$.Float)}  = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName} = vec4${e.fSuffix}(${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha), ${this.color.associatedVariableName}.a);
            #else
                ${e._declareOutput(this.blendColor)} = ${this.color.associatedVariableName};
            #endif
        `,this}}(0,i3.H7)("BABYLON.ParticleBlendMultiplyBlock",lU);var lk=i(79114);class lG extends lP{constructor(e){super(e,tj.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",t$.Vector4,!0),this.registerInput("xyz ",t$.Vector3,!0),this.registerInput("xy ",t$.Vector2,!0),this.registerInput("zw ",t$.Vector2,!0),this.registerInput("x",t$.Float,!0),this.registerInput("y",t$.Float,!0),this.registerInput("z",t$.Float,!0),this.registerInput("w",t$.Float,!0),this.registerOutput("xyzw",t$.Vector4),this.registerOutput("xyz",t$.Vector3),this.registerOutput("xy",t$.Vector2),this.registerOutput("zw",t$.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":e}_buildSwizzle(e){return"."+(this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);let t=this.x,i=this.y,r=this.z,s=this.w,n=this.xyIn,a=this.zwIn,o=this.xyzIn,l=this.xyzwIn,c=this._outputs[0],u=this._outputs[1],h=this._outputs[2],d=this._outputs[3],f=e._getShaderType(t$.Vector4),p=e._getShaderType(t$.Vector3),m=e._getShaderType(t$.Vector2);return l.isConnected?(c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${l.associatedVariableName}${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};
`)):o.isConnected?(c.hasEndpoints&&(e.compilationString+=e._declareOutput(c)+` = ${f}(${o.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${o.associatedVariableName}${this._buildSwizzle(3)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};
`)):(n.isConnected?(c.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(c)+` = ${f}(${n.associatedVariableName}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(c)+` = ${f}(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${p}(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};
`)):(c.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(c)+` = ${f}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${a.associatedVariableName})${this._buildSwizzle(4)};
`:e.compilationString+=e._declareOutput(c)+` = ${f}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),u.hasEndpoints&&(e.compilationString+=e._declareOutput(u)+` = ${p}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`),h.hasEndpoints&&(e.compilationString+=e._declareOutput(h)+` = ${m}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};
`)),d.hasEndpoints&&(a.isConnected?e.compilationString+=e._declareOutput(d)+` = ${a.associatedVariableName}${this._buildSwizzle(2)};
`:e.compilationString+=e._declareOutput(d)+` = ${m}(${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(2)};
`)),this}serialize(){let e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.xSwizzle=e.xSwizzle??"x",this.ySwizzle=e.ySwizzle??"y",this.zSwizzle=e.zSwizzle??"z",this.wSwizzle=e.wSwizzle??"w"}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";
${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";
${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";
${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";
`}}(0,i3.H7)("BABYLON.VectorMergerBlock",lG);class lz extends lP{constructor(e){super(e,tj.Neutral),this.sourceRange=new i1.FM(-1,1),this.targetRange=new i1.FM(0,1),this.registerInput("input",t$.AutoDetect),this.registerInput("sourceMin",t$.Float,!0),this.registerInput("sourceMax",t$.Float,!0),this.registerInput("targetMin",t$.Float,!0),this.registerInput("targetMax",t$.Float,!0),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),r=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),s=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=e._declareOutput(t)+` = ${s} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${s}) / (${r} - ${i});
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});
`+`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});
`}serialize(){let e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=i1.FM.FromArray(e.sourceRange),this.targetRange=i1.FM.FromArray(e.targetRange)}}(0,r$.gn)([lM("From",3)],lz.prototype,"sourceRange",void 0),(0,r$.gn)([lM("To",3)],lz.prototype,"targetRange",void 0),(0,i3.H7)("BABYLON.RemapBlock",lz);class lH extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this.output._typeConnectionSource=this.left,this._linkConnectionTypes(0,1,!0),this.left.acceptedConnectionPointTypes.push(t$.Float),this.right.acceptedConnectionPointTypes.push(t$.Float),this._connectionObservers=[this.left.onTypeChangedObservable.add(()=>this._updateInputOutputTypes()),this.right.onTypeChangedObservable.add(()=>this._updateInputOutputTypes())]}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===t$.Int||this.left.type===t$.Float&&this.right.type!==t$.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(let[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[t$.Int,t$.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===t$.Int||t.type===t$.Float)&&e.acceptedConnectionPointTypes.push(t$.Vector2,t$.Vector3,t$.Vector4,t$.Color3,t$.Color4,t$.Matrix))}dispose(){super.dispose(),this._connectionObservers.forEach(e=>e.remove()),this._connectionObservers.length=0}}class lW extends lH{constructor(e){super(e)}getClassName(){return"MultiplyBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.MultiplyBlock",lW),(er=t0||(t0={}))[er.Material=0]="Material",er[er.PostProcess=1]="PostProcess",er[er.Particle=2]="Particle",er[er.ProceduralTexture=3]="ProceduralTexture";var lY=i(96840);class lX extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("rgba",t$.Color4,!0),this.registerInput("rgb ",t$.Color3,!0),this.registerOutput("rgb",t$.Color3),this.registerOutput("r",t$.Float),this.registerOutput("g",t$.Float),this.registerOutput("b",t$.Float),this.registerOutput("a",t$.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return"rgb "===e?"rgbIn":e}_outputRename(e){return"rgb"===e?"rgbOut":e}_buildBlock(e){super._buildBlock(e);let t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;let i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],a=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.rgb;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.r;
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${t.associatedVariableName}.g;
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.b;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.a;
`),this}}(0,i3.H7)("BABYLON.ColorSplitterBlock",lX);var l$=i(15010),lj=i(11386);(es=t1||(t1={}))[es.Cos=0]="Cos",es[es.Sin=1]="Sin",es[es.Abs=2]="Abs",es[es.Exp=3]="Exp",es[es.Exp2=4]="Exp2",es[es.Round=5]="Round",es[es.Floor=6]="Floor",es[es.Ceiling=7]="Ceiling",es[es.Sqrt=8]="Sqrt",es[es.Log=9]="Log",es[es.Tan=10]="Tan",es[es.ArcTan=11]="ArcTan",es[es.ArcCos=12]="ArcCos",es[es.ArcSin=13]="ArcSin",es[es.Fract=14]="Fract",es[es.Sign=15]="Sign",es[es.Radians=16]="Radians",es[es.Degrees=17]="Degrees",es[es.Set=18]="Set";class lq extends lP{constructor(e){super(e,tj.Neutral),this.operation=t1.Cos,this.registerInput("input",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i="";switch(this.operation){case t1.Cos:i="cos";break;case t1.Sin:i="sin";break;case t1.Abs:i="abs";break;case t1.Exp:i="exp";break;case t1.Exp2:i="exp2";break;case t1.Round:i="round";break;case t1.Floor:i="floor";break;case t1.Ceiling:i="ceil";break;case t1.Sqrt:i="sqrt";break;case t1.Log:i="log";break;case t1.Tan:i="tan";break;case t1.ArcTan:i="atan";break;case t1.ArcCos:i="acos";break;case t1.ArcSin:i="asin";break;case t1.Fract:i="fract";break;case t1.Sign:i="sign";break;case t1.Radians:i="radians";break;case t1.Degrees:i="degrees";break;case t1.Set:i=""}return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.input.associatedVariableName});
`,this}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${t1[this.operation]};
`}}(0,i3.H7)("BABYLON.TrigonometryBlock",lq);let lQ={effect:null,subMesh:null};class lK extends o5.H{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.VERTEXCOLOR_NME=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.PREPASS=!1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_WORLD_NORMAL=!1,this.PREPASS_WORLD_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_LOCAL_POSITION=!1,this.PREPASS_LOCAL_POSITION_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_SCREENSPACE_DEPTH=!1,this.PREPASS_SCREENSPACE_DEPTH_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=0,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.CAMERA_ORTHOGRAPHIC=!1,this.CAMERA_PERSPECTIVE=!1,this.rebuild()}setValue(e,t,i=!1){void 0===this[e]&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class lZ extends o7.a{static _BlockIsTextureBlock(e){return"TextureBlock"===e.getClassName()||"ReflectionTextureBaseBlock"===e.getClassName()||"ReflectionTextureBlock"===e.getClassName()||"ReflectionBlock"===e.getClassName()||"RefractionBlock"===e.getClassName()||"CurrentScreenBlock"===e.getClassName()||"ParticleTextureBlock"===e.getClassName()||"ImageSourceBlock"===e.getClassName()||"TriPlanarBlock"===e.getClassName()||"BiPlanarBlock"===e.getClassName()||"PrePassTextureBlock"===e.getClassName()}_getGlobalNodeMaterialEditor(){return"undefined"!=typeof NODEEDITOR?NODEEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeEditor?BABYLON:void 0}get shaderLanguage(){return this._options.shaderLanguage}set shaderLanguage(e){this._options.shaderLanguage=e}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}constructor(e,t,i={}){if(super(e,t||rh.l.LastCreatedScene),this._buildId=lZ._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new i1.y3,this._cachedWorldViewProjectionMatrix=new i1.y3,this._optimizers=[],this._animationFrame=-1,this._buildIsInProgress=!1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new i0.y$,this.onBuildErrorObservable=new i0.y$,this._vertexOutputNodes=[],this._fragmentOutputNodes=[],this.attachedBlocks=[],this._mode=t0.Material,this.forceAlphaBlending=!1,i&&1===i.shaderLanguage&&!this.getScene().getEngine().isWebGPU)throw Error("WebGPU shader language is only supported with WebGPU engine");this._options={emitComments:!1,shaderLanguage:lZ.DefaultShaderLanguage,...i},this._attachImageProcessingConfiguration(null)}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(let i of this.attachedBlocks)if(i.name===e){if(t){rD.w1.Warn("More than one block was found with the name `"+e+"`");break}t=i}return t}getBlockByPredicate(e){for(let t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(let t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){let e=[];for(let t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){let t=this._optimizers.indexOf(e);if(-1!==t)return this._optimizers.splice(t,1),this}addOutputNode(e){if(null===e.target)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&tj.Vertex)!=0&&this._addVertexOutputNode(e),(e.target&tj.Fragment)!=0&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return null===e.target||((e.target&tj.Vertex)!=0&&this._removeVertexOutputNode(e),(e.target&tj.Fragment)!=0&&this._removeFragmentOutputNode(e)),this}_addVertexOutputNode(e){if(-1===this._vertexOutputNodes.indexOf(e))return e.target=tj.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){let t=this._vertexOutputNodes.indexOf(e);if(-1!==t)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(-1===this._fragmentOutputNodes.indexOf(e))return e.target=tj.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){let t=this._fragmentOutputNodes.indexOf(e);if(-1!==t)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return!this.ignoreAlpha&&(this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending)}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_processInitializeOnLink(e,t,i,r=!0){e.target===tj.VertexAndFragment?i.push(e):t.target===tj.Fragment&&e.target===tj.Vertex&&e._preparationId!==this._buildId&&i.push(e),this._initializeBlock(e,t,i,r)}_attachBlock(e){if(-1===this.attachedBlocks.indexOf(e)){if(e.isUnique){let t=e.getClassName();for(let e of this.attachedBlocks)if(e.getClassName()===t)throw`Cannot have multiple blocks of type ${t} in the same NodeMaterial`}this.attachedBlocks.push(e)}}_initializeBlock(e,t,i,r=!0){for(let s of(e.initialize(t),r&&e.autoConfigure(this),e._preparationId=this._buildId,this._attachBlock(e),e.inputs)){s.associatedVariableName="";let n=s.connectedPoint;if(n&&!n._preventBubbleUp){let s=n.ownerBlock;s!==e&&this._processInitializeOnLink(s,t,i,r)}}if(e.isLoop){if(e.loopID.hasEndpoints)for(let s of e.loopID.endpoints){let e=s.ownerBlock;0===e.outputs.length&&(t._terminalBlocks.add(e),this._processInitializeOnLink(e,t,i,r))}}else e.isTeleportOut&&e.entryPoint&&this._processInitializeOnLink(e.entryPoint,t,i,r);for(let t of e.outputs)t.associatedVariableName=""}_resetDualBlocks(e,t){for(let i of(e.target===tj.VertexAndFragment&&(e.buildId=t),e.inputs)){let r=i.connectedPoint;if(r&&!r._preventBubbleUp){let i=r.ownerBlock;i!==e&&this._resetDualBlocks(i,t)}}if(e.isTeleportOut)e.entryPoint&&this._resetDualBlocks(e.entryPoint,t);else if(e.isLoop&&e.loopID.hasEndpoints)for(let i of e.loopID.endpoints){let e=i.ownerBlock;0===e.outputs.length&&this._resetDualBlocks(e,t)}}removeBlock(e){let t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!1){if(this._buildIsInProgress){re.Y.Warn("Build is already in progress, You can use NodeMaterial.onBuildObservable to determine when the build is completed.");return}this._buildIsInProgress=!0,this._vertexCompilationState||i||(i=!0),this._buildWasSuccessful=!1;let r=this.getScene().getEngine(),s=this._mode===t0.Particle;if(0===this._vertexOutputNodes.length&&!s)throw"You must define at least one vertexOutputNode";if(0===this._fragmentOutputNodes.length)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new lT,this._vertexCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._vertexCompilationState.target=tj.Vertex,this._fragmentCompilationState=new lT,this._fragmentCompilationState.supportUniformBuffers=r.supportsUniformBuffers,this._fragmentCompilationState.target=tj.Fragment,this._sharedData=new lb,this._sharedData.nodeMaterial=this,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=s;let n=[],a=[];for(let e of this._vertexOutputNodes)n.push(e),this._initializeBlock(e,this._vertexCompilationState,a,i);for(let e of this._fragmentOutputNodes)a.push(e),this._initializeBlock(e,this._fragmentCompilationState,n,i);let o=0;for(let i of this.attachedBlocks)i.codeIsReady||(o++,i.onCodeIsReadyObservable.addOnce(()=>{0==--o&&this._finishBuildProcess(e,t,n,a)}));0===o&&this._finishBuildProcess(e,t,n,a)}_finishBuildProcess(e=!1,t=!0,i,r){for(let e of(this.optimize(),i))e.build(this._vertexCompilationState,i);for(let e of(this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState,r))this._resetDualBlocks(e,this._buildId-1);for(let e of r)e.build(this._fragmentCompilationState,r);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=lZ._BuildIdGenerator++);let s=this._sharedData.emitErrors(this.onBuildErrorObservable);for(let t of(e&&(re.Y.Log("Vertex shader:"),re.Y.Log(this._vertexCompilationState.compilationString),re.Y.Log("Fragment shader:"),re.Y.Log(this._fragmentCompilationState.compilationString)),this._buildIsInProgress=!1,this._buildWasSuccessful=!0,s&&this.onBuildObservable.notifyObservers(this),this.getScene().meshes))if(t.subMeshes)for(let e of t.subMeshes){if(e.getMaterial()!==this||!e.materialDefines)continue;let t=e.materialDefines;t.markAllAsDirty(),t.reset()}this.prePassTextureInputs.length&&this.getScene().enablePrePassRenderer();let n=this.getScene().prePassRenderer;n&&n.markAsDirty()}optimize(){for(let e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){let i=t.NORMAL,r=t.TANGENT,s=t.VERTEXCOLOR_NME;t.NORMAL=e.isVerticesDataPresent(st.o.NormalKind),t.TANGENT=e.isVerticesDataPresent(st.o.TangentKind);let n=e.useVertexColors&&e.isVerticesDataPresent(st.o.ColorKind);t.VERTEXCOLOR_NME=n;let a=!1;for(let i=1;i<=6;++i){let r=t["UV"+i];t["UV"+i]=e.isVerticesDataPresent(`uv${1===i?"":i}`),a=a||t["UV"+i]!==r}let o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;(0,le.Kg)(this.getScene(),t,!o),(i!==t.NORMAL||r!==t.TANGENT||s!==t.VERTEXCOLOR_NME||a)&&t.markAsAttributesDirty()}get isPrePassCapable(){return!0}get prePassTextureOutputs(){let e=this.getBlockByPredicate(e=>"PrePassOutputBlock"===e.getClassName()),t=[4];return!e||this.prePassTextureInputs.length||(e.viewDepth.isConnected&&t.push(5),e.screenDepth.isConnected&&t.push(10),e.viewNormal.isConnected&&t.push(6),e.worldNormal.isConnected&&t.push(8),e.worldPosition.isConnected&&t.push(1)),t}get prePassTextureInputs(){let e=this.getAllTextureBlocks().filter(e=>"PrePassTextureBlock"===e.getClassName()),t=[];for(let i of e)i.position.isConnected&&!t.includes(1)&&t.push(1),i.localPosition.isConnected&&!t.includes(9)&&t.push(9),i.depth.isConnected&&!t.includes(5)&&t.push(5),i.screenDepth.isConnected&&!t.includes(10)&&t.push(10),i.normal.isConnected&&!t.includes(6)&&t.push(6),i.worldNormal.isConnected&&!t.includes(8)&&t.push(8);return t}setPrePassRenderer(e){let t=this.prePassTextureInputs.concat(this.prePassTextureOutputs);if(e&&t.length>1){let i=e.getEffectConfiguration("nodeMaterial");for(let r of(i||(i=e.addEffectConfiguration({enabled:!0,needsImageProcessing:!1,name:"nodeMaterial",texturesRequired:[]})),t))i.texturesRequired.includes(r)||i.texturesRequired.push(r);i.enabled=!0}return t.length>1}createPostProcess(e,t=1,i=1,r,s,n=0,a=5){return this.mode!==t0.PostProcess?(re.Y.Log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,r,s,n,a)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,r=1,s,n,a=0,o=5){let l=this.name+this._buildId,c=new lK,u=new rP.Kj(l+"PostProcess",this.getScene()),h=this._buildId;return this._processDefines(u,c),n1.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),e?e.updateEffect(c.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l):e=new sD.D(this.name+"PostProcess",l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,r,s,n,c.toString(),a,l,{maxSimultaneousLights:this.maxSimultaneousLights},!1,o,this.shaderLanguage),e.nodeMaterialSource=this,e.onApplyObservable.add(t=>{h!==this._buildId&&(delete n1.Q.ShadersStore[l+"VertexShader"],delete n1.Q.ShadersStore[l+"PixelShader"],l=this.name+this._buildId,c.markAllAsDirty(),h=this._buildId),this._processDefines(u,c)&&(n1.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),l$.Q.SetImmediate(()=>e.updateEffect(c.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,l,l))),this._checkInternals(t)}),e}createProceduralTexture(e,t){if(this.mode!==t0.ProceduralTexture)return re.Y.Log("Incompatible material mode"),null;let i=this.name+this._buildId,r=new lj.g(i,e,null,t),s=new rP.Kj(i+"Procedural",this.getScene());s.reservedDataStore={hidden:!0};let n=new lK,a=this._processDefines(s,n);n1.Q.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage);let o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[st.o.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),a?.fallbacks,void 0,void 0,void 0,this.shaderLanguage);r.nodeMaterialSource=this,r._setEffect(o);let l=this._buildId,c=()=>{l!==this._buildId&&(delete n1.Q.ShadersStore[i+"VertexShader"],delete n1.Q.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),l=this._buildId);let e=this._processDefines(s,n);e&&(n1.Q.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString,this.shaderLanguage),l$.Q.SetImmediate(()=>{o=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[st.o.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),e?.fallbacks,void 0),r._setEffect(o)})),this._checkInternals(o)};return r.onBeforeGenerationObservable.add(()=>{c()}),this.onBuildObservable.add(()=>{c()}),r}_createEffectForParticles(e,t,i,r,s,n,a,o=""){let l=this.name+this._buildId+"_"+t;n||(n=new lK),a||(a=this.getScene().getMeshByName(this.name+"Particle"))||((a=new rP.Kj(this.name+"Particle",this.getScene())).reservedDataStore={hidden:!0});let c=this._buildId,u=[],h=o;if(!s){let o=this._processDefines(a,n);n1.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),e.fillDefines(u,t,!1),h=u.join("\n"),s=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+h,o?.fallbacks,i,r,e,this.shaderLanguage),e.setCustomEffect(s,t)}s.onBindObservable.add(s=>{c!==this._buildId&&(delete n1.Q.ShadersStore[l+"PixelShader"],l=this.name+this._buildId+"_"+t,n.markAllAsDirty(),c=this._buildId),u.length=0,e.fillDefines(u,t,!1);let d=u.join("\n");d!==h&&(n.markAllAsDirty(),h=d);let f=this._processDefines(a,n);if(f){n1.Q.RegisterShader(l,this._fragmentCompilationState._builtCompilationString,void 0,this.shaderLanguage),s=this.getScene().getEngine().createEffectForParticles(l,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+"\n"+h,f?.fallbacks,i,r,e),e.setCustomEffect(s,t),this._createEffectForParticles(e,t,i,r,s,n,a,o);return}this._checkInternals(s)})}_checkInternals(e){if(this._sharedData.animatedInputs){let e=this.getScene(),t=e.getFrameId();if(this._animationFrame!==t){for(let t of this._sharedData.animatedInputs)t.animate(e);this._animationFrame=t}}for(let t of this._sharedData.bindableBlocks)t.bind(e,this);for(let t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==t0.Particle){re.Y.Log("Incompatible material mode");return}this._createEffectForParticles(e,lY.U.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,lY.U.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==t0.Material){re.Y.Log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,r){let s=null,n=this.getScene();if((0,le.hR)(n,t)&&t.markAsMiscDirty(),this._sharedData.blocksWithDefines.forEach(r=>{r.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(s=>{s.prepareDefines(e,this,t,i,r)}),t.isDirty){let i=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(i=>{i.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});let r=[];this._sharedData.dynamicUniformBlocks.forEach(e=>{e.updateUniformsAndSamples(this._vertexCompilationState,this,t,r)});let n=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(e=>{-1===n.indexOf(e)&&n.push(e)});let a=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(e=>{-1===a.indexOf(e)&&a.push(e)});let o=new o8.L;this._sharedData.blocksWithFallbacks.forEach(t=>{t.provideFallbacks(e,o)}),s={lightDisposed:i,uniformBuffers:r,mergedUniforms:n,mergedSamplers:a,fallbacks:o}}return s}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;let r=this.getScene();if(this._sharedData.animatedInputs){let e=r.getFrameId();if(this._animationFrame!==e){for(let e of this._sharedData.animatedInputs)e.animate(r);this._animationFrame=e}}let s=t._drawWrapper;if(s.effect&&this.isFrozen&&s._wasPreviouslyReady&&s._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new lK);let n=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let a=r.getEngine();if(this._prepareDefinesForAttributes(e,n),this._sharedData.blockingBlocks.some(t=>!t.isReady(e,this,n,i)))return!1;let o=this._processDefines(e,n,i,t);if(o){let e=t.effect,i=n.toString(),s=a.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:i,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,multiTarget:n.PREPASS,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:n.NUM_MORPH_INFLUENCERS},shaderLanguage:this.shaderLanguage},a);if(s){if(this._onEffectCreatedObservable&&(lQ.effect=s,lQ.subMesh=t,this._onEffectCreatedObservable.notifyObservers(lQ)),this.allowShaderHotSwapping&&e&&!s.isReady()){if(s=e,n.markAsUnprocessed(),o.lightDisposed)return n._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(s,n,this._materialContext)}}return!!(t.effect&&t.effect.isReady())&&(n._renderId=r.getRenderId(),s._wasPreviouslyReady=!0,s._wasPreviouslyUsingInstances=i,this._checkScenePerformancePriority(),!0)}get compiledShaders(){return`// Vertex shader
${this._vertexCompilationState.compilationString}

// Fragment shader
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){let t=this.getScene();if(!this._activeEffect)return;let i=this._sharedData.hints;for(let r of(i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),this._sharedData.inputBlocks))r._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.effect;if(!s)return;this._activeEffect=s,this.bindOnlyWorldMatrix(e);let n=this._mustRebind(r,s,i,t.visibility),a=this._sharedData;if(n){for(let e of a.bindableBlocks)e.bind(s,this,t,i);for(let e of a.forcedBindableBlocks)e.bind(s,this,t,i);for(let e of a.inputBlocks)e._transmit(s,r,this)}else if(!this.isFrozen)for(let e of a.forcedBindableBlocks)e.bind(s,this,t,i);this._afterBind(t,this._activeEffect,i)}getActiveTextures(){let e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(e=>e.texture).map(e=>e.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}getAllTextureBlocks(){let e=[];for(let t of this.attachedBlocks)lZ._BlockIsTextureBlock(t)&&e.push(t);return e}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(let t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(let e of this.getTextureBlocks().filter(e=>e.texture).map(e=>e.texture))e.dispose();for(let e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this.onBuildErrorObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(e){let t={nodeMaterial:this,...e};this.BJSNODEMATERIALEDITOR.NodeEditor.Show(t)}edit(e){return new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),void 0===this.BJSNODEMATERIALEDITOR){let i=e&&e.editorURL?e.editorURL:lZ.EditorURL;rD.w1.LoadBabylonScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(e?.nodeEditorConfig),t()})}else this._createNodeEditor(e?.nodeEditorConfig),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0,this._buildIsInProgress=!1}setToDefault(){this.clear(),this.editorData=null;let e=new lL("Position");e.setAsAttribute("position");let t=new lL("World");t.setAsSystemValue(tZ.World);let i=new lR("WorldPos");e.connectTo(i),t.connectTo(i);let r=new lL("ViewProjection");r.setAsSystemValue(tZ.ViewProjection);let s=new lR("WorldPos * ViewProjectionTransform");i.connectTo(s),r.connectTo(s);let n=new lA("VertexOutput");s.connectTo(n);let a=new lL("color");a.value=new i2.HE(.8,.8,.8,1);let o=new lN("FragmentOutput");a.connectTo(o),this.addOutputNode(n),this.addOutputNode(o),this._mode=t0.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;let e=new lL("Position");e.setAsAttribute("position2d");let t=new lL("Constant1");t.isConstant=!0,t.value=1;let i=new lG("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});let r=new lA("VertexOutput");i.connectTo(r);let s=new lL("Scale");s.visibleInInspector=!0,s.value=new i1.FM(1,1);let n=new lz("uv0");e.connectTo(n);let a=new lW("UV scale");n.connectTo(a),s.connectTo(a);let o=new lw("CurrentScreen");a.connectTo(o),o.texture=new rZ.x("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());let l=new lN("FragmentOutput");o.connectTo(l,{output:"rgba"}),this.addOutputNode(r),this.addOutputNode(l),this._mode=t0.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;let e=new lL("Position");e.setAsAttribute("position2d");let t=new lL("Constant1");t.isConstant=!0,t.value=1;let i=new lG("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});let r=new lA("VertexOutput");i.connectTo(r);let s=new lL("Time");s.value=0,s.min=0,s.max=0,s.isBoolean=!1,s.matrixMode=0,s.animationType=tJ.Time,s.isConstant=!1;let n=new lL("Color3");n.value=new i2.Wo(1,1,1),n.isConstant=!1;let a=new lN("FragmentOutput"),o=new lG("VectorMerger");o.visibleInInspector=!1;let l=new lq("Cos");l.operation=t1.Cos,e.connectTo(o),s.output.connectTo(l.input),l.output.connectTo(o.z),o.xyzOut.connectTo(a.rgb),this.addOutputNode(r),this.addOutputNode(a),this._mode=t0.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;let e=new lL("uv");e.setAsAttribute("particle_uv");let t=new lB("ParticleTexture");e.connectTo(t);let i=new lL("Color");i.setAsAttribute("particle_color");let r=new lW("Texture * Color");t.connectTo(r),i.connectTo(r);let s=new lV("ParticleRampGradient");r.connectTo(s);let n=new lX("ColorSplitter");i.connectTo(n);let a=new lU("ParticleBlendMultiply");s.connectTo(a),t.connectTo(a,{output:"a"}),n.connectTo(a,{output:"a"});let o=new lN("FragmentOutput");a.connectTo(o),this.addOutputNode(o),this._mode=t0.Particle}async loadAsync(e,t=""){return lZ.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(-1===t.indexOf(e)){for(let i of(t.push(e),e.inputs)){let r=i.connectedPoint;if(r){let i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}e.isTeleportOut&&e.entryPoint&&this._gatherBlocks(e.entryPoint,t)}}generateCode(){let e=[],t=[],i=["const","var","let"];for(let e of this._vertexOutputNodes)this._gatherBlocks(e,t);let r=[];for(let e of this._fragmentOutputNodes)this._gatherBlocks(e,r);let s=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");
`;for(let r of(s+=`nodeMaterial.mode = BABYLON.NodeMaterialModes.${t0[this.mode]};
`,t))r.isInput&&-1===e.indexOf(r)&&(s+=r._dumpCode(i,e));for(let t of r)t.isInput&&-1===e.indexOf(t)&&(s+=t._dumpCode(i,e));for(let t of(e=[],s+="\n// Connections\n",this._vertexOutputNodes))s+=t._dumpCodeForOutputConnections(e);for(let t of this._fragmentOutputNodes)s+=t._dumpCodeForOutputConnections(e);for(let e of(s+="\n// Output nodes\n",this._vertexOutputNodes))s+=`nodeMaterial.addOutputNode(${e._codeVariableName});
`;for(let e of this._fragmentOutputNodes)s+=`nodeMaterial.addOutputNode(${e._codeVariableName});
`;return s+`nodeMaterial.build();
`}serialize(e){let t=e?{}:rq.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{for(let e of(t.customType="BABYLON.NodeMaterial",t.outputNodes=[],this._vertexOutputNodes))this._gatherBlocks(e,i),t.outputNodes.push(e.uniqueId);for(let e of this._fragmentOutputNodes)this._gatherBlocks(e,i),-1===t.outputNodes.indexOf(e.uniqueId)&&t.outputNodes.push(e.uniqueId)}for(let e of(t.blocks=[],i))t.blocks.push(e.serialize());if(!e)for(let e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t.uniqueId=this.uniqueId,t}_restoreConnections(e,t,i){for(let r of e.outputs)for(let s of t.blocks){let n=i[s.id];if(n){for(let a of s.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===r.name){let e=n.getInputByName(a.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(n,t,i);continue}}}}parseSerializedObject(e,t="",i=!1,r){i||this.clear();let s={};for(let i of e.blocks){let e=(0,i3.qw)(i.customType);if(e){let n=new e;n._deserialize(i,this.getScene(),t,r),s[i.id]=n,this.attachedBlocks.push(n)}}for(let e of this.attachedBlocks)if(e.isTeleportOut){let t=e._tempEntryPointUniqueId;t&&s[t].attachToEndpoint(e)}for(let t=0;t<e.blocks.length;t++){let r=s[e.blocks[t].id];r&&(!r.inputs.length||i)&&this._restoreConnections(r,e,s)}if(e.outputNodes)for(let t of e.outputNodes)this.addOutputNode(s[t]);if(e.locations||e.editorData&&e.editorData.locations){let t=e.locations||e.editorData.locations;for(let e of t)s[e.blockId]&&(e.blockId=s[e.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&t.concat(this.editorData.locations),e.locations?this.editorData={locations:t}:(this.editorData=e.editorData,this.editorData.locations=t);let r=[];for(let e in s)r[e]=s[e].uniqueId;this.editorData.map=r}this.comment=e.comment,void 0!==e.forceAlphaBlending&&(this.forceAlphaBlending=e.forceAlphaBlending),void 0!==e.alphaMode&&(this.alphaMode=e.alphaMode),i||(this._mode=e.mode??t0.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){let i=this.serialize(),r=rq.p.Clone(()=>new lZ(e,this.getScene(),this.options),this);return r.id=e,r.name=e,r.parseSerializedObject(i),r._buildId=this._buildId,r.build(!1,!t),r}whenTexturesReadyAsync(){let e=[];return this.getActiveTextures().forEach(t=>{let i=t.getInternalTexture();i&&!i.isReady&&e.push(new Promise((e,t)=>{i.onLoadedObservable.addOnce(()=>{e()}),i.onErrorObservable.addOnce(e=>{t(e)})}))}),Promise.all(e)}static Parse(e,t,i="",r=0){let s=rq.p.Parse(()=>new lZ(e.name,t,{shaderLanguage:r}),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,r="",s=!1,n,a){let o=n??new lZ(e,i),l=JSON.parse(await i._loadFileAsync(t));return o.parseSerializedObject(l,r,void 0,a),s||o.build(),o}static ParseFromSnippetAsync(e,t=rh.l.LastCreatedScene,i="",r,s=!1,n=!1,a){return"_BLANK"===e?Promise.resolve(lZ.CreateDefault("blank",t)):new Promise((o,l)=>{let c=new lk.g;c.addEventListener("readystatechange",()=>{if(4==c.readyState){if(200==c.status){let u=JSON.parse(JSON.parse(JSON.parse(c.responseText).jsonPayload).nodeMaterial);r||((r=rq.p.Parse(()=>new lZ(e,t),u,t,i)).uniqueId=t.getUniqueId()),r.parseSerializedObject(u,void 0,void 0,a),r.snippetId=e,r.sideOrientation=null;try{s||r.build()}catch(e){l(e)}n?r.whenTexturesReadyAsync().then(()=>{o(r)}).catch(e=>{l(e)}):o(r)}else l("Unable to load the snippet "+e)}}),c.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),c.send()})}static CreateDefault(e,t){let i=new lZ(e,t);return i.setToDefault(),i.build(),i}}lZ._BuildIdGenerator=0,lZ.EditorURL=`${rD.w1._DefaultCdnUrl}/v${rV.a.Version}/nodeEditor/babylon.nodeEditor.js`,lZ.SnippetUrl="https://snippet.babylonjs.com",lZ.IgnoreTexturesAtLoadTime=!1,lZ.DefaultShaderLanguage=0,(0,r$.gn)([(0,rj.qC)()],lZ.prototype,"ignoreAlpha",void 0),(0,r$.gn)([(0,rj.qC)()],lZ.prototype,"maxSimultaneousLights",void 0),(0,r$.gn)([(0,rj.qC)("mode")],lZ.prototype,"_mode",void 0),(0,r$.gn)([(0,rj.qC)("comment")],lZ.prototype,"comment",void 0),(0,r$.gn)([(0,rj.qC)()],lZ.prototype,"forceAlphaBlending",void 0),(0,i3.H7)("BABYLON.NodeMaterial",lZ);var lJ=i(34066);lJ.P.prototype._projectOnTrianglesToRef=function(e,t,i,r,s,n){let a=i1.jp.Vector3[0],o=i1.jp.Vector3[1],l=Infinity;for(let n=this.indexStart;n<this.indexStart+this.indexCount-(3-r);n+=r){let r=i[n],c=i[n+1],u=i[n+2];if(s&&4294967295===u){n+=2;continue}let h=t[r],d=t[c],f=t[u];if(!h||!d||!f)continue;let p=i1.P.ProjectOnTriangleToRef(e,h,d,f,o);p<l&&(a.copyFrom(o),l=p)}return n.copyFrom(a),l},lJ.P.prototype._projectOnUnIndexedTrianglesToRef=function(e,t,i,r){let s=i1.jp.Vector3[0],n=i1.jp.Vector3[1],a=Infinity;for(let i=this.verticesStart;i<this.verticesStart+this.verticesCount;i+=3){let r=t[i],o=t[i+1],l=t[i+2],c=i1.P.ProjectOnTriangleToRef(e,r,o,l,n);c<a&&(s.copyFrom(n),a=c)}return r.copyFrom(s),a},lJ.P.prototype.projectToRef=function(e,t,i,r){let s=this.getMaterial();if(!s)return -1;let n=3,a=!1;switch(s.fillMode){case 3:case 5:case 6:case 8:return -1;case 7:n=1,a=!0}return 4===s.fillMode?-1:!i.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(e,t,i,r):this._projectOnTrianglesToRef(e,t,i,n,a,r)},(en=t2||(t2={}))[en.DEHYDRATED=0]="DEHYDRATED",en[en.HOVER=1]="HOVER",en[en.TOUCH=2]="TOUCH",(ea=t3||(t3={}))[ea.DISABLED=0]="DISABLED",ea[ea.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",ea[ea.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT";class l0 extends lE{constructor(e,t){super(e),this._options=t,this._tmpRay=new nr.zH(new i1.P,new i1.P),this._attachController=e=>{if(this._controllers[e.uniqueId])return;let{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r}=this._generateNewTouchPointMesh(),s=this._generateVisualCue();switch(this._controllers[e.uniqueId]={xrController:e,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r,currentAnimationState:t2.DEHYDRATED,grabRay:new nr.zH(new i1.P,new i1.P),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,downTriggered:!1,id:l0._IdCounter++,pickedPointVisualCue:s},this._controllers[e.uniqueId]._worldScaleObserver=this._controllers[e.uniqueId]._worldScaleObserver||this._xrSessionManager.onWorldScaleFactorChangedObservable.add(t=>{if(t.newScaleFactor!==t.previousScaleFactor){this._controllers[e.uniqueId].touchCollisionMesh.dispose(),this._controllers[e.uniqueId].pickedPointVisualCue.dispose();let{touchCollisionMesh:t,touchCollisionMeshFunction:i,hydrateCollisionMeshFunction:r}=this._generateNewTouchPointMesh();this._controllers[e.uniqueId].touchCollisionMesh=t,this._controllers[e.uniqueId].touchCollisionMeshFunction=i,this._controllers[e.uniqueId].hydrateCollisionMeshFunction=r,this._controllers[e.uniqueId].pickedPointVisualCue=this._generateVisualCue()}}),this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&e.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=e.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=e.uniqueId),e.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(e);case"gaze":case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new i2.Wo(.8,.8,.8),this.selectionMeshPickedColor=new i2.Wo(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,void 0===this._options.nearInteractionControllerMode&&(this._options.nearInteractionControllerMode=2),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return!!super.attach()&&(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0)}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){let t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){if(!(e.currentAnimationState===t||2!==this._options.nearInteractionControllerMode||e.xrController?.inputSource.hand)){if(t>e.currentAnimationState)switch(e.currentAnimationState){case t2.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===t2.HOVER)break;case t2.HOVER:e.touchCollisionMeshFunction(!0),t2.TOUCH}else switch(e.currentAnimationState){case t2.TOUCH:if(e.touchCollisionMeshFunction(!1),t===t2.HOVER)break;case t2.HOVER:e.hydrateCollisionMeshFunction(!1),t2.DEHYDRATED}e.currentAnimationState=t}}_processTouchPoint(e,t,i){let r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(i1.jp.Vector3[0]),r.grabRay.direction.copyFrom(i1.jp.Vector3[0]),2!==this._options.nearInteractionControllerMode||r.xrController?.inputSource.hand||(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius*this._xrSessionManager.worldScalingFactor,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin).scaleInPlace(this._xrSessionManager.worldScalingFactor)}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{let i=this._controllers[t],r=i.xrController?.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!i.xrController||!r&&(!this._options.nearInteractionControllerMode||!i.xrController.inputSource.gamepad)){i.pick=null;return}if(i.hoverInteraction=!1,i.nearInteraction=!1,!i.xrController)return;if(r){let i=r.get("index-finger-tip");if(i){let r=e.getJointPose(i,this._xrSessionManager.referenceSpace);if(r&&r.transform){let e=this._scene.useRightHandedSystem?1:-1;i1.jp.Vector3[0].set(r.transform.position.x,r.transform.position.y,r.transform.position.z*e),i1.jp.Quaternion[0].set(r.transform.orientation.x,r.transform.orientation.y,r.transform.orientation.z*e,r.transform.orientation.w*e),this._processTouchPoint(t,i1.jp.Vector3[0],i1.jp.Quaternion[0])}}}else if(i.xrController.inputSource.gamepad&&0!==this._options.nearInteractionControllerMode){let e=i.xrController.pointer;i.xrController.grip&&1===this._options.nearInteractionControllerMode&&(e=i.xrController.grip),this._processTouchPoint(t,e.position,e.rotationQuaternion)}let s=(e,t)=>t&&t.hit?e&&e.hit?t.distance<e.distance?t:e:t:e,n=e=>{let t=new nR.p,i=!1,r=e&&e.pickedPoint&&e.hit;return e?.pickedPoint&&(i=0===e.pickedPoint.x&&0===e.pickedPoint.y&&0===e.pickedPoint.z),r&&!i&&(t=e),t};if(!i.grabInteraction){let e=null,t=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._utilityLayerScene,e=>this._nearInteractionPredicate(e)));let a=s(this._pickWithSphere(i,this._hoverRadius*this._xrSessionManager.worldScalingFactor,this._scene,e=>this._nearInteractionPredicate(e)),t);if(a&&a.hit&&(e=n(a)).hit&&(i.hoverInteraction=!0),i.hoverInteraction){let t=null,a=(r?this._pickRadius:this._controllerPickRadius)*this._xrSessionManager.worldScalingFactor;this._options.useUtilityLayer&&this._utilityLayerScene&&(t=this._pickWithSphere(i,a,this._utilityLayerScene,e=>this._nearPickPredicate(e)));let o=n(s(this._pickWithSphere(i,a,this._scene,e=>this._nearPickPredicate(e)),t));o.hit&&(e=o,i.nearInteraction=!0)}i.stalePick=i.pick,i.pick=e,i.pick&&i.pick.pickedPoint&&i.pick.hit?(i.meshUnderPointer=i.pick.pickedMesh,i.pickedPointVisualCue.position.copyFrom(i.pick.pickedPoint),i.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!0)):(i.meshUnderPointer=null,i.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(i.id,!1))}let a=t2.DEHYDRATED;i.grabInteraction||i.nearInteraction?a=t2.TOUCH:i.hoverInteraction&&(a=t2.HOVER),this._handleTransitionAnimation(i,a)})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||nW.x.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nW.x.DefaultUtilityLayer.utilityLayerScene:this._scene,t=(0,n$.Qk)("nearInteraction",{diameter:.0105*this._xrSessionManager.worldScalingFactor},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=i1._f.Identity();let i=new nn.K("targetMat",e);return i.specularColor=i2.Wo.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return!this._farInteractionFeature||this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e)}_attachNearInteractionMode(e){let t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{(this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController)&&t.xrController&&(t.xrController.inputSource.hand||this._options.nearInteractionControllerMode&&t.xrController.inputSource.gamepad)&&(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer,t.downTriggered=!0):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.downTriggered=!1,t.nearInteractionTargetMesh=null))});let r=r=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),r&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0):!r&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.downTriggered=!1,t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):!r||this._options.enableNearInteractionOnAllControllers||this._options.disableSwitchOnClick||(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){let i=e=>{t.squeezeComponent=e.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(e=>{e.changes.pressed&&r(e.changes.pressed.current)}):(t.selectionComponent=e.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(e=>{e.changes.pressed&&r(e.changes.pressed.current)}))};e.motionController?i(e.motionController):e.onMotionControllerInitObservable.add(i)}else{let e=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i),t.downTriggered=!0)},r=e=>{t.xrController&&e.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0,t.downTriggered=!1)};t.eventListeners={selectend:r,selectstart:e},this._xrSessionManager.session.addEventListener("selectstart",e),this._xrSessionManager.session.addEventListener("selectend",r)}}_detachController(e){let t=this._controllers[e];if(t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(e=>{let i=t.eventListeners&&t.eventListeners[e];i&&this._xrSessionManager.session.removeEventListener(e,i)}),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{if(!t.downTriggered)return;let e={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new nR.p,e)}),t._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(t._worldScaleObserver),delete this._controllers[e],this._attachedController===e)){let e=Object.keys(this._controllers);e.length?this._attachedController=e[0]:this._attachedController=""}}_generateNewTouchPointMesh(){let e=this._xrSessionManager.worldScalingFactor,t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nW.x.DefaultUtilityLayer.utilityLayerScene:this._scene,i=(0,n$.Qk)("PickSphere",{diameter:1*e},t);(i.isVisible=!1,this._options.motionControllerOrbMaterial)?i.material=this._options.motionControllerOrbMaterial:(this._options.motionControllerTouchMaterialSnippetUrl?lZ.ParseFromFileAsync("motionControllerTouchMaterial",this._options.motionControllerTouchMaterialSnippetUrl,t):lZ.ParseFromSnippetAsync("8RUNKL#3",t)).then(e=>{i.material=e}).catch(e=>{re.Y.Warn(`Error creating touch material in WebXRNearInteraction: ${e}`)});let r=new rT;r.setEasingMode(rS.EASINGMODE_EASEINOUT);let s=new i1.P(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius).scaleInPlace(e),n=this._controllerPickRadius*(4/3),a=new i1.P(n,n,n).scaleInPlace(e),o=this._controllerPickRadius*(7/6),l=new i1.P(o,o,o).scaleInPlace(e),c=.8*this._controllerPickRadius,u=new i1.P(c,c,c).scaleInPlace(e),h=1.5*this._controllerPickRadius,d=[{frame:0,value:s},{frame:10,value:new i1.P(h,h,h).scaleInPlace(e)},{frame:18,value:a}],f=[{frame:0,value:a},{frame:10,value:u},{frame:18,value:s}],p=[{frame:0,value:i1.P.ZeroReadOnly},{frame:12,value:l},{frame:15,value:s}],m=[{frame:0,value:s},{frame:10,value:i1.P.ZeroReadOnly},{frame:15,value:i1.P.ZeroReadOnly}],_=new r_.fw("touch","scaling",60,r_.fw.ANIMATIONTYPE_VECTOR3,r_.fw.ANIMATIONLOOPMODE_CONSTANT),g=new r_.fw("release","scaling",60,r_.fw.ANIMATIONTYPE_VECTOR3,r_.fw.ANIMATIONLOOPMODE_CONSTANT),v=new r_.fw("hydrate","scaling",60,r_.fw.ANIMATIONTYPE_VECTOR3,r_.fw.ANIMATIONLOOPMODE_CONSTANT),S=new r_.fw("dehydrate","scaling",60,r_.fw.ANIMATIONTYPE_VECTOR3,r_.fw.ANIMATIONLOOPMODE_CONSTANT);return _.setEasingFunction(r),g.setEasingFunction(r),v.setEasingFunction(r),S.setEasingFunction(r),_.setKeys(d),g.setKeys(f),v.setKeys(p),S.setKeys(m),{touchCollisionMesh:i,touchCollisionMeshFunction:e=>{t.beginDirectAnimation(i,[e?_:g],0,18,!1,1)},hydrateCollisionMeshFunction:e=>{e&&(i.isVisible=!0),t.beginDirectAnimation(i,[e?v:S],0,15,!1,1,()=>{e||(i.isVisible=!1)})}}}_pickWithSphere(e,t,i,r){let s=new nR.p;if(s.distance=Infinity,e.touchCollisionMesh&&e.xrController){let n=e.touchCollisionMesh.position,a=nB.K.CreateFromCenterAndRadius(n,t);for(let t=0;t<i.meshes.length;t++){let n=i.meshes[t];if(!r(n)||!this._controllerAvailablePredicate(n,e.xrController.uniqueId))continue;let o=l0.PickMeshWithSphere(n,a);o&&o.hit&&o.distance<s.distance&&(s.hit=o.hit,s.pickedMesh=n,s.pickedPoint=o.pickedPoint,s.aimTransform=e.xrController.pointer,s.gripTransform=e.xrController.grip||null,s.originMesh=e.touchCollisionMesh,s.distance=o.distance,s.bu=o.bu,s.bv=o.bv,s.faceId=o.faceId,s.subMeshId=o.subMeshId)}}return s}static PickMeshWithSphere(e,t,i=!1){let r,s,n,a;let o=e.subMeshes,l=new nR.p,c=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!c||!i&&!nB.K.Intersects(c.boundingSphere,t))return l;let u=i1.jp.Vector3[0],h=i1.jp.Vector3[1],d=new nr.zH(i1.P.Zero(),i1.P.Zero(),1),f=Infinity,p=i1.jp.Vector3[2],m=i1.jp.Matrix[0];m.copyFrom(e.getWorldMatrix()),m.invert(),i1.P.TransformCoordinatesToRef(t.center,m,p);for(let i=0;i<o.length;i++)o[i].projectToRef(p,e._positions,e.getIndices(),h),i1.P.TransformCoordinatesToRef(h,e.getWorldMatrix(),h),r=i1.P.Distance(h,t.center),n=i1.P.Distance(h,e.getAbsolutePosition()),-1!==(s=i1.P.Distance(t.center,e.getAbsolutePosition()))&&-1!==n&&n>s&&(r=0,h.copyFrom(t.center)),-1!==r&&r<f&&(f=r,nr.zH.CreateFromToToRef(t.center,h,d),d.length=2*f,a=d.intersectsMesh(e),u.copyFrom(h));return f<t.radius&&(l.hit=!0,l.distance=f,l.pickedMesh=e,l.pickedPoint=u.clone(),a&&null!==a.bu&&null!==a.bv&&(l.faceId=a.faceId,l.subMeshId=a.subMeshId,l.bu=a.bu,l.bv=a.bv)),l}}l0._IdCounter=200,l0.Name=ll.b.NEAR_INTERACTION,l0.Version=1,ll.d.AddWebXRFeature(l0.Name,(e,t)=>()=>new l0(e,t),l0.Version,!0);class l1{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class l2{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new i0.y$,this._onSessionGranted=e=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),"undefined"!=typeof window&&window.location&&"http:"===window.location.protocol&&"localhost"!==window.location.hostname)throw rD.w1.Warn("WebXR can only be served over HTTPS"),Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";let e=t.sessionMode||"immersive-vr",i=t.referenceSpaceType||"local-floor",r=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+("undefined"==typeof SVGSVGElement?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";r+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';let s=document.createElement("style");s.appendChild(document.createTextNode(r)),document.getElementsByTagName("head")[0].appendChild(s);let n=document.createElement("button");n.className="babylonVRicon",n.title=`${e} - ${i}`,this._buttons.push(new l1(n,e,i)),this._buttons[this._buttons.length-1].update=function(e){this.element.style.display=null===e||e===this?"":"none",n.className="babylonVRicon"+(e===this?" vrdisplaypresenting":"")},this._updateButtons(null)}let i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;let i=this._buttons.map(t=>e.sessionManager.isSessionSupportedAsync(t.sessionMode));e.onStateChangedObservable.add(e=>{3==e&&this._updateButtons(null)}),(await Promise.all(i)).forEach((e,t)=>{e?(this.overlay.appendChild(this._buttons[t].element),this._buttons[t].element.onclick=this._enterXRWithButtonIndex.bind(this,t)):rD.w1.Warn(`Session mode "${this._buttons[t].sessionMode}" not supported in browser`)})}static async CreateAsync(e,t,i){let r=new l2(e,i);return await r.setHelperAsync(t,i.renderTarget||void 0),r}async _enterXRWithButtonIndex(e=0){if(2==this._helper.state)await this._helper.exitXRAsync(),this._updateButtons(null);else if(3==this._helper.state)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(r){this._updateButtons(null);let t=this._buttons[e].element,i=t.title;t.title="Error entering XR session : "+i,t.classList.add("xr-error"),this.options.onError&&this.options.onError(r)}}dispose(){let e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach(e=>{e.update(this._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}var l3=i(62317);(eo=t4||(t4={})).WRIST="wrist",eo.THUMB="thumb",eo.INDEX="index",eo.MIDDLE="middle",eo.RING="ring",eo.LITTLE="little",(el=t5||(t5={})).WRIST="wrist",el.THUMB_METACARPAL="thumb-metacarpal",el.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",el.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",el.THUMB_TIP="thumb-tip",el.INDEX_FINGER_METACARPAL="index-finger-metacarpal",el.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",el.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",el.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",el.INDEX_FINGER_TIP="index-finger-tip",el.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",el.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",el.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",el.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",el.MIDDLE_FINGER_TIP="middle-finger-tip",el.RING_FINGER_METACARPAL="ring-finger-metacarpal",el.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",el.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",el.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",el.RING_FINGER_TIP="ring-finger-tip",el.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",el.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",el.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",el.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",el.PINKY_FINGER_TIP="pinky-finger-tip";let l4=["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"],l5={wrist:["wrist"],thumb:["thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip"],index:["index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip"],middle:["middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip"],ring:["ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip"],little:["pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"]};class l7{get handMesh(){return this._handMesh}getHandPartMeshes(e){return l5[e].map(e=>this._jointMeshes[l4.indexOf(e)])}getJointMesh(e){return this._jointMeshes[l4.indexOf(e)]}constructor(e,t,i,r,s=!1,n=!1,a=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=r,this._leftHandedMeshes=s,this._jointsInvisible=n,this._jointScaleFactor=a,this.onHandMeshSetObservable=new i0.y$,this._jointTransforms=Array(l4.length),this._jointTransformMatrices=new Float32Array(16*l4.length),this._tempJointMatrix=new i1.y3,this._jointRadii=new Float32Array(l4.length),this._scene=t[0].getScene();for(let e=0;e<this._jointTransforms.length;e++)this._jointTransforms[e]=new rR.Y(l4[e],this._scene),this._jointTransforms[e].rotationQuaternion=new i1._f,t[e].rotationQuaternion?t[e].rotationQuaternion=new i1._f:t[e].rotationQuaternion?.set(0,0,0,1);i&&this.setHandMesh(i,r),this.xrController.motionController&&this.xrController.motionController.rootMesh&&this.xrController.motionController.rootMesh.dispose(!1,!0),this.xrController.onMotionControllerInitObservable.add(e=>{e._doNotLoadControllerMesh=!0})}setHandMesh(e,t,i){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach(e=>{e.alwaysSelectAsActiveMesh=!0}),this._handMesh.skeleton){let e=this._handMesh.skeleton;l4.forEach((i,r)=>{let s=e.getBoneIndexByName(t?t[i]:i);-1!==s&&e.bones[s].linkTransformNode(this._jointTransforms[r])})}this.onHandMeshSetObservable.notifyObservers(this)}updateFromXRFrame(e,t){let i=this.xrController.inputSource.hand;if(!i)return;let r=l4.map(e=>i[e]||i.get(e)),s=!1;if(e.fillPoses&&e.fillJointRadii)s=e.fillPoses(r,t,this._jointTransformMatrices)&&e.fillJointRadii(r,this._jointRadii);else if(e.getJointPose){s=!0;for(let i=0;i<r.length;i++){let n=e.getJointPose(r[i],t);if(n)this._jointTransformMatrices.set(n.transform.matrix,16*i),this._jointRadii[i]=n.radius||.008;else{s=!1;break}}}s&&(l4.forEach((e,t)=>{let i=this._jointTransforms[t];i1.y3.FromArrayToRef(this._jointTransformMatrices,16*t,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,i.rotationQuaternion,i.position);let r=this._jointRadii[t]*this._jointScaleFactor,s=this._jointMeshes[t];s.isVisible=!this._handMesh&&!this._jointsInvisible,s.position.copyFrom(i.position),s.rotationQuaternion.copyFrom(i.rotationQuaternion),s.scaling.setAll(r),!this._scene.useRightHandedSystem&&(s.position.z*=-1,s.rotationQuaternion.z*=-1,s.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(i.position.z*=-1,i.rotationQuaternion.z*=-1,i.rotationQuaternion.w*=-1))}),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(e=!1){this._handMesh&&(e?(this._handMesh.skeleton?.dispose(),this._handMesh.dispose(!1,!0)):this._handMesh.isVisible=!1),this._jointTransforms.forEach(e=>e.dispose()),this._jointTransforms.length=0}}class l6 extends lE{static _GenerateTrackedJointMeshes(e,t=(0,l3.Au)("jointParent",l6._ICOSPHERE_PARAMS)){let i={};return["left","right"].map(r=>{let s=[];t.isVisible=!!e.jointMeshes?.keepOriginalVisible;for(let i=0;i<l4.length;++i){let n=t.createInstance(`${r}-handJoint-${i}`);if(e.jointMeshes?.onHandJointMeshGenerated){let t=e.jointMeshes.onHandJointMeshGenerated(n,i,r);t&&t!==n&&(n.dispose(),n=t)}if(n.isPickable=!1,e.jointMeshes?.enablePhysics){let t=e.jointMeshes?.physicsProps||{};n.scaling.setAll(.02);let i=void 0!==t.impostorType?t.impostorType:nq.SphereImpostor;n.physicsImpostor=new nq(n,i,{mass:0,...t})}n.rotationQuaternion=new i1._f,n.isVisible=!1,s.push(n)}i[r]=s}),{left:i.left,right:i.right}}static _GenerateDefaultHandMeshesAsync(e,t,i){return new Promise(async r=>{let s={};l6._RightHandGLB?.meshes[1]?.isDisposed()&&(l6._RightHandGLB=null),l6._LeftHandGLB?.meshes[1]?.isDisposed()&&(l6._LeftHandGLB=null);let n=!!(l6._RightHandGLB&&l6._LeftHandGLB),a=await Promise.all([l6._RightHandGLB||lh.n0.ImportMeshAsync("",l6.DEFAULT_HAND_MODEL_BASE_URL,l6.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),l6._LeftHandGLB||lh.n0.ImportMeshAsync("",l6.DEFAULT_HAND_MODEL_BASE_URL,l6.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);l6._RightHandGLB=a[0],l6._LeftHandGLB=a[1];let o=await lZ.ParseFromFileAsync("handShader",l6.DEFAULT_HAND_MODEL_SHADER_URL,e,void 0,!0);o.needDepthPrePass=!0,o.transparencyMode=n0.F.MATERIAL_ALPHABLEND,o.alphaMode=2,o.build(!1);let l={base:i2.Wo.FromInts(116,63,203),fresnel:i2.Wo.FromInts(149,102,229),fingerColor:i2.Wo.FromInts(177,130,255),tipFresnel:i2.Wo.FromInts(220,200,255),...i?.handMeshes?.customColors},c={base:o.getBlockByName("baseColor"),fresnel:o.getBlockByName("fresnelColor"),fingerColor:o.getBlockByName("fingerColor"),tipFresnel:o.getBlockByName("tipFresnelColor")};c.base.value=l.base,c.fresnel.value=l.fresnel,c.fingerColor.value=l.fingerColor,c.tipFresnel.value=l.tipFresnel;let u=t._getBaseLayerWrapper()?.isMultiview;["left","right"].forEach(t=>{let r="left"==t?l6._LeftHandGLB:l6._RightHandGLB;if(!r)throw Error("Could not load hand model");let a=r.meshes[1];a._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,u||i?.handMeshes?.disableHandShader||(a.material=o.clone(`${t}HandShaderClone`,!0)),a.isVisible=!1,s[t]=a,n||e.useRightHandedSystem||r.meshes[1].rotate(r9.RD.Y,Math.PI)}),o.dispose(),r({left:s.left,right:s.right})})}static _GenerateDefaultHandMeshRigMapping(e){let t="right"==e?"R":"L";return{wrist:`wrist_${t}`,"thumb-metacarpal":`thumb_metacarpal_${t}`,"thumb-phalanx-proximal":`thumb_proxPhalanx_${t}`,"thumb-phalanx-distal":`thumb_distPhalanx_${t}`,"thumb-tip":`thumb_tip_${t}`,"index-finger-metacarpal":`index_metacarpal_${t}`,"index-finger-phalanx-proximal":`index_proxPhalanx_${t}`,"index-finger-phalanx-intermediate":`index_intPhalanx_${t}`,"index-finger-phalanx-distal":`index_distPhalanx_${t}`,"index-finger-tip":`index_tip_${t}`,"middle-finger-metacarpal":`middle_metacarpal_${t}`,"middle-finger-phalanx-proximal":`middle_proxPhalanx_${t}`,"middle-finger-phalanx-intermediate":`middle_intPhalanx_${t}`,"middle-finger-phalanx-distal":`middle_distPhalanx_${t}`,"middle-finger-tip":`middle_tip_${t}`,"ring-finger-metacarpal":`ring_metacarpal_${t}`,"ring-finger-phalanx-proximal":`ring_proxPhalanx_${t}`,"ring-finger-phalanx-intermediate":`ring_intPhalanx_${t}`,"ring-finger-phalanx-distal":`ring_distPhalanx_${t}`,"ring-finger-tip":`ring_tip_${t}`,"pinky-finger-metacarpal":`little_metacarpal_${t}`,"pinky-finger-phalanx-proximal":`little_proxPhalanx_${t}`,"pinky-finger-phalanx-intermediate":`little_intPhalanx_${t}`,"pinky-finger-phalanx-distal":`little_distPhalanx_${t}`,"pinky-finger-tip":`little_tip_${t}`}}isCompatible(){return"undefined"!=typeof XRHand}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return"none"==e?null:this._trackingHands[e]}constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this._worldScaleObserver=null,this.onHandAddedObservable=new i0.y$,this.onHandRemovedObservable=new i0.y$,this._attachHand=e=>{if(!e.inputSource.hand||"none"==e.inputSource.handedness||!this._handResources.jointMeshes)return;let t=e.inputSource.handedness,i=new l7(e,this._handResources.jointMeshes[t],this._handResources.handMeshes&&this._handResources.handMeshes[t],this._handResources.rigMappings&&this._handResources.rigMappings[t],this.options.handMeshes?.meshesUseLeftHandedCoordinates,this.options.jointMeshes?.invisible,this.options.jointMeshes?.scaleFactor);this._attachedHands[e.uniqueId]=i,this._trackingHands[t]=i,this.onHandAddedObservable.notifyObservers(i)},this._detachHand=e=>{this._detachHandById(e.uniqueId)},this.xrNativeFeatureName="hand-tracking";let i=t.jointMeshes;if(i&&(void 0!==i.disableDefaultHandMesh&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=i.disableDefaultHandMesh),void 0!==i.handMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=i.handMeshes),void 0!==i.leftHandedSystemMeshes&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=i.leftHandedSystemMeshes),void 0!==i.rigMapping)){t.handMeshes=t.handMeshes||{};let e={},r={};[[i.rigMapping.left,e],[i.rigMapping.right,r]].forEach(e=>{let t=e[0],i=e[1];t.forEach((e,t)=>{i[l4[t]]=e})}),t.handMeshes.customRigMappings={left:e,right:r}}}attach(){return!!super.attach()&&(this._handResources.jointMeshes||(this._originalMesh=this._originalMesh||this.options.jointMeshes?.sourceMesh||(0,l3.Au)("jointParent",l6._ICOSPHERE_PARAMS),this._originalMesh.isVisible=!1,this._handResources.jointMeshes=l6._GenerateTrackedJointMeshes(this.options,this._originalMesh)),this._handResources.handMeshes=this.options.handMeshes?.customMeshes||null,this._handResources.rigMappings=this.options.handMeshes?.customRigMappings||null,this.options.handMeshes?.customMeshes||this.options.handMeshes?.disableDefaultMeshes||(l6._GenerateDefaultHandMeshesAsync(rh.l.LastCreatedScene,this._xrSessionManager,this.options).then(e=>{this._handResources.handMeshes=e,this._handResources.rigMappings={left:l6._GenerateDefaultHandMeshRigMapping("left"),right:l6._GenerateDefaultHandMeshRigMapping("right")},this._trackingHands.left?.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left,this._xrSessionManager),this._trackingHands.right?.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right,this._xrSessionManager),this._handResources.handMeshes.left.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._handResources.handMeshes.right.scaling.setAll(this._xrSessionManager.worldScalingFactor)}),this._worldScaleObserver=this._xrSessionManager.onWorldScaleFactorChangedObservable.add(e=>{this._handResources.handMeshes&&(this._handResources.handMeshes.left.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor),this._handResources.handMeshes.right.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor))})),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0)}_onXRFrame(e){this._trackingHands.left?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),this._trackingHands.right?.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e,t){let i=this.getHandByControllerId(e);if(i){let r="left"==i.xrController.inputSource.handedness?"left":"right";this._trackingHands[r]?.xrController.uniqueId===e&&(this._trackingHands[r]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(t),delete this._attachedHands[e]}}detach(){return!!super.detach()&&(Object.keys(this._attachedHands).forEach(e=>this._detachHandById(e,this.options.handMeshes?.disposeOnSessionEnd)),this.options.handMeshes?.disposeOnSessionEnd&&(this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(e=>e.dispose()),this._handResources.jointMeshes.right.forEach(e=>e.dispose()),this._handResources.jointMeshes=null),this._handResources.handMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),this._handResources.handMeshes=null),l6._RightHandGLB?.meshes.forEach(e=>e.dispose()),l6._LeftHandGLB?.meshes.forEach(e=>e.dispose()),l6._RightHandGLB=null,l6._LeftHandGLB=null,this._originalMesh?.dispose(),this._originalMesh=void 0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver),!0)}dispose(){super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!this.options.handMeshes?.customMeshes&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),l6._RightHandGLB?.meshes.forEach(e=>e.dispose()),l6._LeftHandGLB?.meshes.forEach(e=>e.dispose()),l6._RightHandGLB=null,l6._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(e=>e.dispose()),this._handResources.jointMeshes.right.forEach(e=>e.dispose()))}}function l8(e){let t=0,i=Date.now();e.observableParameters=e.observableParameters??{};let r=e.contextObservable.add(s=>{let n=Date.now();t=n-i;let a={startTime:i,currentTime:n,deltaTime:t,completeRate:t/e.timeout,payload:s};e.onTick&&e.onTick(a),e.breakCondition&&e.breakCondition()&&(e.contextObservable.remove(r),e.onAborted&&e.onAborted(a)),t>=e.timeout&&(e.contextObservable.remove(r),e.onEnded&&e.onEnded(a))},e.observableParameters.mask,e.observableParameters.insertFirst,e.observableParameters.scope);return r}l6.Name=ll.b.HAND_TRACKING,l6.Version=1,l6.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/",l6.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb",l6.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb",l6.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json",l6._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2},l6._RightHandGLB=null,l6._LeftHandGLB=null,ll.d.AddWebXRFeature(l6.Name,(e,t)=>()=>new l6(e,t),l6.Version,!1),(ec=t7||(t7={}))[ec.INIT=0]="INIT",ec[ec.STARTED=1]="STARTED",ec[ec.ENDED=2]="ENDED";class l9{constructor(e){this.onEachCountObservable=new i0.y$,this.onTimerAbortedObservable=new i0.y$,this.onTimerEndedObservable=new i0.y$,this.onStateChangedObservable=new i0.y$,this._observer=null,this._breakOnNextTick=!1,this._tick=e=>{let t=Date.now();this._timer=t-this._startTime;let i={startTime:this._startTime,currentTime:t,deltaTime:this._timer,completeRate:this._timer/this._timeToEnd,payload:e},r=this._breakOnNextTick||this._breakCondition(i);r||this._timer>=this._timeToEnd?this._stop(i,r):this.onEachCountObservable.notifyObservers(i)},this._setState(0),this._contextObservable=e.contextObservable,this._observableParameters=e.observableParameters??{},this._breakCondition=e.breakCondition??(()=>!1),this._timeToEnd=e.timeout,e.onEnded&&this.onTimerEndedObservable.add(e.onEnded),e.onTick&&this.onEachCountObservable.add(e.onTick),e.onAborted&&this.onTimerAbortedObservable.add(e.onAborted)}set breakCondition(e){this._breakCondition=e}clearObservables(){this.onEachCountObservable.clear(),this.onTimerAbortedObservable.clear(),this.onTimerEndedObservable.clear(),this.onStateChangedObservable.clear()}start(e=this._timeToEnd){if(1===this._state)throw Error("Timer already started. Please stop it before starting again");this._timeToEnd=e,this._startTime=Date.now(),this._timer=0,this._observer=this._contextObservable.add(this._tick,this._observableParameters.mask,this._observableParameters.insertFirst,this._observableParameters.scope),this._setState(1)}stop(){1===this._state&&(this._breakOnNextTick=!0)}dispose(){this._observer&&this._contextObservable.remove(this._observer),this.clearObservables()}_setState(e){this._state=e,this.onStateChangedObservable.notifyObservers(this._state)}_stop(e,t=!1){this._contextObservable.remove(this._observer),this._setState(2),t?this.onTimerAbortedObservable.notifyObservers(e):this.onTimerEndedObservable.notifyObservers(e)}}class ce extends lE{get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){let t=this._options.teleportationTargetMesh.getChildMeshes(!1,e=>"rotationCone"===e.name);t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._cachedColor4White=new i2.HE(1,1,1,1),this._tmpRay=new nr.zH(new i1.P,new i1.P),this._tmpVector=new i1.P,this._tmpQuaternion=new i1._f,this._worldScaleObserver=null,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new i0.y$,this.teleportationEnabled=!0,this._rotationEnabled=!0,this.onBeforeCameraTeleportRotation=new i0.y$,this.onAfterCameraTeleportRotation=new i0.y$,this._attachController=e=>{if(this._controllers[e.uniqueId]||this._options.forceHandedness&&e.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[e.uniqueId]={xrController:e,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0,blocked:!1,initialHit:!1,mainComponentUsed:!1}};let t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){let i=()=>{if(e.motionController){let i=e.motionController.getComponentOfType(lu.THUMBSTICK_TYPE)||e.motionController.getComponentOfType(lu.TOUCHPAD_TYPE);if(!i||this._options.useMainComponentOnly){let i=e.motionController.getMainComponent();if(!i)return;t.teleportationState.mainComponentUsed=!0,t.teleportationComponent=i,t.onButtonChangedObserver=i.onButtonStateChangedObservable.add(()=>{if(!this.teleportationEnabled)return;let r=()=>{t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,l8({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!i.pressed,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};i.changes.pressed&&(i.changes.pressed.current?this._options.timeToTeleportStart?l8({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{i.pressed&&r()}}):r():(t.teleportationState.forward=!1,this._currentTeleportationControllerId=""))})}else t.teleportationComponent=i,t.onAxisChangedObserver=i.onAxisValueChangedObservable.add(i=>{if(i.y<=.7&&t.teleportationState.backwards&&(t.teleportationState.backwards=!1),i.y>.7&&!t.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!t.teleportationState.backwards){t.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,i1._f.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);let e=this._xrSessionManager.scene.pickWithRay(this._tmpRay,e=>-1!==this._floorMeshes.indexOf(e));e&&e.pickedPoint&&(this._options.xrInput.xrCamera.position.x=e.pickedPoint.x,this._options.xrInput.xrCamera.position.z=e.pickedPoint.z)}if(i.y<-.7&&!this._currentTeleportationControllerId&&!t.teleportationState.rotating&&this.teleportationEnabled&&(t.teleportationState.forward=!0,this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),i.x){if(t.teleportationState.forward)this._currentTeleportationControllerId===t.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{t.teleportationState.currentRotation=Math.atan2(i.x,i.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):t.teleportationState.currentRotation=0);else if(!t.teleportationState.rotating&&Math.abs(i.x)>.7){t.teleportationState.rotating=!0;let e=this.rotationAngle*(i.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this.onBeforeCameraTeleportRotation.notifyObservers(e),i1._f.FromEulerAngles(0,e,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleportRotation.notifyObservers(this._options.xrInput.xrCamera.rotationQuaternion)}}else t.teleportationState.rotating=!1;0===i.x&&0===i.y&&(t.teleportationState.blocked&&(t.teleportationState.blocked=!1,this._setTargetMeshVisibility(!1)),t.teleportationState.forward&&this._teleportForward(e.uniqueId))})}};e.motionController?i():e.onMotionControllerInitObservable.addOnce(()=>{i()})}else{t.teleportationState.mainComponentUsed=!0;let i=!1,r=()=>{this._currentTeleportationControllerId=t.xrController.uniqueId,t.teleportationState.forward=!0,t.teleportationState.initialHit=!1,t.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,t.teleportationState.currentRotation=0,l8({timeout:this._options.timeToTeleport||3e3,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&t.teleportationState.forward&&this._teleportForward(e.uniqueId)}})};this._xrSessionManager.scene.onPointerObservable.add(e=>{e.type===r1.kD.POINTERDOWN?(i=!1,this._options.timeToTeleportStart?l8({timeout:this._options.timeToTeleportStart,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===t.xrController.uniqueId&&r()},breakCondition:()=>!!i&&(i=!1,!0)}):r()):e.type===r1.kD.POINTERUP&&(i=!0,t.teleportationState.forward=!1,this._currentTeleportationControllerId="")})}},this._colorArray=Array(24).fill(this._cachedColor4White),this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._blockedRayColor=this._options.blockedRayColor||new i2.HE(1,0,0,.75),this._setTargetMeshVisibility(!1),this.onBeforeCameraTeleport=t.xrInput.xrCamera.onBeforeCameraTeleport,this.onAfterCameraTeleport=t.xrInput.xrCamera.onAfterCameraTeleport,this.parabolicCheckRadius*=this._xrSessionManager.worldScalingFactor,this._worldScaleObserver=e.onWorldScaleFactorChangedObservable.add(e=>{this.parabolicCheckRadius=this.parabolicCheckRadius/e.previousScaleFactor*e.newScaleFactor,this._options.teleportationTargetMesh?.scaling.scaleInPlace(e.newScaleFactor/e.previousScaleFactor)})}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return!!super.attach()&&(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0)}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0),this._worldScaleObserver&&this._xrSessionManager.onWorldScaleFactorChangedObservable.remove(this._worldScaleObserver)}removeFloorMesh(e){let t=this._floorMeshes.indexOf(e);-1!==t&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];let t=this._options.pickBlockerMeshes.indexOf(e);-1!==t&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){let t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(-1===t){for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return -1!==t&&(this._snapToPositions.splice(t,1),!0)}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){let t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;let r=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!r)return;r.rotationQuaternion=r.rotationQuaternion||new i1._f;let e=this._controllers[this._currentTeleportationControllerId];if(e&&e.teleportationState.forward){i1._f.RotationYawPitchRollToRef(e.teleportationState.currentRotation+e.teleportationState.baseRotation,0,0,r.rotationQuaternion);let t=!1,s="transient-pointer"!==e.xrController.inputSource.targetRayMode;if(e.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){let r=i.pickWithRay(this._tmpRay,e=>{if(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(e)||this._options.blockAllPickableMeshes&&e.isPickable||this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(e))return!0;let t=this._floorMeshes.indexOf(e);return -1!==t&&this._floorMeshes[t].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y}),n=r&&r.pickedMesh&&-1!==this._floorMeshes.indexOf(r.pickedMesh);if(r&&r.pickedMesh&&!n){if(e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit){e.teleportationState.forward=!1;return}e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,s),this._showParabolicPath(r);return}r&&r.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(r),this._setTargetMeshVisibility(!0,!1,s),this._showParabolicPath(r))}if(this.parabolicRayEnabled&&!t){let r=e.xrController.pointer.rotationQuaternion.toEulerAngles().x,n=this.parabolicCheckRadius*(1+(Math.PI/2-Math.abs(r)));this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(2*n),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(n)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();let a=i.pickWithRay(this._tmpRay,e=>!!(this._options.blockerMeshesPredicate&&this._options.blockerMeshesPredicate(e))||!!this._options.blockAllPickableMeshes&&!!e.isPickable||!!this._options.pickBlockerMeshes&&-1!==this._options.pickBlockerMeshes.indexOf(e)||-1!==this._floorMeshes.indexOf(e)),o=a&&a.pickedMesh&&-1!==this._floorMeshes.indexOf(a.pickedMesh);if(a&&a.pickedMesh&&!o){if(e.teleportationState.mainComponentUsed&&!e.teleportationState.initialHit){e.teleportationState.forward=!1;return}e.teleportationState.blocked=!0,this._setTargetMeshVisibility(!1,!1,s),this._showParabolicPath(a);return}a&&a.pickedPoint&&(e.teleportationState.initialHit=!0,e.teleportationState.blocked=!1,t=!0,this._setTargetMeshPosition(a),this._setTargetMeshVisibility(!0,!1,s),this._showParabolicPath(a))}this._setTargetMeshVisibility(t,!1,s)}else this._setTargetMeshVisibility(!1,!1,!0)}else this._disposeBezierCurve(),this._setTargetMeshVisibility(!1,!1,!0)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};let e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nW.x.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=(0,nv.$6)("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{let i=new na.c("teleportationPlaneDynamicTexture",512,e,!0);i.hasAlpha=!0;let r=i.getContext();r.beginPath(),r.arc(256,256,200,0,2*Math.PI,!1),r.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",r.fill(),r.lineWidth=10,r.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",r.stroke(),r.closePath(),i.update();let s=new nn.K("teleportationPlaneMaterial",e);s.diffuseTexture=i,t.material=s}let i=(0,nS.eu)("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){let t=new r_.fw("animationInnerCircle","position.y",30,r_.fw.ANIMATIONTYPE_FLOAT,r_.fw.ANIMATIONLOOPMODE_CYCLE),r=[];r.push({frame:0,value:0}),r.push({frame:30,value:.4}),r.push({frame:60,value:0}),t.setKeys(r);let s=new rb;s.setEasingMode(rS.EASINGMODE_EASEINOUT),t.setEasingFunction(s),i.animations=[],i.animations.push(t),e.beginAnimation(i,0,60,!0)}let r=(0,nz.wf)("rotationCone",{diameterTop:0,tessellation:4},e);if(r.isPickable=!1,r.scaling.set(.5,.12,.2),r.rotate(r9.RD.X,Math.PI/2),r.position.z=.6,r.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,r.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{let t=new nn.K("torusConsMat",e);t.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,t.disableLighting?t.emissiveColor=new i2.Wo(.3,.3,1):t.diffuseColor=new i2.Wo(.3,.3,1),t.alpha=.9,i.material=t,r.material=t,this._teleportationRingMaterial=t}void 0!==this._options.renderingGroupId&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t,this._options.teleportationTargetMesh.scaling.setAll(this._xrSessionManager.worldScalingFactor),this._setTargetMeshVisibility(!1)}_detachController(e){let t=this._controllers[e];t&&(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,r=Number.MAX_VALUE;if(this._snapToPositions.length){let s=t*t;this._snapToPositions.forEach(t=>{let n=i1.P.DistanceSquared(t,e);n<=s&&n<r&&(r=n,i=t)})}return i}_setTargetMeshPosition(e){let t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;let i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e,t,i){this._options.teleportationTargetMesh&&(this._options.teleportationTargetMesh.isVisible!==e||t)&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(t=>{t.isVisible=e}),e?this._selectionFeature&&i&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&i&&this._selectionFeature.attach()))}_disposeBezierCurve(){this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null)}_showParabolicPath(e){if(!e.pickedPoint||!this._currentTeleportationControllerId)return;let t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||nW.x.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],r=rv.j_.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25),s=i.teleportationState.blocked?this._blockedRayColor:void 0,n=this._colorArray.fill(s||this._cachedColor4White),a=r.getPoints();a.shift(),a.shift(),this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(r.getPoints(),e):this._quadraticBezierCurve=(0,nJ.nL)("teleportation path line",{points:a,instance:this._quadraticBezierCurve,updatable:!0,colors:n},t),this._quadraticBezierCurve.isPickable=!1,void 0!==this._options.renderingGroupId&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){let t=this._controllers[e];if(t&&t.teleportationState.forward&&this.teleportationEnabled&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!this.snapPointsOnly||this._snappedToPoint)){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){let e=this._options.xrInput.xrCamera.realWorldHeight;this.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=e,i1._f.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}}ce.Name=ll.b.TELEPORTATION,ce.Version=1,ll.d.AddWebXRFeature(ce.Name,(e,t)=>()=>new ce(e,t),ce.Version,!0);class ct{constructor(){}static CreateAsync(e,t={}){let i=new ct;if(e.onDisposeObservable.addOnce(()=>{i.dispose()}),!t.disableDefaultUI){let r={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&("boolean"==typeof t.optionalFeatures?r.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:r.optionalFeatures=t.optionalFeatures),i.enterExitUI=new l2(e,r)}return lc.CreateAsync(e).then(e=>{if(i.baseExperience=e,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new lx(e.sessionManager,e.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){let e={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(lC.Name,t.useStablePlugins?"stable":"latest",e),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(ce.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}return(t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(l0.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),t.disableHandTracking||i.baseExperience.featuresManager.enableFeature(l6.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,...t.handSupportOptions},void 0,!1),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),t.disableDefaultUI)?void 0:i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(()=>i).catch(e=>(re.Y.Error("Error initializing XR"),re.Y.Error(e),i))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}function ci(e){for(;e.firstChild;)e.removeChild(e.firstChild);e.srcObject=null,e.src="",e.removeAttribute("src")}rH.x.prototype.createDefaultLight=function(e=!1){if(e&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();0===this.lights.length&&new o$.e("default light",i1.P.Up(),this)},rH.x.prototype.createDefaultCamera=function(e=!1,t=!1,i=!1){if(t&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){let t;let r=this.getWorldExtends(e=>e.isVisible&&e.isEnabled()),s=r.max.subtract(r.min),n=r.min.add(s.scale(.5)),a=1.5*s.length();if(isFinite(a)||(a=1,n.copyFromFloats(0,0,0)),e){let e=new sT("default camera",-(Math.PI/2),Math.PI/2,a,n,this);e.lowerRadiusLimit=.01*a,e.wheelPrecision=100/a,t=e}else{let e=new sE.c("default camera",new i1.P(n.x,n.y,-a),this);e.setTarget(n),t=e}t.minZ=.01*a,t.maxZ=1e3*a,t.speed=.2*a,this.activeCamera=t,i&&t.attachControl()}},rH.x.prototype.createDefaultCameraOrLight=function(e=!1,t=!1,i=!1){this.createDefaultLight(t),this.createDefaultCamera(e,t,i)},rH.x.prototype.createDefaultSkybox=function(e,t=!1,i=1e3,r=0,s=!0){if(!e)return re.Y.Warn("Can not create default skybox without environment texture."),null;s&&e&&(this.environmentTexture=e);let n=(0,nX.NR)("hdrSkyBox",{size:i},this);if(t){let t=new la.Y("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=rZ.x.SKYBOX_MODE),t.microSurface=1-r,t.disableLighting=!0,t.twoSidedLighting=!0,n.material=t}else{let t=new nn.K("skyBox",this);t.backFaceCulling=!1,t.reflectionTexture=e.clone(),t.reflectionTexture&&(t.reflectionTexture.coordinatesMode=rZ.x.SKYBOX_MODE),t.disableLighting=!0,n.material=t}return n.isPickable=!1,n.infiniteDistance=!0,n.ignoreCameraMaxZ=!0,n},rH.x.prototype.createDefaultEnvironment=function(e){return lr?new lr(e,this):null},rH.x.prototype.createDefaultVRExperience=function(e={}){return new nC(this,e)},rH.x.prototype.createDefaultXRExperienceAsync=function(e={}){return ct.CreateAsync(this,e).then(e=>e)};class cr extends rZ.x{get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new i0.y$),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e?.message):re.Y.Error(e?.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if(e?.name==="NotAllowedError"){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers()){this._onUserActionRequestedObservable.notifyObservers(this);return}if(!this.video.muted){re.Y.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,this.video.play().catch(e=>{this._processError(e)});return}}this._processError(e)})}constructor(e,t,i,r=!1,s=!1,n=rZ.x.TRILINEAR_SAMPLINGMODE,a={},o,l=5){super(null,i,!r,s),this._externalTexture=null,this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this.isVideo=!0,this._resizeInternalTexture=()=>{null!=this._texture&&this._texture.dispose(),!this._getEngine().needPOTTextures||rD.w1.IsExponentOfTwo(this.video.videoWidth)&&rD.w1.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=rZ.x.WRAP_ADDRESSMODE,this.wrapV=rZ.x.WRAP_ADDRESSMODE):(this.wrapU=rZ.x.CLAMP_ADDRESSMODE,this.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),this._texture.format=this._format??5,this._frameId=-1,this._updateInternalTexture()},this._createInternalTexture=()=>{if(null!=this._texture){if(!this._displayingPosterTexture)return;this._displayingPosterTexture=!1}if(this.video.addEventListener("resize",this._resizeInternalTexture),this._resizeInternalTexture(),this.video.autoplay||this._settings.poster||this._settings.independentVideoSource)this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this);else{let e=this.video.onplaying,t=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=t,this.video.onplaying=e,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}},this._reset=()=>{null!=this._texture&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(null==this._texture||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;let e=this.getScene().getFrameId();this._frameId!==e&&(this._frameId=e,this._getEngine().updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...a},this._onError=o,this._generateMipMaps=r,this._initialSamplingMode=n,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t);let c=this._engine,u=c?.createExternalTexture;u&&(this._externalTexture=u.call(c,this.video)),!this._settings.independentVideoSource&&(this._settings.poster&&(this.video.poster=this._settings.poster),void 0!==this._settings.autoPlay&&(this.video.autoplay=this._settings.autoPlay),void 0!==this._settings.loop&&(this.video.loop=this._settings.loop),void 0!==this._settings.muted&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("loadeddata",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._settings.autoPlay&&this._handlePlay()),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._format=l;let h=this.video.readyState>=this.video.HAVE_CURRENT_DATA;!this._settings.poster||this._settings.autoPlay&&h?h&&this._createInternalTexture():(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0)}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:"object"==typeof e?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return rD.w1.SetCorsBehavior(e.currentSrc,e),e;let t=document.createElement("video");return"string"==typeof e?(rD.w1.SetCorsBehavior(e,t),t.src=e):(rD.w1.SetCorsBehavior(e[0],t),e.forEach(e=>{let i=document.createElement("source");i.src=e,t.appendChild(i)})),this.onDisposeObservable.addOnce(()=>{ci(t)}),t}_rebuild(){this.update()}update(){this.autoUpdateTexture&&this.updateTexture(!0)}updateTexture(e){!e||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())}get externalTexture(){return this._externalTexture}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new cr(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.independentVideoSource||(this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("loadeddata",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.removeEventListener("resize",this._resizeInternalTexture),this.video.pause()),this._externalTexture?.dispose()}static CreateFromStreamAsync(e,t,i,r=!0){let s=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(s),s.style.transform="scale(0.0001, 0.0001)",s.style.opacity="0",s.style.position="fixed",s.style.bottom="0px",s.style.right="0px"),s.setAttribute("autoplay",""),s.setAttribute("muted","true"),s.setAttribute("playsinline",""),s.muted=!0,s.isNative||("object"==typeof s.srcObject?s.srcObject=t:s.src=window.URL&&window.URL.createObjectURL(t)),new Promise(t=>{let i=()=>{let n=new cr("video",s,e,!0,r,void 0,void 0,void 0,4);e.getEngine()._badOS&&n.onDisposeObservable.addOnce(()=>{s.remove()}),n.onDisposeObservable.addOnce(()=>{ci(s)}),t(n),s.removeEventListener("playing",i)};s.addEventListener("playing",i),s.play()})}static async CreateFromWebCamAsync(e,t,i=!1,r=!0){if(navigator.mediaDevices){let s=await navigator.mediaDevices.getUserMedia({video:t,audio:i}),n=await this.CreateFromStreamAsync(e,s,t,r);return n.onDisposeObservable.addOnce(()=>{s.getTracks().forEach(e=>{e.stop()})}),n}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,r=!1,s=!0){this.CreateFromWebCamAsync(e,i,r,s).then(function(e){t&&t(e)}).catch(function(e){re.Y.Error(e.name)})}}(0,r$.gn)([(0,rj.qC)("settings")],cr.prototype,"_settings",void 0),(0,r$.gn)([(0,rj.qC)("src")],cr.prototype,"_currentSrc",void 0),(0,r$.gn)([(0,rj.qC)()],cr.prototype,"isVideo",void 0),rZ.x._CreateVideoTexture=(e,t,i,r=!1,s=!1,n=rZ.x.TRILINEAR_SAMPLINGMODE,a={},o,l=5)=>new cr(e,t,i,r,s,n,a,o,l),(0,i3.H7)("BABYLON.VideoTexture",cr);class cs extends ls{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){let r={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},s=new cr((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,rZ.x.TRILINEAR_SAMPLINGMODE,r);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add(e=>{e.pickInfo?.pickedMesh===this.mesh&&this._texture.video.play()},r1.kD.POINTERDOWN)),this._textureObserver=s.onLoadObservable.add(()=>{this.onLoadObservable.notifyObservers()}),s}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}cs.MODE_MONOSCOPIC=ls.MODE_MONOSCOPIC,cs.MODE_TOPBOTTOM=ls.MODE_TOPBOTTOM,cs.MODE_SIDEBYSIDE=ls.MODE_SIDEBYSIDE;var cn=i(80527);i(4326);var ca=i(48895);rH.x.prototype.getHighlightLayerByName=function(e){for(let t=0;t<this.effectLayers?.length;t++)if(this.effectLayers[t].name===e&&this.effectLayers[t].getEffectName()===cl.EffectName)return this.effectLayers[t];return null};class co extends sD.D{constructor(e,t,i,r,s,n=rZ.x.BILINEAR_SAMPLINGMODE,a,o){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,r,s,n,a,o),this.direction=t,this.kernel=i,this.onApplyObservable.add(e=>{e.setFloat2("screenSize",this.width,this.height),e.setVector2("direction",this.direction),e.setFloat("blurWidth",this.kernel)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,54879)))):t.push(Promise.resolve().then(i.bind(i,5899))),super._gatherImports(e,t)}}class cl extends cn.w{set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}constructor(e,t,i){super(e,t,void 0!==i&&!!i.forceGLSL),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new i0.y$,this.onAfterBlurObservable=new i0.y$,this._instanceGlowingMeshStencilReference=cl.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=cl.NeutralColor,this._engine.isStencilEnable||re.Y.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,mainTextureType:0,forceGLSL:!1,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId,mainTextureType:this._options.mainTextureType}),this._shouldRender=!1}async _importShadersAsync(){1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,41903)),Promise.resolve().then(i.bind(i,75356)),Promise.resolve().then(i.bind(i,54879))]):await Promise.all([Promise.resolve().then(i.bind(i,27623)),Promise.resolve().then(i.bind(i,81442)),Promise.resolve().then(i.bind(i,5899))]),await super._importShadersAsync()}getEffectName(){return cl.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[st.o.PositionKind],["offset"],["textureSampler"],this._options.isStroke?"#define STROKE \n":void 0,void 0,void 0,void 0,void 0,this._shaderLanguage,this._shadersLoaded?void 0:async()=>{await this._importShadersAsync(),this._shadersLoaded=!0})}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?(0,oH.p7)(e,this._maxSize):e,t=this._engine.needPOTTextures?(0,oH.p7)(t,this._maxSize):t;let i=0;if(i=this._engine.getCaps().textureHalfFloatRender?2:0,this._blurTexture=new s2._("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(rZ.x.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],2===this._options.alphaBlendingMode)this._downSamplePostprocess=new sO.Q("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(e=>{e.setTexture("textureSampler",this._mainTexture)}),this._horizontalBlurPostprocess=new co("HighlightLayerHBP",new i1.FM(1,0),this._options.blurHorizontalSize,1,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",e,t)}),this._verticalBlurPostprocess=new co("HighlightLayerVBP",new i1.FM(0,1),this._options.blurVerticalSize,1,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",e,t)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess];else{this._horizontalBlurPostprocess=new o2.i("HighlightLayerHBP",new i1.FM(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i);let r=this._horizontalBlurPostprocess;r.width=e,r.height=t,r.externalTextureSamplerBinding=!0,r.onApplyObservable.add(e=>{e.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess=new o2.i("HighlightLayerVBP",new i1.FM(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]}this._mainTexture.onAfterUnbindObservable.add(()=>{this.onBeforeBlurObservable.notifyObservers(this);let e=this._blurTexture.renderTarget;e&&(this._scene.postProcessManager.directRender(this._postProcesses,e,!0),this._engine.unBindFramebuffer(e,!0)),this.onAfterBlurObservable.notifyObservers(this)}),this._postProcesses.map(e=>{e.autoClear=!1})}needStencil(){return!0}isReady(e,t){let i=e.getMaterial(),r=e.getRenderingMesh();if(!i||!r||!this._meshes)return!1;let s=null,n=this._meshes[r.uniqueId];return n&&n.glowEmissiveOnly&&i&&(s=i.emissiveTexture),super._isReady(e,t,s)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);let i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&0===t&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(n0.F.TriangleFillMode,0,6)),this.innerGlow&&1===t&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(n0.F.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return!!super.shouldRender()&&!!this._meshes}_shouldRenderMesh(e){return(!this._excludedMeshes||!this._excludedMeshes[e.uniqueId])&&!!super.hasMesh(e)}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){let r=this._meshes[e.uniqueId];r?this._emissiveTextureAndColor.color.set(r.color.r,r.color.g,r.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),r&&r.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(this._excludedMeshes&&!this._excludedMeshes[e.uniqueId]){let t={mesh:e,beforeBind:null,afterRender:null,stencilState:!1};t.beforeBind=e.onBeforeBindObservable.add(e=>{t.stencilState=e.getEngine().getStencilBuffer(),e.getEngine().setStencilBuffer(!1)}),t.afterRender=e.onAfterRenderObservable.add(e=>{e.getEngine().setStencilBuffer(t.stencilState)}),this._excludedMeshes[e.uniqueId]=t}}removeExcludedMesh(e){if(!this._excludedMeshes)return;let t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!!(this._meshes&&super.hasMesh(e))&&void 0!==this._meshes[e.uniqueId]&&null!==this._meshes[e.uniqueId]}addMesh(e,t,i=!1){if(!this._meshes)return;let r=this._meshes[e.uniqueId];r?r.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add(e=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]?this._defaultStencilReference(e):e.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(e=>{this.isEnabled&&this._defaultStencilReference(e)}),glowEmissiveOnly:i},e.onDisposeObservable.add(()=>{this._disposeMesh(e)})),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;let t=this._meshes[e.uniqueId];for(let i in t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1,this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}removeAllMeshes(){if(this._meshes){for(let e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){let t=this._meshes[e];t&&this.removeMesh(t.mesh)}}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(cl.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(let e in this._meshes){let t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(let e in this._excludedMeshes){let t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){let e=rq.p.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(let t in this._meshes){let i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(let t in this._excludedMeshes){let i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){let r;let s=rq.p.Parse(()=>new cl(e.name,t,e.options),e,t,i);for(r=0;r<e.excludedMeshes.length;r++){let i=t.getMeshById(e.excludedMeshes[r]);i&&s.addExcludedMesh(i)}for(r=0;r<e.meshes.length;r++){let i=e.meshes[r],n=t.getMeshById(i.meshId);n&&s.addMesh(n,i2.Wo.FromArray(i.color),i.glowEmissiveOnly)}return s}}cl.EffectName="HighlightLayer",cl.NeutralColor=new i2.HE(0,0,0,0),cl.GlowingMeshStencilReference=2,cl.NormalMeshStencilReference=1,(0,r$.gn)([(0,rj.qC)()],cl.prototype,"innerGlow",void 0),(0,r$.gn)([(0,rj.qC)()],cl.prototype,"outerGlow",void 0),(0,r$.gn)([(0,rj.qC)()],cl.prototype,"blurHorizontalSize",null),(0,r$.gn)([(0,rj.qC)()],cl.prototype,"blurVerticalSize",null),(0,r$.gn)([(0,rj.qC)("options")],cl.prototype,"_options",void 0),(0,i3.H7)("BABYLON.HighlightLayer",cl);var cc=i(53179);i(56692),i(20215),i(96884),i(37933),i(33758),i(27623),i(81442),i(5899),i(41903),i(75356),i(54879),i(94566),i(14337),i(48407),i(75439);var cu=i(83260);class ch{static AddFlare(e,t,i,r,s){return new ch(e,t,i,r,s)}constructor(e,t,i,r,s){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new i2.Wo(1,1,1),this.texture=r?new rZ.x(r,s.getScene(),!0):null,this._system=s;let n=s.scene.getEngine();s._onShadersLoaded.addOnce(()=>{this._drawWrapper=new cu.q(n),this._drawWrapper.effect=n.createEffect("lensFlare",[st.o.PositionKind],["color","viewportMatrix"],["textureSampler"],"",void 0,void 0,void 0,void 0,s.shaderLanguage)}),s.lensFlares.push(this)}dispose(){this.texture&&this.texture.dispose();let e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}class cd{get scene(){return this._scene}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this.name=e,this.lensFlares=[],this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._shaderLanguage=0,this._vertexBuffers={},this._isEnabled=!0,this._onShadersLoaded=new i0.y$(void 0,!0),this._shadersLoaded=!1,this._scene=i||rh.l.LastCreatedScene,cd._SceneComponentInitialization(this._scene),this._emitter=t,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=e=>i.activeCamera&&e.material&&e.isVisible&&e.isEnabled()&&e.isBlocker&&(e.layerMask&i.activeCamera.layerMask)!=0;let r=i.getEngine(),s=[];s.push(1,1),s.push(-1,1),s.push(-1,-1),s.push(1,-1),this._vertexBuffers[st.o.PositionKind]=new st.o(r,s,st.o.PositionKind,!1,!1,2),this._createIndexBuffer(),this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!cd.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,76673)),Promise.resolve().then(i.bind(i,15744))])):await Promise.all([Promise.resolve().then(i.bind(i,42850)),Promise.resolve().then(i.bind(i,90525))]),this._shadersLoaded=!0,this._onShadersLoaded.notifyObservers()}_createIndexBuffer(){let e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(e){this._emitter=e}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(e){let t=this.getEmitterPosition();t=i1.P.Project(t,i1.y3.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=i1.P.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=2*this.viewportBorder,e.height+=2*this.viewportBorder,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);let i=this._scene.useRightHandedSystem;return(t.z>0&&!i||t.z<0&&!!i)&&(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&(this._positionY,e.y,e.height),!0)}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;let e=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),t=e.length();e.normalize();let i=new nr.zH(this._scene.activeCamera.globalPosition,e),r=this._scene.pickWithRay(i,this.meshesSelectionPredicate,!0);return!r||!r.hit||r.distance>t}render(){let e,t;if(!this._scene.activeCamera||!this._shadersLoaded)return!1;let i=this._scene.getEngine(),r=this._scene.activeCamera.viewport.toGlobal(i.getRenderWidth(!0),i.getRenderHeight(!0));if(!this.computeEffectivePosition(r)||!this._isVisible())return!1;let s=(e=this._positionX<this.borderLimit+r.x?this.borderLimit+r.x-this._positionX:this._positionX>r.x+r.width-this.borderLimit?this._positionX-r.x-r.width+this.borderLimit:0)>(t=this._positionY<this.borderLimit+r.y?this.borderLimit+r.y-this._positionY:this._positionY>r.y+r.height-this.borderLimit?this._positionY-r.y-r.height+this.borderLimit:0)?e:t;(s-=this.viewportBorder)>this.borderLimit&&(s=this.borderLimit);let n=1-(0,aP.Clamp)(s/this.borderLimit,0,1);if(n<0)return!1;n>1&&(n=1),this.viewportBorder>0&&(r.x+=this.viewportBorder,r.y+=this.viewportBorder,r.width-=2*this.viewportBorder,r.height-=2*this.viewportBorder,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);let a=r.x+r.width/2,o=r.y+r.height/2,l=a-this._positionX,c=o-this._positionY;i.setState(!1),i.setDepthBuffer(!1);for(let e=0;e<this.lensFlares.length;e++){let t=this.lensFlares[e];if(!t._drawWrapper.effect.isReady()||t.texture&&!t.texture.isReady())continue;i.enableEffect(t._drawWrapper),i.bindBuffers(this._vertexBuffers,this._indexBuffer,t._drawWrapper.effect),i.setAlphaMode(t.alphaMode);let s=a-l*t.position,u=o-c*t.position,h=t.size,d=t.size*i.getAspectRatio(this._scene.activeCamera,!0),f=(s-r.x)/r.width*2-1,p=1-(u-r.y)/r.height*2,m=i1.y3.FromValues(h/2,0,0,0,0,d/2,0,0,0,0,1,0,f,p,0,1);t._drawWrapper.effect.setMatrix("viewportMatrix",m),t._drawWrapper.effect.setTexture("textureSampler",t.texture),t._drawWrapper.effect.setFloat4("color",t.color.r*n,t.color.g*n,t.color.b*n,1),i.drawElementsType(n0.F.TriangleFillMode,0,6)}return i.setDepthBuffer(!0),i.setAlphaMode(0),!0}rebuild(){for(let e in this._createIndexBuffer(),this._vertexBuffers)this._vertexBuffers[e]?._rebuild()}dispose(){this._onShadersLoaded.clear();let e=this._vertexBuffers[st.o.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[st.o.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();let t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)}static Parse(e,t,i){let r=t.getLastEntryById(e.emitterId),s=e.name||"lensFlareSystem#"+e.emitterId,n=new cd(s,r,t);n.id=e.id||s,n.borderLimit=e.borderLimit;for(let t=0;t<e.flares.length;t++){let r=e.flares[t];ch.AddFlare(r.size,r.position,i2.Wo.FromArray(r.color),r.textureName?i+r.textureName:"",n)}return n}serialize(){let e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(let t=0;t<this.lensFlares.length;t++){let i=this.lensFlares[t];e.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:rD.w1.GetFilename(i.texture?i.texture.name:"")})}return e}}cd.ForceGLSL=!1,cd._SceneComponentInitialization=e=>{throw(0,rU.S)("LensFlareSystemSceneComponent")},(0,rY.PS)(rz.l.NAME_LENSFLARESYSTEM,(e,t,i,r)=>{if(void 0!==e.lensFlareSystems&&null!==e.lensFlareSystems){i.lensFlareSystems||(i.lensFlareSystems=[]);for(let s=0,n=e.lensFlareSystems.length;s<n;s++){let n=e.lensFlareSystems[s],a=cd.Parse(n,t,r);i.lensFlareSystems.push(a)}}}),rH.x.prototype.getLensFlareSystemByName=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].name===e)return this.lensFlareSystems[t];return null},rH.x.prototype.getLensFlareSystemById=function(e){for(let t=0;t<this.lensFlareSystems.length;t++)if(this.lensFlareSystems[t].id===e)return this.lensFlareSystems[t];return null},rH.x.prototype.getLensFlareSystemByID=function(e){return this.getLensFlareSystemById(e)},rH.x.prototype.removeLensFlareSystem=function(e){let t=this.lensFlareSystems.indexOf(e);return -1!==t&&this.lensFlareSystems.splice(t,1),t},rH.x.prototype.addLensFlareSystem=function(e){this.lensFlareSystems.push(e)};class cf{constructor(e){this.name=rz.l.NAME_LENSFLARESYSTEM,this.scene=e}register(){this.scene._afterCameraDrawStage.registerStep(rz.l.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){e.lensFlareSystems&&e.lensFlareSystems.forEach(e=>{this.scene.addLensFlareSystem(e)})}removeFromContainer(e,t){e.lensFlareSystems&&e.lensFlareSystems.forEach(e=>{this.scene.removeLensFlareSystem(e),t&&e.dispose()})}serialize(e){for(let t of(e.lensFlareSystems=[],this.scene.lensFlareSystems))e.lensFlareSystems.push(t.serialize())}dispose(){let e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){let t=this.scene.lensFlareSystems;for(let i of(rD.w1.StartPerformanceCounter("Lens flares",t.length>0),t))(e.layerMask&i.layerMask)!=0&&i.render();rD.w1.EndPerformanceCounter("Lens flares",t.length>0)}}}cd._SceneComponentInitialization=e=>{let t=e._getComponent(rz.l.NAME_LENSFLARESYSTEM);t||(t=new cf(e),e._addComponent(t))},i(42850),i(90525),i(76673),i(15744);var cp=i(15431);class cm{get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return void 0!==this._depthScale?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===cm.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}if(e===cm.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}if(e===cm.FILTER_PCF||e===cm.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===cm.FILTER_PCF||e===cm.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===cm.FILTER_POISSONSAMPLING}set usePoissonSampling(e){let t=this._validateFilter(cm.FILTER_POISSONSAMPLING);(e||this.filter===cm.FILTER_POISSONSAMPLING)&&(this.filter=e?t:cm.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===cm.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){let t=this._validateFilter(cm.FILTER_EXPONENTIALSHADOWMAP);(e||this.filter===cm.FILTER_EXPONENTIALSHADOWMAP)&&(this.filter=e?t:cm.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===cm.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){let t=this._validateFilter(cm.FILTER_BLUREXPONENTIALSHADOWMAP);(e||this.filter===cm.FILTER_BLUREXPONENTIALSHADOWMAP)&&(this.filter=e?t:cm.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===cm.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){let t=this._validateFilter(cm.FILTER_CLOSEEXPONENTIALSHADOWMAP);(e||this.filter===cm.FILTER_CLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:cm.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===cm.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){let t=this._validateFilter(cm.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);(e||this.filter===cm.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP)&&(this.filter=e?t:cm.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===cm.FILTER_PCF}set usePercentageCloserFiltering(e){let t=this._validateFilter(cm.FILTER_PCF);(e||this.filter===cm.FILTER_PCF)&&(this.filter=e?t:cm.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===cm.FILTER_PCSS}set useContactHardeningShadow(e){let t=this._validateFilter(cm.FILTER_PCSS);(e||this.filter===cm.FILTER_PCSS)&&(this.filter=e?t:cm.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return cm.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),-1===this._shadowMap.renderList.indexOf(e)&&this._shadowMap.renderList.push(e),t)for(let t of e.getChildMeshes())-1===this._shadowMap.renderList.indexOf(t)&&this._shadowMap.renderList.push(t);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;let i=this._shadowMap.renderList.indexOf(e);if(-1!==i&&this._shadowMap.renderList.splice(i,1),t)for(let t of e.getChildren())this.removeShadowCaster(t);return this}getLight(){return this._light}get shaderLanguage(){return this._shaderLanguage}_getCamera(){return this._camera??this._scene.activeCamera}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}constructor(e,t,i,r,s,n=!1){this.onBeforeShadowMapRenderObservable=new i0.y$,this.onAfterShadowMapRenderObservable=new i0.y$,this.onBeforeShadowMapRenderMeshObservable=new i0.y$,this.onAfterShadowMapRenderMeshObservable=new i0.y$,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=cm.FILTER_NONE,this._filteringQuality=cm.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this._shaderLanguage=0,this.forceBackFacesOnly=!1,this._lightDirection=i1.P.Zero(),this._viewMatrix=i1.y3.Zero(),this._projectionMatrix=i1.y3.Zero(),this._transformMatrix=i1.y3.Zero(),this._cachedPosition=new i1.P(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new i1.P(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=i1.y3.Identity(),this._shadersLoaded=!1,this._mapSize=e,this._light=t,this._scene=t.getScene(),this._camera=r??null,this._useRedTextureType=!!s,this._initShaderSourceAsync(n);let a=t._shadowGenerators;a||(a=t._shadowGenerators=new Map),a.set(this._camera,this),this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),cm._SceneComponentInitialization(this._scene);let o=this._scene.getEngine().getCaps();i?o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:o.textureHalfFloatRender&&o.textureHalfFloatLinearFiltering?this._textureType=2:o.textureFloatRender&&o.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){let e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new s2._(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForShadowGenerator-${this._light.name}`)):this._shadowMap=new s2._(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube()),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(this._createTargetRenderTexture(),null===this._shadowMap)return;this._shadowMap.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(rZ.x.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=(e,t,i,r)=>this._renderForShadowMap(e,t,i,r),this._shadowMap.customIsReadyFunction=()=>!0;let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=t,this._filter===cm.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===cm.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){e._debugPopGroup?.(1);return}let t=this.getShadowMapForRendering();t&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,t.renderTarget,!0),e.unBindFramebuffer(t.renderTarget,!0),e._debugPopGroup?.(1))});let t=new i2.HE(0,0,0,0),i=new i2.HE(1,1,1,1);this._shadowMap.onClearObservable.add(e=>{this._filter===cm.FILTER_PCF?e.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e.clear(t,!0,!0,!1):e.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(e=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=e.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let e=cp.$.MIN_RENDERINGGROUPS;e<cp.$.MAX_RENDERINGGROUPS;e++)this._shadowMap.setRenderingAutoClearDepthStencil(e,!1)}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||cm.ForceGLSL?await Promise.all([Promise.resolve().then(i.bind(i,76720)),Promise.resolve().then(i.bind(i,17791)),Promise.resolve().then(i.bind(i,63023)),Promise.resolve().then(i.bind(i,820))]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,7434)),Promise.resolve().then(i.bind(i,48592)),Promise.resolve().then(i.bind(i,69639)),Promise.resolve().then(i.bind(i,11395))])),this._shadersLoaded=!0}_initializeBlurRTTAndPostProcesses(){let e=this._scene.getEngine(),t=this._mapSize/this.blurScale;this.useKernelBlur&&1===this.blurScale||(this._shadowMap2=new s2._(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(rZ.x.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new o2.i(this._light.name+"KernelBlurX",new i1.FM(1,0),this.blurKernel,1,null,rZ.x.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(e=>{e.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new o2.i(this._light.name+"KernelBlurY",new i1.FM(0,1),this.blurKernel,1,null,rZ.x.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,0===this._textureType&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new sD.D(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,rZ.x.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType,void 0,void 0,void 0,void 0,this._shaderLanguage),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(e=>{e.setFloat2("screenSize",t,t),e.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,r){let s;if(r.length)for(s=0;s<r.length;s++)this._renderSubMeshForShadowMap(r.data[s]);for(s=0;s<e.length;s++)this._renderSubMeshForShadowMap(e.data[s]);for(s=0;s<t.length;s++)this._renderSubMeshForShadowMap(t.data[s]);if(this._transparencyShadow)for(s=0;s<i.length;s++)this._renderSubMeshForShadowMap(i.data[s],!0);else for(s=0;s<i.length;s++)i.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){let i=e.getRenderingMesh(),r=e.getEffectiveMesh(),s=this._scene,n=s.getEngine(),a=e.getMaterial();if(r._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!a||0===e.verticesCount||e._renderId===s.getRenderId())return;let o=s.useRightHandedSystem,l=0>r._getWorldMatrixDeterminant(),c=a._getEffectiveOrientation(i);(l&&!o||!l&&o)&&(c=0===c?1:0);let u=0===c;n.setState(a.backFaceCulling,void 0,void 0,u,a.cullBackFaces);let h=i._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(h.mustReturn)return;let d=n.getCaps().instancedArrays&&(null!==h.visibleInstances[e._id]&&void 0!==h.visibleInstances[e._id]||i.hasThinInstances);if(!this.customAllowRendering||this.customAllowRendering(e)){if(this.isReady(e,d,t)){e._renderId=s.getRenderId();let o=a.shadowDepthWrapper,l=o?.getEffect(e,this,n.currentRenderPassId)??e._getDrawWrapper(),c=cu.q.GetEffect(l);n.enableEffect(l),d||i._bind(e,c,a.fillMode),this.getTransformMatrix(),c.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===rN._.LIGHTTYPEID_DIRECTIONALLIGHT?c.setVector3("lightDataSM",this._cachedDirection):c.setVector3("lightDataSM",this._cachedPosition);let u=this._getCamera();if(u&&c.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(u),this.getLight().getDepthMinZ(u)+this.getLight().getDepthMaxZ(u)),t&&this.enableSoftTransparentShadow&&c.setFloat2("softTransparentShadowSM",r.visibility*a.alpha,this._opacityTexture?.getAlphaFromRGB?1:0),o)e._setMainDrawWrapperOverride(l),o.standalone?o.baseMaterial.bindForSubMesh(r.getWorldMatrix(),i,e):a.bindForSubMesh(r.getWorldMatrix(),i,e),e._setMainDrawWrapperOverride(null);else{if(this._opacityTexture&&(c.setTexture("diffuseSampler",this._opacityTexture),c.setMatrix("diffuseMatrix",this._opacityTexture.getTextureMatrix()||this._defaultTextureMatrix)),i.useBones&&i.computeBonesUsingShaders&&i.skeleton){let e=i.skeleton;if(e.isUsingTextureForMatrices){let t=e.getTransformMatrixTexture(i);if(!t)return;c.setTexture("boneSampler",t),c.setFloat("boneTextureWidth",4*(e.bones.length+1))}else c.setMatrices("mBones",e.getTransformMatrices(i))}(0,le.KG)(i,c),i.morphTargetManager&&i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(c);let t=e.getMesh().bakedVertexAnimationManager;t&&t.isEnabled&&t.bind(c,d),(0,o9.an)(c,a,s)}this._useUBO||o||this._bindCustomEffectForRenderSubMeshForShadowMap(e,c,r),(0,le.ml)(c,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();let f=r.getWorldMatrix();d&&(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(f)),this.forceBackFacesOnly&&n.setState(!0,0,!1,!0,a.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(i),this.onBeforeShadowMapRenderObservable.notifyObservers(c),i._processRendering(r,e,c,a.fillMode,h,d,(e,t)=>{r===i||e?(r.getMeshUniformBuffer().bindToEffect(c,"Mesh"),r.transferToEffect(e?t:f)):(i.getMeshUniformBuffer().bindToEffect(c,"Mesh"),i.transferToEffect(t))}),this.forceBackFacesOnly&&n.setState(!0,0,!1,!1,a.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(c),this.onAfterShadowMapRenderMeshObservable.notifyObservers(i)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}}_applyFilterValues(){this._shadowMap&&(this.filter===cm.FILTER_NONE||this.filter===cm.FILTER_PCSS?this._shadowMap.updateSamplingMode(rZ.x.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(rZ.x.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){let i={useInstances:!1,...t},r=this.getShadowMap();if(!r){e&&e(this);return}let s=r.renderList;if(!s){e&&e(this);return}let n=[];for(let e of s)n.push(...e.subMeshes);if(0===n.length){e&&e(this);return}let a=0,o=()=>{if(this._scene&&this._scene.getEngine()){for(;this.isReady(n[a],i.useInstances,n[a].getMaterial()?.needAlphaBlendingForMesh(n[a].getMesh())??!1);)if(++a>=n.length){e&&e(this);return}setTimeout(o,16)}};o()}forceCompilationAsync(e){return new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,r){i.push("#define SM_LIGHTTYPE_"+this._light.getClassName().toUpperCase()),i.push("#define SM_FLOAT "+(0!==this._textureType?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));let s=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&s.isVerticesDataPresent(st.o.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===rN._.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&r?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){if(!this._shadersLoaded)return!1;let r=e.getMaterial(),s=r?.shadowDepthWrapper;if(this._opacityTexture=null,!r)return!1;let n=[];if(this._prepareShadowDefines(e,t,n,i),s){if(!s.isReadyForSubMesh(e,n,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{let i=e._getDrawWrapper(void 0,!0),s=i.effect,a=i.defines,o=[st.o.PositionKind],l=e.getMesh();this.normalBias&&l.isVerticesDataPresent(st.o.NormalKind)&&(o.push(st.o.NormalKind),n.push("#define NORMAL"),l.nonUniformScaling&&n.push("#define NONUNIFORMSCALING"));let c=r.needAlphaTesting();if((c||r.needAlphaBlending())&&(this.useOpacityTextureForTransparentShadow?this._opacityTexture=r.opacityTexture:this._opacityTexture=r.getAlphaTestTexture(),this._opacityTexture)){if(!this._opacityTexture.isReady())return!1;let e=r.alphaCutOff??cm.DEFAULT_ALPHA_CUTOFF;n.push("#define ALPHATEXTURE"),c&&n.push(`#define ALPHATESTVALUE ${e}${e%1==0?".":""}`),l.isVerticesDataPresent(st.o.UVKind)&&(o.push(st.o.UVKind),n.push("#define UV1")),l.isVerticesDataPresent(st.o.UV2Kind)&&1===this._opacityTexture.coordinatesIndex&&(o.push(st.o.UV2Kind),n.push("#define UV2"))}let u=new o8.L;if(l.useBones&&l.computeBonesUsingShaders&&l.skeleton){o.push(st.o.MatricesIndicesKind),o.push(st.o.MatricesWeightsKind),l.numBoneInfluencers>4&&(o.push(st.o.MatricesIndicesExtraKind),o.push(st.o.MatricesWeightsExtraKind));let e=l.skeleton;n.push("#define NUM_BONE_INFLUENCERS "+l.numBoneInfluencers),l.numBoneInfluencers>0&&u.addCPUSkinningFallback(0,l),e.isUsingTextureForMatrices?n.push("#define BONETEXTURE"):n.push("#define BonesPerMesh "+(e.bones.length+1))}else n.push("#define NUM_BONE_INFLUENCERS 0");let h=l.morphTargetManager,d=0;if(h&&(d=h.numMaxInfluencers||h.numInfluencers)>0&&(n.push("#define MORPHTARGETS"),n.push("#define NUM_MORPH_INFLUENCERS "+d),h.isUsingTextureForTargets&&n.push("#define MORPHTARGETS_TEXTURE"),(0,le.Vk)(o,l,d)),(0,o9.lK)(r,this._scene,n),t&&(n.push("#define INSTANCES"),(0,le.y9)(o),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(let e of this.customShaderOptions.defines)-1===n.indexOf(e)&&n.push(e);let f=l.bakedVertexAnimationManager;f&&f.isEnabled&&(n.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&o.push("bakedVertexAnimationSettingsInstanced"));let p=n.join("\n");if(a!==p){a=p;let e="shadowMap",t=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","morphTargetCount","boneTextureWidth","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],r=["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"];if((0,o9.qx)(t),this.customShaderOptions){if(e=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(let e of this.customShaderOptions.attributes)-1===o.indexOf(e)&&o.push(e);if(this.customShaderOptions.uniforms)for(let e of this.customShaderOptions.uniforms)-1===t.indexOf(e)&&t.push(e);if(this.customShaderOptions.samplers)for(let e of this.customShaderOptions.samplers)-1===r.indexOf(e)&&r.push(e)}let n=this._scene.getEngine();s=n.createEffect(e,{attributes:o,uniformsNames:t,uniformBuffersNames:["Scene","Mesh"],samplers:r,defines:p,fallbacks:u,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:d},shaderLanguage:this._shaderLanguage},n),i.setEffect(s,a)}if(!s.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),(!this._kernelBlurXPostprocess||!!this._kernelBlurXPostprocess.isReady())&&(!this._kernelBlurYPostprocess||!!this._kernelBlurYPostprocess.isReady())&&(!this._boxBlurPostprocess||!!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){let i=this._scene,r=this._light;i.shadowsEnabled&&r.shadowEnabled&&(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===cm.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===cm.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===cm.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===cm.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),r.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){let i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;let r=this._getCamera();if(!r)return;let s=this.getShadowMap();if(!s)return;i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix());let n=this.getShadowMapForRendering();this._filter===cm.FILTER_PCF?(t.setDepthStencilTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),s.getSize().width,1/s.getSize().width,this.frustumEdgeFalloff,e)):this._filter===cm.FILTER_PCSS?(t.setDepthStencilTexture("shadowTexture"+e,n),t.setTexture("depthTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/s.getSize().width,this._contactHardeningLightSizeUVRatio*s.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowTexture"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/s.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}get viewMatrix(){return this._viewMatrix}get projectionMatrix(){return this._projectionMatrix}getTransformMatrix(){let e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),i1.P.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),1===Math.abs(i1.P.Dot(this._lightDirection,i1.P.Up()))&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),i1.y3.LookAtLHToRef(t,t.add(this._lightDirection),i1.P.Up(),this._viewMatrix);let e=this.getShadowMap();if(e){let t=e.renderList;t&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,t)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){let e=this._shadowMap;if(!e)return;let t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t)for(let e of(this._shadowMap.renderList||(this._shadowMap.renderList=[]),t))this._shadowMap.renderList.push(e);else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(let e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){if(this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light){if(this._light._shadowGenerators){let e=this._light._shadowGenerators.entries();for(let t=e.next();!0!==t.done;t=e.next()){let[e,i]=t.value;i===this&&this._light._shadowGenerators.delete(e)}0===this._light._shadowGenerators.size&&(this._light._shadowGenerators=null)}this._light._markMeshesAsLightDirty()}this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){let e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.cameraId=this._camera?.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){let r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t,i){let r=t.getLightById(e.lightId),s=void 0!==e.cameraId?t.getCameraById(e.cameraId):null,n=i?i(e.mapSize,r,s):new cm(e.mapSize,r,void 0,s),a=n.getShadowMap();for(let i=0;i<e.renderList.length;i++)t.getMeshesById(e.renderList[i]).forEach(function(e){a&&(a.renderList||(a.renderList=[]),a.renderList.push(e))});return void 0!==e.id&&(n.id=e.id),n.forceBackFacesOnly=!!e.forceBackFacesOnly,void 0!==e.darkness&&n.setDarkness(e.darkness),e.transparencyShadow&&n.setTransparencyShadow(!0),void 0!==e.frustumEdgeFalloff&&(n.frustumEdgeFalloff=e.frustumEdgeFalloff),void 0!==e.bias&&(n.bias=e.bias),void 0!==e.normalBias&&(n.normalBias=e.normalBias),e.usePercentageCloserFiltering?n.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?n.useContactHardeningShadow=!0:e.usePoissonSampling?n.usePoissonSampling=!0:e.useExponentialShadowMap?n.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?n.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?n.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?n.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?n.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(n.useBlurExponentialShadowMap=!0),void 0!==e.contactHardeningLightSizeUVRatio&&(n.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),void 0!==e.filteringQuality&&(n.filteringQuality=e.filteringQuality),e.depthScale&&(n.depthScale=e.depthScale),e.blurScale&&(n.blurScale=e.blurScale),e.blurBoxOffset&&(n.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(n.useKernelBlur=e.useKernelBlur),e.blurKernel&&(n.blurKernel=e.blurKernel),n}}cm.CLASSNAME="ShadowGenerator",cm.ForceGLSL=!1,cm.FILTER_NONE=0,cm.FILTER_EXPONENTIALSHADOWMAP=1,cm.FILTER_POISSONSAMPLING=2,cm.FILTER_BLUREXPONENTIALSHADOWMAP=3,cm.FILTER_CLOSEEXPONENTIALSHADOWMAP=4,cm.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5,cm.FILTER_PCF=6,cm.FILTER_PCSS=7,cm.QUALITY_HIGH=0,cm.QUALITY_MEDIUM=1,cm.QUALITY_LOW=2,cm.DEFAULT_ALPHA_CUTOFF=.5,cm._SceneComponentInitialization=e=>{throw(0,rU.S)("ShadowGeneratorSceneComponent")},i(51302),i(69689);class c_{get shaderLanguage(){return this._shaderLanguage}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}constructor(e,t=1,i=null,r=!1,s=rZ.x.TRILINEAR_SAMPLINGMODE,n=!1,a){this._shaderLanguage=0,this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this.reverseCulling=!1,this._shadersLoaded=!1,this._scene=e,this._storeNonLinearDepth=r,this._storeCameraSpaceZ=n,this.isPacked=0===t,this.isPacked?this.clearColor=new i2.HE(1,1,1,1):this.clearColor=new i2.HE(n?1e8:1,0,0,1),this._initShaderSourceAsync(),c_._SceneComponentInitialization(this._scene);let o=e.getEngine();this._camera=i,s===rZ.x.NEAREST_SAMPLINGMODE||(1!==t||o._caps.textureFloatLinearFiltering||(s=rZ.x.NEAREST_SAMPLINGMODE),2!==t||o._caps.textureHalfFloatLinearFiltering||(s=rZ.x.NEAREST_SAMPLINGMODE));let l=this.isPacked||!o._features.supportExtendedTextureFormats?5:6;this._depthMap=new s2._(a??"DepthRenderer",{width:o.getRenderWidth(),height:o.getRenderHeight()},this._scene,!1,!0,t,!1,s,void 0,void 0,void 0,l),this._depthMap.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._depthMap.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.noPrePassRenderer=!0,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(e=>{e.clear(this.clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{o._debugPushGroup?.("depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{o._debugPopGroup?.(1)}),this._depthMap.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){let i=e.subMeshes[t],r=i.getRenderingMesh(),s=r._getInstancesRenderList(i._id,!!i.getReplacementMesh()),n=o.getCaps().instancedArrays&&(null!==s.visibleInstances[i._id]&&void 0!==s.visibleInstances[i._id]||r.hasThinInstances);if(!this.isReady(i,n))return!1}return!0};let c=e=>{let t=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,s=r.getEngine(),n=e.getMaterial();if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!n||i.infiniteDistance||n.disableDepthWrite||0===e.verticesCount||e._renderId===r.getRenderId())return;let a=0>i._getWorldMatrixDeterminant(),o=n._getEffectiveOrientation(t);a&&(o=0===o?1:0);let l=0===o;s.setState(n.backFaceCulling,0,!1,l,this.reverseCulling?!n.cullBackFaces:n.cullBackFaces);let c=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(c.mustReturn)return;let u=s.getCaps().instancedArrays&&(null!==c.visibleInstances[e._id]&&void 0!==c.visibleInstances[e._id]||t.hasThinInstances),h=this._camera||r.activeCamera;if(this.isReady(e,u)&&h){let a,o;e._renderId=r.getRenderId();let l=i._internalAbstractMeshDataInfo._materialForRenderPass?.[s.currentRenderPassId],d=e._getDrawWrapper();!d&&l&&(d=l._getDrawWrapper());let f=h.mode===rO.V.ORTHOGRAPHIC_CAMERA;if(!d)return;let p=d.effect;if(s.enableEffect(d),u||t._bind(e,p,n.fillMode),l?l.bindForSubMesh(i.getWorldMatrix(),i,e):(p.setMatrix("viewProjection",r.getTransformMatrix()),p.setMatrix("world",i.getWorldMatrix()),this._storeCameraSpaceZ&&p.setMatrix("view",r.getViewMatrix())),f?(a=!s.useReverseDepthBuffer&&s.isNDCHalfZRange?0:1,o=s.useReverseDepthBuffer&&s.isNDCHalfZRange?0:1):(a=s.useReverseDepthBuffer&&s.isNDCHalfZRange?h.minZ:s.isNDCHalfZRange?0:h.minZ,o=s.useReverseDepthBuffer&&s.isNDCHalfZRange?0:h.maxZ),p.setFloat2("depthValues",a,a+o),!l){if(n.needAlphaTesting()){let e=n.getAlphaTestTexture();e&&(p.setTexture("diffuseSampler",e),p.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,le.qx)(t,p),(0,o9.an)(p,n,r),(0,le.KG)(t,p),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(p);let i=e.getMesh().bakedVertexAnimationManager;i&&i.isEnabled&&i.bind(p,u),n.pointsCloud&&p.setFloat("pointSize",n.pointSize)}t._processRendering(i,e,p,n.fillMode,c,u,(e,t)=>p.setMatrix("world",t))}};this._depthMap.customRenderFunction=(e,t,i,r)=>{let s;if(r.length)for(s=0;s<r.length;s++)c(r.data[s]);for(s=0;s<e.length;s++)c(e.data[s]);for(s=0;s<t.length;s++)c(t.data[s]);if(this.forceDepthWriteTransparentMeshes)for(s=0;s<i.length;s++)c(i.data[s]);else for(s=0;s<i.length;s++)i.data[s].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}async _initShaderSourceAsync(e=!1){!this._scene.getEngine().isWebGPU||e||c_.ForceGLSL?await Promise.all([Promise.resolve().then(i.bind(i,69689)),Promise.resolve().then(i.bind(i,51302))]):(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,74725)),Promise.resolve().then(i.bind(i,81042))])),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;let i=this._scene.getEngine(),r=e.getMesh(),s=r.getScene(),n=r._internalAbstractMeshDataInfo._materialForRenderPass?.[i.currentRenderPassId];if(n)return n.isReadyForSubMesh(r,e,t);let a=e.getMaterial();if(!a||a.disableDepthWrite)return!1;let o=[],l=[st.o.PositionKind];a.needAlphaTesting()&&a.getAlphaTestTexture()&&(o.push("#define ALPHATEST"),r.isVerticesDataPresent(st.o.UVKind)&&(l.push(st.o.UVKind),o.push("#define UV1")),r.isVerticesDataPresent(st.o.UV2Kind)&&(l.push(st.o.UV2Kind),o.push("#define UV2")));let c=new o8.L;if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){l.push(st.o.MatricesIndicesKind),l.push(st.o.MatricesWeightsKind),r.numBoneInfluencers>4&&(l.push(st.o.MatricesIndicesExtraKind),l.push(st.o.MatricesWeightsExtraKind)),o.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),r.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,r);let e=r.skeleton;e.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(e.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");let u=r.morphTargetManager,h=0;u&&(h=u.numMaxInfluencers||u.numInfluencers)>0&&(o.push("#define MORPHTARGETS"),o.push("#define NUM_MORPH_INFLUENCERS "+h),u.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),(0,le.Vk)(l,r,h)),a.pointsCloud&&o.push("#define POINTSIZE"),t&&(o.push("#define INSTANCES"),(0,le.y9)(l),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES"));let d=r.bakedVertexAnimationManager;d&&d.isEnabled&&(o.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&l.push("bakedVertexAnimationSettingsInstanced")),this._storeNonLinearDepth&&o.push("#define NONLINEARDEPTH"),this._storeCameraSpaceZ&&o.push("#define STORE_CAMERASPACE_Z"),this.isPacked&&o.push("#define PACKED"),(0,o9.lK)(a,s,o);let f=e._getDrawWrapper(void 0,!0),p=f.defines,m=o.join("\n");if(p!==m){let e=["world","mBones","boneTextureWidth","pointSize","viewProjection","view","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"];(0,o9.qx)(e),f.setEffect(i.createEffect("depth",{attributes:l,uniformsNames:e,uniformBuffersNames:[],samplers:["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"],defines:m,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:h},shaderLanguage:this._shaderLanguage},i))}return f.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){let e=[];for(let t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0)for(let t of(this._depthMap.dispose(),e))delete this._scene._depthRenderer[t]}}c_.ForceGLSL=!1,c_._SceneComponentInitialization=e=>{throw(0,rU.S)("DepthRendererSceneComponent")};var cg=i(11538);let cv=`varying vec2 vUV;uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));float f1=texelFetch(sourceTexture,coord,0).r;float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(MAIN)
uniform vec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*(texSize-1.0));vec2 f1=texelFetch(textureSampler,coord,0).rg;vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;void main(void)
{ivec2 coord=ivec2(vUV*vec2(texSize-1));vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;float minz=min(f1.x,f2.x);float maxz=max(f1.y,f2.y);glFragColor=vec4(minz,maxz,0.,0.);}
#elif defined(LAST)
void main(void)
{glFragColor=vec4(0.);if (true) { 
discard;}}
#endif
`;sG.v.ShadersStore.minmaxReduxPixelShader=cv;class cS{constructor(e){this.onAfterReductionPerformed=new i0.y$,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new cg.O(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,r=!0){let s,n;if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=r;let a=this._camera.getScene(),o=new sD.D("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,a.getEngine(),!1,"#define INITIAL"+(t?"\n#define DEPTH_REDUX":""),i,void 0,void 0,void 0,7);o.autoClear=!1,o.forceFullscreenViewport=r;let l=this._sourceTexture.getRenderWidth(),c=this._sourceTexture.getRenderHeight();o.onApply=(s=l,n=c,e=>{e.setTexture("sourceTexture",this._sourceTexture),e.setFloat2("texSize",s,n)}),this._reductionSteps.push(o);let u=1;for(;l>1||c>1;){let e,t;l=Math.max(Math.round(l/2),1),c=Math.max(Math.round(c/2),1);let s=new sD.D("Reduction phase "+u,"minmaxRedux",["texSize"],null,{width:l,height:c},null,1,a.getEngine(),!1,"#define "+(1==l&&1==c?"LAST":1==l||1==c?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(s.autoClear=!1,s.forceFullscreenViewport=r,s.onApply=(e=l,t=c,i=>{1==e||1==t?i.setInt2("texSize",e,t):i.setFloat2("texSize",e,t)}),this._reductionSteps.push(s),u++,1==l&&1==c){let e=(e,t,i)=>{let r=new Float32Array(4*e*t),s={min:0,max:0};return()=>{a.getEngine()._readTexturePixels(i.inputTexture.texture,e,t,-1,0,r,!1),s.min=r[0],s.max=r[1],this.onAfterReductionPerformed.notifyObservers(s)}};s.onAfterRenderObservable.add(e(l,c,s))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){!this._onAfterUnbindObserver&&this._sourceTexture&&(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{let e=this._camera.getScene().getEngine();e._debugPushGroup?.("min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),e.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),e._debugPopGroup?.(1)}),this._activated=!0)}deactivate(){this._onAfterUnbindObserver&&this._sourceTexture&&(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let e=0;e<this._reductionSteps.length;++e)this._reductionSteps[e].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class cx extends cS{get depthRenderer(){return this._depthRenderer}constructor(e){super(e)}setDepthRenderer(e=null,t=2,i=!0){let r=this._camera.getScene();this._depthRenderer&&(delete r._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),null===e&&(r._depthRenderer||(r._depthRenderer={}),(e=this._depthRenderer=new c_(r,t,this._camera,!1,1)).enabled=!1,this._depthRendererId="minmax"+this._camera.id,r._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,r=!0){super.setSourceTexture(e,t,i,r)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){let e=this._depthRenderer.getDepthMap().getScene();e&&delete e._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}let cE=i1.P.Up(),cC=i1.P.Zero(),cT=new i1.P,cb=new i1.P,cy=new i1.y3;class cI extends cm{_validateFilter(e){return e===cm.FILTER_NONE||e===cm.FILTER_PCF||e===cm.FILTER_PCSS?e:(re.Y.Error('Unsupported filter "'+e+'"!'),cm.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){(e=Math.min(Math.max(e,cI.MIN_CASCADES_COUNT),cI.MAX_CASCADES_COUNT))!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._freezeShadowCastersBoundingInfoObservable||e||(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(()=>this._computeShadowCastersBoundingInfo())),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._shadowMap&&this._shadowMap.renderList){let e=this._shadowMap.renderList;for(let t=0;t<e.length;t++){let i=e[t];if(!i)continue;let r=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(r.minimumWorld),this._scbiMax.maximizeInPlace(r.maximumWorld)}let t=this._scene.meshes;for(let e=0;e<t.length;e++){let i=t[e];if(!i||!i.isVisible||!i.isEnabled||!i.receiveShadows)continue;let r=i.getBoundingInfo().boundingBox;this._scbiMin.minimizeInPlace(r.minimumWorld),this._scbiMax.maximizeInPlace(r.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){(this._minDistance!==e||this._maxDistance!==t)&&(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return cI.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return this._getCamera()?this._shadowMaxZ:0}set shadowMaxZ(e){let t=this._getCamera();if(!t){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<t.minZ||e>t.maxZ&&0!==t.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){let t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){let t=this._getCamera();if(t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new cx(t),this._depthReducer.onAfterReductionPerformed.add(e=>{let t=e.min,i=e.max;t>=i&&(t=0,i=1),(t!=this._minDistance||i!=this._maxDistance)&&this.setMinMaxDistance(t,i)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){return this._depthReducer?.depthRenderer?.getDepthMap().refreshRate??-1}set autoCalcDepthBoundsRefreshRate(e){this._depthReducer?.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){let e=this._getCamera();if(!e)return;let t=e.minZ,i=e.maxZ||this._shadowMaxZ,r=i-t,s=this._minDistance,n=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,a=t+s*r,o=t+n*r,l=o-a,c=o/a;for(let e=0;e<this._cascades.length;++e){let i=(e+1)/this._numCascades,n=a*c**i,o=a+l*i,u=this._lambda*(n-o)+o;this._cascades[e].prevBreakDistance=0===e?s:this._cascades[e-1].breakDistance,this._cascades[e].breakDistance=(u-t)/r,this._viewSpaceFrustumsZ[e]=u,this._frustumLengths[e]=(this._cascades[e].breakDistance-this._cascades[e].prevBreakDistance)*r}this._breaksAreDirty=!1}_computeMatrices(){let e=this._scene;if(!this._getCamera())return;i1.P.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),1===Math.abs(i1.P.Dot(this._lightDirection,i1.P.Up()))&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);let t=e.getEngine().useReverseDepthBuffer;for(let i=0;i<this._numCascades;++i){this._computeFrustumInWorldSpace(i),this._computeCascadeFrustum(i),this._cascadeMaxExtents[i].subtractToRef(this._cascadeMinExtents[i],cT),this._frustumCenter[i].addToRef(this._lightDirection.scale(this._cascadeMinExtents[i].z),this._shadowCameraPos[i]),i1.y3.LookAtLHToRef(this._shadowCameraPos[i],this._frustumCenter[i],cE,this._viewMatrices[i]);let r=0,s=cT.z,n=this._shadowCastersBoundingInfo;n.update(this._viewMatrices[i]),s=Math.min(s,n.boundingBox.maximumWorld.z),r=this._depthClamp&&this.filter!==cm.FILTER_PCSS?Math.max(r,n.boundingBox.minimumWorld.z):Math.min(r,n.boundingBox.minimumWorld.z),i1.y3.OrthoOffCenterLHToRef(this._cascadeMinExtents[i].x,this._cascadeMaxExtents[i].x,this._cascadeMinExtents[i].y,this._cascadeMaxExtents[i].y,t?s:r,t?r:s,this._projectionMatrices[i],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[i].z=r,this._cascadeMaxExtents[i].z=s,this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),i1.P.TransformCoordinatesToRef(cC,this._transformMatrices[i],cT),cT.scaleInPlace(this._mapSize/2),cb.copyFromFloats(Math.round(cT.x),Math.round(cT.y),Math.round(cT.z)),cb.subtractInPlace(cT).scaleInPlace(2/this._mapSize),i1.y3.TranslationToRef(cb.x,cb.y,0,cy),this._projectionMatrices[i].multiplyToRef(cy,this._projectionMatrices[i]),this._viewMatrices[i].multiplyToRef(this._projectionMatrices[i],this._transformMatrices[i]),this._transformMatrices[i].copyToArray(this._transformMatricesAsArray,16*i)}}_computeFrustumInWorldSpace(e){let t=this._getCamera();if(!t)return;let i=this._cascades[e].prevBreakDistance,r=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;t.getViewMatrix();let n=0===t.maxZ,a=t.maxZ;n&&(t.maxZ=this._shadowMaxZ,t.getProjectionMatrix(!0));let o=i1.y3.Invert(t.getTransformationMatrix());n&&(t.maxZ=a,t.getProjectionMatrix(!0));let l=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let t=0;t<cI._FrustumCornersNDCSpace.length;++t)cT.copyFrom(cI._FrustumCornersNDCSpace[(t+l)%cI._FrustumCornersNDCSpace.length]),s&&-1===cT.z&&(cT.z=0),i1.P.TransformCoordinatesToRef(cT,o,this._frustumCornersWorldSpace[e][t]);for(let t=0;t<cI._FrustumCornersNDCSpace.length/2;++t)cT.copyFrom(this._frustumCornersWorldSpace[e][t+4]).subtractInPlace(this._frustumCornersWorldSpace[e][t]),cb.copyFrom(cT).scaleInPlace(i),cT.scaleInPlace(r),cT.addInPlace(this._frustumCornersWorldSpace[e][t]),this._frustumCornersWorldSpace[e][t+4].copyFrom(cT),this._frustumCornersWorldSpace[e][t].addInPlace(cb)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),this._getCamera()){for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][t]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let t=0;for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)t=Math.max(t,this._frustumCornersWorldSpace[e][i].subtractToRef(this._frustumCenter[e],cT).length());t=Math.ceil(16*t)/16,this._cascadeMaxExtents[e].copyFromFloats(t,t,t),this._cascadeMinExtents[e].copyFromFloats(-t,-t,-t)}else{let t=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,cT),i1.y3.LookAtLHToRef(t,cT,cE,cy);for(let t=0;t<this._frustumCornersWorldSpace[e].length;++t)i1.P.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][t],cy,cT),this._cascadeMinExtents[e].minimizeInPlace(cT),this._cascadeMaxExtents[e].maximizeInPlace(cT)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){let e=rh.l.LastCreatedEngine;return!!e&&e._features.supportCSM}constructor(e,t,i,r,s=!0){if(!cI.IsSupported){re.Y.Error("CascadedShadowMap is not supported by the current engine.");return}super(e,t,i,r,s),this.usePercentageCloserFiltering=!0}_initializeGenerator(){this.penumbraDarkness=this.penumbraDarkness??1,this._numCascades=this._numCascades??cI.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=this.stabilizeCascades??!1,this._freezeShadowCastersBoundingInfoObservable=this._freezeShadowCastersBoundingInfoObservable??null,this.freezeShadowCastersBoundingInfo=this.freezeShadowCastersBoundingInfo??!1,this._scbiMin=this._scbiMin??new i1.P(0,0,0),this._scbiMax=this._scbiMax??new i1.P(0,0,0),this._shadowCastersBoundingInfo=this._shadowCastersBoundingInfo??new nw.j(new i1.P(0,0,0),new i1.P(0,0,0)),this._breaksAreDirty=this._breaksAreDirty??!0,this._minDistance=this._minDistance??0,this._maxDistance=this._maxDistance??1,this._currentLayer=this._currentLayer??0,this._shadowMaxZ=this._shadowMaxZ??this._getCamera()?.maxZ??1e4,this._debug=this._debug??!1,this._depthClamp=this._depthClamp??!0,this._cascadeBlendPercentage=this._cascadeBlendPercentage??.1,this._lambda=this._lambda??.5,this._autoCalcDepthBounds=this._autoCalcDepthBounds??!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){let e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new s2._(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0,this._useRedTextureType?6:5),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0,void 0,void 0,void 0,`DepthStencilForCSMShadowGenerator-${this._light.name}`),this._shadowMap.noPrePassRenderer=!0}_initializeShadowMap(){if(super._initializeShadowMap(),null===this._shadowMap)return;this._transformMatricesAsArray=new Float32Array(16*this._numCascades),this._viewSpaceFrustumsZ=Array(this._numCascades),this._frustumLengths=Array(this._numCascades),this._lightSizeUVCorrection=Array(2*this._numCascades),this._depthCorrection=Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let e=0;e<this._numCascades;++e){this._cascades[e]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[e]=i1.y3.Zero(),this._projectionMatrices[e]=i1.y3.Zero(),this._transformMatrices[e]=i1.y3.Zero(),this._cascadeMinExtents[e]=new i1.P,this._cascadeMaxExtents[e]=new i1.P,this._frustumCenter[e]=new i1.P,this._shadowCameraPos[e]=new i1.P,this._frustumCornersWorldSpace[e]=Array(cI._FrustumCornersNDCSpace.length);for(let t=0;t<cI._FrustumCornersNDCSpace.length;++t)this._frustumCornersWorldSpace[e][t]=new i1.P}let e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===cm.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{this._currentSceneUBO=this._scene.getSceneUniformBuffer(),e._debugPushGroup?.(`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==cm.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);let i=this._scene,r=this._light;if(!i.shadowsEnabled||!r.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;let s=this._getCamera();s&&this._shadowMaxZ<=(s.maxZ||this._shadowMaxZ)&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),0===this.cascadeBlendPercentage&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){let i=this._light;if(!this._scene.shadowsEnabled||!i.shadowEnabled)return;let r=this._getCamera();if(!r)return;let s=this.getShadowMap();if(!s)return;let n=s.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,0===this.cascadeBlendPercentage?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===cm.FILTER_PCF)t.setDepthStencilTexture("shadowTexture"+e,s),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);else if(this._filter===cm.FILTER_PCSS){for(let e=0;e<this._numCascades;++e)this._lightSizeUVCorrection[2*e+0]=0===e?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[e].x-this._cascadeMinExtents[e].x),this._lightSizeUVCorrection[2*e+1]=0===e?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[e].y-this._cascadeMinExtents[e].y),this._depthCorrection[e]=0===e?1:(this._cascadeMaxExtents[e].z-this._cascadeMinExtents[e].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowTexture"+e,s),t.setTexture("depthTexture"+e,s),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n,this._contactHardeningLightSizeUVRatio*n,this.frustumEdgeFalloff,e)}else t.setTexture("shadowTexture"+e,s),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n,1/n,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){let e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){let r=t.renderList[i];e.renderList.push(r.id)}return e}static Parse(e,t){let i=cm.Parse(e,t,(e,t,i)=>new cI(e,t,void 0,i));return void 0!==e.numCascades&&(i.numCascades=e.numCascades),void 0!==e.debug&&(i.debug=e.debug),void 0!==e.stabilizeCascades&&(i.stabilizeCascades=e.stabilizeCascades),void 0!==e.lambda&&(i.lambda=e.lambda),void 0!==e.cascadeBlendPercentage&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),void 0!==e.depthClamp&&(i.depthClamp=e.depthClamp),void 0!==e.autoCalcDepthBounds&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),void 0!==e.shadowMaxZ&&(i.shadowMaxZ=e.shadowMaxZ),void 0!==e.penumbraDarkness&&(i.penumbraDarkness=e.penumbraDarkness),void 0!==e.freezeShadowCastersBoundingInfo&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),void 0!==e.minDistance&&void 0!==e.maxDistance&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}cI._FrustumCornersNDCSpace=[new i1.P(-1,1,-1),new i1.P(1,1,-1),new i1.P(1,-1,-1),new i1.P(-1,-1,-1),new i1.P(-1,1,1),new i1.P(1,1,1),new i1.P(1,-1,1),new i1.P(-1,-1,1)],cI.CLASSNAME="CascadedShadowGenerator",cI.DEFAULT_CASCADES_COUNT=4,cI.MIN_CASCADES_COUNT=2,cI.MAX_CASCADES_COUNT=4,cI._SceneComponentInitialization=e=>{throw(0,rU.S)("ShadowGeneratorSceneComponent")},(0,rY.PS)(rz.l.NAME_SHADOWGENERATOR,(e,t)=>{if(void 0!==e.shadowGenerators&&null!==e.shadowGenerators)for(let i=0,r=e.shadowGenerators.length;i<r;i++){let r=e.shadowGenerators[i];r.className===cI.CLASSNAME?cI.Parse(r,t):cm.Parse(r,t)}});class cP{constructor(e){this.name=rz.l.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(rz.l.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){for(let t of(e.shadowGenerators=[],this.scene.lights)){let i=t.getShadowGenerators();if(i){let t=i.values();for(let i=t.next();!0!==i.done;i=t.next()){let t=i.value;e.shadowGenerators.push(t.serialize())}}}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){let t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){let r=t.lights[i],s=r.getShadowGenerators();if(r.isEnabled()&&r.shadowEnabled&&s){let i=s.values();for(let r=i.next();!0!==r.done;r=i.next()){let i=r.value.getShadowMap();-1!==t.textures.indexOf(i)&&e.push(i)}}}}}cm._SceneComponentInitialization=e=>{let t=e._getComponent(rz.l.NAME_SHADOWGENERATOR);t||(t=new cP(e),e._addComponent(t))},i(7434),i(48592),i(69639),i(11395),i(76720),i(17791),i(63023),i(820),sC.N.AddNodeConstructor("Light_Type_0",(e,t)=>()=>new cR(e,i1.P.Zero(),t));class cR extends oj{get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){let t=this.needCube();if(this._direction=e,this.needCube()!==t&&this._shadowGenerators){let e=this._shadowGenerators.values();for(let t=e.next();!0!==t.done;t=e.next())t.value.recreateShadowMap()}}constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}getClassName(){return"PointLight"}getTypeID(){return rN._.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new i1.P(1,0,0);case 1:return new i1.P(-1,0,0);case 2:return new i1.P(0,-1,0);case 3:return new i1.P(0,1,0);case 4:return new i1.P(0,0,1);case 5:return new i1.P(0,0,-1)}return i1.P.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){let r=this.getScene().activeCamera;if(!r)return;let s=void 0!==this.shadowMinZ?this.shadowMinZ:r.minZ,n=void 0!==this.shadowMaxZ?this.shadowMaxZ:r.maxZ,a=this.getScene().getEngine().useReverseDepthBuffer;i1.y3.PerspectiveFovLHToRef(this.shadowAngle,1,a?n:s,a?s:n,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,a)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}(0,r$.gn)([(0,rj.qC)()],cR.prototype,"shadowAngle",null),(0,i3.H7)("BABYLON.PointLight",cR);class cA{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{let e=this._renderingCanvas.getBoundingClientRect(),t=window.getComputedStyle(this._renderingCanvas).position;this._loadingDiv&&(this._loadingDiv.style.position="fixed"===t?"fixed":"absolute",this._loadingDiv.style.left=e.left+"px",this._loadingDiv.style.top=e.top+"px",this._loadingDiv.style.width=e.width+"px",this._loadingDiv.style.height=e.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css";let e=`@-webkit-keyframes spin1 {\
                    0% { -webkit-transform: rotate(0deg);}
                    100% { -webkit-transform: rotate(360deg);}
                }\
                @keyframes spin1 {\
                    0% { transform: rotate(0deg);}
                    100% { transform: rotate(360deg);}
                }`;this._style.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(this._style);let t=!!window.SVGSVGElement,i=new Image;cA.DefaultLogoUrl?i.src=cA.DefaultLogoUrl:i.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",i.style.width="150px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";let r=document.createElement("div");r.style.width="300px",r.style.gridColumn="1",r.style.gridRow="1",r.style.top="50%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.position="absolute";let s=new Image;if(cA.DefaultSpinnerUrl?s.src=cA.DefaultSpinnerUrl:s.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",s.style.animation="spin1 0.75s infinite linear",s.style.transformOrigin="50% 50%",!t){let e={w:16,h:18.5},t={w:30,h:30};i.style.width=`${e.w}vh`,i.style.height=`${e.h}vh`,i.style.left=`calc(50% - ${e.w/2}vh)`,i.style.top=`calc(50% - ${e.h/2}vh)`,s.style.width=`${t.w}vh`,s.style.height=`${t.h}vh`,s.style.left=`calc(50% - ${t.w/2}vh)`,s.style.top=`calc(50% - ${t.h/2}vh)`}r.appendChild(s),this._loadingDiv.appendChild(i),this._loadingDiv.appendChild(r),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){this._loadingDiv&&(this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)}))}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}cA.DefaultLogoUrl="",cA.DefaultSpinnerUrl="",rV.a.DefaultLoadingScreenFactory=e=>new cA(e);var cM=i(66415),cN=i(25074),cO=i(32958),cD=i(94480),cF=i(85774);class cL{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);let i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){let t=e.getSize().width,i=(0,aP.ILog2)(t)+1,r=this._effectWrapper.effect,s=this._createRenderTarget(t);this._effectRenderer.saveStates(),this._effectRenderer.setViewport();let n=e.getInternalTexture();n&&this._engine.updateTextureSamplingMode(3,n,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let a=[[new aN.P(0,0,-1),new aN.P(0,-1,0),new aN.P(1,0,0)],[new aN.P(0,0,1),new aN.P(0,-1,0),new aN.P(-1,0,0)],[new aN.P(1,0,0),new aN.P(0,0,1),new aN.P(0,1,0)],[new aN.P(1,0,0),new aN.P(0,0,-1),new aN.P(0,-1,0)],[new aN.P(1,0,0),new aN.P(0,-1,0),new aN.P(0,0,1)],[new aN.P(-1,0,0),new aN.P(0,-1,0),new aN.P(0,0,-1)]];r.setFloat("hdrScale",this.hdrScale),r.setFloat2("vFilteringInfo",e.getSize().width,i),r.setTexture("inputTexture",e);for(let e=0;e<6;e++){r.setVector3("up",a[e][0]),r.setVector3("right",a[e][1]),r.setVector3("front",a[e][2]);for(let n=0;n<i;n++){this._engine.bindFramebuffer(s,e,void 0,void 0,!0,n),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let i=Math.pow(2,(n-this._lodGenerationOffset)/this._lodGenerationScale)/t;0===n&&(i=0),r.setFloat("alphaG",i),this._effectRenderer.draw()}}this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture);let o=s.texture.type,l=s.texture.format;return s._swapAndDie(e._texture),e._texture.type=o,e._texture.format=l,e.gammaSpace=!1,e.lodGenerationOffset=this._lodGenerationOffset,e.lodGenerationScale=this._lodGenerationScale,e._prefiltered=!0,e}_createEffect(e,t){let r=[];e.gammaSpace&&r.push("#define GAMMA_INPUT"),r.push("#define NUM_SAMPLES "+this.quality+"u");let s=this._engine.isWebGPU;return new cF.H({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:r,onCompiled:t,shaderLanguage:s?1:0,extraInitializationsAsync:async()=>{s?await Promise.all([Promise.resolve().then(i.bind(i,54625)),Promise.resolve().then(i.bind(i,74988))]):await Promise.all([Promise.resolve().then(i.bind(i,81438)),Promise.resolve().then(i.bind(i,35275))])}})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new cF.I(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(re.Y.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}i(78344);class cw extends o1.V{set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(i1.y3.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;let t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}constructor(e,t,i,r=!1,s=!0,n=!1,a=!1,o=null,l=null,c=!1){if(super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=i1.P.Zero(),this.onLoadObservable=new i0.y$,!e)return;this._coordinatesMode=rZ.x.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=i1.y3.Identity(),this._prefilterOnLoad=a,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),o&&o()},this._onError=l,this.gammaSpace=n,this._noMipmap=r,this._size=i,this._supersample=c,this._generateHarmonics=s,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?rD.w1.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):this.getScene()?.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}getClassName(){return"HDRCubeTexture"}_loadTexture(){let e=this._getEngine(),t=e.getCaps(),i=0;if(t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2),e._features.allowTexturePrefiltering&&this._prefilterOnLoad){let t=this._onLoad,i=new cL(e);this._onLoad=()=>{i.prefilter(this,t)}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,e=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;let t=(0,cO.od)(e,this._size,this._supersample);if(this._generateHarmonics){let e=cD.$.ConvertCubeMapToSphericalPolynomial(t);this.sphericalPolynomial=e}let r=[],s=null,n=null;for(let e=0;e<6;e++){2===i?n=new Uint16Array(this._size*this._size*3):0===i&&(s=new Uint8Array(this._size*this._size*3));let a=t[cw._FacesMapping[e]];if(this.gammaSpace||n||s){for(let e=0;e<this._size*this._size;e++)if(this.gammaSpace&&(a[3*e+0]=Math.pow(a[3*e+0],r2.zp),a[3*e+1]=Math.pow(a[3*e+1],r2.zp),a[3*e+2]=Math.pow(a[3*e+2],r2.zp)),n&&(n[3*e+0]=(0,a1.ay)(a[3*e+0]),n[3*e+1]=(0,a1.ay)(a[3*e+1]),n[3*e+2]=(0,a1.ay)(a[3*e+2])),s){let t=Math.max(255*a[3*e+0],0),i=Math.max(255*a[3*e+1],0),r=Math.max(255*a[3*e+2],0),n=Math.max(Math.max(t,i),r);if(n>255){let e=255/n;t*=e,i*=e,r*=e}s[3*e+0]=t,s[3*e+1]=i,s[3*e+2]=r}}n?r.push(n):s?r.push(s):r.push(a)}return r},null,this._onLoad,this._onError)}clone(){let e=new cw(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&this.getScene()?.markAllMaterialsAsDirty(1,e=>e.getActiveTextures().indexOf(this)!==-1)}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(e,t,i){let r=null;return e.name&&!e.isRenderTarget&&((r=new cw(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace)).name=e.name,r.hasAlpha=e.hasAlpha,r.level=e.level,r.coordinatesMode=e.coordinatesMode,r.isBlocking=e.isBlocking),r&&(e.boundingBoxPosition&&(r.boundingBoxPosition=i1.P.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(r.boundingBoxSize=i1.P.FromArray(e.boundingBoxSize)),e.rotationY&&(r.rotationY=e.rotationY)),r}serialize(){if(!this.name)return null;let e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}}cw._FacesMapping=["right","left","up","down","front","back"],(0,i3.H7)("BABYLON.HDRCubeTexture",cw);class cB{get influence(){return this._influence}set influence(e){if(this._influence===e)return;let t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(0===t||0===e)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}constructor(e,t=0,i=null){this.name=e,this.animations=[],this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new i0.y$,this._onDataLayoutChanged=new i0.y$,this._animationPropertiesOverride=null,this._scene=i||rh.l.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){let t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){let t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){let t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){let t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){let e=rq.p.Clone(()=>new cB(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){let e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),null!=this.id&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),rq.p.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){let i=new cB(e.name,e.influence);if(i.setPositions(e.positions),null!=e.id&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let t=0;t<e.animations.length;t++){let r=e.animations[t],s=(0,i3.qw)("BABYLON.Animation");s&&i.animations.push(s.Parse(r))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);let r=new cB(t,i,e.getScene());return r.setPositions(e.getVerticesData(st.o.PositionKind)),e.isVerticesDataPresent(st.o.NormalKind)&&r.setNormals(e.getVerticesData(st.o.NormalKind)),e.isVerticesDataPresent(st.o.TangentKind)&&r.setTangents(e.getVerticesData(st.o.TangentKind)),e.isVerticesDataPresent(st.o.UVKind)&&r.setUVs(e.getVerticesData(st.o.UVKind)),r}}(0,r$.gn)([(0,rj.qC)()],cB.prototype,"id",void 0);class cV extends rZ.x{get depth(){return this._depth}constructor(e,t,i,r,s,n,a=!0,o=!1,l=rZ.x.TRILINEAR_SAMPLINGMODE,c=0,u){super(null,n,!a,o),this.format=s,this._texture=n.getEngine().createRawTexture2DArray(e,t,i,r,s,a,o,l,null,c,u),this._depth=r,this.is2DArray=!0}update(e){this._texture&&this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,r,s,n=!0,a=!1,o=3,l=0){return new cV(e,t,i,r,5,s,n,a,o,l)}}class cU{set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}constructor(e=null){if(this._targets=[],this._targetInfluenceChangedObservers=[],this._targetDataLayoutChangedObservers=[],this._activeTargets=new nV.t(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._uniqueId=0,this._tempInfluences=[],this._canUseTextureForTargets=!1,this._blockCounter=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._numMaxInfluencers=0,this._useTextureToStoreTargets=!0,e||(e=rh.l.LastCreatedScene),this._scene=e,this._scene){this._scene.addMorphTargetManager(this),this._uniqueId=this._scene.getUniqueId();let e=this._scene.getEngine().getCaps();this._canUseTextureForTargets=e.canUseGLVertexID&&e.textureFloat&&e.maxVertexTextureImageUnits>0&&e.texture2DArrayMaxLayerCount>1}}get numMaxInfluencers(){return this._numMaxInfluencers}set numMaxInfluencers(e){this._numMaxInfluencers!==e&&(this._numMaxInfluencers=e,this._syncActiveTargets(!0))}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){return cU.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets&&!this._scene?.getEngine().getCaps().disableMorphTargetTexture}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}getTargetByName(e){for(let t of this._targets)if(t.name===e)return t;return null}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(e=>{this._syncActiveTargets(e)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){let t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0)),this._scene&&this._scene.stopAnimation(e)}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture),e.setInt("morphTargetCount",this.numInfluencers)}clone(){let e=new cU(this._scene);for(let t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){let e={};for(let t of(e.id=this.uniqueId,e.targets=[],this._targets))e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,this._scene&&this._targets.length>this._scene.getEngine().getCaps().texture2DArrayMaxLayerCount&&(this.useTextureToStoreTargets=!1),this._morphTargetTextureIndices&&this._morphTargetTextureIndices.length===this._targets.length||(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(let e of this._targets){if(i++,0===e.influence&&this.optimizeInfluencers)continue;if(this._activeTargets.length>=cU.MaxActiveMorphTargetsInVertexAttributeMode&&!this.isUsingTextureForTargets)break;this._activeTargets.push(e),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=e.influence,this._supportsNormals=this._supportsNormals&&e.hasNormals,this._supportsTangents=this._supportsTangents&&e.hasTangents,this._supportsUVs=this._supportsUVs&&e.hasUVs;let r=e.getPositions();if(r){let e=r.length/3;if(0===this._vertexCount)this._vertexCount=e;else if(this._vertexCount!==e){re.Y.Error("Incompatible target. Targets must all have the same vertices count.");return}}}this._morphTargetTextureIndices.length!==t&&(this._morphTargetTextureIndices=this._morphTargetTextureIndices.slice(0,t)),this._influences&&this._influences.length===t||(this._influences=new Float32Array(t));for(let e=0;e<t;e++)this._influences[e]=this._tempInfluences[e];e&&this.synchronize()}synchronize(){if(this._scene&&!this.areUpdatesFrozen){if(this.isUsingTextureForTargets&&(this._vertexCount||this.numMaxInfluencers>0)){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride||1,this._textureHeight=1;let e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){let e=this._targetStoreTexture.getSize();e.width===this._textureWidth&&e.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();let e=this._targets.length,t=new Float32Array(e*this._textureWidth*this._textureHeight*4),i=0;for(let r=0;r<e;r++){let e=this._targets[r],s=e.getPositions(),n=e.getNormals(),a=e.getUVs(),o=e.getTangents();if(!s){0===r&&re.Y.Error("Invalid morph target. Target must have positions.");return}i=r*this._textureWidth*this._textureHeight*4;for(let e=0;e<this._vertexCount;e++)t[i]=s[3*e],t[i+1]=s[3*e+1],t[i+2]=s[3*e+2],i+=4,this._supportsNormals&&n&&(t[i]=n[3*e],t[i+1]=n[3*e+1],t[i+2]=n[3*e+2],i+=4),this._supportsUVs&&a&&(t[i]=a[2*e],t[i+1]=a[2*e+1],i+=4),this._supportsTangents&&o&&(t[i]=o[3*e],t[i+1]=o[3*e+1],t[i+2]=o[3*e+2],i+=4)}this._targetStoreTexture=cV.CreateRGBATexture(t,this._textureWidth,this._textureHeight,e,this._scene,!1,!1,1,1)}}for(let e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene){if(this._scene.removeMorphTargetManager(this),this._parentContainer){let e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}for(let e of this._targets)this._scene.stopAnimation(e)}}static Parse(e,t){let i=new cU(t);for(let r of(i._uniqueId=e.id,e.targets))i.addTarget(cB.Parse(r,t));return i}}cU.EnableTextureStorage=!0,cU.MaxActiveMorphTargetsInVertexAttributeMode=8;class ck{constructor(){this._hasHit=!1,this._hitNormal=i1.P.Zero(),this._hitPoint=i1.P.Zero(),this._triangleIndex=-1}get hitPoint(){return this._hitPoint}get hitNormal(){return this._hitNormal}get hasHit(){return this._hasHit}get triangleIndex(){return this._triangleIndex}setHitData(e,t,i){this._hasHit=!0,this._hitNormal.set(e.x,e.y,e.z),this._hitPoint.set(t.x,t.y,t.z),this._triangleIndex=i??-1}reset(){this._hasHit=!1,this._hitNormal.setAll(0),this._hitPoint.setAll(0),this._triangleIndex=-1,this.body=void 0,this.bodyIndex=void 0,this.shape=void 0}}class cG extends ck{constructor(){super(...arguments),this._hitDistance=0,this._rayFromWorld=i1.P.Zero(),this._rayToWorld=i1.P.Zero()}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormal}get hitPointWorld(){return this._hitPoint}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=i1.P.Distance(this._rayFromWorld,this._hitPoint)}reset(e=i1.P.Zero(),t=i1.P.Zero()){super.reset(),this._rayFromWorld.copyFrom(e),this._rayToWorld.copyFrom(t),this._hitDistance=0}}class cz{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,rU.S)("CannonJSPlugin")}constructor(e,t=cz.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new i1.P(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){let t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){let r={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(r),this._physicsPlugin.generateJoint(r)}removeJoint(e,t,i){let r=this._joints.filter(function(r){return r.connectedImpostor===t&&r.joint===i&&r.mainImpostor===e});r.length&&this._physicsPlugin.removeJoint(r[0])}_step(e){this._impostors.forEach(e=>{e.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(e)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}raycastToRef(e,t,i){return this._physicsPlugin.raycastToRef(e,t,i)}}class cH{constructor(e=!0,t=10,i=CANNON){if(this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=[],this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=[],this._firstFrame=!0,this._tmpQuaternion=new i1._f,this._minus90X=new i1._f(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new i1._f(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=i1.P.Zero(),this._tmpDeltaPosition=i1.P.Zero(),this._tmpUnityRotation=new i1._f,this.BJSCANNON=i,!this.isSupported()){re.Y.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new cG}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame)for(let e of(this._firstFrame=!1,t))e.type==nq.HeightmapImpostor||e.type===nq.PlaneImpostor||e.beforeStep();this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(e=>{"function"==typeof this.world.removeBody?this.world.removeBody(e):this.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){let r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(s,r)}applyForce(e,t,i){let r=new this.BJSCANNON.Vec3(i.x,i.y,i.z),s=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(s,r)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){let t=this._createShape(e);if(!t){re.Y.Warn("It was not possible to create a physics body for this object.");return}let i=e.physicsBody;i&&this.removePhysicsBody(e);let r=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),s={mass:e.getParam("mass"),material:r},n=e.getParam("nativeOptions");for(let e in n)Object.prototype.hasOwnProperty.call(n,e)&&(s[e]=n[e]);e.physicsBody=new this.BJSCANNON.Body(s),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),"function"==typeof this.world.addBody?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(t){let r=i[t];e.physicsBody[t].set(r.x,r.y,r.z)}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}_processChildMeshes(e){let t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){let i=t=>{if(!t.rotationQuaternion)return;let r=t.getPhysicsImpostor();if(r&&r.parent!==e&&t.parent){let i=t.getAbsolutePosition().subtract(t.parent.getAbsolutePosition()),s=t.rotationQuaternion.multiply(this._tmpQuaternion);r.physicsBody&&(this.removePhysicsBody(r),r.physicsBody=null),r.parent=e,r.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(r),new this.BJSCANNON.Vec3(i.x,i.y,i.z),new this.BJSCANNON.Quaternion(s.x,s.y,s.z,s.w)),e.physicsBody.mass+=r.getParam("mass")}t.getChildMeshes(!0).filter(e=>!!e.physicsImpostor).forEach(i)};t.filter(e=>!!e.physicsImpostor).forEach(i)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),-1===this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){let t;let i=e.mainImpostor.physicsBody,r=e.connectedImpostor.physicsBody;if(!i||!r)return;let s=e.joint.jointData,n={pivotA:s.mainPivot?new this.BJSCANNON.Vec3().set(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z):null,pivotB:s.connectedPivot?new this.BJSCANNON.Vec3().set(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z):null,axisA:s.mainAxis?new this.BJSCANNON.Vec3().set(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z):null,axisB:s.connectedAxis?new this.BJSCANNON.Vec3().set(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z):null,maxForce:s.nativeParams.maxForce,collideConnected:!!s.collision};switch(e.joint.type){case nj.HingeJoint:case nj.Hinge2Joint:t=new this.BJSCANNON.HingeConstraint(i,r,n);break;case nj.DistanceJoint:t=new this.BJSCANNON.DistanceConstraint(i,r,s.maxDistance||2);break;case nj.SpringJoint:t=new this.BJSCANNON.Spring(i,r,{restLength:s.length,stiffness:s.stiffness,damping:s.damping,localAnchorA:n.pivotA,localAnchorB:n.pivotB});break;case nj.LockJoint:t=new this.BJSCANNON.LockConstraint(i,r,n);break;case nj.PointToPointJoint:case nj.BallAndSocketJoint:default:t=new this.BJSCANNON.PointToPointConstraint(i,n.pivotA,r,n.pivotB,n.maxForce)}t.collideConnected=!!s.collision,e.joint.physicsJoint=t,e.joint.type!==nj.SpringJoint?this.world.addConstraint(t):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){t.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==nj.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let r,s;for(r=0;r<this._physicsMaterials.length;r++)if((s=this._physicsMaterials[r]).friction===t&&s.restitution===i)return s;let n=new this.BJSCANNON.Material(e);return n.friction=t,n.restitution=i,this._physicsMaterials.push(n),n}_checkWithEpsilon(e){return e<r2.kn?r2.kn:e}_createShape(e){let t;let i=e.object,r=e.getObjectExtents();switch(e.type){case nq.SphereImpostor:{let e=r.x,i=r.y,s=r.z;t=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(e),this._checkWithEpsilon(i),this._checkWithEpsilon(s))/2);break}case nq.CylinderImpostor:{let i=e.getParam("nativeOptions");i||(i={});let s=void 0!==i.radiusTop?i.radiusTop:this._checkWithEpsilon(r.x)/2,n=void 0!==i.radiusBottom?i.radiusBottom:this._checkWithEpsilon(r.x)/2,a=void 0!==i.height?i.height:this._checkWithEpsilon(r.y),o=void 0!==i.numSegments?i.numSegments:16;t=new this.BJSCANNON.Cylinder(s,n,a,o);let l=new this.BJSCANNON.Quaternion;l.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);let c=new this.BJSCANNON.Vec3(0,0,0);t.transformAllPoints(c,l);break}case nq.BoxImpostor:{let e=r.scale(.5);t=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(e.x),this._checkWithEpsilon(e.y),this._checkWithEpsilon(e.z)));break}case nq.PlaneImpostor:re.Y.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),t=new this.BJSCANNON.Plane;break;case nq.MeshImpostor:{let r;let s=i.getVerticesData?i.getVerticesData(st.o.PositionKind):[],n=i.getIndices?i.getIndices():[];if(!s){re.Y.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}let a=i.position.clone(),o=i.rotation&&i.rotation.clone(),l=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0),i.rotation&&i.rotation.copyFromFloats(0,0,0),i.rotationQuaternion&&i.rotationQuaternion.copyFrom(e.getParentsRotation()),i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace();let c=i.computeWorldMatrix(!0),u=[];for(r=0;r<s.length;r+=3)i1.P.TransformCoordinates(i1.P.FromArray(s,r),c).toArray(u,r);re.Y.Warn("MeshImpostor only collides against spheres."),t=new this.BJSCANNON.Trimesh(u,n),i.position.copyFrom(a),o&&i.rotation&&i.rotation.copyFrom(o),l&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(l);break}case nq.HeightmapImpostor:{let r=i.position.clone(),s=i.rotation&&i.rotation.clone(),n=i.rotationQuaternion&&i.rotationQuaternion.clone();i.position.copyFromFloats(0,0,0),i.rotation&&i.rotation.copyFromFloats(0,0,0),i.rotationQuaternion&&i.rotationQuaternion.copyFrom(e.getParentsRotation()),i.rotationQuaternion&&i.parent&&i.rotationQuaternion.conjugateInPlace(),i.rotationQuaternion&&i.rotationQuaternion.multiplyInPlace(this._minus90X),t=this._createHeightmap(i),i.position.copyFrom(r),s&&i.rotation&&i.rotation.copyFrom(s),n&&i.rotationQuaternion&&i.rotationQuaternion.copyFrom(n),i.computeWorldMatrix(!0);break}case nq.ParticleImpostor:t=new this.BJSCANNON.Particle;break;case nq.NoImpostor:t=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0))}return t}_createHeightmap(e,t){let i,r=e.getVerticesData(st.o.PositionKind),s=e.computeWorldMatrix(!0),n=[];for(i=0;i<r.length;i+=3)i1.P.TransformCoordinates(i1.P.FromArray(r,i),s).toArray(n,i);r=n;let a=[],o=t||~~(Math.sqrt(r.length/3)-1),l=e.getBoundingInfo(),c=Math.min(l.boundingBox.extendSizeWorld.x,l.boundingBox.extendSizeWorld.y),u=l.boundingBox.extendSizeWorld.z,h=2*c/o;for(let e=0;e<r.length;e+=3){let t=Math.round(r[e+0]/h+o/2),i=Math.round(-((r[e+1]/h-o/2)*1)),s=-r[e+2]+u;a[t]||(a[t]=[]),a[t][i]||(a[t][i]=s),a[t][i]=Math.max(s,a[t][i])}for(let e=0;e<=o;++e){if(!a[e]){let t=1;for(;!a[(e+t)%o];)t++;a[e]=a[(e+t)%o].slice()}for(let t=0;t<=o;++t)if(!a[e][t]){let i,r=1;for(;void 0===i;)i=a[e][(t+r++)%o];a[e][t]=i}}let d=new this.BJSCANNON.Heightfield(a,{elementSize:h});return d.minY=u,d}_updatePhysicsBodyTransformation(e){let t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;let i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let r=t.rotationQuaternion;if(r){if((e.type===nq.PlaneImpostor||e.type===nq.HeightmapImpostor)&&(r=r.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===nq.HeightmapImpostor){let e=t.getBoundingInfo(),r=t.rotationQuaternion;t.rotationQuaternion=this._tmpUnityRotation,t.computeWorldMatrix(!0);let s=i.clone(),n=t.getPivotMatrix();n=n?n.clone():i1.y3.Identity();let a=i1.y3.Translation(e.boundingBox.extendSizeWorld.x,0,-e.boundingBox.extendSizeWorld.z);t.setPreTransformMatrix(a),t.computeWorldMatrix(!0);let o=(e=t.getBoundingInfo()).boundingBox.centerWorld.subtract(i).subtract(t.position).negate();this._tmpPosition.copyFromFloats(o.x,o.y-e.boundingBox.extendSizeWorld.y,o.z),this._tmpDeltaPosition.copyFrom(e.boundingBox.centerWorld.subtract(s)),this._tmpDeltaPosition.y+=e.boundingBox.extendSizeWorld.y,t.rotationQuaternion=r,t.setPreTransformMatrix(n),t.computeWorldMatrix(!0)}else e.type===nq.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(r.x,r.y,r.z,r.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){let t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return void 0!==this.BJSCANNON}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){let t=e.physicsBody.velocity;return t?new i1.P(t.x,t.y,t.z):null}getAngularVelocity(e){let t=e.physicsBody.angularVelocity;return t?new i1.P(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,r){!r&&(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=void 0===t?-t:t}syncMeshWithImpostor(e,t){let i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){let i=e.physicsBody.shapes[0];t.x=2*i.halfExtents.x,t.y=2*i.halfExtents.y,t.z=2*i.halfExtents.z}dispose(){}_extendNamespace(){let e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,r,s){if(s=s||10,0===(r=r||0))this.internalStep(i),this.time+=i;else{let n=Math.floor((this.time+r)/i)-Math.floor(this.time/i);n=Math.min(n,s)||1;let a=performance.now();for(let e=0;e!==n&&(this.internalStep(i),!(performance.now()-a>1e3*i));e++);this.time+=r;let o=this.time%i/i,l=this.bodies;for(let i=0;i!==l.length;i++){let r=l[i];r.type!==t.Body.STATIC&&r.sleepState!==t.Body.SLEEPING?(r.position.vsub(r.previousPosition,e),e.scale(o,e),r.position.vadd(e,r.interpolatedPosition)):(r.interpolatedPosition.set(r.position.x,r.position.y,r.position.z),r.interpolatedQuaternion.set(r.quaternion.x,r.quaternion.y,r.quaternion.z,r.quaternion.w))}}}}raycast(e,t){return this._raycastResult.reset(e,t),this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),i.reset(e,t),this._cannonRaycastResult.hasHit&&(i.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),i.setHitDistance(this._cannonRaycastResult.distance))}}cz.DefaultPluginFactory=()=>new cH;class cW{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=i1.P.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new cG}getPluginVersion(){return 1}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach(function(e){e.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach(e=>{e.afterStep(),this._tmpImpostorsArray[e.uniqueId]=e});let i=this.world.contacts;for(;null!==i;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}let e=this._tmpImpostorsArray[+i.body1.name],t=this._tmpImpostorsArray[+i.body2.name];if(!e||!t){i=i.next;continue}e.onCollide({body:t.physicsBody,point:null,distance:0,impulse:0,normal:null}),t.onCollide({body:e.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next}}applyImpulse(e,t,i){let r=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*r))}applyForce(e,t,i){re.Y.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){var t;let i={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:0!==e.getParam("mass"),density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},r=[e];(t=e.object).getChildMeshes&&t.getChildMeshes().forEach(function(e){e.physicsImpostor&&r.push(e.physicsImpostor)});let s=e=>Math.max(e,r2.kn),n=new i1._f;r.forEach(t=>{if(!t.object.rotationQuaternion)return;let r=t.object.rotationQuaternion;n.copyFrom(r),t.object.rotationQuaternion.set(0,0,0,1),t.object.computeWorldMatrix(!0);let a=n.toEulerAngles(),o=t.getObjectExtents();if(t===e){let t=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(t,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),i.pos.push(t.x),i.pos.push(t.y),i.pos.push(t.z),i.posShape.push(0,0,0),i.rotShape.push(0,0,0)}else{let e=t.object.position.clone();i.posShape.push(e.x),i.posShape.push(e.y),i.posShape.push(e.z),i.rotShape.push(57.29577951308232*a.x,57.29577951308232*a.y,57.29577951308232*a.z)}switch(t.object.rotationQuaternion.copyFrom(n),t.type){case nq.ParticleImpostor:re.Y.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case nq.SphereImpostor:{let e=o.x,t=o.y,r=o.z,n=Math.max(s(e),s(t),s(r))/2;i.type.push("sphere"),i.size.push(n),i.size.push(n),i.size.push(n);break}case nq.CylinderImpostor:{let e=s(o.x)/2,t=s(o.y);i.type.push("cylinder"),i.size.push(e),i.size.push(t),i.size.push(t);break}case nq.PlaneImpostor:case nq.BoxImpostor:default:{let e=s(o.x),t=s(o.y),r=s(o.z);i.type.push("box"),i.size.push(e),i.size.push(t),i.size.push(r)}}t.object.rotationQuaternion=r}),e.physicsBody=this.world.add(i),e.physicsBody.resetQuaternion(n),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){let t;let i=e.mainImpostor.physicsBody,r=e.connectedImpostor.physicsBody;if(!i||!r)return;let s=e.joint.jointData,n=s.nativeParams||{},a={body1:i,body2:r,axe1:n.axe1||(s.mainAxis?s.mainAxis.asArray():null),axe2:n.axe2||(s.connectedAxis?s.connectedAxis.asArray():null),pos1:n.pos1||(s.mainPivot?s.mainPivot.asArray():null),pos2:n.pos2||(s.connectedPivot?s.connectedPivot.asArray():null),min:n.min,max:n.max,collision:n.collision||s.collision,spring:n.spring,world:this.world};switch(e.joint.type){case nj.BallAndSocketJoint:t="jointBall";break;case nj.SpringJoint:re.Y.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead"),a.min=s.length||a.min,a.max=Math.max(a.min,a.max);case nj.DistanceJoint:t="jointDistance",a.max=s.maxDistance;break;case nj.PrismaticJoint:t="jointPrisme";break;case nj.SliderJoint:t="jointSlide";break;case nj.WheelJoint:t="jointWheel";break;case nj.HingeJoint:default:t="jointHinge"}a.type=t,e.joint.physicsJoint=this.world.add(a)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(e){re.Y.Warn(e)}}isSupported(){return void 0!==this.BJSOIMO}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{let t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){let t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){let r=e.physicsBody;e.physicsBody.shapes.next||(r.position.set(t.x,t.y,t.z),r.orientation.set(i.x,i.y,i.z,i.w),r.syncShapes(),r.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){let t=e.physicsBody.linearVelocity;return t?new i1.P(t.x,t.y,t.z):null}getAngularVelocity(e){let t=e.physicsBody.angularVelocity;return t?new i1.P(t.x,t.y,t.z):null}setBodyMass(e,t){let i=0===t;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,void 0!==i&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,r){void 0!==i?re.Y.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;let s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setMotor(t,i)}setLimit(e,t,i,r){let s=r?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;s&&s.setLimit(t,void 0===i?-t:i)}syncMeshWithImpostor(e,t){let i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){let i=e.physicsBody.shapes;t.x=2*i.halfWidth,t.y=2*i.halfHeight,t.z=2*i.halfDepth}dispose(){this.world.clear()}raycast(e,t){return re.Y.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}raycastToRef(e,t,i){re.Y.Warn("raycast is not currently supported by the Oimo physics plugin"),i.reset(e,t)}}class cY{constructor(e=!0,t=Ammo,i=null){if(this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new i1._f,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new i1.P,this._tmpContactNormal=new i1.P,this._tmpVec3=new i1.P,this._tmpMatrix=new i1.y3,"function"==typeof t){re.Y.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}if(this.bjsAMMO=t,!this.isSupported()){re.Y.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=e=>{let t=(e=this.bjsAMMO.wrapPointer(e,this.bjsAMMO.btManifoldPoint)).getPositionWorldOnA(),i=e.m_normalWorldOnB;this._tmpContactPoint.x=t.x(),this._tmpContactPoint.y=t.y(),this._tmpContactPoint.z=t.z(),this._tmpContactNormal.x=i.x(),this._tmpContactNormal.y=i.y(),this._tmpContactNormal.z=i.z(),this._tmpContactImpulse=e.getAppliedImpulse(),this._tmpContactDistance=e.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new cG,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}getPluginVersion(){return 1}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(0==t)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(let e of t)e.soft||e.beforeStep();for(let i of(this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep),t))if(i.soft?this._afterSoftStep(i):i.afterStep(),i._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(i))for(let e of i._onPhysicsCollideCallbacks)for(let t of e.otherImpostors)(i.physicsBody.isActive()||t.physicsBody.isActive())&&this._isImpostorPairInContact(i,t)&&(i.onCollide({body:t.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),t.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===nq.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){let t,i,r,s;let n=e.physicsBody.get_m_nodes(),a=n.size(),o=[];for(let e=0;e<a;e++)i=(t=n.at(e).get_m_x()).x(),r=t.y(),s=t.z(),o.push(new i1.P(i,r,s));let l=e.object,c=e.getParam("shape");e._isFromLine?e.object=(0,nJ.nL)("lines",{points:o,instance:l}):e.object=(0,n2.Gc)("ext",{shape:c,path:o,instance:l})}_softbodyOrClothStep(e){let t,i,r,s,n,a,o,l;let c=e.type===nq.ClothImpostor?1:-1,u=e.object,h=u.getVerticesData(st.o.PositionKind);h||(h=[]);let d=u.getVerticesData(st.o.NormalKind);d||(d=[]);let f=h.length/3,p=e.physicsBody.get_m_nodes();for(let e=0;e<f;e++){r=(i=(t=p.at(e)).get_m_x()).x(),s=i.y(),n=i.z()*c;let u=t.get_m_n();a=u.x(),o=u.y(),l=u.z()*c,h[3*e]=r,h[3*e+1]=s,h[3*e+2]=n,d[3*e]=a,d[3*e+1]=o,d[3*e+2]=l}let m=new nK.x;m.positions=h,m.normals=d,m.uvs=u.getVerticesData(st.o.UVKind),m.colors=u.getVerticesData(st.o.ColorKind),u&&u.getIndices&&(m.indices=u.getIndices()),m.applyToMesh(u)}applyImpulse(e,t,i){if(e.soft)re.Y.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();let r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),r.setValue(i.x,i.y,i.z),s.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(s,r)}}applyForce(e,t,i){if(e.soft)re.Y.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();let r=this._tmpAmmoVectorA,s=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){let t=e.object.getWorldMatrix().getTranslation();r.setValue(i.x-t.x,i.y-t.y,i.z-t.z)}else r.setValue(i.x,i.y,i.z);s.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(s,r)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){let t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(cY._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===nq.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{let r=new this.bjsAMMO.btVector3(0,0,0),s=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),s.setIdentity(),0!==i&&t.calculateLocalInertia(i,r),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),s.setOrigin(this._tmpAmmoVectorA),s.setRotation(this._tmpAmmoQuaternion);let n=new this.bjsAMMO.btDefaultMotionState(s),a=new this.bjsAMMO.btRigidBodyConstructionInfo(i,n,t,r),o=new this.bjsAMMO.btRigidBody(a);if(0===i&&(o.setCollisionFlags(o.getCollisionFlags()|cY._KINEMATIC_FLAG),o.setActivationState(cY._DISABLE_DEACTIVATION_FLAG)),e.type!=nq.NoImpostor||t.getChildShape||o.setCollisionFlags(o.getCollisionFlags()|cY._DISABLE_COLLISION_FLAG),e.type!==nq.MeshImpostor&&e.type!==nq.NoImpostor){let t=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(t.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}let l=e.getParam("group"),c=e.getParam("mask");l&&c?this.world.addRigidBody(o,l,c):this.world.addRigidBody(o),e.physicsBody=o,e._pluginData.toDispose=e._pluginData.toDispose.concat([o,a,n,s,r,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData&&(e._pluginData.toDispose.forEach(e=>{this.bjsAMMO.destroy(e)}),e._pluginData.toDispose=[]))}generateJoint(e){let t;let i=e.mainImpostor.physicsBody,r=e.connectedImpostor.physicsBody;if(!i||!r||e.joint.physicsJoint)return;let s=e.joint.jointData;switch(s.mainPivot||(s.mainPivot=new i1.P(0,0,0)),s.connectedPivot||(s.connectedPivot=new i1.P(0,0,0)),e.joint.type){case nj.DistanceJoint:{let e=s.maxDistance;e&&(s.mainPivot=new i1.P(0,-e/2,0),s.connectedPivot=new i1.P(0,e/2,0));let n=this._tmpAmmoVectorA;n.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let a=this._tmpAmmoVectorB;a.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),t=new this.bjsAMMO.btPoint2PointConstraint(i,r,n,a);break}case nj.HingeJoint:{s.mainAxis||(s.mainAxis=new i1.P(0,0,0)),s.connectedAxis||(s.connectedAxis=new i1.P(0,0,0));let e=this._tmpAmmoVectorA;e.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let n=this._tmpAmmoVectorB;n.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z);let a=this._tmpAmmoVectorC;a.setValue(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z);let o=this._tmpAmmoVectorD;o.setValue(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z),t=new this.bjsAMMO.btHingeConstraint(i,r,e,n,a,o);break}case nj.BallAndSocketJoint:{let e=this._tmpAmmoVectorA;e.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let n=this._tmpAmmoVectorB;n.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),t=new this.bjsAMMO.btPoint2PointConstraint(i,r,e,n);break}default:{re.Y.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint");let e=this._tmpAmmoVectorA;e.setValue(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z);let n=this._tmpAmmoVectorB;n.setValue(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),t=new this.bjsAMMO.btPoint2PointConstraint(i,r,e,n)}}this.world.addConstraint(t,!e.joint.jointData.collision),e.joint.physicsJoint=t}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint),this.bjsAMMO.destroy(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s,n=i.getIndices();n||(n=[]);let a=i.getVerticesData(st.o.PositionKind);if(a||(a=[]),t&&t!==i){let e;e=t.rotationQuaternion?t.rotationQuaternion:t.rotation?i1._f.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):i1._f.Identity(),i1.y3.Compose(i1.P.One(),e,t.position).invertToRef(this._tmpMatrix),s=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else i1.y3.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),s=this._tmpMatrix;let o=n.length/3;for(let t=0;t<o;t++){let i=[];for(let e=0;e<3;e++){let r,o=new i1.P(a[3*n[3*t+e]+0],a[3*n[3*t+e]+1],a[3*n[3*t+e]+2]);o=i1.P.TransformCoordinates(o,s),(r=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC).setValue(o.x,o.y,o.z),i.push(r)}e.addTriangle(i[0],i[1],i[2]),r++}i.getChildMeshes().forEach(i=>{r+=this._addMeshVerts(e,t,i)})}return r}_softVertexData(e){let t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){let e=t.getIndices();e||(e=[]);let i=t.getVerticesData(st.o.PositionKind);i||(i=[]);let r=t.getVerticesData(st.o.NormalKind);r||(r=[]),t.computeWorldMatrix(!1);let s=[],n=[];for(let e=0;e<i.length;e+=3){let a=new i1.P(i[e],i[e+1],i[e+2]),o=new i1.P(r[e],r[e+1],r[e+2]);a=i1.P.TransformCoordinates(a,t.getWorldMatrix()),o=i1.P.TransformNormal(o,t.getWorldMatrix()),s.push(a.x,a.y,a.z),n.push(o.x,o.y,o.z)}let a=new nK.x;return a.positions=s,a.normals=n,a.uvs=t.getVerticesData(st.o.UVKind),a.colors=t.getVerticesData(st.o.ColorKind),t&&t.getIndices&&(a.indices=t.getIndices()),a.applyToMesh(t),t.position=i1.P.Zero(),t.rotationQuaternion=null,t.rotation=i1.P.Zero(),t.computeWorldMatrix(!0),a}return nK.x.ExtractFromMesh(t)}_createSoftbody(e){let t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);let r=this._softVertexData(e),s=r.positions,n=r.normals;if(null===s||null===n)return new this.bjsAMMO.btCompoundShape;{let e;let r=[],a=[];for(let e=0;e<s.length;e+=3){let t=new i1.P(s[e],s[e+1],s[e+2]),i=new i1.P(n[e],n[e+1],n[e+2]);r.push(t.x,t.y,-t.z),a.push(i.x,i.y,-i.z)}let o=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),r,t.getIndices(),i.length/3,!0),l=s.length/3,c=o.get_m_nodes();for(let t=0;t<l;t++)(e=c.at(t).get_m_n()).setX(a[3*t]),e.setY(a[3*t+1]),e.setZ(a[3*t+2]);return o}}}_createCloth(e){let t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);let r=this._softVertexData(e),s=r.positions,n=r.normals;if(null===s||null===n)return new this.bjsAMMO.btCompoundShape;{let t=s.length,i=Math.sqrt(t/3);e.segments=i;let r=i-1;return this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[3*r],s[3*r+1],s[3*r+2]),this._tmpAmmoVectorD.setValue(s[t-3],s[t-2],s[t-1]),this._tmpAmmoVectorC.setValue(s[t-3-3*r],s[t-2-3*r],s[t-1-3*r]),new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,i,i,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;let r=this._softVertexData(e),s=r.positions,n=r.normals;if(null===s||null===n)return new this.bjsAMMO.btCompoundShape;if(r.applyToMesh(e.object,!0),e._isFromLine=!0,0===n.map(e=>e*e).reduce((e,t)=>e+t))i=(t=s.length)/3-1,this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[t-3],s[t-2],s[t-1]);else{e._isFromLine=!1;let r=e.getParam("path");if(null===e.getParam("shape"))return re.Y.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;i=(t=r.length)-1,this._tmpAmmoVectorA.setValue(r[0].x,r[0].y,r[0].z),this._tmpAmmoVectorB.setValue(r[t-1].x,r[t-1].y,r[t-1].z)}e.segments=i;let a=e.getParam("fixedPoints");a=a>3?3:a;let o=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,a);return o.get_m_cfg().set_collisions(17),o}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),null==t&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let r=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let s=i.getIndices();s||(s=[]);let n=i.getVerticesData(st.o.PositionKind);n||(n=[]),i.computeWorldMatrix(!1);let a=s.length/3;for(let t=0;t<a;t++){let a=[];for(let e=0;e<3;e++){let r,o=new i1.P(n[3*s[3*t+e]+0],n[3*s[3*t+e]+1],n[3*s[3*t+e]+2]);i1.y3.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),o=i1.P.TransformCoordinates(o,this._tmpMatrix),(r=0==e?this._tmpAmmoVectorA:1==e?this._tmpAmmoVectorB:this._tmpAmmoVectorC).setValue(o.x,o.y,o.z),a.push(r)}e.addPoint(a[0],!0),e.addPoint(a[1],!0),e.addPoint(a[2],!0),r++}i.getChildMeshes().forEach(i=>{r+=this._addHullVerts(e,t,i)})}return r}_createShape(e,t=!1){let i;let r=e.object,s=e.getObjectExtents();if(!t){let t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];i=new this.bjsAMMO.btCompoundShape;let r=0;if(t.forEach(e=>{let t=e.getPhysicsImpostor();if(t){if(t.type==nq.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";let s=this._createShape(t),n=e.parent.getWorldMatrix().clone(),a=new i1.P;n.decompose(a),this._tmpAmmoTransform.getOrigin().setValue(e.position.x*a.x,e.position.y*a.y,e.position.z*a.z),this._tmpAmmoQuaternion.setValue(e.rotationQuaternion.x,e.rotationQuaternion.y,e.rotationQuaternion.z,e.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),i.addChildShape(this._tmpAmmoTransform,s),t.dispose(),r++}}),r>0){if(e.type!=nq.NoImpostor){let t=this._createShape(e,!0);t&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),i.addChildShape(this._tmpAmmoTransform,t))}return i}this.bjsAMMO.destroy(i),i=null}switch(e.type){case nq.SphereImpostor:if((0,aP.WithinEpsilon)(s.x,s.y,1e-4)&&(0,aP.WithinEpsilon)(s.x,s.z,1e-4))i=new this.bjsAMMO.btSphereShape(s.x/2);else{this._tmpAmmoVectorA.setValue(0,0,0);let e=[this._tmpAmmoVectorA];i=new this.bjsAMMO.btMultiSphereShape(e,[1],1),this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),i.setLocalScaling(this._tmpAmmoVectorA)}break;case nq.CapsuleImpostor:{let e=s.x/2;i=new this.bjsAMMO.btCapsuleShape(e,s.y-2*e)}break;case nq.CylinderImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),i=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case nq.PlaneImpostor:case nq.BoxImpostor:this._tmpAmmoVectorA.setValue(s.x/2,s.y/2,s.z/2),i=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case nq.MeshImpostor:if(0==e.getParam("mass")){if(this.onCreateCustomMeshImpostor)i=this.onCreateCustomMeshImpostor(e);else{let t=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(t),i=0==this._addMeshVerts(t,r,r)?new this.bjsAMMO.btCompoundShape:new this.bjsAMMO.btBvhTriangleMeshShape(t)}break}case nq.ConvexHullImpostor:if(this.onCreateCustomConvexHullImpostor)i=this.onCreateCustomConvexHullImpostor(e);else{let t=new this.bjsAMMO.btConvexHullShape;0==this._addHullVerts(t,r,r)?(e._pluginData.toDispose.push(t),i=new this.bjsAMMO.btCompoundShape):i=t}break;case nq.NoImpostor:i=new this.bjsAMMO.btSphereShape(s.x/2);break;case nq.CustomImpostor:i=this._createCustom(e);break;case nq.SoftbodyImpostor:i=this._createSoftbody(e);break;case nq.ClothImpostor:i=this._createCloth(e);break;case nq.RopeImpostor:i=this._createRope(e);break;default:re.Y.Warn("The impostor type is not currently supported by the ammo plugin.")}return i}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){let r=e.physicsBody.getWorldTransform();if(Math.abs(r.getOrigin().x()-t.x)>r2.kn||Math.abs(r.getOrigin().y()-t.y)>r2.kn||Math.abs(r.getOrigin().z()-t.z)>r2.kn||Math.abs(r.getRotation().x()-i.x)>r2.kn||Math.abs(r.getRotation().y()-i.y)>r2.kn||Math.abs(r.getRotation().z()-i.z)>r2.kn||Math.abs(r.getRotation().w()-i.w)>r2.kn){if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),r.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),r.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(r),0==e.mass){let t=e.physicsBody.getMotionState();t&&t.setWorldTransform(r)}else e.physicsBody.activate()}}isSupported(){return void 0!==this.bjsAMMO}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(!(t=e.soft?e.physicsBody.linearVelocity():e.physicsBody.getLinearVelocity()))return null;let i=new i1.P(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(!(t=e.soft?e.physicsBody.angularVelocity():e.physicsBody.getAngularVelocity()))return null;let i=new i1.P(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(re.Y.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===nq.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):re.Y.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(re.Y.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=(t=t<0?0:t)>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):re.Y.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(re.Y.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):re.Y.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(re.Y.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):re.Y.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,r,s=1,n=!1){let a=e.segments;e.physicsBody.appendAnchor(Math.round((a-1)*i)+a*(a-1-Math.round((a-1)*r)),t.physicsBody,n,s)}appendHook(e,t,i,r=1,s=!1){let n=Math.round(e.segments*i);e.physicsBody.appendAnchor(n,t.physicsBody,s,r)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){re.Y.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){re.Y.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){let i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._softBodySolver),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoVectorD),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){return this.raycastToRef(e,t,this._raycastResult),this._raycastResult}raycastToRef(e,t,i){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);let r=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,r),i.reset(e,t),r.hasHit()&&(i.setHitData({x:r.get_m_hitNormalWorld().x(),y:r.get_m_hitNormalWorld().y(),z:r.get_m_hitNormalWorld().z()},{x:r.get_m_hitPointWorld().x(),y:r.get_m_hitPointWorld().y(),z:r.get_m_hitPointWorld().z()}),i.calculateHitDistance()),this.bjsAMMO.destroy(r),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB)}}cY._DISABLE_COLLISION_FLAG=4,cY._KINEMATIC_FLAG=2,cY._DISABLE_DEACTIVATION_FLAG=4,rH.x.prototype.removeReflectionProbe=function(e){if(!this.reflectionProbes)return -1;let t=this.reflectionProbes.indexOf(e);return -1!==t&&this.reflectionProbes.splice(t,1),t},rH.x.prototype.addReflectionProbe=function(e){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(e)};class cX{constructor(e,t,i,r=!0,s=!1,n=!1){let a;if(this.name=e,this._viewMatrix=i1.y3.Identity(),this._target=i1.P.Zero(),this._add=i1.P.Zero(),this._invertYAxis=!1,this.position=i1.P.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let t=0;t<6;++t)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${t}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let o=0;if(s){let e=this._scene.getEngine().getCaps();e.textureHalfFloatRender?o=2:e.textureFloatRender&&(o=1)}this._renderTargetTexture=new s2._(e,t,i,r,!0,o,!0),this._renderTargetTexture.gammaSpace=!n,this._renderTargetTexture.invertZ=i.useRightHandedSystem;let l=i.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(e=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[e]),i.getSceneUniformBuffer().unbindEffect()),e){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1)}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);let t=i.useRightHandedSystem?i1.y3.LookAtRHToRef:i1.y3.LookAtLHToRef,r=i.useRightHandedSystem?i1.y3.PerspectiveFovRH:i1.y3.PerspectiveFovLH;t(this.position,this._target,i1.P.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=r(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position}),this._renderTargetTexture.onBeforeBindObservable.add(()=>{this._currentSceneUBO=i.getSceneUniformBuffer(),i.getEngine()._debugPushGroup?.(`reflection probe generation for ${e}`,1),a=this._scene.imageProcessingConfiguration.applyByPostProcess,n&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{i.imageProcessingConfiguration.applyByPostProcess=a,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),i.getEngine()._debugPopGroup?.(1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){let e=this._scene.reflectionProbes.indexOf(this);if(-1!==e&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){let e=this._parentContainer.reflectionProbes.indexOf(this);e>-1&&this._parentContainer.reflectionProbes.splice(e,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(let e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){let e=rq.p.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let r=null;if(t.reflectionProbes)for(let i=0;i<t.reflectionProbes.length;i++){let s=t.reflectionProbes[i];if(s.name===e.name){r=s;break}}return(r=rq.p.Parse(()=>r||new cX(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i)).cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&r.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(r.metadata=e.metadata),r}}(0,r$.gn)([(0,rj.RR)()],cX.prototype,"_attachedMesh",void 0),(0,r$.gn)([(0,rj.hd)()],cX.prototype,"position",void 0);class c${get animationStarted(){return this._animationStarted}get fromIndex(){return this._fromIndex}get toIndex(){return this._toIndex}get loopAnimation(){return this._loopAnimation}get delay(){return Math.max(this._delay,1)}constructor(){this.width=1,this.height=1,this.angle=0,this.invertU=!1,this.invertV=!1,this.isVisible=!0,this._animationStarted=!1,this._loopAnimation=!1,this._fromIndex=0,this._toIndex=0,this._delay=0,this._direction=1,this._time=0,this._onBaseAnimationEnd=null,this.position={x:1,y:1,z:1},this.color={r:1,g:1,b:1,a:1}}playAnimation(e,t,i,r,s){this._fromIndex=e,this._toIndex=t,this._loopAnimation=i,this._delay=r||1,this._animationStarted=!0,this._onBaseAnimationEnd=s,e<t?this._direction=1:(this._direction=-1,this._toIndex=e,this._fromIndex=t),this.cellIndex=e,this._time=0}stopAnimation(){this._animationStarted=!1}_animate(e){this._animationStarted&&(this._time+=e,this._time>this._delay&&(this._time=this._time%this._delay,this.cellIndex+=this._direction,(this._direction>0&&this.cellIndex>this._toIndex||this._direction<0&&this.cellIndex<this._fromIndex)&&(this._loopAnimation?this.cellIndex=this._direction>0?this._fromIndex:this._toIndex:(this.cellIndex=this._toIndex,this._animationStarted=!1,this._onBaseAnimationEnd&&this._onBaseAnimationEnd()))))}}class cj extends c${get size(){return this.width}set size(e){this.width=e,this.height=e}get manager(){return this._manager}constructor(e,t){super(),this.name=e,this.animations=[],this.isPickable=!1,this.useAlphaForPicking=!1,this.onDisposeObservable=new i0.y$,this._onAnimationEnd=null,this._endAnimation=()=>{this._onAnimationEnd&&this._onAnimationEnd(),this.disposeWhenFinishedAnimating&&this.dispose()},this.color=new i2.HE(1,1,1,1),this.position=i1.P.Zero(),this._manager=t,this._manager.sprites.push(this),this.uniqueId=this._manager.scene.getUniqueId()}getClassName(){return"Sprite"}get fromIndex(){return this._fromIndex}set fromIndex(e){this.playAnimation(e,this._toIndex,this._loopAnimation,this._delay,this._onAnimationEnd)}get toIndex(){return this._toIndex}set toIndex(e){this.playAnimation(this._fromIndex,e,this._loopAnimation,this._delay,this._onAnimationEnd)}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){this.playAnimation(this._fromIndex,this._toIndex,e,this._delay,this._onAnimationEnd)}get delay(){return Math.max(this._delay,1)}set delay(e){this.playAnimation(this._fromIndex,this._toIndex,this._loopAnimation,e,this._onAnimationEnd)}playAnimation(e,t,i,r,s=null){this._onAnimationEnd=s,super.playAnimation(e,t,i,r,this._endAnimation)}dispose(){for(let e=0;e<this._manager.sprites.length;e++)this._manager.sprites[e]==this&&this._manager.sprites.splice(e,1);this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}serialize(){let e={};return e.name=this.name,e.position=this.position.asArray(),e.color=this.color.asArray(),e.width=this.width,e.height=this.height,e.angle=this.angle,e.cellIndex=this.cellIndex,e.cellRef=this.cellRef,e.invertU=this.invertU,e.invertV=this.invertV,e.disposeWhenFinishedAnimating=this.disposeWhenFinishedAnimating,e.isPickable=this.isPickable,e.isVisible=this.isVisible,e.useAlphaForPicking=this.useAlphaForPicking,e.animationStarted=this.animationStarted,e.fromIndex=this.fromIndex,e.toIndex=this.toIndex,e.loopAnimation=this.loopAnimation,e.delay=this.delay,e}static Parse(e,t){let i=new cj(e.name,t);return i.position=i1.P.FromArray(e.position),i.color=i2.HE.FromArray(e.color),i.width=e.width,i.height=e.height,i.angle=e.angle,i.cellIndex=e.cellIndex,i.cellRef=e.cellRef,i.invertU=e.invertU,i.invertV=e.invertV,i.disposeWhenFinishedAnimating=e.disposeWhenFinishedAnimating,i.isPickable=e.isPickable,i.isVisible=e.isVisible,i.useAlphaForPicking=e.useAlphaForPicking,i._fromIndex=e.fromIndex,i._toIndex=e.toIndex,i._loopAnimation=e.loopAnimation,i._delay=e.delay,e.animationStarted&&i.playAnimation(i.fromIndex,i.toIndex,i.loopAnimation,i.delay),i}}var cq=i(23050);rH.x.prototype._internalPickSprites=function(e,t,i,r){if(!nR.p)return null;let s=null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let n=0;n<this.spriteManagers.length;n++){let a=this.spriteManagers[n];if(!a.isPickable)continue;let o=a.intersects(e,r,t,i);if(o&&o.hit&&(i||null==s||!(o.distance>=s.distance))&&(s=o,i))break}return s||new nR.p},rH.x.prototype._internalMultiPickSprites=function(e,t,i){if(!nR.p)return null;let r=[];if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers&&this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){let n=this.spriteManagers[s];if(!n.isPickable)continue;let a=n.multiIntersects(e,i,t);null!==a&&(r=r.concat(a))}return r},rH.x.prototype.pickSprite=function(e,t,i,r,s){if(!this._tempSpritePickingRay)return null;(0,cq.kA)(this,e,t,this._tempSpritePickingRay,s);let n=this._internalPickSprites(this._tempSpritePickingRay,i,r,s);return n&&(n.ray=(0,cq.K7)(this,e,t,s)),n},rH.x.prototype.pickSpriteWithRay=function(e,t,i,r){if(!this._tempSpritePickingRay)return null;if(!r){if(!this.activeCamera)return null;r=this.activeCamera}cq.zH.TransformToRef(e,r.getViewMatrix(),this._tempSpritePickingRay);let s=this._internalPickSprites(this._tempSpritePickingRay,t,i,r);return s&&(s.ray=e),s},rH.x.prototype.multiPickSprite=function(e,t,i,r){return(0,cq.kA)(this,e,t,this._tempSpritePickingRay,r),this._internalMultiPickSprites(this._tempSpritePickingRay,i,r)},rH.x.prototype.multiPickSpriteWithRay=function(e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}return cq.zH.TransformToRef(e,i.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)},rH.x.prototype.setPointerOverSprite=function(e){this._pointerOverSprite!==e&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,i5.V.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=e,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,i5.V.CreateNewFromSprite(this._pointerOverSprite,this)))},rH.x.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};class cQ{constructor(e){this.name=rz.l.NAME_SPRITE,this.scene=e,this.scene.spriteManagers=[],this.scene._tempSpritePickingRay=cq.zH?cq.zH.Zero():null,this.scene.onBeforeSpritesRenderingObservable=new i0.y$,this.scene.onAfterSpritesRenderingObservable=new i0.y$,this._spritePredicate=e=>!!e.actionManager&&e.isPickable&&e.actionManager.hasPointerTriggers}register(){this.scene._pointerMoveStage.registerStep(rz.l.STEP_POINTERMOVE_SPRITE,this,this._pointerMove),this.scene._pointerDownStage.registerStep(rz.l.STEP_POINTERDOWN_SPRITE,this,this._pointerDown),this.scene._pointerUpStage.registerStep(rz.l.STEP_POINTERUP_SPRITE,this,this._pointerUp)}rebuild(){}dispose(){this.scene.onBeforeSpritesRenderingObservable.clear(),this.scene.onAfterSpritesRenderingObservable.clear();let e=this.scene.spriteManagers;if(e)for(;e.length;)e[0].dispose()}_pickSpriteButKeepRay(e,t,i,r,s){let n=this.scene.pickSprite(t,i,this._spritePredicate,r,s);return n&&(n.ray=e?e.ray:null),n}_pointerMove(e,t,i,r,s){let n=this.scene;return r?n.setPointerOverSprite(null):(i=this._pickSpriteButKeepRay(i,e,t,!1,n.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite?(n.setPointerOverSprite(i.pickedSprite),!n.doNotHandleCursors&&s&&(n._pointerOverSprite&&n._pointerOverSprite.actionManager&&n._pointerOverSprite.actionManager.hoverCursor?s.style.cursor=n._pointerOverSprite.actionManager.hoverCursor:s.style.cursor=n.hoverCursor)):n.setPointerOverSprite(null),i}_pointerDown(e,t,i,r){let s=this.scene;if(s._pickedDownSprite=null,s.spriteManagers&&s.spriteManagers.length>0&&(i=s.pickSprite(e,t,this._spritePredicate,!1,s.cameraToUseForPointers||void 0))&&i.hit&&i.pickedSprite&&i.pickedSprite.actionManager){switch(s._pickedDownSprite=i.pickedSprite,r.button){case 0:i.pickedSprite.actionManager.processTrigger(2,i5.V.CreateNewFromSprite(i.pickedSprite,s,r));break;case 1:i.pickedSprite.actionManager.processTrigger(4,i5.V.CreateNewFromSprite(i.pickedSprite,s,r));break;case 2:i.pickedSprite.actionManager.processTrigger(3,i5.V.CreateNewFromSprite(i.pickedSprite,s,r))}i.pickedSprite.actionManager&&i.pickedSprite.actionManager.processTrigger(5,i5.V.CreateNewFromSprite(i.pickedSprite,s,r))}return i}_pointerUp(e,t,i,r,s){let n=this.scene;if(n.spriteManagers&&n.spriteManagers.length>0){let i=n.pickSprite(e,t,this._spritePredicate,!1,n.cameraToUseForPointers||void 0);i&&(i.hit&&i.pickedSprite&&i.pickedSprite.actionManager&&(i.pickedSprite.actionManager.processTrigger(7,i5.V.CreateNewFromSprite(i.pickedSprite,n,r)),i.pickedSprite.actionManager&&(this.scene._inputManager._isPointerSwiping()||i.pickedSprite.actionManager.processTrigger(1,i5.V.CreateNewFromSprite(i.pickedSprite,n,r)),s&&i.pickedSprite.actionManager.processTrigger(6,i5.V.CreateNewFromSprite(i.pickedSprite,n,r)))),n._pickedDownSprite&&n._pickedDownSprite.actionManager&&n._pickedDownSprite!==i.pickedSprite&&n._pickedDownSprite.actionManager.processTrigger(16,i5.V.CreateNewFromSprite(n._pickedDownSprite,n,r)))}return i}}class cK{get fogEnabled(){return this._fogEnabled}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this._createEffects())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){let t=!!this._scene?.getEngine().getCaps().fragmentDepthSupported;e&&!t&&re.Y.Warn("Logarithmic depth has been requested for a sprite renderer on a device that doesn't support it."),this._useLogarithmicDepth=e&&t,this._createEffects()}get capacity(){return this._capacity}get pixelPerfect(){return this._pixelPerfect}set pixelPerfect(e){this._pixelPerfect!==e&&(this._pixelPerfect=e,this._createEffects())}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i=.01,r=null){let s;this.blendMode=2,this.autoResetAlpha=!0,this.disableDepthWrite=!1,this._fogEnabled=!0,this._pixelPerfect=!1,this._shaderLanguage=0,this._useVAO=!1,this._useInstancing=!1,this._vertexBuffers={},this._isDisposed=!1,this._shadersLoaded=!1,this._capacity=t,this._epsilon=i,this._engine=e,this._useInstancing=e.getCaps().instancedArrays&&e._features.supportSpriteInstancing,this._useVAO=e.getCaps().vertexArrayObject&&!e.disableVertexArrayObjects,this._scene=r,this._useInstancing||this._buildIndexBuffer(),this._vertexBufferSize=this._useInstancing?16:18,this._vertexData=new Float32Array(t*this._vertexBufferSize*(this._useInstancing?1:4)),this._buffer=new st.l(e,this._vertexData,!0,this._vertexBufferSize);let n=this._buffer.createVertexBuffer(st.o.PositionKind,0,4,this._vertexBufferSize,this._useInstancing),a=this._buffer.createVertexBuffer("options",4,2,this._vertexBufferSize,this._useInstancing),o=6;if(this._useInstancing){let t=new Float32Array([this._epsilon,this._epsilon,1-this._epsilon,this._epsilon,this._epsilon,1-this._epsilon,1-this._epsilon,1-this._epsilon]);this._spriteBuffer=new st.l(e,t,!1,2),s=this._spriteBuffer.createVertexBuffer("offsets",0,2)}else s=this._buffer.createVertexBuffer("offsets",o,2,this._vertexBufferSize,this._useInstancing),o+=2;let l=this._buffer.createVertexBuffer("inverts",o,2,this._vertexBufferSize,this._useInstancing),c=this._buffer.createVertexBuffer("cellInfo",o+2,4,this._vertexBufferSize,this._useInstancing),u=this._buffer.createVertexBuffer(st.o.ColorKind,o+6,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[st.o.PositionKind]=n,this._vertexBuffers.options=a,this._vertexBuffers.offsets=s,this._vertexBuffers.inverts=l,this._vertexBuffers.cellInfo=c,this._vertexBuffers[st.o.ColorKind]=u,this._initShaderSourceAsync()}async _initShaderSourceAsync(){this._engine.isWebGPU&&!cK.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,39684)),Promise.resolve().then(i.bind(i,34560))])):await Promise.all([Promise.resolve().then(i.bind(i,12199)),Promise.resolve().then(i.bind(i,5566))]),this._shadersLoaded=!0,this._createEffects()}_createEffects(){if(this._isDisposed)return;this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._drawWrapperBase=new cu.q(this._engine),this._drawWrapperDepth=new cu.q(this._engine,!1),this._drawWrapperBase.drawContext&&(this._drawWrapperBase.drawContext.useInstancing=this._useInstancing),this._drawWrapperDepth.drawContext&&(this._drawWrapperDepth.drawContext.useInstancing=this._useInstancing);let e="";this._pixelPerfect&&(e+="#define PIXEL_PERFECT\n"),this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode&&this._fogEnabled&&(e+="#define FOG\n"),this._useLogarithmicDepth&&(e+="#define LOGARITHMICDEPTH\n"),this._drawWrapperBase.effect=this._engine.createEffect("sprites",[st.o.PositionKind,"options","offsets","inverts","cellInfo",st.o.ColorKind],["view","projection","textureInfos","alphaTest","vFogInfos","vFogColor","logarithmicDepthConstant"],["diffuseSampler"],e,void 0,void 0,void 0,void 0,this._shaderLanguage),this._drawWrapperDepth.effect=this._drawWrapperBase.effect,this._drawWrapperDepth.materialContext=this._drawWrapperBase.materialContext}render(e,t,i,r,s=null){if(!this._shadersLoaded||!this.texture||!this.texture.isReady()||!e.length)return;let n=this._drawWrapperBase,a=this._drawWrapperDepth,o=this.fogEnabled&&this._scene&&this._scene.fogEnabled&&0!==this._scene.fogMode,l=n.effect;if(!l.isReady())return;let c=this._engine,u=!!(this._scene&&this._scene.useRightHandedSystem),h=Math.min(this._capacity,e.length),d=0,f=!0;for(let i=0;i<h;i++){let r=e[i];if(!r||!r.isVisible)continue;f=!1,r._animate(t);let n=this.texture.getBaseSize();this._appendSpriteVertex(d++,r,0,0,n,u,s),this._useInstancing||(this._appendSpriteVertex(d++,r,1,0,n,u,s),this._appendSpriteVertex(d++,r,1,1,n,u,s),this._appendSpriteVertex(d++,r,0,1,n,u,s))}if(f)return;this._buffer.update(this._vertexData);let p=!!c.depthCullingState.cull,m=c.depthCullingState.zOffset,_=c.depthCullingState.zOffsetUnits;if(c.setState(p,m,!1,!1,void 0,void 0,_),c.enableEffect(n),l.setTexture("diffuseSampler",this.texture),l.setMatrix("view",i),l.setMatrix("projection",r),o){let e=this._scene;l.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),l.setColor3("vFogColor",e.fogColor)}this.useLogarithmicDepth&&this._scene&&(0,le.gz)(n.defines,l,this._scene),this._useVAO?(this._vertexArrayObject||(this._vertexArrayObject=c.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,l)),c.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):c.bindBuffers(this._vertexBuffers,this._indexBuffer,l),c.depthCullingState.depthFunc=c.useReverseDepthBuffer?518:515,this.disableDepthWrite||(l.setBool("alphaTest",!0),c.setColorWrite(!1),c.enableEffect(a),this._useInstancing?c.drawArraysType(7,0,4,d):c.drawElementsType(0,0,d/4*6),c.enableEffect(n),c.setColorWrite(!0),l.setBool("alphaTest",!1)),c.setAlphaMode(this.blendMode),this._useInstancing?c.drawArraysType(7,0,4,d):c.drawElementsType(0,0,d/4*6),this.autoResetAlpha&&c.setAlphaMode(0),u&&this._scene.getEngine().setState(p,m,!1,!0,void 0,void 0,_),c.unbindInstanceAttributes()}_appendSpriteVertex(e,t,i,r,s,n,a){let o=e*this._vertexBufferSize;if(0===i?i=this._epsilon:1===i&&(i=1-this._epsilon),0===r?r=this._epsilon:1===r&&(r=1-this._epsilon),a)a(t,s);else{t.cellIndex||(t.cellIndex=0);let e=s.width/this.cellWidth,i=t.cellIndex/e>>0;t._xOffset=(t.cellIndex-i*e)*this.cellWidth/s.width,t._yOffset=i*this.cellHeight/s.height,t._xSize=this.cellWidth,t._ySize=this.cellHeight}this._vertexData[o]=t.position.x,this._vertexData[o+1]=t.position.y,this._vertexData[o+2]=t.position.z,this._vertexData[o+3]=t.angle,this._vertexData[o+4]=t.width,this._vertexData[o+5]=t.height,this._useInstancing?o-=2:(this._vertexData[o+6]=i,this._vertexData[o+7]=r),n?this._vertexData[o+8]=t.invertU?0:1:this._vertexData[o+8]=t.invertU?1:0,this._vertexData[o+9]=t.invertV?1:0,this._vertexData[o+10]=t._xOffset,this._vertexData[o+11]=t._yOffset,this._vertexData[o+12]=t._xSize/s.width,this._vertexData[o+13]=t._ySize/s.height,this._vertexData[o+14]=t.color.r,this._vertexData[o+15]=t.color.g,this._vertexData[o+16]=t.color.b,this._vertexData[o+17]=t.color.a}_buildIndexBuffer(){let e=[],t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}rebuild(){for(let e in this._indexBuffer&&this._buildIndexBuffer(),this._useVAO&&(this._vertexArrayObject=void 0),this._buffer._rebuild(),this._vertexBuffers)this._vertexBuffers[e]._rebuild();this._spriteBuffer?._rebuild()}dispose(){this._buffer&&(this._buffer.dispose(),this._buffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this.texture&&(this.texture.dispose(),this.texture=null),this._drawWrapperBase?.dispose(),this._drawWrapperDepth?.dispose(),this._isDisposed=!0}}cK.ForceGLSL=!1;class cZ{set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get children(){return this.sprites}get scene(){return this._scene}get capacity(){return this._spriteRenderer.capacity}get texture(){return this._spriteRenderer.texture}set texture(e){e.wrapU=rZ.x.CLAMP_ADDRESSMODE,e.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._spriteRenderer.texture=e,this._textureContent=null}get cellWidth(){return this._spriteRenderer.cellWidth}set cellWidth(e){this._spriteRenderer.cellWidth=e}get cellHeight(){return this._spriteRenderer.cellHeight}set cellHeight(e){this._spriteRenderer.cellHeight=e}get fogEnabled(){return this._spriteRenderer.fogEnabled}set fogEnabled(e){this._spriteRenderer.fogEnabled=e}get useLogarithmicDepth(){return this._spriteRenderer.useLogarithmicDepth}set useLogarithmicDepth(e){this._spriteRenderer.useLogarithmicDepth=e}get blendMode(){return this._spriteRenderer.blendMode}set blendMode(e){this._spriteRenderer.blendMode=e}get disableDepthWrite(){return this._disableDepthWrite}set disableDepthWrite(e){this._disableDepthWrite=e,this._spriteRenderer.disableDepthWrite=e}get pixelPerfect(){return this._spriteRenderer.pixelPerfect}set pixelPerfect(e){this._spriteRenderer.pixelPerfect=e,e&&3!==this.texture.samplingMode&&this.texture.updateSamplingMode(3)}constructor(e,t,i,r,s,n=.01,a=rZ.x.TRILINEAR_SAMPLINGMODE,o=!1,l=null){this.name=e,this.sprites=[],this.renderingGroupId=0,this.layerMask=268435455,this.isPickable=!1,this.metadata=null,this._wasDispatched=!1,this.onDisposeObservable=new i0.y$,this._disableDepthWrite=!1,this._packedAndReady=!1,this._customUpdate=(e,t)=>{e.cellRef||(e.cellIndex=0);let i=e.cellIndex;"number"==typeof i&&isFinite(i)&&Math.floor(i)===i&&(e.cellRef=this._spriteMap[e.cellIndex]),e._xOffset=this._cellData[e.cellRef].frame.x/t.width,e._yOffset=this._cellData[e.cellRef].frame.y/t.height,e._xSize=this._cellData[e.cellRef].frame.w,e._ySize=this._cellData[e.cellRef].frame.h},s||(s=rh.l.LastCreatedScene),s._getComponent(rz.l.NAME_SPRITE)||s._addComponent(new cQ(s)),this._fromPacked=o,this._scene=s;let c=this._scene.getEngine();if(this._spriteRenderer=new cK(c,i,n,s),r.width&&r.height)this.cellWidth=r.width,this.cellHeight=r.height;else if(void 0!==r)this.cellWidth=r,this.cellHeight=r;else{this._spriteRenderer=null;return}this._scene.spriteManagers&&this._scene.spriteManagers.push(this),this.uniqueId=this.scene.getUniqueId(),t&&(this.texture=new rZ.x(t,s,!0,!1,a)),this._fromPacked&&this._makePacked(t,l)}getClassName(){return"SpriteManager"}_makePacked(e,t){if(null!==t)try{let e;if((e="string"==typeof t?JSON.parse(t):t).frames.length){let t={};for(let i=0;i<e.frames.length;i++){let r=e.frames[i];if("string"!=typeof Object.keys(r)[0])throw Error("Invalid JSON Format.  Check the frame values and make sure the name is the first parameter.");t[r[Object.keys(r)[0]]]=r}e.frames=t}let i=Reflect.ownKeys(e.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=e.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,Error("Invalid JSON from string. Spritesheet managed with constant cell size.")}else{let t;let i=/\./g;do t=i.lastIndex,i.test(e);while(i.lastIndex>0);let r=e.substring(0,t-1)+".json";rD.w1.LoadFile(r,e=>{try{let t=JSON.parse(e),i=Reflect.ownKeys(t.frames);this._spriteMap=i,this._packedAndReady=!0,this._cellData=t.frames}catch(e){throw this._fromPacked=!1,this._packedAndReady=!1,Error("Invalid JSON format. Please check documentation for format specifications.")}},void 0,void 0,!1,()=>{re.Y.Error("JSON ERROR: Unable to load JSON file."),this._fromPacked=!1,this._packedAndReady=!1})}}_checkTextureAlpha(e,t,i,r,s){if(!e.useAlphaForPicking||!this.texture)return!0;let n=this.texture.getSize();this._textureContent||(this._textureContent=new Uint8Array(n.width*n.height*4),this.texture.readPixels(0,0,this._textureContent));let a=i1.jp.Vector3[0];a.copyFrom(t.direction),a.normalize(),a.scaleInPlace(i),a.addInPlace(t.origin);let o=(a.x-r.x)/(s.x-r.x),l=1-(a.y-r.y)/(s.y-r.y),c=e._xOffset*n.width+o*e._xSize|0,u=e._yOffset*n.height+l*e._ySize|0;return this._textureContent[(c+u*n.width)*4+3]>.5}intersects(e,t,i,r){let s=Math.min(this.capacity,this.sprites.length),n=i1.P.Zero(),a=i1.P.Zero(),o=Number.MAX_VALUE,l=null,c=i1.jp.Vector3[0],u=i1.jp.Vector3[1],h=t.getViewMatrix(),d=e,f=e;for(let t=0;t<s;t++){let s=this.sprites[t];if(s){if(i){if(!i(s))continue}else if(!s.isPickable)continue;if(i1.P.TransformCoordinatesToRef(s.position,h,u),s.angle?(i1.y3.TranslationToRef(-u.x,-u.y,0,i1.jp.Matrix[1]),i1.y3.TranslationToRef(u.x,u.y,0,i1.jp.Matrix[2]),i1.y3.RotationZToRef(-s.angle,i1.jp.Matrix[3]),i1.jp.Matrix[1].multiplyToRef(i1.jp.Matrix[3],i1.jp.Matrix[4]),i1.jp.Matrix[4].multiplyToRef(i1.jp.Matrix[2],i1.jp.Matrix[0]),d=e.clone(),i1.P.TransformCoordinatesToRef(e.origin,i1.jp.Matrix[0],d.origin),i1.P.TransformNormalToRef(e.direction,i1.jp.Matrix[0],d.direction)):d=e,n.copyFromFloats(u.x-s.width/2,u.y-s.height/2,u.z),a.copyFromFloats(u.x+s.width/2,u.y+s.height/2,u.z),d.intersectsBoxMinMax(n,a)){let e=i1.P.Distance(u,d.origin);if(o>e){if(!this._checkTextureAlpha(s,d,e,n,a))continue;if(f=d,o=e,l=s,r)break}}}}if(l){let e=new nR.p;h.invertToRef(i1.jp.Matrix[0]),e.hit=!0,e.pickedSprite=l,e.distance=o;let t=i1.jp.Vector3[2];return t.copyFrom(f.direction),t.normalize(),t.scaleInPlace(o),f.origin.addToRef(t,c),e.pickedPoint=i1.P.TransformCoordinates(c,i1.jp.Matrix[0]),e}return null}multiIntersects(e,t,i){let r;let s=Math.min(this.capacity,this.sprites.length),n=i1.P.Zero(),a=i1.P.Zero(),o=[],l=i1.jp.Vector3[0].copyFromFloats(0,0,0),c=i1.jp.Vector3[1].copyFromFloats(0,0,0),u=t.getViewMatrix();for(let t=0;t<s;t++){let s=this.sprites[t];if(s){if(i){if(!i(s))continue}else if(!s.isPickable)continue;if(i1.P.TransformCoordinatesToRef(s.position,u,c),n.copyFromFloats(c.x-s.width/2,c.y-s.height/2,c.z),a.copyFromFloats(c.x+s.width/2,c.y+s.height/2,c.z),e.intersectsBoxMinMax(n,a)){if(r=i1.P.Distance(c,e.origin),!this._checkTextureAlpha(s,e,r,n,a))continue;let t=new nR.p;o.push(t),u.invertToRef(i1.jp.Matrix[0]),t.hit=!0,t.pickedSprite=s,t.distance=r;let i=i1.jp.Vector3[2];i.copyFrom(e.direction),i.normalize(),i.scaleInPlace(r),e.origin.addToRef(i,l),t.pickedPoint=i1.P.TransformCoordinates(l,i1.jp.Matrix[0])}}}return o}render(){if(this._fromPacked&&(!this._packedAndReady||!this._spriteMap||!this._cellData))return;let e=this._scene.getEngine().getDeltaTime();this._packedAndReady?this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix(),this._customUpdate):this._spriteRenderer.render(this.sprites,e,this._scene.getViewMatrix(),this._scene.getProjectionMatrix())}rebuild(){this._spriteRenderer?.rebuild()}dispose(){if(this._spriteRenderer&&(this._spriteRenderer.dispose(),this._spriteRenderer=null),this._textureContent=null,this._scene.spriteManagers){let e=this._scene.spriteManagers.indexOf(this);this._scene.spriteManagers.splice(e,1)}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null}serialize(e=!1){let t={};for(let i of(t.name=this.name,t.capacity=this.capacity,t.cellWidth=this.cellWidth,t.cellHeight=this.cellHeight,t.fogEnabled=this.fogEnabled,t.blendMode=this.blendMode,t.disableDepthWrite=this.disableDepthWrite,t.pixelPerfect=this.pixelPerfect,t.useLogarithmicDepth=this.useLogarithmicDepth,this.texture&&(e?t.texture=this.texture.serialize():(t.textureUrl=this.texture.name,t.invertY=this.texture._invertY)),t.sprites=[],this.sprites))t.sprites.push(i.serialize());return t.metadata=this.metadata,t}static Parse(e,t,i){let r=new cZ(e.name,"",e.capacity,{width:e.cellWidth,height:e.cellHeight},t);for(let s of(void 0!==e.fogEnabled&&(r.fogEnabled=e.fogEnabled),void 0!==e.blendMode&&(r.blendMode=e.blendMode),void 0!==e.disableDepthWrite&&(r.disableDepthWrite=e.disableDepthWrite),void 0!==e.pixelPerfect&&(r.pixelPerfect=e.pixelPerfect),void 0!==e.useLogarithmicDepth&&(r.useLogarithmicDepth=e.useLogarithmicDepth),void 0!==e.metadata&&(r.metadata=e.metadata),e.texture?r.texture=rZ.x.Parse(e.texture,t,i):e.textureName&&(r.texture=new rZ.x(i+e.textureUrl,t,!1,void 0===e.invertY||e.invertY)),e.sprites))cj.Parse(s,r);return r}static ParseFromFileAsync(e,t,i,r=""){return new Promise((s,n)=>{let a=new lk.g;a.addEventListener("readystatechange",()=>{if(4==a.readyState){if(200==a.status){let t=JSON.parse(a.responseText),n=cZ.Parse(t,i||rh.l.LastCreatedScene,r);e&&(n.name=e),s(n)}else n("Unable to load the sprite manager")}}),a.open("GET",t),a.send()})}static ParseFromSnippetAsync(e,t,i=""){return"_BLANK"===e?Promise.resolve(new cZ("Default sprite manager","//playground.babylonjs.com/textures/player.png",500,64,t)):new Promise((r,s)=>{let n=new lk.g;n.addEventListener("readystatechange",()=>{if(4==n.readyState){if(200==n.status){let s=JSON.parse(JSON.parse(JSON.parse(n.responseText).jsonPayload).spriteManager),a=cZ.Parse(s,t||rh.l.LastCreatedScene,i);a.snippetId=e,r(a)}else s("Unable to load the snippet "+e)}}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}cZ.SnippetUrl="https://snippet.babylonjs.com",cZ.CreateFromSnippetAsync=cZ.ParseFromSnippetAsync;class cJ{}cJ.LoaderInjectedPhysicsEngine=void 0;let c0={},c1={},c2=(e,t,i,r)=>{if(!t.materials)return null;for(let s=0,n=t.materials.length;s<n;s++){let n=t.materials[s];if(e(n))return{parsedMaterial:n,material:n0.F.Parse(n,i,r)}}return null},c3=(e,t,i)=>{for(let r in t)if(e.name===t[r])return i.push(e.id),!0;return void 0!==e.parentId&&-1!==i.indexOf(e.parentId)&&(i.push(e.id),!0)},c4=(e,t)=>e+" of "+(t?t.file+" from "+t.name+" version: "+t.version+", exporter version: "+t.exporter_version:"unknown"),c5=(e,t)=>{if(t._waitingData.lods){if(t._waitingData.lods.ids&&t._waitingData.lods.ids.length>0){let i=t._waitingData.lods.ids,r=t.isEnabled(!1);if(t._waitingData.lods.distances){let s=t._waitingData.lods.distances;if(s.length>=i.length){let n=s.length>i.length?s[s.length-1]:0;t.setEnabled(!1);for(let r=0;r<i.length;r++){let n=i[r],a=e.getMeshById(n);null!=a&&t.addLODLevel(s[r],a)}n>0&&t.addLODLevel(n,null),!0===r&&t.setEnabled(!0)}else rD.w1.Warn("Invalid level of detail distances for "+t.name)}}t._waitingData.lods=null}},c7=(e,t,i)=>{if("number"!=typeof e){let r=i.getLastEntryById(e);return r&&null!=t?r.instances[parseInt(t)]:r}let r=c0[e];return r&&null!=t?r.instances[parseInt(t)]:r},c6=(e,t)=>"number"!=typeof e?t.getLastMaterialById(e,!0):c1[e],c8=(e,t,i,r,s=!1)=>{let n=new rB(e),a="importScene has failed JSON parse";try{let r,s;var o=JSON.parse(t);a="";let l=lh.n0.loggingLevel===lh.n0.DETAILED_LOGGING;if(void 0!==o.environmentTexture&&null!==o.environmentTexture){let t=void 0===o.isPBR||o.isPBR;if(o.environmentTextureType&&"BABYLON.HDRCubeTexture"===o.environmentTextureType){let r=o.environmentTextureSize?o.environmentTextureSize:128,s=new cw((o.environmentTexture.match(/https?:\/\//g)?"":i)+o.environmentTexture,e,r,!0,!t,void 0,o.environmentTexturePrefilterOnLoad);o.environmentTextureRotationY&&(s.rotationY=o.environmentTextureRotationY),e.environmentTexture=s}else if("object"==typeof o.environmentTexture){let t=o4.Parse(o.environmentTexture,e,i);e.environmentTexture=t}else if(o.environmentTexture.endsWith(".env")){let t=new o4((o.environmentTexture.match(/https?:\/\//g)?"":i)+o.environmentTexture,e,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(t.rotationY=o.environmentTextureRotationY),e.environmentTexture=t}else{let t=o4.CreateFromPrefilteredData((o.environmentTexture.match(/https?:\/\//g)?"":i)+o.environmentTexture,e,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(t.rotationY=o.environmentTextureRotationY),e.environmentTexture=t}if(!0===o.createDefaultSkybox){let i=void 0!==e.activeCamera&&null!==e.activeCamera?(e.activeCamera.maxZ-e.activeCamera.minZ)/2:1e3,r=o.skyboxBlurLevel||0;e.createDefaultSkybox(e.environmentTexture,t,i,r)}n.environmentTexture=e.environmentTexture}if(void 0!==o.environmentIntensity&&null!==o.environmentIntensity&&(e.environmentIntensity=o.environmentIntensity),void 0!==o.lights&&null!==o.lights)for(r=0,s=o.lights.length;r<s;r++){let t=o.lights[r],i=rN._.Parse(t,e);i&&(c0[t.uniqueId]=i,n.lights.push(i),i._parentContainer=n,a+=(0===r?"\n	Lights:":"")+"\n		"+i.toString(l))}if(void 0!==o.reflectionProbes&&null!==o.reflectionProbes)for(r=0,s=o.reflectionProbes.length;r<s;r++){let t=o.reflectionProbes[r],s=cX.Parse(t,e,i);s&&(n.reflectionProbes.push(s),s._parentContainer=n,a+=(0===r?"\n	Reflection Probes:":"")+"\n		"+s.toString(l))}if(void 0!==o.animations&&null!==o.animations)for(r=0,s=o.animations.length;r<s;r++){let t=o.animations[r],i=(0,i3.qw)("BABYLON.Animation");if(i){let s=i.Parse(t);e.animations.push(s),n.animations.push(s),a+=(0===r?"\n	Animations:":"")+"\n		"+s.toString(l)}}if(void 0!==o.materials&&null!==o.materials)for(r=0,s=o.materials.length;r<s;r++){let t=o.materials[r],s=n0.F.Parse(t,e,i);s&&(c1[t.uniqueId||t.id]=s,n.materials.push(s),s._parentContainer=n,a+=(0===r?"\n	Materials:":"")+"\n		"+s.toString(l),s.getActiveTextures().forEach(e=>{-1==n.textures.indexOf(e)&&(n.textures.push(e),e._parentContainer=n)}))}if(void 0!==o.multiMaterials&&null!==o.multiMaterials)for(r=0,s=o.multiMaterials.length;r<s;r++){let t=o.multiMaterials[r],i=cN.G.ParseMultiMaterial(t,e);c1[t.uniqueId||t.id]=i,n.multiMaterials.push(i),i._parentContainer=n,a+=(0===r?"\n	MultiMaterials:":"")+"\n		"+i.toString(l),i.getActiveTextures().forEach(e=>{-1==n.textures.indexOf(e)&&(n.textures.push(e),e._parentContainer=n)})}if(void 0!==o.morphTargetManagers&&null!==o.morphTargetManagers)for(let t of o.morphTargetManagers){let i=cU.Parse(t,e);n.morphTargetManagers.push(i),i._parentContainer=n}if(void 0!==o.skeletons&&null!==o.skeletons)for(r=0,s=o.skeletons.length;r<s;r++){let t=o.skeletons[r],i=r0.Parse(t,e);n.skeletons.push(i),i._parentContainer=n,a+=(0===r?"\n	Skeletons:":"")+"\n		"+i.toString(l)}let c=o.geometries;if(null!=c){let t=[],a=c.vertexData;if(null!=a)for(r=0,s=a.length;r<s;r++){let s=a[r];t.push(cM.Z.Parse(s,e,i))}t.forEach(e=>{e&&(n.geometries.push(e),e._parentContainer=n)})}if(void 0!==o.transformNodes&&null!==o.transformNodes)for(r=0,s=o.transformNodes.length;r<s;r++){let t=o.transformNodes[r],s=rR.Y.Parse(t,e,i);c0[t.uniqueId]=s,n.transformNodes.push(s),s._parentContainer=n}if(void 0!==o.meshes&&null!==o.meshes)for(r=0,s=o.meshes.length;r<s;r++){let t=o.meshes[r],s=rP.Kj.Parse(t,e,i);if(c0[t.uniqueId]=s,n.meshes.push(s),s._parentContainer=n,s.hasInstances)for(let e of s.instances)n.meshes.push(e),e._parentContainer=n;a+=(0===r?"\n	Meshes:":"")+"\n		"+s.toString(l)}if(void 0!==o.cameras&&null!==o.cameras)for(r=0,s=o.cameras.length;r<s;r++){let t=o.cameras[r],i=rO.V.Parse(t,e);c0[t.uniqueId]=i,n.cameras.push(i),i._parentContainer=n,a+=(0===r?"\n	Cameras:":"")+"\n		"+i.toString(l)}if(void 0!==o.postProcesses&&null!==o.postProcesses)for(r=0,s=o.postProcesses.length;r<s;r++){let t=o.postProcesses[r],s=sD.D.Parse(t,e,i);s&&(n.postProcesses.push(s),s._parentContainer=n,a+=(0===r?"\nPostprocesses:":"")+"\n		"+s.toString())}if(void 0!==o.animationGroups&&null!==o.animationGroups)for(r=0,s=o.animationGroups.length;r<s;r++){let t=o.animationGroups[r],i=ry.O.Parse(t,e);n.animationGroups.push(i),i._parentContainer=n,a+=(0===r?"\n	AnimationGroups:":"")+"\n		"+i.toString(l)}if(o.spriteManagers)for(let t=0,r=o.spriteManagers.length;t<r;t++){let r=o.spriteManagers[t],s=cZ.Parse(r,e,i);a+="\n		SpriteManager "+s.name}for(r=0,s=e.cameras.length;r<s;r++){let t=e.cameras[r];null!==t._waitingParentId&&(t.parent=c7(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(r=0,s=e.lights.length;r<s;r++){let t=e.lights[r];t&&null!==t._waitingParentId&&(t.parent=c7(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(r=0,s=e.transformNodes.length;r<s;r++){let t=e.transformNodes[r];null!==t._waitingParentId&&(t.parent=c7(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null)}for(r=0,s=e.meshes.length;r<s;r++){let t=e.meshes[r];null!==t._waitingParentId&&(t.parent=c7(t._waitingParentId,t._waitingParentInstanceIndex,e),t._waitingParentId=null,t._waitingParentInstanceIndex=null),t._waitingData.lods&&c5(e,t)}for(e.multiMaterials.forEach(t=>{t._waitingSubMaterialsUniqueIds.forEach(i=>{t.subMaterials.push(c6(i,e))}),t._waitingSubMaterialsUniqueIds=[]}),e.meshes.forEach(t=>{null!==t._waitingMaterialId&&(t.material=c6(t._waitingMaterialId,e),t._waitingMaterialId=null)}),r=0,s=e.skeletons.length;r<s;r++){let t=e.skeletons[r];t._hasWaitingData&&(null!=t.bones&&t.bones.forEach(t=>{if(t._waitingTransformNodeId){let i=e.getLastEntryById(t._waitingTransformNodeId);i&&t.linkTransformNode(i),t._waitingTransformNodeId=null}}),t._hasWaitingData=null)}for(r=0,s=e.meshes.length;r<s;r++){let t=e.meshes[r];t._waitingData.freezeWorldMatrix?(t.freezeWorldMatrix(),t._waitingData.freezeWorldMatrix=null):t.computeWorldMatrix(!0)}for(r=0,s=e.lights.length;r<s;r++){let t=e.lights[r];if(t._excludedMeshesIds.length>0){for(let i=0;i<t._excludedMeshesIds.length;i++){let r=e.getMeshById(t._excludedMeshesIds[i]);r&&t.excludedMeshes.push(r)}t._excludedMeshesIds=[]}if(t._includedOnlyMeshesIds.length>0){for(let i=0;i<t._includedOnlyMeshesIds.length;i++){let r=e.getMeshById(t._includedOnlyMeshesIds[i]);r&&t.includedOnlyMeshes.push(r)}t._includedOnlyMeshesIds=[]}}for(e.geometries.forEach(e=>{e._loadedUniqueId=""}),(0,rY.Ze)(o,e,n,i),r=0,s=e.meshes.length;r<s;r++){let t=e.meshes[r];t._waitingData.actions&&(rf.Parse(t._waitingData.actions,t,e),t._waitingData.actions=null)}void 0!==o.actions&&null!==o.actions&&rf.Parse(o.actions,null,e)}catch(t){let e=c4("loadAssets",o?o.producer:"Unknown")+a;if(r)r(e,t);else throw re.Y.Log(e),t}finally{c0={},c1={},s||n.removeAllFromScene(),null!==a&&lh.n0.loggingLevel!==lh.n0.NO_LOGGING&&re.Y.Log(c4("loadAssets",o?o.producer:"Unknown")+(lh.n0.loggingLevel!==lh.n0.MINIMAL_LOGGING?a:""))}return n};lh.n0.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:e=>-1!==e.indexOf("babylon"),importMesh:(e,t,i,r,s,n,a,o)=>{let l="importMesh has failed JSON parse";try{var c=JSON.parse(i);l="";let o=lh.n0.loggingLevel===lh.n0.DETAILED_LOGGING;e?Array.isArray(e)||(e=[e]):e=null;let u=[],h=new Map,d=[];if(void 0!==c.transformNodes&&null!==c.transformNodes)for(let e=0,i=c.transformNodes.length;e<i;e++){let i=c.transformNodes[e],s=rR.Y.Parse(i,t,r);d.push(s),h.set(s._waitingParsedUniqueId,s),s._waitingParsedUniqueId=null}if(void 0!==c.meshes&&null!==c.meshes){let i;let n=[],f=[],p=[],m=[];for(let i=0,d=c.meshes.length;i<d;i++){let d=c.meshes[i];if(null===e||c3(d,e,u)){if(null!==e&&delete e[e.indexOf(d.name)],void 0!==d.geometryId&&null!==d.geometryId&&void 0!==c.geometries&&null!==c.geometries){let e=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(i=>{!0!==e&&c.geometries[i]&&Array.isArray(c.geometries[i])&&c.geometries[i].forEach(s=>{s.id===d.geometryId&&("vertexData"===i&&cM.Z.Parse(s,t,r),e=!0)})}),!1===e&&re.Y.Warn("Geometry not found for mesh "+d.id)}if(d.materialUniqueId||d.materialId){let e=d.materialUniqueId?p:f,i=-1!==e.indexOf(d.materialUniqueId||d.materialId);if(!1===i&&void 0!==c.multiMaterials&&null!==c.multiMaterials){let s=(i,s)=>{e.push(i);let n=c2(s,c,t,r);n&&n.material&&(c1[n.parsedMaterial.uniqueId||n.parsedMaterial.id]=n.material,l+="\n	Material "+n.material.toString(o))};for(let r=0,n=c.multiMaterials.length;r<n;r++){let n=c.multiMaterials[r];if(d.materialUniqueId&&n.uniqueId===d.materialUniqueId||n.id===d.materialId){n.materialsUniqueIds?n.materialsUniqueIds.forEach(e=>s(e,t=>t.uniqueId===e)):n.materials.forEach(e=>s(e,t=>t.id===e)),e.push(n.uniqueId||n.id);let r=cN.G.ParseMultiMaterial(n,t);c1[n.uniqueId||n.id]=r,r&&(i=!0,l+="\n	Multi-Material "+r.toString(o));break}}}if(!1===i){e.push(d.materialUniqueId||d.materialId);let i=c2(e=>d.materialUniqueId&&e.uniqueId===d.materialUniqueId||e.id===d.materialId,c,t,r);i&&i.material?(c1[i.parsedMaterial.uniqueId||i.parsedMaterial.id]=i.material,l+="\n	Material "+i.material.toString(o)):re.Y.Warn("Material not found for mesh "+d.id)}}if(null!==d.skeletonId&&void 0!==d.skeletonId&&-1!==c.skeletonId&&void 0!==c.skeletons&&null!==c.skeletons&&!(n.indexOf(d.skeletonId)>-1))for(let e=0,i=c.skeletons.length;e<i;e++){let i=c.skeletons[e];if(i.id===d.skeletonId){let e=r0.Parse(i,t);a.push(e),n.push(i.id),l+="\n	Skeleton "+e.toString(o)}}if(d.morphTargetManagerId>-1&&void 0!==c.morphTargetManagers&&null!==c.morphTargetManagers&&!(m.indexOf(d.morphTargetManagerId)>-1))for(let e=0,i=c.morphTargetManagers.length;e<i;e++){let i=c.morphTargetManagers[e];if(i.id===d.morphTargetManagerId){let e=cU.Parse(i,t);m.push(e.uniqueId),l+="\nMorph target "+e.toString()}}let i=rP.Kj.Parse(d,t,r);s.push(i),h.set(i._waitingParsedUniqueId,i),i._waitingParsedUniqueId=null,l+="\n	Mesh "+i.toString(o)}}t.multiMaterials.forEach(e=>{e._waitingSubMaterialsUniqueIds.forEach(i=>{e.subMaterials.push(c6(i,t))}),e._waitingSubMaterialsUniqueIds=[]}),t.meshes.forEach(e=>{null!==e._waitingMaterialId&&(e.material=c6(e._waitingMaterialId,t),e._waitingMaterialId=null)});for(let e=0,i=t.transformNodes.length;e<i;e++){let i=t.transformNodes[e];if(null!==i._waitingParentId){let e=h.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let r=e;i._waitingParentInstanceIndex&&(r=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=r,i._waitingParentId=null}}for(let e=0,r=t.meshes.length;e<r;e++){if((i=t.meshes[e])._waitingParentId){let e=h.get(parseInt(i._waitingParentId))||null;null===e&&(e=t.getLastEntryById(i._waitingParentId));let r=e;if(i._waitingParentInstanceIndex&&(r=e.instances[parseInt(i._waitingParentInstanceIndex)],i._waitingParentInstanceIndex=null),i.parent=r,i.parent?.getClassName()==="TransformNode"){let e=d.indexOf(i.parent);e>-1&&d.splice(e,1)}i._waitingParentId=null}i._waitingData.lods&&c5(t,i)}for(let e of d)e.dispose();for(let e=0,i=t.skeletons.length;e<i;e++){let i=t.skeletons[e];i._hasWaitingData&&(null!=i.bones&&i.bones.forEach(e=>{if(e._waitingTransformNodeId){let i=t.getLastEntryById(e._waitingTransformNodeId);i&&e.linkTransformNode(i),e._waitingTransformNodeId=null}}),i._hasWaitingData=null)}for(let e=0,r=t.meshes.length;e<r;e++)(i=t.meshes[e])._waitingData.freezeWorldMatrix?(i.freezeWorldMatrix(),i._waitingData.freezeWorldMatrix=null):i.computeWorldMatrix(!0)}if(void 0!==c.particleSystems&&null!==c.particleSystems){let e=(0,rY.t)(rz.l.NAME_PARTICLESYSTEM);if(e)for(let i=0,s=c.particleSystems.length;i<s;i++){let s=c.particleSystems[i];-1!==u.indexOf(s.emitterId)&&n.push(e(s,t,r))}}return t.geometries.forEach(e=>{e._loadedUniqueId=""}),!0}catch(t){let e=c4("importMesh",c?c.producer:"Unknown")+l;if(o)o(e,t);else throw re.Y.Log(e),t}finally{null!==l&&lh.n0.loggingLevel!==lh.n0.NO_LOGGING&&re.Y.Log(c4("importMesh",c?c.producer:"Unknown")+(lh.n0.loggingLevel!==lh.n0.MINIMAL_LOGGING?l:"")),c1={}}return!1},load:(e,t,i,r)=>{let s="importScene has failed JSON parse";try{var n=JSON.parse(t);switch(s="",void 0!==n.useDelayedTextureLoading&&null!==n.useDelayedTextureLoading&&(e.useDelayedTextureLoading=n.useDelayedTextureLoading&&!lh.n0.ForceFullSceneLoadingForIncremental),void 0!==n.autoClear&&null!==n.autoClear&&(e.autoClear=n.autoClear),void 0!==n.clearColor&&null!==n.clearColor&&(e.clearColor=i2.HE.FromArray(n.clearColor)),void 0!==n.ambientColor&&null!==n.ambientColor&&(e.ambientColor=i2.Wo.FromArray(n.ambientColor)),void 0!==n.gravity&&null!==n.gravity&&(e.gravity=i1.P.FromArray(n.gravity)),void 0!==n.useRightHandedSystem&&(e.useRightHandedSystem=!!n.useRightHandedSystem),void 0!==n.fogMode&&null!==n.fogMode&&(e.fogMode=n.fogMode),void 0!==n.fogColor&&null!==n.fogColor&&(e.fogColor=i2.Wo.FromArray(n.fogColor)),void 0!==n.fogStart&&null!==n.fogStart&&(e.fogStart=n.fogStart),void 0!==n.fogEnd&&null!==n.fogEnd&&(e.fogEnd=n.fogEnd),void 0!==n.fogDensity&&null!==n.fogDensity&&(e.fogDensity=n.fogDensity),s+="	Fog mode for scene:  ",e.fogMode){case 0:s+="none\n";break;case 1:s+="exp\n";break;case 2:s+="exp2\n";break;case 3:s+="linear\n"}if(n.physicsEnabled){let t;"cannon"===n.physicsEngine||n.physicsEngine===cH.name?t=new cH(void 0,void 0,cJ.LoaderInjectedPhysicsEngine):"oimo"===n.physicsEngine||n.physicsEngine===cW.name?t=new cW(void 0,cJ.LoaderInjectedPhysicsEngine):("ammo"===n.physicsEngine||n.physicsEngine===cY.name)&&(t=new cY(void 0,cJ.LoaderInjectedPhysicsEngine,void 0)),s="	Physics engine "+(n.physicsEngine?n.physicsEngine:"oimo")+" enabled\n";let i=n.gravity?i1.P.FromArray(n.gravity):n.physicsGravity?i1.P.FromArray(n.physicsGravity):null;e.enablePhysics(i,t)}if(void 0!==n.metadata&&null!==n.metadata&&(e.metadata=n.metadata),void 0!==n.collisionsEnabled&&null!==n.collisionsEnabled&&(e.collisionsEnabled=n.collisionsEnabled),!c8(e,t,i,r,!0))return!1;return n.autoAnimate&&e.beginAnimation(e,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1),void 0!==n.activeCameraID&&null!==n.activeCameraID&&e.setActiveCameraById(n.activeCameraID),!0}catch(t){let e=c4("importScene",n?n.producer:"Unknown")+s;if(r)r(e,t);else throw re.Y.Log(e),t}finally{null!==s&&lh.n0.loggingLevel!==lh.n0.NO_LOGGING&&re.Y.Log(c4("importScene",n?n.producer:"Unknown")+(lh.n0.loggingLevel!==lh.n0.MINIMAL_LOGGING?s:""))}return!1},loadAssetContainer:(e,t,i,r)=>c8(e,t,i,r)}),i(27243),i(95538),i(50131),i(37506),i(93028),i(90982);class c9{get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,rV.a.MarkAllMaterialsAsDirty(20))}constructor(e={}){this._isEnabled=!0,this.bias=void 0===e.bias?0:e.bias,this.power=void 0===e.power?1:e.power,this.leftColor=e.leftColor||i2.Wo.White(),this.rightColor=e.rightColor||i2.Wo.Black(),!1===e.isEnabled&&(this.isEnabled=!1)}clone(){let e=new c9;return rd.j.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new c9({isEnabled:e.isEnabled,leftColor:i2.Wo.FromArray(e.leftColor),rightColor:i2.Wo.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}rq.p._FresnelParametersParser=c9.Parse;class ue{}ue.BindSceneUniformBuffer=le.ml,ue.PrepareDefinesForMergedUV=le.lw,ue.BindTextureMatrix=le.NL,ue.GetFogState=le.l6,ue.PrepareDefinesForMisc=le.BV,ue.PrepareDefinesForCamera=le.hR,ue.PrepareDefinesForFrameBoundValues=le.vG,ue.PrepareDefinesForBones=le.Ni,ue.PrepareDefinesForMorphTargets=le.FU,ue.PrepareDefinesForBakedVertexAnimation=le.Er,ue.PrepareDefinesForAttributes=le.wJ,ue.PrepareDefinesForMultiview=le.Z7,ue.PrepareDefinesForOIT=le.t6,ue.PrepareDefinesForPrePass=le.Kg,ue.PrepareDefinesForLight=le.wg,ue.PrepareDefinesForLights=le.UX,ue.PrepareUniformsAndSamplersForLight=le.YM,ue.PrepareUniformsAndSamplersList=le.DI,ue.HandleFallbacksForShadows=le.Lh,ue.PrepareAttributesForMorphTargetsInfluencers=le.Vk,ue.PrepareAttributesForMorphTargets=le.n5,ue.PrepareAttributesForBakedVertexAnimation=le.pd,ue.PrepareAttributesForBones=le.TD,ue.PrepareAttributesForInstances=le.od,ue.PushAttributesForInstances=le.y9,ue.BindLightProperties=le.KL,ue.BindLight=le.aM,ue.BindLights=le.VX,ue.BindFogParameters=le.D1,ue.BindBonesParameters=le.qx,ue.BindMorphTargetParameters=le.KG,ue.BindLogDepth=le.gz,i(8860),i(19948),i(66114);var ut=i(40193);class ui extends ut.m{get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new i2.Wo(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}getClassName(){return"PBRBaseSimpleMaterial"}}(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsLightsDirty")],ui.prototype,"maxSimultaneousLights",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsLightsDirty")],ui.prototype,"disableLighting",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],ui.prototype,"environmentTexture",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"invertNormalMapX",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"invertNormalMapY",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],ui.prototype,"normalTexture",void 0),(0,r$.gn)([(0,rj.n9)("emissive"),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"emissiveColor",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"emissiveTexture",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],ui.prototype,"occlusionStrength",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],ui.prototype,"occlusionTexture",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],ui.prototype,"alphaCutOff",void 0),(0,r$.gn)([(0,rj.qC)()],ui.prototype,"doubleSided",null),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty",null)],ui.prototype,"lightmapTexture",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],ui.prototype,"useLightmapAsShadowmap",void 0);var ur=i(29526),us=i(66110);class un extends ui{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){let t=rq.p.Clone(()=>new un(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){let e=rq.p.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){let r=rq.p.Parse(()=>new un(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}(0,r$.gn)([(0,rj.n9)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],un.prototype,"baseColor",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],un.prototype,"baseTexture",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],un.prototype,"metallic",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],un.prototype,"roughness",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],un.prototype,"metallicRoughnessTexture",void 0),(0,i3.H7)("BABYLON.PBRMetallicRoughnessMaterial",un);class ua extends ui{get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){let t=rq.p.Clone(()=>new ua(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){let e=rq.p.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){let r=rq.p.Parse(()=>new ua(e.name,t),e,t,i);return e.clearCoat&&r.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&r.anisotropy.parse(e.anisotropy,t,i),e.brdf&&r.brdf.parse(e.brdf,t,i),e.sheen&&r.sheen.parse(e.sheen,t,i),e.subSurface&&r.subSurface.parse(e.subSurface,t,i),e.iridescence&&r.iridescence.parse(e.iridescence,t,i),r}}(0,r$.gn)([(0,rj.n9)("diffuse"),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_albedoColor")],ua.prototype,"diffuseColor",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],ua.prototype,"diffuseTexture",void 0),(0,r$.gn)([(0,rj.n9)("specular"),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],ua.prototype,"specularColor",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_microSurface")],ua.prototype,"glossiness",void 0),(0,r$.gn)([(0,rj.oU)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],ua.prototype,"specularGlossinessTexture",void 0),(0,i3.H7)("BABYLON.PBRSpecularGlossinessMaterial",ua),i(70325),i(88118),i(8133),i(77082),i(98296),i(80024),(eu=t6||(t6={}))[eu.GLSL=0]="GLSL",eu[eu.WGSL=1]="WGSL";class uo extends o1.V{constructor(e,t,i=null){if(super(t),!e)return;if(this._textureMatrix=i1.y3.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{let e=this.getScene();e&&e.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){let e;let t=this._getEngine();e=t._features.support3DTextures?t.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=e,this._texture.isReady=!1,this.isCube=!1,this.is3D=t._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;let i=i=>{let r;if("string"!=typeof i)return;let s=null,n=null,a=i.split("\n"),o=0,l=0,c=0,u=0,h=0;for(let e=0;e<a.length;e++){if(r=a[e],!uo._NoneEmptyLineRegex.test(r)||0===r.indexOf("#"))continue;let t=r.split(" ");if(0===o){s=new Uint8Array((o=t.length)*o*o*4),n=new Float32Array(o*o*o*4);continue}if(0!=o){let e=Math.max(parseInt(t[0]),0),i=Math.max(parseInt(t[1]),0),r=Math.max(parseInt(t[2]),0);h=Math.max(r,h=Math.max(i,h=Math.max(e,h)));let s=(l+u*o+c*o*o)*4;n&&(n[s+0]=e,n[s+1]=i,n[s+2]=r),++c%o==0&&(c=0,++u%o==0&&(l++,u=0))}}if(n&&s)for(let e=0;e<n.length;e++)if(e>0&&(e+1)%4==0)s[e]=255;else{let t=n[e];s[e]=t/h*255}e.is3D?(e.updateSize(o,o,o),t.updateRawTexture3D(e,s,5,!1)):(e.updateSize(o*o,o),t.updateRawTexture(e,s,5,!1)),e.isReady=!0,this._triggerOnLoad()},r=this.getScene();return r?r._loadFile(this.url,i):t._loadFile(this.url,i),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){let e=new uo(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){4===this.delayLoadState&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&((i=new uo(e.name,t)).name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;let e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}uo._NoneEmptyLineRegex=/\S+/,(0,i3.H7)("BABYLON.ColorGradingTexture",uo);var ul=i(75769),uc=i(14684);class uu extends o1.V{constructor(e,t,i,r=!1,s=!0,n=null,a=null,o=!1){if(super(t),this._onLoad=null,this._onError=null,!e)throw Error("Image url is not set");this._coordinatesMode=rZ.x.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._supersample=o,this._noMipmap=r,this.gammaSpace=s,this._onLoad=n,this._onError=a,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?n&&(this._texture.isReady?rD.w1.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(n)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage(()=>this._loadTexture(),this._onError)}_loadImage(e,t){let i=this.getScene();if(!i)return;let r=i.getEngine().createRawCubeTexture(null,this._size,4,i.getEngine().getCaps().textureFloat?1:7,!this._noMipmap,!1,3);r.generateMipMaps=!this._noMipmap,i.addPendingData(r),r.url=this.url,r.isReady=!1,i.getEngine()._internalTexturesCache.push(r),this._texture=r;let s=document.createElement("canvas");(0,uc.r6)(this.url,t=>{this._width=t.width,this._height=t.height,s.width=this._width,s.height=this._height;let i=s.getContext("2d");i.drawImage(t,0,0);let r=i.getImageData(0,0,t.width,t.height);this._buffer=r.data.buffer,s.remove(),e()},(e,s)=>{i.removePendingData(r),t&&t(`${this.getClassName()} could not be loaded`,s)},i?i.offlineProvider:null)}_loadTexture(){let e=this.getScene();if(!e)return;let t=(()=>{let e=this._getFloat32ArrayFromArrayBuffer(this._buffer),t=ul.B.ConvertPanoramaToCubemap(e,this._width,this._height,this._size,this._supersample),i=[];for(let e=0;e<6;e++){let r=t[uu._FacesMapping[e]];i.push(r)}return i})(),i=this._texture;e.getEngine().updateRawCubeTexture(i,t,i.format,i.type,i.invertY),i.isReady=!0,e.removePendingData(i),i.onLoadedObservable.notifyObservers(i),i.onLoadedObservable.clear(),this._onLoad&&this._onLoad()}_getFloat32ArrayFromArrayBuffer(e){let t=new DataView(e),i=new Float32Array(3*e.byteLength/4),r=0;for(let s=0;s<e.byteLength;s++)(s+1)%4!=0&&(i[r++]=t.getUint8(s)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){let e=this.getScene();if(!e)return this;let t=new uu(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}uu._FacesMapping=["right","left","up","down","front","back"];class uh extends o1.V{constructor(e,t,i){if(super(i.scene||i.engine),this.onLoadObservable=new i0.y$,!t||!i.engine&&!i.scene)return;if(i={...uh._DefaultOptions,...i},this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=i1.y3.Identity(),this._format=i.format,this.name=e,this.element=t,this._isVideo=!!t.getVideoPlaybackQuality,this._isVideo){let e=this._engine,i=e?.createExternalTexture;i&&(this._externalTexture=i.call(e,t))}this.anisotropicFilteringLevel=1,this._createInternalTexture()}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);let i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode),this._texture.format=this._format),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){let t=this._getEngine();if(null==this._texture||null==t)return;let i=this.isReady();if(this._isVideo){let i=this.element;if(i.readyState<i.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,this._externalTexture?this._externalTexture:i,null===e||e)}else{let i=this.element;t.updateDynamicTexture(this._texture,i,null===e||e,!1,this._format)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}uh._DefaultOptions={generateMipMaps:!1,samplingMode:2,format:5,engine:null,scene:null},i(86861),i(46877),i(35068),i(57301),i(49714),i(1392),i(68940),i(89458),i(3983),i(57859),i(29990);class ud extends s2._{get isSupported(){return this._engine?.getCaps().drawBuffersExtension??!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}constructor(e,t,i,r,s,n){let a=!!s&&!!s.generateMipMaps&&s.generateMipMaps,o=!!s&&!!s.generateDepthTexture&&s.generateDepthTexture,l=s&&s.depthTextureFormat?s.depthTextureFormat:15,c=!s||void 0===s.doNotChangeAspectRatio||s.doNotChangeAspectRatio,u=!!s&&!!s.drawOnlyOnFirstAttachmentByDefault&&s.drawOnlyOnFirstAttachmentByDefault;if(super(e,t,r,a,c,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported){this.dispose();return}this._textureNames=n;let h=[],d=[],f=[],p=[],m=[],_=[],g=[],v=[];this._initTypes(i,h,d,f,p,m,_,g,v,s);let S=!s||void 0===s.generateDepthBuffer||s.generateDepthBuffer,x=!!s&&void 0!==s.generateStencilBuffer&&s.generateStencilBuffer;this._multiRenderTargetOptions={samplingModes:d,generateMipMaps:a,generateDepthBuffer:S,generateStencilBuffer:x,generateDepthTexture:o,depthTextureFormat:l,types:h,textureCount:i,useSRGBBuffers:f,formats:p,targetTypes:m,faceIndex:_,layerIndex:g,layerCounts:v,labels:n,label:e},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=u,i>0&&(this._createInternalTextures(),this._createTextures(n))}_initTypes(e,t,i,r,s,n,a,o,l,c){for(let u=0;u<e;u++)c&&c.types&&void 0!==c.types[u]?t.push(c.types[u]):t.push(c&&c.defaultType?c.defaultType:0),c&&c.samplingModes&&void 0!==c.samplingModes[u]?i.push(c.samplingModes[u]):i.push(rZ.x.BILINEAR_SAMPLINGMODE),c&&c.useSRGBBuffers&&void 0!==c.useSRGBBuffers[u]?r.push(c.useSRGBBuffers[u]):r.push(!1),c&&c.formats&&void 0!==c.formats[u]?s.push(c.formats[u]):s.push(5),c&&c.targetTypes&&void 0!==c.targetTypes[u]?n.push(c.targetTypes[u]):n.push(3553),c&&c.faceIndex&&void 0!==c.faceIndex[u]?a.push(c.faceIndex[u]):a.push(0),c&&c.layerIndex&&void 0!==c.layerIndex[u]?o.push(c.layerIndex[u]):o.push(0),c&&c.layerCounts&&void 0!==c.layerCounts[u]?l.push(c.layerCounts[u]):l.push(1)}_createInternaTextureIndexMapping(){let e={},t=[];if(!this._renderTarget)return t;let i=this._renderTarget.textures;for(let r=0;r<i.length;r++){let s=i[r];if(!s)continue;let n=e[s.uniqueId];void 0!==n?t[r]=n:e[s.uniqueId]=r}return t}_rebuild(e=!1,t=!1,i){if(this._count<1||e)return;let r=this._createInternaTextureIndexMapping();this.releaseInternalTextures(),this._createInternalTextures(),t&&(this._releaseTextures(),this._createTextures(i));let s=this._renderTarget.textures;for(let e=0;e<s.length;e++){let t=this._textures[e];void 0!==r[e]&&this._renderTarget.setTexture(s[r[e]],e),t._texture=s[e],t._texture&&(t._noMipmap=!t._texture.useMipMaps,t._useSRGBBuffer=t._texture._useSRGBBuffer)}1!==this.samples&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){let t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){let r=new rZ.x(null,this.getScene());e?.[i]&&(r.name=e[i]),r._texture=t[i],r._texture&&(r._noMipmap=!r._texture.useMipMaps,r._useSRGBBuffer=r._texture._useSRGBBuffer),this._textures.push(r)}}setInternalTexture(e,t,i=!0){if(this.renderTarget&&(0===t&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new rZ.x(null,this.getScene()),this.textures[t].name=this._textureNames?.[t]??this.textures[t].name),this.textures[t]._texture=e,this.textures[t]._noMipmap=!e.useMipMaps,this.textures[t]._useSRGBBuffer=e._useSRGBBuffer,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer),this._multiRenderTargetOptions.targetTypes&&-1!==this._multiRenderTargetOptions.targetTypes[t])){let i=0;i=e.is2DArray?35866:e.isCube?34067:e.is3D?32879:3553,this._multiRenderTargetOptions.targetTypes[t]=i}}setLayerAndFaceIndex(e,t=-1,i=-1){this.textures[e]&&this.renderTarget&&(this._multiRenderTargetOptions.layerIndex&&(this._multiRenderTargetOptions.layerIndex[e]=t),this._multiRenderTargetOptions.faceIndex&&(this._multiRenderTargetOptions.faceIndex[e]=i),this.renderTarget.setLayerAndFaceIndex(e,t,i))}setLayerAndFaceIndices(e,t){this.renderTarget&&(this._multiRenderTargetOptions.layerIndex=e,this._multiRenderTargetOptions.faceIndex=t,this.renderTarget.setLayerAndFaceIndices(e,t))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._processSizeParameter(e,!1),this._rebuild(!1,void 0,this._textureNames)}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;let r=[],s=[],n=[],a=[],o=[],l=[],c=[],u=[];this._textureNames=i,this._initTypes(e,r,s,n,a,o,l,c,u,t),this._multiRenderTargetOptions.types=r,this._multiRenderTargetOptions.samplingModes=s,this._multiRenderTargetOptions.useSRGBBuffers=n,this._multiRenderTargetOptions.formats=a,this._multiRenderTargetOptions.targetTypes=o,this._multiRenderTargetOptions.faceIndex=l,this._multiRenderTargetOptions.layerIndex=c,this._multiRenderTargetOptions.layerCounts=u,this._multiRenderTargetOptions.labels=i,this._rebuild(!1,!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){let e=this._renderTarget?.textures;if(e){for(let t=e.length-1;t>=0;t--)this._textures[t]._texture=null;this._renderTarget?.dispose(),this._renderTarget=null}}}class uf{constructor(e,t,i){this.id=e,this.scale=t,this.offset=i}}class up{constructor(e,t,i,r){return this.name=e,this.meshes=t,this.scene=r,this.options=i,this.options.map=this.options.map??["ambientTexture","bumpTexture","diffuseTexture","emissiveTexture","lightmapTexture","opacityTexture","reflectionTexture","refractionTexture","specularTexture"],this.options.uvsIn=this.options.uvsIn??st.o.UVKind,this.options.uvsOut=this.options.uvsOut??st.o.UVKind,this.options.layout=this.options.layout??up.LAYOUT_STRIP,this.options.layout===up.LAYOUT_COLNUM&&(this.options.colnum=this.options.colnum??8),this.options.updateInputMeshes=this.options.updateInputMeshes??!0,this.options.disposeSources=this.options.disposeSources??!0,this._expecting=0,this.options.fillBlanks=this.options.fillBlanks??!0,!0===this.options.fillBlanks&&(this.options.customFillColor=this.options.customFillColor??"black"),this.options.frameSize=this.options.frameSize??256,this.options.paddingRatio=this.options.paddingRatio??.0115,this._paddingValue=Math.ceil(this.options.frameSize*this.options.paddingRatio),this._paddingValue%2!=0&&this._paddingValue++,this.options.paddingMode=this.options.paddingMode??up.SUBUV_WRAP,this.options.paddingMode===up.SUBUV_COLOR&&(this.options.paddingColor=this.options.paddingColor??new i2.HE(0,0,0,1)),this.sets={},this.frames=[],this}_createFrames(e){let t=this._calculateSize(),i=new i1.FM(1,1).divide(t),r=0,s=this._expecting,n=this.meshes.length,a=Object.keys(this.sets);for(let e=0;e<a.length;e++){let i=a[e],r=new na.c(this.name+".TexturePack."+i+"Set",{width:t.x,height:t.y},this.scene,!0,rZ.x.TRILINEAR_SAMPLINGMODE,5),s=r.getContext();s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,t.x,t.y),r.update(!1),this.sets[i]=r}let o=this.options.frameSize||256,l=this._paddingValue,c=o+2*l,u=()=>{this._calculateMeshUVFrames(o,l,t,i,this.options.updateInputMeshes||!1)};for(let i=0;i<n;i++){let n=this.meshes[i].material;for(let h=0;h<a.length;h++){let d=new na.c("temp",c,this.scene,!0),f=d.getContext(),p=this._getFrameOffset(i),m=()=>{r++,d.update(!1);let i=f.getImageData(0,0,c,c),n=this.sets[_];if(n.getContext().putImageData(i,t.x*p.x,t.y*p.y),d.dispose(),n.update(!1),r==s){u(),e();return}},_=a[h]||"_blank";if(n&&null!==n[_]){let e=n[_],t=new Image;e instanceof na.c?t.src=e.getContext().canvas.toDataURL("image/png"):t.src=e.url,rD.w1.SetCorsBehavior(t.src,t),t.onload=()=>{f.fillStyle="rgba(0,0,0,0)",f.fillRect(0,0,c,c),d.update(!1),f.setTransform(1,0,0,-1,0,0);let e=[0,0,1,0,1,1,0,1,-1,1,-1,0,-2,0,-1,1,-1];switch(this.options.paddingMode){case 0:for(let i=0;i<9;i++)f.drawImage(t,0,0,t.width,t.height,l+o*e[i],l+o*e[i+1]-c,o,o);break;case 1:for(let e=0;e<l;e++)f.drawImage(t,0,0,t.width,t.height,e+0*o,l-c,o,o),f.drawImage(t,0,0,t.width,t.height,2*l-e,l-c,o,o),f.drawImage(t,0,0,t.width,t.height,l,e-c,o,o),f.drawImage(t,0,0,t.width,t.height,l,2*l-e-c,o,o);f.drawImage(t,0,0,t.width,t.height,l+0*o,l+0*o-c,o,o);break;case 2:f.fillStyle=(this.options.paddingColor||i2.Wo.Black()).toHexString(),f.fillRect(0,0,c,-c),f.clearRect(l,l,o,o),f.drawImage(t,0,0,t.width,t.height,l+0*o,l+0*o-c,o,o)}f.setTransform(1,0,0,1,0,0),m()}}else f.fillStyle="rgba(0,0,0,0)",this.options.fillBlanks&&(f.fillStyle=this.options.customFillColor),f.fillRect(0,0,c,c),m()}}}_calculateSize(){let e=this.meshes.length||0,t=this.options.frameSize||0,i=this._paddingValue||0;switch(this.options.layout){case 0:return new i1.FM(t*e+2*i*e,t+2*i);case 1:{let r=Math.max(2,Math.ceil(Math.sqrt(e))),s=t*r+2*i*r;return new i1.FM(s,s)}case 2:{let r=this.options.colnum||1,s=Math.max(1,Math.ceil(e/r));return new i1.FM(t*r+2*i*r,t*s+2*i*s)}}return i1.FM.Zero()}_calculateMeshUVFrames(e,t,i,r,s){let n=this.meshes.length;for(let a=0;a<n;a++){let n=this.meshes[a],o=new i1.FM(e/i.x,e/i.y),l=r.clone().scale(t),c=this._getFrameOffset(a).add(l),u=new uf(a,o,c);this.frames.push(u),s&&(this._updateMeshUV(n,a),this._updateTextureReferences(n))}}_getFrameOffset(e){let t,i,r;let s=this.meshes.length;switch(this.options.layout){case 0:return t=1/s,new i1.FM(e*t,0);case 1:{let n=Math.max(2,Math.ceil(Math.sqrt(s)));return i=Math.floor(e/n),r=e-i*n,t=1/n,new i1.FM(r*t,i*t)}case 2:{let n=this.options.colnum||1,a=Math.max(1,Math.ceil(s/n));return r=Math.floor(e/a),i=e-r*a,t=new i1.FM(1/n,1/a),new i1.FM(r*t.x,i*t.y)}}return i1.FM.Zero()}_updateMeshUV(e,t){let i=this.frames[t],r=e.getVerticesData(this.options.uvsIn||st.o.UVKind),s=[],n=0;r.length&&(n=r.length||0);for(let e=0;e<n;e+=2)s.push(r[e]*i.scale.x+i.offset.x,r[e+1]*i.scale.y+i.offset.y);e.setVerticesData(this.options.uvsOut||st.o.UVKind,s)}_updateTextureReferences(e,t=!1){let i=e.material,r=Object.keys(this.sets),s=e=>{e.dispose&&e.dispose()};for(let e=0;e<r.length;e++){let n=r[e];if(t)null!==i[n]&&s(i[n]),i[n]=this.sets[n];else{if(!i)return;null!==i[n]&&(s(i[n]),i[n]=this.sets[n])}}}setMeshToFrame(e,t,i=!1){this._updateMeshUV(e,t),i&&this._updateTextureReferences(e,!0)}processAsync(){return new Promise((e,t)=>{try{if(0===this.meshes.length){e();return}let t=0,i=i=>{if(t++,this.options.map){for(let e=0;e<this.options.map.length;e++){let t=i[this.options.map[e]];null!==t&&(this.sets[this.options.map[e]]||(this.sets[this.options.map[e]]=!0),this._expecting++)}t===this.meshes.length&&this._createFrames(e)}};for(let r=0;r<this.meshes.length;r++){let s=this.meshes[r],n=s.material;if(!n){if(++t===this.meshes.length)return this._createFrames(e);continue}n.forceCompilationAsync(s).then(()=>{i(n)})}}catch(e){return t(e)}})}dispose(){let e=Object.keys(this.sets);for(let t=0;t<e.length;t++){let i=e[t];this.sets[i].dispose()}}download(e="png",t=1){setTimeout(()=>{let i={name:this.name,sets:{},options:{},frames:[]},r=Object.keys(this.sets),s=Object.keys(this.options);try{for(let s=0;s<r.length;s++){let n=r[s],a=this.sets[n];i.sets[n]=a.getContext().canvas.toDataURL("image/"+e,t)}for(let e=0;e<s.length;e++){let t=s[e];i.options[t]=this.options[t]}for(let e=0;e<this.frames.length;e++){let t=this.frames[e];i.frames.push(t.scale.x,t.scale.y,t.offset.x,t.offset.y)}}catch(e){re.Y.Warn("Unable to download: "+e);return}let n="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(i,null,4)),a=document.createElement("a");a.setAttribute("href",n),a.setAttribute("download",this.name+"_texurePackage.json"),document.body.appendChild(a),a.click(),a.remove()},0)}updateFromJSON(e){try{let t=JSON.parse(e);this.name=t.name;let i=Object.keys(t.options);for(let e=0;e<i.length;e++)this.options[i[e]]=t.options[i[e]];for(let e=0;e<t.frames.length;e+=4){let i=new uf(e/4,new i1.FM(t.frames[e],t.frames[e+1]),new i1.FM(t.frames[e+2],t.frames[e+3]));this.frames.push(i)}let r=Object.keys(t.sets);for(let e=0;e<r.length;e++){let i=new rZ.x(t.sets[r[e]],this.scene,!1,!1);this.sets[r[e]]=i}}catch(e){re.Y.Warn("Unable to update from JSON: "+e)}}}up.LAYOUT_STRIP=0,up.LAYOUT_POWER2=1,up.LAYOUT_COLNUM=2,up.SUBUV_WRAP=0,up.SUBUV_EXTEND=1,up.SUBUV_COLOR=2;var um=i(83610);i(94136),i(72831);var u_=i(14187);i(55663),i(3509),i(29653),i(81438),i(35275),i(54625),i(74988),(eh=t8||(t8={}))[eh.Uniform=0]="Uniform",eh[eh.Attribute=1]="Attribute",eh[eh.Varying=2]="Varying",eh[eh.Undefined=3]="Undefined";class ug extends ly{constructor(e,t,i,r,s){super(e,t,i),this._blockType=r,this._blockName=s,this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof ug&&e._blockName===this._blockName?0:1}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class uv extends lP{constructor(e){super(e,tj.Vertex),this.registerInput("matricesIndices",t$.Vector4),this.registerInput("matricesWeights",t$.Vector4),this.registerInput("matricesIndicesExtra",t$.Vector4,!0),this.registerInput("matricesWeightsExtra",t$.Vector4,!0),this.registerInput("world",t$.Matrix),this.registerOutput("output",t$.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,10001)),Promise.resolve().then(i.bind(i,30037))]):await Promise.all([Promise.resolve().then(i.bind(i,74910)),Promise.resolve().then(i.bind(i,27373))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.matricesIndices.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"matricesIndices"===e.name&&t(e));i||(i=new lL("matricesIndices")).setAsAttribute("matricesIndices"),i.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"matricesWeights"===e.name&&t(e));i||(i=new lL("matricesWeights")).setAsAttribute("matricesWeights"),i.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.World&&t(e));i||(i=new lL("world")).setAsSystemValue(tZ.World),i.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){(0,le.qx)(i,e)}prepareDefines(e,t,i){i._areAttributesDirty&&(0,le.Ni)(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");let t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});let i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});let r=this._outputs[0],s=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0
`,e.compilationString+=e._declareOutput(r)+` = ${s.associatedVariableName} * ${i};
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(r)+` = ${s.associatedVariableName};
`,e.compilationString+=`#endif
`,this}}(0,i3.H7)("BABYLON.BonesBlock",uv);class uS extends lP{constructor(e){super(e,tj.Vertex),this.registerInput("world0",t$.Vector4),this.registerInput("world1",t$.Vector4),this.registerInput("world2",t$.Vector4),this.registerInput("world3",t$.Vector4),this.registerInput("world",t$.Matrix,!0),this.registerOutput("output",t$.Matrix),this.registerOutput("instanceID",t$.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e,t=()=>!0){if(!this.world0.connectedPoint){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"world0"===e.name&&t(e));i||(i=new lL("world0")).setAsAttribute("world0"),i.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"world1"===e.name&&t(e));i||(i=new lL("world1")).setAsAttribute("world1"),i.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"world2"===e.name&&t(e));i||(i=new lL("world2")).setAsAttribute("world2"),i.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"world3"===e.name&&t(e));i||(i=new lL("world3")).setAsAttribute("world3"),i.output.connectTo(this.world3)}if(!this.world.connectedPoint){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"world"===e.name&&t(e));i||(i=new lL("world")).setAsSystemValue(tZ.World),i.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,r=!1,s){let n=!1;i.INSTANCES!==r&&(i.setValue("INSTANCES",r),n=!0),s&&!!s?.getRenderingMesh().hasThinInstances!==i.THIN_INSTANCES&&(i.setValue("THIN_INSTANCES",!!s?.getRenderingMesh().hasThinInstances),n=!0),n&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);let t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);let i=this._outputs[0],r=this._outputs[1],s=this.world0,n=this.world1,a=this.world2,o=this.world3,l="mat4",c="gl_InstanceID",u="float";return 1===e.shaderLanguage&&(l="mat4x4f",c="vertexInputs.instanceIndex",u="f32"),e.compilationString+=`#ifdef INSTANCES
`,e.compilationString+=e._declareOutput(i)+` = ${l}(${s.associatedVariableName}, ${n.associatedVariableName}, ${a.associatedVariableName}, ${o.associatedVariableName});
`,e.compilationString+=`#ifdef THIN_INSTANCES
`,e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};
`,e.compilationString+=`#endif
`,t._caps.canUseGLInstanceID?e.compilationString+=e._declareOutput(r)+` = ${u}(${c});
`:e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(i)+` = ${this.world.associatedVariableName};
`,e.compilationString+=e._declareOutput(r)+` = 0.0;
`,e.compilationString+=`#endif
`,this}}(0,i3.H7)("BABYLON.InstancesBlock",uS);class ux extends lP{constructor(e){super(e,tj.Vertex),this.registerInput("position",t$.Vector3),this.registerInput("normal",t$.Vector3),this.registerInput("tangent",t$.AutoDetect),this.tangent.addExcludedConnectionPointFromAllowedTypes(t$.Color4|t$.Vector4|t$.Vector3),this.registerInput("uv",t$.Vector2),this.registerOutput("positionOutput",t$.Vector3),this.registerOutput("normalOutput",t$.Vector3),this.registerOutput("tangentOutput",t$.Vector4),this.registerOutput("uvOutput",t$.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,87696)),Promise.resolve().then(i.bind(i,31343)),Promise.resolve().then(i.bind(i,8772)),Promise.resolve().then(i.bind(i,54394))]):await Promise.all([Promise.resolve().then(i.bind(i,74436)),Promise.resolve().then(i.bind(i,43626)),Promise.resolve().then(i.bind(i,76086)),Promise.resolve().then(i.bind(i,50731))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"position"===e.name&&t(e));i||(i=new lL("position")).setAsAttribute(),i.output.connectTo(this.position)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"normal"===e.name&&t(e));i||(i=new lL("normal")).setAsAttribute("normal"),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"tangent"===e.name&&t(e));i||(i=new lL("tangent")).setAsAttribute("tangent"),i.output.connectTo(this.tangent)}if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"uv"===e.name&&t(e));i||(i=new lL("uv")).setAsAttribute("uv"),i.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){let t=e.morphTargetManager;t?.isUsingTextureForTargets&&(t.numMaxInfluencers||t.numInfluencers)!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}i._areAttributesDirty&&(0,le.FU)(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&((0,le.KG)(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,r){let s=this.position,n=this.normal,a=this.tangent,o=this.uv,l=this.positionOutput,c=this.normalOutput,u=this.tangentOutput,h=this.uvOutput,d=r.NUM_MORPH_INFLUENCERS,f=i.morphTargetManager,p=f&&f.supportsNormals&&r.NORMAL,m=f&&f.supportsTangents&&r.TANGENT,_=f&&f.supportsUVs&&r.UV1,g="";f?.isUsingTextureForTargets&&d>0&&(g+=`${e._declareLocalVar("vertexID",t$.Float)};
`),g+=`#ifdef MORPHTARGETS
`;let v=1===e.shaderLanguage,S=v?"uniforms.":"";if(f?.isUsingTextureForTargets)g+=`for (${v?"var":"int"} i = 0; i < NUM_MORPH_INFLUENCERS; i++) {
if (i >= ${S}morphTargetCount) { break; }
vertexID = ${v?"f32(vertexInputs.vertexIndex":"float(gl_VertexID"}) * ${S}morphTargetTextureInfo.x;
${l.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${s.associatedVariableName}) * ${S}morphTargetInfluences[i];
vertexID += 1.0;
`,p&&(g+=`#ifdef MORPHTARGETS_NORMAL
${c.associatedVariableName} += (readVector3FromRawSampler(i, vertexID) - ${n.associatedVariableName}) * ${S}morphTargetInfluences[i];
vertexID += 1.0;
#endif
`),_&&(g+=`#ifdef MORPHTARGETS_UV
${h.associatedVariableName} += (readVector3FromRawSampler(i, vertexID).xy - ${o.associatedVariableName}) * ${S}morphTargetInfluences[i];
vertexID += 1.0;
#endif
`),m&&(g+=`#ifdef MORPHTARGETS_TANGENT
${u.associatedVariableName}.xyz += (readVector3FromRawSampler(i, vertexID) - ${a.associatedVariableName}.xyz) * ${S}morphTargetInfluences[i];
`,a.type===t$.Vector4?g+=`${u.associatedVariableName}.w = ${a.associatedVariableName}.w;
`:g+=`${u.associatedVariableName}.w = 1.;
`,g+=`#endif
`),g+="}\n";else for(let e=0;e<d;e++)g+=`${l.associatedVariableName} += (position${e} - ${s.associatedVariableName}) * ${S}morphTargetInfluences[${e}];
`,p&&(g+=`#ifdef MORPHTARGETS_NORMAL
${c.associatedVariableName} += (normal${e} - ${n.associatedVariableName}) * ${S}morphTargetInfluences[${e}];
#endif
`),_&&(g+=`#ifdef MORPHTARGETS_UV
${h.associatedVariableName}.xy += (uv_${e} - ${o.associatedVariableName}.xy) * ${S}morphTargetInfluences[${e}];
#endif
`),m&&(g+=`#ifdef MORPHTARGETS_TANGENT
${u.associatedVariableName}.xyz += (tangent${e} - ${a.associatedVariableName}.xyz) * ${S}morphTargetInfluences[${e}];
`,a.type===t$.Vector4?g+=`${u.associatedVariableName}.w = ${a.associatedVariableName}.w;
`:g+=`${u.associatedVariableName}.w = 1.;
`,g+=`#endif
`);if(g+=`#endif
`,e.compilationString=e.compilationString.replace(this._repeatableContentAnchor,g),d>0)for(let t=0;t<d;t++)e.attributes.push(st.o.PositionKind+t),p&&e.attributes.push(st.o.NormalKind+t),m&&e.attributes.push(st.o.TangentKind+t),_&&e.attributes.push(st.o.UVKind+"_"+t)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);let t=this.position,i=this.normal,r=this.tangent,s=this.uv,n=this.positionOutput,a=this.normalOutput,o=this.tangentOutput,l=this.uvOutput,c=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetCount"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",c),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",c,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${e._declareOutput(n)} = ${t.associatedVariableName};
`,e.compilationString+=`#ifdef NORMAL
`,e.compilationString+=`${e._declareOutput(a)} = ${i.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(a)} = vec3(0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef TANGENT
`,e.compilationString+=`${e._declareOutput(o)} = ${r.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(o)} = vec4(0., 0., 0., 0.);
`,e.compilationString+=`#endif
`,e.compilationString+=`#ifdef UV1
`,e.compilationString+=`${e._declareOutput(l)} = ${s.associatedVariableName};
`,e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(l)} = vec2(0., 0.);
`,e.compilationString+=`#endif
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}(0,i3.H7)("BABYLON.MorphTargetsBlock",ux);class uE extends lP{constructor(e){super(e,tj.Vertex),this.registerInput("worldPosition",t$.Vector4,!1,tj.Vertex),this.registerOutput("direction",t$.Vector3),this.registerOutput("color",t$.Color3),this.registerOutput("intensity",t$.Float),this.registerOutput("shadowBias",t$.Float),this.registerOutput("shadowNormalBias",t$.Float),this.registerOutput("shadowDepthScale",t$.Float),this.registerOutput("shadowDepthRange",t$.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let r=this.light,s=t.getScene();if(!r&&s.lights.length&&(r=this.light=s.lights[0],this._forcePrepareDefines=!0),!r||!r.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}r.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,r.diffuse,r.intensity);let n=r.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(n?e.setFloat3(this._lightShadowUniformName,n.bias,n.normalBias,n.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange){if(n&&s.activeCamera){let t=r;e.setFloat2(this._lightShadowExtraUniformName,t.getDepthMinZ(s.activeCamera),t.getDepthMinZ(s.activeCamera)+t.getDepthMaxZ(s.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;let r=this.light;i.setValue(this._lightTypeDefineName,!!r&&r instanceof cR,!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);let t=this.direction,i=this.color,r=this.intensity,s=this.shadowBias,n=this.shadowNormalBias,a=this.shadowDepthScale,o=this.shadowDepthRange;this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE");let l=1===e.shaderLanguage?"uniforms.":"";return e._emitUniformFromString(this._lightDataUniformName,t$.Vector3),e._emitUniformFromString(this._lightColorUniformName,t$.Vector4),e.compilationString+=`#ifdef ${this._lightTypeDefineName}
`,e.compilationString+=e._declareOutput(t)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${l}${this._lightDataUniformName});
`,e.compilationString+=`#else
`,e.compilationString+=e._declareOutput(t)+` = ${l}${this._lightDataUniformName};
`,e.compilationString+=`#endif
`,e.compilationString+=e._declareOutput(i)+` = ${l}${this._lightColorUniformName}.rgb;
`,e.compilationString+=e._declareOutput(r)+` = ${l}${this._lightColorUniformName}.a;
`,(s.hasEndpoints||n.hasEndpoints||a.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,t$.Vector3),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${l}${this._lightShadowUniformName}.x;
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${l}${this._lightShadowUniformName}.y;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}${this._lightShadowUniformName}.z;
`)),o.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,t$.Vector2),e.compilationString+=e._declareOutput(o)+` = ${this._lightShadowUniformName};
`),this}serialize(){let e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}(0,i3.H7)("BABYLON.LightInformationBlock",uE),i(10001),i(30037),i(74910),i(27373),i(87696),i(31343),i(8772),i(54394),i(74436),i(43626),i(76086),i(50731);class uC extends lP{constructor(e){super(e,tj.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",t$.AutoDetect),this.registerOutput("output",t$.Color4),this.registerOutput("rgb",t$.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Color4|t$.Vector3|t$.Vector4)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}get rgb(){return this._outputs[1]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,42766)),Promise.resolve().then(i.bind(i,16693)),Promise.resolve().then(i.bind(i,31103))]):await Promise.all([Promise.resolve().then(i.bind(i,7565)),Promise.resolve().then(i.bind(i,76909)),Promise.resolve().then(i.bind(i,25902))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}isReady(e,t,i){return!i._areImageProcessingDirty||!t.imageProcessingConfiguration||!!t.imageProcessingConfiguration.isReady()}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){i&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");let t=this.color,i=this._outputs[0],r=`//${this.name}`,s=1===e.shaderLanguage?"Vec3":"";return e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),t.connectedPoint?.isConnected&&(t.connectedPoint.type===t$.Color4||t.connectedPoint.type===t$.Vector4?e.compilationString+=`${e._declareOutput(i)} = ${t.associatedVariableName};
`:e.compilationString+=`${e._declareOutput(i)} = vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${s}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`#else
`,e.compilationString+=`#ifdef IMAGEPROCESSING
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName} = vec4${e.fSuffix}(toLinearSpace${s}(${t.associatedVariableName}.rgb), ${t.associatedVariableName}.a);
`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});
`,e.compilationString+=`#endif
`,e.compilationString+=`#endif
`,this.rgb.hasEndpoints&&(e.compilationString+=e._declareOutput(this.rgb)+` = ${this.output.associatedVariableName}.xyz;
`)),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};
`}serialize(){let e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertInputToLinearSpace=e.convertInputToLinearSpace??!0}}(0,r$.gn)([lM("Convert input to linear space",0,"ADVANCED")],uC.prototype,"convertInputToLinearSpace",void 0),(0,i3.H7)("BABYLON.ImageProcessingBlock",uC);class uT extends lP{constructor(e){super(e,tj.Fragment,!0),this.registerInput("normal",t$.AutoDetect,!1),this.normal.addExcludedConnectionPointFromAllowedTypes(t$.Color4|t$.Vector4|t$.Vector3),this.registerInput("tangent",t$.Vector4,!1),this.registerInput("world",t$.Matrix,!1),this.registerOutput("TBN",t$.Object,tj.Fragment,new ug("TBN",this,1,uT,"TBNBlock")),this.registerOutput("row0",t$.Vector3,tj.Fragment),this.registerOutput("row1",t$.Vector3,tj.Fragment),this.registerOutput("row2",t$.Vector3,tj.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return tj.Fragment}set target(e){}autoConfigure(e,t=()=>!0){if(!this.world.isConnected){let i=e.getInputBlockByPredicate(e=>e.isSystemValue&&e.systemValue===tZ.World&&t(e));i||(i=new lL("world")).setAsSystemValue(tZ.World),i.output.connectTo(this.world)}if(!this.normal.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"normal"===e.name&&t(e));i||(i=new lL("normal")).setAsAttribute("normal"),i.output.connectTo(this.normal)}if(!this.tangent.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"tangent"===e.name&&e.type===t$.Vector4&&t(e));i||(i=new lL("tangent")).setAsAttribute("tangent"),i.output.connectTo(this.tangent)}}prepareDefines(e,t,i){let r=this.normal,s=this.tangent,n=r.isConnected;r.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(r.connectInputBlock?.name)&&(n=!1);let a=s.isConnected;s.connectInputBlock?.isAttribute&&!e.isVerticesDataPresent(s.connectInputBlock?.name)&&(a=!1);let o=n&&a;i.setValue("TBNBLOCK",o,!0)}_buildBlock(e){super._buildBlock(e);let t=this.normal,i=this.tangent,r=this.world,s=this.TBN,n=this.row0,a=this.row1,o=this.row2,l=1===e.shaderLanguage,c=l?"mat3x3f":"mat3",u=l?"f":"";return e.target===tj.Fragment&&(e.compilationString+=`
                // ${this.name}
                ${e._declareLocalVar("tbnNormal",t$.Vector3)} = normalize(${t.associatedVariableName}).xyz;
                ${e._declareLocalVar("tbnTangent",t$.Vector3)} = normalize(${i.associatedVariableName}.xyz);
                ${e._declareLocalVar("tbnBitangent",t$.Vector3)} = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;
                ${l?"var":"mat3"} ${s.associatedVariableName} = ${c}(${r.associatedVariableName}[0].xyz, ${r.associatedVariableName}[1].xyz, ${r.associatedVariableName}[2].xyz) * ${c}(tbnTangent, tbnBitangent, tbnNormal);
            `,n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = vec3${u}(${s.associatedVariableName}[0][0], ${s.associatedVariableName}[0][1], ${s.associatedVariableName}[0][2]);
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = vec3${u}(${s.associatedVariableName}[1[0], ${s.associatedVariableName}[1][1], ${s.associatedVariableName}[1][2]);
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = vec3${u}(${s.associatedVariableName}[2][0], ${s.associatedVariableName}[2][1], ${s.associatedVariableName}[2][2]);
`),e.sharedData.blocksWithDefines.push(this)),this}}(0,i3.H7)("BABYLON.TBNBlock",uT);class ub extends lP{constructor(e){super(e,tj.Fragment),this._tangentSpaceParameterName="",this._tangentCorrectionFactorName="",this._worldMatrixName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this.useObjectSpaceNormalMap=!1,this._isUnique=!0,this.registerInput("worldPosition",t$.Vector4,!1),this.registerInput("worldNormal",t$.Vector4,!1),this.registerInput("worldTangent",t$.Vector4,!0),this.registerInput("uv",t$.Vector2,!1),this.registerInput("normalMapColor",t$.Color3,!1),this.registerInput("strength",t$.Float,!1),this.registerInput("viewDirection",t$.Vector3,!0),this.registerInput("parallaxScale",t$.Float,!0),this.registerInput("parallaxHeight",t$.Float,!0),this.registerInput("TBN",t$.Object,!0,tj.VertexAndFragment,new ug("TBN",this,0,uT,"TBNBlock")),this.registerInput("world",t$.Matrix,!0),this.registerOutput("output",t$.Vector4),this.registerOutput("uvOffset",t$.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get world(){return this._inputs[10]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,24140)),Promise.resolve().then(i.bind(i,40373)),Promise.resolve().then(i.bind(i,6877))]):await Promise.all([Promise.resolve().then(i.bind(i,5413)),Promise.resolve().then(i.bind(i,32465)),Promise.resolve().then(i.bind(i,91023))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}prepareDefines(e,t,i){let r=this.normalMapColor.connectedPoint._ownerBlock.samplerName,s=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&r||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",s,!0),i.setValue("PARALLAX_RHS",t.getScene().useRightHandedSystem,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0),i.setValue("OBJECTSPACE_NORMALMAP",this.useObjectSpaceNormalMap,!0)}bind(e,t,i){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1),i&&(e.setFloat(this._tangentCorrectionFactorName,0>i.getWorldMatrix().determinant()?-1:1),this.useObjectSpaceNormalMap&&!this.world.isConnected&&e.setMatrix(this._worldMatrixName,i.getWorldMatrix()))}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"uv"===e.name&&t(e));i||(i=new lL("uv")).setAsAttribute(),i.output.connectTo(this.uv)}if(!this.strength.isConnected){let e=new lL("strength");e.value=1,e.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`,i=this.uv,r=this.worldPosition,s=this.worldNormal,n=this.worldTangent,a=1===e.shaderLanguage,o=a?"mat3x3f":"mat3",l=a?"f":"",c=a?"uniforms.":"";e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,t$.Vector2),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,t$.Float),this._worldMatrixName=e._getFreeDefineName("perturbNormalWorldMatrix"),e._emitUniformFromString(this._worldMatrixName,t$.Matrix);let u=null;this.normalMapColor.connectedPoint&&(u=this.normalMapColor.connectedPoint._ownerBlock.samplerName);let h=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&u||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),d=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",f=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${e._emitFloat(this.strength.connectInputBlock.value)}`:`
#if !defined(NORMALXYSCALE)
1.0/
#endif
${this.strength.associatedVariableName}`;a||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let p={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},m=this.TBN;m.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            ${a?"var":"mat3"} vTBN = ${m.associatedVariableName};
            #endif
            `:n.isConnected&&(e.compilationString+=`${e._declareLocalVar("tbnNormal",t$.Vector3)} = normalize(${s.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnTangent",t$.Vector3)} = normalize(${n.associatedVariableName}.xyz);
`,e.compilationString+=`${e._declareLocalVar("tbnBitangent",t$.Vector3)} = cross(tbnNormal, tbnTangent) * ${a?"uniforms.":""}${this._tangentCorrectionFactorName};
`,e.compilationString+=`${a?"var":"mat3"} vTBN = ${o}(tbnTangent, tbnBitangent, tbnNormal);
`);let _=[p,{search:/varying mat3 vTBN;/g,replace:""},{search:/uniform mat4 normalMatrix;/g,replace:""}];a&&(_.push({search:/varying vTBN0: vec3f;/g,replace:""}),_.push({search:/varying vTBN1: vec3f;/g,replace:""}),_.push({search:/varying vTBN2: vec3f;/g,replace:""})),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:_}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:a?/fn parallaxOcclusion\(vViewDirCoT: vec3f,vNormalCoT: vec3f,texCoord: vec2f,parallaxScale: f32\)/g:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:a?"fn parallaxOcclusion(vViewDirCoT: vec3f, vNormalCoT: vec3f, texCoord: vec2f, parallaxScale:f32, bump: texture_2d<f32>, bumpSampler: sampler)":"#define inline\nvec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)"},{search:a?/fn parallaxOffset\(viewDir: vec3f,heightScale: f32\)/g:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:a?"fn parallaxOffset(viewDir: vec3f, heightScale: f32, height_: f32)":"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture.+?bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});let g=a?`textureSample(${u}, ${u+"Sampler"}`:`texture2D(${u}`,v=h&&u?`${g}, ${i.associatedVariableName} + uvOffset).xyz`:this.normalMapColor.associatedVariableName,S=e._getFreeVariableName("tempOutput");return e.compilationString+=e._declareLocalVar(S,t$.Vector3)+` = vec3${l}(0.);
`,_=[{search:RegExp(`texture.+?bumpSampler${a?"Sampler,fragmentInputs.":","}vBumpUV\\)`,"g"),replace:`${v}`},{search:/#define CUSTOM_FRAGMENT_BUMP_FRAGMENT/g,replace:`${e._declareLocalVar("normalMatrix",t$.Matrix)} = toNormalMatrix(${this.world.isConnected?this.world.associatedVariableName:this._worldMatrixName});`},{search:RegExp(`perturbNormal\\(TBN,texture.+?bumpSampler${a?"Sampler,fragmentInputs.":","}vBumpUV\\+uvOffset\\).xyz,${a?"uniforms.":""}vBumpInfos.y\\)`,"g"),replace:`perturbNormal(TBN, ${v}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${a?h&&this.useParallaxOcclusion?`${u}, ${u+"Sampler"}`:"bump, bumpSampler":h&&this.useParallaxOcclusion?u:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${h?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vBumpInfos.y/g,replace:f},{search:/vBumpInfos.z/g,replace:d},{search:/normalW=/g,replace:S+" = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:`${o}(normalMatrix) * `+S},{search:/normalW/g,replace:s.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:h?this.viewDirection.associatedVariableName:`vec3${l}(0.)`},p],a?(_.push({search:/fragmentInputs.vBumpUV/g,replace:i.associatedVariableName}),_.push({search:/input.vPositionW/g,replace:r.associatedVariableName+".xyz"}),_.push({search:/uniforms.vTangentSpaceParams/g,replace:c+this._tangentSpaceParameterName}),_.push({search:/var TBN: mat3x3f=mat3x3<f32>\(input.vTBN0,input.vTBN1,input.vTBN2\);/g,replace:"var TBN = vTBN;"})):(_.push({search:/vBumpUV/g,replace:i.associatedVariableName}),_.push({search:/vPositionW/g,replace:r.associatedVariableName+".xyz"}),_.push({search:/vTangentSpaceParams/g,replace:c+this._tangentSpaceParameterName})),e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:_}),e.compilationString+=e._declareOutput(this.output)+` = vec4${l}(${S}, 0.);
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};
`+`${this._codeVariableName}.invertY = ${this.invertY};
${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};
${this._codeVariableName}.useObjectSpaceNormalMap = ${this.useObjectSpaceNormalMap};
`}serialize(){let e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e.useObjectSpaceNormalMap=this.useObjectSpaceNormalMap,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion,this.useObjectSpaceNormalMap=!!e.useObjectSpaceNormalMap}}(0,r$.gn)([lM("Invert X axis",0,"PROPERTIES",{notifiers:{update:!1}})],ub.prototype,"invertX",void 0),(0,r$.gn)([lM("Invert Y axis",0,"PROPERTIES",{notifiers:{update:!1}})],ub.prototype,"invertY",void 0),(0,r$.gn)([lM("Use parallax occlusion",0)],ub.prototype,"useParallaxOcclusion",void 0),(0,r$.gn)([lM("Object Space Mode",0,"PROPERTIES",{notifiers:{update:!1}})],ub.prototype,"useObjectSpaceNormalMap",void 0),(0,i3.H7)("BABYLON.PerturbNormalBlock",ub);class uy extends lP{constructor(e){super(e,tj.Fragment,!0),this.registerInput("value",t$.Float,!0),this.registerInput("cutoff",t$.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,this.cutoff.isConnected&&this.value.isConnected)return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) { discard; }
`,this}}(0,i3.H7)("BABYLON.DiscardBlock",uy);class uI extends lP{constructor(e){super(e,tj.Fragment),this.registerOutput("output",t$.Float,tj.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===tj.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary("1.0","0.0",0===e.shaderLanguage?"gl_FrontFacing":"fragmentInputs.frontFacing")};
`,this}}(0,i3.H7)("BABYLON.FrontFacingBlock",uI);class uP extends lP{constructor(e){super(e,tj.Fragment),this.registerInput("input",t$.AutoDetect,!1),this.registerOutput("dx",t$.BasedOnInput),this.registerOutput("dy",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._outputs[1];e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let r="dFdx",s="dFdy";return 1===e.shaderLanguage&&(r="dpdx",s="dpdy"),t.hasEndpoints&&(e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`),i.hasEndpoints&&(e.compilationString+=e._declareOutput(i)+` = ${s}(${this.input.associatedVariableName});
`),this}}(0,i3.H7)("BABYLON.DerivativeBlock",uP);class uR extends lP{constructor(e){super(e,tj.Fragment),this.registerOutput("xy",t$.Vector2,tj.Fragment),this.registerOutput("xyz",t$.Vector3,tj.Fragment),this.registerOutput("xyzw",t$.Vector4,tj.Fragment),this.registerOutput("x",t$.Float,tj.Fragment),this.registerOutput("y",t$.Float,tj.Fragment),this.registerOutput("z",t$.Float,tj.Fragment),this.registerOutput("w",t$.Float,tj.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="",i=1===e.shaderLanguage?"fragmentInputs.position":"gl_FragCoord";for(let r of this._outputs)r.hasEndpoints&&(t+=`${e._declareOutput(r)} = ${i}.${r.name};
`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===tj.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}(0,i3.H7)("BABYLON.FragCoordBlock",uR);class uA extends lP{constructor(e){super(e,tj.Fragment),this.registerOutput("xy",t$.Vector2,tj.Fragment),this.registerOutput("x",t$.Float,tj.Fragment),this.registerOutput("y",t$.Float,tj.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){let t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(let r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===tj.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,t$.Vector2);let t=1===e.shaderLanguage?"uniforms.":"";return e.compilationString+=this.writeOutputs(e,t+this._varName),this}}(0,i3.H7)("BABYLON.ScreenSizeBlock",uA);class uM extends lP{constructor(e){super(e,tj.Fragment),this.registerInput("vector",t$.AutoDetect),this.registerInput("worldViewProjection",t$.Matrix),this.registerOutput("output",t$.Vector2),this.registerOutput("x",t$.Float),this.registerOutput("y",t$.Float),this.inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e,t=()=>!0){if(!this.worldViewProjection.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.WorldViewProjection&&t(e));i||(i=new lL("worldViewProjection")).setAsSystemValue(tZ.WorldViewProjection),i.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);let t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;let r=i.associatedVariableName,s=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case t$.Vector3:e.compilationString+=`${e._declareLocalVar(s,t$.Vector4)} = ${r} * vec4${e.fSuffix}(${t.associatedVariableName}, 1.0);
`;break;case t$.Vector4:e.compilationString+=`${e._declareLocalVar(s,t$.Vector4)} = ${r} * ${t.associatedVariableName};
`}return e.compilationString+=`${s} = vec4${e.fSuffix}(${s}.xy / ${s}.w, ${s}.zw);`,e.compilationString+=`${s} = vec4${e.fSuffix}(${s}.xy * 0.5 + vec2${e.fSuffix}(0.5, 0.5), ${s}.zw);`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${s}.xy;
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${s}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${s}.y;
`),this}}(0,i3.H7)("BABYLON.ScreenSpaceBlock",uM);class uN extends lP{constructor(e){super(e,tj.Fragment),this.registerInput("input",t$.Vector2),this.registerInput("strength",t$.Float),this.registerInput("center",t$.Vector2),this.registerInput("offset",t$.Vector2),this.registerOutput("output",t$.Vector2),this.registerOutput("x",t$.Float),this.registerOutput("y",t$.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){let e=new lL("center");e.value=new i1.FM(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){let e=new lL("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){let e=new lL("offset");e.value=new i1.FM(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);let t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),r=e._getFreeVariableName("x"),s=e._getFreeVariableName("y"),n=e._getFreeVariableName("result");return e.compilationString+=`        
            ${e._declareLocalVar(t,t$.Vector2)} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};
            ${e._declareLocalVar(i,t$.Float)} = ${this.strength.associatedVariableName} * length(${t});
            ${e._declareLocalVar(r,t$.Float)} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;
            ${e._declareLocalVar(s,t$.Float)} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;
            ${e._declareLocalVar(n,t$.Vector2)} = vec2(${r} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${s} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);
        `,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${n};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${n}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${n}.y;
`),this}}(0,i3.H7)("BABYLON.TwirlBlock",uN);class uO extends lP{constructor(e){super(e,tj.Fragment),this.generateInWorldSpace=!1,this.automaticNormalizationNormal=!0,this.automaticNormalizationTangent=!0,this.registerInput("input",t$.Float),this.registerInput("worldPosition",t$.Vector3),this.registerInput("worldNormal",t$.Vector3),this.registerInput("worldTangent",t$.AutoDetect,!0),this.registerOutput("output",t$.Vector4),this.registerOutput("xyz",t$.Vector3),this._inputs[3].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=1===e.shaderLanguage,r=e.fSuffix;this.generateInWorldSpace||this.worldTangent.isConnected||re.Y.Error(`You must connect the 'worldTangent' input of the ${this.name} block!`);let s=this.generateInWorldSpace?"":`
            vec3 biTangent = cross(norm, tgt);
            mat3 TBN = mat3(tgt, biTangent, norm);
            `,n=this.generateInWorldSpace?"":`
            result = TBN * result;
            result = result * vec3(0.5) + vec3(0.5);
            `,a=`
            vec4 heightToNormal(float height, vec3 position, vec3 tangent, vec3 normal) {
                vec3 tgt = ${this.automaticNormalizationTangent?"normalize(tangent);":"tangent;"}
                vec3 norm = ${this.automaticNormalizationNormal?"normalize(normal);":"normal;"}
                ${s}
                vec3 worlddX = dFdx(position);
                vec3 worlddY = dFdy(position);
                vec3 crossX = cross(norm, worlddX);
                vec3 crossY = cross(worlddY, norm);
                float d = abs(dot(crossY, worlddX));
                vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));
                inToNormal.y *= -1.0;
                vec3 result = normalize((d * norm) - inToNormal);
                ${n}
                return vec4(result, 0.);
            }`;return i?a=e._babylonSLtoWGSL(a):e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",a,"// heightToNormal"),e.compilationString+=e._declareOutput(t)+` = heightToNormal(${this.input.associatedVariableName}, ${this.worldPosition.associatedVariableName}, ${this.worldTangent.isConnected?this.worldTangent.associatedVariableName:`vec3${r}(0.)`}.xyz, ${this.worldNormal.associatedVariableName});
`,this.xyz.hasEndpoints&&(e.compilationString+=e._declareOutput(this.xyz)+` = ${this.output.associatedVariableName}.xyz;
`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.generateInWorldSpace = ${this.generateInWorldSpace};
${this._codeVariableName}.automaticNormalizationNormal = ${this.automaticNormalizationNormal};
${this._codeVariableName}.automaticNormalizationTangent = ${this.automaticNormalizationTangent};
`}serialize(){let e=super.serialize();return e.generateInWorldSpace=this.generateInWorldSpace,e.automaticNormalizationNormal=this.automaticNormalizationNormal,e.automaticNormalizationTangent=this.automaticNormalizationTangent,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.generateInWorldSpace=e.generateInWorldSpace,this.automaticNormalizationNormal=e.automaticNormalizationNormal,this.automaticNormalizationTangent=e.automaticNormalizationTangent}}(0,r$.gn)([lM("Generate in world space instead of tangent space",0,"PROPERTIES",{notifiers:{update:!0}})],uO.prototype,"generateInWorldSpace",void 0),(0,r$.gn)([lM("Force normalization for the worldNormal input",0,"PROPERTIES",{notifiers:{update:!0}})],uO.prototype,"automaticNormalizationNormal",void 0),(0,r$.gn)([lM("Force normalization for the worldTangent input",0,"PROPERTIES",{notifiers:{update:!0}})],uO.prototype,"automaticNormalizationTangent",void 0),(0,i3.H7)("BABYLON.HeightToNormalBlock",uO);class uD extends lP{constructor(e){super(e,tj.Fragment,!0),this.registerInput("depth",t$.Float,!0),this.registerInput("worldPos",t$.Vector4,!0),this.registerInput("viewProjection",t$.Matrix,!0)}getClassName(){return"FragDepthBlock"}get depth(){return this._inputs[0]}get worldPos(){return this._inputs[1]}get viewProjection(){return this._inputs[2]}_buildBlock(e){super._buildBlock(e);let t=0===e.shaderLanguage?"gl_FragDepth":"fragmentOutputs.fragDepth";return this.depth.isConnected?e.compilationString+=`${t} = ${this.depth.associatedVariableName};
`:this.worldPos.isConnected&&this.viewProjection.isConnected?e.compilationString+=`
                ${e._declareLocalVar("p",t$.Vector4)} = ${this.viewProjection.associatedVariableName} * ${this.worldPos.associatedVariableName};
                ${e._declareLocalVar("v",t$.Float)} = p.z / p.w;
                #ifndef IS_NDC_HALF_ZRANGE
                    v = v * 0.5 + 0.5;
                #endif
                ${t} = v;
    
            `:re.Y.Warn("FragDepthBlock: either the depth input or both the worldPos and viewProjection inputs must be connected!"),this}}(0,i3.H7)("BABYLON.FragDepthBlock",uD);class uF extends lP{constructor(e){super(e,tj.Fragment),this.registerInput("worldPosition",t$.Vector4,!1),this.registerInput("viewProjection",t$.Matrix,!1),this.registerInput("worldNormal",t$.AutoDetect,!0),this.registerOutput("depth",t$.Vector3),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Vector4)}getClassName(){return"ShadowMapBlock"}initialize(e){e._excludeVariableName("vPositionWSM"),e._excludeVariableName("lightDataSM"),e._excludeVariableName("biasAndScaleSM"),e._excludeVariableName("depthValuesSM"),e._excludeVariableName("clipPos"),e._excludeVariableName("worldPos"),e._excludeVariableName("zSM"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,58530)),Promise.resolve().then(i.bind(i,758)),Promise.resolve().then(i.bind(i,3342))]):await Promise.all([Promise.resolve().then(i.bind(i,10224)),Promise.resolve().then(i.bind(i,43870)),Promise.resolve().then(i.bind(i,69303))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get viewProjection(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get depth(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`,i=1===e.shaderLanguage;e._emitUniformFromString("biasAndScaleSM",t$.Vector3),e._emitUniformFromString("lightDataSM",t$.Vector3),e._emitUniformFromString("depthValuesSM",t$.Vector2),e._emitFunctionFromInclude("packingFunctions",t),e.compilationString+=`${e._declareLocalVar("worldPos",t$.Vector4)} = ${this.worldPosition.associatedVariableName};
`,e.compilationString+=`${e._declareLocalVar("vPositionWSM",t$.Vector3)};
`,e.compilationString+=`${e._declareLocalVar("vDepthMetricSM",t$.Float)} = 0.0;
`,e.compilationString+=`${e._declareLocalVar("zSM",t$.Float)};
`,this.worldNormal.isConnected&&(e.compilationString+=`${e._declareLocalVar("vNormalW",t$.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexNormalBias",t)),e.compilationString+=`${e._declareLocalVar("clipPos",t$.Vector4)} = ${this.viewProjection.associatedVariableName} * worldPos;
`,e.compilationString+=e._emitCodeFromInclude("shadowMapVertexMetric",t,{replaceStrings:[{search:/gl_Position/g,replace:"clipPos"},{search:/vertexOutputs.position/g,replace:"clipPos"}]}),e.compilationString+=e._emitCodeFromInclude("shadowMapFragment",t,{replaceStrings:[{search:/return;/g,replace:""}]});let r=i?"fragmentOutputs.fragDepth":"gl_FragDepth";return e.compilationString+=`
            #if SM_DEPTHTEXTURE == 1
                #ifdef IS_NDC_HALF_ZRANGE
                    ${r} = (clipPos.z / clipPos.w);
                #else
                    ${r} = (clipPos.z / clipPos.w) * 0.5 + 0.5;
                #endif
            #endif
        `,e.compilationString+=`${e._declareOutput(this.depth)} = vec3${e.fSuffix}(depthSM, 1., 1.);
`,this}}(0,i3.H7)("BABYLON.ShadowMapBlock",uF);class uL extends lP{constructor(e){super(e,tj.Fragment,!0),this.registerInput("viewDepth",t$.Float,!0),this.registerInput("screenDepth",t$.Float,!0),this.registerInput("worldPosition",t$.AutoDetect,!0),this.registerInput("localPosition",t$.AutoDetect,!0),this.registerInput("viewNormal",t$.AutoDetect,!0),this.registerInput("worldNormal",t$.AutoDetect,!0),this.registerInput("reflectivity",t$.AutoDetect,!0),this.inputs[2].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4),this.inputs[3].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4),this.inputs[4].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4),this.inputs[5].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4),this.inputs[6].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4|t$.Color3|t$.Color4)}getClassName(){return"PrePassOutputBlock"}get viewDepth(){return this._inputs[0]}get screenDepth(){return this._inputs[1]}get worldPosition(){return this._inputs[2]}get localPosition(){return this._inputs[3]}get viewNormal(){return this._inputs[4]}get worldNormal(){return this._inputs[5]}get reflectivity(){return this._inputs[6]}_getFragData(e,t){return e?`fragmentOutputs.fragData${t}`:`gl_FragData[${t}]`}_buildBlock(e){super._buildBlock(e);let t=this.worldPosition,i=this.localPosition,r=this.viewNormal,s=this.worldNormal,n=this.viewDepth,a=this.reflectivity,o=this.screenDepth;e.sharedData.blocksWithDefines.push(this);let l=`//${this.name}`,c=e._getShaderType(t$.Vector4),u=1===e.shaderLanguage;return e._emitFunctionFromInclude("helperFunctions",l),e.compilationString+=`#if defined(PREPASS)\r
`,e.compilationString+=u?`var fragData: array<vec4<f32>, SCENE_MRT_COUNT>;\r
`:`vec4 fragData[SCENE_MRT_COUNT];\r
`,e.compilationString+=`#ifdef PREPASS_DEPTH\r
`,n.connectedPoint?e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${c}(${n.associatedVariableName}, 0.0, 0.0, 1.0);\r
`:e.compilationString+=` fragData[PREPASS_DEPTH_INDEX] = ${c}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_SCREENSPACE_DEPTH\r
`,o.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(${o.associatedVariableName}, 0.0, 0.0, 1.0);\r
`:e.compilationString+=` gl_FragData[PREPASS_SCREENSPACE_DEPTH_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_POSITION\r
`,t.connectedPoint?e.compilationString+=`fragData[PREPASS_POSITION_INDEX] = ${c}(${t.associatedVariableName}.rgb, ${t.connectedPoint.type===t$.Vector4?t.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_POSITION_INDEX] = ${c}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_LOCAL_POSITION\r
`,i.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(${i.associatedVariableName}.rgb, ${i.connectedPoint.type===t$.Vector4?i.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_LOCAL_POSITION_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_NORMAL\r
`,r.connectedPoint?e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${c}(${r.associatedVariableName}.rgb, ${r.connectedPoint.type===t$.Vector4?r.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_NORMAL_INDEX] = ${c}(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_WORLD_NORMAL\r
`,s.connectedPoint?e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(${s.associatedVariableName}.rgb, ${s.connectedPoint.type===t$.Vector4?s.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` gl_FragData[PREPASS_WORLD_NORMAL_INDEX] = vec4(0.0, 0.0, 0.0, 0.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef PREPASS_REFLECTIVITY\r
`,a.connectedPoint?e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${c}(${a.associatedVariableName}.rgb, ${a.connectedPoint.type===t$.Vector4?a.associatedVariableName+".a":"1.0"});\r
`:e.compilationString+=` fragData[PREPASS_REFLECTIVITY_INDEX] = ${c}(0.0, 0.0, 0.0, 1.0);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 1\r
`,e.compilationString+=`${this._getFragData(u,1)} = fragData[1];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 2\r
`,e.compilationString+=`${this._getFragData(u,2)} = fragData[2];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 3\r
`,e.compilationString+=`${this._getFragData(u,3)} = fragData[3];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 4\r
`,e.compilationString+=`${this._getFragData(u,4)} = fragData[4];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 5\r
`,e.compilationString+=`${this._getFragData(u,5)} = fragData[5];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 6\r
`,e.compilationString+=`${this._getFragData(u,6)} = fragData[6];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#if SCENE_MRT_COUNT > 7\r
`,e.compilationString+=`${this._getFragData(u,7)} = fragData[7];\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this}}(0,i3.H7)("BABYLON.PrePassOutputBlock",uL),i(16693),i(31103),i(7565),i(76909),i(25902),i(24140),i(40373),i(6877),i(5413),i(32465),i(91023),i(58530),i(758),i(3342),i(10224),i(43870),i(69303);class uw extends lP{constructor(e){super(e,tj.VertexAndFragment,!1),this.registerInput("worldPosition",t$.Vector4,!1,tj.Vertex),this.registerInput("view",t$.Matrix,!1,tj.Vertex),this.registerInput("input",t$.AutoDetect,!1,tj.Fragment),this.registerInput("fogColor",t$.AutoDetect,!1,tj.Fragment),this.registerOutput("output",t$.Color3,tj.Fragment),this.input.addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Color4),this.fogColor.addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(i.bind(i,1741)):await Promise.resolve().then(i.bind(i,88004)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.view.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.View&&t(e));i||(i=new lL("view")).setAsSystemValue(tZ.View),i.output.connectTo(this.view)}if(!this.fogColor.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.FogColor&&t(e));i||(i=new lL("fogColor",void 0,t$.Color3)).setAsSystemValue(tZ.FogColor),i.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){let r=e.getScene();i.setValue("FOG",t.fogEnabled&&(0,le.l6)(e,r))}bind(e,t,i){if(!i)return;let r=i.getScene();e.setFloat4(this._fogParameters,r.fogMode,r.fogStart,r.fogEnd,r.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===tj.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=[],i="",r="";1===e.shaderLanguage?(t=[{search:/fn CalcFogFactor\(\)/,replace:"fn CalcFogFactor(vFogDistance: vec3f, vFogInfos: vec4f)"},{search:/uniforms.vFogInfos/g,replace:"vFogInfos"},{search:/fragmentInputs.vFogDistance/g,replace:"vFogDistance"}],i="fragmentInputs.",r="uniforms."):t=[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}],e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:t});let s=e._getFreeVariableName("fog"),n=this.input,a=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");let o=this._outputs[0];e._emitUniformFromString(this._fogParameters,t$.Vector4),e.compilationString+=`#ifdef FOG
`,e.compilationString+=`${e._declareLocalVar(s,t$.Float)} = CalcFogFactor(${i}${this._fogDistanceName}, ${r}${this._fogParameters});
`,e.compilationString+=e._declareOutput(o)+` = ${s} * ${n.associatedVariableName}.rgb + (1.0 - ${s}) * ${a.associatedVariableName}.rgb;
`,e.compilationString+=`#else
${e._declareOutput(o)} =  ${n.associatedVariableName}.rgb;
`,e.compilationString+=`#endif
`}else{let t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,t$.Vector3);let r=1===e.shaderLanguage?"vertexOutputs.":"";e.compilationString+=`${r}${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;
`}return this}}(0,i3.H7)("BABYLON.FogBlock",uw);class uB extends lP{static _OnGenerateOnlyFragmentCodeChanged(e,t){return e.worldPosition.isConnected?(e.generateOnlyFragmentCode=!e.generateOnlyFragmentCode,re.Y.Error("The worldPosition input must not be connected to be able to switch!"),!1):(e._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?tj.Fragment:tj.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?tj.Fragment:tj.Vertex}constructor(e){super(e,tj.VertexAndFragment),this._lightId=0,this.generateOnlyFragmentCode=!1,this._isUnique=!0,this.registerInput("worldPosition",t$.Vector4,!1,tj.Vertex),this.registerInput("worldNormal",t$.Vector4,!1,tj.Fragment),this.registerInput("cameraPosition",t$.Vector3,!1,tj.Fragment),this.registerInput("glossiness",t$.Float,!0,tj.Fragment),this.registerInput("glossPower",t$.Float,!0,tj.Fragment),this.registerInput("diffuseColor",t$.Color3,!0,tj.Fragment),this.registerInput("specularColor",t$.Color3,!0,tj.Fragment),this.registerInput("view",t$.Matrix,!0),this.registerOutput("diffuseOutput",t$.Color3,tj.Fragment),this.registerOutput("specularOutput",t$.Color3,tj.Fragment),this.registerOutput("shadow",t$.Float,tj.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,39192)),Promise.resolve().then(i.bind(i,42751)),Promise.resolve().then(i.bind(i,18777)),Promise.resolve().then(i.bind(i,42766)),Promise.resolve().then(i.bind(i,14696)),Promise.resolve().then(i.bind(i,89716)),Promise.resolve().then(i.bind(i,14413))]):await Promise.all([Promise.resolve().then(i.bind(i,72069)),Promise.resolve().then(i.bind(i,97853)),Promise.resolve().then(i.bind(i,6937)),Promise.resolve().then(i.bind(i,97533)),Promise.resolve().then(i.bind(i,87672)),Promise.resolve().then(i.bind(i,7565)),Promise.resolve().then(i.bind(i,63164)),Promise.resolve().then(i.bind(i,86507)),Promise.resolve().then(i.bind(i,77272))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.CameraPosition&&t(e));i||(i=new lL("cameraPosition")).setAsSystemValue(tZ.CameraPosition),i.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;let r=e.getScene();if(this.light){let t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,le.wg)(r,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,le.UX)(r,e,i,!0,t.maxSimultaneousLights)}updateUniformsAndSamples(e,t,i,r){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){let t=e.uniforms.indexOf("vLightData"+s)>=0;(0,le.YM)(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,t)}}bind(e,t,i){if(!i)return;let r=i.getScene();this.light?(0,le.aM)(this.light,this._lightId,r,e,!0):(0,le.VX)(r,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){let t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));let r="v_"+t.associatedVariableName;e._emitVaryingFromString(r,t$.Vector4)&&(e.compilationString+=(1===e.shaderLanguage?"vertexOutputs.":"")+`${r} = ${t.associatedVariableName};
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",t$.Vector4)} = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",t$.Matrix)} = ${this.view.associatedVariableName};
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_injectUBODeclaration(e){let t=`//${this.name}`;this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0})}_buildBlock(e){super._buildBlock(e);let t=1===e.shaderLanguage,i=t?"f":"",r=`//${this.name}`;if(e.target!==tj.Fragment){this._injectVertexCode(e);return}this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);let s=this.worldPosition,n=s.associatedVariableName;this.generateOnlyFragmentCode?(n=e._getFreeVariableName("globalWorldPos"),e._emitFunction("light_globalworldpos",`${e._declareLocalVar(n,t$.Vector3)};
`,r),e.compilationString+=`${n} = ${s.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${s.associatedVariableName}`:void 0})):n=(t?"fragmentInputs.":"")+"v_"+n+".xyz",e._emitFunctionFromInclude("helperFunctions",r);let a={search:/vPositionW/g,replace:n};if(t&&(a={search:/fragmentInputs\.vPositionW/g,replace:n}),e._emitFunctionFromInclude("lightsFragmentFunctions",r,{replaceStrings:[a]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",r,{replaceStrings:[a]}),this._injectUBODeclaration(e),0===this._lightId&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",t$.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${n});
`),e.compilationString+=t?`var info: lightingInfo;
`:`lightingInfo info;
`,e.compilationString+=`${e._declareLocalVar("shadow",t$.Float)} = 1.;
`,e.compilationString+=`${e._declareLocalVar("aggShadow",t$.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("numLights",t$.Float)} = 0.;
`,e.compilationString+=`${e._declareLocalVar("glossiness",t$.Float)} = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};
`,e.compilationString+=`${e._declareLocalVar("diffuseBase",t$.Vector3)} = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("specularBase",t$.Vector3)}  = vec3${i}(0., 0., 0.);
`,e.compilationString+=`${e._declareLocalVar("normalW",t$.Vector3)} = ${this.worldNormal.associatedVariableName}.xyz;
`),this.light){let i={search:/vPositionW/g,replace:n+".xyz"};t&&(i={search:/fragmentInputs\.vPositionW/g,replace:n+".xyz"}),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},i]})}else{let i=`vPositionW,${n}.xyz`;t&&(i=`fragmentInputs.vPositionW,${n}.xyz`),e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:i})}0===this._lightId&&(e.compilationString+=`aggShadow = aggShadow / numLights;
`);let o=this.diffuseOutput,l=this.specularOutput;return e.compilationString+=e._declareOutput(o)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};
`,l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};
`),this.shadow.hasEndpoints&&(e.compilationString+=e._declareOutput(this.shadow)+` = aggShadow;
`),this}serialize(){let e=super.serialize();return e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,r$.gn)([lM("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:uB._OnGenerateOnlyFragmentCodeChanged}})],uB.prototype,"generateOnlyFragmentCode",void 0),(0,i3.H7)("BABYLON.LightBlock",uB);class uV extends lP{get texture(){return this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??rh.l.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,t=>t.hasTexture(e))}get samplerName(){return this._samplerName}constructor(e){super(e,tj.VertexAndFragment),this.registerOutput("source",t$.Object,tj.VertexAndFragment,new ug("source",this,1,uV,"ImageSourceBlock")),this.registerOutput("dimensions",t$.Vector2)}bind(e){this.texture&&e.setTexture(this._samplerName,this.texture)}isReady(){return!this.texture||!!this.texture.isReadyOrNotBlocking()}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}get dimensions(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),e.target===tj.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),this.dimensions.isConnected){let t="";t=1===e.shaderLanguage?`vec2f(textureDimensions(${this._samplerName}, 0).xy)`:`vec2(textureSize(${this._samplerName}, 0).xy)`,e.compilationString+=`${e._declareOutput(this.dimensions)} = ${t};
`}return e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture?e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`:e}serialize(){let e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&"VideoTexture"!==this.texture.getClassName()&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i,r),e.texture&&!lZ.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=rZ.x.Parse(e.texture,t,i))}}(0,i3.H7)("BABYLON.ImageSourceBlock",uV);class uU extends lP{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??rh.l.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,t=>t.hasTexture(e))}static _IsPrePassTextureBlock(e){return e?.getClassName()==="PrePassTextureBlock"}get _isSourcePrePass(){return uU._IsPrePassTextureBlock(this._imageSource)}get samplerName(){if(this._imageSource){if(!uU._IsPrePassTextureBlock(this._imageSource))return this._imageSource.samplerName;if(this.source.connectedPoint)return this._imageSource.getSamplerName(this.source.connectedPoint)}return this._samplerName}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){let e=this.texture.getScene()??rh.l.LastCreatedScene;e?.markAllMaterialsAsDirty(1,e=>e.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){let e=this.texture.getScene()??rh.l.LastCreatedScene;e?.markAllMaterialsAsDirty(1,e=>e.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,t?tj.Fragment:tj.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",t$.AutoDetect,!1,tj.VertexAndFragment),this.registerInput("source",t$.Object,!0,tj.VertexAndFragment,new ug("source",this,0,uV,"ImageSourceBlock")),this.registerInput("layer",t$.Float,!0),this.registerInput("lod",t$.Float,!0),this.registerOutput("rgba",t$.Color4,tj.Neutral),this.registerOutput("rgb",t$.Color3,tj.Neutral),this.registerOutput("r",t$.Float,tj.Neutral),this.registerOutput("g",t$.Float,tj.Neutral),this.registerOutput("b",t$.Float,tj.Neutral),this.registerOutput("a",t$.Float,tj.Neutral),this.registerOutput("level",t$.Float,tj.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Vector2|t$.Vector3|t$.Vector4),this._inputs[0]._prioritizeVertex=!t}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get layer(){return this._inputs[2]}get lod(){return this._inputs[3]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}_isTiedToFragment(e){if(e.target===tj.Fragment)return!0;if(e.target===tj.Vertex)return!1;if(e.target===tj.Neutral||e.target===tj.VertexAndFragment){let t=e.ownerBlock;if(t.target===tj.Fragment)return!0;for(let e of t.inputs)if(e.isConnected&&this._isTiedToFragment(e.connectedPoint))return!0}return!1}_getEffectiveTarget(){return this._fragmentOnly?tj.Fragment:!this.uv.isConnected||this.uv.sourceBlock.isInput?tj.VertexAndFragment:this._isTiedToFragment(this.uv.connectedPoint)?tj.Fragment:tj.VertexAndFragment}get target(){return this._getEffectiveTarget()}set target(e){}autoConfigure(e,t=()=>!0){if(!this.uv.isConnected){if(e.mode===t0.PostProcess){let i=e.getBlockByPredicate(e=>"uv"===e.name&&t(e));i&&i.connectTo(this)}else if(e.mode!==t0.ProceduralTexture){let i=e.mode===t0.Particle?"particle_uv":"uv",r=e.getInputBlockByPredicate(e=>e.isAttribute&&e.name===i&&t(e));r||(r=new lL("uv")).setAsAttribute(i),r.output.connectTo(this.uv)}}}initializeDefines(e,t,i){i._areTexturesDirty&&void 0!==this._mainUVDefineName&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0));return}let r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),void 0==i[this._mainUVDefineName]&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!!this._isSourcePrePass||!this.texture||!!this.texture.isReadyOrNotBlocking()}bind(e){this._isSourcePrePass&&e.setFloat(this._textureInfoName,1),this.texture&&(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==tj.Fragment}_injectVertexCode(e){let t=this.uv;this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.declarationVariableName.toUpperCase(),this._mainUVName="vMain"+t.declarationVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,t$.Vector2,this._defineName),e._emitVaryingFromString(this._mainUVName,t$.Vector2,this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,t$.Matrix,this._defineName);let i=e._getShaderType(t$.Vector4),r=e._getShaderType(t$.Vector2);e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._getVaryingName(this._transformedUVName)} = ${r}(${this._textureTransformName} * ${i}(${t.associatedVariableName}.xy, 1.0, 0.0));
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`;let s="";if(1===e.shaderLanguage&&t.isConnectedToInputBlock&&-1===t.associatedVariableName.indexOf("vertexInputs.")&&(s="vertexInputs."),e.compilationString+=`${e._getVaryingName(this._mainUVName)} = ${s}${t.associatedVariableName}.xy;
`,e.compilationString+=`#endif
`,this._outputs.some(e=>e.isConnectedInVertexShader))for(let t of(this._writeTextureRead(e,!0),this._outputs))t.hasEndpoints&&"level"!==t.name&&this._writeOutput(e,t,t.name,!0)}_getUVW(e){let t=e,i=this._texture?._texture?.is2DArray??!1,r=this._texture?._texture?.is3D??!1;if(i){let i=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${i})`}else if(r){let i=this.layer.isConnected?this.layer.associatedVariableName:"0";t=`vec3(${e}, ${i})`}return t}_samplerFunc(e){return 1===e.shaderLanguage?e.target===tj.Vertex?"textureSampleLevel":"textureSample":this.lod.isConnected?"texture2DLodEXT":"texture2D"}get _samplerLodSuffix(){return this.lod.isConnected?`, ${this.lod.associatedVariableName}`:""}_generateTextureSample(e,t){if(1===t.shaderLanguage){let i=t.target===tj.Vertex;return`${this._samplerFunc(t)}(${this.samplerName},${this.samplerName+"Sampler"}, ${this._getUVW(e)}${this._samplerLodSuffix}${i?", 0":""})`}return`${this._samplerFunc(t)}(${this.samplerName}, ${this._getUVW(e)}${this._samplerLodSuffix})`}_generateTextureLookup(e){e.compilationString+=`#ifdef ${this._defineName}
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${this._generateTextureSample(e._getVaryingName(this._transformedUVName),e)};
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})
`,e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${this._generateTextureSample(this._mainUVName?e._getVaryingName(this._mainUVName):this.uv.associatedVariableName,e)}${this._samplerLodSuffix};
`,e.compilationString+=`#endif
`}_writeTextureRead(e,t=!1){let i=this.uv;if(t){if(e.target===tj.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===tj.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${this._generateTextureSample(i.associatedVariableName,e)}${this._samplerLodSuffix};
`;return}this._generateTextureLookup(e)}_generateConversionCode(e,t,i){"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = ${e._toLinearSpace(t)};
                #endif
            `)}_writeOutput(e,t,i,r=!1){if(r){if(e.target===tj.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===tj.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`,this._generateConversionCode(e,t,i);return}let s="";this.disableLevelMultiplication||(s=` * ${(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${s};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===tj.Vertex||this._fragmentOnly||e.target===tj.Fragment)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),!this._isMixed&&e.target===tj.Fragment||this._isMixed&&e.target===tj.Vertex){if(!this._imageSource){let t=e._getFreeVariableName(this.name);this._samplerName=t+"Texture",this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName)}e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)}if(e.target!==tj.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(e=>e.isConnectedInFragmentShader))return;this._isMixed&&!this._imageSource&&(this._texture?._texture?.is2DArray?e._emit2DArraySampler(this._samplerName):e._emit2DSampler(this._samplerName));let t=`//${this.name}`;for(let i of(e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,t$.Float),this._writeTextureRead(e),this._outputs))i.hasEndpoints&&"level"!==i.name&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return(e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
`,this.texture)?e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`:e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i,r){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!lZ.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(0===e.texture.url.indexOf("data:")?i="":r&&(e.texture.url=r(e.texture.url),e.texture.name=e.texture.url),this.texture=rZ.x.Parse(e.texture,t,i))}}(0,i3.H7)("BABYLON.TextureBlock",uU);class uk extends lP{get texture(){return this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??rh.l.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,t=>t.hasTexture(e))}static _OnGenerateOnlyFragmentCodeChanged(e,t){return e._onGenerateOnlyFragmentCodeChanged()}_onGenerateOnlyFragmentCodeChanged(){return this._setTarget(),!0}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?tj.Fragment:tj.VertexAndFragment)}constructor(e){super(e,tj.VertexAndFragment),this.generateOnlyFragmentCode=!1}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}initialize(e){this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.resolve().then(i.bind(i,82370)):await Promise.resolve().then(i.bind(i,43237)),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}autoConfigure(e,t=()=>!0){if(!this.position.isConnected){let i=e.getInputBlockByPredicate(e=>e.isAttribute&&"position"===e.name&&t(e));i||(i=new lL("position")).setAsAttribute(),i.output.connectTo(this.position)}if(!this.world.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.World&&t(e));i||(i=new lL("world")).setAsSystemValue(tZ.World),i.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.View&&t(e));i||(i=new lL("view")).setAsSystemValue(tZ.View),i.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;let r=this._getTexture();r&&r.getTextureMatrix&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLocalCubicName,!!r.boundingBoxSize,!0),i.setValue(this._defineExplicitName,0===r.coordinatesMode,!0),i.setValue(this._defineSkyboxName,5===r.coordinatesMode,!0),i.setValue(this._defineCubicName,3===r.coordinatesMode||6===r.coordinatesMode,!0),i.setValue("INVERTCUBICMAP",6===r.coordinatesMode,!0),i.setValue(this._defineSphericalName,1===r.coordinatesMode,!0),i.setValue(this._definePlanarName,2===r.coordinatesMode,!0),i.setValue(this._defineProjectionName,4===r.coordinatesMode,!0),i.setValue(this._defineEquirectangularName,7===r.coordinatesMode,!0),i.setValue(this._defineEquirectangularFixedName,8===r.coordinatesMode,!0),i.setValue(this._defineMirroredEquirectangularFixedName,9===r.coordinatesMode,!0))}isReady(){let e=this._getTexture();return!e||!!e.isReadyOrNotBlocking()}bind(e,t,i,r){let s=this._getTexture();i&&s&&(e.setMatrix(this._reflectionMatrixName,s.getReflectionTextureMatrix()),s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s),s.boundingBoxSize&&(e.setVector3(this._reflectionPositionName,s.boundingBoxPosition),e.setVector3(this._reflectionSizeName,s.boundingBoxSize)))}handleVertexSide(e){if(this.generateOnlyFragmentCode&&e.target===tj.Vertex)return"";let t=1===e.shaderLanguage;this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,t$.Matrix);let i="";this._worldPositionNameInFragmentOnlyMode=e._getFreeVariableName("worldPosition");let r=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:"v_"+this.worldPosition.associatedVariableName;return(this.generateOnlyFragmentCode||e._emitVaryingFromString(r,t$.Vector4))&&(this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(r,t$.Vector4)} = ${this.worldPosition.associatedVariableName};
`:i+=`${t?"vertexOutputs.":""}${r} = ${this.worldPosition.associatedVariableName};
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._positionUVWName,t$.Vector3,this._defineSkyboxName))&&(i+=`#ifdef ${this._defineSkyboxName}
`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._positionUVWName,t$.Vector3)} = ${this.position.associatedVariableName}.xyz;
`:i+=`${t?"vertexOutputs.":""}${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;
`,i+=`#endif
`),(this.generateOnlyFragmentCode||e._emitVaryingFromString(this._directionWName,t$.Vector3,`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`))&&(i+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})
`,this.generateOnlyFragmentCode?i+=`${e._declareLocalVar(this._directionWName,t$.Vector3)} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`:i+=`${t?"vertexOutputs.":""}${this._directionWName} = normalize(vec3${e.fSuffix}(${this.world.associatedVariableName} * vec4${e.fSuffix}(${this.position.associatedVariableName}.xyz, 0.0)));
`,i+=`#endif
`),i}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._emitCubeSampler(this._cubeSamplerName,"",!0),e._samplerDeclaration+=`#else
`,e._emit2DSampler(this._2DSamplerName,"",!0),e._samplerDeclaration+=`#endif
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"},{search:/fn computeReflectionCoords\(worldPos: vec4f,worldNormal: vec3f\)->vec3f/g,replace:"fn DUMMYFUNC()"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,t$.Vector3),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,t$.Vector3)}handleFragmentSideCodeReflectionCoords(e,t,i,r=!1,s=!1){i||(i=this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:`v_${this.worldPosition.associatedVariableName}`);let n=(1===e.shaderLanguage?"uniforms.":"")+this._reflectionMatrixName,a=`normalize(${this._directionWName})`,o=`${this._positionUVWName}`,l=`${this.cameraPosition.associatedVariableName}`,c=`${this.view.associatedVariableName}`;t+=".xyz";let u=`
            #ifdef ${this._defineMirroredEquirectangularFixedName}
               ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeMirroredFixedEquirectangularCoords(${i}, ${t}, ${a});
            #endif

            #ifdef ${this._defineEquirectangularFixedName}
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeFixedEquirectangularCoords(${i}, ${t}, ${a});
            #endif

            #ifdef ${this._defineEquirectangularName}
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeEquirectangularCoords(${i}, ${t}, ${l}.xyz, ${n});
            #endif

            #ifdef ${this._defineSphericalName}
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeSphericalCoords(${i}, ${t}, ${c}, ${n});
            #endif

            #ifdef ${this._definePlanarName}
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computePlanarCoords(${i}, ${t}, ${l}.xyz, ${n});
            #endif

            #ifdef ${this._defineCubicName}
                #ifdef ${this._defineLocalCubicName}
                    ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeCubicLocalCoords(${i}, ${t}, ${l}.xyz, ${n}, ${this._reflectionSizeName}, ${this._reflectionPositionName});
                #else
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeCubicCoords(${i}, ${t}, ${l}.xyz, ${n});
                #endif
            #endif

            #ifdef ${this._defineProjectionName}
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeProjectionCoords(${i}, ${c}, ${n});
            #endif

            #ifdef ${this._defineSkyboxName}
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = computeSkyBoxCoords(${o}, ${n});
            #endif

            #ifdef ${this._defineExplicitName}
                ${e._declareLocalVar(this._reflectionVectorName,t$.Vector3)} = vec3(0, 0, 0);
            #endif
`;return s||(u+=`#ifdef ${this._defineOppositeZ}
                ${this._reflectionVectorName}.z *= -1.0;
            #endif
`),r||(u+=`
                #ifdef ${this._define3DName}
                    ${e._declareLocalVar(this._reflectionCoordsName,t$.Vector3)} = ${this._reflectionVectorName};
                #else
                    ${e._declareLocalVar(this._reflectionCoordsName,t$.Vector2)} = ${this._reflectionVectorName}.xy;
                    #ifdef ${this._defineProjectionName}
                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;
                    #endif
                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;
                #endif
`),u}handleFragmentSideCodeReflectionColor(e,t,i=".rgb"){let r=t$.Vector4;3===i.length&&(r=t$.Vector3);let s=`${e._declareLocalVar(this._reflectionColorName,r)};
            #ifdef ${this._define3DName}
`;return t?s+=`${this._reflectionColorName} = ${e._generateTextureSampleCubeLOD(this._reflectionVectorName,this._cubeSamplerName,t)}${i};
`:s+=`${this._reflectionColorName} = ${e._generateTextureSampleCube(this._reflectionVectorName,this._cubeSamplerName)}${i};
`,s+=`
            #else
`,t?s+=`${this._reflectionColorName} =${e._generateTextureSampleLOD(this._reflectionCoordsName,this._2DSamplerName,t)}${i};
`:s+=`${this._reflectionColorName} = ${e._generateTextureSample(this._reflectionCoordsName,this._2DSamplerName)}${i};
`,s+=`#endif
`}writeOutputs(e,t){let i="";if(e.target===tj.Fragment)for(let r of this._outputs)r.hasEndpoints&&(i+=`${e._declareOutput(r)} = ${t}.${r.name};
`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){let t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});
`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);
`;return e+`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`}serialize(){let e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!lZ.IgnoreTexturesAtLoadTime&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=o4.Parse(e.texture,t,i):this.texture=rZ.x.Parse(e.texture,t,i)),this.generateOnlyFragmentCode=e.generateOnlyFragmentCode,this._setTarget()}}(0,r$.gn)([lM("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:uk._OnGenerateOnlyFragmentCodeChanged}})],uk.prototype,"generateOnlyFragmentCode",void 0),(0,i3.H7)("BABYLON.ReflectionTextureBaseBlock",uk);class uG extends uk{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,re.Y.Error("The position input must not be connected to be able to switch!"),!1):this.worldPosition.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,re.Y.Error("The worldPosition input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?tj.Fragment:tj.Vertex,this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?tj.Fragment:tj.Vertex}constructor(e){super(e),this.registerInput("position",t$.AutoDetect,!1,tj.Vertex),this.registerInput("worldPosition",t$.Vector4,!1,tj.Vertex),this.registerInput("worldNormal",t$.Vector4,!1,tj.Fragment),this.registerInput("world",t$.Matrix,!1,tj.Vertex),this.registerInput("cameraPosition",t$.Vector3,!1,tj.Fragment),this.registerInput("view",t$.Matrix,!1,tj.Fragment),this.registerOutput("rgb",t$.Color3,tj.Fragment),this.registerOutput("rgba",t$.Color4,tj.Fragment),this.registerOutput("r",t$.Float,tj.Fragment),this.registerOutput("g",t$.Float,tj.Fragment),this.registerOutput("b",t$.Float,tj.Fragment),this.registerOutput("a",t$.Float,tj.Fragment),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e,t=()=>!0){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.CameraPosition&&t(e));i||(i=new lL("cameraPosition")).setAsSystemValue(tZ.CameraPosition),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,`vec4${e.fSuffix}(0.)`),this;if(e.target!==tj.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.generateOnlyFragmentCode&&(e.compilationString+=this.handleVertexSide(e)),this.handleFragmentSideInits(e);let t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`${e._declareLocalVar(t,t$.Vector4)} = normalize(${this.worldNormal.associatedVariableName});
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(e,t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(e,void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}(0,i3.H7)("BABYLON.ReflectionTextureBlock",uG);class uz extends lP{constructor(e){super(e,tj.VertexAndFragment),this.useNonLinearDepth=!1,this.storeCameraSpaceZ=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",t$.AutoDetect,!1,tj.VertexAndFragment),this.registerOutput("depth",t$.Float,tj.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Vector2|t$.Vector3|t$.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?tj.VertexAndFragment:tj.Fragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat,void 0,this.storeCameraSpaceZ).getDepthMap()}bind(e,t){let i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){let t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&!t.connectedPoint.ownerBlock.isAttribute&&e._emitUniformFromString(t.associatedVariableName,t.type===t$.Vector3?t$.Vector3:t.type===t$.Vector4?t$.Vector4:t$.Vector2),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,t$.Vector2),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;
`,this._outputs.some(e=>e.isConnectedInVertexShader))for(let t of(this._writeTextureRead(e,!0),this._outputs))t.hasEndpoints&&this._writeOutput(e,t,"r",!0)}_writeTextureRead(e,t=!1){let i=this.uv;if(t){if(e.target===tj.Fragment)return;let t=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSampleLevel(${this._samplerName}, ${this._samplerName+"Sampler"},`,r=0===e.shaderLanguage?"":", 0";e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)}=  ${t} ${i.associatedVariableName}.xy${r});
`;return}let r=0===e.shaderLanguage?`texture2D(${this._samplerName},`:`textureSample(${this._samplerName}, ${this._samplerName+"Sampler"},`;if(this.uv.ownerBlock.target===tj.Fragment){e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${r} ${i.associatedVariableName}.xy);
`;return}e.compilationString+=`${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = ${r} ${this._mainUVName});
`}_writeOutput(e,t,i,r=!1){if(r){if(e.target===tj.Fragment)return;e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}if(this.uv.ownerBlock.target===tj.Fragment){e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`;return}e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i};
`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),0>e.sharedData.bindableBlocks.indexOf(this)&&e.sharedData.bindableBlocks.push(this),e.target!==tj.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(this._outputs.some(e=>e.isConnectedInFragmentShader)){for(let t of(e._emit2DSampler(this._samplerName),this._writeTextureRead(e),this._outputs))t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){let e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.storeCameraSpaceZ=this.storeCameraSpaceZ,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.storeCameraSpaceZ=!!e.storeCameraSpaceZ,this.force32itsFloat=e.force32itsFloat}}(0,r$.gn)([lM("Use non linear depth",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{let i=!1;return t.useNonLinearDepth&&(t.storeCameraSpaceZ=!1,i=!0),e&&e.disableDepthRenderer(),i}}})],uz.prototype,"useNonLinearDepth",void 0),(0,r$.gn)([lM("Store Camera space Z",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:(e,t)=>{let i=!1;return t.storeCameraSpaceZ&&(t.useNonLinearDepth=!1,i=!0),e&&e.disableDepthRenderer(),i}}})],uz.prototype,"storeCameraSpaceZ",void 0),(0,r$.gn)([lM("Force 32 bits float",0,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:e=>e?.disableDepthRenderer()}})],uz.prototype,"force32itsFloat",void 0),(0,i3.H7)("BABYLON.SceneDepthBlock",uz);class uH extends lP{constructor(e){super(e,tj.VertexAndFragment,!0),this.registerInput("worldPosition",t$.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,24228)),Promise.resolve().then(i.bind(i,71030)),Promise.resolve().then(i.bind(i,46479)),Promise.resolve().then(i.bind(i,47659))]):await Promise.all([Promise.resolve().then(i.bind(i,81269)),Promise.resolve().then(i.bind(i,56119)),Promise.resolve().then(i.bind(i,12637)),Promise.resolve().then(i.bind(i,64676))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}get worldPosition(){return this._inputs[0]}get target(){return tj.VertexAndFragment}set target(e){}prepareDefines(e,t,i){let r=e.getScene(),s=!!(t.clipPlane??r.clipPlane),n=!!(t.clipPlane2??r.clipPlane2),a=!!(t.clipPlane3??r.clipPlane3),o=!!(t.clipPlane4??r.clipPlane4),l=!!(t.clipPlane5??r.clipPlane5),c=!!(t.clipPlane6??r.clipPlane6);i.setValue("CLIPPLANE",s,!0),i.setValue("CLIPPLANE2",n,!0),i.setValue("CLIPPLANE3",a,!0),i.setValue("CLIPPLANE4",o,!0),i.setValue("CLIPPLANE5",l,!0),i.setValue("CLIPPLANE6",c,!0)}bind(e,t,i){if(!i)return;let r=i.getScene();(0,o9.an)(e,t,r)}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`;if(e.target!==tj.Fragment){let i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane",t$.Vector4),e._emitUniformFromString("vClipPlane2",t$.Vector4),e._emitUniformFromString("vClipPlane3",t$.Vector4),e._emitUniformFromString("vClipPlane4",t$.Vector4),e._emitUniformFromString("vClipPlane5",t$.Vector4),e._emitUniformFromString("vClipPlane6",t$.Vector4);return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}(0,i3.H7)("BABYLON.ClipPlanesBlock",uH),i(24228),i(71030),i(46479),i(47659),i(81269),i(56119),i(12637),i(64676),i(1741),i(88004),i(39192),i(42751),i(18777),i(14696),i(89716),i(14413),i(72069),i(97853),i(6937),i(97533),i(87672),i(63164),i(86507),i(77272),i(82370),i(43237);class uW extends lP{get texture(){return null}set texture(e){}constructor(e,t=tj.VertexAndFragment){super(e,t,!1),this.registerOutput("position",t$.Object,tj.VertexAndFragment,new ug("position",this,1,uV,"ImageSourceBlock")),this.registerOutput("localPosition",t$.Object,tj.VertexAndFragment,new ug("localPosition",this,1,uV,"ImageSourceBlock")),this.registerOutput("depth",t$.Object,tj.VertexAndFragment,new ug("depth",this,1,uV,"ImageSourceBlock")),this.registerOutput("screenDepth",t$.Object,tj.VertexAndFragment,new ug("screenDepth",this,1,uV,"ImageSourceBlock")),this.registerOutput("normal",t$.Object,tj.VertexAndFragment,new ug("normal",this,1,uV,"ImageSourceBlock")),this.registerOutput("worldNormal",t$.Object,tj.VertexAndFragment,new ug("worldNormal",this,1,uV,"ImageSourceBlock"))}getSamplerName(e){return e===this._outputs[0]?this._positionSamplerName:e===this._outputs[1]?this._localPositionSamplerName:e===this._outputs[2]?this._depthSamplerName:e===this._outputs[3]?this._screenSpaceDepthSamplerName:e===this._outputs[4]?this._normalSamplerName:e===this._outputs[5]?this._worldNormalSamplerName:""}get position(){return this._outputs[0]}get localPosition(){return this._outputs[1]}get depth(){return this._outputs[2]}get screenDepth(){return this._outputs[3]}get normal(){return this._outputs[4]}get worldNormal(){return this._outputs[5]}get positionSamplerName(){return this._positionSamplerName}get localPositionSamplerName(){return this._localPositionSamplerName}get normalSamplerName(){return this._normalSamplerName}get worldNormalSamplerName(){return this._worldNormalSamplerName}get depthSamplerName(){return this._depthSamplerName}get linearDepthSamplerName(){return this._screenSpaceDepthSamplerName}getClassName(){return"PrePassTextureBlock"}_buildBlock(e){if(super._buildBlock(e),e.target!==tj.Vertex)return this._positionSamplerName="prepassPositionSampler",this._depthSamplerName="prepassDepthSampler",this._normalSamplerName="prepassNormalSampler",this._worldNormalSamplerName="prepassWorldNormalSampler",this._localPositionSamplerName="prepassLocalPositionSampler",this._screenSpaceDepthSamplerName="prepassScreenSpaceDepthSampler",e.sharedData.variableNames.prepassPositionSampler=0,e.sharedData.variableNames.prepassDepthSampler=0,e.sharedData.variableNames.prepassNormalSampler=0,e.sharedData.variableNames.prepassWorldNormalSampler=0,e.sharedData.variableNames.prepassLocalPositionSampler=0,e.sharedData.variableNames.prepassScreenSpaceDepthSampler=0,e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this),this.position.isConnected&&e._emit2DSampler(this._positionSamplerName),this.depth.isConnected&&e._emit2DSampler(this._depthSamplerName),this.normal.isConnected&&e._emit2DSampler(this._normalSamplerName),this.worldNormal.isConnected&&e._emit2DSampler(this._worldNormalSamplerName),this.localPosition.isConnected&&e._emit2DSampler(this._localPositionSamplerName),this.screenDepth.isConnected&&e._emit2DSampler(this._screenSpaceDepthSamplerName),this}bind(e,t){let i=t.getScene().enablePrePassRenderer();if(!i)return;let r=i.defaultRT;r.textures&&(this.position.isConnected&&e.setTexture(this._positionSamplerName,r.textures[i.getIndex(1)]),this.localPosition.isConnected&&e.setTexture(this._localPositionSamplerName,r.textures[i.getIndex(9)]),this.depth.isConnected&&e.setTexture(this._depthSamplerName,r.textures[i.getIndex(5)]),this.screenDepth.isConnected&&e.setTexture(this._screenSpaceDepthSamplerName,r.textures[i.getIndex(10)]),this.normal.isConnected&&e.setTexture(this._normalSamplerName,r.textures[i.getIndex(6)]),this.worldNormal.isConnected&&e.setTexture(this._worldNormalSamplerName,r.textures[i.getIndex(8)]))}}(0,i3.H7)("BABYLON.PrePassTextureBlock",uW);class uY extends lP{get endpoints(){return this._endpoints}get target(){let e=this._inputs[0];if(e.isConnected){let t=e.connectedPoint.ownerBlock;if(t.target!==tj.VertexAndFragment)return t.target;if(e.connectedPoint.target!==tj.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){(this._target&e)==0&&(this._target=e)}constructor(e){super(e,tj.Neutral),this._endpoints=[],this.registerInput("input",t$.AutoDetect)}getClassName(){return"NodeMaterialTeleportInBlock"}get input(){return this._inputs[0]}isConnectedInFragmentShader(){return this.endpoints.some(e=>e.output.isConnectedInFragmentShader)}_dumpCode(e,t){let i=super._dumpCode(e,t);for(let r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOf(e){for(let t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name,this._outputs=this._endpoints.map(e=>e.output)}detachFromEndpoint(e){let t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null,this._outputs=this._endpoints.map(e=>e.output))}dispose(){for(let e of(super.dispose(),this._endpoints))this.detachFromEndpoint(e);this._endpoints=[]}}(0,i3.H7)("BABYLON.NodeMaterialTeleportInBlock",uY);class uX extends lP{constructor(e){super(e,tj.Neutral),this._entryPoint=null,this._tempEntryPointUniqueId=null,this.registerOutput("output",t$.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"NodeMaterialTeleportOutBlock"}get output(){return this._outputs[0]}get target(){return this._entryPoint?this._entryPoint.target:this._target}set target(e){(this._target&e)==0&&(this._target=e)}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(e){super._buildBlock(e),this.entryPoint&&(e.compilationString+=e._declareOutput(this.output)+` = ${this.entryPoint.input.associatedVariableName};
`)}clone(e,t=""){let i=super.clone(e,t);return this.entryPoint&&this.entryPoint.attachToEndpoint(i),i}_customBuildStep(e,t){this.entryPoint&&this.entryPoint.build(e,t)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){let e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e,t,i){super._deserialize(e,t,i),this._tempEntryPointUniqueId=e.entryPoint}}(0,i3.H7)("BABYLON.NodeMaterialTeleportOutBlock",uX);class u$ extends lH{constructor(e){super(e)}getClassName(){return"AddBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.AddBlock",u$);class uj extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.AutoDetect),this.registerInput("factor",t$.Float),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.ScaleBlock",uj);class uq extends lP{constructor(e){super(e,tj.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=1===e.shaderLanguage?e._getShaderType(this.value.type):"";return e.compilationString+=e._declareOutput(t)+` = clamp(${this.value.associatedVariableName}, ${i}(${this._writeFloat(this.minimum)}), ${i}(${this._writeFloat(this.maximum)}));
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};
`+`${this._codeVariableName}.maximum = ${this.maximum};
`}serialize(){let e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}(0,r$.gn)([lM("Minimum",1)],uq.prototype,"minimum",void 0),(0,r$.gn)([lM("Maximum",1)],uq.prototype,"maximum",void 0),(0,i3.H7)("BABYLON.ClampBlock",uq);class uQ extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerOutput("output",t$.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(t$.Float),this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[0].excludedConnectionPointTypes.push(t$.Vector2),this._inputs[1].excludedConnectionPointTypes.push(t$.Float),this._inputs[1].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[1].excludedConnectionPointTypes.push(t$.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);
`,this}}(0,i3.H7)("BABYLON.CrossBlock",uQ);class uK extends lP{get options(){return this._options}set options(e){this._deserializeOptions(e)}constructor(e){super(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach(r=>{let s=RegExp("\\{TYPE_"+r.name+"\\}","gm"),n=e._getGLType(r.type);t=t.replace(s,n),i=i.replace(s,n)}),this._outputs.forEach(r=>{let s=RegExp("\\{TYPE_"+r.name+"\\}","gm"),n=e._getGLType(r.type);t=t.replace(s,n),i=i.replace(s,n)}),e._emitFunction(i,t,""),this._outputs.forEach(t=>{e.compilationString+=e._declareOutput(t)+";\n"}),e.compilationString+=i+"(";let r=!1;return this._inputs.forEach((t,i)=>{i>0&&(e.compilationString+=", "),this._inputSamplers&&-1!==this._inputSamplers.indexOf(t.name)?e.compilationString+=t.connectedPoint?.ownerBlock?.samplerName??t.associatedVariableName:e.compilationString+=t.associatedVariableName,r=!0}),this._outputs.forEach((t,i)=>{(i>0||r)&&(e.compilationString+=", "),e.compilationString+=t.associatedVariableName}),e.compilationString+=");\n",this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.options = ${JSON.stringify(this._options)};
`}serialize(){let e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){this._options=e,this._code=e.code.join("\n")+"\n",this.name=this.name||e.name,this.target=tj[e.target],e.inParameters?.forEach((e,t)=>{let i=t$[e.type];"sampler2D"===e.type||"samplerCube"===e.type?(this._inputSamplers=this._inputSamplers||[],this._inputSamplers.push(e.name),this.registerInput(e.name,t$.Object,!0,tj.VertexAndFragment,new ug(e.name,this,0,uV,"ImageSourceBlock"))):this.registerInput(e.name,i),Object.defineProperty(this,e.name,{get:function(){return this._inputs[t]},enumerable:!0,configurable:!0})}),e.outParameters?.forEach((e,t)=>{this.registerOutput(e.name,t$[e.type]),Object.defineProperty(this,e.name,{get:function(){return this._outputs[t]},enumerable:!0,configurable:!0}),"BasedOnInput"===e.type&&(this._outputs[t]._typeConnectionSource=this._findInputByName(e.typeFromInput)[0])}),e.inLinkedConnectionTypes?.forEach(e=>{this._linkConnectionTypes(this._findInputByName(e.input1)[1],this._findInputByName(e.input2)[1])})}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}(0,i3.H7)("BABYLON.CustomBlock",uK);class uZ extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerOutput("output",t$.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(t$.Float),this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[1].excludedConnectionPointTypes.push(t$.Float),this._inputs[1].excludedConnectionPointTypes.push(t$.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.DotBlock",uZ);class uJ extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(t$.Float),this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${i.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.NormalizeBlock",uJ);class u0 extends lP{constructor(e){super(e,tj.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",t$.Color3,!0),this.registerInput("r",t$.Float,!0),this.registerInput("g",t$.Float,!0),this.registerInput("b",t$.Float,!0),this.registerInput("a",t$.Float,!0),this.registerOutput("rgba",t$.Color4),this.registerOutput("rgb",t$.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return"rgb "===e?"rgbIn":e}_buildSwizzle(e){return"."+(this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle).substring(0,e)}_buildBlock(e){super._buildBlock(e);let t=this.r,i=this.g,r=this.b,s=this.a,n=this.rgbIn,a=this._outputs[0],o=this._outputs[1],l=e._getShaderType(t$.Vector4),c=e._getShaderType(t$.Vector3);return n.isConnected?(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${n.associatedVariableName}${this._buildSwizzle(3)};
`)):(a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${l}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(4)};
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${c}(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(3)};
`)),this}serialize(){let e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.rSwizzle=e.rSwizzle??"r",this.gSwizzle=e.gSwizzle??"g",this.bSwizzle=e.bSwizzle??"b",this.aSwizzle=e.aSwizzle??"a"}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";
${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";
${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";
${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";
`}}(0,i3.H7)("BABYLON.ColorMergerBlock",u0);class u1 extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("xyzw",t$.Vector4,!0),this.registerInput("xyz ",t$.Vector3,!0),this.registerInput("xy ",t$.Vector2,!0),this.registerOutput("xyz",t$.Vector3),this.registerOutput("xy",t$.Vector2),this.registerOutput("zw",t$.Vector2),this.registerOutput("x",t$.Float),this.registerOutput("y",t$.Float),this.registerOutput("z",t$.Float),this.registerOutput("w",t$.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);let t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],r=this._outputs[1],s=this._outputs[2],n=this._outputs[3],a=this._outputs[4],o=this._outputs[5],l=this._outputs[6],c=e._getShaderType(t$.Vector3);return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=e._declareOutput(i)+` = ${c}(${t.associatedVariableName}, 0.0);
`:e.compilationString+=e._declareOutput(i)+` = ${t.associatedVariableName}.xyz;
`),s.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=e._declareOutput(s)+` = ${this.xyzw.associatedVariableName}.zw;
`),r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName}.xy;
`),n.hasEndpoints&&(e.compilationString+=e._declareOutput(n)+` = ${t.associatedVariableName}.x;
`),a.hasEndpoints&&(e.compilationString+=e._declareOutput(a)+` = ${t.associatedVariableName}.y;
`),o.hasEndpoints&&(e.compilationString+=e._declareOutput(o)+` = ${t.associatedVariableName}.z;
`),l.hasEndpoints&&(e.compilationString+=e._declareOutput(l)+` = ${t.associatedVariableName}.w;
`),this}}(0,i3.H7)("BABYLON.VectorSplitterBlock",u1);class u2 extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerInput("gradient",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(t$.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.LerpBlock",u2);class u3 extends lH{constructor(e){super(e)}getClassName(){return"DivideBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.DivideBlock",u3);class u4 extends lH{constructor(e){super(e)}getClassName(){return"SubtractBlock"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.SubtractBlock",u4);class u5 extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("value",t$.Float),this.registerInput("edge",t$.Float),this.registerOutput("output",t$.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.StepBlock",u5);class u7 extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(t$.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = 1. - ${this.input.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.OneMinusBlock",u7),(0,i3.H7)("BABYLON.OppositeBlock",u7);class u6 extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("worldPosition",t$.Vector4),this.registerInput("cameraPosition",t$.Vector3),this.registerOutput("output",t$.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.CameraPosition&&t(e));i||(i=new lL("cameraPosition")).setAsSystemValue(tZ.CameraPosition),i.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);
`,this}}(0,i3.H7)("BABYLON.ViewDirectionBlock",u6),i(90350);class u8 extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("worldNormal",t$.Vector4),this.registerInput("viewDirection",t$.Vector3),this.registerInput("bias",t$.Float),this.registerInput("power",t$.Float),this.registerOutput("fresnel",t$.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){let t=new u6("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){let e=new lL("bias");e.value=0,e.output.connectTo(this.bias)}if(!this.power.isConnected){let e=new lL("power");e.value=1,e.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);let t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=e._declareOutput(this.fresnel)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.FresnelBlock",u8);class u9 extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.MaxBlock",u9);class he extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.MinBlock",he);class ht extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerOutput("output",t$.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(t$.Float),this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[1].excludedConnectionPointTypes.push(t$.Float),this._inputs[1].excludedConnectionPointTypes.push(t$.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.DistanceBlock",ht);class hi extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("value",t$.AutoDetect),this.registerOutput("output",t$.Float),this._inputs[0].excludedConnectionPointTypes.push(t$.Float),this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = length(${this.value.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.LengthBlock",hi);class hr extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("value",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = -1.0 * ${this.value.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.NegateBlock",hr);class hs extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("value",t$.AutoDetect),this.registerInput("power",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = pow(max(${this.value.associatedVariableName}, 0.), ${this.power.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.PowBlock",hs);class hn extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("seed",t$.AutoDetect),this.registerOutput("output",t$.Float),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Vector2|t$.Vector3|t$.Vector4|t$.Color3|t$.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=e._declareOutput(t)+` = getRand(${this.seed.associatedVariableName}.xy);
`,this}}(0,i3.H7)("BABYLON.RandomNumberBlock",hn);class ha extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("x",t$.Float),this.registerInput("y",t$.Float),this.registerOutput("output",t$.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=1===e.shaderLanguage?"atan2":"atan";return e.compilationString+=e._declareOutput(t)+` = ${i}(${this.x.associatedVariableName}, ${this.y.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.ArcTan2Block",ha);class ho extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("value",t$.AutoDetect),this.registerInput("edge0",t$.Float),this.registerInput("edge1",t$.Float),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e._getShaderType(this.value.type);return e.compilationString+=e._declareOutput(t)+` = smoothstep(${i}(${this.edge0.associatedVariableName}), ${i}(${this.edge1.associatedVariableName}), ${this.value.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.SmoothStepBlock",ho);class hl extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return this.input.type===t$.Matrix?e.compilationString+=e._declareOutput(t)+` = inverse(${this.input.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = 1. / ${this.input.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.ReciprocalBlock",hl);class hc extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("value",t$.AutoDetect),this.registerInput("reference",t$.AutoDetect),this.registerInput("distance",t$.Float),this.registerInput("replacement",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(t$.Float),this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[1].excludedConnectionPointTypes.push(t$.Float),this._inputs[1].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[3].excludedConnectionPointTypes.push(t$.Float),this._inputs[3].excludedConnectionPointTypes.push(t$.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {
`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};
`,e.compilationString+=`} else {
`,e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};
`,e.compilationString+=`}
`,this}}(0,i3.H7)("BABYLON.ReplaceColorBlock",hc);class hu extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("value",t$.AutoDetect),this.registerInput("steps",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[1].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(t$.Float)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.PosterizeBlock",hu),(ed=t9||(t9={}))[ed.SawTooth=0]="SawTooth",ed[ed.Square=1]="Square",ed[ed.Triangle=2]="Triangle";class hh extends lP{constructor(e){super(e,tj.Neutral),this.kind=0,this.registerInput("input",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];switch(this.kind){case 0:e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});
`;break;case 1:e.compilationString+=e._declareOutput(t)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));
`;break;case 2:e.compilationString+=e._declareOutput(t)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;
`}return this}serialize(){let e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}(0,i3.H7)("BABYLON.WaveBlock",hh);class hd{get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}constructor(e,t){this.step=e,this.color=t}}class hf extends lP{colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}constructor(e){super(e,tj.Neutral),this.colorSteps=[new hd(0,i2.Wo.Black()),new hd(1,i2.Wo.White())],this.onValueChangedObservable=new i0.y$,this.registerInput("gradient",t$.AutoDetect),this.registerOutput("output",t$.Color3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Float|t$.Vector2|t$.Vector3|t$.Vector4|t$.Color3|t$.Color4)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e,t){let i=this.colorSteps[e];return`${t}(${i.color.r}, ${i.color.g}, ${i.color.b})`}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=e._getShaderType(t$.Vector3);if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=e._declareOutput(t)+` = ${i}(0., 0., 0.);
`;return}let r=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`${e._declareLocalVar(r,t$.Vector3)} = ${this._writeColorConstant(0,i)};
`,e.compilationString+=`${e._declareLocalVar(s,t$.Float)};
`;let n=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==t$.Float&&(n+=".x");for(let t=1;t<this.colorSteps.length;t++){let a=this.colorSteps[t],o=this.colorSteps[t-1];e.compilationString+=`${s} = clamp((${n} - ${e._emitFloat(o.step)}) / (${e._emitFloat(a.step)} -  ${e._emitFloat(o.step)}), 0.0, 1.0) * step(${e._emitFloat(t)}, ${e._emitFloat(this.colorSteps.length-1)});
`,e.compilationString+=`${r} = mix(${r}, ${this._writeColorConstant(t,i)}, ${s});
`}return e.compilationString+=e._declareOutput(t)+` = ${r};
`,this}serialize(){let e=super.serialize();for(let t of(e.colorSteps=[],this.colorSteps))e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){for(let r of(super._deserialize(e,t,i),this.colorSteps.length=0,e.colorSteps))this.colorSteps.push(new hd(r.step,new i2.Wo(r.color.r,r.color.g,r.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();for(let t of(e+=`${this._codeVariableName}.colorSteps = [];
`,this.colorSteps))e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));
`;return e}}(0,i3.H7)("BABYLON.GradientBlock",hf);class hp extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerInput("gradient",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(t$.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));
`,this}}(0,i3.H7)("BABYLON.NLerpBlock",hp);class hm extends lP{constructor(e){super(e,tj.Neutral),this.manhattanDistance=!1,this.registerInput("seed",t$.Vector3),this.registerInput("jitter",t$.Float),this.registerOutput("output",t$.Vector2),this.registerOutput("x",t$.Float),this.registerOutput("y",t$.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t=`vec3 permute(vec3 x){
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);
}

vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){
    return [manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z)];
}

vec2 worley(vec3 P, float jitter, bool manhattanDistance){
    float K = 0.142857142857; // 1/7
    float Ko = 0.428571428571; // 1/2-K/2
    float  K2 = 0.020408163265306; // 1/(7*7)
    float Kz = 0.166666666667; // 1/6
    float Kzo = 0.416666666667; // 1/2-1/6*2

    vec3 Pi = mod(floor(P), 289.0);
    vec3 Pf = fract(P) - 0.5;

    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);
    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);
    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);

    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));
    vec3 p1 = permute(p + Pi.y - 1.0);
    vec3 p2 = permute(p + Pi.y);
    vec3 p3 = permute(p + Pi.y + 1.0);

    vec3 p11 = permute(p1 + Pi.z - 1.0);
    vec3 p12 = permute(p1 + Pi.z);
    vec3 p13 = permute(p1 + Pi.z + 1.0);

    vec3 p21 = permute(p2 + Pi.z - 1.0);
    vec3 p22 = permute(p2 + Pi.z);
    vec3 p23 = permute(p2 + Pi.z + 1.0);

    vec3 p31 = permute(p3 + Pi.z - 1.0);
    vec3 p32 = permute(p3 + Pi.z);
    vec3 p33 = permute(p3 + Pi.z + 1.0);

    vec3 ox11 = fract(p11*K) - Ko;
    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;
    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed

    vec3 ox12 = fract(p12*K) - Ko;
    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;
    vec3 oz12 = floor(p12*K2)*Kz - Kzo;

    vec3 ox13 = fract(p13*K) - Ko;
    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;
    vec3 oz13 = floor(p13*K2)*Kz - Kzo;

    vec3 ox21 = fract(p21*K) - Ko;
    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;
    vec3 oz21 = floor(p21*K2)*Kz - Kzo;

    vec3 ox22 = fract(p22*K) - Ko;
    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;
    vec3 oz22 = floor(p22*K2)*Kz - Kzo;

    vec3 ox23 = fract(p23*K) - Ko;
    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;
    vec3 oz23 = floor(p23*K2)*Kz - Kzo;

    vec3 ox31 = fract(p31*K) - Ko;
    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;
    vec3 oz31 = floor(p31*K2)*Kz - Kzo;

    vec3 ox32 = fract(p32*K) - Ko;
    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;
    vec3 oz32 = floor(p32*K2)*Kz - Kzo;

    vec3 ox33 = fract(p33*K) - Ko;
    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;
    vec3 oz33 = floor(p33*K2)*Kz - Kzo;

    vec3 dx11 = Pfx + jitter*ox11;
    vec3 dy11 = Pfy.x + jitter*oy11;
    vec3 dz11 = Pfz.x + jitter*oz11;

    vec3 dx12 = Pfx + jitter*ox12;
    vec3 dy12 = Pfy.x + jitter*oy12;
    vec3 dz12 = Pfz.y + jitter*oz12;

    vec3 dx13 = Pfx + jitter*ox13;
    vec3 dy13 = Pfy.x + jitter*oy13;
    vec3 dz13 = Pfz.z + jitter*oz13;

    vec3 dx21 = Pfx + jitter*ox21;
    vec3 dy21 = Pfy.y + jitter*oy21;
    vec3 dz21 = Pfz.x + jitter*oz21;

    vec3 dx22 = Pfx + jitter*ox22;
    vec3 dy22 = Pfy.y + jitter*oy22;
    vec3 dz22 = Pfz.y + jitter*oz22;

    vec3 dx23 = Pfx + jitter*ox23;
    vec3 dy23 = Pfy.y + jitter*oy23;
    vec3 dz23 = Pfz.z + jitter*oz23;

    vec3 dx31 = Pfx + jitter*ox31;
    vec3 dy31 = Pfy.z + jitter*oy31;
    vec3 dz31 = Pfz.x + jitter*oz31;

    vec3 dx32 = Pfx + jitter*ox32;
    vec3 dy32 = Pfy.z + jitter*oy32;
    vec3 dz32 = Pfz.y + jitter*oz32;

    vec3 dx33 = Pfx + jitter*ox33;
    vec3 dy33 = Pfy.z + jitter*oy33;
    vec3 dz33 = Pfz.z + jitter*oz33;

    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);
    vec3 d12 = dist(dx12, dy12, dz12, manhattanDistance);
    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);
    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);
    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);
    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);
    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);
    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);
    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);

    vec3 d1a = min(d11, d12);
    d12 = max(d11, d12);
    d11 = min(d1a, d13); // Smallest now not in d12 or d13
    d13 = max(d1a, d13);
    d12 = min(d12, d13); // 2nd smallest now not in d13
    vec3 d2a = min(d21, d22);
    d22 = max(d21, d22);
    d21 = min(d2a, d23); // Smallest now not in d22 or d23
    d23 = max(d2a, d23);
    d22 = min(d22, d23); // 2nd smallest now not in d23
    vec3 d3a = min(d31, d32);
    d32 = max(d31, d32);
    d31 = min(d3a, d33); // Smallest now not in d32 or d33
    d33 = max(d3a, d33);
    d32 = min(d32, d33); // 2nd smallest now not in d33
    vec3 da = min(d11, d21);
    d21 = max(d11, d21);
    d11 = min(da, d31); // Smallest now in d11
    d31 = max(da, d31); // 2nd smallest now not in d31
    if (d11.x >= d11.y) { vec2 temp = d11.yx; d11.x = temp.x; d11.y = temp.y; }
    if (d11.x >= d11.z) { vec2 temp = d11.zx; d11.x = temp.x; d11.z = temp.y; }
    d12 = min(d12, d21); // 2nd smallest now not in d21
    d12 = min(d12, d22); // nor in d22
    d12 = min(d12, d31); // nor in d31
    d12 = min(d12, d32); // nor in d32
    vec2 temp2 = min(d11.yz, d12.xy); // nor in d12.yz
    d11.y = temp2.x;
    d11.z = temp2.y;
    d11.y = min(d11.y, d12.z); // Only two more to go
    d11.y = min(d11.y, d11.z); // Done! (Phew!)
    return sqrt(d11.xy); // F1, F2
}

`,t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("worley3D",t,"// Worley3D");let i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`${e._declareLocalVar(i,t$.Vector2)} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.x.hasEndpoints&&(e.compilationString+=e._declareOutput(this.x)+` = ${i}.x;
`),this.y.hasEndpoints&&(e.compilationString+=e._declareOutput(this.y)+` = ${i}.y;
`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};
`}serialize(){let e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}(0,r$.gn)([lM("Use Manhattan Distance",0,"PROPERTIES",{notifiers:{update:!1}})],hm.prototype,"manhattanDistance",void 0),(0,i3.H7)("BABYLON.WorleyNoise3DBlock",hm);class h_ extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("seed",t$.Vector3),this.registerOutput("output",t$.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`const float SKEWFACTOR = 1.0/3.0;
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;
const float SIMPLEX_CORNER_POS = 0.5;
const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;
float SimplexPerlin3D( vec3 source ){
    vec3 P = source;
    P.x = [P.x == 0. && P.y == 0. && P.z == 0. ? 0.00001 : P.x];
    P *= SIMPLEX_TETRAHADRON_HEIGHT;
    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );
    vec3 g = step(x0.yzx, x0.xyz);
    vec3 l = 1.0 - g;
    vec3 Pi_1 = min( g.xyz, l.zxy );
    vec3 Pi_2 = max( g.xyz, l.zxy );
    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;
    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;
    vec3 x3 = x0 - SIMPLEX_CORNER_POS;
    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );
    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );
    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );
    Pi = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;
    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );
    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;
    Pt *= Pt;
    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );
    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );
    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );
    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );
    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );
    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );
    Pi_1 = [( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods];
    Pi_2 = [( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods];
    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;
    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;
    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;
    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );
    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;
    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;
    kernel_weights = max(0.5 - kernel_weights, vec4(0.));
    kernel_weights = kernel_weights*kernel_weights*kernel_weights;
    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;
}
`,t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=e._declareOutput(this._outputs[0])+` = SimplexPerlin3D(${this.seed.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.SimplexPerlin3DBlock",h_);class hg extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("normalMap0",t$.AutoDetect),this.registerInput("normalMap1",t$.AutoDetect),this.registerOutput("output",t$.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Color4|t$.Vector3|t$.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Color4|t$.Vector3|t$.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0],r=this._inputs[1],s=e._getFreeVariableName("stepR"),n=e._getFreeVariableName("stepG");return e.compilationString+=`${e._declareLocalVar(s,t$.Float)} = step(0.5, ${i.associatedVariableName}.r);
`,e.compilationString+=`${e._declareLocalVar(n,t$.Float)} = step(0.5, ${i.associatedVariableName}.g);
`,e.compilationString+=e._declareOutput(t)+`;
`,e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${s}) * ${i.associatedVariableName}.r * ${r.associatedVariableName}.r * 2.0 + ${s} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${r.associatedVariableName}.r) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${n}) * ${i.associatedVariableName}.g * ${r.associatedVariableName}.g * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${r.associatedVariableName}.g) * 2.0);
`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${r.associatedVariableName}.b;
`,this}}(0,i3.H7)("BABYLON.NormalBlendBlock",hg);class hv extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.Vector2),this.registerInput("angle",t$.Float),this.registerOutput("output",t$.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new lL("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.angle,r=this.input;return e.compilationString+=e._declareOutput(t)+` = vec2(cos(${i.associatedVariableName}) * ${r.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${r.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${r.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${r.associatedVariableName}.y);
`,this}}(0,i3.H7)("BABYLON.Rotate2dBlock",hv);class hS extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("incident",t$.AutoDetect),this.registerInput("normal",t$.AutoDetect),this.registerOutput("output",t$.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4|t$.Color3|t$.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4|t$.Color3|t$.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);
`,this}}(0,i3.H7)("BABYLON.ReflectBlock",hS);class hx extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("incident",t$.AutoDetect),this.registerInput("normal",t$.AutoDetect),this.registerInput("ior",t$.Float),this.registerOutput("output",t$.Vector3),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4|t$.Color3|t$.Color4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(t$.Vector3|t$.Vector4|t$.Color3|t$.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return e.compilationString+=e._declareOutput(t)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.RefractBlock",hx);class hE extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("color",t$.Color3),this.registerInput("level",t$.Float),this.registerOutput("output",t$.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.color.associatedVariableName,r=e._getFreeVariableName("colorMin"),s=e._getFreeVariableName("colorMax"),n=e._getFreeVariableName("colorMerge");return e.compilationString+=`${e._declareLocalVar(r,t$.Float)} = min(min(${i}.x, ${i}.y), ${i}.z);
`,e.compilationString+=`${e._declareLocalVar(s,t$.Float)} = max(max(${i}.x, ${i}.y), ${i}.z);
`,e.compilationString+=`${e._declareLocalVar(n,t$.Float)} = 0.5 * (${r} + ${s});
`,e.compilationString+=e._declareOutput(t)+` = mix(${i}, ${e._getShaderType(t$.Vector3)}(${n}, ${n}, ${n}), ${this.level.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.DesaturateBlock",hE);class hC extends lP{constructor(e){super(e,tj.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",t$.Float,!0,tj.Fragment),this.registerInput("color",t$.Color3,!0,tj.Fragment),this.registerInput("roughness",t$.Float,!0,tj.Fragment),this.registerOutput("sheen",t$.Object,tj.Fragment,new ug("sheen",this,1,hC,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e,t){let i=this.color.isConnected?this.color.associatedVariableName:`vec3${t.fSuffix}(1.)`,r=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",s=this.roughness.isConnected?this.roughness.associatedVariableName:"0.",n=`vec4${t.fSuffix}(0.)`,a=1===t.shaderLanguage;return`#ifdef SHEEN
            ${a?"var sheenOut: sheenOutParams":"sheenOutParams sheenOut"};

            ${t._declareLocalVar("vSheenColor",t$.Vector4)} = vec4${t.fSuffix}(${i}, ${r});

            sheenOut = sheenBlock(
                vSheenColor
            #ifdef SHEEN_ROUGHNESS
                , ${s}
            #endif
                , roughness
            #ifdef SHEEN_TEXTURE
                , ${n}
                ${a?`, ${n}Sampler`:""}
                , 1.0
            #endif
                , reflectance
            #ifdef SHEEN_LINKWITHALBEDO
                , baseColor
                , surfaceAlbedo
            #endif
            #ifdef ENVIRONMENTBRDF
                , NdotV
                , environmentBrdf
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                , AARoughnessFactors
                , ${a?"uniforms.":""}${e?._vReflectionMicrosurfaceInfosName}
                , ${e?._vReflectionInfosName}
                , ${e?.reflectionColor}
                , ${a?"uniforms.":""}vLightingIntensity
                #ifdef ${e?._define3DName}
                    , ${e?._cubeSamplerName}                                      
                    ${a?`, ${e?._cubeSamplerName}Sampler`:""}
                #else
                    , ${e?._2DSamplerName}
                    ${a?`, ${e?._2DSamplerName}Sampler`:""}
                #endif
                , reflectionOut.reflectionCoords
                , NdotVUnclamped
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${e?._define3DName}
                        , ${e?._cubeSamplerName}                        
                        ${a?`, ${e?._cubeSamplerName}Sampler`:""}
                        , ${e?._cubeSamplerName}
                        ${a?`, ${e?._cubeSamplerName}Sampler`:""}
                    #else
                        , ${e?._2DSamplerName}
                        ${a?`, ${e?._2DSamplerName}Sampler`:""}
                        , ${e?._2DSamplerName}
                        ${a?`, ${e?._2DSamplerName}Sampler`:""}
                    #endif
                #endif
                #if !defined(${e?._defineSkyboxName}) && defined(RADIANCEOCCLUSION)
                    , seo
                #endif
                #if !defined(${e?._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e?._define3DName})
                    , eho
                #endif
            #endif
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif
`}_buildBlock(e){return e.target===tj.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};
${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};
`}serialize(){let e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}(0,r$.gn)([lM("Albedo scaling",0,"PROPERTIES",{notifiers:{update:!0}})],hC.prototype,"albedoScaling",void 0),(0,r$.gn)([lM("Link sheen with albedo",0,"PROPERTIES",{notifiers:{update:!0}})],hC.prototype,"linkSheenWithAlbedo",void 0),(0,i3.H7)("BABYLON.SheenBlock",hC);var hT=i(45260);class hb extends lP{constructor(e){super(e,tj.Fragment),this._tangentCorrectionFactorName="",this._isUnique=!0,this.registerInput("intensity",t$.Float,!0,tj.Fragment),this.registerInput("direction",t$.Vector2,!0,tj.Fragment),this.registerInput("uv",t$.Vector2,!0),this.registerInput("worldTangent",t$.Vector4,!0),this.registerInput("TBN",t$.Object,!0,tj.VertexAndFragment,new ug("TBN",this,0,uT,"TBNBlock")),this.registerInput("roughness",t$.Float,!0,tj.Fragment),this.registerOutput("anisotropy",t$.Object,tj.Fragment,new ug("anisotropy",this,1,hb,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get roughness(){return this._inputs[5]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="",i=`//${this.name}`,r=this.uv,s=this.worldPositionConnectionPoint,n=this.worldNormalConnectionPoint,a=this.worldTangent,o=1===e.shaderLanguage;r.isConnected||re.Y.Error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let l={search:/defined\(TANGENT\)/g,replace:a.isConnected?"defined(TANGENT)":"defined(IGNORE)"},c=this.TBN;return c.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            ${o?"var TBN":"mat3 TBN"} = ${c.associatedVariableName};
            #endif
            `:a.isConnected&&(t+=`${e._declareLocalVar("tbnNormal",t$.Vector3)} = normalize(${n.associatedVariableName}.xyz);
${e._declareLocalVar("tbnTangent",t$.Vector3)} = normalize(${a.associatedVariableName}.xyz);
${e._declareLocalVar("tbnBitangent",t$.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
${o?"var vTBN":"mat3 vTBN"} = ${o?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);
`),t+=`
            #if defined(${a.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)
                ${o?"var TBN":"mat3 TBN"} = vTBN;
            #else
                ${o?"var TBN":"mat3 TBN"} = cotangent_frame(${n.associatedVariableName+".xyz"}, ${"v_"+s.associatedVariableName+".xyz"}, ${r.isConnected?r.associatedVariableName:"vec2(0.)"}, vec2${e.fSuffix}(1., 1.));
            #endif
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));let r=1===e.shaderLanguage,s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0",n=this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)",a=this.roughness.isConnected?this.roughness.associatedVariableName:"0.";return i+`${r?"var anisotropicOut: anisotropicOutParams":"anisotropicOutParams anisotropicOut"};
            anisotropicOut = anisotropicBlock(
                vec3(${n}, ${s}),
                ${a},
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW
            );
`}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0),i.setValue("ANISOTROPIC_LEGACY",!this.roughness.isConnected)}bind(e,t,i){super.bind(e,t,i),i&&e.setFloat(this._tangentCorrectionFactorName,0>i.getWorldMatrix().determinant()?-1:1)}_buildBlock(e){return e.target===tj.Fragment&&(e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,t$.Float)),this}}(0,i3.H7)("BABYLON.AnisotropyBlock",hb);class hy extends uk{_onGenerateOnlyFragmentCodeChanged(){return this.position.isConnected?(this.generateOnlyFragmentCode=!this.generateOnlyFragmentCode,re.Y.Error("The position input must not be connected to be able to switch!"),!1):(this._setTarget(),!0)}_setTarget(){super._setTarget(),this.getInputByName("position").target=this.generateOnlyFragmentCode?tj.Fragment:tj.Vertex,this.generateOnlyFragmentCode&&(this.forceIrradianceInFragment=!0)}constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",t$.AutoDetect,!1,tj.Vertex),this.registerInput("world",t$.Matrix,!1,tj.Vertex),this.registerInput("color",t$.Color3,!0,tj.Fragment),this.registerOutput("reflection",t$.Object,tj.Fragment,new ug("reflection",this,1,hy,"ReflectionBlock")),this.position.addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Vector4)}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);let r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("REFLECTION",s,!0),s&&(i.setValue(this._defineLODReflectionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!r.invertZ:r.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",r.gammaSpace,!0),i.setValue("RGBDREFLECTION",r.isRGBD,!0),r&&r.coordinatesMode!==rZ.x.SKYBOX_MODE&&r.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,r){super.bind(e,t,i);let s=this._getTexture();if(!s||!r)return;s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s);let n=s.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,n,s.lodGenerationScale,s.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,n,Math.log2(n));let a=r.materialDefines,o=s.sphericalPolynomial;if(a.USESPHERICALFROMREFLECTIONMAP&&o){if(a.SPHERICAL_HARMONICS){let t=o.preScaledHarmonics;e.setVector3("vSphericalL00",t.l00),e.setVector3("vSphericalL1_1",t.l1_1),e.setVector3("vSphericalL10",t.l10),e.setVector3("vSphericalL11",t.l11),e.setVector3("vSphericalL2_2",t.l2_2),e.setVector3("vSphericalL2_1",t.l2_1),e.setVector3("vSphericalL20",t.l20),e.setVector3("vSphericalL21",t.l21),e.setVector3("vSphericalL22",t.l22)}else e.setFloat3("vSphericalX",o.x.x,o.x.y,o.x.z),e.setFloat3("vSphericalY",o.y.x,o.y.y,o.y.z),e.setFloat3("vSphericalZ",o.z.x,o.z.y,o.z.z),e.setFloat3("vSphericalXX_ZZ",o.xx.x-o.zz.x,o.xx.y-o.zz.y,o.xx.z-o.zz.z),e.setFloat3("vSphericalYY_ZZ",o.yy.x-o.zz.x,o.yy.y-o.zz.y,o.yy.z-o.zz.z),e.setFloat3("vSphericalZZ",o.zz.x,o.zz.y,o.zz.z),e.setFloat3("vSphericalXY",o.xy.x,o.xy.y,o.xy.z),e.setFloat3("vSphericalYZ",o.yz.x,o.yz.y,o.yz.z),e.setFloat3("vSphericalZX",o.zx.x,o.zx.y,o.zx.z)}}handleVertexSide(e){let t=super.handleVertexSide(e),i=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});let r=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,t$.Vector3,"defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22",t$.Vector3,"SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ",t$.Vector3,"SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX",t$.Vector3,"SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                ${e._declareLocalVar(r,t$.Vector3)} = (${(i?"uniforms.":"")+this._reflectionMatrixName} * vec4${e.fSuffix}(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;
                #ifdef ${this._defineOppositeZ}
                    ${r}.z *= -1.0;
                #endif
                ${i?"vertexOutputs.":""}${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${r});
            #endif
`}getCode(e,t){let i="";this.handleFragmentSideInits(e);let r=1===e.shaderLanguage;e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),r||(e._emitFunction("sampleReflection",`
                #ifdef ${this._define3DName}
                    #define sampleReflection(s, c) textureCube(s, c)
                #else
                    #define sampleReflection(s, c) texture2D(s, c)
                #endif
`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`
                #ifdef ${this._define3DName}
                    #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
                #else
                    #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
                #endif
`,`//${this.name}`));let s=r?`
            fn computeReflectionCoordsPBR(worldPos: vec4f, worldNormal: vec3f) -> vec3f {
                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }
`:`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                ${this.handleFragmentSideCodeReflectionCoords(e,"worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }
`;return e._emitFunction("computeReflectionCoordsPBR",s,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,t$.Vector3),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,t$.Vector2),i+=`#ifdef REFLECTION
            ${e._declareLocalVar(this._vReflectionInfosName,t$.Vector2)} = vec2${e.fSuffix}(1., 0.);

            ${r?"var reflectionOut: reflectionOutParams":"reflectionOutParams reflectionOut"};

            reflectionOut = reflectionBlock(
                ${this.generateOnlyFragmentCode?this._worldPositionNameInFragmentOnlyMode:(r?"input.":"")+"v_"+this.worldPosition.associatedVariableName}.xyz
                , ${t}
                , alphaG
                , ${(r?"uniforms.":"")+this._vReflectionMicrosurfaceInfosName}
                , ${this._vReflectionInfosName}
                , ${this.reflectionColor}
            #ifdef ANISOTROPIC
                ,anisotropicOut
            #endif
            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})
                ,NdotVUnclamped
            #endif
            #ifdef ${this._defineLinearSpecularReflection}
                , roughness
            #endif
            #ifdef ${this._define3DName}
                , ${this._cubeSamplerName}
                ${r?`, ${this._cubeSamplerName}Sampler`:""}
            #else
                , ${this._2DSamplerName}
                ${r?`, ${this._2DSamplerName}Sampler`:""}
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                , ${r?"input.":""}${this._vEnvironmentIrradianceName}
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    , ${this._reflectionMatrixName}
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                , irradianceSampler         // ** not handled **
                ${r?", irradianceSamplerSampler":""}
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef ${this._define3DName}
                    , ${this._cubeSamplerName}
                    ${r?`, ${this._cubeSamplerName}Sampler`:""}
                    , ${this._cubeSamplerName}
                    ${r?`, ${this._cubeSamplerName}Sampler`:""}
                #else
                    , ${this._2DSamplerName}
                    ${r?`, ${this._2DSamplerName}Sampler`:""}
                    , ${this._2DSamplerName}                    
                    ${r?`, ${this._2DSamplerName}Sampler`:""}
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                , ${this._vReflectionFilteringInfoName}
            #endif
            );
        #endif
`}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==tj.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};
`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};
${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};
`}serialize(){let e=super.serialize();return e.useSphericalHarmonics=this.useSphericalHarmonics,e.forceIrradianceInFragment=this.forceIrradianceInFragment,e.gammaSpace=this.texture?.gammaSpace??!0,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}(0,r$.gn)([lM("Spherical Harmonics",0,"ADVANCED",{notifiers:{update:!0}})],hy.prototype,"useSphericalHarmonics",void 0),(0,r$.gn)([lM("Force irradiance in fragment",0,"ADVANCED",{notifiers:{update:!0}})],hy.prototype,"forceIrradianceInFragment",void 0),(0,i3.H7)("BABYLON.ReflectionBlock",hy);class hI extends lP{constructor(e){super(e,tj.Fragment),this._tangentCorrectionFactorName="",this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",t$.Float,!1,tj.Fragment),this.registerInput("roughness",t$.Float,!0,tj.Fragment),this.registerInput("indexOfRefraction",t$.Float,!0,tj.Fragment),this.registerInput("normalMapColor",t$.Color3,!0,tj.Fragment),this.registerInput("uv",t$.Vector2,!0,tj.Fragment),this.registerInput("tintColor",t$.Color3,!0,tj.Fragment),this.registerInput("tintAtDistance",t$.Float,!0,tj.Fragment),this.registerInput("tintThickness",t$.Float,!0,tj.Fragment),this.registerInput("worldTangent",t$.Vector4,!0),this.registerInput("worldNormal",t$.AutoDetect,!0),this.worldNormal.addExcludedConnectionPointFromAllowedTypes(t$.Color4|t$.Vector4|t$.Vector3),this.registerInput("TBN",t$.Object,!0,tj.VertexAndFragment,new ug("TBN",this,0,uT,"TBNBlock")),this.registerOutput("clearcoat",t$.Object,tj.Fragment,new ug("clearcoat",this,1,hI,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){let e=new lL("ClearCoat intensity",tj.Fragment,t$.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",!this.indexOfRefraction.isConnected||this.indexOfRefraction.connectInputBlock.value===ur.Y._DefaultIndexOfRefraction,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){super.bind(e,t,i);let r=this.indexOfRefraction.connectInputBlock?.value??ur.Y._DefaultIndexOfRefraction,s=1-r,n=1+r;e.setFloat4("vClearCoatRefractionParams",Math.pow(-s/n,2),1/r,s,n);let a=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,o=a?.perturbedNormal.isConnected?a.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",o?.invertX?1:-1,o?.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",o?.invertX?-1:1,o?.invertY?-1:1),i&&e.setFloat(this._tangentCorrectionFactorName,0>i.getWorldMatrix().determinant()?-1:1)}_generateTBNSpace(e,t,i){let r="",s=`//${this.name}`,n=this.worldTangent,a=1===e.shaderLanguage;a||e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");let o={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
                ${a?"var TBN":"mat3 TBN"} = ${l.associatedVariableName};
            #endif
            `:n.isConnected&&(r+=`${e._declareLocalVar("tbnNormal",t$.Vector3)} = normalize(${i}.xyz);
${e._declareLocalVar("tbnTangent",t$.Vector3)} = normalize(${n.associatedVariableName}.xyz);
${e._declareLocalVar("tbnBitangent",t$.Vector3)} = cross(tbnNormal, tbnTangent) * ${this._tangentCorrectionFactorName};
${a?"var vTBN":"mat3 vTBN"} = ${a?"mat3x3f":"mat3"}(tbnTangent, tbnBitangent, tbnNormal);
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",s,{replaceStrings:[o]}),r}static GetCode(e,t,i,r,s,n,a){let o="",l=t?.intensity.isConnected?t.intensity.associatedVariableName:"1.",c=t?.roughness.isConnected?t.roughness.associatedVariableName:"0.",u=t?.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:`vec3${e.fSuffix}(0.)`,h=t?.uv.isConnected?t.uv.associatedVariableName:`vec2${e.fSuffix}(0.)`,d=t?.tintColor.isConnected?t.tintColor.associatedVariableName:`vec3${e.fSuffix}(1.)`,f=t?.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",p=t?.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",m=`vec4${e.fSuffix}(0.)`;if(t){e._emitUniformFromString("vClearCoatRefractionParams",t$.Vector4),e._emitUniformFromString("vClearCoatTangentSpaceParams",t$.Vector2);let i=t.worldNormal;o+=`${e._declareLocalVar("vGeometricNormaClearCoatW",t$.Vector3)} = ${i.isConnected?"normalize("+i.associatedVariableName+".xyz)":"geometricNormalW"};
`}else o+=`${e._declareLocalVar("vGeometricNormaClearCoatW",t$.Vector3)} = geometricNormalW;
`;s&&t&&(o+=t._generateTBNSpace(e,r,a),n=t.worldTangent.isConnected);let _=1===e.shaderLanguage;return o+`${_?"var clearcoatOut: clearcoatOutParams":"clearcoatOutParams clearcoatOut"};

        #ifdef CLEARCOAT
            ${e._declareLocalVar("vClearCoatParams",t$.Vector2)} = vec2${e.fSuffix}(${l}, ${c});
            ${e._declareLocalVar("vClearCoatTintParams",t$.Vector4)} = vec4${e.fSuffix}(${d}, ${f});

            clearcoatOut = clearcoatBlock(
                ${r}.xyz
                , vGeometricNormaClearCoatW
                , viewDirectionW
                , vClearCoatParams
                , specularEnvironmentR0
            #ifdef CLEARCOAT_TEXTURE
                , vec2${e.fSuffix}(0.)
            #endif
            #ifdef CLEARCOAT_TINT
                , vClearCoatTintParams
                , ${p}
                , ${_?"uniforms.":""}vClearCoatRefractionParams
                #ifdef CLEARCOAT_TINT_TEXTURE
                    , ${m}
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                , vec2${e.fSuffix}(0., 1.)
                , vec4${e.fSuffix}(${u}, 0.)
                , ${h}
                #if defined(${n?"TANGENT":"IGNORE"}) && defined(NORMAL)
                    , vTBN
                #else
                    , ${_?"uniforms.":""}vClearCoatTangentSpaceParams
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    , normalMatrix
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                , faceNormal
            #endif
            #ifdef REFLECTION
                , ${_?"uniforms.":""}${i?._vReflectionMicrosurfaceInfosName}
                , ${i?._vReflectionInfosName}
                , ${i?.reflectionColor}
                , ${_?"uniforms.":""}vLightingIntensity
                #ifdef ${i?._define3DName}
                    , ${i?._cubeSamplerName}       
                    ${_?`, ${i?._cubeSamplerName}Sampler`:""}
                #else
                    , ${i?._2DSamplerName}       
                    ${_?`, ${i?._2DSamplerName}Sampler`:""}
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${i?._define3DName}
                        , ${i?._cubeSamplerName}       
                        ${_?`, ${i?._cubeSamplerName}Sampler`:""}
                        , ${i?._cubeSamplerName}
                        ${_?`, ${i?._cubeSamplerName}Sampler`:""}
                    #else
                        , ${i?._2DSamplerName}
                        ${_?`, ${i?._2DSamplerName}Sampler`:""}
                        , ${i?._2DSamplerName}
                        ${_?`, ${i?._2DSamplerName}Sampler`:""}                        
                    #endif
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                , (${e._generateTernary("1.","-1.",_?"fragmentInputs.frontFacing":"gl_FrontFacing")})
            #endif
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif
`}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===tj.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._tangentCorrectionFactorName=e._getFreeDefineName("tangentCorrectionFactor"),e._emitUniformFromString(this._tangentCorrectionFactorName,t$.Float)),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};
`}serialize(){let e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.remapF0OnInterfaceChange=e.remapF0OnInterfaceChange??!0}}(0,r$.gn)([lM("Remap F0 on interface change",0,"ADVANCED")],hI.prototype,"remapF0OnInterfaceChange",void 0),(0,i3.H7)("BABYLON.ClearCoatBlock",hI);class hP extends lP{constructor(e){super(e,tj.Fragment),this._isUnique=!0,this.registerInput("intensity",t$.Float,!0,tj.Fragment),this.registerInput("indexOfRefraction",t$.Float,!0,tj.Fragment),this.registerInput("thickness",t$.Float,!0,tj.Fragment),this.registerOutput("iridescence",t$.Object,tj.Fragment,new ug("iridescence",this,1,hP,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){let e=new lL("Iridescence intensity",tj.Fragment,t$.Float);e.value=1,e.output.connectTo(this.intensity);let t=new lL("Iridescence ior",tj.Fragment,t$.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);let i=new lL("Iridescence thickness",tj.Fragment,t$.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e,t){let i=e?.intensity.isConnected?e.intensity.associatedVariableName:"1.",r=e?.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:us.B._DefaultIndexOfRefraction,s=e?.thickness.isConnected?e.thickness.associatedVariableName:us.B._DefaultMaximumThickness,n=1===t.shaderLanguage;return`${n?"var iridescenceOut: iridescenceOutParams":"iridescenceOutParams iridescenceOut"};

        #ifdef IRIDESCENCE
            iridescenceOut = iridescenceBlock(
                vec4(${i}, ${r}, 1., ${s})
                , NdotV
                , specularEnvironmentR0
                #ifdef CLEARCOAT
                    , NdotVUnclamped
                #endif                
            );

            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;
            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;
        #endif
`}_buildBlock(e){return e.target===tj.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}(0,i3.H7)("BABYLON.IridescenceBlock",hP);class hR extends lP{constructor(e){super(e,tj.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",t$.Float,!1,tj.Fragment),this.registerInput("tintAtDistance",t$.Float,!0,tj.Fragment),this.registerInput("volumeIndexOfRefraction",t$.Float,!0,tj.Fragment),this.registerOutput("refraction",t$.Object,tj.Fragment,new ug("refraction",this,1,hR,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e,t=()=>!0){if(!this.intensity.isConnected){let e=new lL("Refraction intensity",tj.Fragment,t$.Float);e.value=1,e.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.View&&t(e));i||(i=new lL("view")).setAsSystemValue(tZ.View),i.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);let r=this._getTexture(),s=r&&r.getTextureMatrix;i.setValue("SS_REFRACTION",s,!0),s&&(i.setValue(this._define3DName,r.isCube,!0),i.setValue(this._defineLODRefractionAlpha,r.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,r.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem&&r.isCube?!r.invertZ:r.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",r.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",r.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!r.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){let e=this._getTexture();return!e||!!e.isReadyOrNotBlocking()}bind(e,t,i){super.bind(e,t,i);let r=this._getTexture();if(!r)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r),e.setMatrix(this._refractionMatrixName,r.getRefractionTextureMatrix());let s=1;!r.isCube&&r.depth&&(s=r.depth);let n=this.volumeIndexOfRefraction.connectInputBlock?.value??this.indexOfRefractionConnectionPoint.connectInputBlock?.value??1.5;e.setFloat4(this._vRefractionInfosName,r.level,1/n,s,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,r.getSize().width,r.lodGenerationScale,r.lodGenerationOffset,1/n);let a=r.getSize().width;e.setFloat2(this._vRefractionFilteringInfoName,a,Math.log2(a)),r.boundingBoxSize&&(e.setVector3("vRefractionPosition",r.boundingBoxPosition),e.setVector3("vRefractionSize",r.boundingBoxSize))}getCode(e){return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),this._getTexture()&&(e._samplerDeclaration+=`#ifdef ${this._define3DName}
`,e._emitCubeSampler(this._cubeSamplerName,void 0,!0),e._samplerDeclaration+=`#else
`,e._emit2DSampler(this._2DSamplerName,void 0,!0),e._samplerDeclaration+=`#endif
`),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,t$.Matrix),1!==e.shaderLanguage&&(e._emitFunction("sampleRefraction",`
                #ifdef ${this._define3DName}
                    #define sampleRefraction(s, c) textureCube(s, c)
                #else
                    #define sampleRefraction(s, c) texture2D(s, c)
                #endif
`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`
                #ifdef ${this._define3DName}
                    #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
                #else
                    #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
                #endif
`,`//${this.name}`)),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,t$.Vector4),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,t$.Vector4),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,t$.Vector2),e._emitUniformFromString("vRefractionPosition",t$.Vector3),e._emitUniformFromString("vRefractionSize",t$.Vector3),""}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e=(this.texture.isCube?`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");
`:`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");
`)+`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};
${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};
${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};
`}serialize(){let e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=0===e.texture.url.indexOf("data:")?"":i,e.texture.isCube?this.texture=o4.Parse(e.texture,t,i):this.texture=rZ.x.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}(0,r$.gn)([lM("Link refraction to transparency",0,"ADVANCED",{notifiers:{update:!0}})],hR.prototype,"linkRefractionWithTransparency",void 0),(0,r$.gn)([lM("Invert refraction Y",0,"ADVANCED",{notifiers:{update:!0}})],hR.prototype,"invertRefractionY",void 0),(0,r$.gn)([lM("Use thickness as depth",0,"ADVANCED",{notifiers:{update:!0}})],hR.prototype,"useThicknessAsDepth",void 0),(0,i3.H7)("BABYLON.RefractionBlock",hR);class hA extends lP{constructor(e){super(e,tj.Fragment),this._isUnique=!0,this.registerInput("thickness",t$.Float,!1,tj.Fragment),this.registerInput("tintColor",t$.Color3,!0,tj.Fragment),this.registerInput("translucencyIntensity",t$.Float,!0,tj.Fragment),this.registerInput("translucencyDiffusionDist",t$.Color3,!0,tj.Fragment),this.registerInput("refraction",t$.Object,!0,tj.Fragment,new ug("refraction",this,0,hR,"RefractionBlock")),this.registerInput("dispersion",t$.Float,!0,tj.Fragment),this.registerOutput("subsurface",t$.Object,tj.Fragment,new ug("subsurface",this,1,hA,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vTranslucencyColor"),e._excludeVariableName("vSubSurfaceIntensity"),e._excludeVariableName("dispersion")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get dispersion(){return this._inputs[5]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){let e=new lL("SubSurface thickness",tj.Fragment,t$.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);let r=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",r||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",r,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0),i.setValue("SS_DISPERSION",this.dispersion.isConnected,!0)}static GetCode(e,t,i,r){let s=t?.thickness.isConnected?t.thickness.associatedVariableName:"0.",n=t?.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",a=t?.translucencyIntensity.isConnected?t?.translucencyIntensity.associatedVariableName:"1.",o=t?.translucencyDiffusionDist.isConnected?t?.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",l=t?.refraction.isConnected?t?.refraction.connectedPoint?.ownerBlock:null,c=l?.tintAtDistance.isConnected?l.tintAtDistance.associatedVariableName:"1.",u=l?.intensity.isConnected?l.intensity.associatedVariableName:"1.",h=l?.view.isConnected?l.view.associatedVariableName:"",d=t?.dispersion.isConnected?t?.dispersion.associatedVariableName:"0.0",f=1===e.shaderLanguage;return""+(l?.getCode(e)??"")+`${f?"var subSurfaceOut: subSurfaceOutParams":"subSurfaceOutParams subSurfaceOut"};

        #ifdef SUBSURFACE
            ${e._declareLocalVar("vThicknessParam",t$.Vector2)} = vec2${e.fSuffix}(0., ${s});
            ${e._declareLocalVar("vTintColor",t$.Vector4)} = vec4${e.fSuffix}(${n}, ${c});
            ${e._declareLocalVar("vSubSurfaceIntensity",t$.Vector3)} = vec3(${u}, ${a}, 0.);
            ${e._declareLocalVar("dispersion",t$.Float)} = ${d};
            subSurfaceOut = subSurfaceBlock(
                vSubSurfaceIntensity
                , vThicknessParam
                , vTintColor
                , normalW
                , specularEnvironmentReflectance
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                , vec4${e.fSuffix}(0.)
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    , ${(f?"uniforms.":"")+i?._reflectionMatrixName}
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            , reflectionOut.irradianceVector
                        #endif
                        #if defined(REALTIME_FILTERING)
                            , ${i?._cubeSamplerName}
                            ${f?`, ${i?._cubeSamplerName}Sampler`:""}
                            , ${i?._vReflectionFilteringInfoName}
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        , irradianceSampler
                        ${f?", irradianceSamplerSampler":""}
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                , surfaceAlbedo
            #endif
            #ifdef SS_REFRACTION
                , ${r}.xyz
                , viewDirectionW
                , ${h}
                , ${((f?"uniforms.":"")+l?._vRefractionInfosName)??""}
                , ${((f?"uniforms.":"")+l?._refractionMatrixName)??""}
                , ${((f?"uniforms.":"")+l?._vRefractionMicrosurfaceInfosName)??""}
                , ${f?"uniforms.":""}vLightingIntensity
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    , alpha
                #endif
                #ifdef ${l?._defineLODRefractionAlpha??"IGNORE"}
                    , NdotVUnclamped
                #endif
                #ifdef ${l?._defineLinearSpecularRefraction??"IGNORE"}
                    , roughness
                #endif
                , alphaG
                #ifdef ${l?._define3DName??"IGNORE"}
                    , ${l?._cubeSamplerName??""}
                    ${f?`, ${l?._cubeSamplerName}Sampler`:""}
                #else
                    , ${l?._2DSamplerName??""}
                    ${f?`, ${l?._2DSamplerName}Sampler`:""}
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${l?._define3DName??"IGNORE"}
                        , ${l?._cubeSamplerName??""}                        
                        ${f?`, ${l?._cubeSamplerName}Sampler`:""}
                        , ${l?._cubeSamplerName??""}                        
                        ${f?`, ${l?._cubeSamplerName}Sampler`:""}
                    #else
                        , ${l?._2DSamplerName??""}
                        ${f?`, ${l?._2DSamplerName}Sampler`:""}
                        , ${l?._2DSamplerName??""}
                        ${f?`, ${l?._2DSamplerName}Sampler`:""}
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    , anisotropicOut
                #endif
                #ifdef REALTIME_FILTERING
                    , ${l?._vRefractionFilteringInfoName??""}
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    , vRefractionPosition
                    , vRefractionSize
                #endif
                #ifdef SS_DISPERSION
                    , dispersion
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                , ${o}
                , vTintColor
                #ifdef SS_TRANSLUCENCYCOLOR_TEXTURE
                    , vec4${e.fSuffix}(0.)
                #endif
            #endif                
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif
`}_buildBlock(e){return e.target===tj.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}(0,i3.H7)("BABYLON.SubSurfaceBlock",hA);let hM={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["aggShadow",""],alpha:["alpha",""]};class hN extends lP{static _OnGenerateOnlyFragmentCodeChanged(e,t){return e.worldPosition.isConnected?(e.generateOnlyFragmentCode=!e.generateOnlyFragmentCode,re.Y.Error("The worldPosition input must not be connected to be able to switch!"),!1):(e._setTarget(),!0)}_setTarget(){this._setInitialTarget(this.generateOnlyFragmentCode?tj.Fragment:tj.VertexAndFragment),this.getInputByName("worldPosition").target=this.generateOnlyFragmentCode?tj.Fragment:tj.Vertex}constructor(e){super(e,tj.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=i2.Wo.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.generateOnlyFragmentCode=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",t$.Vector4,!1,tj.Vertex),this.registerInput("worldNormal",t$.Vector4,!1,tj.Vertex),this.registerInput("view",t$.Matrix,!1),this.registerInput("cameraPosition",t$.Vector3,!1,tj.Fragment),this.registerInput("perturbedNormal",t$.Vector4,!0,tj.Fragment),this.registerInput("baseColor",t$.Color3,!0,tj.Fragment),this.registerInput("metallic",t$.Float,!1,tj.Fragment),this.registerInput("roughness",t$.Float,!1,tj.Fragment),this.registerInput("ambientOcc",t$.Float,!0,tj.Fragment),this.registerInput("opacity",t$.Float,!0,tj.Fragment),this.registerInput("indexOfRefraction",t$.Float,!0,tj.Fragment),this.registerInput("ambientColor",t$.Color3,!0,tj.Fragment),this.registerInput("reflection",t$.Object,!0,tj.Fragment,new ug("reflection",this,0,hy,"ReflectionBlock")),this.registerInput("clearcoat",t$.Object,!0,tj.Fragment,new ug("clearcoat",this,0,hI,"ClearCoatBlock")),this.registerInput("sheen",t$.Object,!0,tj.Fragment,new ug("sheen",this,0,hC,"SheenBlock")),this.registerInput("subsurface",t$.Object,!0,tj.Fragment,new ug("subsurface",this,0,hA,"SubSurfaceBlock")),this.registerInput("anisotropy",t$.Object,!0,tj.Fragment,new ug("anisotropy",this,0,hb,"AnisotropyBlock")),this.registerInput("iridescence",t$.Object,!0,tj.Fragment,new ug("iridescence",this,0,hP,"IridescenceBlock")),this.registerOutput("ambientClr",t$.Color3,tj.Fragment),this.registerOutput("diffuseDir",t$.Color3,tj.Fragment),this.registerOutput("specularDir",t$.Color3,tj.Fragment),this.registerOutput("clearcoatDir",t$.Color3,tj.Fragment),this.registerOutput("sheenDir",t$.Color3,tj.Fragment),this.registerOutput("diffuseInd",t$.Color3,tj.Fragment),this.registerOutput("specularInd",t$.Color3,tj.Fragment),this.registerOutput("clearcoatInd",t$.Color3,tj.Fragment),this.registerOutput("sheenInd",t$.Color3,tj.Fragment),this.registerOutput("refraction",t$.Color3,tj.Fragment),this.registerOutput("lighting",t$.Color3,tj.Fragment),this.registerOutput("shadow",t$.Float,tj.Fragment),this.registerOutput("alpha",t$.Float,tj.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode"),this._initShaderSourceAsync(e.shaderLanguage)}async _initShaderSourceAsync(e){this._codeIsReady=!1,1===e?await Promise.all([Promise.resolve().then(i.bind(i,8133)),Promise.resolve().then(i.bind(i,77082))]):await Promise.all([Promise.resolve().then(i.bind(i,98296)),Promise.resolve().then(i.bind(i,80024))]),this._codeIsReady=!0,this.onCodeIsReadyObservable.notifyObservers(this)}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e,t=()=>!0){if(!this.cameraPosition.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.CameraPosition&&t(e));i||(i=new lL("cameraPosition")).setAsSystemValue(tZ.CameraPosition),i.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let i=e.getInputBlockByPredicate(e=>e.systemValue===tZ.View&&t(e));i||(i=new lL("view")).setAsSystemValue(tZ.View),i.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("DEBUGMODE_FORCERETURN",!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===ut.m.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===ut.m.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));let r=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",0>r.indexOf(".")?r+".":r,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);let s=e.getScene();if(s.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&o6.k.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),i._areLightsDirty){if(this.light){let t={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};(0,le.wg)(s,e,this.light,this._lightId,i,!0,t),t.needRebuild&&i.rebuild()}else(0,le.UX)(s,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,(0,le.Z7)(s,i)}}updateUniformsAndSamples(e,t,i,r){for(let s=0;s<t.maxSimultaneousLights&&i["LIGHT"+s];s++){let t=e.uniforms.indexOf("vLightData"+s)>=0;(0,le.YM)(s,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+s],r,t)}}isReady(e,t,i){return(!this._environmentBRDFTexture||!!this._environmentBRDFTexture.isReady())&&(!i._areImageProcessingDirty||!t.imageProcessingConfiguration||!!t.imageProcessingConfiguration.isReady())}bind(e,t,i){if(!i)return;let r=i.getScene();this.light?(0,le.aM)(this.light,this._lightId,r,e,!0):(0,le.VX)(r,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);let s=this._scene.ambientColor;s&&e.setColor3("ambientFromScene",s);let n=r.useRightHandedSystem===(null!=r._mirroredCameraPosition);e.setFloat(this._invertNormalName,n?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);let a=this.indexOfRefraction.connectInputBlock?.value??1.5;this._metallicReflectanceColor.scaleToRef(Math.pow((a-1)/(a+1),2)*this._metallicF0Factor,i2.zZ.Color3[0]);let o=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,i2.zZ.Color3[0],o),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){let t=this.worldPosition,i=this.worldNormal,r=`//${this.name}`,s=1===e.shaderLanguage;this.light?(this._lightId=(void 0!==e.counters.lightCounter?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));let n="v_"+t.associatedVariableName;e._emitVaryingFromString(n,t$.Vector4)&&(e.compilationString+=(s?"vertexOutputs.":"")+`${n} = ${t.associatedVariableName};
`);let a="v_"+i.associatedVariableName;e._emitVaryingFromString(a,t$.Vector4)&&(e.compilationString+=(s?"vertexOutputs.":"")+`${a} = ${i.associatedVariableName};
`);let o=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=o?.handleVertexSide(e)??"",e._emitVaryingFromString("vClipSpacePosition",t$.Vector4,"defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0
`,e._injectAtEnd+=(s?"vertexOutputs.":"")+`vClipSpacePosition = ${s?"vertexOutputs.position":"gl_Position"};
`,e._injectAtEnd+=`#endif
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`${e._declareLocalVar("worldPos",t$.Vector4)} = ${t.associatedVariableName};
`,this.view.isConnected&&(e.compilationString+=`${e._declareLocalVar("view",t$.Matrix)} = ${this.view.associatedVariableName};
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(e){let t=1===e.shaderLanguage?"var albedoOpacityOut: albedoOpacityOutParams;\n":`albedoOpacityOutParams albedoOpacityOut;
`,i=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",r=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return t+`albedoOpacityOut = albedoOpacityBlock(
                vec4${e.fSuffix}(${i}, 1.)
            #ifdef ALBEDO
                ,vec4${e.fSuffix}(1.)
                ,vec2${e.fSuffix}(1., 1.)
            #endif
            #ifdef OPACITY
                ,vec4${e.fSuffix}(${r})
                ,vec2${e.fSuffix}(1., 1.)
            #endif                
            );

            ${e._declareLocalVar("surfaceAlbedo",t$.Vector3)} = albedoOpacityOut.surfaceAlbedo;
            ${e._declareLocalVar("alpha",t$.Float)} = albedoOpacityOut.alpha;
`}_getAmbientOcclusionCode(e){let t=1===e.shaderLanguage?"var aoOut: ambientOcclusionOutParams;\n":`ambientOcclusionOutParams aoOut;
`,i=this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1.";return t+`aoOut = ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3${e.fSuffix}(${i}),
                vec4${e.fSuffix}(0., 1.0, 1.0, 0.)
            #endif
            );
`}_getReflectivityCode(e){let t=1===e.shaderLanguage,i=t?"var reflectivityOut: reflectivityOutParams;\n":`reflectivityOutParams reflectivityOut;
`;return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,t$.Vector4),i+=`${e._declareLocalVar("baseColor",t$.Vector3)} = surfaceAlbedo;

            reflectivityOut = reflectivityBlock(
                vec4${e.fSuffix}(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.)
            #ifdef METALLICWORKFLOW
                , surfaceAlbedo
                , ${(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}
            #endif
            #ifdef REFLECTIVITY
                , vec3${e.fSuffix}(0., 0., 1.)
                , vec4${e.fSuffix}(1.)
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                , aoOut.ambientOcclusionColor
            #endif
            #ifdef MICROSURFACEMAP
                , microSurfaceTexel <== not handled!
            #endif
            );

            ${e._declareLocalVar("microSurface",t$.Float)} = reflectivityOut.microSurface;
            ${e._declareLocalVar("roughness",t$.Float)} = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif
`}_buildBlock(e){super._buildBlock(e),this._scene=e.sharedData.scene;let t=1===e.shaderLanguage;this._environmentBRDFTexture||(this._environmentBRDFTexture=(0,hT.$)(this._scene));let i=this.reflection.isConnected?this.reflection.connectedPoint?.ownerBlock:null;if(i&&(i.worldPositionConnectionPoint=this.worldPosition,i.cameraPositionConnectionPoint=this.cameraPosition,i.worldNormalConnectionPoint=this.worldNormal,i.viewConnectionPoint=this.view),e.target!==tj.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),this.generateOnlyFragmentCode&&e.sharedData.dynamicUniformBlocks.push(this);let r=`//${this.name}`,s=this.perturbedNormal,n=this.worldPosition.associatedVariableName,a=this.worldNormal.associatedVariableName;this.generateOnlyFragmentCode?(n=e._getFreeVariableName("globalWorldPos"),e.compilationString+=`${n} = ${this.worldPosition.associatedVariableName}.xyz;
`,a=e._getFreeVariableName("globalWorldNormal"),e.compilationString+=`${a} = ${this.worldNormal.associatedVariableName}.xyz;
`,e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?`worldPos,${this.worldPosition.associatedVariableName}`:void 0}),e.compilationString+=`#if DEBUGMODE > 0
`,e.compilationString+=`${e._declareLocalVar("vClipSpacePosition",t$.Vector4)} = vec4${e.fSuffix}((vec2${e.fSuffix}(${t?"fragmentInputs.position":"gl_FragCoord.xy"}) / vec2${e.fSuffix}(1.0)) * 2.0 - 1.0, 0.0, 1.0);
`,e.compilationString+=`#endif
`):(n=(t?"input.":"")+"v_"+n,a=(t?"input.":"")+"v_"+a),this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitUniformFromString("vDebugMode",t$.Vector2,"defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene",t$.Vector3),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights",substitutionVars:this.generateOnlyFragmentCode?"varying,":void 0}),e._emitFunctionFromInclude("helperFunctions",r),e._emitFunctionFromInclude("importanceSampling",r),e._emitFunctionFromInclude("pbrHelperFunctions",r),e._emitFunctionFromInclude("imageProcessingDeclaration",r),e._emitFunctionFromInclude("imageProcessingFunctions",r),e._emitFunctionFromInclude("shadowsFragmentFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",r),e._emitFunctionFromInclude("pbrBRDFFunctions",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",r),e._emitFunctionFromInclude("pbrDirectLightingFunctions",r),e._emitFunctionFromInclude("pbrIBLFunctions",r),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",r),e._emitFunctionFromInclude("pbrBlockReflectivity",r),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",r),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",r),e._emitFunctionFromInclude("pbrBlockAnisotropic",r),e._emitUniformFromString("vLightingIntensity",t$.Vector4),i?.generateOnlyFragmentCode&&(e.compilationString+=i.handleVertexSide(e)),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`${e._declareLocalVar(this._vNormalWName,t$.Vector4)} = normalize(${a});
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`${e._declareLocalVar("viewDirectionW",t$.Vector3)} = normalize(${this.cameraPosition.associatedVariableName} - ${n}.xyz);
`),e.compilationString+=`${e._declareLocalVar("geometricNormalW",t$.Vector3)} = ${this._vNormalWName}.xyz;
`,e.compilationString+=`${e._declareLocalVar("normalW",t$.Vector3)} = ${s.isConnected?"normalize("+s.associatedVariableName+".xyz)":"geometricNormalW"};
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,t$.Float),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",r,{replaceStrings:[{search:/vPositionW/g,replace:n+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(e),e.compilationString+=e._emitCodeFromInclude("depthPrePass",r),e.compilationString+=this._getAmbientOcclusionCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",r),e.compilationString+=`#ifdef UNLIT
                ${e._declareLocalVar("diffuseBase",t$.Vector3)} = vec3${e.fSuffix}(1., 1., 1.);
            #else
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});let o=this.anisotropy.isConnected?this.anisotropy.connectedPoint?.ownerBlock:null;o&&(o.worldPositionConnectionPoint=this.worldPosition,o.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=o.getCode(e,!this.perturbedNormal.isConnected)),i&&i.hasTexture&&(e.compilationString+=i.getCode(e,o?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:i?._vReflectionFilteringInfoName??"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",r,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:(t?"uniforms.":"")+this._vMetallicReflectanceFactorsName}]});let l=this.sheen.isConnected?this.sheen.connectedPoint?.ownerBlock:null;l&&(e.compilationString+=l.getCode(i,e)),e._emitFunctionFromInclude("pbrBlockSheen",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"}]});let c=this.iridescence.isConnected?this.iridescence.connectedPoint?.ownerBlock:null;e.compilationString+=hP.GetCode(c,e),e._emitFunctionFromInclude("pbrBlockIridescence",r,{replaceStrings:[]});let u=this.clearcoat.isConnected?this.clearcoat.connectedPoint?.ownerBlock:null,h=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,d=this.perturbedNormal.isConnected&&this.perturbedNormal.connectedPoint?.ownerBlock.worldTangent?.isConnected,f=this.anisotropy.isConnected&&(this.anisotropy.connectedPoint?.ownerBlock).worldTangent.isConnected,p=d||!this.perturbedNormal.isConnected&&f;e.compilationString+=hI.GetCode(e,u,i,n,h,p,a),h&&(p=u?.worldTangent.isConnected??!1),e._emitFunctionFromInclude("pbrBlockClearcoat",r,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:i?._defineLODReflectionAlpha??"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:i?._defineLinearSpecularReflection??"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:p?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",r,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:i?._defineSkyboxName??"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"}]});let m=this.subsurface.isConnected?this.subsurface.connectedPoint?.ownerBlock:null,_=this.subsurface.isConnected?this.subsurface.connectedPoint?.ownerBlock.refraction.connectedPoint?.ownerBlock:null;_&&(_.viewConnectionPoint=this.view,_.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=hA.GetCode(e,m,i,n),e._emitFunctionFromInclude("pbrBlockSubSurface",r,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:i?._define3DName??"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:i?._defineOppositeZ??"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:i?._defineProjectionName??"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:_?._define3DName??"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:_?._defineLODRefractionAlpha??"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:_?._defineLinearSpecularRefraction??"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:_?._defineOppositeZ??"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",r),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:RegExp(`${t?"fragmentInputs.":""}vPositionW`,"g"),replace:n+".xyz"}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",r,{repeatKey:"maxSimultaneousLights",substitutionVars:`${t?"fragmentInputs.":""}vPositionW,${n}.xyz`}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",r),e.compilationString+=`#endif
`;let g=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:`vec3${e.fSuffix}(0., 0., 0.)`,v=ut.m.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();-1===v.indexOf(".")&&(v+=".");let S=[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:RegExp(`${t?"uniforms.":""}vAmbientColor`,"g"),replace:g+` * ${t?"uniforms.":""}ambientFromScene`},{search:RegExp(`${t?"uniforms.":""}vAmbientInfos.w`,"g"),replace:v}];t&&(S[0]={search:/var finalEmissive[\s\S]*?finalEmissive\*=uniforms.vLightingIntensity\.y;/g,replace:""}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",r,{replaceStrings:S}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",r,{replaceStrings:[{search:/finalEmissive/g,replace:`vec3${e.fSuffix}(0.)`}]}),S=t?[{search:/mesh.visibility/g,replace:"1."}]:[{search:/visibility/g,replace:"1."}],e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",r,{replaceStrings:S});let x=t?"fragmentOutputs.color":"gl_FragColor";for(let i of(S=[{search:RegExp(`${t?"fragmentInputs.":""}vNormalW`,"g"),replace:this._vNormalWName},{search:RegExp(`${t?"fragmentInputs.":""}vPositionW`,"g"),replace:n},{search:/albedoTexture\.rgb;/g,replace:`vec3${e.fSuffix}(1.);
${x}.rgb = toGammaSpace(${x}.rgb);
`}],e.compilationString+=e._emitCodeFromInclude("pbrDebug",r,{replaceStrings:S}),this._outputs))if(i.hasEndpoints){let t=hM[i.name];if(t){let[r,s]=t;s&&(e.compilationString+=`#if ${s}
`),e.compilationString+=`${e._declareOutput(i)} = ${r};
`,s&&(e.compilationString+=`#else
`,e.compilationString+=`${e._declareOutput(i)} = vec3${e.fSuffix}(0.);
`,e.compilationString+=`#endif
`)}else re.Y.Error(`There's no remapping for the ${i.name} end point! No code generated`)}return this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};
${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};
${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};
${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};
${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};
${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};
${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};
${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};
${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};
${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};
${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};
${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};
${this._codeVariableName}.unlit = ${this.unlit};
${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};
${this._codeVariableName}.debugMode = ${this.debugMode};
${this._codeVariableName}.debugLimit = ${this.debugLimit};
${this._codeVariableName}.debugFactor = ${this.debugFactor};
`}serialize(){let e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e.generateOnlyFragmentCode=this.generateOnlyFragmentCode,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=e.lightFalloff??0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=e.realTimeFilteringQuality??8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor,this.generateOnlyFragmentCode=!!e.generateOnlyFragmentCode,this._setTarget()}}(0,r$.gn)([lM("Direct lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],hN.prototype,"directIntensity",void 0),(0,r$.gn)([lM("Environment lights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],hN.prototype,"environmentIntensity",void 0),(0,r$.gn)([lM("Specular highlights",1,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],hN.prototype,"specularIntensity",void 0),(0,r$.gn)([lM("Light falloff",4,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:ut.m.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:ut.m.LIGHTFALLOFF_GLTF},{label:"Standard",value:ut.m.LIGHTFALLOFF_STANDARD}]})],hN.prototype,"lightFalloff",void 0),(0,r$.gn)([lM("Alpha Testing",0,"OPACITY")],hN.prototype,"useAlphaTest",void 0),(0,r$.gn)([lM("Alpha CutOff",1,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],hN.prototype,"alphaTestCutoff",void 0),(0,r$.gn)([lM("Alpha blending",0,"OPACITY")],hN.prototype,"useAlphaBlending",void 0),(0,r$.gn)([lM("Radiance over alpha",0,"RENDERING",{notifiers:{update:!0}})],hN.prototype,"useRadianceOverAlpha",void 0),(0,r$.gn)([lM("Specular over alpha",0,"RENDERING",{notifiers:{update:!0}})],hN.prototype,"useSpecularOverAlpha",void 0),(0,r$.gn)([lM("Specular anti-aliasing",0,"RENDERING",{notifiers:{update:!0}})],hN.prototype,"enableSpecularAntiAliasing",void 0),(0,r$.gn)([lM("Realtime filtering",0,"RENDERING",{notifiers:{update:!0}})],hN.prototype,"realTimeFiltering",void 0),(0,r$.gn)([lM("Realtime filtering quality",4,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],hN.prototype,"realTimeFilteringQuality",void 0),(0,r$.gn)([lM("Energy Conservation",0,"ADVANCED",{notifiers:{update:!0}})],hN.prototype,"useEnergyConservation",void 0),(0,r$.gn)([lM("Radiance occlusion",0,"ADVANCED",{notifiers:{update:!0}})],hN.prototype,"useRadianceOcclusion",void 0),(0,r$.gn)([lM("Horizon occlusion",0,"ADVANCED",{notifiers:{update:!0}})],hN.prototype,"useHorizonOcclusion",void 0),(0,r$.gn)([lM("Unlit",0,"ADVANCED",{notifiers:{update:!0}})],hN.prototype,"unlit",void 0),(0,r$.gn)([lM("Force normal forward",0,"ADVANCED",{notifiers:{update:!0}})],hN.prototype,"forceNormalForward",void 0),(0,r$.gn)([lM("Generate only fragment code",0,"ADVANCED",{notifiers:{rebuild:!0,update:!0,onValidation:hN._OnGenerateOnlyFragmentCodeChanged}})],hN.prototype,"generateOnlyFragmentCode",void 0),(0,r$.gn)([lM("Debug mode",4,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87},{label:"Albedo color",value:88},{label:"Ambient occlusion color",value:89}]})],hN.prototype,"debugMode",void 0),(0,r$.gn)([lM("Split position",1,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],hN.prototype,"debugLimit",void 0),(0,r$.gn)([lM("Output factor",1,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],hN.prototype,"debugFactor",void 0),(0,i3.H7)("BABYLON.PBRMetallicRoughnessBlock",hN);class hO extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("left",t$.AutoDetect),this.registerInput("right",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[1].acceptedConnectionPointTypes.push(t$.Float)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0];return 0===e.shaderLanguage?e.compilationString+=e._declareOutput(t)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});
`:e.compilationString+=e._declareOutput(t)+` = (${this.left.associatedVariableName} % ${this.right.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.ModBlock",hO);class hD extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("row0",t$.Vector4),this.registerInput("row1",t$.Vector4),this.registerInput("row2",t$.Vector4),this.registerInput("row3",t$.Vector4),this.registerOutput("output",t$.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){let e=new lL("row0");e.value=new i1.Lt(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){let e=new lL("row1");e.value=new i1.Lt(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){let e=new lL("row2");e.value=new i1.Lt(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){let e=new lL("row3");e.value=new i1.Lt(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.row0,r=this.row1,s=this.row2,n=this.row3,a=1===e.shaderLanguage?"mat4x4f":"mat4";return e.compilationString+=e._declareOutput(t)+` = ${a}(${i.associatedVariableName}, ${r.associatedVariableName}, ${s.associatedVariableName}, ${n.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.MatrixBuilder",hD),(ef=ie||(ie={}))[ef.Equal=0]="Equal",ef[ef.NotEqual=1]="NotEqual",ef[ef.LessThan=2]="LessThan",ef[ef.GreaterThan=3]="GreaterThan",ef[ef.LessOrEqual=4]="LessOrEqual",ef[ef.GreaterOrEqual=5]="GreaterOrEqual",ef[ef.Xor=6]="Xor",ef[ef.Or=7]="Or",ef[ef.And=8]="And";class hF extends lP{constructor(e){super(e,tj.Neutral),this.condition=ie.LessThan,this.registerInput("a",t$.Float),this.registerInput("b",t$.Float),this.registerInput("true",t$.AutoDetect,!0),this.registerInput("false",t$.AutoDetect,!0),this.registerOutput("output",t$.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=t$.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",r=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case ie.Equal:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} == ${this.b.associatedVariableName}`)};
`;break;case ie.NotEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} != ${this.b.associatedVariableName}`)};
`;break;case ie.LessThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} < ${this.b.associatedVariableName}`)};
`;break;case ie.LessOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} <= ${this.b.associatedVariableName}`)};
`;break;case ie.GreaterThan:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} > ${this.b.associatedVariableName}`)};
`;break;case ie.GreaterOrEqual:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`${this.a.associatedVariableName} >= ${this.b.associatedVariableName}`)};
`;break;case ie.Xor:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(((${this.a.associatedVariableName} + ${this.b.associatedVariableName}) % 2.0) > 0.0)`)};
`;break;case ie.Or:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0)`)};
`;break;case ie.And:e.compilationString+=e._declareOutput(t)+` = ${e._generateTernary(i,r,`(${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)`)};
`}return this}serialize(){let e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${ie[this.condition]};
`}}(0,i3.H7)("BABYLON.ConditionalBlock",hF);class hL extends lP{constructor(e){super(e,tj.Neutral),this.octaves=6,this.registerInput("seed",t$.AutoDetect),this.registerInput("chaos",t$.AutoDetect,!0),this.registerInput("offsetX",t$.Float,!0),this.registerInput("offsetY",t$.Float,!0),this.registerInput("offsetZ",t$.Float,!0),this.registerOutput("output",t$.Float),this._inputs[0].acceptedConnectionPointTypes.push(t$.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(t$.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`

        float cloudRandom(float p) { 
            float temp = fract(p * 0.011); 
            temp *= temp + 7.5; 
            temp *= temp + temp; 
            return fract(temp); 
        }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise2(vec2 x, vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise3(vec3 x, vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,i=`
        float fbm2(vec2 st, vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            vec2 tempST = st;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise2(tempST, chaos);
                tempST *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm3(vec3 x, vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            vec3 tempX = x;
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise3(tempX, chaos);
                tempX = tempX * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`;1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t),i=e._babylonSLtoWGSL(i));let r=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",t,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,i.replace(/fbm/gi,r).replace(/OCTAVES/gi,(0|this.octaves).toString()),"// CloudBlockCode FBM");let s=e._getFreeVariableName("st"),n=this.seed.connectedPoint?.type||t$.Vector3;e.compilationString+=`${e._declareLocalVar(s,n)} = ${this.seed.associatedVariableName};
`,this.offsetX.isConnected&&(e.compilationString+=`${s}.x += 0.1 * ${this.offsetX.associatedVariableName};
`),this.offsetY.isConnected&&(e.compilationString+=`${s}.y += 0.1 * ${this.offsetY.associatedVariableName};
`),this.offsetZ.isConnected&&n===t$.Vector3&&(e.compilationString+=`${s}.z += 0.1 * ${this.offsetZ.associatedVariableName};
`);let a="";if(this.chaos.isConnected)a=this.chaos.associatedVariableName;else{let t=e.fSuffix;a=this.seed.connectedPoint?.type===t$.Vector2?`vec2${t}(0., 0.)`:`vec3${t}(0., 0., 0.)`}return e.compilationString+=e._declareOutput(this._outputs[0])+` = ${r}${this.seed.connectedPoint?.type===t$.Vector2?"2":"3"}(${s}, ${a});
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};
`}serialize(){let e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}(0,r$.gn)([lM("Octaves",2)],hL.prototype,"octaves",void 0),(0,i3.H7)("BABYLON.CloudBlock",hL);class hw extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("seed",t$.Vector2),this.registerInput("offset",t$.Float),this.registerInput("density",t$.Float),this.registerOutput("output",t$.Float),this.registerOutput("cells",t$.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t=`vec2 voronoiRandom(vec2 p){
            p = vec2(dot(p,vec2(127.1,311.7)),dot(p,vec2(269.5,183.3)));
            return fract(sin(p)*18.5453);
        }
        `;1===e.shaderLanguage&&(t=e._babylonSLtoWGSL(t)),e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 n = floor(seed * density);
            vec2 f = fract(seed * density);
            vec3 m = vec3( 8.0 );
            for( int j=-1; j<=1; j++ ){
                for( int i=-1; i<=1; i++ ){
                    vec2  g = vec2( float(i), float(j) );
                    vec2  o = voronoiRandom( n + g);
                    vec2  r = g - f + (0.5+0.5*sin(offset+6.2831*o));
                    float d = dot( r, r );
                    if( d<m.x ){
                        m = vec3( d, o );
                        outValue = m.x;
                        cells = m.y;
                    }
                }
			}
        }
        `,t=1===e.shaderLanguage?e._babylonSLtoWGSL(t):e._babylonSLtoGLSL(t),e._emitFunction("voronoi",t,"// Voronoi");let i=e._getFreeVariableName("tempOutput"),r=e._getFreeVariableName("tempCells"),s=1===e.shaderLanguage?"&":"";return e.compilationString+=`${e._declareLocalVar(i,t$.Float)} = 0.0;
`,e.compilationString+=`${e._declareLocalVar(r,t$.Float)} = 0.0;
`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${s}${i}, ${s}${r});
`,this.output.hasEndpoints&&(e.compilationString+=e._declareOutput(this.output)+` = ${i};
`),this.cells.hasEndpoints&&(e.compilationString+=e._declareOutput(this.cells)+` = ${r};
`),this}}(0,i3.H7)("BABYLON.VoronoiNoiseBlock",hw);class hB extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){let e=this._inputs[0];if(e.isConnected){let t=e.connectedPoint.ownerBlock;if(t.target!==tj.VertexAndFragment)return t.target;if(e.connectedPoint.target!==tj.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){(this._target&e)==0&&(this._target=e)}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0];return e.compilationString+=e._declareOutput(t)+` = ${i.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.ElbowBlock",hB);class hV extends lP{get texture(){return this.source.isConnected?(this.source.connectedPoint?.ownerBlock).texture:this._texture}set texture(e){if(this._texture===e)return;let t=e?.getScene()??rh.l.LastCreatedScene;!e&&t&&t.markAllMaterialsAsDirty(1,e=>e.hasTexture(this._texture)),this._texture=e,e&&t&&t.markAllMaterialsAsDirty(1,t=>t.hasTexture(e))}get textureY(){return this.sourceY.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}get textureZ(){return this.sourceZ?.isConnected?(this.sourceY.connectedPoint?.ownerBlock).texture:null}_getImageSourceBlock(e){return e?.isConnected?e.connectedPoint.ownerBlock:null}get samplerName(){let e=this._getImageSourceBlock(this.source);return e?e.samplerName:this._samplerName}get samplerYName(){return this._getImageSourceBlock(this.sourceY)?.samplerName??null}get samplerZName(){return this._getImageSourceBlock(this.sourceZ)?.samplerName??null}get hasImageSource(){return this.source.isConnected}set convertToGammaSpace(e){if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){let e=this.texture.getScene()??rh.l.LastCreatedScene;e?.markAllMaterialsAsDirty(1,e=>e.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){let e=this.texture.getScene()??rh.l.LastCreatedScene;e?.markAllMaterialsAsDirty(1,e=>e.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}constructor(e,t=!1){super(e,tj.Neutral),this.projectAsCube=!1,this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this.registerInput("position",t$.AutoDetect,!1),this.registerInput("normal",t$.AutoDetect,!1),this.registerInput("sharpness",t$.Float,!0),this.registerInput("source",t$.Object,!0,tj.VertexAndFragment,new ug("source",this,0,uV,"ImageSourceBlock")),this.registerInput("sourceY",t$.Object,!0,tj.VertexAndFragment,new ug("sourceY",this,0,uV,"ImageSourceBlock")),t||this.registerInput("sourceZ",t$.Object,!0,tj.VertexAndFragment,new ug("sourceZ",this,0,uV,"ImageSourceBlock")),this.registerOutput("rgba",t$.Color4,tj.Neutral),this.registerOutput("rgb",t$.Color3,tj.Neutral),this.registerOutput("r",t$.Float,tj.Neutral),this.registerOutput("g",t$.Float,tj.Neutral),this.registerOutput("b",t$.Float,tj.Neutral),this.registerOutput("a",t$.Float,tj.Neutral),this.registerOutput("level",t$.Float,tj.Neutral),this._inputs[0].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Vector4),this._inputs[1].addExcludedConnectionPointFromAllowedTypes(t$.Color3|t$.Vector3|t$.Vector4)}getClassName(){return"TriPlanarBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get sharpness(){return this._inputs[2]}get source(){return this._inputs[3]}get sourceY(){return this._inputs[4]}get sourceZ(){return this._inputs[5]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;let r=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,s=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,r,!0),i.setValue(this._gammaDefineName,s,!0)}isReady(){return!this.texture||!!this.texture.isReadyOrNotBlocking()}bind(e){this.texture&&(e.setFloat(this._textureInfoName,this.texture.level),this._imageSource||e.setTexture(this._samplerName,this.texture))}_samplerFunc(e){return 1===e.shaderLanguage?"textureSample":"texture2D"}_generateTextureSample(e,t,i){return 1===i.shaderLanguage?`${this._samplerFunc(i)}(${e},${e+"Sampler"}, ${t})`:`${this._samplerFunc(i)}(${e}, ${t})`}_generateTextureLookup(e){let t=this.samplerName,i=this.samplerYName??t,r=this.samplerZName??t,s=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",n=e._getFreeVariableName("x"),a=e._getFreeVariableName("y"),o=e._getFreeVariableName("z"),l=e._getFreeVariableName("w"),c=e._getFreeVariableName("n"),u=e._getFreeVariableName("uvx"),h=e._getFreeVariableName("uvy"),d=e._getFreeVariableName("uvz");e.compilationString+=`
            ${e._declareLocalVar(c,t$.Vector3)} = ${this.normal.associatedVariableName}.xyz;

            ${e._declareLocalVar(u,t$.Vector2)} = ${this.position.associatedVariableName}.yz;
            ${e._declareLocalVar(h,t$.Vector2)} = ${this.position.associatedVariableName}.zx;
            ${e._declareLocalVar(d,t$.Vector2)} = ${this.position.associatedVariableName}.xy;
        `,this.projectAsCube&&(e.compilationString+=`
                ${u}.xy = ${u}.yx;

                if (${c}.x >= 0.0) {
                    ${u}.x = -${u}.x;
                }
                if (${c}.y < 0.0) {
                    ${h}.y = -${h}.y;
                }
                if (${c}.z < 0.0) {
                    ${d}.x = -${d}.x;
                }
            `);let f=e.fSuffix;e.compilationString+=`
            ${e._declareLocalVar(n,t$.Vector4)} = ${this._generateTextureSample(t,u,e)};
            ${e._declareLocalVar(a,t$.Vector4)} = ${this._generateTextureSample(i,h,e)};
            ${e._declareLocalVar(o,t$.Vector4)} = ${this._generateTextureSample(r,d,e)};
           
            // blend weights
            ${e._declareLocalVar(l,t$.Vector3)} = pow(abs(${c}), vec3${f}(${s}));

            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = (${n}*${l}.x + ${a}*${l}.y + ${o}*${l}.z) / (${l}.x + ${l}.y + ${l}.z);        
        `}_generateConversionCode(e,t,i){let r="";1===e.shaderLanguage&&(t.type===t$.Vector3||t.type===t$.Color3)&&(r="Vec3"),"a"!==i&&(this.texture&&this.texture.gammaSpace||(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace${r}(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace${r}(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i){let r="";this.disableLevelMultiplication||(r=` * ${1===e.shaderLanguage?"uniforms.":""}${this._textureInfoName}`),e.compilationString+=`${e._declareOutput(t)} = ${this._tempTextureRead}.${i}${r};
`,this._generateConversionCode(e,t,i)}_buildBlock(e){super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=(1===e.shaderLanguage?"uniforms.":"")+this._textureInfoName,this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA"),this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Texture"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);let t=`//${this.name}`;for(let i of(e._emitFunctionFromInclude("helperFunctions",t),e._emitUniformFromString(this._textureInfoName,t$.Float),this._generateTextureLookup(e),this._outputs))i.hasEndpoints&&"level"!==i.name&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return(e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};
${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};
${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};
${this._codeVariableName}.projectAsCube = ${this.projectAsCube};
`,this.texture)?e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});
${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};
${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};
${this._codeVariableName}.texture.uAng = ${this.texture.uAng};
${this._codeVariableName}.texture.vAng = ${this.texture.vAng};
${this._codeVariableName}.texture.wAng = ${this.texture.wAng};
${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};
${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};
${this._codeVariableName}.texture.uScale = ${this.texture.uScale};
${this._codeVariableName}.texture.vScale = ${this.texture.vScale};
${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};
`:e}serialize(){let e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.disableLevelMultiplication=this.disableLevelMultiplication,e.projectAsCube=this.projectAsCube,this.hasImageSource||!this.texture||this.texture.isRenderTarget||"VideoTexture"===this.texture.getClassName()||(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this.disableLevelMultiplication=!!e.disableLevelMultiplication,this.projectAsCube=!!e.projectAsCube,e.texture&&!lZ.IgnoreTexturesAtLoadTime&&void 0!==e.texture.url&&(i=0===e.texture.url.indexOf("data:")?"":i,this.texture=rZ.x.Parse(e.texture,t,i))}}(0,r$.gn)([lM("Project as cube",0,"ADVANCED",{notifiers:{update:!0}})],hV.prototype,"projectAsCube",void 0),(0,i3.H7)("BABYLON.TriPlanarBlock",hV);class hU extends hV{constructor(e){super(e,!0)}getClassName(){return"BiPlanarBlock"}_declareLocalVarAsVec3I(e,t){return 1===t.shaderLanguage?`var ${e}: vec3<i32>`:`ivec3 ${e}`}_getTextureGrad(e,t){return 1===e.shaderLanguage?`textureSampleGrad(${t},${t+"Sampler"}`:`textureGrad(${t}`}_generateTextureLookup(e){let t=this.samplerName,i=this.samplerYName??this.samplerName,r=this.sharpness.isConnected?this.sharpness.associatedVariableName:"1.0",s=e._getFreeVariableName("dxValue"),n=e._getFreeVariableName("dyValue"),a=e._getFreeVariableName("n"),o=e._getFreeVariableName("ma"),l=e._getFreeVariableName("mi"),c=e._getFreeVariableName("me"),u=e._getFreeVariableName("x"),h=e._getFreeVariableName("y"),d=e._getFreeVariableName("w"),f="ivec3",p="dFdx",m="dFdy",_=e.fSuffix;1===e.shaderLanguage&&(f="vec3<i32>",p="dpdx",m="dpdy"),e.compilationString+=`
            // grab coord derivatives for texturing
            ${e._declareLocalVar(s,t$.Vector3)} = ${p}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(n,t$.Vector3)} = ${m}(${this.position.associatedVariableName}.xyz);
            ${e._declareLocalVar(a,t$.Vector3)} = abs(${this.normal.associatedVariableName}.xyz);
        
            // determine major axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(o,e)} = ${e._generateTernary(`${f}(0,1,2)`,`${e._generateTernary(`${f}(1,2,0)`,`${f}(2,0,1)`,`(${a}.y>${a}.z)`)}`,`(${a}.x>${a}.y && ${a}.x>${a}.z)`)};                    

            // determine minor axis (in x; yz are following axis)
            ${this._declareLocalVarAsVec3I(l,e)} =  ${e._generateTernary(`${f}(0,1,2)`,`${e._generateTernary(`${f}(1,2,0)`,`${f}(2,0,1)`,`(${a}.y<${a}.z)`)}`,`(${a}.x<${a}.y && ${a}.x<${a}.z)`)};  
                              
            // determine median axis (in x;  yz are following axis)
            ${this._declareLocalVarAsVec3I(c,e)} = ${f}(3) - ${l} - ${o};
            
            // project+fetch
            ${e._declareLocalVar(u,t$.Vector4)} = ${this._getTextureGrad(e,t)}, vec2${_}(${this.position.associatedVariableName}[${o}.y], ${this.position.associatedVariableName}[${o}.z]), 
                                    vec2${_}(${s}[${o}.y],${s}[${o}.z]), 
                                    vec2${_}(${n}[${o}.y],${n}[${o}.z]));
            ${e._declareLocalVar(h,t$.Vector4)} = ${this._getTextureGrad(e,i)}, vec2${_}(${this.position.associatedVariableName}[${c}.y], ${this.position.associatedVariableName}[${c}.z]), 
                                    vec2${_}(${s}[${c}.y],${s}[${c}.z]),
                                    vec2${_}(${n}[${c}.y],${n}[${c}.z]));
            
            // blend factors
            ${e._declareLocalVar(d,t$.Vector2)} = vec2${_}(${a}[${o}.x],${a}[${c}.x]);
            // make local support
            ${d} = clamp( (${d}-0.5773)/(1.0-0.5773), vec2${_}(0.0), vec2${_}(1.0) );
            // shape transition
            ${d} = pow( ${d}, vec2${_}(${r}/8.0) );
            // blend and return
            ${e._declareLocalVar(this._tempTextureRead,t$.Vector4)} = (${u}*${d}.x + ${h}*${d}.y) / (${d}.x + ${d}.y);
        `}}(0,i3.H7)("BABYLON.BiPlanarBlock",hU);class hk extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.Matrix),this.registerOutput("output",t$.Float)}getClassName(){return"MatrixDeterminantBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = determinant(${i.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.MatrixDeterminantBlock",hk);class hG extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("input",t$.Matrix),this.registerOutput("output",t$.Matrix)}getClassName(){return"MatrixTransposeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this.output,i=this.input;return e.compilationString+=e._declareOutput(t)+` = transpose(${i.associatedVariableName});
`,this}}(0,i3.H7)("BABYLON.MatrixTransposeBlock",hG),(ep=it||(it={}))[ep.None=0]="None",ep[ep.Normal=1]="Normal",ep[ep.Tangent=2]="Tangent",ep[ep.VertexColor=3]="VertexColor",ep[ep.UV1=4]="UV1",ep[ep.UV2=5]="UV2",ep[ep.UV3=6]="UV3",ep[ep.UV4=7]="UV4",ep[ep.UV5=8]="UV5",ep[ep.UV6=9]="UV6";class hz extends lP{constructor(e){super(e,tj.Neutral),this.attributeType=0,this.registerInput("input",t$.AutoDetect),this.registerInput("fallback",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].onConnectionObservable.add(e=>{if(this.attributeType)return;let t=e.ownerBlock;if(t instanceof lL&&t.isAttribute)switch(t.name){case"color":this.attributeType=3;break;case"normal":this.attributeType=1;break;case"tangent":this.attributeType=2;break;case"uv":this.attributeType=4;break;case"uv2":this.attributeType=5;break;case"uv3":this.attributeType=6;break;case"uv4":this.attributeType=7;break;case"uv5":this.attributeType=8;break;case"uv6":this.attributeType=9}else if(t instanceof ux)switch(this.input.connectedPoint?.name){case"normalOutput":this.attributeType=1;break;case"tangentOutput":this.attributeType=2;break;case"uvOutput":this.attributeType=4}})}getClassName(){return"MeshAttributeExistsBlock"}get input(){return this._inputs[0]}get fallback(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.attributeType){case 3:t="VERTEXCOLOR_NME";break;case 1:t="NORMAL";break;case 2:t="TANGENT";break;case 4:t="UV1";break;case 5:t="UV2";break;case 6:t="UV3";break;case 7:t="UV4";break;case 8:t="UV5";break;case 9:t="UV6"}let i=e._declareOutput(this.output);return t&&(e.compilationString+=`#ifdef ${t}
`),e.compilationString+=`${i} = ${this.input.associatedVariableName};
`,t&&(e.compilationString+=`#else
`,e.compilationString+=`${i} = ${this.fallback.associatedVariableName};
`,e.compilationString+=`#endif
`),this}serialize(){let e=super.serialize();return e.attributeType=this.attributeType,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.attributeType=e.attributeType??0}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.attributeType = ${this.attributeType};
`}}(0,r$.gn)([lM("Attribute lookup",4,void 0,{notifiers:{update:!0},options:[{label:"(None)",value:0},{label:"Normal",value:1},{label:"Tangent",value:2},{label:"Vertex Color",value:3},{label:"UV1",value:4},{label:"UV2",value:5},{label:"UV3",value:6},{label:"UV4",value:7},{label:"UV5",value:8},{label:"UV6",value:9}]})],hz.prototype,"attributeType",void 0),(0,i3.H7)("BABYLON.MeshAttributeExistsBlock",hz),(em=ii||(ii={}))[em.EaseInSine=0]="EaseInSine",em[em.EaseOutSine=1]="EaseOutSine",em[em.EaseInOutSine=2]="EaseInOutSine",em[em.EaseInQuad=3]="EaseInQuad",em[em.EaseOutQuad=4]="EaseOutQuad",em[em.EaseInOutQuad=5]="EaseInOutQuad",em[em.EaseInCubic=6]="EaseInCubic",em[em.EaseOutCubic=7]="EaseOutCubic",em[em.EaseInOutCubic=8]="EaseInOutCubic",em[em.EaseInQuart=9]="EaseInQuart",em[em.EaseOutQuart=10]="EaseOutQuart",em[em.EaseInOutQuart=11]="EaseInOutQuart",em[em.EaseInQuint=12]="EaseInQuint",em[em.EaseOutQuint=13]="EaseOutQuint",em[em.EaseInOutQuint=14]="EaseInOutQuint",em[em.EaseInExpo=15]="EaseInExpo",em[em.EaseOutExpo=16]="EaseOutExpo",em[em.EaseInOutExpo=17]="EaseInOutExpo",em[em.EaseInCirc=18]="EaseInCirc",em[em.EaseOutCirc=19]="EaseOutCirc",em[em.EaseInOutCirc=20]="EaseInOutCirc",em[em.EaseInBack=21]="EaseInBack",em[em.EaseOutBack=22]="EaseOutBack",em[em.EaseInOutBack=23]="EaseInOutBack",em[em.EaseInElastic=24]="EaseInElastic",em[em.EaseOutElastic=25]="EaseOutElastic",em[em.EaseInOutElastic=26]="EaseInOutElastic";class hH extends lP{constructor(e){super(e,tj.Neutral),this.type=ii.EaseInOutSine,this.registerInput("input",t$.AutoDetect),this.registerOutput("output",t$.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(t$.Matrix),this._inputs[0].excludedConnectionPointTypes.push(t$.Object),this._inputs[0].excludedConnectionPointTypes.push(t$.Int)}getClassName(){return"CurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_duplicateEntry(e,t){return`ret.${t} = ${e.replace(/VAL/g,"v."+t)}`}_duplicateEntryDirect(e){return`return ${e.replace(/VAL/g,"v")}`}_duplicateVector(e,t,i){if("float"===t||"f32"===t)return this._duplicateEntryDirect(e);let r=parseInt(t.replace("vec","")),s=i?`
            var ret: vec${r}f = vec${r}f(0.0);
        `:`
            vec${r} ret = vec${r}(0.0);
        `;for(let t=1;t<=r;t++)s+=this._duplicateEntry(e,1===t?"x":2===t?"y":3===t?"z":"w")+";\n";return s+"return ret;\n"}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i="",r="",s=e._getShaderType(this.input.type),n=1===e.shaderLanguage;switch(r=ii[this.type]+"_"+s.replace("<","").replace(">",""),this.type){case ii.EaseInSine:i="return 1.0 - cos((v * 3.1415) / 2.0)";break;case ii.EaseOutSine:i="return sin((v * 3.1415) / 2.0)";break;case ii.EaseInOutSine:i="return -(cos(v * 3.1415) - 1.0) / 2.0";break;case ii.EaseInQuad:i="return v * v";break;case ii.EaseOutQuad:i="return (1.0 - v) * (1.0 - v)";break;case ii.EaseInOutQuad:{let t=e._generateTernary("2.0 * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case ii.EaseInCubic:i="return v * v * v";break;case ii.EaseOutCubic:i=this._duplicateVector("1.0 - pow(1.0 - VAL, 3.0)",s,n);break;case ii.EaseInOutCubic:{let t=e._generateTernary("4.0 * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 3.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case ii.EaseInQuart:i="return v * v * v * v";break;case ii.EaseOutQuart:i=this._duplicateVector("1.0 - pow(1.0 - VAL, 4.0)",s,n);break;case ii.EaseInOutQuart:{let t=e._generateTernary("8.0 * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 4.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case ii.EaseInQuint:i="return v * v * v * v * v";break;case ii.EaseOutQuint:i=this._duplicateVector("1.0 - pow(1.0 - VAL, 5.0)",s,n);break;case ii.EaseInOutQuint:{let t=e._generateTernary("16.0 * VAL * VAL * VAL * VAL * VAL","1.0 - pow(-2.0 * VAL + 2.0, 5.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case ii.EaseInExpo:{let t=e._generateTernary("0.0","pow(2.0, 10.0 * VAL - 10.0)","VAL == 0.0");i=this._duplicateVector(t,s,n);break}case ii.EaseOutExpo:{let t=e._generateTernary("1.0","1.0 - pow(2.0, -10.0 * VAL)","VAL == 1.0");i=this._duplicateVector(t,s,n);break}case ii.EaseInOutExpo:{let t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("pow(2.0, 20.0 * VAL - 10.0) / 2.0","(2.0 - pow(2.0, -20.0 * VAL + 10.0)) / 2.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n);break}case ii.EaseInCirc:i=this._duplicateVector("1.0 - sqrt(1.0 - pow(VAL, 2.0))",s,n);break;case ii.EaseOutCirc:i=this._duplicateVector("sqrt(1.0 - pow(VAL - 1.0, 2.0))",s,n);break;case ii.EaseInOutCirc:{let t=e._generateTernary("(1.0 - sqrt(1.0 - pow(2.0 * VAL, 2.0))) / 2.0","(sqrt(1.0 - pow(-2.0 * VAL + 2.0, 2.0)) + 1.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case ii.EaseInBack:i="return 2.70158 * v * v * v - 1.70158 * v * v";break;case ii.EaseOutBack:i=this._duplicateVector("2.70158 * pow(VAL - 1.0, 3.0) + 1.70158 * pow(VAL - 1.0, 2.0)",s,n);break;case ii.EaseInOutBack:{let t=e._generateTernary("(pow(2.0 * VAL, 2.0) * ((3.5949095) * 2.0 * VAL - 2.5949095)) / 2.0","(pow(2.0 * VAL - 2.0, 2.0) * (3.5949095 * (VAL * 2.0 - 2.0) + 3.5949095) + 2.0) / 2.0","VAL < 0.5");i=this._duplicateVector(t,s,n);break}case ii.EaseInElastic:{let t=e._generateTernary("0.0",e._generateTernary("1.0","-pow(2.0, 10.0 * VAL - 10.0) * sin((VAL * 10.0 - 10.75) * ((2.0 * 3.1415) / 3.0))","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n);break}case ii.EaseOutElastic:{let t=e._generateTernary("0.0",e._generateTernary("1.0","pow(2.0, -10.0 * VAL) * sin((VAL * 10.0 - 0.75) * ((2.0 * 3.1415) / 3.0)) + 1.0","VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n);break}case ii.EaseInOutElastic:{let t=e._generateTernary("0.0",e._generateTernary("1.0",e._generateTernary("-(pow(2.0, 20.0 * VAL - 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0","(pow(2.0, -20.0 * VAL + 10.0) * sin((20.0 * VAL - 11.125) * ((2.0 * 3.1415) / 4.5))) / 2.0 + 1.0","VAL < 0.5"),"VAL == 1.0"),"VAL == 0.0");i=this._duplicateVector(t,s,n)}}return n?e._emitFunction(r,`fn ${r}(v: ${s}) -> ${s}  {${i};}
`,""):e._emitFunction(r,`${s} ${r}(${s} v) {${i};}
`,""),e.compilationString+=e._declareOutput(t)+` = ${r}(${this.input.associatedVariableName});
`,this}serialize(){let e=super.serialize();return e.curveType=this.type,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.CurveBlockTypes.${ii[this.type]};
`}}(0,i3.H7)("BABYLON.CurveBlock",hH);class hW extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("rgb ",t$.Color3,!0),this.registerInput("hsl ",t$.Color3,!0),this.registerOutput("rgb",t$.Color3),this.registerOutput("hsl",t$.Color3)}getClassName(){return"ColorConverterBlock"}get rgbIn(){return this._inputs[0]}get hslIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get hslOut(){return this._outputs[1]}_inputRename(e){return"rgb "===e?"rgbIn":"hsl "===e?"hslIn":e}_buildBlock(e){super._buildBlock(e);let t=this.rgbIn,i=this.hslIn,r=this._outputs[0],s=this._outputs[1],n=e._getShaderType(t$.Vector3),a=`
            vec3 rgb2hsl(vec3 color) {
                float r = color.r;
                float g = color.g;
                float b = color.b;

                float maxc = max(r, max(g, b));
                float minc = min(r, min(g, b));
                float h = 0.0;
                float s = 0.0;
                float l = (maxc + minc) / 2.0;

                if (maxc != minc) {
                    float d = maxc - minc;
                    if (l > 0.5) {
                        s = d / (2.0 - maxc - minc);
                    } else {
                        s = d / (maxc + minc);
                    }

                    if (maxc == r) {
                        float add = 0.0;
                        if (g < b) {
                            add = 6.0;
                        }
                        h = (g - b) / d + add;
                    } else if (maxc == g) {
                        h = (b - r) / d + 2.0;
                    } else if (maxc == b) {
                        h = (r - g) / d + 4.0;
                    }
                    h /= 6.0;
                }

                return vec3(h, s, l);
            }`,o=`
            float hue2rgb(float p, float q, float tt) {
                float t = tt;
                if (t < 0.0) {
                    t += 1.0;
                }
                if (t > 1.0) {
                    t -= 1.0;
                }
                if (t < 1.0/6.0) {
                    return p + (q - p) * 6.0 * t;
                }
                if (t < 1.0/2.0) {
                    return q;
                }
                if (t < 2.0/3.0) {
                    return p + (q - p) * (2.0/3.0 - t) * 6.0;
                }
                return p;
            }`,l=`
            vec3 hsl2rgb(vec3 hsl) {
                float h = hsl.x;
                float s = hsl.y;
                float l = hsl.z;

                float r;
                float g;
                float b;

                if (s == 0.0) {
                    // Achromatic (grey)
                    r = l;
                    g = l;
                    b = l; 
                } else {
                    float q;
                
                    if (l < 0.5) {
                        q = l * (1.0 + s);
                    } else {
                        q = (l + s - l * s);
                    }

                    float p = 2.0 * l - q;

                    r = hue2rgb(p, q, h + 1.0/3.0);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1.0/3.0);
                }

                return vec3(r, g, b);
            }`;return 1===e.shaderLanguage&&(a=e._babylonSLtoWGSL(a),o=e._babylonSLtoWGSL(o),l=e._babylonSLtoWGSL(l)),e._emitFunction("rgb2hsl",a,""),e._emitFunction("hue2rgb",o,""),e._emitFunction("hsl2rgb",l,""),t.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = ${t.associatedVariableName};
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = rgb2hsl(${t.associatedVariableName});
`)):i.isConnected?(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` = hsl2rgb(${i.associatedVariableName});
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` = ${i.associatedVariableName};
`)):(r.hasEndpoints&&(e.compilationString+=e._declareOutput(r)+` =  ${n}(0.);
`),s.hasEndpoints&&(e.compilationString+=e._declareOutput(s)+` =  ${n}(0.);
`)),this}}(0,i3.H7)("BABYLON.ColorConverterBlock",hW);class hY extends lP{constructor(e){super(e,tj.Neutral),this.iterations=4,this.registerInput("input",t$.AutoDetect),this.registerInput("iterations",t$.Float,!0),this.registerOutput("output",t$.BasedOnInput),this.registerOutput("index",t$.Float,tj.Fragment),this.registerOutput("loopID",t$.Object,void 0,new ug("loopID",this,1,hY,"LoopBlock")),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0]._forPostBuild=!0,this._outputs[2]._redirectedSource=this._inputs[0],this._outputs[1]._preventBubbleUp=!0,this._outputs[2]._preventBubbleUp=!0}getClassName(){return"LoopBlock"}get input(){return this._inputs[0]}get iterationsInput(){return this._inputs[1]}get output(){return this._outputs[0]}get index(){return this._outputs[1]}get loopID(){return this._outputs[2]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._outputs[1],r=e._getFreeVariableName("index"),s=1===e.shaderLanguage?"var":"int",n=1===e.shaderLanguage?"f32":"float",a=1===e.shaderLanguage?"i32":"int";e.compilationString+=e._declareOutput(t)+` = ${this.input.associatedVariableName};
`;let o=this.iterationsInput.isConnected?`${a}(${this.iterationsInput.associatedVariableName})`:this.iterations;return e.compilationString+=`for (${s} ${r} = 0; ${r} < ${o}; ${r}++){
`,e.compilationString+=`${e._declareOutput(i)} = ${n}(${r});
`,this}_postBuildBlock(e){return super._postBuildBlock(e),e.compilationString+=`}
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.iterations = ${this.iterations};
`}serialize(){let e=super.serialize();return e.iterations=this.iterations,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.iterations=e.iterations}}(0,r$.gn)([lM("Iterations",2)],hY.prototype,"iterations",void 0),(0,i3.H7)("BABYLON.LoopBlock",hY);class hX extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("loopID",t$.Object,!1,void 0,new ug("loopID",this,0,hY,"LoopBlock")),this.registerOutput("value",t$.AutoDetect),this._outputs[0]._linkedConnectionSource=this._inputs[0]}getClassName(){return"StorageReadBlock"}get loopID(){return this._inputs[0]}get value(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this.value;if(!this.loopID.isConnected)return this;let i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=e._declareOutput(t)+` = ${i.output.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.StorageReadBlock",hX);class h$ extends lP{constructor(e){super(e,tj.Neutral),this.registerInput("loopID",t$.Object,!1,void 0,new ug("loopID",this,0,hY,"LoopBlock")),this.registerInput("value",t$.AutoDetect),this._linkConnectionTypes(0,1)}getClassName(){return"StorageWriteBlock"}get loopID(){return this._inputs[0]}get value(){return this._inputs[1]}isConnectedInFragmentShader(){return!!this.loopID.isConnected&&this.loopID.connectedPoint.ownerBlock.output.isConnectedInFragmentShader}_buildBlock(e){super._buildBlock(e);let t=this.value;if(!this.loopID.isConnected)return this;let i=this.loopID.connectedPoint.ownerBlock;return e.compilationString+=`${i.output.associatedVariableName} = ${t.associatedVariableName};
`,this}}(0,i3.H7)("BABYLON.StorageWriteBlock",h$);var hj=i(25675),hq=i(65940);i(32365),(e_=ir||(ir={}))[e_.Created=1]="Created",e_[e_.Disposed=2]="Disposed",e_[e_.GetDefineNames=4]="GetDefineNames",e_[e_.PrepareUniformBuffer=8]="PrepareUniformBuffer",e_[e_.IsReadyForSubMesh=16]="IsReadyForSubMesh",e_[e_.PrepareDefines=32]="PrepareDefines",e_[e_.BindForSubMesh=64]="BindForSubMesh",e_[e_.PrepareEffect=128]="PrepareEffect",e_[e_.GetAnimatables=256]="GetAnimatables",e_[e_.GetActiveTextures=512]="GetActiveTextures",e_[e_.HasTexture=1024]="HasTexture",e_[e_.FillRenderTargetTextures=2048]="FillRenderTargetTextures",e_[e_.HasRenderTargetTextures=4096]="HasRenderTargetTextures",e_[e_.HardBindForSubMesh=8192]="HardBindForSubMesh",i(33776);class hQ extends o5.H{constructor(){super(...arguments),this.DECAL=!1,this.DECALDIRECTUV=0,this.DECAL_SMOOTHALPHA=!1,this.GAMMADECAL=!1}}class hK extends hq.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e,t=!0){super(e,"DecalMap",150,new hQ,t),this._isEnabled=!1,this.isEnabled=!1,this._smoothAlpha=!1,this.smoothAlpha=!1,this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}isReadyForSubMesh(e,t,i,r){let s=r.getMesh().decalMap;return!(this._isEnabled&&s?.texture)||!o6.k.DecalMapEnabled||!t.texturesEnabled||s.isReady()}prepareDefinesBeforeAttributes(e,t,i){let r=i.decalMap;this._isEnabled&&r?.texture&&o6.k.DecalMapEnabled&&t.texturesEnabled?(e.DECAL&&e.GAMMADECAL===r.texture.gammaSpace||e.markAsTexturesDirty(),e.DECAL=!0,e.GAMMADECAL=r.texture.gammaSpace,e.DECAL_SMOOTHALPHA=this._smoothAlpha,(0,le.lw)(r.texture,e,"DECAL")):(e.DECAL&&e.markAsTexturesDirty(),e.DECAL=!1)}hardBindForSubMesh(e,t,i,r){let s=r.getMesh().decalMap;if(!this._isEnabled||!s?.texture||!o6.k.DecalMapEnabled||!t.texturesEnabled)return;let n=this._material.isFrozen,a=s.texture;e.useUbo&&n&&e.isSync||(e.updateFloat4("vDecalInfos",a.coordinatesIndex,0,0,0),(0,le.NL)(a,e,"decal")),e.setTexture("decalSampler",a)}getClassName(){return"DecalMapConfiguration"}getSamplers(e){e.push("decalSampler")}getUniforms(){return{ubo:[{name:"vDecalInfos",size:4,type:"vec4"},{name:"decalMatrix",size:16,type:"mat4"}]}}}(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],hK.prototype,"isEnabled",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],hK.prototype,"smoothAlpha",void 0),(0,i3.H7)("BABYLON.DecalMapConfiguration",hK),i(30362);class hZ{}hZ.DEFAULT_COLOR=i2.Wo.White(),hZ.DEFAULT_WIDTH_ATTENUATED=1,hZ.DEFAULT_WIDTH=.1;var hJ=i(67351);class h0{static ConvertPoints(e,t){if(e.length&&Array.isArray(e)&&"number"==typeof e[0])return[e];if(e.length&&Array.isArray(e[0])&&"number"==typeof e[0][0])return e;if(e.length&&!Array.isArray(e[0])&&e[0]instanceof i1.P){let t=[];for(let i=0;i<e.length;i++){let r=e[i];t.push(r.x,r.y,r.z)}return[t]}if(e.length>0&&Array.isArray(e[0])&&e[0].length>0&&e[0][0]instanceof i1.P){let t=[];return e.forEach(e=>{t.push(e.flatMap(e=>[e.x,e.y,e.z]))}),t}if(e instanceof Float32Array){if(!t?.floatArrayStride)return[Array.from(e)];{let i=[],r=3*t.floatArrayStride;for(let t=0;t<e.length;t+=r){let s=Array(r);for(let i=0;i<r;i++)s[i]=e[t+i];i.push(s)}return i}}if(e.length&&e[0]instanceof Float32Array){let t=[];return e.forEach(e=>{t.push(Array.from(e))}),t}return[]}static OmitZeroLengthPredicate(e,t,i){let r=[];return t.subtract(e).lengthSquared()>0&&r.push([e,t]),i.subtract(t).lengthSquared()>0&&r.push([t,i]),e.subtract(i).lengthSquared()>0&&r.push([i,e]),0===r.length?null:r}static OmitDuplicatesPredicate(e,t,i,r){let s=[];return h0._SearchInPoints(e,t,r)||s.push([e,t]),h0._SearchInPoints(t,i,r)||s.push([t,i]),h0._SearchInPoints(i,e,r)||s.push([i,e]),0===s.length?null:s}static _SearchInPoints(e,t,i){for(let r of i)for(let i=0;i<r.length;i++)if(r[i]?.equals(e)&&(r[i+1]?.equals(t)||r[i-1]?.equals(t)))return!0;return!1}static MeshesToLines(e,t){let i=[];return e.forEach((e,r)=>{let s=e.getVerticesData(st.o.PositionKind),n=e.getIndices();if(s&&n)for(let a=0,o=0;a<n.length;a++){let l=3*n[o++],c=3*n[o++],u=3*n[o++],h=new i1.P(s[l],s[l+1],s[l+2]),d=new i1.P(s[c],s[c+1],s[c+2]),f=new i1.P(s[u],s[u+1],s[u+2]);if(t){let o=t(h,d,f,i,a,l,e,r,s,n);if(o)for(let e of o)i.push(e)}else i.push([h,d],[d,f],[f,h])}}),i}static ToVector3Array(e){if(Array.isArray(e[0])){let t=[];for(let i of e){let e=[];for(let t=0;t<i.length;t+=3)e.push(new i1.P(i[t],i[t+1],i[t+2]));t.push(e)}return t}let t=[];for(let i=0;i<e.length;i+=3)t.push(new i1.P(e[i],e[i+1],e[i+2]));return t}static ToNumberArray(e){return e.flatMap(e=>[e.x,e.y,e.z])}static GetPointsCountInfo(e){let t=Array(e.length),i=0;for(let r=e.length;r--;)t[r]=e[r].length/3,i+=t[r];return{total:i,counts:t}}static GetLineLength(e){let t;if(0===e.length)return 0;t="number"==typeof e[0]?h0.ToVector3Array(e):e;let i=i1.jp.Vector3[0],r=0;for(let e=0;e<t.length-1;e++){let s=t[e];r+=t[e+1].subtractToRef(s,i).length()}return r}static GetLineLengthArray(e){let t=new Float32Array(e.length/3),i=0;for(let r=0,s=e.length/3-1;r<s;r++){let s=e[3*r+0],n=e[3*r+1],a=e[3*r+2];s-=e[3*r+3],n-=e[3*r+4],i+=Math.sqrt(s*s+n*n+(a-=e[3*r+5])*a),t[r+1]=i}return t}static SegmentizeSegmentByCount(e,t,i){let r=[],s=t.subtract(e),n=i1.jp.Vector3[0];n.setAll(i);let a=i1.jp.Vector3[1];s.divideToRef(n,a);let o=e.clone();r.push(o);for(let e=0;e<i;e++)r.push((o=o.clone()).addInPlace(a));return r}static SegmentizeLineBySegmentLength(e,t){let i=e[0]instanceof i1.P?h0.GetLineSegments(e):"number"==typeof e[0]?h0.GetLineSegments(h0.ToVector3Array(e)):e,r=[];return i.forEach(e=>{e.length>t?h0.SegmentizeSegmentByCount(e.point1,e.point2,Math.ceil(e.length/t)).forEach(e=>{r.push(e)}):(r.push(e.point1),r.push(e.point2))}),r}static SegmentizeLineBySegmentCount(e,t){let i="number"==typeof e[0]?h0.ToVector3Array(e):e,r=h0.GetLineLength(i)/t;return h0.SegmentizeLineBySegmentLength(i,r)}static GetLineSegments(e){let t=[];for(let i=0;i<e.length-1;i++){let r=e[i],s=e[i+1],n=s.subtract(r).length();t.push({point1:r,point2:s,length:n})}return t}static GetMinMaxSegmentLength(e){let t=h0.GetLineSegments(e).sort(e=>e.length);return{min:t[0].length,max:t[t.length-1].length}}static GetPositionOnLineByVisibility(e,t,i,r=!1){let s=t*i,n=0,a=0,o=e.length;for(let t=0;t<o;t++){if(s<=n+e[t].length){a=t;break}n+=e[t].length}let l=(s-n)/e[a].length;return e[a].point2.subtractToRef(e[a].point1,i1.jp.Vector3[0]),i1.jp.Vector3[1]=i1.jp.Vector3[0].multiplyByFloats(l,l,l),r||i1.jp.Vector3[1].addInPlace(e[a].point1),i1.jp.Vector3[1].clone()}static GetCircleLinePoints(e,t,i=0,r=e,s=2*Math.PI/t){let n=[];for(let a=0;a<=t;a++)n.push(new i1.P(Math.cos(a*s)*e,Math.sin(a*s)*r,i));return n}static GetBezierLinePoints(e,t,i,r){return rv.j_.CreateQuadraticBezier(e,t,i,r).getPoints().flatMap(e=>[e.x,e.y,e.z])}static GetArrowCap(e,t,i,r,s,n=0,a=0){return{points:[e.clone(),e.add(t.multiplyByFloats(i,i,i))],widths:[r,s,n,a]}}static GetPointsFromText(e,t,i,r,s=0,n=!0){let a=[];for(let o of(0,hJ.v)(e,t,i,r)){for(let e of o.paths){let t=[];for(let i of e.getPoints())t.push(i.x,i.y,s);a.push(t)}if(n)for(let e of o.holes){let t=[];for(let i of e.getPoints())t.push(i.x,i.y,s);a.push(t)}}return a}static Color3toRGBAUint8(e){let t=new Uint8Array(4*e.length);for(let i=0,r=0;i<e.length;i++)t[r++]=255*e[i].r,t[r++]=255*e[i].g,t[r++]=255*e[i].b,t[r++]=255;return t}static CreateColorsTexture(e,t,i,r){let s=r.getEngine().getCaps().maxTextureSize??1,n=t.length>s?s:t.length,a=Math.ceil(t.length/s);a>1&&(t=[...t,...Array(n*a-t.length).fill(t[0])]);let o=h0.Color3toRGBAUint8(t),l=new rK.l(o,n,a,sJ.D.TEXTUREFORMAT_RGBA,r,!1,!0,i);return l.name=e,l}static PrepareEmptyColorsTexture(e){if(!hZ.EmptyColorsTexture){let t=new Uint8Array(4);hZ.EmptyColorsTexture=new rK.l(t,1,1,sJ.D.TEXTUREFORMAT_RGBA,e,!1,!1,rK.l.NEAREST_NEAREST),hZ.EmptyColorsTexture.name="grlEmptyColorsTexture"}return hZ.EmptyColorsTexture}static DisposeEmptyColorsTexture(){hZ.EmptyColorsTexture?.dispose(),hZ.EmptyColorsTexture=null}static BooleanToNumber(e){return e?1:0}}class h1 extends o5.H{constructor(){super(...arguments),this.GREASED_LINE_HAS_COLOR=!1,this.GREASED_LINE_SIZE_ATTENUATION=!1,this.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=!1,this.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=!1,this.GREASED_LINE_CAMERA_FACING=!0}}class h2 extends hq.n{constructor(e,t,i){i=i||{color:hZ.DEFAULT_COLOR};let r=new h1;r.GREASED_LINE_HAS_COLOR=!!i.color&&!i.useColors,r.GREASED_LINE_SIZE_ATTENUATION=i.sizeAttenuation??!1,r.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===i.colorDistributionType,r.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=(t??e.getScene()).useRightHandedSystem,r.GREASED_LINE_CAMERA_FACING=i.cameraFacing??!0,super(e,h2.GREASED_LINE_MATERIAL_NAME,200,r),this.colorsTexture=null,this._scene=t??e.getScene(),this._engine=this._scene.getEngine(),this._cameraFacing=i.cameraFacing??!0,this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.width=i.width?i.width:i.sizeAttenuation?hZ.DEFAULT_WIDTH_ATTENUATED:hZ.DEFAULT_WIDTH,this._sizeAttenuation=i.sizeAttenuation??!1,this.colorMode=i.colorMode??0,this._color=i.color??null,this.useColors=i.useColors??!1,this._colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??rK.l.NEAREST_NEAREST,this._colors=i.colors??null,this.dashCount=i.dashCount??1,this.resolution=i.resolution??new i1.FM(this._engine.getRenderWidth(),this._engine.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this._colors?this.colorsTexture=h0.CreateColorsTexture(`${e.name}-colors-texture`,this._colors,this.colorsSampling,this._scene):(this._color=this._color??hZ.DEFAULT_COLOR,h0.PrepareEmptyColorsTexture(this._scene)),this._engine.onDisposeObservable.add(()=>{h0.DisposeEmptyColorsTexture()}),this._enable(!0)}getAttributes(e){e.push("grl_offsets"),e.push("grl_widths"),e.push("grl_colorPointers"),e.push("grl_counters"),this._cameraFacing?(e.push("grl_previousAndSide"),e.push("grl_nextAndCounters")):e.push("grl_slopes")}getSamplers(e){e.push("grl_colors")}getActiveTextures(e){this.colorsTexture&&e.push(this.colorsTexture)}getUniforms(){let e=[{name:"grl_singleColor",size:3,type:"vec3"},{name:"grl_textureSize",size:2,type:"vec2"},{name:"grl_dashOptions",size:4,type:"vec4"},{name:"grl_colorMode_visibility_colorsWidth_useColors",size:4,type:"vec4"}];return this._cameraFacing&&e.push({name:"grl_projection",size:16,type:"mat4"},{name:"grl_aspect_resolution_lineWidth",size:4,type:"vec4"}),{ubo:e,vertex:this._cameraFacing?`
                uniform vec4 grl_aspect_resolution_lineWidth;
                uniform mat4 grl_projection;
                `:"",fragment:`
                uniform vec4 grl_dashOptions;
                uniform vec2 grl_textureSize;
                uniform vec4 grl_colorMode_visibility_colorsWidth_useColors;
                uniform vec3 grl_singleColor;
                `}}get isEnabled(){return!0}bindForSubMesh(e){if(this._cameraFacing){let t=this._scene.activeCamera;if(t){let i=t.getProjectionMatrix();e.updateMatrix("grl_projection",i)}else throw Error("GreasedLinePluginMaterial requires an active camera.");let i=i1.jp.Vector4[0];i.x=this._aspect,i.y=this._resolution.x,i.z=this._resolution.y,i.w=this.width,e.updateVector4("grl_aspect_resolution_lineWidth",i)}let t=i1.jp.Vector4[0];t.x=h0.BooleanToNumber(this.useDash),t.y=this._dashArray,t.z=this.dashOffset,t.w=this.dashRatio,e.updateVector4("grl_dashOptions",t);let i=i1.jp.Vector4[1];i.x=this.colorMode,i.y=this.visibility,i.z=this.colorsTexture?this.colorsTexture.getSize().width:0,i.w=h0.BooleanToNumber(this.useColors),e.updateVector4("grl_colorMode_visibility_colorsWidth_useColors",i),this._color&&e.updateColor3("grl_singleColor",this._color);let r=this.colorsTexture??hZ.EmptyColorsTexture;e.setTexture("grl_colors",r),e.updateFloat2("grl_textureSize",r?.getSize().width??1,r?.getSize().height??1)}prepareDefines(e,t,i){e.GREASED_LINE_HAS_COLOR=!!this.color&&!this.useColors,e.GREASED_LINE_SIZE_ATTENUATION=this._sizeAttenuation,e.GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE=1===this._colorsDistributionType,e.GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM=t.useRightHandedSystem,e.GREASED_LINE_CAMERA_FACING=this._cameraFacing}getClassName(){return h2.GREASED_LINE_MATERIAL_NAME}getCustomCode(e){if("vertex"===e){let e={CUSTOM_VERTEX_DEFINITIONS:`
                attribute float grl_widths;
                attribute vec3 grl_offsets;
                attribute float grl_colorPointers;
                varying float grlCounters;
                varying float grlColorPointer;

                #ifdef GREASED_LINE_CAMERA_FACING
                    attribute vec4 grl_previousAndSide;
                    attribute vec4 grl_nextAndCounters;

                    vec2 grlFix( vec4 i, float aspect ) {
                        vec2 res = i.xy / i.w;
                        res.x *= aspect;
                        return res;
                    }
                #else
                    attribute vec3 grl_slopes;
                    attribute float grl_counters;
                #endif
                `,CUSTOM_VERTEX_UPDATE_POSITION:`
                #ifdef GREASED_LINE_CAMERA_FACING
                    vec3 grlPositionOffset = grl_offsets;
                    positionUpdated += grlPositionOffset;
                #else
                    positionUpdated = (positionUpdated + grl_offsets) + (grl_slopes * grl_widths);
                #endif
                `,CUSTOM_VERTEX_MAIN_END:`
                grlColorPointer = grl_colorPointers;

                #ifdef GREASED_LINE_CAMERA_FACING

                    float grlAspect = grl_aspect_resolution_lineWidth.x;
                    float grlBaseWidth = grl_aspect_resolution_lineWidth.w;


                    vec3 grlPrevious = grl_previousAndSide.xyz;
                    float grlSide = grl_previousAndSide.w;

                    vec3 grlNext = grl_nextAndCounters.xyz;
                    grlCounters = grl_nextAndCounters.w;

                    mat4 grlMatrix = viewProjection * finalWorld;
                    vec4 grlFinalPosition = grlMatrix * vec4( positionUpdated , 1.0 );
                    vec4 grlPrevPos = grlMatrix * vec4( grlPrevious + grlPositionOffset, 1.0 );
                    vec4 grlNextPos = grlMatrix * vec4( grlNext + grlPositionOffset, 1.0 );

                    vec2 grlCurrentP = grlFix( grlFinalPosition, grlAspect );
                    vec2 grlPrevP = grlFix( grlPrevPos, grlAspect );
                    vec2 grlNextP = grlFix( grlNextPos, grlAspect );

                    float grlWidth = grlBaseWidth * grl_widths;

                    vec2 grlDir;
                    if( grlNextP == grlCurrentP ) grlDir = normalize( grlCurrentP - grlPrevP );
                    else if( grlPrevP == grlCurrentP ) grlDir = normalize( grlNextP - grlCurrentP );
                    else {
                        vec2 grlDir1 = normalize( grlCurrentP - grlPrevP );
                        vec2 grlDir2 = normalize( grlNextP - grlCurrentP );
                        grlDir = normalize( grlDir1 + grlDir2 );
                    }
                    vec4 grlNormal = vec4( -grlDir.y, grlDir.x, 0., 1. );
                    #ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
                        grlNormal.xy *= -.5 * grlWidth;
                    #else
                        grlNormal.xy *= .5 * grlWidth;
                    #endif

                    grlNormal *= grl_projection;

                    #ifdef GREASED_LINE_SIZE_ATTENUATION
                        grlNormal.xy *= grlFinalPosition.w;
                        grlNormal.xy /= ( vec4( grl_aspect_resolution_lineWidth.yz, 0., 1. ) * grl_projection ).xy;
                    #endif

                    grlFinalPosition.xy += grlNormal.xy * grlSide;
                    gl_Position = grlFinalPosition;

                    vPositionW = vec3(grlFinalPosition);
                #else
                    grlCounters = grl_counters;
                #endif
                `};return this._cameraFacing&&(e["!gl_Position\\=viewProjection\\*worldPos;"]="//"),e}return"fragment"===e?{CUSTOM_FRAGMENT_DEFINITIONS:`
                    varying float grlCounters;
                    varying float grlColorPointer;
                    uniform sampler2D grl_colors;
                `,CUSTOM_FRAGMENT_MAIN_END:`
                    float grlColorMode = grl_colorMode_visibility_colorsWidth_useColors.x;
                    float grlVisibility = grl_colorMode_visibility_colorsWidth_useColors.y;
                    float grlColorsWidth = grl_colorMode_visibility_colorsWidth_useColors.z;
                    float grlUseColors = grl_colorMode_visibility_colorsWidth_useColors.w;

                    float grlUseDash = grl_dashOptions.x;
                    float grlDashArray = grl_dashOptions.y;
                    float grlDashOffset = grl_dashOptions.z;
                    float grlDashRatio = grl_dashOptions.w;

                    gl_FragColor.a *= step(grlCounters, grlVisibility);
                    if( gl_FragColor.a == 0. ) discard;

                    if(grlUseDash == 1.){
                        gl_FragColor.a *= ceil(mod(grlCounters + grlDashOffset, grlDashArray) - (grlDashArray * grlDashRatio));
                        if (gl_FragColor.a == 0.) discard;
                    }

                    #ifdef GREASED_LINE_HAS_COLOR
                        if (grlColorMode == 0.) {
                            gl_FragColor.rgb = grl_singleColor;
                        } else if (grlColorMode == 1.) {
                            gl_FragColor.rgb += grl_singleColor;
                        } else if (grlColorMode == 2.) {
                            gl_FragColor.rgb *= grl_singleColor;
                        }
                    #else
                        if (grlUseColors == 1.) {
                            #ifdef GREASED_LINE_COLOR_DISTRIBUTION_TYPE_LINE
                                vec4 grlColor = texture2D(grl_colors, vec2(grlCounters, 0.), 0.);
                            #else
                                vec2 lookup = vec2(fract(grlColorPointer / grl_textureSize.x), 1.0 - floor(grlColorPointer / grl_textureSize.x) / max(grl_textureSize.y - 1.0, 1.0));
                                vec4 grlColor = texture2D(grl_colors, lookup, 0.0);
                            #endif
                            if (grlColorMode == 0.) {
                                gl_FragColor = grlColor;
                            } else if (grlColorMode == 1.) {
                                gl_FragColor += grlColor;
                            } else if (grlColorMode == 2.) {
                                gl_FragColor *= grlColor;
                            }
                        }
                    #endif

                `}:null}dispose(){this.colorsTexture?.dispose(),super.dispose()}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){let r=this._colors?.length??0;if(this._colors=e,null===e||0===e.length){this.colorsTexture?.dispose();return}if(!t||i){if(this.colorsTexture&&r===e.length&&!i){let t=h0.Color3toRGBAUint8(e);this.colorsTexture.update(t)}else this.colorsTexture?.dispose(),this.colorsTexture=h0.CreateColorsTexture(`${this._material.name}-colors-texture`,e,this.colorsSampling,this._scene)}}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.markAllDefinesAsDirty()}get color(){return this._color}set color(e){this.setColor(e)}setColor(e,t=!1){null===this._color&&null!==e||null!==this._color&&null===e?(this._color=e,t||this.markAllDefinesAsDirty()):this._color=e}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this.markAllDefinesAsDirty()}get resolution(){return this._resolution}set resolution(e){this._aspect=e.x/e.y,this._resolution=e}serialize(){let e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this.colorsSampling,colorMode:this.colorMode,dashCount:this._dashCount,dashOffset:this.dashOffset,dashRatio:this.dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this.useColors,useDash:this.useDash,visibility:this.visibility,width:this.width};return this._colors&&(t.colors=this._colors),this._color&&(t.color=this._color),e.greasedLineMaterialOptions=t,e}parse(e,t,i){super.parse(e,t,i);let r=e.greasedLineMaterialOptions;this.colorsTexture?.dispose(),r.color&&this.setColor(r.color,!0),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colors&&(this.colors=r.colors),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),this.colors?this.colorsTexture=h0.CreateColorsTexture(`${this._material.name}-colors-texture`,this.colors,this.colorsSampling,t):h0.PrepareEmptyColorsTexture(t),this.markAllDefinesAsDirty()}copyTo(e){e.colorsTexture?.dispose(),this._colors&&(e.colorsTexture=h0.CreateColorsTexture(`${e._material.name}-colors-texture`,this._colors,e.colorsSampling,this._scene)),e.setColor(this.color,!0),e.colorsDistributionType=this.colorsDistributionType,e.colorsSampling=this.colorsSampling,e.colorMode=this.colorMode,e.useColors=this.useColors,e.visibility=this.visibility,e.useDash=this.useDash,e.dashCount=this.dashCount,e.dashRatio=this.dashRatio,e.dashOffset=this.dashOffset,e.width=this.width,e.sizeAttenuation=this.sizeAttenuation,e.resolution=this.resolution,e.markAllDefinesAsDirty()}}h2.GREASED_LINE_MATERIAL_NAME="GreasedLinePluginMaterial",(0,i3.H7)(`BABYLON.${h2.GREASED_LINE_MATERIAL_NAME}`,h2);let h3=`precision highp float;uniform sampler2D grlColors;uniform float grlUseColors;uniform float grlUseDash;uniform float grlDashArray;uniform float grlDashOffset;uniform float grlDashRatio;uniform float grlVisibility;uniform float grlColorsWidth;uniform vec2 grl_colorModeAndColorDistributionType;uniform vec3 grlColor;varying float grlCounters;varying float grlColorPointer;void main() {float grlColorMode=grl_colorModeAndColorDistributionType.x;float grlColorDistributionType=grl_colorModeAndColorDistributionType.y;gl_FragColor=vec4(grlColor,1.);gl_FragColor.a=step(grlCounters,grlVisibility);if (gl_FragColor.a==0.) discard;if( grlUseDash==1. ){gl_FragColor.a=ceil(mod(grlCounters+grlDashOffset,grlDashArray)-(grlDashArray*grlDashRatio));if (gl_FragColor.a==0.) discard;}
if (grlUseColors==1.) {vec4 textureColor;if (grlColorDistributionType==COLOR_DISTRIBUTION_TYPE_LINE) { 
textureColor=texture2D(grlColors,vec2(grlCounters,0.),0.);} else {textureColor=texture2D(grlColors,vec2(grlColorPointer/grlColorsWidth,0.),0.);}
if (grlColorMode==COLOR_MODE_SET) {gl_FragColor=textureColor;} else if (grlColorMode==COLOR_MODE_ADD) {gl_FragColor+=textureColor;} else if (grlColorMode==COLOR_MODE_MULTIPLY) {gl_FragColor*=textureColor;}}}
`;sG.v.ShadersStore.greasedLinePixelShader=h3,i(48714),i(85814);let h4=`precision highp float;
#include<instancesDeclaration>
attribute float grl_widths;attribute vec3 grl_offsets;attribute float grl_colorPointers;attribute vec3 position;uniform mat4 viewProjection;uniform mat4 projection;varying float grlCounters;varying float grlColorPointer;
#ifdef GREASED_LINE_CAMERA_FACING
attribute vec4 grl_nextAndCounters;attribute vec4 grl_previousAndSide;uniform vec2 grlResolution;uniform float grlAspect;uniform float grlWidth;uniform float grlSizeAttenuation;vec2 grlFix( vec4 i,float aspect ) {vec2 res=i.xy/i.w;res.x*=aspect;return res;}
#else
attribute vec3 grl_slopes;attribute float grl_counters;
#endif
void main() {
#include<instancesVertex>
grlColorPointer=grl_colorPointers;mat4 grlMatrix=viewProjection*finalWorld ;
#ifdef GREASED_LINE_CAMERA_FACING
float grlBaseWidth=grlWidth;vec3 grlPrevious=grl_previousAndSide.xyz;float grlSide=grl_previousAndSide.w;vec3 grlNext=grl_nextAndCounters.xyz;grlCounters=grl_nextAndCounters.w;vec3 grlPositionOffset=grl_offsets;vec4 grlFinalPosition=grlMatrix*vec4( position+grlPositionOffset ,1.0 );vec4 grlPrevPos=grlMatrix*vec4( grlPrevious+grlPositionOffset,1.0 );vec4 grlNextPos=grlMatrix*vec4( grlNext+grlPositionOffset,1.0 );vec2 grlCurrentP=grlFix( grlFinalPosition,grlAspect );vec2 grlPrevP=grlFix( grlPrevPos,grlAspect );vec2 grlNextP=grlFix( grlNextPos,grlAspect );float grlWidth=grlBaseWidth*grl_widths;vec2 grlDir;if( grlNextP==grlCurrentP ) grlDir=normalize( grlCurrentP-grlPrevP );else if( grlPrevP==grlCurrentP ) grlDir=normalize( grlNextP-grlCurrentP );else {vec2 grlDir1=normalize( grlCurrentP-grlPrevP );vec2 grlDir2=normalize( grlNextP-grlCurrentP );grlDir=normalize( grlDir1+grlDir2 );}
vec4 grlNormal=vec4( -grlDir.y,grlDir.x,0.,1. );
#ifdef GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM
grlNormal.xy*=-.5*grlWidth;
#else
grlNormal.xy*=.5*grlWidth;
#endif
grlNormal*=projection;if (grlSizeAttenuation==1.) {grlNormal.xy*=grlFinalPosition.w;grlNormal.xy/=( vec4( grlResolution,0.,1. )*projection ).xy;}
grlFinalPosition.xy+=grlNormal.xy*grlSide;gl_Position=grlFinalPosition;
#else
grlCounters=grl_counters;vec4 grlFinalPosition=grlMatrix*vec4( (position+grl_offsets)+grl_slopes*grl_widths ,1.0 ) ;gl_Position=grlFinalPosition;
#endif
}
`;sG.v.ShadersStore.greasedLineVertexShader=h4;class h5 extends nA.j{constructor(e,t,i){let r=["COLOR_DISTRIBUTION_TYPE_LINE 1.","COLOR_DISTRIBUTION_TYPE_SEGMENT 0.","COLOR_MODE_SET 0.","COLOR_MODE_ADD 1.","COLOR_MODE_MULTIPLY 2."],s=["position","grl_widths","grl_offsets","grl_colorPointers"];t.useRightHandedSystem&&r.push("GREASED_LINE_RIGHT_HANDED_COORDINATE_SYSTEM"),i.cameraFacing?(r.push("GREASED_LINE_CAMERA_FACING"),s.push("grl_previousAndSide","grl_nextAndCounters")):(s.push("grl_slopes"),s.push("grl_counters")),super(e,t,{vertex:"greasedLine",fragment:"greasedLine"},{attributes:s,uniforms:["world","viewProjection","view","projection","grlColorsWidth","grlUseColors","grlWidth","grlColor","grl_colorModeAndColorDistributionType","grlResolution","grlAspect","grlAizeAttenuation","grlDashArray","grlDashOffset","grlDashRatio","grlUseDash","grlVisibility"],samplers:["grlColors"],defines:r}),this._color=i2.Wo.White(),this._colorsDistributionType=0,this._colorsTexture=null,i=i||{color:hZ.DEFAULT_COLOR};let n=t.getEngine();this.visibility=i.visibility??1,this.useDash=i.useDash??!1,this.dashRatio=i.dashRatio??.5,this.dashOffset=i.dashOffset??0,this.dashCount=i.dashCount??1,this.width=i.width?i.width:i.sizeAttenuation&&i.cameraFacing?hZ.DEFAULT_WIDTH_ATTENUATED:hZ.DEFAULT_WIDTH,this.sizeAttenuation=i.sizeAttenuation??!1,this.color=i.color??i2.Wo.White(),this.useColors=i.useColors??!1,this.colorsDistributionType=i.colorDistributionType??0,this.colorsSampling=i.colorsSampling??rK.l.NEAREST_NEAREST,this.colorMode=i.colorMode??0,this._colors=i.colors??null,this._cameraFacing=i.cameraFacing??!0,this.resolution=i.resolution??new i1.FM(n.getRenderWidth(),n.getRenderHeight()),i.colorsTexture?this.colorsTexture=i.colorsTexture:this.colorsTexture=h0.PrepareEmptyColorsTexture(t),this._colors&&this.useColors&&(this.colorsTexture=h0.CreateColorsTexture(`${this.name}-colors-texture`,this._colors,this.colorsSampling,t)),n.onDisposeObservable.add(()=>{h0.DisposeEmptyColorsTexture()})}dispose(){this._colorsTexture?.dispose(),super.dispose()}_setColorModeAndColorDistributionType(){this.setVector2("grl_colorModeAndColorDistributionType",new i1.FM(this._colorMode,this._colorsDistributionType))}updateLazy(){this._colors&&this.setColors(this._colors,!1,!0)}get colors(){return this._colors}set colors(e){this.setColors(e)}setColors(e,t=!1,i=!1){let r=this._colors?.length??0;if(this._colors=e,null===e||0===e.length){this._colorsTexture?.dispose();return}if(!t||i){if(this._colorsTexture&&r===e.length&&!i){let t=h0.Color3toRGBAUint8(e);this._colorsTexture.update(t)}else this._colorsTexture?.dispose(),this.colorsTexture=h0.CreateColorsTexture(`${this.name}-colors-texture`,e,this.colorsSampling,this.getScene())}}get colorsTexture(){return this._colorsTexture??null}set colorsTexture(e){this._colorsTexture=e,this.setFloat("grlColorsWidth",this._colorsTexture.getSize().width),this.setTexture("grlColors",this._colorsTexture)}get width(){return this._width}set width(e){this._width=e,this.setFloat("grlWidth",e)}get useColors(){return this._useColors}set useColors(e){this._useColors=e,this.setFloat("grlUseColors",h0.BooleanToNumber(e))}get colorsSampling(){return this._colorsSampling}set colorsSampling(e){this._colorsSampling=e}get visibility(){return this._visibility}set visibility(e){this._visibility=e,this.setFloat("grlVisibility",e)}get useDash(){return this._useDash}set useDash(e){this._useDash=e,this.setFloat("grlUseDash",h0.BooleanToNumber(e))}get dashOffset(){return this._dashOffset}set dashOffset(e){this._dashOffset=e,this.setFloat("grlDashOffset",e)}get dashRatio(){return this._dashRatio}set dashRatio(e){this._dashRatio=e,this.setFloat("grlDashRatio",e)}get dashCount(){return this._dashCount}set dashCount(e){this._dashCount=e,this._dashArray=1/e,this.setFloat("grlDashArray",this._dashArray)}get sizeAttenuation(){return this._sizeAttenuation}set sizeAttenuation(e){this._sizeAttenuation=e,this.setFloat("grlSizeAttenuation",h0.BooleanToNumber(e))}get color(){return this._color}set color(e){this.setColor(e)}setColor(e){e=e??hZ.DEFAULT_COLOR,this._color=e,this.setColor3("grlColor",e)}get colorsDistributionType(){return this._colorsDistributionType}set colorsDistributionType(e){this._colorsDistributionType=e,this._setColorModeAndColorDistributionType()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=e,this._setColorModeAndColorDistributionType()}get resolution(){return this._resolution}set resolution(e){this._resolution=e,this.setVector2("grlResolution",e),this.setFloat("grlAspect",e.x/e.y)}serialize(){let e=super.serialize(),t={colorDistributionType:this._colorsDistributionType,colorsSampling:this._colorsSampling,colorMode:this._colorMode,color:this._color,dashCount:this._dashCount,dashOffset:this._dashOffset,dashRatio:this._dashRatio,resolution:this._resolution,sizeAttenuation:this._sizeAttenuation,useColors:this._useColors,useDash:this._useDash,visibility:this._visibility,width:this._width,cameraFacing:this._cameraFacing};return this._colors&&(t.colors=this._colors),e.greasedLineMaterialOptions=t,e}parse(e,t,i){let r=e.greasedLineMaterialOptions;this._colorsTexture?.dispose(),r.color&&(this.color=r.color),r.colorDistributionType&&(this.colorsDistributionType=r.colorDistributionType),r.colorsSampling&&(this.colorsSampling=r.colorsSampling),r.colorMode&&(this.colorMode=r.colorMode),r.useColors&&(this.useColors=r.useColors),r.visibility&&(this.visibility=r.visibility),r.useDash&&(this.useDash=r.useDash),r.dashCount&&(this.dashCount=r.dashCount),r.dashRatio&&(this.dashRatio=r.dashRatio),r.dashOffset&&(this.dashOffset=r.dashOffset),r.width&&(this.width=r.width),r.sizeAttenuation&&(this.sizeAttenuation=r.sizeAttenuation),r.resolution&&(this.resolution=r.resolution),r.colors?this.colorsTexture=h0.CreateColorsTexture(`${this.name}-colors-texture`,r.colors,this.colorsSampling,this.getScene()):this.colorsTexture=h0.PrepareEmptyColorsTexture(t),this._cameraFacing=r.cameraFacing??!0,this.setDefine("GREASED_LINE_CAMERA_FACING",this._cameraFacing)}}(eg=is||(is={}))[eg.MATERIAL_TYPE_STANDARD=0]="MATERIAL_TYPE_STANDARD",eg[eg.MATERIAL_TYPE_PBR=1]="MATERIAL_TYPE_PBR",eg[eg.MATERIAL_TYPE_SIMPLE=2]="MATERIAL_TYPE_SIMPLE",(ev=ia||(ia={}))[ev.COLOR_MODE_SET=0]="COLOR_MODE_SET",ev[ev.COLOR_MODE_ADD=1]="COLOR_MODE_ADD",ev[ev.COLOR_MODE_MULTIPLY=2]="COLOR_MODE_MULTIPLY",(eS=io||(io={}))[eS.COLOR_DISTRIBUTION_TYPE_SEGMENT=0]="COLOR_DISTRIBUTION_TYPE_SEGMENT",eS[eS.COLOR_DISTRIBUTION_TYPE_LINE=1]="COLOR_DISTRIBUTION_TYPE_LINE";let h7=`#if defined(DBG_ENABLED)
attribute float dbg_initialPass;
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;
#endif`,h6=`#if defined(DBG_ENABLED)
attribute dbg_initialPass: f32;
varying dbg_vBarycentric: vec3f;
varying dbg_vVertexWorldPos: vec3f;
varying dbg_vPass: f32;
#endif`,h8=`#if defined(DBG_ENABLED)
float dbg_vertexIndex = mod(float(gl_VertexID), 3.);
if (dbg_vertexIndex == 0.0) { 
    dbg_vBarycentric = vec3(1.,0.,0.); 
}
else if (dbg_vertexIndex == 1.0) { 
    dbg_vBarycentric = vec3(0.,1.,0.); 
}
else { 
    dbg_vBarycentric = vec3(0.,0.,1.); 
}

dbg_vVertexWorldPos = vPositionW;
dbg_vPass = dbg_initialPass;
#endif`,h9=`#if defined(DBG_ENABLED)
var dbg_vertexIndex = f32(input.vertexIndex) % 3.;
if (dbg_vertexIndex == 0.0) { 
    vertexOutputs.dbg_vBarycentric = vec3f(1.,0.,0.); 
}
else if (dbg_vertexIndex == 1.0) { 
    vertexOutputs.dbg_vBarycentric = vec3f(0.,1.,0.); 
}
else { 
    vertexOutputs.dbg_vBarycentric = vec3f(0.,0.,1.); 
}

vertexOutputs.dbg_vVertexWorldPos = vertexOutputs.vPositionW;
vertexOutputs.dbg_vPass = input.dbg_initialPass;
#endif`,de=`#if defined(DBG_ENABLED)
uniform vec3 dbg_shadedDiffuseColor;
uniform vec4 dbg_shadedSpecularColorPower;
uniform vec3 dbg_thicknessRadiusScale;

#if DBG_MODE == 2 || DBG_MODE == 3
    uniform vec3 dbg_vertexColor;
#endif

#if DBG_MODE == 1
    uniform vec3 dbg_wireframeTrianglesColor;
#elif DBG_MODE == 3
    uniform vec3 dbg_wireframeVerticesColor;
#elif DBG_MODE == 4 || DBG_MODE == 5
    uniform vec3 dbg_uvPrimaryColor;
    uniform vec3 dbg_uvSecondaryColor;
#elif DBG_MODE == 7
    uniform vec3 dbg_materialColor;
#endif
#endif`,dt=`#if defined(DBG_ENABLED)
uniform dbg_shadedDiffuseColor: vec3f;
uniform dbg_shadedSpecularColorPower: vec4f;
uniform dbg_thicknessRadiusScale: vec3f;

#if DBG_MODE == 2 || DBG_MODE == 3
    uniform dbg_vertexColor: vec3f;
#endif

#if DBG_MODE == 1
    uniform dbg_wireframeTrianglesColor: vec3f;
#elif DBG_MODE == 3
    uniform  dbg_wireframeVerticesColor: vec3f;
#elif DBG_MODE == 4 || DBG_MODE == 5
    uniform dbg_uvPrimaryColor: vec3f;
    uniform dbg_uvSecondaryColor: vec3f;
#elif DBG_MODE == 7
    uniform dbg_materialColor: vec3f;
#endif
#endif`,di=`#if defined(DBG_ENABLED)
varying vec3 dbg_vBarycentric;
flat varying vec3 dbg_vVertexWorldPos;
flat varying float dbg_vPass;

#if !defined(DBG_MULTIPLY)
    vec3 dbg_applyShading(vec3 color) {
        vec3 N = vNormalW.xyz;
        vec3 L = normalize(vEyePosition.xyz - vPositionW.xyz);
        vec3 H = normalize(L + L);
        float LdotN = clamp(dot(L,N), 0., 1.);
        float HdotN = clamp(dot(H,N), 0., 1.);
        float specTerm = pow(HdotN, dbg_shadedSpecularColorPower.w);
        color *= (LdotN / PI);
        color += dbg_shadedSpecularColorPower.rgb * (specTerm / PI);
        return color;
    }
#endif

#if DBG_MODE == 1 || DBG_MODE == 3
    float dbg_edgeFactor() {
        vec3 d = fwidth(dbg_vBarycentric);
        vec3 a3 = smoothstep(vec3(0.), d * dbg_thicknessRadiusScale.x, dbg_vBarycentric);
        return min(min(a3.x, a3.y), a3.z);
    }
#endif

#if DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor() {
        vec3 worldPos = vPositionW;
        float dist = length(worldPos - dbg_vVertexWorldPos);
        float camDist = length(worldPos - vEyePosition.xyz);
        float d = sqrt(camDist) * .001;
        return smoothstep((dbg_thicknessRadiusScale.y * d), ((dbg_thicknessRadiusScale.y * 1.01) * d), dist);
    }
#endif

#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))
    float dbg_checkerboardFactor(vec2 uv) {
        vec2 f = fract(uv * dbg_thicknessRadiusScale.z);
        f -= .5;
        return (f.x * f.y) > 0. ? 1. : 0.;
    }
#endif
#endif`,dr=`#if defined(DBG_ENABLED)
varying dbg_vBarycentric: vec3f;
varying dbg_vVertexWorldPos: vec3f;
varying dbg_vPass: f32;

#if !defined(DBG_MULTIPLY)
    fn dbg_applyShading(color: vec3f) -> vec3f {
        var N = fragmentInputs.vNormalW.xyz;
        var L = normalize(scene.vEyePosition.xyz - fragmentInputs.vPositionW.xyz);
        var H = normalize(L + L);
        var LdotN = clamp(dot(L,N), 0., 1.);
        var HdotN = clamp(dot(H,N), 0., 1.);
        var specTerm = pow(HdotN, uniforms.dbg_shadedSpecularColorPower.w);
        var result = color * (LdotN / PI);
        result += uniforms.dbg_shadedSpecularColorPower.rgb * (specTerm / PI);
        return result;
    }
#endif

#if DBG_MODE == 1 || DBG_MODE == 3
    fn dbg_edgeFactor() -> f32 {
        var d = fwidth(fragmentInputs.dbg_vBarycentric);
        var a3 = smoothstep(vec3f(0.), d * uniforms.dbg_thicknessRadiusScale.x, fragmentInputs.dbg_vBarycentric);
        return min(min(a3.x, a3.y), a3.z);
    }
#endif

#if DBG_MODE == 2 || DBG_MODE == 3
    fn dbg_cornerFactor() -> f32 {
        var worldPos = fragmentInputs.vPositionW;
        float dist = length(worldPos - fragmentInputs.dbg_vVertexWorldPos);
        float camDist = length(worldPos - scene.vEyePosition.xyz);
        float d = sqrt(camDist) * .001;
        return smoothstep((uniforms.dbg_thicknessRadiusScale.y * d), ((uniforms.dbg_thicknessRadiusScale.y * 1.01) * d), dist);
    }
#endif

#if (DBG_MODE == 4 && defined(UV1)) || (DBG_MODE == 5 && defined(UV2))
    fn dbg_checkerboardFactor(uv: vec2f) -> f32 {
        var f = fract(uv * uniforms.dbg_thicknessRadiusScale.z);
        f -= .5;
        return (f.x * f.y) > 0. ? 1. : 0.;
    }
#endif
#endif`,ds=`#if defined(DBG_ENABLED)
vec3 dbg_color = vec3(1.);
#if DBG_MODE == 1
    dbg_color = mix(dbg_wireframeTrianglesColor, vec3(1.), dbg_edgeFactor());
#elif DBG_MODE == 2 || DBG_MODE == 3
    float dbg_cornerFactor = dbg_cornerFactor();
    if (dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;
    dbg_color = mix(dbg_vertexColor, vec3(1.), dbg_cornerFactor);
    #if DBG_MODE == 3
        dbg_color *= mix(dbg_wireframeVerticesColor, vec3(1.), dbg_edgeFactor());
    #endif
#elif DBG_MODE == 4 && defined(MAINUV1)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV1));
#elif DBG_MODE == 5 && defined(MAINUV2)
    dbg_color = mix(dbg_uvPrimaryColor, dbg_uvSecondaryColor, dbg_checkerboardFactor(vMainUV2));
#elif DBG_MODE == 6 && defined(VERTEXCOLOR)
    dbg_color = vColor.rgb;
#elif DBG_MODE == 7
    dbg_color = dbg_materialColor;
#endif

#if defined(DBG_MULTIPLY)
    gl_FragColor *= vec4(dbg_color, 1.);
#else
    #if DBG_MODE != 6
        gl_FragColor = vec4(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);
    #else
        gl_FragColor = vec4(dbg_color, 1.);
    #endif
#endif
#endif`,dn=`#if defined(DBG_ENABLED)
var dbg_color = vec3f(1.);
#if DBG_MODE == 1
    dbg_color = mix(uniforms.dbg_wireframeTrianglesColor, vec3f(1.), dbg_edgeFactor());
#elif DBG_MODE == 2 || DBG_MODE == 3
    var dbg_cornerFactor = dbg_cornerFactor();
    if (fragmentInputs.dbg_vPass == 0. && dbg_cornerFactor == 1.) discard;
    dbg_color = mix(uniforms.dbg_vertexColor, vec3(1.), dbg_cornerFactor);
    #if DBG_MODE == 3
        dbg_color *= mix(uniforms.dbg_wireframeVerticesColor, vec3f(1.), dbg_edgeFactor());
    #endif
#elif DBG_MODE == 4 && defined(MAINUV1)
    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV1));
#elif DBG_MODE == 5 && defined(MAINUV2)
    dbg_color = mix(uniforms.dbg_uvPrimaryColor, uniforms.dbg_uvSecondaryColor, dbg_checkerboardFactor(fragmentInputs.vMainUV2));
#elif DBG_MODE == 6 && defined(VERTEXCOLOR)
    dbg_color = fragmentInputs.vColor.rgb;
#elif DBG_MODE == 7
    dbg_color = uniforms.dbg_materialColor;
#endif

#if defined(DBG_MULTIPLY)
    fragmentOutputs.color *= vec4f(dbg_color, 1.);
#else
    #if DBG_MODE != 6
        fragmentOutputs.color = vec4f(dbg_applyShading(dbg_shadedDiffuseColor) * dbg_color, 1.);
    #else
        fragmentOutputs.color = vec4f(dbg_color, 1.);
    #endif
#endif
#endif`,da=[new aN.Wo(.98,.26,.38),new aN.Wo(.47,.75,.3),new aN.Wo(0,.26,.77),new aN.Wo(.97,.6,.76),new aN.Wo(.19,.63,.78),new aN.Wo(.98,.8,.6),new aN.Wo(.65,.43,.15),new aN.Wo(.15,.47,.22),new aN.Wo(.67,.71,.86),new aN.Wo(.09,.46,.56),new aN.Wo(.8,.98,.02),new aN.Wo(.39,.29,.13),new aN.Wo(.53,.63,.06),new aN.Wo(.95,.96,.41),new aN.Wo(1,.72,.94),new aN.Wo(.63,.08,.31),new aN.Wo(.66,.96,.95),new aN.Wo(.22,.14,.19),new aN.Wo(.14,.65,.59),new aN.Wo(.93,1,.68),new aN.Wo(.93,.14,.44),new aN.Wo(.47,.86,.67),new aN.Wo(.85,.07,.78),new aN.Wo(.53,.64,.98),new aN.Wo(.43,.37,.56),new aN.Wo(.71,.65,.25),new aN.Wo(.66,.19,.01),new aN.Wo(.94,.53,.12),new aN.Wo(.41,.44,.44),new aN.Wo(.24,.71,.96),new aN.Wo(.57,.28,.56),new aN.Wo(.44,.98,.42)];(ex=il||(il={}))[ex.NONE=0]="NONE",ex[ex.TRIANGLES=1]="TRIANGLES",ex[ex.VERTICES=2]="VERTICES",ex[ex.TRIANGLES_VERTICES=3]="TRIANGLES_VERTICES",ex[ex.UV0=4]="UV0",ex[ex.UV1=5]="UV1",ex[ex.VERTEXCOLORS=6]="VERTEXCOLORS",ex[ex.MATERIALIDS=7]="MATERIALIDS";class dl extends o5.H{constructor(){super(...arguments),this.DBG_MODE=0,this.DBG_MULTIPLY=!0,this.DBG_ENABLED=!0}}class dc extends hq.n{_markAllDefinesAsDirty(){this._enable(this._isEnabled),this.markAllDefinesAsDirty()}isCompatible(e){switch(e){case 0:case 1:return!0;default:return!1}}constructor(e,t={}){let i=new dl;i.DBG_MODE=t.mode??i.DBG_MODE,i.DBG_MULTIPLY=t.multiply??i.DBG_MULTIPLY,super(e,"MeshDebug",200,i,!0,!0),this._mode=i.DBG_MODE,this._multiply=i.DBG_MULTIPLY,this.shadedDiffuseColor=t.shadedDiffuseColor??new aN.Wo(1,1,1),this.shadedSpecularColor=t.shadedSpecularColor??new aN.Wo(.8,.8,.8),this.shadedSpecularPower=t.shadedSpecularPower??10,this.wireframeThickness=t.wireframeThickness??.7,this.wireframeTrianglesColor=t.wireframeTrianglesColor??new aN.Wo(0,0,0),this.wireframeVerticesColor=t.wireframeVerticesColor??new aN.Wo(.8,.8,.8),this.vertexColor=t.vertexColor??new aN.Wo(0,0,0),this.vertexRadius=t.vertexRadius??1.2,this.uvScale=t.uvScale??20,this.uvPrimaryColor=t.uvPrimaryColor??new aN.Wo(1,1,1),this.uvSecondaryColor=t.uvSecondaryColor??new aN.Wo(.5,.5,.5),this._materialColor=dc.MaterialColors[dc._PluginCount++%dc.MaterialColors.length],this.isEnabled=!0}getClassName(){return"MeshDebugPluginMaterial"}get isEnabled(){return this._isEnabled}set isEnabled(e){if(this._isEnabled!==e){if(!this._material.getScene().getEngine().isWebGPU&&1==this._material.getScene().getEngine().version){re.Y.Error("MeshDebugPluginMaterial is not supported on WebGL 1.0."),this._isEnabled=!1;return}this._isEnabled=e,this._markAllDefinesAsDirty()}}prepareDefines(e,t,i){2!=this._mode&&1!=this._mode&&3!=this._mode||i.isVerticesDataPresent("dbg_initialPass")||re.Y.Warn("For best results with TRIANGLES, TRIANGLES_VERTICES, or VERTICES modes, please use MeshDebugPluginMaterial.PrepareMeshForTrianglesAndVerticesMode() on mesh.",1),e.DBG_MODE=this._mode,e.DBG_MULTIPLY=this._multiply,e.DBG_ENABLED=this._isEnabled}getAttributes(e){e.push("dbg_initialPass")}getUniforms(e=0){return{ubo:[{name:"dbg_shadedDiffuseColor",size:3,type:"vec3"},{name:"dbg_shadedSpecularColorPower",size:4,type:"vec4"},{name:"dbg_thicknessRadiusScale",size:3,type:"vec3"},{name:"dbg_wireframeTrianglesColor",size:3,type:"vec3"},{name:"dbg_wireframeVerticesColor",size:3,type:"vec3"},{name:"dbg_vertexColor",size:3,type:"vec3"},{name:"dbg_uvPrimaryColor",size:3,type:"vec3"},{name:"dbg_uvSecondaryColor",size:3,type:"vec3"},{name:"dbg_materialColor",size:3,type:"vec3"}],fragment:0===e?de:dt}}bindForSubMesh(e){this._isEnabled&&(e.updateFloat3("dbg_shadedDiffuseColor",this.shadedDiffuseColor.r,this.shadedDiffuseColor.g,this.shadedDiffuseColor.b),e.updateFloat4("dbg_shadedSpecularColorPower",this.shadedSpecularColor.r,this.shadedSpecularColor.g,this.shadedSpecularColor.b,this.shadedSpecularPower),e.updateFloat3("dbg_thicknessRadiusScale",this.wireframeThickness,this.vertexRadius,this.uvScale),e.updateColor3("dbg_wireframeTrianglesColor",this.wireframeTrianglesColor),e.updateColor3("dbg_wireframeVerticesColor",this.wireframeVerticesColor),e.updateColor3("dbg_vertexColor",this.vertexColor),e.updateColor3("dbg_uvPrimaryColor",this.uvPrimaryColor),e.updateColor3("dbg_uvSecondaryColor",this.uvSecondaryColor),e.updateColor3("dbg_materialColor",this._materialColor))}getCustomCode(e,t=0){return 1===t?"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:h6,CUSTOM_VERTEX_MAIN_END:h9}:{CUSTOM_FRAGMENT_DEFINITIONS:dr,CUSTOM_FRAGMENT_MAIN_END:dn}:"vertex"===e?{CUSTOM_VERTEX_DEFINITIONS:h7,CUSTOM_VERTEX_MAIN_END:h8}:{CUSTOM_FRAGMENT_DEFINITIONS:di,CUSTOM_FRAGMENT_MAIN_END:ds}}static Reset(){this._PluginCount=0,this.MaterialColors=da}static PrepareMeshForTrianglesAndVerticesMode(e,t=!1){let i=()=>{};if(0==e.getTotalIndices())return i;if(t){let t=e.getVerticesDataKinds(),r=e.getIndices(),s={};for(let i of t)s[i]=e.getVerticesData(i);i=function(){for(let i of(e.setIndices(r),t)){let t=e.getVertexBuffer(i).getStrideSize();e.setVerticesData(i,s[i],void 0,t)}e.removeVerticesData("dbg_initialPass")}}let r=Array.from(e.getIndices()),s=[];for(let e=0;e<r.length;e+=3)s.push(r[e+1],r[e+2],r[e+0]);e.setIndices(r.concat(s)),e.convertToUnIndexedMesh(),e.isUnIndexed=!1,r=Array.from(e.getIndices());let n=[];for(let e=r.length/2;e<r.length;e+=3)n.push(r[e+1],r[e+2],r[e+0]);e.setIndices(r.concat(n));let a=e.getTotalVertices(),o=a/2,l=Array(a).fill(1,0,o).fill(0,o,a);return e.setVerticesData("dbg_initialPass",l,!1,1),i}}dc._PluginCount=0,dc.MaterialColors=da,(0,r$.gn)([(0,rj.n9)()],dc.prototype,"_materialColor",void 0),(0,r$.gn)([(0,rj.qC)()],dc.prototype,"_isEnabled",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllDefinesAsDirty")],dc.prototype,"mode",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllDefinesAsDirty")],dc.prototype,"multiply",void 0),(0,r$.gn)([(0,rj.n9)()],dc.prototype,"shadedDiffuseColor",void 0),(0,r$.gn)([(0,rj.n9)()],dc.prototype,"shadedSpecularColor",void 0),(0,r$.gn)([(0,rj.qC)()],dc.prototype,"shadedSpecularPower",void 0),(0,r$.gn)([(0,rj.qC)()],dc.prototype,"wireframeThickness",void 0),(0,r$.gn)([(0,rj.n9)()],dc.prototype,"wireframeTrianglesColor",void 0),(0,r$.gn)([(0,rj.n9)()],dc.prototype,"wireframeVerticesColor",void 0),(0,r$.gn)([(0,rj.n9)()],dc.prototype,"vertexColor",void 0),(0,r$.gn)([(0,rj.qC)()],dc.prototype,"vertexRadius",void 0),(0,r$.gn)([(0,rj.qC)()],dc.prototype,"uvScale",void 0),(0,r$.gn)([(0,rj.n9)()],dc.prototype,"uvPrimaryColor",void 0),(0,r$.gn)([(0,rj.n9)()],dc.prototype,"uvSecondaryColor",void 0),(0,i3.H7)("BABYLON.MeshDebugPluginMaterial",dc),i(41871),i(28951),i(37387);let du=`#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
varying vec4 vColor;varying vec2 vPosition;void main () { 
#include<clipPlaneFragment>
float A=-dot(vPosition,vPosition);if (A<-4.0) discard;float B=exp(A)*vColor.a;
#include<logDepthFragment>
vec3 color=vColor.rgb;
#ifdef FOG
#include<fogFragment>
#endif
gl_FragColor=vec4(color,B);}
`;sG.v.ShadersStore.gaussianSplattingPixelShader=du;let dh=`uniform mat4 world;uniform mat4 view;uniform mat4 projection;
`;sG.v.IncludesShadersStore.gaussianSplattingVertexDeclaration=dh,i(16282),i(33587);let dd=`#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;sG.v.IncludesShadersStore.gaussianSplattingUboDeclaration=dd,i(99115),i(97059),i(74450);let df=`#include<__decl__gaussianSplattingVertex>
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
attribute vec2 position;attribute float splatIndex;uniform vec2 invViewport;uniform vec2 dataTextureSize;uniform vec2 focal;uniform sampler2D covariancesATexture;uniform sampler2D covariancesBTexture;uniform sampler2D centersTexture;uniform sampler2D colorsTexture;varying vec4 vColor;varying vec2 vPosition;
#if !defined(WEBGL2) && !defined(WEBGPU) && !defined(NATIVE)
mat3 transpose(mat3 matrix) {return mat3(matrix[0][0],matrix[1][0],matrix[2][0],
matrix[0][1],matrix[1][1],matrix[2][1],
matrix[0][2],matrix[1][2],matrix[2][2]);}
#endif
vec2 getDataUV(float index,vec2 textureSize) {float y=floor(index/textureSize.x);float x=index-y*textureSize.x;return vec2((x+0.5)/textureSize.x,(y+0.5)/textureSize.y);}
void main () {vec2 splatUV=getDataUV(splatIndex,dataTextureSize);vec3 center=texture2D(centersTexture,splatUV).xyz;vec4 color=texture2D(colorsTexture,splatUV);vec3 covA=texture2D(covariancesATexture,splatUV).xyz;vec3 covB=texture2D(covariancesBTexture,splatUV).xyz;vec4 worldPos=world*vec4(center,1.0);mat4 modelView=view*world;vec4 camspace=view*worldPos;vec4 pos2d=projection*camspace;float bounds=1.2*pos2d.w;if (pos2d.z<-pos2d.w || pos2d.x<-bounds || pos2d.x>bounds
|| pos2d.y<-bounds || pos2d.y>bounds) {gl_Position=vec4(0.0,0.0,2.0,1.0);return;}
mat3 Vrk=mat3(
covA.x,covA.y,covA.z,
covA.y,covB.x,covB.y,
covA.z,covB.y,covB.z
);mat3 J=mat3(
focal.x/camspace.z,0.,-(focal.x*camspace.x)/(camspace.z*camspace.z),
0.,focal.y/camspace.z,-(focal.y*camspace.y)/(camspace.z*camspace.z),
0.,0.,0.
);mat3 invy=mat3(1,0,0,0,-1,0,0,0,1);mat3 T=invy*transpose(mat3(modelView))*J;mat3 cov2d=transpose(T)*Vrk*T;float mid=(cov2d[0][0]+cov2d[1][1])/2.0;float radius=length(vec2((cov2d[0][0]-cov2d[1][1])/2.0,cov2d[0][1]));float lambda1=mid+radius,lambda2=mid-radius;if (lambda2<0.0) return;vec2 diagonalVector=normalize(vec2(cov2d[0][1],lambda1-cov2d[0][0]));vec2 majorAxis=min(sqrt(2.0*lambda1),1024.0)*diagonalVector;vec2 minorAxis=min(sqrt(2.0*lambda2),1024.0)*vec2(diagonalVector.y,-diagonalVector.x);vColor=color;vPosition=position;vec2 vCenter=vec2(pos2d);gl_Position=vec4(
vCenter 
+ (position.x*majorAxis
+ position.y*minorAxis)*invViewport*pos2d.w,pos2d.zw);
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}
`;sG.v.ShadersStore.gaussianSplattingVertexShader=df;class dp extends o5.H{constructor(){super(),this.FOG=!1,this.THIN_INSTANCES=!0,this.LOGARITHMICDEPTH=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.rebuild()}}class dm extends o7.a{constructor(e,t){super(e,t),this.backFaceCulling=!1}get hasRenderTargetTextures(){return!1}needAlphaTesting(){return!1}needAlphaBlending(){return!0}isReadyForSubMesh(e,t){let i=t._drawWrapper;if(i.effect&&this.isFrozen&&i._wasPreviouslyReady&&!0===i._wasPreviouslyUsingInstances)return!0;t.materialDefines||(t.materialDefines=new dp);let r=this.getScene(),s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;let n=r.getEngine();if((0,le.BV)(e,r,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,!1,s),(0,le.vG)(r,n,this,s,!0,null,!0),(0,le.wJ)(e,s,!1,!1),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial();let e=[st.o.PositionKind,"splatIndex"];(0,le.od)(e,s);let i=["world","view","projection","vFogInfos","vFogColor","logarithmicDepthConstant","invViewport","dataTextureSize","focal"],a=["covariancesATexture","covariancesBTexture","centersTexture","colorsTexture"],o=["Scene","Mesh"];(0,le.DI)({uniformsNames:i,uniformBuffersNames:o,samplers:a,defines:s}),(0,o9.qx)(i);let l=s.toString(),c=r.getEngine().createEffect("gaussianSplatting",{attributes:e,uniformsNames:i,uniformBuffersNames:o,samplers:a,defines:l,onCompiled:this.onCompiled,onError:this.onError},n);t.setEffect(c,s,this._materialContext)}return!!(t.effect&&t.effect.isReady())&&(s._renderId=r.getRenderId(),i._wasPreviouslyReady=!0,i._wasPreviouslyUsingInstances=!0,!0)}bindForSubMesh(e,t,i){let r=this.getScene(),s=i.materialDefines;if(!s)return;let n=i.effect;if(n){if(this._activeEffect=n,t.getMeshUniformBuffer().bindToEffect(n,"Mesh"),t.transferToEffect(e),this._mustRebind(r,n,i,t.visibility)){this.bindView(n),this.bindViewProjection(n);let e=r.getEngine(),i=this.getScene().activeCamera,s=e.getRenderWidth(),a=e.getRenderHeight(),o=i?.rigParent?.rigCameras.length||1;this._activeEffect.setFloat2("invViewport",1/(s/o),1/a);let l=1e3;if(i){let e=i.getProjectionMatrix().m[5];l=i.fovMode==rO.V.FOVMODE_VERTICAL_FIXED?a*e/2:s*e/2}if(this._activeEffect.setFloat2("focal",l,l),t.covariancesATexture){let e=t.covariancesATexture.getSize();n.setFloat2("dataTextureSize",e.width,e.height),n.setTexture("covariancesATexture",t.covariancesATexture),n.setTexture("covariancesBTexture",t.covariancesBTexture),n.setTexture("centersTexture",t.centersTexture),n.setTexture("colorsTexture",t.colorsTexture)}(0,o9.an)(n,this,r)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(0,le.D1)(r,t,n),this.useLogarithmicDepth&&(0,le.gz)(s,n,r),this._afterBind(t,this._activeEffect,i)}}clone(e){return rq.p.Clone(()=>new dm(e,this.getScene()),this)}serialize(){let e=super.serialize();return e.customType="BABYLON.GaussianSplattingMaterial",e}getClassName(){return"GaussianSplattingMaterial"}static Parse(e,t,i){return rq.p.Parse(()=>new dm(e.name,t),e,t,i)}}(0,i3.H7)("BABYLON.GaussianSplattingMaterial",dm),Object.defineProperty(nn.K.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new hK(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(ut.m.prototype,"decalMap",{get:function(){if(!this._decalMap){if(this._uniformBufferLayoutBuilt)return null;this._decalMap=new hK(this)}return this._decalMap},enumerable:!0,configurable:!0}),Object.defineProperty(rA.x.prototype,"decalMap",{get:function(){return this._decalMap},set:function(e){this._decalMap=e},enumerable:!0,configurable:!0}),i(86426),i(67665),i(96874),i(74640),i(25184);var d_=i(59874);class dg{constructor(e,t=2,i=3,r=1,s=1){this._curIndex=0,this._sequence=[],this._numSamples=0,this.x=0,this.y=0,this._width=r,this._height=s,this._baseX=t,this._baseY=i,this._generateSequence(e),this.next()}regenerate(e){this._generateSequence(e),this.next()}setDimensions(e,t){this._width=e,this._height=t}next(){this.x=this._sequence[this._curIndex]/this._width,this.y=this._sequence[this._curIndex+1]/this._height,this._curIndex+=2,this._curIndex>=2*this._numSamples&&(this._curIndex=0)}_generateSequence(e){this._sequence=[],this._curIndex=0,this._numSamples=e;for(let t=1;t<=e;++t)this._sequence.push(this._halton(t,this._baseX)-.5,this._halton(t,this._baseY)-.5)}_halton(e,t){let i=1,r=0;for(;e>0;)i/=t,r+=e%t*i,e=~~(e/t);return r}}var dv=i(24929);function dS(e,t,i,r,s){let n=null,a=null,o=null;try{let l;n=new e.Decoder,(a=new e.DecoderBuffer).Init(t,t.byteLength);let c=n.GetEncodedGeometryType(a);switch(c){case e.TRIANGULAR_MESH:{let t=new e.Mesh;if(!(l=n.DecodeBufferToMesh(a,t)).ok()||0===t.ptr)throw Error(l.error_msg());let i=t.num_faces(),s=3*i,c=4*s,u=e._malloc(c);try{n.GetTrianglesUInt32Array(t,c,u);let i=new Uint32Array(s);i.set(new Uint32Array(e.HEAPF32.buffer,u,s)),r(i)}finally{e._free(u)}o=t;break}case e.POINT_CLOUD:{let t=new e.PointCloud;if(!(l=n.DecodeBufferToPointCloud(a,t)).ok()||!t.ptr)throw Error(l.error_msg());o=t;break}default:throw Error(`Invalid geometry type ${c}`)}let u=o.num_points(),h=(t,i,r,n)=>{let a=n.data_type(),o=n.num_components(),l=n.normalized(),c=n.byte_stride(),h=n.byte_offset(),d={[e.DT_FLOAT32]:{typedArrayConstructor:Float32Array,heap:e.HEAPF32},[e.DT_INT8]:{typedArrayConstructor:Int8Array,heap:e.HEAP8},[e.DT_INT16]:{typedArrayConstructor:Int16Array,heap:e.HEAP16},[e.DT_INT32]:{typedArrayConstructor:Int32Array,heap:e.HEAP32},[e.DT_UINT8]:{typedArrayConstructor:Uint8Array,heap:e.HEAPU8},[e.DT_UINT16]:{typedArrayConstructor:Uint16Array,heap:e.HEAPU16},[e.DT_UINT32]:{typedArrayConstructor:Uint32Array,heap:e.HEAPU32}}[a];if(!d)throw Error(`Invalid data type ${a}`);let f=u*o,p=f*d.typedArrayConstructor.BYTES_PER_ELEMENT,m=e._malloc(p);try{t.GetAttributeDataArrayForAllPoints(i,n,a,p,m);let e=new d.typedArrayConstructor(d.heap.buffer,m,f);s(r,e.slice(),o,h,c,l)}finally{e._free(m)}};if(i)for(let e in i){let t=i[e],r=n.GetAttributeByUniqueId(o,t);h(n,o,e,r)}else{let t={position:e.POSITION,normal:e.NORMAL,color:e.COLOR,uv:e.TEX_COORD};for(let e in t){let i=n.GetAttributeId(o,t[e]);if(-1!==i){let t=n.GetAttribute(o,i);h(n,o,e,t)}}}return u}finally{o&&e.destroy(o),a&&e.destroy(a),n&&e.destroy(n)}}function dx(){let e;onmessage=t=>{let i=t.data;switch(i.id){case"init":{let t=i.decoder;t.url&&importScripts(t.url),e=DracoDecoderModule(t.wasmBinary?{wasmBinary:t.wasmBinary}:{}),postMessage({id:"initDone"});break}case"decodeMesh":if(!e)throw Error("Draco decoder module is not available");e.then(e=>{let t=dS(e,i.dataView,i.attributes,e=>{postMessage({id:"indices",data:e},[e.buffer])},(e,t,i,r,s,n)=>{postMessage({id:"attribute",kind:e,data:t,size:i,byteOffset:r,byteStride:s,normalized:n},[t.buffer])});postMessage({id:"decodeMeshDone",totalVertices:t})})}}}class dE{static get DecoderAvailable(){let e=dE.Configuration.decoder;return!!(e.wasmUrl&&e.wasmBinaryUrl&&"object"==typeof WebAssembly||e.fallbackUrl)}static GetDefaultNumWorkers(){return"object"==typeof navigator&&navigator.hardwareConcurrency?Math.min(Math.floor(.5*navigator.hardwareConcurrency),4):1}static get Default(){return dE._Default||(dE._Default=new dE),dE._Default}static ResetDefault(e){dE._Default&&(e||dE._Default.dispose(),dE._Default=null)}constructor(e=dE.DefaultNumWorkers){let t=dE.Configuration.decoder;if(t.workerPool||"object"==typeof e&&e.workerPool)this._workerPoolPromise=Promise.resolve(t.workerPool||e.workerPool);else{let i=t.wasmBinary||"object"==typeof e&&e.wasmBinary,r="number"==typeof e?e:e.numWorkers,s=r&&"function"==typeof Worker&&"function"==typeof URL,n=s||!s&&!t.jsModule,a=t.wasmUrl&&t.wasmBinaryUrl&&"object"==typeof WebAssembly?{url:n?rD.w1.GetBabylonScriptURL(t.wasmUrl,!0):"",wasmBinaryPromise:i?Promise.resolve(i):rD.w1.LoadFileAsync(rD.w1.GetBabylonScriptURL(t.wasmBinaryUrl,!0))}:{url:n?rD.w1.GetBabylonScriptURL(t.fallbackUrl):"",wasmBinaryPromise:Promise.resolve(void 0)};s?this._workerPoolPromise=a.wasmBinaryPromise.then(e=>{let t=`${dS}(${dx})()`,i=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));return new dv.v(r,()=>{var t,r;return t=new Worker(i),r=a.url,new Promise((i,s)=>{let n=e=>{t.removeEventListener("error",n),t.removeEventListener("message",a),s(e)},a=e=>{"initDone"===e.data.id&&(t.removeEventListener("error",n),t.removeEventListener("message",a),i(t))};if(t.addEventListener("error",n),t.addEventListener("message",a),e){let i=e.slice(0);t.postMessage({id:"init",decoder:{url:r,wasmBinary:i}},[i])}else t.postMessage({id:"init",decoder:{url:r}})})})}):this._decoderModulePromise=a.wasmBinaryPromise.then(async e=>{var i;if("undefined"==typeof DracoDecoderModule&&!t.jsModule){if(!a.url)throw Error("Draco decoder module is not available");await rD.w1.LoadBabylonScriptAsync(a.url)}return await (i=t.jsModule,new Promise(t=>{(i||DracoDecoderModule)({wasmBinary:e}).then(e=>{t({module:e})})}))})}}dispose(){this._workerPoolPromise&&this._workerPoolPromise.then(e=>{e.dispose()}),delete this._workerPoolPromise,delete this._decoderModulePromise}async whenReadyAsync(){if(this._workerPoolPromise){await this._workerPoolPromise;return}if(this._decoderModulePromise){await this._decoderModulePromise;return}}decodeMeshToMeshDataAsync(e,t,i){let r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e.buffer,e.byteOffset,e.byteLength),s=(e,t)=>i&&void 0!==i[e]?(t!==i[e]&&re.Y.Warn(`Normalized flag from Draco data (${t}) does not match normalized flag from glTF accessor (${i[e]}). Using flag from glTF accessor.`),i[e]):t;if(this._workerPoolPromise)return this._workerPoolPromise.then(e=>new Promise((i,n)=>{e.push((e,a)=>{let o=null,l=[],c=t=>{e.removeEventListener("error",c),e.removeEventListener("message",u),n(t),a()},u=t=>{let r=t.data;switch(r.id){case"decodeMeshDone":e.removeEventListener("error",c),e.removeEventListener("message",u),i({indices:o,attributes:l,totalVertices:r.totalVertices}),a();break;case"indices":o=r.data;break;case"attribute":l.push({kind:r.kind,data:r.data,size:r.size,byteOffset:r.byteOffset,byteStride:r.byteStride,normalized:s(r.kind,r.normalized)})}};e.addEventListener("error",c),e.addEventListener("message",u);let h=r.slice();e.postMessage({id:"decodeMesh",dataView:h,attributes:t},[h.buffer])})}));if(this._decoderModulePromise)return this._decoderModulePromise.then(e=>{let i=null,s=[],n=dS(e.module,r,t,e=>{i=e},(e,t,i,r,n,a)=>{s.push({kind:e,data:t,size:i,byteOffset:r,byteStride:n,normalized:a})});return{indices:i,attributes:s,totalVertices:n}});throw Error("Draco decoder module is not available")}async decodeMeshToGeometryAsync(e,t,i,r){let s=await this.decodeMeshToMeshDataAsync(i,r),n=new cM.Z(e,t);for(let e of(s.indices&&n.setIndices(s.indices),s.attributes))n.setVerticesBuffer(new st.o(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),s.totalVertices);return n}async _decodeMeshToGeometryForGltfAsync(e,t,i,r,s){let n=await this.decodeMeshToMeshDataAsync(i,r,s),a=new cM.Z(e,t);for(let e of(n.indices&&a.setIndices(n.indices),n.attributes))a.setVerticesBuffer(new st.o(t.getEngine(),e.data,e.kind,!1,void 0,e.byteStride,void 0,e.byteOffset,e.size,void 0,e.normalized,!0),n.totalVertices);return a}async decodeMeshAsync(e,t){let i=await this.decodeMeshToMeshDataAsync(e,t),r=new nK.x;for(let e of(i.indices&&(r.indices=i.indices),i.attributes)){let t=st.o.GetFloatData(e.data,e.size,st.o.GetDataType(e.data),e.byteOffset,e.byteStride,e.normalized,i.totalVertices);r.set(t,e.kind)}return r}}dE.Configuration={decoder:{wasmUrl:`${rD.w1._DefaultCdnUrl}/draco_wasm_wrapper_gltf.js`,wasmBinaryUrl:`${rD.w1._DefaultCdnUrl}/draco_decoder_gltf.wasm`,fallbackUrl:`${rD.w1._DefaultCdnUrl}/draco_decoder_gltf.js`}},dE.DefaultNumWorkers=dE.GetDefaultNumWorkers(),dE._Default=null;class dC{static get Default(){return dC._Default||(dC._Default=new dC),dC._Default}constructor(){let e=dC.Configuration.decoder;this._decoderModulePromise=rD.w1.LoadBabylonScriptAsync(e.url).then(()=>MeshoptDecoder.ready)}dispose(){delete this._decoderModulePromise}decodeGltfBufferAsync(e,t,i,r,s){return this._decoderModulePromise.then(async()=>{MeshoptDecoder.useWorkers(1);let n=await MeshoptDecoder.decodeGltfBufferAsync(t,i,e,r,s);return MeshoptDecoder.useWorkers(0),n})}}dC.Configuration={decoder:{url:`${rD.w1._DefaultCdnUrl}/meshopt_decoder.js`}},dC._Default=null;let dT=0;class db{constructor(e,t,i,r){this.pos=e,this.normal=t,this.uv=i,this.vertColor=r}clone(){return new db(this.pos.clone(),this.normal.clone(),this.uv?.clone(),this.vertColor?.clone())}flip(){this.normal=this.normal.scale(-1)}interpolate(e,t){return new db(i1.P.Lerp(this.pos,e.pos,t),i1.P.Lerp(this.normal,e.normal,t),this.uv&&e.uv?i1.FM.Lerp(this.uv,e.uv,t):void 0,this.vertColor&&e.vertColor?i2.HE.Lerp(this.vertColor,e.vertColor,t):void 0)}}class dy{constructor(e,t){this.normal=e,this.w=t}static FromPoints(e,t,i){let r=i.subtract(e),s=t.subtract(e);if(0===r.lengthSquared()||0===s.lengthSquared())return null;let n=i1.P.Normalize(i1.P.Cross(r,s));return new dy(n,i1.P.Dot(n,e))}clone(){return new dy(this.normal.clone(),this.w)}flip(){this.normal.scaleInPlace(-1),this.w=-this.w}splitPolygon(e,t,i,r,s){let n,a;let o=0,l=[];for(n=0;n<e.vertices.length;n++){let t=(a=i1.P.Dot(this.normal,e.vertices[n].pos)-this.w)<-dy.EPSILON?2:a>dy.EPSILON?1:0;o|=t,l.push(t)}switch(o){case 0:(i1.P.Dot(this.normal,e.plane.normal)>0?t:i).push(e);break;case 1:r.push(e);break;case 2:s.push(e);break;case 3:{let t;let i=[],o=[];for(n=0;n<e.vertices.length;n++){let t=(n+1)%e.vertices.length,r=l[n],s=l[t],c=e.vertices[n],u=e.vertices[t];if(2!==r&&i.push(c),1!==r&&o.push(2!==r?c.clone():c),(r|s)==3){a=(this.w-i1.P.Dot(this.normal,c.pos))/i1.P.Dot(this.normal,u.pos.subtract(c.pos));let e=c.interpolate(u,a);i.push(e),o.push(e.clone())}}i.length>=3&&(t=new dI(i,e.shared)).plane&&r.push(t),o.length>=3&&(t=new dI(o,e.shared)).plane&&s.push(t)}}}}dy.EPSILON=1e-5;class dI{constructor(e,t){this.vertices=e,this.shared=t,this.plane=dy.FromPoints(e[0].pos,e[1].pos,e[2].pos)}clone(){return new dI(this.vertices.map(e=>e.clone()),this.shared)}flip(){this.vertices.reverse().map(e=>{e.flip()}),this.plane.flip()}}class dP{constructor(e){this._plane=null,this._front=null,this._back=null,this._polygons=[],e&&this.build(e)}clone(){let e=new dP;return e._plane=this._plane&&this._plane.clone(),e._front=this._front&&this._front.clone(),e._back=this._back&&this._back.clone(),e._polygons=this._polygons.map(e=>e.clone()),e}invert(){for(let e=0;e<this._polygons.length;e++)this._polygons[e].flip();this._plane&&this._plane.flip(),this._front&&this._front.invert(),this._back&&this._back.invert();let e=this._front;this._front=this._back,this._back=e}clipPolygons(e){if(!this._plane)return e.slice();let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],t,i,t,i);return this._front&&(t=this._front.clipPolygons(t)),i=this._back?this._back.clipPolygons(i):[],t.concat(i)}clipTo(e){this._polygons=e.clipPolygons(this._polygons),this._front&&this._front.clipTo(e),this._back&&this._back.clipTo(e)}allPolygons(){let e=this._polygons.slice();return this._front&&(e=e.concat(this._front.allPolygons())),this._back&&(e=e.concat(this._back.allPolygons())),e}build(e){if(!e.length)return;this._plane||(this._plane=e[0].plane.clone());let t=[],i=[];for(let r=0;r<e.length;r++)this._plane.splitPolygon(e[r],this._polygons,this._polygons,t,i);t.length&&(this._front||(this._front=new dP),this._front.build(t)),i.length&&(this._back||(this._back=new dP),this._back.build(i))}}class dR{constructor(){this._polygons=[]}static FromVertexData(e){let t,i,r;let s=[],n=e.indices,a=e.positions,o=e.normals,l=e.uvs,c=e.colors;if(!n||!a)throw"BABYLON.CSG: VertexData must at least contain positions and indices";for(let e=0;e<n.length;e+=3){r=[];for(let i=0;i<3;i++){let s=n[e+i],u=o?i1.P.FromArray(o,3*s):i1.P.Zero(),h=l?i1.FM.FromArray(l,2*s):void 0,d=c?i2.HE.FromArray(c,4*s):void 0;t=new db(i1.P.FromArray(a,3*s),u,h,d),r.push(t)}(i=new dI(r,{subMeshId:0,meshId:dT,materialIndex:0})).plane&&s.push(i)}let u=dR._FromPolygons(s);return u.matrix=i1.y3.Identity(),u.position=i1.P.Zero(),u.rotation=i1.P.Zero(),u.scaling=i1.P.One(),u.rotationQuaternion=i1._f.Identity(),dT++,u}static FromMesh(e,t=!1){let i,r,s,n,a;let o=[],l,c,u,h=null,d,f=!1;if(e instanceof rP.Kj)e.computeWorldMatrix(!0),l=e.getWorldMatrix(),c=e.position.clone(),u=e.rotation.clone(),e.rotationQuaternion&&(h=e.rotationQuaternion.clone()),d=e.scaling.clone(),e.material&&t&&(f=0===e.material.sideOrientation);else throw"BABYLON.CSG: Wrong Mesh type, must be BABYLON.Mesh";let p=e.getIndices(),m=e.getVerticesData(st.o.PositionKind),_=e.getVerticesData(st.o.NormalKind),g=e.getVerticesData(st.o.UVKind),v=e.getVerticesData(st.o.ColorKind);if(null===p)throw"BABYLON.CSG: Mesh has no indices";if(null===m)throw"BABYLON.CSG: Mesh has no positions";if(null===_)throw"BABYLON.CSG: Mesh has no normals";let S=e.subMeshes;for(let e=0,t=S.length;e<t;e++)for(let t=S[e].indexStart,c=S[e].indexCount+S[e].indexStart;t<c;t+=3){a=[];for(let e=0;e<3;e++){let n=0===e?t+e:f?t+3-e:t+e,o=new i1.P(_[3*p[n]],_[3*p[n]+1],_[3*p[n]+2]);g&&(r=new i1.FM(g[2*p[n]],g[2*p[n]+1])),v&&(s=new i2.HE(v[4*p[n]],v[4*p[n]+1],v[4*p[n]+2],v[4*p[n]+3]));let c=new i1.P(m[3*p[n]],m[3*p[n]+1],m[3*p[n]+2]);i=new db(i1.P.TransformCoordinates(c,l),i1.P.TransformNormal(o,l),r,s),a.push(i)}(n=new dI(a,{subMeshId:e,meshId:dT,materialIndex:S[e].materialIndex})).plane&&o.push(n)}let x=dR._FromPolygons(o);return x.matrix=t?i1.y3.Identity():l,x.position=t?i1.P.Zero():c,x.rotation=t?i1.P.Zero():u,x.scaling=t?i1.P.One():d,x.rotationQuaternion=t&&h?i1._f.Identity():h,dT++,x}static _FromPolygons(e){let t=new dR;return t._polygons=e,t}clone(){let e=new dR;return e._polygons=this._polygons.map(e=>e.clone()),e.copyTransformAttributes(this),e}union(e){let t=new dP(this.clone()._polygons),i=new dP(e.clone()._polygons);return t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),dR._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}unionInPlace(e){let t=new dP(this._polygons),i=new dP(e._polygons);t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),this._polygons=t.allPolygons()}subtract(e){let t=new dP(this.clone()._polygons),i=new dP(e.clone()._polygons);return t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),dR._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}subtractInPlace(e){let t=new dP(this._polygons),i=new dP(e._polygons);t.invert(),t.clipTo(i),i.clipTo(t),i.invert(),i.clipTo(t),i.invert(),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}intersect(e){let t=new dP(this.clone()._polygons),i=new dP(e.clone()._polygons);return t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),dR._FromPolygons(t.allPolygons()).copyTransformAttributes(this)}intersectInPlace(e){let t=new dP(this._polygons),i=new dP(e._polygons);t.invert(),i.clipTo(t),i.invert(),t.clipTo(i),i.clipTo(t),t.build(i.allPolygons()),t.invert(),this._polygons=t.allPolygons()}inverse(){let e=this.clone();return e.inverseInPlace(),e}inverseInPlace(){this._polygons.map(e=>{e.flip()})}copyTransformAttributes(e){return this.matrix=e.matrix,this.position=e.position,this.rotation=e.rotation,this.scaling=e.scaling,this.rotationQuaternion=e.rotationQuaternion,this}toVertexData(e=null,t=null){let i;let r=this.matrix.clone();r.invert();let s=this._polygons,n=[],a=[],o=[],l=null,c=null,u=i1.P.Zero(),h=i1.P.Zero(),d=i1.FM.Zero(),f=new i2.HE(0,0,0,0),p=[0,0,0],m={};for(let _=0,g=s.length;_<g;_++){let g=s[_];e&&e(g);for(let e=2,s=g.vertices.length;e<s;e++){p[0]=0,p[1]=e-1,p[2]=e;for(let e=0;e<3;e++){u.copyFrom(g.vertices[p[e]].pos),h.copyFrom(g.vertices[p[e]].normal),g.vertices[p[e]].uv&&(l||(l=[]),d.copyFrom(g.vertices[p[e]].uv)),g.vertices[p[e]].vertColor&&(c||(c=[]),f.copyFrom(g.vertices[p[e]].vertColor));let s=i1.P.TransformCoordinates(u,r),_=i1.P.TransformNormal(h,r);i=m[s.x+","+s.y+","+s.z];let v=!1;l&&!(l[2*i]===d.x||l[2*i+1]===d.y)&&(v=!0);let S=!1;c&&!(c[4*i]===f.r||c[4*i+1]===f.g||c[4*i+2]===f.b||c[4*i+3]===f.a)&&(S=!0),(!(void 0!==i&&o[3*i]===_.x&&o[3*i+1]===_.y&&o[3*i+2]===_.z)||v||S)&&(n.push(s.x,s.y,s.z),l&&l.push(d.x,d.y),o.push(h.x,h.y,h.z),c&&c.push(f.r,f.g,f.b,f.a),i=m[s.x+","+s.y+","+s.z]=n.length/3-1),a.push(i),t&&t()}}}let _=new nK.x;return _.positions=n,_.normals=o,l&&(_.uvs=l),c&&(_.colors=c),_.indices=a,_}buildMeshGeometry(e,t,i){let r;let s=new rP.Kj(e,t),n=this._polygons,a=0,o={};if(i&&n.sort((e,t)=>e.shared.meshId===t.shared.meshId?e.shared.subMeshId-t.shared.subMeshId:e.shared.meshId-t.shared.meshId),this.toVertexData(e=>{o[e.shared.meshId]||(o[e.shared.meshId]={}),o[e.shared.meshId][e.shared.subMeshId]||(o[e.shared.meshId][e.shared.subMeshId]={indexStart:Infinity,indexEnd:-1/0,materialIndex:e.shared.materialIndex}),r=o[e.shared.meshId][e.shared.subMeshId]},()=>{r.indexStart=Math.min(a,r.indexStart),r.indexEnd=Math.max(a,r.indexEnd),a++}).applyToMesh(s),i){let e=0,t;for(let i in s.subMeshes=[],o){for(let n in t=-1,o[i])r=o[i][n],lJ.P.CreateFromIndices(r.materialIndex+e,r.indexStart,r.indexEnd-r.indexStart+1,s),t=Math.max(r.materialIndex,t);e+=++t}}return s}toMesh(e,t=null,i,r){let s=this.buildMeshGeometry(e,i,r);return s.material=t,s.position.copyFrom(this.position),s.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(s.rotationQuaternion=this.rotationQuaternion.clone()),s.scaling.copyFrom(this.scaling),s.computeWorldMatrix(!0),s}}i(33416),i(98317),rP.Kj._TrailMeshParser=(e,t)=>dA.Parse(e,t);class dA extends rP.Kj{constructor(e,t,i,r,s=60,n=!0){super(e,i),this._sectionPolygonPointsCount=4,this._running=!1,this._generator=t,"object"==typeof r&&null!==r?(this.diameter=r.diameter||1,this._length=r.length||60,this._segments=r.segments?r.segments>this._length?this._length:r.segments:this._length,this._sectionPolygonPointsCount=r.sections||4,this._doNotTaper=r.doNotTaper||!1,this._autoStart=r.autoStart||!0):(this.diameter=r||1,this._length=s,this._segments=this._length,this._doNotTaper=!1,this._autoStart=n),this._sectionVectors=[],this._sectionNormalVectors=[];for(let e=0;e<=this._sectionPolygonPointsCount;e++)this._sectionVectors[e]=i1.P.Zero(),this._sectionNormalVectors[e]=i1.P.Zero();this._createMesh()}getClassName(){return"TrailMesh"}_createMesh(){let e=new nK.x,t=[],i=[],r=[],s=[],n=i1.P.Zero();n=this._generator instanceof rA.x&&this._generator.hasBoundingInfo?this._generator.getBoundingInfo().boundingBox.centerWorld:this._generator.absolutePosition;let a=2*Math.PI/this._sectionPolygonPointsCount;for(let e=0;e<=this._sectionPolygonPointsCount;e++){let i=e!==this._sectionPolygonPointsCount?e*a:0;t.push(n.x+Math.cos(i)*this.diameter,n.y+Math.sin(i)*this.diameter,n.z),s.push(e/this._sectionPolygonPointsCount,0)}for(let e=1;e<=this._segments;e++){for(let i=0;i<=this._sectionPolygonPointsCount;i++){let r=i!==this._sectionPolygonPointsCount?i*a:0;t.push(n.x+Math.cos(r)*this.diameter,n.y+Math.sin(r)*this.diameter,n.z),s.push(i/this._sectionPolygonPointsCount,e/this._segments)}let i=t.length/3-2*(this._sectionPolygonPointsCount+1);for(let e=0;e<=this._sectionPolygonPointsCount;e++)r.push(i+e,i+e+this._sectionPolygonPointsCount,i+e+this._sectionPolygonPointsCount+1),r.push(i+e,i+e+this._sectionPolygonPointsCount+1,i+e+1)}nK.x.ComputeNormals(t,r,i),e.positions=t,e.normals=i,e.indices=r,e.uvs=s,e.applyToMesh(this,!0),this._autoStart&&this.start()}_updateSectionVectors(){let e=this._generator.getWorldMatrix(),t=2*Math.PI/this._sectionPolygonPointsCount;for(let i=0;i<=this._sectionPolygonPointsCount;i++){let r=i!==this._sectionPolygonPointsCount?i*t:0;this._sectionVectors[i].copyFromFloats(Math.cos(r)*this.diameter,Math.sin(r)*this.diameter,0),this._sectionNormalVectors[i].copyFromFloats(Math.cos(r),Math.sin(r),0),i1.P.TransformCoordinatesToRef(this._sectionVectors[i],e,this._sectionVectors[i]),i1.P.TransformNormalToRef(this._sectionNormalVectors[i],e,this._sectionNormalVectors[i])}}start(){this._running||(this._running=!0,this._beforeRenderObserver=this.getScene().onBeforeRenderObservable.add(()=>{this.update()}))}stop(){this._beforeRenderObserver&&this._running&&(this._running=!1,this.getScene().onBeforeRenderObservable.remove(this._beforeRenderObserver))}update(){let e=this.getVerticesData(st.o.PositionKind),t=this.getVerticesData(st.o.NormalKind),i=3*(this._sectionPolygonPointsCount+1);if(e&&t){if(this._doNotTaper)for(let t=i;t<e.length;t++)e[t-i]=(0,aP.Lerp)(e[t-i],e[t],this._segments/this._length);else for(let r=i;r<e.length;r++)e[r-i]=(0,aP.Lerp)(e[r-i],e[r],this._segments/this._length)-t[r]/this._length*this.diameter;for(let e=i;e<t.length;e++)t[e-i]=(0,aP.Lerp)(t[e-i],t[e],this._segments/this._length);this._updateSectionVectors();let r=e.length-3*(this._sectionPolygonPointsCount+1);for(let i=0;i<=this._sectionPolygonPointsCount;i++)e[r+3*i]=this._sectionVectors[i].x,e[r+3*i+1]=this._sectionVectors[i].y,e[r+3*i+2]=this._sectionVectors[i].z,t[r+3*i]=this._sectionNormalVectors[i].x,t[r+3*i+1]=this._sectionNormalVectors[i].y,t[r+3*i+2]=this._sectionNormalVectors[i].z;this.updateVerticesData(st.o.PositionKind,e,!0,!1),this.updateVerticesData(st.o.NormalKind,t,!0,!1)}}reset(){let e=this.getVerticesData(st.o.PositionKind),t=this.getVerticesData(st.o.NormalKind);if(e&&t){this._updateSectionVectors();for(let i=0;i<=this._segments;i++){let r=3*i*(this._sectionPolygonPointsCount+1);for(let i=0;i<=this._sectionPolygonPointsCount;i++)e[r+3*i]=this._sectionVectors[i].x,e[r+3*i+1]=this._sectionVectors[i].y,e[r+3*i+2]=this._sectionVectors[i].z,t[r+3*i]=this._sectionNormalVectors[i].x,t[r+3*i+1]=this._sectionNormalVectors[i].y,t[r+3*i+2]=this._sectionNormalVectors[i].z}this.updateVerticesData(st.o.PositionKind,e,!0,!1),this.updateVerticesData(st.o.NormalKind,t,!0,!1)}}clone(e="",t){let i={diameter:this.diameter,length:this._length,segments:this._segments,sections:this._sectionPolygonPointsCount,doNotTaper:this._doNotTaper,autoStart:this._autoStart};return new dA(e,t??this._generator,this.getScene(),i)}serialize(e){super.serialize(e),e.generatorId=this._generator.id}static Parse(e,t){let i=t.getLastMeshById(e.generatorId)??t.getLastTransformNodeById(e.generatorId);if(!i)throw Error("TrailMesh: generator not found with ID "+e.generatorId);let r={diameter:e.diameter??e._diameter,length:e._length,segments:e._segments,sections:e._sectionPolygonPointsCount,doNotTaper:e._doNotTaper,autoStart:e._autoStart};return new dA(e.name,i,t,r)}}var dM=i(63548);class dN{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){let e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach(t=>{this._getSimplifier(e).simplify(t,i=>{void 0!==t.distance&&e.mesh.addLODLevel(t.distance,i),i.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()})});else{let t=this._getSimplifier(e),i=(i,r)=>{t.simplify(i,t=>{void 0!==i.distance&&e.mesh.addLODLevel(i.distance,t),t.isVisible=!0,r()})};rD.$g.Run(e.settings.length,t=>{i(e.settings[t.index],()=>{t.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){return e.simplificationType,new dw(e.mesh)}}(eE=ic||(ic={}))[eE.QUADRATIC=0]="QUADRATIC";class dO{constructor(e){this._vertices=e,this.error=[,,,,],this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class dD{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new dF,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class dF{constructor(e){this.data=Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,r,s,n,a,o,l){return this.data[e]*this.data[s]*this.data[l]+this.data[i]*this.data[r]*this.data[o]+this.data[t]*this.data[n]*this.data[a]-this.data[i]*this.data[s]*this.data[a]-this.data[e]*this.data[n]*this.data[o]-this.data[t]*this.data[r]*this.data[l]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){let t=new dF;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,r){return new dF(dF.DataFromNumbers(e,t,i,r))}static DataFromNumbers(e,t,i,r){return[e*e,e*t,e*i,e*r,t*t,t*i,t*r,i*i,i*r,r*r]}}class dL{constructor(e,t){this.vertexId=e,this.triangleId=t}}class dw{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=r2.kn}simplify(e,t){this._initDecimatedMesh(),rD.$g.Run(this._mesh.subMeshes.length,t=>{this._initWithMesh(t.index,()=>{this._runDecimation(e,t.index,()=>{t.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){let r=~~(this._triangles.length*e.quality),s=0,n=this._triangles.length,a=(e,t)=>{setTimeout(()=>{e%5==0&&this._updateMesh(0===e);for(let e=0;e<this._triangles.length;++e)this._triangles[e].isDirty=!1;let i=1e-9*Math.pow(e+3,this.aggressiveness);rD.$g.SyncAsyncForLoop(this._triangles.length,this.syncIterations,e=>{let t=~~((this._triangles.length/2+e)%this._triangles.length),r=this._triangles[t];if(r&&!(r.error[3]>i)&&!r.deleted&&!r.isDirty){for(let e=0;e<3;++e)if(r.error[e]<i){let t=[],i=[],n=r._vertices[e],a=r._vertices[(e+1)%3];if(n.isBorder||a.isBorder)continue;let o=i1.P.Zero();this._calculateError(n,a,o);let l=[];if(this._isFlipped(n,a,o,t,l)||this._isFlipped(a,n,o,i,l)||0>t.indexOf(!0)||0>i.indexOf(!0))continue;let c=[];if(l.forEach(e=>{-1===c.indexOf(e)&&(e.deletePending=!0,c.push(e))}),c.length%2!=0)continue;n.q=a.q.add(n.q),n.updatePosition(o);let u=this._references.length;s=this._updateTriangles(n,n,t,s),s=this._updateTriangles(n,a,i,s);let h=this._references.length-u;if(h<=n.triangleCount){if(h)for(let e=0;e<h;e++)this._references[n.triangleStart+e]=this._references[u+e]}else n.triangleStart=u;n.triangleCount=h;break}}},t,()=>n-s<=r)},0)};rD.$g.Run(this.decimationIterations,e=>{n-s<=r?e.breakLoop():a(e.index,()=>{e.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];let r=this._mesh.getVerticesData(st.o.PositionKind),s=this._mesh.getIndices(),n=this._mesh.subMeshes[e],a=e=>{if(i){for(let t=0;t<this._vertices.length;++t)if(this._vertices[t].position.equalsWithEpsilon(e,1e-4))return this._vertices[t]}return null},o=[],l=n.verticesCount;rD.$g.SyncAsyncForLoop(l,this.syncIterations/4>>0,e=>{if(!r)return;let t=e+n.verticesStart,i=i1.P.FromArray(r,3*t),s=a(i)||new dD(i,this._vertices.length);s.originalOffsets.push(t),s.id===this._vertices.length&&this._vertices.push(s),o.push(s.id)},()=>{rD.$g.SyncAsyncForLoop(n.indexCount/3,this.syncIterations,e=>{if(!s)return;let t=3*(n.indexStart/3+e),i=s[t+0],r=s[t+1],a=s[t+2],l=new dO([this._vertices[o[i-n.verticesStart]],this._vertices[o[r-n.verticesStart]],this._vertices[o[a-n.verticesStart]]]);l.originalOffset=t,this._triangles.push(l)},()=>{this._init(t)})})}_init(e){rD.$g.SyncAsyncForLoop(this._triangles.length,this.syncIterations,e=>{let t=this._triangles[e];t.normal=i1.P.Cross(t._vertices[1].position.subtract(t._vertices[0].position),t._vertices[2].position.subtract(t._vertices[0].position)).normalize();for(let e=0;e<3;e++)t._vertices[e].q.addArrayInPlace(dF.DataFromNumbers(t.normal.x,t.normal.y,t.normal.z,-i1.P.Dot(t.normal,t._vertices[0].position)))},()=>{rD.$g.SyncAsyncForLoop(this._triangles.length,this.syncIterations,e=>{let t=this._triangles[e];for(let e=0;e<3;++e)t.error[e]=this._calculateError(t._vertices[e],t._vertices[(e+1)%3]);t.error[3]=Math.min(t.error[0],t.error[1],t.error[2])},()=>{e()})})}_reconstructMesh(e){let t,i,r;let s=[];for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0;for(t=0;t<this._triangles.length;++t)if(!this._triangles[t].deleted){for(r=0,i=this._triangles[t];r<3;++r)i._vertices[r].triangleCount=1;s.push(i)}let n=this._reconstructedMesh.getVerticesData(st.o.PositionKind)||[],a=this._reconstructedMesh.getVerticesData(st.o.NormalKind)||[],o=this._reconstructedMesh.getVerticesData(st.o.UVKind)||[],l=this._reconstructedMesh.getVerticesData(st.o.ColorKind)||[],c=this._mesh.getVerticesData(st.o.NormalKind),u=this._mesh.getVerticesData(st.o.UVKind),h=this._mesh.getVerticesData(st.o.ColorKind),d=0;for(t=0;t<this._vertices.length;++t){let e=this._vertices[t];e.id=d,e.triangleCount&&e.originalOffsets.forEach(t=>{n.push(e.position.x),n.push(e.position.y),n.push(e.position.z),c&&c.length&&(a.push(c[3*t]),a.push(c[3*t+1]),a.push(c[3*t+2])),u&&u.length&&(o.push(u[2*t]),o.push(u[2*t+1])),h&&h.length&&(l.push(h[4*t]),l.push(h[4*t+1]),l.push(h[4*t+2]),l.push(h[4*t+3])),++d})}let f=this._reconstructedMesh.getTotalIndices(),p=this._reconstructedMesh.getTotalVertices(),m=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];let _=this._reconstructedMesh.getIndices(),g=this._mesh.getIndices();for(t=0;t<s.length;++t)i=s[t],[0,1,2].forEach(e=>{let t=g[i.originalOffset+e],r=i._vertices[e].originalOffsets.indexOf(t);r<0&&(r=0),_.push(i._vertices[e].id+r+p)});this._reconstructedMesh.setIndices(_),this._reconstructedMesh.setVerticesData(st.o.PositionKind,n),a.length>0&&this._reconstructedMesh.setVerticesData(st.o.NormalKind,a),o.length>0&&this._reconstructedMesh.setVerticesData(st.o.UVKind,o),l.length>0&&this._reconstructedMesh.setVerticesData(st.o.ColorKind,l);let v=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],m.forEach(e=>{lJ.P.AddToMesh(e.materialIndex,e.verticesStart,e.verticesCount,e.indexStart,e.indexCount,e.getMesh())}),lJ.P.AddToMesh(v.materialIndex,p,d,f,3*s.length,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new rP.Kj(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,r,s){for(let n=0;n<e.triangleCount;++n){let a=this._triangles[this._references[e.triangleStart+n].triangleId];if(a.deleted)continue;let o=this._references[e.triangleStart+n].vertexId,l=a._vertices[(o+1)%3],c=a._vertices[(o+2)%3];if(l===t||c===t){r[n]=!0,s.push(a);continue}let u=l.position.subtract(i);u=u.normalize();let h=c.position.subtract(i);if(h=h.normalize(),Math.abs(i1.P.Dot(u,h))>.999)return!0;let d=i1.P.Cross(u,h).normalize();if(r[n]=!1,.2>i1.P.Dot(d,a.normal))return!0}return!1}_updateTriangles(e,t,i,r){let s=r;for(let r=0;r<t.triangleCount;++r){let n=this._references[t.triangleStart+r],a=this._triangles[n.triangleId];if(!a.deleted){if(i[r]&&a.deletePending){a.deleted=!0,s++;continue}a._vertices[n.vertexId]=e,a.isDirty=!0,a.error[0]=this._calculateError(a._vertices[0],a._vertices[1])+a.borderFactor/2,a.error[1]=this._calculateError(a._vertices[1],a._vertices[2])+a.borderFactor/2,a.error[2]=this._calculateError(a._vertices[2],a._vertices[0])+a.borderFactor/2,a.error[3]=Math.min(a.error[0],a.error[1],a.error[2]),this._references.push(n)}}return s}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){let t;let i=[],r=[],s=this._vertices[e];for(t=0;t<s.triangleCount;++t){let e=this._triangles[this._references[s.triangleStart+t].triangleId];for(let t=0;t<3;t++){let s=0,n=e._vertices[t];for(;s<i.length&&r[s]!==n.id;)++s;s===i.length?(i.push(1),r.push(n.id)):i[s]++}}for(t=0;t<i.length;++t)1===i[t]?this._vertices[r[t]].isBorder=!0:this._vertices[r[t]].isBorder=!1}}_updateMesh(e=!1){let t,i,r,s;if(!e){let e=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||e.push(this._triangles[t]);this._triangles=e}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;for(t=0;t<this._triangles.length;++t)for(r=0,i=this._triangles[t];r<3;++r)s=i._vertices[r],s.triangleCount++;let n=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=n,n+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;let a=Array(3*this._triangles.length);for(t=0;t<this._triangles.length;++t)for(r=0,i=this._triangles[t];r<3;++r)a[(s=i._vertices[r]).triangleStart+s.triangleCount]=new dL(r,t),s.triangleCount++;this._references=a,e&&this._identifyBorder()}_vertexError(e,t){let i=t.x,r=t.y,s=t.z;return e.data[0]*i*i+2*e.data[1]*i*r+2*e.data[2]*i*s+2*e.data[3]*i+e.data[4]*r*r+2*e.data[5]*r*s+2*e.data[6]*r+e.data[7]*s*s+2*e.data[8]*s+e.data[9]}_calculateError(e,t,i){let r=e.q.add(t.q),s=e.isBorder&&t.isBorder,n=0,a=r.det(0,1,2,1,4,5,2,5,7);if(0===a||s){let s=e.position.add(t.position).divide(new i1.P(2,2,2)),a=this._vertexError(r,e.position),o=this._vertexError(r,t.position);(n=Math.min(a,o,this._vertexError(r,s)))===a?i&&i.copyFrom(e.position):n===o?i&&i.copyFrom(t.position):i&&i.copyFrom(s)}else i||(i=i1.P.Zero()),i.x=-1/a*r.det(1,2,3,4,5,6,5,7,8),i.y=1/a*r.det(0,2,3,1,5,6,2,7,8),i.z=-1/a*r.det(0,1,3,1,4,6,2,5,8),n=this._vertexError(r,i);return n}}Object.defineProperty(rH.x.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new dN;let e=this._getComponent(rz.l.NAME_SIMPLIFICATIONQUEUE);e||(e=new dB(this),this._addComponent(e))}return this._simplificationQueue},set:function(e){this._simplificationQueue=e},enumerable:!0,configurable:!0}),rP.Kj.prototype.simplify=function(e,t=!0,i=0,r){return this.getScene().simplificationQueue.addTask({settings:e,parallelProcessing:t,mesh:this,simplificationType:i,successCallback:r}),this};class dB{constructor(e){this.name=rz.l.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(rz.l.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}i(4601),i(21716),i(80292),i(73722),i(57813),i(36556),i(42257),i(27283),i(96799),i(79470),i(21568),i(31385),i(16),(eC=iu||(iu={}))[eC.POINTS_MODE_POINTS=0]="POINTS_MODE_POINTS",eC[eC.POINTS_MODE_PATHS=1]="POINTS_MODE_PATHS",(eT=ih||(ih={}))[eT.FACES_MODE_SINGLE_SIDED=0]="FACES_MODE_SINGLE_SIDED",eT[eT.FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING=1]="FACES_MODE_SINGLE_SIDED_NO_BACKFACE_CULLING",eT[eT.FACES_MODE_DOUBLE_SIDED=2]="FACES_MODE_DOUBLE_SIDED",(eb=id||(id={}))[eb.AUTO_DIRECTIONS_FROM_FIRST_SEGMENT=0]="AUTO_DIRECTIONS_FROM_FIRST_SEGMENT",eb[eb.AUTO_DIRECTIONS_FROM_ALL_SEGMENTS=1]="AUTO_DIRECTIONS_FROM_ALL_SEGMENTS",eb[eb.AUTO_DIRECTIONS_ENHANCED=2]="AUTO_DIRECTIONS_ENHANCED",eb[eb.AUTO_DIRECTIONS_FACE_TO=3]="AUTO_DIRECTIONS_FACE_TO",eb[eb.AUTO_DIRECTIONS_NONE=99]="AUTO_DIRECTIONS_NONE";class dV extends rP.Kj{constructor(e,t,i){super(e,t,null,null,!1,!1),this.name=e,this._options=i,this._lazy=!1,this._updatable=!1,this._engine=t.getEngine(),this._lazy=i.lazy??!1,this._updatable=i.updatable??!1,this._vertexPositions=[],this._indices=[],this._uvs=[],this._points=[],this._colorPointers=i.colorPointers??[],this._widths=i.widths??Array(i.points.length).fill(1)}getClassName(){return"GreasedLineMesh"}_updateWidthsWithValue(e){let t=0;for(let e of this._points)t+=e.length;let i=t/3*2-this._widths.length;for(let t=0;t<i;t++)this._widths.push(e)}updateLazy(){this._setPoints(this._points),this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(this._options.ribbonOptions?.smoothShading),this.doNotSyncBoundingInfo||this.refreshBoundingInfo(),this.greasedLineMaterial?.updateLazy()}addPoints(e,t){for(let t of e)this._points.push(t);this._lazy||this.setPoints(this._points,t)}dispose(e,t=!1){super.dispose(e,t)}isLazy(){return this._lazy}get uvs(){return this._uvs}set uvs(e){this._uvs=e instanceof Float32Array?e:new Float32Array(e),this._createVertexBuffers()}get offsets(){return this._offsets}set offsets(e){this._offsets=e,this._offsetsBuffer?this._offsetsBuffer.update(e):this._createOffsetsBuffer(e)}get widths(){return this._widths}set widths(e){this._widths=e,!this._lazy&&this._widthsBuffer&&this._widthsBuffer.update(e)}get colorPointers(){return this._colorPointers}set colorPointers(e){this._colorPointers=e,!this._lazy&&this._colorPointersBuffer&&this._colorPointersBuffer.update(e)}get greasedLineMaterial(){if(this.material&&this.material instanceof h5)return this.material;let e=this.material?.pluginManager?.getPlugin(h2.GREASED_LINE_MATERIAL_NAME);if(e)return e}get points(){let e=[];return rd.j.DeepCopy(this._points,e),e}setPoints(e,t){this._points=e,this._updateWidths(),t?.colorPointers||this._updateColorPointers(),this._setPoints(e,t)}_initGreasedLine(){this._vertexPositions=[],this._indices=[],this._uvs=[]}_createLineOptions(){return{points:this._points,colorPointers:this._colorPointers,lazy:this._lazy,updatable:this._updatable,uvs:this._uvs,widths:this._widths,ribbonOptions:this._options.ribbonOptions}}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}_createVertexBuffers(e=!1){let t=new nK.x;return t.positions=this._vertexPositions,t.indices=this._indices,t.uvs=this._uvs,e&&(t.normals=[],nK.x.ComputeNormals(this._vertexPositions,this._indices,t.normals)),t.applyToMesh(this,this._options.updatable),t}_createOffsetsBuffer(e){let t=this._scene.getEngine(),i=new st.l(t,e,this._updatable,3);this.setVerticesBuffer(i.createVertexBuffer("grl_offsets",0,3)),this._offsetsBuffer=i}}rP.Kj._GreasedLineMeshParser=(e,t)=>dU.Parse(e,t);class dU extends dV{constructor(e,t,i){super(e,t,i),this.name=e,this.intersectionThreshold=.1,this._previousAndSide=[],this._nextAndCounters=[],i.points&&this.addPoints(h0.ConvertPoints(i.points))}getClassName(){return"GreasedLineMesh"}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[],this._points.forEach(t=>{for(let i=0;i<t.length;i+=3)this._colorPointers.push(e),this._colorPointers.push(e++)})}_updateWidths(){}_setPoints(e){this._points=e,this._options.points=e,this._initGreasedLine();let t=0,i=0,r=0,s=0,n=0;e.forEach(e=>{i+=2*e.length,r+=(e.length-3)*2,s+=4*e.length/3,n+=8*e.length/3});let a=new Float32Array(i),o=i>65535?new Uint32Array(r):new Uint16Array(r),l=new Float32Array(s),c=new Float32Array(n),u=new Float32Array(n),h=0,d=0,f=0,p=0,m=0;e.forEach(e=>{let i;let r=h0.GetLineLengthArray(e),s=r[r.length-1];for(let i=0,r=0;r<e.length;i++,r+=3){let s=h+2*r;if(a[s+0]=e[r+0],a[s+1]=e[r+1],a[s+2]=e[r+2],a[s+3]=e[r+0],a[s+4]=e[r+1],a[s+5]=e[r+2],r<e.length-3){let e=2*i+t,s=d+2*r;o[s+0]=e,o[s+1]=e+1,o[s+2]=e+2,o[s+3]=e+2,o[s+4]=e+1,o[s+5]=e+3}}t+=e.length/3*2;let n=2*e.length,_=a.subarray(h,h+n);h+=n,d+=(e.length-3)*2;let g=new Float32Array(_.length),v=new Float32Array(_.length),S=_.length/6;i=dU._CompareV3(0,S-1,_)?_.subarray((S-2)*6,(S-1)*6):_.subarray(0,6),g.set(i),g.set(_.subarray(0,_.length-6),6),v.set(_.subarray(6)),i=dU._CompareV3(S-1,0,_)?_.subarray(6,12):_.subarray((S-1)*6,6*S),v.set(i,v.length-6);for(let e=0,t=_.length/3;e<t;e++)c[p++]=g[3*e],c[p++]=g[3*e+1],c[p++]=g[3*e+2],c[p++]=1-((1&e)<<1),u[m++]=v[3*e],u[m++]=v[3*e+1],u[m++]=v[3*e+2],u[m++]=r[e>>1]/s;if(this._options.uvs)for(let e=0;e<this._options.uvs.length;e++)l[f++]=this._options.uvs[e];else for(let e=0;e<S;e++){let t=r[e]/s,i=f+4*e;l[i+0]=t,l[i+1]=0,l[i+2]=t,l[i+3]=1}}),this._vertexPositions=a,this._indices=o,this._uvs=l,this._previousAndSide=c,this._nextAndCounters=u,!this._lazy&&(this._options.colorPointers||this._updateColorPointers(),this._createVertexBuffers(),this.doNotSyncBoundingInfo||this.refreshBoundingInfo())}clone(e=`${this.name}-cloned`,t){let i=this._createLineOptions(),r={};rd.j.DeepCopy(i,r,["instance"],void 0,!0);let s=new dU(e,this._scene,r);return t&&(s.parent=t),s.material=this.material,s}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions()}static Parse(e,t){let i=e.lineOptions;return new dU(e.name,t,i)}_initGreasedLine(){super._initGreasedLine(),this._previousAndSide=[],this._nextAndCounters=[]}intersects(e,t,i,r=!1,s,n=!1){let a=new nR.p,o=this.findAllIntersections(e,t,i,r,s,n,!0);if(o?.length===1){let t=o[0];a.hit=!0,a.distance=t.distance,a.ray=e,a.pickedMesh=this,a.pickedPoint=t.point}return a}findAllIntersections(e,t,i,r=!1,s,n=!1,a=!1){if(r&&!n&&!1===e.intersectsSphere(this._boundingSphere,this.intersectionThreshold))return;let o=this.getIndices(),l=this.getVerticesData(st.o.PositionKind),c=this._widths,u=this.greasedLineMaterial?.width??1,h=[];if(o&&l&&c){let t=0,i=0;for(t=0,i=o.length-1;t<i;t+=3){let i=o[t],r=o[t+1];dU._V_START.fromArray(l,3*i),dU._V_END.fromArray(l,3*r),this._offsets&&(dU._V_OFFSET_START.fromArray(this._offsets,3*i),dU._V_OFFSET_END.fromArray(this._offsets,3*r),dU._V_START.addInPlace(dU._V_OFFSET_START),dU._V_END.addInPlace(dU._V_OFFSET_END));let s=Math.floor(t/3),n=void 0!==c[s]?c[s]:1,d=this.intersectionThreshold*(u*n)/2,f=e.intersectionSegment(dU._V_START,dU._V_END,d);if(-1!==f&&(h.push({distance:f,point:e.direction.normalize().multiplyByFloats(f,f,f).add(e.origin)}),a))return h}t=i}return h}get _boundingSphere(){return this.getBoundingInfo().boundingSphere}static _CompareV3(e,t,i){let r=6*e,s=6*t;return i[r]===i[s]&&i[r+1]===i[s+1]&&i[r+2]===i[s+2]}_createVertexBuffers(){let e=super._createVertexBuffers(),t=this._scene.getEngine(),i=new st.l(t,this._previousAndSide,!1,4);this.setVerticesBuffer(i.createVertexBuffer("grl_previousAndSide",0,4));let r=new st.l(t,this._nextAndCounters,!1,4);this.setVerticesBuffer(r.createVertexBuffer("grl_nextAndCounters",0,4));let s=new st.l(t,this._widths,this._updatable,1);this.setVerticesBuffer(s.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=s;let n=new st.l(t,this._colorPointers,this._updatable,1);return this.setVerticesBuffer(n.createVertexBuffer("grl_colorPointers",0,1)),this._colorPointersBuffer=n,e}}dU._V_START=new i1.P,dU._V_END=new i1.P,dU._V_OFFSET_START=new i1.P,dU._V_OFFSET_END=new i1.P,rP.Kj._GreasedLineRibbonMeshParser=(e,t)=>dk.Parse(e,t);class dk extends dV{constructor(e,t,i,r){if(super(e,t,i),this.name=e,!i.ribbonOptions)throw"'GreasedLineMeshOptions.ribbonOptions' is not set.";this._paths=[],this._counters=[],this._slopes=[],this._widths=i.widths??[],this._ribbonWidths=[],this._pathsOptions=r??[],i.points&&this.addPoints(h0.ConvertPoints(i.points),i,!!r)}addPoints(e,t,i=!1){if(!t.ribbonOptions)throw"addPoints() on GreasedLineRibbonMesh instance requires 'GreasedLineMeshOptions.ribbonOptions'.";i||this._pathsOptions.push({options:t,pathCount:e.length}),super.addPoints(e,t)}getClassName(){return"GreasedLineRibbonMesh"}get isFlatLine(){return this._paths.length<3}get slopes(){return this._slopes}set slopes(e){this._slopes=e}_updateColorPointers(){if(this._options.colorPointers)return;let e=0;this._colorPointers=[];for(let t=0;t<this._pathsOptions.length;t++){let{options:i,pathCount:r}=this._pathsOptions[t],s=this._points[t];if(0===i.ribbonOptions.pointsMode)for(let t=0;t<r;t++)for(let t=0;t<s.length;t+=3)this._colorPointers.push(e),this._colorPointers.push(e++);else for(let t=0;t<s.length;t+=3){for(let t=0;t<r;t++)this._colorPointers.push(e);e++}}}_updateWidths(){super._updateWidthsWithValue(1)}_setPoints(e,t){let i;if(!this._options.ribbonOptions)throw"No 'GreasedLineMeshOptions.ribbonOptions' provided.";this._points=e,this._options.points=e,this._initGreasedLine();let r=0;for(let t=0,s=0;t<this._pathsOptions.length;t++){let{options:n,pathCount:a}=this._pathsOptions[t],o=e.slice(s,s+a);if(s+=a,n.ribbonOptions?.pointsMode===1)r=this._preprocess(h0.ToVector3Array(o),r,n);else{if(n.ribbonOptions?.directionsAutoMode===99){if(!n.ribbonOptions.directions)throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_NONE 'GreasedLineMeshOptions.ribbonOptions.directions' must be defined.";i=dk._GetDirectionPlanesFromDirectionsOption(o.length,n.ribbonOptions.directions)}o.forEach((e,t)=>{let s=dk._ConvertToRibbonPath(e,n.ribbonOptions,this._scene.useRightHandedSystem,i?i[t]:i);r=this._preprocess(s,r,n)})}}!this._lazy&&(this._createVertexBuffers(),this.doNotSyncBoundingInfo||this.refreshBoundingInfo())}static _GetDirectionPlanesFromDirectionsOption(e,t){return Array.isArray(t)?t:Array(e).fill(t)}static _CreateRibbonVertexData(e,t){let i=e.length;if(i<2)throw"Minimum of two paths are required to create a GreasedLineRibbonMesh.";let r=[],s=[],n=e[0];for(let t=0;t<n.length;t++)for(let i=0;i<e.length;i++){let s=e[i][t];r.push(s.x,s.y,s.z)}let a=[1,0,i],o=(t.ribbonOptions?.facesMode===2)??!1,l=t.ribbonOptions?.pointsMode===1&&t.ribbonOptions.closePath;if(i>2)for(let e=0;e<n.length-1;e++){a[0]=1+i*e,a[1]=i*e,a[2]=(e+1)*i;for(let e=0;e<(i-1)*2;e++)e%2!=0&&(a[2]+=1),e%2==0&&e>0&&(a[0]+=1,a[1]+=1),s.push(a[1]+(e%2!=0?i:0),a[0],a[2]),o&&s.push(a[0],a[1]+(e%2!=0?i:0),a[2])}else for(let e=0;e<r.length/3-3;e+=2)s.push(e,e+1,e+2),s.push(e+2,e+1,e+3),o&&(s.push(e+1,e,e+2),s.push(e+1,e+2,e+3));if(l){let e=i*(n.length-1);for(let t=0;t<i-1;t++)s.push(e,t+1,t),s.push(e+1,t+1,e),o&&(s.push(t,t+1,e),s.push(e,t+1,e+1)),e++}return{positions:r,indices:s}}_preprocess(e,t,i){this._paths=e;let r=dk._CreateRibbonVertexData(e,i),s=r.positions;if(!this._options.widths)throw"No 'GreasedLineMeshOptions.widths' table is specified.";let n=Array.isArray(this._vertexPositions)?this._vertexPositions:Array.from(this._vertexPositions);this._vertexPositions=n;let a=Array.isArray(this._uvs)?this._uvs:Array.from(this._uvs);this._uvs=a;let o=Array.isArray(this._indices)?this._indices:Array.from(this._indices);for(let e of(this._indices=o,s))n.push(e);let l=e;if(i.ribbonOptions?.pointsMode===1&&i.ribbonOptions.closePath){l=[];for(let t=0;t<e.length;t++){let i=e[t].slice();i.push(e[t][0].clone()),l.push(i)}}this._calculateSegmentLengths(l);let c=l.length,u=Array(c).fill(0);for(let e=0;e<l[0].length;e++){let t=0;for(let i=0;i<c;i++){let r=u[i]+this._vSegmentLengths[i][e]/this._vTotalLengths[i];this._counters.push(r),a.push(r,t),u[i]=r,t+=this._uSegmentLengths[e][i]/this._uTotalLengths[e]}}for(let e=0,t=0;e<l[0].length;e++){let i=this._uSegmentLengths[e][0]/2,r=this._uSegmentLengths[e][c-1]/2;this._ribbonWidths.push(((this._widths[t++]??1)-1)*i);for(let e=0;e<c-2;e++)this._ribbonWidths.push(0);this._ribbonWidths.push(((this._widths[t++]??1)-1)*r)}for(let e of i.ribbonOptions?.pointsMode===1?Array(l[0].length*l.length*6).fill(0):dk._CalculateSlopes(l))this._slopes.push(e);if(r.indices)for(let e=0;e<r.indices.length;e++)o.push(r.indices[e]+t);return t+=s.length/3}static _ConvertToRibbonPath(e,t,i,r){if(0===t.pointsMode&&!t.width)throw"'GreasedLineMeshOptions.ribbonOptiosn.width' must be specified in GreasedLineRibbonPointsMode.POINTS_MODE_POINTS.";let s=[],n=[];if(0===t.pointsMode){let a=t.width/2,o=h0.ToVector3Array(e),l=null,c=null;if(0===t.directionsAutoMode&&(r=dk._GetDirectionFromPoints(o[0],o[1],null)),3===t.directionsAutoMode&&!(t.directions instanceof i1.P))throw"In GreasedLineRibbonAutoDirectionMode.AUTO_DIRECTIONS_FACE_TO 'GreasedLineMeshOptions.ribbonOptions.directions' must be a Vector3.";i1.jp.Vector3[1]=t.directions instanceof i1.P?t.directions:dk.DIRECTION_XZ;for(let e=0;e<o.length-(r?0:1);e++){let u=o[e],h=o[e+1];if(r)l=r;else if(3===t.directionsAutoMode)h.subtractToRef(u,i1.jp.Vector3[0]),l=i1.P.CrossToRef(i1.jp.Vector3[0],i1.jp.Vector3[1],i1.jp.Vector3[2]).normalize();else if(1===t.directionsAutoMode)l=dk._GetDirectionFromPoints(u,h,l);else{let e=h.subtract(u);e.applyRotationQuaternionInPlace(e.x>e.y&&e.x>e.z?i?dk._RightHandedForwardReadOnlyQuaternion:dk._LeftHandedForwardReadOnlyQuaternion:dk._LeftReadOnlyQuaternion),l=e.normalize()}c=l.multiplyByFloats(a,a,a),s.push(u.add(c)),n.push(u.subtract(c))}r||(s.push(o[o.length-1].add(c)),n.push(o[o.length-1].subtract(c)))}return[s,n]}static _GetDirectionFromPoints(e,t,i){return e.x!==t.x||i&&i?.x!==1?e.y===t.y?dk.DIRECTION_XZ:e.z===t.z?dk.DIRECTION_XY:dk.DIRECTION_XZ:dk.DIRECTION_YZ}clone(e=`${this.name}-cloned`,t){let i=this._createLineOptions(),r={},s=[];rd.j.DeepCopy(this._pathsOptions,s,void 0,void 0,!0),rd.j.DeepCopy(i,r,["instance"],void 0,!0);let n=new dk(e,this._scene,r,s);return t&&(n.parent=t),n.material=this.material,n}serialize(e){super.serialize(e),e.type=this.getClassName(),e.lineOptions=this._createLineOptions(),e.pathsOptions=this._pathsOptions}static Parse(e,t){let i=e.lineOptions;return new dk(e.name,t,i,e.pathOptions)}_initGreasedLine(){super._initGreasedLine(),this._paths=[],this._counters=[],this._slopes=[],this._ribbonWidths=[]}_calculateSegmentLengths(e){let t=e.length;this._vSegmentLengths=Array(t),this._vTotalLengths=Array(t);let i=0;for(let r=0;r<t;r++){let t=e[r];this._vSegmentLengths[r]=[0],i=0;for(let e=0;e<t.length-1;e++){let s=Math.abs(t[e].subtract(t[e+1]).lengthSquared());i+=s,this._vSegmentLengths[r].push(s)}this._vTotalLengths[r]=i}let r=e[0].length;this._uSegmentLengths=Array(r).fill([]),this._uTotalLengths=Array(r).fill([]);let s=new i1.P;for(let n=0;n<r;n++){i=0;for(let r=1;r<t;r++){e[r][n].subtractToRef(e[r-1][n],s);let t=s.length();i+=t,this._uSegmentLengths[n].push(t)}this._uTotalLengths[n]=i}}static _CalculateSlopes(e){let t=e[0],i=2===e.length?e[1]:e[e.length-1],r=[],s=new i1.P;for(let n=0;n<t.length;n++)for(let a=0;a<e.length;a++)0===a||a===e.length-1?(t[n].subtract(i[n]).normalizeToRef(s),r.push(s.x,s.y,s.z),r.push(-s.x,-s.y,-s.z)):r.push(0,0,0,0,0,0);return r}_createVertexBuffers(){this._uvs=this._options.uvs??this._uvs;let e=super._createVertexBuffers(this._options.ribbonOptions?.smoothShading),t=new st.l(this._engine,this._counters,this._updatable,1);this.setVerticesBuffer(t.createVertexBuffer("grl_counters",0,1));let i=new st.l(this._engine,this._colorPointers,this._updatable,1);this.setVerticesBuffer(i.createVertexBuffer("grl_colorPointers",0,1));let r=new st.l(this._engine,this._slopes,this._updatable,3);this.setVerticesBuffer(r.createVertexBuffer("grl_slopes",0,3));let s=new st.l(this._engine,this._ribbonWidths,this._updatable,1);return this.setVerticesBuffer(s.createVertexBuffer("grl_widths",0,1)),this._widthsBuffer=s,e}}dk.DEFAULT_WIDTH=.1,dk._RightHandedForwardReadOnlyQuaternion=i1._f.RotationAxis(i1.P.RightHandedForwardReadOnly,Math.PI/2),dk._LeftHandedForwardReadOnlyQuaternion=i1._f.RotationAxis(i1.P.LeftHandedForwardReadOnly,Math.PI/2),dk._LeftReadOnlyQuaternion=i1._f.RotationAxis(i1.P.LeftReadOnly,Math.PI/2),dk.DIRECTION_XY=i1.P.LeftHandedForwardReadOnly,dk.DIRECTION_XZ=i1.P.UpReadOnly,dk.DIRECTION_YZ=i1.P.LeftReadOnly,(ey=ip||(ip={}))[ey.COLOR_DISTRIBUTION_NONE=0]="COLOR_DISTRIBUTION_NONE",ey[ey.COLOR_DISTRIBUTION_REPEAT=1]="COLOR_DISTRIBUTION_REPEAT",ey[ey.COLOR_DISTRIBUTION_EVEN=2]="COLOR_DISTRIBUTION_EVEN",ey[ey.COLOR_DISTRIBUTION_START=3]="COLOR_DISTRIBUTION_START",ey[ey.COLOR_DISTRIBUTION_END=4]="COLOR_DISTRIBUTION_END",ey[ey.COLOR_DISTRIBUTION_START_END=5]="COLOR_DISTRIBUTION_START_END",(eI=im||(im={}))[eI.WIDTH_DISTRIBUTION_NONE=0]="WIDTH_DISTRIBUTION_NONE",eI[eI.WIDTH_DISTRIBUTION_REPEAT=1]="WIDTH_DISTRIBUTION_REPEAT",eI[eI.WIDTH_DISTRIBUTION_EVEN=2]="WIDTH_DISTRIBUTION_EVEN",eI[eI.WIDTH_DISTRIBUTION_START=3]="WIDTH_DISTRIBUTION_START",eI[eI.WIDTH_DISTRIBUTION_END=4]="WIDTH_DISTRIBUTION_END",eI[eI.WIDTH_DISTRIBUTION_START_END=5]="WIDTH_DISTRIBUTION_START_END",i(72563),i(21658),(eP=i_||(i_={}))[eP.Int=1]="Int",eP[eP.Float=2]="Float",eP[eP.Vector2=4]="Vector2",eP[eP.Vector3=8]="Vector3",eP[eP.Vector4=16]="Vector4",eP[eP.Matrix=32]="Matrix",eP[eP.Geometry=64]="Geometry",eP[eP.Texture=128]="Texture",eP[eP.AutoDetect=1024]="AutoDetect",eP[eP.BasedOnInput=2048]="BasedOnInput",eP[eP.Undefined=4096]="Undefined",eP[eP.All=4095]="All",(eR=ig||(ig={}))[eR.Compatible=0]="Compatible",eR[eR.TypeIncompatible=1]="TypeIncompatible",eR[eR.HierarchyIssue=2]="HierarchyIssue",(eA=iv||(iv={}))[eA.Input=0]="Input",eA[eA.Output=1]="Output";class dG{get direction(){return this._direction}get type(){if(this._type===i_.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===i_.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get isConnected(){return null!==this.connectedPoint||this.hasEndpoints}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return 0===this._endpoints.length?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}_resetCounters(){this._callCount=0,this._executionCount=0}get callCount(){return this._callCount}get executionCount(){return this._executionCount}getConnectedValue(e){return this.isConnected?this._connectedPoint?._storedFunction?(this._connectedPoint._callCount++,this._connectedPoint._executionCount++,this._connectedPoint._storedFunction(e)):(this._connectedPoint._callCount++,this._connectedPoint._executionCount=1,this._connectedPoint._storedValue):(this._callCount++,this._executionCount=1,this.value)}constructor(e,t,i){this._connectedPoint=null,this._storedValue=null,this._storedFunction=null,this._acceptedConnectionPointType=null,this._endpoints=[],this._type=i_.Geometry,this._linkedConnectionSource=null,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this.acceptedConnectionPointTypes=[],this.excludedConnectionPointTypes=[],this.onConnectionObservable=new i0.y$,this.onDisconnectionObservable=new i0.y$,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this.defaultValue=null,this.value=null,this.valueMin=null,this.valueMax=null,this._callCount=0,this._executionCount=0,this._ownerBlock=t,this.name=e,this._direction=i}getClassName(){return"NodeGeometryConnectionPoint"}canConnectTo(e){return 0===this.checkCompatibilityState(e)}checkCompatibilityState(e){let t=this._ownerBlock,i=e.ownerBlock;if(this.type!==e.type&&e.innerType!==i_.AutoDetect)return e.acceptedConnectionPointTypes&&-1!==e.acceptedConnectionPointTypes.indexOf(this.type)?0:1;if(e.excludedConnectionPointTypes&&-1!==e.excludedConnectionPointTypes.indexOf(this.type))return 1;let r=i,s=t;return(0===this.direction&&(r=t,s=i),r.isAnAncestorOf(s))?2:0}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){let t=this._endpoints.indexOf(e);return -1===t||(this._endpoints.splice(t,1),e._connectedPoint=null,this.onDisconnectionObservable.notifyObservers(e),e.onDisconnectionObservable.notifyObservers(this)),this}addExcludedConnectionPointFromAllowedTypes(e){let t=1;for(;t<i_.All;)e&t||this.excludedConnectionPointTypes.push(t),t<<=1}serialize(e=!0){let t={};return t.name=this.name,t.displayName=this.displayName,void 0!==this.value&&null!==this.value&&(this.value.asArray?(t.valueType="BABYLON."+this.value.getClassName(),t.value=this.value.asArray()):(t.valueType="number",t.value=this.value)),e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear(),this.onDisconnectionObservable.clear()}}class dz{get buildExecutionTime(){return this._buildExecutionTime}get inputs(){return this._inputs}get outputs(){return this._outputs}get name(){return this._name}set name(e){this._name=e}get isInput(){return this._isInput}get isTeleportOut(){return this._isTeleportOut}get isTeleportIn(){return this._isTeleportIn}get isDebug(){return this._isDebug}get isUnique(){return this._isUnique}getClassName(){return"NodeGeometryBlock"}_inputRename(e){return e}_outputRename(e){return e}isAnAncestorOf(e){for(let t of this._outputs)if(t.hasEndpoints){for(let i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(let t of this._outputs)if(t.hasEndpoints){for(let i of t.endpoints)if(i.ownerBlock.isAnAncestorOfType(e))return!0}return!1}getDescendantOfPredicate(e){if(e(this))return this;for(let t of this._outputs)if(t.hasEndpoints)for(let i of t.endpoints){let t=i.ownerBlock.getDescendantOfPredicate(e);if(t)return t}return null}constructor(e){this._name="",this._isInput=!1,this._isTeleportOut=!1,this._isTeleportIn=!1,this._isDebug=!1,this._isUnique=!1,this._buildExecutionTime=0,this.onBuildObservable=new i0.y$,this._inputs=[],this._outputs=[],this._codeVariableName="",this.visibleOnFrame=!1,this._name=e,this.uniqueId=lI.K.UniqueId}registerInput(e,t,i=!1,r,s,n){let a=new dG(e,this,0);return a.type=t,a.isOptional=i,a.defaultValue=r,a.value=r,a.valueMin=s,a.valueMax=n,this._inputs.push(a),this}registerOutput(e,t,i){return(i=i??new dG(e,this,1)).type=t,this._outputs.push(i),this}_buildBlock(e){}_customBuildStep(e){}build(e){if(this._buildId===e.buildId)return!0;if(this._outputs.length>0){if(!this._outputs.some(e=>e.hasEndpoints)&&!this.isDebug)return!1;this.outputs.forEach(e=>e._resetCounters())}for(let t of(this._buildId=e.buildId,this._inputs)){if(!t.connectedPoint){t.isOptional||e.notConnectedNonOptionalInputs.push(t);continue}let i=t.connectedPoint.ownerBlock;i&&i!==this&&i.build(e)}this._customBuildStep(e),e.verbose&&re.Y.Log(`Building ${this.name} [${this.getClassName()}]`);let t=rW.F.Now;for(let i of(this._buildBlock(e),this._buildExecutionTime=rW.F.Now-t,this._outputs))for(let t of i.endpoints){let i=t.ownerBlock;i&&i.build(e)}return this.onBuildObservable.notifyObservers(this),!1}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}initialize(){}autoConfigure(){}getInputByName(e){let t=this._inputs.filter(t=>t.name===e);return t.length?t[0]:null}getOutputByName(e){let t=this._outputs.filter(t=>t.name===e);return t.length?t[0]:null}serialize(){let e={};for(let t of(e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.visibleOnFrame=this.visibleOnFrame,e.inputs=[],e.outputs=[],this.inputs))e.inputs.push(t.serialize());for(let t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e){this._name=e.name,this.comments=e.comments,this.visibleOnFrame=!!e.visibleOnFrame,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){let t=e.inputs,i=e.outputs;t&&t.forEach(e=>{let t=this.inputs.find(t=>t.name===e.name);if(t&&(e.displayName&&(t.displayName=e.displayName),e.isExposedOnFrame&&(t.isExposedOnFrame=e.isExposedOnFrame,t.exposedPortPosition=e.exposedPortPosition),void 0!==e.value&&null!==e.value)){if("number"===e.valueType)t.value=e.value;else{let i=(0,i3.qw)(e.valueType);i&&(t.value=i.FromArray(e.value))}}}),i&&i.forEach((e,t)=>{e.displayName&&(this.outputs[t].displayName=e.displayName),e.isExposedOnFrame&&(this.outputs[t].isExposedOnFrame=e.isExposedOnFrame,this.outputs[t].exposedPortPosition=e.exposedPortPosition)})}_dumpPropertiesCode(){let e=this._codeVariableName;return`${e}.visibleOnFrame = ${this.visibleOnFrame};
`}_dumpCodeForOutputConnections(e){let t="";if(-1!==e.indexOf(this))return t;for(let i of(e.push(this),this.inputs)){if(!i.isConnected)continue;let r=i.connectedPoint,s=r.ownerBlock;t+=s._dumpCodeForOutputConnections(e)+`${s._codeVariableName}.${s._outputRename(r.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});
`}return t}_dumpCode(e,t){t.push(this);let i=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=i||`${this.getClassName()}_${this.uniqueId}`,-1!==e.indexOf(this._codeVariableName)){let t=0;do t++,this._codeVariableName=i+t;while(-1!==e.indexOf(this._codeVariableName))}e.push(this._codeVariableName);let r=`
// ${this.getClassName()}
`;this.comments&&(r+=`// ${this.comments}
`);let s=this.getClassName();if("GeometryInputBlock"===s){let e=this.type;r+=`var ${this._codeVariableName} = new BABYLON.GeometryInputBlock("${this.name}", ${e});
`}else r+=`var ${this._codeVariableName} = new BABYLON.${s}("${this.name}");
`;for(let i of(r+=this._dumpPropertiesCode(),this.inputs)){if(!i.isConnected)continue;let s=i.connectedPoint.ownerBlock;-1===t.indexOf(s)&&(r+=s._dumpCode(e,t))}for(let i of this.outputs)if(i.hasEndpoints)for(let s of i.endpoints){let i=s.ownerBlock;i&&-1===t.indexOf(i)&&(r+=i._dumpCode(e,t))}return r}clone(){let e=this.serialize(),t=(0,i3.qw)(e.customType);if(t){let i=new t;return i._deserialize(e),i}return null}dispose(){for(let e of this.inputs)e.dispose();for(let e of this.outputs)e.dispose();this.onBuildObservable.clear()}}(0,r$.gn)([(0,rj.qC)("comment")],dz.prototype,"comments",void 0);class dH extends dz{get currentVertexData(){return this._vertexData}constructor(e){super(e),this._vertexData=null,this._isUnique=!0,this.registerInput("geometry",i_.Geometry)}getClassName(){return"GeometryOutputBlock"}get geometry(){return this._inputs[0]}_buildBlock(e){e.vertexData=this.geometry.getConnectedValue(e),this._vertexData=e.vertexData}}(0,i3.H7)("BABYLON.GeometryOutputBlock",dH),(eM=iS||(iS={}))[eM.None=0]="None",eM[eM.Positions=1]="Positions",eM[eM.Normals=2]="Normals",eM[eM.Tangents=3]="Tangents",eM[eM.UV=4]="UV",eM[eM.UV2=5]="UV2",eM[eM.UV3=6]="UV3",eM[eM.UV4=7]="UV4",eM[eM.UV5=8]="UV5",eM[eM.UV6=9]="UV6",eM[eM.Colors=10]="Colors",eM[eM.VertexID=11]="VertexID",eM[eM.FaceID=12]="FaceID",eM[eM.GeometryID=13]="GeometryID",eM[eM.CollectionID=14]="CollectionID",eM[eM.LoopID=15]="LoopID",eM[eM.InstanceID=16]="InstanceID";class dW{constructor(){this._rotationMatrix=new i1.y3,this._scalingMatrix=new i1.y3,this._positionMatrix=new i1.y3,this._scalingRotationMatrix=new i1.y3,this._transformMatrix=new i1.y3,this._tempVector3=new i1.P,this.notConnectedNonOptionalInputs=[],this.noContextualData=[],this.vertexData=null,this._geometryContext=null,this._executionContext=null,this._instancingContext=null,this._geometryContextStack=[],this._executionContextStack=[],this._instancingContextStack=[]}get geometryContext(){return this._geometryContext}get executionContext(){return this._executionContext}get instancingContext(){return this._instancingContext}pushGeometryContext(e){this._geometryContext=e,this._geometryContextStack.push(this._geometryContext)}pushExecutionContext(e){this._executionContext=e,this._executionContextStack.push(this._executionContext)}pushInstancingContext(e){this._instancingContext=e,this._instancingContextStack.push(this._instancingContext)}restoreGeometryContext(){this._geometryContextStack.pop(),this._geometryContext=this._geometryContextStack.length>0?this._geometryContextStack[this._geometryContextStack.length-1]:null}restoreExecutionContext(){this._executionContextStack.pop(),this._executionContext=this._executionContextStack.length>0?this._executionContextStack[this._executionContextStack.length-1]:null}restoreInstancingContext(){this._instancingContextStack.pop(),this._instancingContext=this._instancingContextStack.length>0?this._instancingContextStack[this._instancingContextStack.length-1]:null}getContextualValue(e,t=!1){if(!this.executionContext)return t||this.noContextualData.push(e),null;let i=this.executionContext.getExecutionIndex();switch(e){case iS.Positions:if(this.executionContext.getOverridePositionsContextualValue)return this.executionContext.getOverridePositionsContextualValue();if(!this.geometryContext||!this.geometryContext.positions)return i1.P.Zero();return i1.P.FromArray(this.geometryContext.positions,3*i);case iS.Normals:if(this.executionContext.getOverrideNormalsContextualValue)return this.executionContext.getOverrideNormalsContextualValue();if(!this.geometryContext||!this.geometryContext.normals)return i1.P.Zero();return i1.P.FromArray(this.geometryContext.normals,3*i);case iS.Colors:if(!this.geometryContext||!this.geometryContext.colors)return i1.Lt.Zero();return i1.Lt.FromArray(this.geometryContext.colors,4*i);case iS.Tangents:if(!this.geometryContext||!this.geometryContext.tangents)return i1.Lt.Zero();return i1.Lt.FromArray(this.geometryContext.tangents,4*i);case iS.UV:if(this.executionContext.getOverrideUVs1ContextualValue)return this.executionContext.getOverrideUVs1ContextualValue();if(!this.geometryContext||!this.geometryContext.uvs)return i1.FM.Zero();return i1.FM.FromArray(this.geometryContext.uvs,2*i);case iS.UV2:if(!this.geometryContext||!this.geometryContext.uvs2)return i1.FM.Zero();return i1.FM.FromArray(this.geometryContext.uvs2,2*i);case iS.UV3:if(!this.geometryContext||!this.geometryContext.uvs3)return i1.FM.Zero();return i1.FM.FromArray(this.geometryContext.uvs3,2*i);case iS.UV4:if(!this.geometryContext||!this.geometryContext.uvs4)return i1.FM.Zero();return i1.FM.FromArray(this.geometryContext.uvs4,2*i);case iS.UV5:if(!this.geometryContext||!this.geometryContext.uvs5)return i1.FM.Zero();return i1.FM.FromArray(this.geometryContext.uvs5,2*i);case iS.UV6:if(!this.geometryContext||!this.geometryContext.uvs6)return i1.FM.Zero();return i1.FM.FromArray(this.geometryContext.uvs6,2*i);case iS.VertexID:return i;case iS.FaceID:return this.executionContext.getExecutionFaceIndex();case iS.LoopID:return this.executionContext.getExecutionLoopIndex();case iS.InstanceID:return this.instancingContext?this.instancingContext.getInstanceIndex():0;case iS.GeometryID:return this.geometryContext?this.geometryContext.uniqueId:0;case iS.CollectionID:if(!this.geometryContext||!this.geometryContext.metadata)return 0;return this.geometryContext.metadata.collectionId||0}return null}adapt(e,t){let i=e.getConnectedValue(this)||0;if(e.type===t)return i;switch(t){case i_.Vector2:return new i1.FM(i,i);case i_.Vector3:return new i1.P(i,i,i);case i_.Vector4:return new i1.Lt(i,i,i,i)}return null}adaptInput(e,t,i){if(!e.isConnected)return e.value||i;let r=e.getConnectedValue(this);if(e._connectedPoint?.type===t)return r;switch(t){case i_.Vector2:return new i1.FM(r,r);case i_.Vector3:return new i1.P(r,r,r);case i_.Vector4:return new i1.Lt(r,r,r,r)}return null}emitErrors(){let e="";for(let t of this.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.
`;for(let t of this.noContextualData)e+=`Contextual input ${iS[t]} has no context to pull data from (must be connected to a setXXX block or a instantiateXXX block).
`;if(e)throw"Build of NodeGeometry failed:\n"+e}_instantiate(e,t,i,r,s){i1.y3.ScalingToRef(r.x,r.y,r.z,this._scalingMatrix),i1.y3.RotationYawPitchRollToRef(i.y,i.x,i.z,this._rotationMatrix),i1.y3.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),i1.P.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),i1.P.TransformNormalToRef(this._tempVector3,this._scalingRotationMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));s.push(e)}_instantiateWithMatrix(e,t,i){for(let i=0;i<e.positions.length;i+=3)this._tempVector3.fromArray(e.positions,i),i1.P.TransformCoordinatesToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.positions,i),e.normals&&(this._tempVector3.fromArray(e.normals,i),i1.P.TransformNormalToRef(this._tempVector3,t,this._tempVector3),this._tempVector3.toArray(e.normals,i));i.push(e)}_instantiateWithPositionAndMatrix(e,t,i,r){i1.y3.TranslationToRef(t.x,t.y,t.z,this._positionMatrix),i.multiplyToRef(this._positionMatrix,this._transformMatrix);for(let t=0;t<e.positions.length;t+=3)this._tempVector3.fromArray(e.positions,t),i1.P.TransformCoordinatesToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.positions,t),e.normals&&(this._tempVector3.fromArray(e.normals,t),i1.P.TransformNormalToRef(this._tempVector3,this._transformMatrix,this._tempVector3),this._tempVector3.toArray(e.normals,t));r.push(e)}}class dY extends dz{get type(){if(this._type===i_.AutoDetect&&null!=this.value){if(!isNaN(this.value))return this._type=i_.Float,this._type;switch(this.value.getClassName()){case"Vector2":this._type=i_.Vector2;break;case"Vector3":this._type=i_.Vector3;break;case"Vector4":this._type=i_.Vector4;break;case"Matrix":this._type=i_.Matrix}}return this._type}get isContextual(){return this._contextualSource!==iS.None}get contextualValue(){return this._contextualSource}set contextualValue(e){switch(this._contextualSource=e,e){case iS.Positions:case iS.Normals:this._type=i_.Vector3;break;case iS.Colors:case iS.Tangents:this._type=i_.Vector4;break;case iS.UV:case iS.UV2:case iS.UV3:case iS.UV4:case iS.UV5:case iS.UV6:this._type=i_.Vector2;break;case iS.VertexID:case iS.GeometryID:case iS.CollectionID:case iS.FaceID:case iS.LoopID:case iS.InstanceID:this._type=i_.Int}this.output&&(this.output.type=this._type)}constructor(e,t=i_.AutoDetect){super(e),this._type=i_.Undefined,this._contextualSource=iS.None,this.min=0,this.max=0,this.groupInInspector="",this.onValueChangedObservable=new i0.y$,this._type=t,this._isInput=!0,this.setDefaultValue(),this.registerOutput("output",t)}get value(){return this._storedValue}set value(e){this.type===i_.Float&&this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e)),this._storedValue=e,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e}getClassName(){return"GeometryInputBlock"}get output(){return this._outputs[0]}setDefaultValue(){switch(this.contextualValue=iS.None,this.type){case i_.Int:case i_.Float:this.value=0;break;case i_.Vector2:this.value=i1.FM.Zero();break;case i_.Vector3:this.value=i1.P.Zero();break;case i_.Vector4:this.value=i1.Lt.Zero();break;case i_.Matrix:this.value=i1.y3.Identity()}}_buildBlock(e){super._buildBlock(e),this.isContextual?(this.output._storedValue=null,this.output._storedFunction=e=>e.getContextualValue(this._contextualSource)):(this.output._storedFunction=null,this.output._storedValue=this.value)}dispose(){this.onValueChangedObservable.clear(),super.dispose()}_dumpPropertiesCode(){let e=this._codeVariableName;if(this.isContextual)return super._dumpPropertiesCode()+`${e}.contextualValue = BABYLON.NodeGeometryContextualSources.${iS[this._contextualSource]};
`;let t=[],i="";switch(this.type){case i_.Float:case i_.Int:i=`${this.value}`;break;case i_.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case i_.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case i_.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`}return t.push(`${e}.value = ${i}`),(this.type===i_.Float||this.type===i_.Int)&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`),t.push(""),super._dumpPropertiesCode()+t.join(";\n")}serialize(){let e=super.serialize();return e.type=this.type,e.contextualValue=this.contextualValue,e.min=this.min,e.max=this.max,e.groupInInspector=this.groupInInspector,null===this._storedValue||this.isContextual||(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e){if(super._deserialize(e),this._type=e.type,this.contextualValue=e.contextualValue,this.min=e.min||0,this.max=e.max||0,this.groupInInspector=e.groupInInspector||"",e.valueType){if("number"===e.valueType)this._storedValue=e.value;else{let t=(0,i3.qw)(e.valueType);t&&(this._storedValue=t.FromArray(e.value))}}}}(0,i3.H7)("BABYLON.GeometryInputBlock",dY);class dX extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("size",i_.Float,!0,1),this.registerInput("width",i_.Float,!0,0),this.registerInput("height",i_.Float,!0,0),this.registerInput("depth",i_.Float,!0,0),this.registerInput("subdivisions",i_.Int,!0,1),this.registerInput("subdivisionsX",i_.Int,!0,0),this.registerInput("subdivisionsY",i_.Int,!0,0),this.registerInput("subdivisionsZ",i_.Int,!0,0),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"BoxBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get depth(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get subdivisionsX(){return this._inputs[5]}get subdivisionsY(){return this._inputs[6]}get subdivisionsZ(){return this._inputs[7]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected&&!this.depth.isConnected){let e=new dY("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){let e=new dY("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){let e=new dY("Height");e.value=1,e.output.connectTo(this.height)}if(!this.depth.isConnected){let e=new dY("Depth");e.value=1,e.output.connectTo(this.depth)}}}_buildBlock(e){let t={},i=e=>{t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.depth=this.depth.getConnectedValue(e);let i=this.subdivisions.getConnectedValue(e),r=this.subdivisionsX.getConnectedValue(e),s=this.subdivisionsY.getConnectedValue(e),n=this.subdivisionsZ.getConnectedValue(e);return i&&(t.segments=i),r&&(t.widthSegments=r),s&&(t.heightSegments=s),n&&(t.depthSegments=n),(0,nX.ZU)(t)};if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],dX.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.BoxBlock",dX);class d${_getGlobalNodeGeometryEditor(){return"undefined"!=typeof NODEGEOMETRYEDITOR?NODEGEOMETRYEDITOR:"undefined"!=typeof BABYLON&&void 0!==BABYLON.NodeGeometryEditor?BABYLON:void 0}get buildExecutionTime(){return this._buildExecutionTime}constructor(e){this._buildId=d$._BuildIdGenerator++,this._buildWasSuccessful=!1,this._vertexData=null,this._buildExecutionTime=0,this.BJSNODEGEOMETRYEDITOR=this._getGlobalNodeGeometryEditor(),this.editorData=null,this.attachedBlocks=[],this.onBuildObservable=new i0.y$,this.outputBlock=null,this.name=e}getClassName(){return"NodeGeometry"}get vertexData(){return this._vertexData}getBlockByName(e){let t=null;for(let i of this.attachedBlocks)if(i.name===e){if(t){rD.w1.Warn("More than one block was found with the name `"+e+"`");break}t=i}return t}getBlockByPredicate(e){for(let t of this.attachedBlocks)if(e(t))return t;return null}getInputBlocks(){let e=[];for(let t of this.attachedBlocks)t.isInput&&e.push(t);return e}edit(e){return new Promise(t=>{if(this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),void 0===this.BJSNODEGEOMETRYEDITOR){let i=e&&e.editorURL?e.editorURL:d$.EditorURL;rD.w1.LoadBabylonScript(i,()=>{this.BJSNODEGEOMETRYEDITOR=this.BJSNODEGEOMETRYEDITOR||this._getGlobalNodeGeometryEditor(),this._createNodeEditor(e?.nodeGeometryEditorConfig),t()})}else this._createNodeEditor(e?.nodeGeometryEditorConfig),t()})}_createNodeEditor(e){let t={nodeGeometry:this,...e};this.BJSNODEGEOMETRYEDITOR.NodeGeometryEditor.Show(t)}build(e=!1,t=!0,i=!1){if(this._buildWasSuccessful=!1,!this.outputBlock)throw"You must define the outputBlock property before building the geometry";let r=rW.F.Now;this._initializeBlock(this.outputBlock,i);let s=new dW;s.buildId=this._buildId,s.verbose=e,this.outputBlock.build(s),t&&(this._buildId=d$._BuildIdGenerator++),this._buildExecutionTime=rW.F.Now-r,s.emitErrors(),this._buildWasSuccessful=!0,this._vertexData=s.vertexData,this.onBuildObservable.notifyObservers(this)}createMesh(e,t=null){if(this._buildWasSuccessful||this.build(),!this._vertexData)return null;let i=new rP.Kj(e,t);return this._vertexData.applyToMesh(i),i._internalMetadata=i._internalMetadata||{},i._internalMetadata.nodeGeometry=this,i}updateMesh(e){return this._buildWasSuccessful||this.build(),!!this._vertexData&&(this._vertexData.applyToMesh(e),e._internalMetadata=e._internalMetadata||{},e._internalMetadata.nodeGeometry=this,e)}_initializeBlock(e,t=!0){for(let i of(e.initialize(),t&&e.autoConfigure(),e._preparationId=this._buildId,-1===this.attachedBlocks.indexOf(e)&&this.attachedBlocks.push(e),e.inputs)){let r=i.connectedPoint;if(r){let i=r.ownerBlock;i!==e&&this._initializeBlock(i,t)}}}clear(){this.outputBlock=null,this.attachedBlocks.length=0}removeBlock(e){let t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e===this.outputBlock&&(this.outputBlock=null)}parseSerializedObject(e,t=!1){t||this.clear();let i={};for(let t of e.blocks){let e=(0,i3.qw)(t.customType);if(e){let r=new e;r._deserialize(t),i[t.id]=r,this.attachedBlocks.push(r)}}for(let e of this.attachedBlocks)if(e.isTeleportOut){let t=e._tempEntryPointUniqueId;if(t){let r=i[t];r&&r.attachToEndpoint(e)}}for(let r=0;r<e.blocks.length;r++){let s=e.blocks[r],n=i[s.id];!n||n.inputs.length&&s.inputs.some(e=>e.targetConnectionName)&&!t||this._restoreConnections(n,e,i)}if(e.outputNodeId&&(this.outputBlock=i[e.outputNodeId]),e.locations||e.editorData&&e.editorData.locations){let r=e.locations||e.editorData.locations;for(let e of r)i[e.blockId]&&(e.blockId=i[e.blockId].uniqueId);t&&this.editorData&&this.editorData.locations&&r.concat(this.editorData.locations),e.locations?this.editorData={locations:r}:(this.editorData=e.editorData,this.editorData.locations=r);let s=[];for(let e in i)s[e]=i[e].uniqueId;this.editorData.map=s}this.comment=e.comment}_restoreConnections(e,t,i){for(let r of e.outputs)for(let s of t.blocks){let n=i[s.id];if(n){for(let a of s.inputs)if(i[a.targetBlockId]===e&&a.targetConnectionName===r.name){let e=n.getInputByName(a.inputName);if(!e||e.isConnected)continue;r.connectTo(e,!0),this._restoreConnections(n,t,i);continue}}}}generateCode(){let e=[],t=[],i=["const","var","let"];this.outputBlock&&this._gatherBlocks(this.outputBlock,t);let r=`let nodeGeometry = new BABYLON.NodeGeometry("${this.name||"node geometry"}");
`;for(let s of t)s.isInput&&-1===e.indexOf(s)&&(r+=s._dumpCode(i,e));return this.outputBlock&&(e=[],r+="// Connections\n"+this.outputBlock._dumpCodeForOutputConnections(e)+"// Output nodes\n"+`nodeGeometry.outputBlock = ${this.outputBlock._codeVariableName};
`+`nodeGeometry.build();
`),r}_gatherBlocks(e,t){if(-1===t.indexOf(e)){for(let i of(t.push(e),e.inputs)){let r=i.connectedPoint;if(r){let i=r.ownerBlock;i!==e&&this._gatherBlocks(i,t)}}e.isTeleportOut&&e.entryPoint&&this._gatherBlocks(e.entryPoint,t)}}setToDefault(){this.clear(),this.editorData=null;let e=new dX("Box");e.autoConfigure();let t=new dH("Geometry Output");e.geometry.connectTo(t.geometry),this.outputBlock=t}clone(e){let t=this.serialize(),i=rq.p.Clone(()=>new d$(e),this);return i.name=e,i.parseSerializedObject(t),i._buildId=this._buildId,i.build(!1),i}serialize(e){let t=e?{}:rq.p.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];for(let r of(e?i=e:(t.customType="BABYLON.NodeGeometry",this.outputBlock&&(t.outputNodeId=this.outputBlock.uniqueId)),t.blocks=[],i))t.blocks.push(r.serialize());if(!e)for(let e of this.attachedBlocks)-1===i.indexOf(e)&&t.blocks.push(e.serialize());return t}dispose(){for(let e of this.attachedBlocks)e.dispose();this.attachedBlocks.length=0,this.onBuildObservable.clear()}static CreateDefault(e){let t=new d$(e);return t.setToDefault(),t.build(),t}static Parse(e){let t=rq.p.Parse(()=>new d$(e.name),e,null);return t.parseSerializedObject(e),t.build(),t}static ParseFromSnippetAsync(e,t,i=!1){return"_BLANK"===e?Promise.resolve(d$.CreateDefault("blank")):new Promise((r,s)=>{let n=new lk.g;n.addEventListener("readystatechange",()=>{if(4==n.readyState){if(200==n.status){let a=JSON.parse(JSON.parse(JSON.parse(n.responseText).jsonPayload).nodeGeometry);t||(t=rq.p.Parse(()=>new d$(e),a,null)),t.parseSerializedObject(a),t.snippetId=e;try{i||t.build(),r(t)}catch(e){s(e)}}else s("Unable to load the snippet "+e)}}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}d$._BuildIdGenerator=0,d$.EditorURL=`${rD.w1._DefaultCdnUrl}/v${rV.a.Version}/nodeGeometryEditor/babylon.nodeGeometryEditor.js`,d$.SnippetUrl="https://snippet.babylonjs.com",(0,r$.gn)([(0,rj.qC)()],d$.prototype,"name",void 0),(0,r$.gn)([(0,rj.qC)("comment")],d$.prototype,"comment",void 0);class dj extends dz{constructor(e){super(e),this.evaluateContext=!0,this.epsilon=r2.kn,this.optimizeFaces=!1,this.registerInput("geometry",i_.Geometry),this.registerOutput("output",i_.Geometry)}getClassName(){return"GeometryOptimizeBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{if(!this.geometry.isConnected)return null;let t=this.geometry.getConnectedValue(e),i=[],r={};for(let e=0;e<t.positions.length;e+=3){let s=t.positions[e],n=t.positions[e+1],a=t.positions[e+2],o=!1;for(let t=0;t<i.length;t+=3)if((0,aP.WithinEpsilon)(s,i[t],this.epsilon)&&(0,aP.WithinEpsilon)(n,i[t+1],this.epsilon)&&(0,aP.WithinEpsilon)(a,i[t+2],this.epsilon)){r[e/3]=t/3,o=!0;continue}o||(r[e/3]=i.length/3,i.push(s,n,a))}let s=new nK.x;s.positions=i;let n=t.indices.map(e=>r[e]),a=[];if(this.optimizeFaces){for(let e=0;e<n.length;e+=3){let t=n[e],i=n[e+1],r=n[e+2];if(t===i||i==r||r===t)continue;let s=!1;for(let e=0;e<a.length;e+=3)if(t===a[e]&&i===a[e+1]&&r===a[e+2]||t===a[e+1]&&i===a[e+2]&&r===a[e]||t===a[e+2]&&i===a[e]&&r===a[e+1]){s=!0;continue}s||a.push(t,i,r)}s.indices=a}else s.indices=n;return s};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`+`${this._codeVariableName}.epsilon = ${this.epsilon};
${this._codeVariableName}.optimizeFaces = ${this.optimizeFaces?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.epsilon=this.epsilon,e.optimizeFaces=this.optimizeFaces,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,this.epsilon=e.epsilon,this.optimizeFaces=e.optimizeFaces}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],dj.prototype,"evaluateContext",void 0),(0,r$.gn)([lM("Epsilon",1,"ADVANCED",{notifiers:{rebuild:!0}})],dj.prototype,"epsilon",void 0),(0,r$.gn)([lM("Optimize faces",0,"ADVANCED",{notifiers:{rebuild:!0}})],dj.prototype,"optimizeFaces",void 0),(0,i3.H7)("BABYLON.GeometryOptimizeBlock",dj);class dq extends dz{constructor(e){super(e),this._rotationMatrix=new i1.y3,this.evaluateContext=!1,this.registerInput("size",i_.Float,!0,1),this.registerInput("width",i_.Float,!0,0),this.registerInput("height",i_.Float,!0,0),this.registerInput("subdivisions",i_.Int,!0,1),this.registerInput("subdivisionsX",i_.Int,!0,0),this.registerInput("subdivisionsY",i_.Int,!0,0),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"PlaneBlock"}get size(){return this._inputs[0]}get width(){return this._inputs[1]}get height(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get subdivisionsX(){return this._inputs[4]}get subdivisionsY(){return this._inputs[5]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.size.isConnected){if(!this.width.isConnected&&!this.height.isConnected){let e=new dY("Size");e.value=1,e.output.connectTo(this.size);return}if(!this.width.isConnected){let e=new dY("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){let e=new dY("Height");e.value=1,e.output.connectTo(this.height)}}}_buildBlock(e){let t={},i=e=>{t.size=this.size.getConnectedValue(e),t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e);let i=this.subdivisions.getConnectedValue(e),r=this.subdivisionsX.getConnectedValue(e),s=this.subdivisionsY.getConnectedValue(e);i&&(t.subdivisions=i),r&&(t.subdivisionsX=r),s&&(t.subdivisionsY=s);let n=(0,nv.kt)(t);return i1.y3.RotationYawPitchRollToRef(-Math.PI/2,0,Math.PI/2,this._rotationMatrix),n.transform(this._rotationMatrix),n};if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],dq.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.PlaneBlock",dq);class dQ extends dz{get mesh(){return this._mesh}set mesh(e){this._mesh=e}constructor(e){super(e),this._cachedVertexData=null,this.reverseWindingOrder=!1,this.serializedCachedData=!1,this.registerOutput("geometry",i_.Geometry)}getClassName(){return"MeshBlock"}get isUsingCachedData(){return!this.mesh&&!!this._cachedVertexData}get geometry(){return this._outputs[0]}cleanData(){this._mesh=null,this._cachedVertexData=null}_buildBlock(){if(!this._mesh){this._cachedVertexData?this.geometry._storedValue=this._cachedVertexData.clone():this.geometry._storedValue=null;return}let e=nK.x.ExtractFromMesh(this._mesh,!1,!0);if(this._cachedVertexData=null,this.reverseWindingOrder&&e.indices)for(let t=0;t<e.indices.length;t+=3){let i=e.indices[t];e.indices[t]=e.indices[t+2],e.indices[t+2]=i}this.geometry._storedFunction=()=>e.clone()}serialize(){let e=super.serialize();return e.serializedCachedData=this.serializedCachedData,this.serializedCachedData&&(this._mesh?e.cachedVertexData=nK.x.ExtractFromMesh(this._mesh,!1,!0).serialize():this._cachedVertexData&&(e.cachedVertexData=this._cachedVertexData.serialize())),e.reverseWindingOrder=this.reverseWindingOrder,e}_deserialize(e){super._deserialize(e),e.cachedVertexData&&(this._cachedVertexData=nK.x.Parse(e.cachedVertexData)),this.serializedCachedData=!!e.serializedCachedData,this.reverseWindingOrder=e.reverseWindingOrder}}(0,r$.gn)([lM("Serialize cached data",0,"ADVANCED",{notifiers:{rebuild:!0}})],dQ.prototype,"serializedCachedData",void 0),(0,i3.H7)("BABYLON.MeshBlock",dQ);class dK extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",i_.Float,!0,1),this.registerInput("radiusX",i_.Float,!0,0),this.registerInput("radiusY",i_.Float,!0,0),this.registerInput("radiusZ",i_.Float,!0,0),this.registerInput("subdivisions",i_.Int,!0,4),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"IcoSphereBlock"}get radius(){return this._inputs[0]}get radiusX(){return this._inputs[1]}get radiusY(){return this._inputs[2]}get radiusZ(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){let e=new dY("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){let t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.radiusX=this.radiusX.getConnectedValue(e),t.radiusY=this.radiusY.getConnectedValue(e),t.radiusZ=this.radiusZ.getConnectedValue(e),(0,l3.GQ)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],dK.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.IcoSphereBlock",dK);class dZ extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("segments",i_.Int,!0,32),this.registerInput("diameter",i_.Float,!0,1),this.registerInput("diameterX",i_.Float,!0,0),this.registerInput("diameterY",i_.Float,!0,0),this.registerInput("diameterZ",i_.Float,!0,0),this.registerInput("arc",i_.Float,!0,1),this.registerInput("slice",i_.Float,!0,1),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"SphereBlock"}get segments(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterX(){return this._inputs[2]}get diameterY(){return this._inputs[3]}get diameterZ(){return this._inputs[4]}get arc(){return this._inputs[5]}get slice(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){let e=new dY("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){let t={},i=e=>(t.segments=this.segments.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterX=this.diameterX.getConnectedValue(e),t.diameterY=this.diameterY.getConnectedValue(e),t.diameterZ=this.diameterZ.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),t.slice=this.slice.getConnectedValue(e),(0,n$.jY)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],dZ.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.SphereBlock",dZ);class dJ extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("width",i_.Float,!0,1),this.registerInput("height",i_.Float,!0,1),this.registerInput("subdivisions",i_.Int,!0,1),this.registerInput("subdivisionsX",i_.Int,!0,0),this.registerInput("subdivisionsY",i_.Int,!0,0),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"GridBlock"}get width(){return this._inputs[0]}get height(){return this._inputs[1]}get subdivisions(){return this._inputs[2]}get subdivisionsX(){return this._inputs[3]}get subdivisionsY(){return this._inputs[4]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.width.isConnected){let e=new dY("Width");e.value=1,e.output.connectTo(this.width)}if(!this.height.isConnected){let e=new dY("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){let t={},i=e=>(t.width=this.width.getConnectedValue(e),t.height=this.height.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.subdivisionsX=this.subdivisionsX.getConnectedValue(e),t.subdivisionsY=this.subdivisionsY.getConnectedValue(e),(0,nv.kt)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],dJ.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.GridBlock",dJ);class d0 extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("diameter",i_.Float,!0,1),this.registerInput("thickness",i_.Float,!0,.5),this.registerInput("tessellation",i_.Int,!0,16),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"TorusBlock"}get diameter(){return this._inputs[0]}get thickness(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){let e=new dY("Diameter");e.value=1,e.output.connectTo(this.diameter)}}_buildBlock(e){let t={},i=e=>(t.thickness=this.thickness.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),(0,nS.h5)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d0.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.TorusBlock",d0);class d1 extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",i_.Float,!0,25),this.registerInput("diameter",i_.Float,!0,1),this.registerInput("diameterTop",i_.Float,!0,-1),this.registerInput("diameterBottom",i_.Float,!0,-1),this.registerInput("subdivisions",i_.Int,!0,1),this.registerInput("tessellation",i_.Int,!0,24),this.registerInput("arc",i_.Float,!0,1),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"CylinderBlock"}get height(){return this._inputs[0]}get diameter(){return this._inputs[1]}get diameterTop(){return this._inputs[2]}get diameterBottom(){return this._inputs[3]}get subdivisions(){return this._inputs[4]}get tessellation(){return this._inputs[5]}get arc(){return this._inputs[6]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.diameter.isConnected){let e=new dY("Diameter");e.value=1,e.output.connectTo(this.diameter)}if(!this.height.isConnected){let e=new dY("Height");e.value=1,e.output.connectTo(this.height)}}_buildBlock(e){let t={},i=e=>(t.height=this.height.getConnectedValue(e),t.diameter=this.diameter.getConnectedValue(e),t.diameterTop=this.diameterTop.getConnectedValue(e),t.diameterBottom=this.diameterBottom.getConnectedValue(e),-1===t.diameterTop&&(t.diameterTop=t.diameter),-1===t.diameterBottom&&(t.diameterBottom=t.diameter),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),(0,nz.zD)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d1.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.CylinderBlock",d1);class d2 extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("height",i_.Float,!0,1),this.registerInput("radius",i_.Float,!0,.25),this.registerInput("tessellation",i_.Int,!0,16),this.registerInput("subdivisions",i_.Int,!0,2),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"CapsuleBlock"}get height(){return this._inputs[0]}get radius(){return this._inputs[1]}get tessellation(){return this._inputs[2]}get subdivisions(){return this._inputs[3]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.height.isConnected){let e=new dY("Height");e.value=1,e.output.connectTo(this.height)}if(!this.radius.isConnected){let e=new dY("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){let t={},i=e=>(t.height=this.height.getConnectedValue(e),t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.subdivisions=this.subdivisions.getConnectedValue(e),(0,nQ.VF)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d2.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.CapsuleBlock",d2);class d3 extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("radius",i_.Float,!0,.5),this.registerInput("tessellation",i_.Int,!0,64),this.registerInput("arc",i_.Float,!0,1),this.registerOutput("geometry",i_.Geometry)}getClassName(){return"DiscBlock"}get radius(){return this._inputs[0]}get tessellation(){return this._inputs[1]}get arc(){return this._inputs[2]}get geometry(){return this._outputs[0]}autoConfigure(){if(!this.radius.isConnected){let e=new dY("Radius");e.value=.2,e.output.connectTo(this.radius)}}_buildBlock(e){let t={},i=e=>(t.radius=this.radius.getConnectedValue(e),t.tessellation=this.tessellation.getConnectedValue(e),t.arc=this.arc.getConnectedValue(e),(0,oQ.vM)(t));if(this.evaluateContext)this.geometry._storedFunction=i;else{let t=i(e);this.geometry._storedFunction=()=>(this.geometry._executionCount=1,t.clone())}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d3.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.DiscBlock",d3);class d4 extends dz{constructor(e){super(e),this.registerOutput("geometry",i_.Geometry),this.registerOutput("vector",i_.Vector3)}getClassName(){return"NullBlock"}get geometry(){return this._outputs[0]}get vector(){return this._outputs[1]}_buildBlock(){this.geometry._storedValue=null,this.vector._storedValue=null}}(0,i3.H7)("BABYLON.NullBlock",d4);class d5 extends dz{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",i_.Geometry),this.registerInput("positions",i_.Vector3),this.registerOutput("output",i_.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetPositionsBlock"}get geometry(){return this._inputs[0]}get positions(){return this._inputs[1]}get output(){return this._outputs[0]}_remapVector3Data(e,t){let i=[];for(let r=0;r<e.length;r+=3)void 0!==t[r/3]&&i.push(e[r],e[r+1],e[r+2]);return i}_remapVector4Data(e,t){let i=[];for(let r=0;r<e.length;r+=4)void 0!==t[r/4]&&i.push(e[r],e[r+1],e[r+2],e[r+3]);return i}_remapVector2Data(e,t){let i=[];for(let r=0;r<e.length;r+=2)void 0!==t[r/2]&&i.push(e[r],e[r+1]);return i}_buildBlock(e){let t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.positions.isConnected){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=null;return}let t={},i=this._vertexData.positions.length/3,r=[],s=0,n=!1;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){let i=this.positions.getConnectedValue(e);i?(i.toArray(r,3*s),t[this._currentIndex]=s,s++):n=!0}if(n){if(this._vertexData.indices){let e=[];for(let i=0;i<this._vertexData.indices.length;i++){let r=t[this._vertexData.indices[i]];void 0!==r&&e.push(r)}this._vertexData.indices=e}this._vertexData.normals&&(this._vertexData.normals=this._remapVector3Data(this._vertexData.normals,t)),this._vertexData.tangents&&(this._vertexData.tangents=this._remapVector4Data(this._vertexData.tangents,t)),this._vertexData.colors&&(this._vertexData.colors=this._remapVector4Data(this._vertexData.colors,t)),this._vertexData.uvs&&(this._vertexData.uvs=this._remapVector2Data(this._vertexData.uvs,t)),this._vertexData.uvs2&&(this._vertexData.uvs2=this._remapVector2Data(this._vertexData.uvs2,t)),this._vertexData.uvs3&&(this._vertexData.uvs3=this._remapVector2Data(this._vertexData.uvs3,t)),this._vertexData.uvs4&&(this._vertexData.uvs4=this._remapVector2Data(this._vertexData.uvs4,t)),this._vertexData.uvs5&&(this._vertexData.uvs5=this._remapVector2Data(this._vertexData.uvs5,t)),this._vertexData.uvs6&&(this._vertexData.uvs6=this._remapVector2Data(this._vertexData.uvs6,t))}return this._vertexData.positions=r,e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d5.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.SetPositionsBlock",d5);class d7 extends dz{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",i_.Geometry),this.registerInput("normals",i_.Vector3),this.registerOutput("output",i_.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetNormalsBlock"}get geometry(){return this._inputs[0]}get normals(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.normals.isConnected){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.normals||(this._vertexData.normals=[]);let t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){let t=this.normals.getConnectedValue(e);t&&t.toArray(this._vertexData.normals,3*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d7.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.SetNormalsBlock",d7);class d6 extends dz{constructor(e){super(e),this.evaluateContext=!0,this.textureCoordinateIndex=0,this.registerInput("geometry",i_.Geometry),this.registerInput("uvs",i_.Vector2),this.registerOutput("output",i_.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetUVsBlock"}get geometry(){return this._inputs[0]}get uvs(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.uvs.isConnected){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}let t=[],i=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<i;this._currentIndex++){let i=this.uvs.getConnectedValue(e);i&&i.toArray(t,2*this._currentIndex)}switch(this.textureCoordinateIndex){case 0:this._vertexData.uvs=t;break;case 1:this._vertexData.uvs2=t;break;case 2:this._vertexData.uvs3=t;break;case 3:this._vertexData.uvs4=t;break;case 4:this._vertexData.uvs5=t;break;case 5:this._vertexData.uvs6=t}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.textureCoordinateIndex};
`+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.textureCoordinateIndex=this.textureCoordinateIndex,e}_deserialize(e){super._deserialize(e),this.textureCoordinateIndex=e.textureCoordinateIndex,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d6.prototype,"evaluateContext",void 0),(0,r$.gn)([lM("Texture coordinates index",4,"ADVANCED",{notifiers:{update:!0},options:[{label:"UV1",value:0},{label:"UV2",value:1},{label:"UV3",value:2},{label:"UV4",value:3},{label:"UV5",value:4},{label:"UV6",value:5}]})],d6.prototype,"textureCoordinateIndex",void 0),(0,i3.H7)("BABYLON.SetUVsBlock",d6);class d8 extends dz{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",i_.Geometry),this.registerInput("colors",i_.AutoDetect),this.registerOutput("output",i_.Geometry),this._inputs[1].excludedConnectionPointTypes.push(i_.Int),this._inputs[1].excludedConnectionPointTypes.push(i_.Float),this._inputs[1].excludedConnectionPointTypes.push(i_.Vector2),this._inputs[1].excludedConnectionPointTypes.push(i_.Texture),this._inputs[1].excludedConnectionPointTypes.push(i_.Texture)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetColorsBlock"}get geometry(){return this._inputs[0]}get colors(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.colors.isConnected){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.colors||(this._vertexData.colors=[]);let t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++)if(this.colors.connectedPoint?.type===i_.Vector3){let t=this.colors.getConnectedValue(e);t&&(t.toArray(this._vertexData.colors,4*this._currentIndex),this._vertexData.colors[4*this._currentIndex+3]=1,this._vertexData.hasVertexAlpha=!1)}else{let t=this.colors.getConnectedValue(e);t&&(t.toArray(this._vertexData.colors,4*this._currentIndex),this._vertexData.hasVertexAlpha=!0)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d8.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.SetColorsBlock",d8);class d9 extends dz{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",i_.Geometry),this.registerInput("tangents",i_.Vector4),this.registerOutput("output",i_.Geometry)}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"SetTangentsBlock"}get geometry(){return this._inputs[0]}get tangents(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{if(e.pushExecutionContext(this),this._vertexData=this.geometry.getConnectedValue(e),this._vertexData&&(this._vertexData=this._vertexData.clone()),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=null;return}if(!this.tangents.isConnected){e.restoreGeometryContext(),e.restoreExecutionContext(),this.output._storedValue=this._vertexData;return}this._vertexData.tangents||(this._vertexData.tangents=[]);let t=this._vertexData.positions.length/3;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){let t=this.tangents.getConnectedValue(e);t&&t.toArray(this._vertexData.tangents,4*this._currentIndex)}return e.restoreGeometryContext(),e.restoreExecutionContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],d9.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.SetTangentsBlock",d9),(eN=ix||(ix={}))[eN.Add=0]="Add",eN[eN.Subtract=1]="Subtract",eN[eN.Multiply=2]="Multiply",eN[eN.Divide=3]="Divide",eN[eN.Max=4]="Max",eN[eN.Min=5]="Min";class fe extends dz{constructor(e){super(e),this.operation=ix.Add,this.registerInput("left",i_.AutoDetect),this.registerInput("right",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this.output._typeConnectionSource=this.left;let t=[i_.Matrix,i_.Geometry,i_.Texture];this.left.excludedConnectionPointTypes.push(...t),this.right.excludedConnectionPointTypes.push(...t),this._linkConnectionTypes(0,1),this._connectionObservers=[this.left.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.left.onDisconnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onConnectionObservable.add(()=>this._updateInputOutputTypes()),this.right.onDisconnectionObservable.add(()=>this._updateInputOutputTypes())]}getClassName(){return"MathBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){let e;let t=this.left,i=this.right;if(!t.isConnected||!i.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let r=t.type===i_.Float||t.type===i_.Int,s=i.type===i_.Float||i.type===i_.Int,n=r&&s;switch(this.operation){case ix.Add:e=n?e=>t.getConnectedValue(e)+i.getConnectedValue(e):r?e=>e.adapt(t,i.type).add(i.getConnectedValue(e)):e=>t.getConnectedValue(e).add(e.adapt(i,t.type));break;case ix.Subtract:e=n?e=>t.getConnectedValue(e)-i.getConnectedValue(e):r?e=>e.adapt(t,i.type).subtract(i.getConnectedValue(e)):e=>t.getConnectedValue(e).subtract(e.adapt(i,t.type));break;case ix.Multiply:e=n?e=>t.getConnectedValue(e)*i.getConnectedValue(e):r?e=>e.adapt(t,i.type).multiply(i.getConnectedValue(e)):e=>t.getConnectedValue(e).multiply(e.adapt(i,t.type));break;case ix.Divide:e=n?e=>t.getConnectedValue(e)/i.getConnectedValue(e):r?e=>e.adapt(t,i.type).divide(i.getConnectedValue(e)):e=>t.getConnectedValue(e).divide(e.adapt(i,t.type));break;case ix.Min:if(n)e=e=>Math.min(t.getConnectedValue(e),i.getConnectedValue(e));else{let[s,n]=r?[i,t]:[t,i];switch(s.type){case i_.Vector2:e=e=>i1.FM.Minimize(s.getConnectedValue(e),e.adapt(n,s.type));break;case i_.Vector3:e=e=>i1.P.Minimize(s.getConnectedValue(e),e.adapt(n,s.type));break;case i_.Vector4:e=e=>i1.Lt.Minimize(s.getConnectedValue(e),e.adapt(n,s.type))}}break;case ix.Max:if(n)e=e=>Math.max(t.getConnectedValue(e),i.getConnectedValue(e));else{let[s,n]=r?[i,t]:[t,i];switch(s.type){case i_.Vector2:e=e=>i1.FM.Maximize(s.getConnectedValue(e),e.adapt(n,s.type));break;case i_.Vector3:e=e=>i1.P.Maximize(s.getConnectedValue(e),e.adapt(n,s.type));break;case i_.Vector4:e=e=>i1.Lt.Maximize(s.getConnectedValue(e),e.adapt(n,s.type))}}}this.output._storedFunction=i=>t.type===i_.Int?0|e(i):e(i)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.MathBlockOperations.${ix[this.operation]};
`}_updateInputOutputTypes(){if(this.output._typeConnectionSource=this.left,this.left.isConnected&&this.right.isConnected?(this.left.type===i_.Int||this.left.type===i_.Float&&this.right.type!==i_.Int)&&(this.output._typeConnectionSource=this.right):this.left.isConnected!==this.right.isConnected&&(this.output._typeConnectionSource=this.left.isConnected?this.left:this.right),this.left.isConnected||this.right.isConnected)for(let[e,t]of[[this.left,this.right],[this.right,this.left]])e.acceptedConnectionPointTypes=[i_.Int,i_.Float],t.isConnected&&(e.acceptedConnectionPointTypes.push(t.type),(t.type===i_.Int||t.type===i_.Float)&&e.acceptedConnectionPointTypes.push(i_.Vector2,i_.Vector3,i_.Vector4))}dispose(){super.dispose(),this._connectionObservers.forEach(e=>e.remove()),this._connectionObservers.length=0}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}}(0,r$.gn)([lM("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Add",value:ix.Add},{label:"Subtract",value:ix.Subtract},{label:"Multiply",value:ix.Multiply},{label:"Divide",value:ix.Divide},{label:"Max",value:ix.Max},{label:"Min",value:ix.Min}]})],fe.prototype,"operation",void 0),(0,i3.H7)("BABYLON.MathBlock",fe);class ft extends dz{constructor(e){super(e),this.registerInput("value",i_.AutoDetect),this.registerInput("fromMin",i_.Float,!0,0),this.registerInput("fromMax",i_.Float,!0,1),this.registerInput("toMin",i_.Float,!0,0),this.registerInput("toMax",i_.Float,!0,1),this.registerOutput("output",i_.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(i_.Vector2),this._inputs[0].excludedConnectionPointTypes.push(i_.Vector3),this._inputs[0].excludedConnectionPointTypes.push(i_.Vector4),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"MapRangeBlock"}get value(){return this._inputs[0]}get fromMin(){return this._inputs[1]}get fromMax(){return this._inputs[2]}get toMin(){return this._inputs[3]}get toMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.output._storedFunction=e=>{let t=this.value.getConnectedValue(e),i=this.fromMin.getConnectedValue(e),r=this.fromMax.getConnectedValue(e),s=this.toMin.getConnectedValue(e),n=(t-i)/(r-i)*(this.toMax.getConnectedValue(e)-s)+s;return this.output.type===i_.Int?Math.floor(n):n}}}(0,i3.H7)("BABYLON.MapRangeBlock",ft),(eO=iE||(iE={}))[eO.Equal=0]="Equal",eO[eO.NotEqual=1]="NotEqual",eO[eO.LessThan=2]="LessThan",eO[eO.GreaterThan=3]="GreaterThan",eO[eO.LessOrEqual=4]="LessOrEqual",eO[eO.GreaterOrEqual=5]="GreaterOrEqual",eO[eO.Xor=6]="Xor",eO[eO.Or=7]="Or",eO[eO.And=8]="And";class fi extends dz{constructor(e){super(e),this.test=iE.Equal,this.registerInput("left",i_.Float),this.registerInput("right",i_.Float,!0,0),this.registerInput("ifTrue",i_.AutoDetect,!0,1),this.registerInput("ifFalse",i_.AutoDetect,!0,0),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=i_.Float,this._inputs[0].acceptedConnectionPointTypes.push(i_.Int),this._inputs[1].acceptedConnectionPointTypes.push(i_.Int),this._linkConnectionTypes(2,3)}getClassName(){return"ConditionBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get ifTrue(){return this._inputs[2]}get ifFalse(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=e=>{let t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e),r=!1;switch(this.test){case iE.Equal:r=(0,aP.WithinEpsilon)(t,i,r2.kn);break;case iE.NotEqual:r=t!==i;break;case iE.LessThan:r=t<i;break;case iE.GreaterThan:r=t>i;break;case iE.LessOrEqual:r=t<=i;break;case iE.GreaterOrEqual:r=t>=i;break;case iE.Xor:r=!!t&&!i||!t&&!!i;break;case iE.Or:r=!!t||!!i;break;case iE.And:r=!!t&&!!i}return r};this.output._storedFunction=t=>e(t)?this.ifTrue.getConnectedValue(t):this.ifFalse.getConnectedValue(t)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.test = BABYLON.ConditionBlockTests.${iE[this.test]};
`}serialize(){let e=super.serialize();return e.test=this.test,e}_deserialize(e){super._deserialize(e),this.test=e.test}}(0,r$.gn)([lM("Test",4,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Equal",value:iE.Equal},{label:"NotEqual",value:iE.NotEqual},{label:"LessThan",value:iE.LessThan},{label:"GreaterThan",value:iE.GreaterThan},{label:"LessOrEqual",value:iE.LessOrEqual},{label:"GreaterOrEqual",value:iE.GreaterOrEqual},{label:"Xor",value:iE.Xor},{label:"Or",value:iE.Or},{label:"And",value:iE.And}]})],fi.prototype,"test",void 0),(0,i3.H7)("BABYLON.ConditionBlock",fi),(eD=iC||(iC={}))[eD.None=0]="None",eD[eD.LoopID=1]="LoopID",eD[eD.InstanceID=2]="InstanceID",eD[eD.Once=3]="Once";class fr extends dz{constructor(e){super(e),this._currentLockId=-1,this.lockMode=iC.None,this.registerInput("min",i_.AutoDetect),this.registerInput("max",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture),this._inputs[1].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[1].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[1].excludedConnectionPointTypes.push(i_.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"RandomBlock"}get min(){return this._inputs[0]}get max(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.min.isConnected){let e=new dY("Min");e.value=0,e.output.connectTo(this.min)}if(!this.max.isConnected){let e=new dY("Max");e.value=1,e.output.connectTo(this.max)}}_buildBlock(){let e=null;switch(this._currentLockId=-1,this.min.type){case i_.Int:case i_.Float:e=e=>{let t=this.min.getConnectedValue(e)||0;return t+Math.random()*((this.max.getConnectedValue(e)||0)-t)};break;case i_.Vector2:e=e=>{let t=this.min.getConnectedValue(e)||i1.FM.Zero(),i=this.max.getConnectedValue(e)||i1.FM.Zero();return new i1.FM(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y))};break;case i_.Vector3:e=e=>{let t=this.min.getConnectedValue(e)||i1.P.Zero(),i=this.max.getConnectedValue(e)||i1.P.Zero();return new i1.P(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z))};break;case i_.Vector4:e=e=>{let t=this.min.getConnectedValue(e)||i1.Lt.Zero(),i=this.max.getConnectedValue(e)||i1.Lt.Zero();return new i1.Lt(t.x+Math.random()*(i.x-t.x),t.y+Math.random()*(i.y-t.y),t.z+Math.random()*(i.z-t.z),t.w+Math.random()*(i.w-t.w))}}this.lockMode!==iC.None&&e?this.output._storedFunction=t=>{let i=0;switch(this.lockMode){case iC.InstanceID:i=t.getContextualValue(iS.InstanceID,!0)||0;break;case iC.LoopID:i=t.getContextualValue(iS.LoopID,!0)||0;break;case iC.Once:i=t.buildId||0}return(this._currentLockId!==i||this.lockMode===iC.None)&&(this._currentLockId=i,this.output._storedValue=e(t)),this.output._storedValue}:this.output._storedFunction=e}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.lockMode = BABYLON.RandomBlockLocks.${iC[this.lockMode]};
`}serialize(){let e=super.serialize();return e.lockMode=this.lockMode,e}_deserialize(e){super._deserialize(e),this.lockMode=e.lockMode}}(0,r$.gn)([lM("LockMode",4,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"None",value:iC.None},{label:"LoopID",value:iC.LoopID},{label:"InstanceID",value:iC.InstanceID},{label:"Once",value:iC.Once}]})],fr.prototype,"lockMode",void 0),(0,i3.H7)("BABYLON.RandomBlock",fr);class fs extends dz{constructor(e){super(e),this.registerInput("offset",i_.Vector3,!0,i1.P.Zero()),this.registerInput("scale",i_.Float,!0,1),this.registerInput("octaves",i_.Float,!0,2,0,16),this.registerInput("roughness",i_.Float,!0,.5,0,1),this.registerOutput("output",i_.Float)}getClassName(){return"NoiseBlock"}get offset(){return this._inputs[0]}get scale(){return this._inputs[1]}get octaves(){return this._inputs[2]}get roughness(){return this._inputs[3]}get output(){return this._outputs[0]}_negateIf(e,t){return 0!==t?-e:e}_noiseGrad(e,t,i,r){let s=15&e,n=s<8?t:i,a=s<4?i:12===s||14==s?t:r;return this._negateIf(n,s&n)+this._negateIf(a,2&s)}_fade(e){return e*e*e*(e*(6*e-15)+10)}_hashBitRotate(e,t){return e<<t|e>>32-t}_hash(e,t,i){let r,s,n;return r=s=n=3735928584,n+=i,s+=t,r+=e,n^=s,n-=this._hashBitRotate(s,14),r^=n,r-=this._hashBitRotate(n,11),s^=r,s-=this._hashBitRotate(r,25),n^=s,n-=this._hashBitRotate(s,16),r^=n,r-=this._hashBitRotate(n,4),s^=r,s-=this._hashBitRotate(r,14),n^=s,n-=this._hashBitRotate(s,24)}_mix(e,t,i,r,s,n,a,o,l,c,u){let h=1-l,d=1-c;return(1-u)*(d*(e*h+t*l)+c*(i*h+r*l))+u*(d*(s*h+n*l)+c*(a*h+o*l))}_perlinNoise(e){let t=(0|e.x)-(e.x<0?1:0),i=(0|e.y)-(e.y<0?1:0),r=(0|e.z)-(e.z<0?1:0),s=e.x-t,n=e.y-i,a=e.z-r,o=this._fade(s),l=this._fade(n),c=this._fade(a);return this._mix(this._noiseGrad(this._hash(t,i,r),s,n,a),this._noiseGrad(this._hash(t+1,i,r),s-1,n,a),this._noiseGrad(this._hash(t,i+1,r),s,n-1,a),this._noiseGrad(this._hash(t+1,i+1,r),s-1,n-1,a),this._noiseGrad(this._hash(t,i,r+1),s,n,a-1),this._noiseGrad(this._hash(t+1,i,r+1),s-1,n,a-1),this._noiseGrad(this._hash(t,i+1,r+1),s,n-1,a-1),this._noiseGrad(this._hash(t+1,i+1,r+1),s-1,n-1,a-1),o,l,c)}_perlinSigned(e){return .982*this._perlinNoise(e)}_perlin(e){return this._perlinSigned(e)/2+.5}noise(e,t,i,r,s){let n=new i1.P(i.x*s+r.x,i.y*s+r.y,i.z*s+r.z),a=1,o=1,l=0,c=0,u=0|(e=(0,aP.Clamp)(e,0,15));for(let e=0;e<=u;e++)c+=this._perlin(n.scale(a))*o,l+=o,o*=(0,aP.Clamp)(t,0,1),a*=2;let h=e-Math.floor(e);if(0==h)return c/l;let d=c+this._perlin(n.scale(a))*o;return(1-h)*(c/=l)+h*(d/=l+o)}_buildBlock(){this.output._storedFunction=e=>{let t=e.getContextualValue(iS.Positions),i=this.octaves.getConnectedValue(e),r=this.roughness.getConnectedValue(e),s=this.offset.getConnectedValue(e),n=this.scale.getConnectedValue(e);return this.noise(i,r,t,s,n)}}}(0,i3.H7)("BABYLON.NoiseBlock",fs);class fn extends dz{constructor(e){super(e),this.evaluateContext=!1,this.registerInput("geometry0",i_.Geometry),this.registerInput("geometry1",i_.Geometry,!0),this.registerInput("geometry2",i_.Geometry,!0),this.registerInput("geometry3",i_.Geometry,!0),this.registerInput("geometry4",i_.Geometry,!0),this.registerOutput("output",i_.Geometry)}getClassName(){return"MergeGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{let t=[];if(this.geometry0.isConnected){let i=this.geometry0.getConnectedValue(e);i&&t.push(i)}if(this.geometry1.isConnected){let i=this.geometry1.getConnectedValue(e);i&&t.push(i)}if(this.geometry2.isConnected){let i=this.geometry2.getConnectedValue(e);i&&t.push(i)}if(this.geometry3.isConnected){let i=this.geometry3.getConnectedValue(e);i&&t.push(i)}if(this.geometry4.isConnected){let i=this.geometry4.getConnectedValue(e);i&&t.push(i)}if(0===t.length)return null;let i=t[0].clone(),r=t.slice(1);return r.length&&i&&(i=i.merge(r,!0,!1,!0,!0)),i};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fn.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.MergeGeometryBlock",fn);class fa extends dz{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry0",i_.Geometry,!0),this.registerInput("geometry1",i_.Geometry,!0),this.registerInput("geometry2",i_.Geometry,!0),this.registerInput("geometry3",i_.Geometry,!0),this.registerInput("geometry4",i_.Geometry,!0),this.registerInput("geometry5",i_.Geometry,!0),this.registerInput("geometry6",i_.Geometry,!0),this.registerInput("geometry7",i_.Geometry,!0),this.registerInput("geometry8",i_.Geometry,!0),this.registerInput("geometry9",i_.Geometry,!0),this.registerOutput("output",i_.Geometry),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"GeometryCollectionBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get geometry2(){return this._inputs[2]}get geometry3(){return this._inputs[3]}get geometry4(){return this._inputs[4]}get geometry5(){return this._inputs[5]}get geometry6(){return this._inputs[6]}get geometry7(){return this._inputs[7]}get geometry8(){return this._inputs[8]}get geometry9(){return this._inputs[9]}get output(){return this._outputs[0]}_storeGeometry(e,t,i,r){if(e.isConnected){let s=e.getConnectedValue(t);s&&(s.metadata=s.metadata||{},s.metadata.collectionId=i,r.push(s))}}_buildBlock(e){let t=e=>{let t=[];return(this._storeGeometry(this.geometry0,e,0,t),this._storeGeometry(this.geometry1,e,1,t),this._storeGeometry(this.geometry2,e,2,t),this._storeGeometry(this.geometry3,e,3,t),this._storeGeometry(this.geometry4,e,4,t),this._storeGeometry(this.geometry5,e,5,t),this._storeGeometry(this.geometry6,e,6,t),this._storeGeometry(this.geometry7,e,7,t),this._storeGeometry(this.geometry8,e,8,t),this._storeGeometry(this.geometry9,e,9,t),t.length)?t[Math.round(Math.random()*(t.length-1))]:null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fa.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.GeometryCollectionBlock",fa);class fo extends dz{constructor(e){super(e),this.registerInput("input",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return -1}getClassName(){return"GeometryElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>i.getConnectedValue(e)}}(0,i3.H7)("BABYLON.GeometryElbowBlock",fo);class fl extends dz{constructor(e){super(e),this.registerInput("geometry",i_.Geometry),this.registerOutput("output",i_.Geometry)}getClassName(){return"ComputeNormalsBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.geometry.isConnected)return null;let t=this.geometry.getConnectedValue(e);return t.normals||(t.normals=[]),nK.x.ComputeNormals(t.positions,t.indices,t.normals),t}}}(0,i3.H7)("BABYLON.ComputeNormalsBlock",fl);class fc extends dz{constructor(e){super(e),this.registerInput("xyzw ",i_.Vector4,!0),this.registerInput("xyz ",i_.Vector3,!0),this.registerInput("xy ",i_.Vector2,!0),this.registerInput("zw ",i_.Vector2,!0),this.registerInput("x ",i_.Float,!0),this.registerInput("y ",i_.Float,!0),this.registerInput("z ",i_.Float,!0),this.registerInput("w ",i_.Float,!0),this.registerOutput("xyzw",i_.Vector4),this.registerOutput("xyz",i_.Vector3),this.registerOutput("xy",i_.Vector2),this.registerOutput("zw",i_.Vector2),this.registerOutput("x",i_.Float),this.registerOutput("y",i_.Float),this.registerOutput("z",i_.Float),this.registerOutput("w",i_.Float)}getClassName(){return"VectorConverterBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get xIn(){return this._inputs[4]}get yIn(){return this._inputs[5]}get zIn(){return this._inputs[6]}get wIn(){return this._inputs[7]}get xyzwOut(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xOut(){return this._outputs[4]}get yOut(){return this._outputs[5]}get zOut(){return this._outputs[6]}get wOut(){return this._outputs[7]}_inputRename(e){return"xyzw "===e?"xyzwIn":"xyz "===e?"xyzIn":"xy "===e?"xyIn":"zw "===e?"zwIn":"x "===e?"xIn":"y "===e?"yIn":"z "===e?"zIn":"w "===e?"wIn":e}_outputRename(e){switch(e){case"x":return"xOut";case"y":return"yOut";case"z":return"zOut";case"w":return"wOut";case"xy":return"xyOut";case"zw":return"zwOut";case"xyz":return"xyzOut";case"xyzw":return"xyzwOut";default:return e}}_buildBlock(e){super._buildBlock(e);let t=this.xIn,i=this.yIn,r=this.zIn,s=this.wIn,n=this.xyIn,a=this.zwIn,o=this.xyzIn,l=this.xyzwIn,c=this.xyzwOut,u=this.xyzOut,h=this.xyOut,d=this.zwOut,f=this.xOut,p=this.yOut,m=this.zOut,_=this.wOut,g=e=>{if(l.isConnected)return l.getConnectedValue(e);let c=0,u=0,h=0,d=0;if(t.isConnected&&(c=t.getConnectedValue(e)),i.isConnected&&(u=i.getConnectedValue(e)),r.isConnected&&(h=r.getConnectedValue(e)),s.isConnected&&(d=s.getConnectedValue(e)),n.isConnected){let t=n.getConnectedValue(e);t&&(c=t.x,u=t.y)}if(a.isConnected){let t=a.getConnectedValue(e);t&&(h=t.x,d=t.y)}if(o.isConnected){let t=o.getConnectedValue(e);t&&(c=t.x,u=t.y,h=t.z)}return new i1.Lt(c,u,h,d)};c._storedFunction=e=>g(e),u._storedFunction=e=>{let t=g(e);return new i1.P(t.x,t.y,t.z)},h._storedFunction=e=>{let t=g(e);return new i1.FM(t.x,t.y)},d._storedFunction=e=>{let t=g(e);return new i1.FM(t.z,t.w)},f._storedFunction=e=>g(e).x,p._storedFunction=e=>g(e).y,m._storedFunction=e=>g(e).z,_._storedFunction=e=>g(e).w}}(0,i3.H7)("BABYLON.VectorConverterBlock",fc);class fu extends dz{constructor(e){super(e),this.registerInput("input",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._inputs[0].excludedConnectionPointTypes.push(i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NormalizeVectorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),this.output._storedFunction=null,!this.input.isConnected){this.output._storedValue=null;return}this.output._storedFunction=e=>this.input.getConnectedValue(e).normalize()}}(0,i3.H7)("BABYLON.NormalizeVectorBlock",fu);class fh extends dz{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("geometry",i_.Geometry),this.registerInput("id",i_.Int,!0,0),this.registerOutput("output",i_.Geometry),this.id.acceptedConnectionPointTypes.push(i_.Float)}getClassName(){return"SetMaterialIDBlock"}get geometry(){return this._inputs[0]}get id(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.geometry.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let t=e=>{let t=this.geometry.getConnectedValue(e);if(!t||!t.indices||!t.positions)return t;let i=new nK.D;return i.materialIndex=0|this.id.getConnectedValue(e),i.indexStart=0,i.indexCount=t.indices.length,i.verticesStart=0,i.verticesCount=t.positions.length/3,t.materialInfos=[i],t};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fh.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.SetMaterialIDBlock",fh),(eF=iT||(iT={}))[eF.Cos=0]="Cos",eF[eF.Sin=1]="Sin",eF[eF.Abs=2]="Abs",eF[eF.Exp=3]="Exp",eF[eF.Round=4]="Round",eF[eF.Floor=5]="Floor",eF[eF.Ceiling=6]="Ceiling",eF[eF.Sqrt=7]="Sqrt",eF[eF.Log=8]="Log",eF[eF.Tan=9]="Tan",eF[eF.ArcTan=10]="ArcTan",eF[eF.ArcCos=11]="ArcCos",eF[eF.ArcSin=12]="ArcSin",eF[eF.Sign=13]="Sign",eF[eF.Negate=14]="Negate",eF[eF.OneMinus=15]="OneMinus",eF[eF.Reciprocal=16]="Reciprocal",eF[eF.ToDegrees=17]="ToDegrees",eF[eF.ToRadians=18]="ToRadians",eF[eF.Fract=19]="Fract",eF[eF.Exp2=20]="Exp2";class fd extends dz{constructor(e){super(e),this.operation=iT.Cos,this.registerInput("input",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryTrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=null;switch(this.operation){case iT.Cos:t=e=>Math.cos(e);break;case iT.Sin:t=e=>Math.sin(e);break;case iT.Abs:t=e=>Math.abs(e);break;case iT.Exp:t=e=>Math.exp(e);break;case iT.Exp2:t=e=>Math.pow(2,e);break;case iT.Round:t=e=>Math.round(e);break;case iT.Floor:t=e=>Math.floor(e);break;case iT.Ceiling:t=e=>Math.ceil(e);break;case iT.Sqrt:t=e=>Math.sqrt(e);break;case iT.Log:t=e=>Math.log(e);break;case iT.Tan:t=e=>Math.tan(e);break;case iT.ArcTan:t=e=>Math.atan(e);break;case iT.ArcCos:t=e=>Math.acos(e);break;case iT.ArcSin:t=e=>Math.asin(e);break;case iT.Sign:t=e=>Math.sign(e);break;case iT.Negate:t=e=>-e;break;case iT.OneMinus:t=e=>1-e;break;case iT.Reciprocal:t=e=>1/e;break;case iT.ToRadians:t=e=>e*Math.PI/180;break;case iT.ToDegrees:t=e=>180*e/Math.PI;break;case iT.Fract:t=e=>e>=0?e-Math.floor(e):e-Math.ceil(e)}if(!t){this.output._storedFunction=null,this.output._storedValue=null;return}switch(this.input.type){case i_.Int:case i_.Float:this.output._storedFunction=e=>{let i=this.input.getConnectedValue(e);return t(i)};break;case i_.Vector2:this.output._storedFunction=e=>{let i=this.input.getConnectedValue(e);return new i1.FM(t(i.x),t(i.y))};break;case i_.Vector3:this.output._storedFunction=e=>{let i=this.input.getConnectedValue(e);return new i1.P(t(i.x),t(i.y),t(i.z))};break;case i_.Vector4:this.output._storedFunction=e=>{let i=this.input.getConnectedValue(e);return new i1.Lt(t(i.x),t(i.y),t(i.z),t(i.w))}}return this}serialize(){let e=super.serialize();return e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.GeometryTrigonometryBlockOperations.${iT[this.operation]};
`}}(0,r$.gn)([lM("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Cos",value:iT.Cos},{label:"Sin",value:iT.Sin},{label:"Abs",value:iT.Abs},{label:"Exp",value:iT.Exp},{label:"Exp2",value:iT.Exp2},{label:"Round",value:iT.Round},{label:"Floor",value:iT.Floor},{label:"Ceiling",value:iT.Ceiling},{label:"Sqrt",value:iT.Sqrt},{label:"Log",value:iT.Log},{label:"Tan",value:iT.Tan},{label:"ArcTan",value:iT.ArcTan},{label:"ArcCos",value:iT.ArcCos},{label:"ArcSin",value:iT.ArcSin},{label:"Sign",value:iT.Sign},{label:"Negate",value:iT.Negate},{label:"OneMinus",value:iT.OneMinus},{label:"Reciprocal",value:iT.Reciprocal},{label:"ToDegrees",value:iT.ToDegrees},{label:"ToRadians",value:iT.ToRadians},{label:"Fract",value:iT.Fract}]})],fd.prototype,"operation",void 0),(0,i3.H7)("BABYLON.GeometryTrigonometryBlock",fd);class ff extends dz{constructor(e){super(e),this._rotationMatrix=new i1.y3,this._scalingMatrix=new i1.y3,this._translationMatrix=new i1.y3,this._scalingRotationMatrix=new i1.y3,this._transformMatrix=new i1.y3,this.evaluateContext=!0,this.registerInput("value",i_.AutoDetect),this.registerInput("matrix",i_.Matrix,!0),this.registerInput("translation",i_.Vector3,!0,i1.P.Zero()),this.registerInput("rotation",i_.Vector3,!0,i1.P.Zero()),this.registerInput("scaling",i_.Vector3,!0,i1.P.One()),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryTransformBlock"}get value(){return this._inputs[0]}get matrix(){return this._inputs[1]}get translation(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let t=e=>{let t;let i=this.value.getConnectedValue(e);if(!i)return null;if(this.matrix.isConnected)t=this.matrix.getConnectedValue(e);else{let i=this.scaling.getConnectedValue(e),r=this.rotation.getConnectedValue(e),s=this.translation.getConnectedValue(e);i1.y3.ScalingToRef(i.x,i.y,i.z,this._scalingMatrix),i1.y3.RotationYawPitchRollToRef(r.y,r.x,r.z,this._rotationMatrix),i1.y3.TranslationToRef(s.x,s.y,s.z,this._translationMatrix),this._scalingMatrix.multiplyToRef(this._rotationMatrix,this._scalingRotationMatrix),this._scalingRotationMatrix.multiplyToRef(this._translationMatrix,this._transformMatrix),t=this._transformMatrix}switch(this.value.type){case i_.Geometry:{let e=i.clone();return e.transform(t),e}case i_.Vector2:return i1.FM.Transform(i,t);case i_.Vector3:return i1.P.TransformCoordinates(i,t);case i_.Vector4:return i1.Lt.TransformCoordinates(i,t)}return null};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],ff.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.GeometryTransformBlock",ff);class fp extends dz{constructor(e){super(e),this.registerInput("angle",i_.Float,!1,0),this.registerOutput("matrix",i_.Matrix)}getClassName(){return"RotationXBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new dY("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>i1.y3.RotationX(this.angle.getConnectedValue(e))}}(0,i3.H7)("BABYLON.RotationXBlock",fp);class fm extends dz{constructor(e){super(e),this.registerInput("angle",i_.Float,!1,0),this.registerOutput("matrix",i_.Matrix)}getClassName(){return"RotationYBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new dY("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>i1.y3.RotationY(this.angle.getConnectedValue(e))}}(0,i3.H7)("BABYLON.RotationYBlock",fm);class f_ extends dz{constructor(e){super(e),this.registerInput("angle",i_.Float,!1,0),this.registerOutput("matrix",i_.Matrix)}getClassName(){return"RotationZBlock"}get angle(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){let e=new dY("Angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>i1.y3.RotationZ(this.angle.getConnectedValue(e))}}(0,i3.H7)("BABYLON.RotationZBlock",f_);class fg extends dz{constructor(e){super(e),this.registerInput("scale",i_.Vector3,!1,i1.P.One()),this.registerOutput("matrix",i_.Matrix)}getClassName(){return"ScalingBlock"}get scale(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.scale.isConnected){let e=new dY("Scale");e.value=new i1.P(1,1,1),e.output.connectTo(this.scale)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{let t=this.scale.getConnectedValue(e);return i1.y3.Scaling(t.x,t.y,t.z)}}}(0,i3.H7)("BABYLON.ScalingBlock",fg);class fv extends dz{constructor(e){super(e),this.registerInput("source",i_.Vector3,!0,i1.P.Up()),this.registerInput("target",i_.Vector3,!0,i1.P.Left()),this.registerOutput("matrix",i_.Matrix)}getClassName(){return"AlignBlock"}get source(){return this._inputs[0]}get target(){return this._inputs[1]}get matrix(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{let t=this.source.getConnectedValue(e).clone(),i=this.target.getConnectedValue(e).clone(),r=new i1.y3;return t.normalize(),i.normalize(),i1.y3.RotationAlignToRef(t,i,r,!0),r}}}(0,i3.H7)("BABYLON.AlignBlock",fv);class fS extends dz{constructor(e){super(e),this.registerInput("translation",i_.Vector3,!1,i1.P.Zero()),this.registerOutput("matrix",i_.Matrix)}getClassName(){return"TranslationBlock"}get translation(){return this._inputs[0]}get matrix(){return this._outputs[0]}autoConfigure(){if(!this.translation.isConnected){let e=new dY("Translation");e.value=new i1.P(0,0,0),e.output.connectTo(this.translation)}}_buildBlock(e){super._buildBlock(e),this.matrix._storedFunction=e=>{let t=this.translation.getConnectedValue(e);return i1.y3.Translation(t.x,t.y,t.z)}}}(0,i3.H7)("BABYLON.TranslationBlock",fS);class fx extends dz{constructor(e){super(e),this._indexTranslation=null,this.evaluateContext=!0,this.removeDuplicatedPositions=!0,this.registerInput("geometry",i_.Geometry),this.registerInput("instance",i_.Geometry,!0),this.registerInput("density",i_.Float,!0,1,0,1),this.registerInput("matrix",i_.Matrix,!0),this.registerInput("rotation",i_.Vector3,!0,i1.P.Zero()),this.registerInput("scaling",i_.Vector3,!0,i1.P.One()),this.scaling.acceptedConnectionPointTypes.push(i_.Float),this.registerOutput("output",i_.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return this._indexTranslation?this._indexTranslation[this._currentIndex]:this._currentIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateOnVerticesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get density(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this.instance.isConnected){e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),this.output._storedValue=null;return}let t=this._vertexData.positions.length/3,i=[],r=new i1.P,s=[],n=this._vertexData.positions;if(this._currentLoopIndex=0,this.removeDuplicatedPositions){for(this._indexTranslation={},this._currentIndex=0;this._currentIndex<t;this._currentIndex++){let e=n[3*this._currentIndex],t=n[3*this._currentIndex+1],i=n[3*this._currentIndex+2],r=!1;for(let n=0;n<s.length;n+=3)if(Math.abs(s[n]-e)<r2.kn&&Math.abs(s[n+1]-t)<r2.kn&&Math.abs(s[n+2]-i)<r2.kn){r=!0;break}r||(this._indexTranslation[s.length/3]=this._currentIndex,s.push(e,t,i))}t=(n=s).length/3}else this._indexTranslation=null;for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){let t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;let s=this.density.getConnectedValue(e);if(s<1&&Math.random()>s)continue;r.fromArray(n,3*this._currentIndex);let a=t.clone();if(this.matrix.isConnected){let t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(a,r,t,i)}else{let t=e.adaptInput(this.scaling,i_.Vector3,i1.P.OneReadOnly),s=this.rotation.getConnectedValue(e)||i1.P.ZeroReadOnly;e._instantiate(a,r,s,t,i)}this._currentLoopIndex++}if(e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),!i.length)return null;if(1===i.length)this._vertexData=i[0];else{let e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}return this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.removeDuplicatedPositions = ${this.removeDuplicatedPositions?"true":"false"};
`+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.removeDuplicatedPositions=this.removeDuplicatedPositions,e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),this.removeDuplicatedPositions=e.removeDuplicatedPositions,void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fx.prototype,"evaluateContext",void 0),(0,r$.gn)([lM("Remove duplicated positions",0,"ADVANCED",{notifiers:{update:!0}})],fx.prototype,"removeDuplicatedPositions",void 0),(0,i3.H7)("BABYLON.InstantiateOnVerticesBlock",fx);class fE extends dz{constructor(e){super(e),this._currentPosition=new i1.P,this._currentUV=new i1.FM,this._vertex0=new i1.P,this._vertex1=new i1.P,this._vertex2=new i1.P,this._tempVector0=new i1.P,this._tempVector1=new i1.P,this._uv0=new i1.FM,this._uv1=new i1.FM,this._uv2=new i1.FM,this.evaluateContext=!0,this.registerInput("geometry",i_.Geometry),this.registerInput("instance",i_.Geometry,!0),this.registerInput("count",i_.Int,!0,256),this.registerInput("matrix",i_.Matrix,!0),this.registerInput("rotation",i_.Vector3,!0,i1.P.Zero()),this.registerInput("scaling",i_.Vector3,!0,i1.P.One()),this.scaling.acceptedConnectionPointTypes.push(i_.Float),this.registerOutput("output",i_.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return this._currentFaceIndex}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getOverrideNormalsContextualValue(){return this._vertex1.subtractToRef(this._vertex0,this._tempVector0),this._vertex2.subtractToRef(this._vertex1,this._tempVector1),this._tempVector0.normalize(),this._tempVector1.normalize(),i1.P.Cross(this._tempVector1,this._tempVector0)}getOverrideUVs1ContextualValue(){return this._currentUV}getClassName(){return"InstantiateOnFacesBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),this.output._storedValue=null;return}let t=null,i=this.count.getConnectedValue(e),r=this._vertexData.indices.length/3,s=i/r,n=0,a=[],o=0;for(this._currentLoopIndex=0,this._currentFaceIndex=0;this._currentFaceIndex<r;this._currentFaceIndex++){let r=(0|(n+=s))-o;if(r<1)continue;let l=this._vertexData.indices[3*this._currentFaceIndex],c=this._vertexData.indices[3*this._currentFaceIndex+1],u=this._vertexData.indices[3*this._currentFaceIndex+2];this._vertex0.fromArray(this._vertexData.positions,3*l),this._vertex1.fromArray(this._vertexData.positions,3*c),this._vertex2.fromArray(this._vertexData.positions,3*u),this._vertexData.uvs&&(this._uv0.fromArray(this._vertexData.uvs,2*l),this._uv1.fromArray(this._vertexData.uvs,2*c),this._uv2.fromArray(this._vertexData.uvs,2*u));for(let l=0;l<r&&!(o>=i);l++){let i=Math.random(),r=Math.random();if(i>r){let e=i;i=r,r=e}let l=i,c=r-i,u=1-l-c;if(this._currentPosition.set(l*this._vertex0.x+c*this._vertex1.x+u*this._vertex2.x,l*this._vertex0.y+c*this._vertex1.y+u*this._vertex2.y,l*this._vertex0.z+c*this._vertex1.z+u*this._vertex2.z),this._vertexData.uvs&&this._currentUV.set(l*this._uv0.x+c*this._uv1.x+u*this._uv2.x,l*this._uv0.y+c*this._uv1.y+u*this._uv2.y),!(t=this.instance.getConnectedValue(e))||!t.positions||0===t.positions.length){n-=s;continue}let h=t.clone();if(this.matrix.isConnected){let t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(h,this._currentPosition,t,a)}else{let t=e.adaptInput(this.scaling,i_.Vector3,i1.P.OneReadOnly),i=this.rotation.getConnectedValue(e)||i1.P.ZeroReadOnly;e._instantiate(h,this._currentPosition,i,t,a)}o++,this._currentLoopIndex++}}if(a.length){if(1===a.length)this._vertexData=a[0];else{let e=a.splice(0,1)[0];this._vertexData=e.merge(a,!0,!1,!0,!0)}}return e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fE.prototype,"evaluateContext",void 0),(0,i3.H7)("BABYLON.InstantiateOnFacesBlock",fE);class fC extends dz{constructor(e){super(e),this._currentPosition=new i1.P,this._vertex0=new i1.P,this._vertex1=new i1.P,this._vertex2=new i1.P,this.evaluateContext=!0,this.gridMode=!1,this.registerInput("geometry",i_.Geometry),this.registerInput("instance",i_.Geometry,!0),this.registerInput("count",i_.Int,!0,256),this.registerInput("matrix",i_.Matrix,!0),this.registerInput("rotation",i_.Vector3,!0,i1.P.Zero()),this.registerInput("scaling",i_.Vector3,!0,i1.P.One()),this.registerInput("gridSize",i_.Int,!0,10),this.scaling.acceptedConnectionPointTypes.push(i_.Float),this.registerOutput("output",i_.Geometry)}getInstanceIndex(){return this._currentLoopIndex}getExecutionIndex(){return 0}getExecutionFaceIndex(){return 0}getExecutionLoopIndex(){return this._currentLoopIndex}getOverridePositionsContextualValue(){return this._currentPosition}getClassName(){return"InstantiateOnVolumeBlock"}get geometry(){return this._inputs[0]}get instance(){return this._inputs[1]}get count(){return this._inputs[2]}get matrix(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}get gridSize(){return this._inputs[6]}get output(){return this._outputs[0]}_getValueOnGrid(e,t,i,r){let s=(r-i)/t;return i+s/2+e*s}_getIndexinGrid(e,t,i,r){return e+t*r+i*r*r}_buildBlock(e){let t=e=>{let t;if(e.pushExecutionContext(this),e.pushInstancingContext(this),this._vertexData=this.geometry.getConnectedValue(e),e.pushGeometryContext(this._vertexData),!this._vertexData||!this._vertexData.positions||!this._vertexData.indices||!this.instance.isConnected){e.restoreExecutionContext(),e.restoreInstancingContext(),e.restoreGeometryContext(),this.output._storedValue=null;return}let i=null,r=this.count.getConnectedValue(e),s=[],n=(0,d_.k)(this._vertexData.positions,0,this._vertexData.positions.length/3),a=n.minimum,o=n.maximum,l=new i1.P(.5,.8,.2),c=this._vertexData.indices.length/3,u=this.gridSize.getConnectedValue(e);if(this._currentLoopIndex=0,this.gridMode){t=[];for(let e=0;e<u*u*u;e++)t[e]=!1}for(let n=0;n<r;n++){if(this.gridMode){let e=Math.floor(Math.random()*u),i=Math.floor(Math.random()*u),r=Math.floor(Math.random()*u),s=this._getIndexinGrid(e,i,r,u);if(t[s]){let n=!1;for(let a=0;a<u*u*u;a++)if(!t[a]){r=Math.floor(a/(u*u)),i=Math.floor((a-r*u*u)/u),e=a-r*u*u-i*u,s=this._getIndexinGrid(e,i,r,u),n=!0;break}if(!n)break}if(!t[s]){let n=this._getValueOnGrid(e,u,a.x,o.x),l=this._getValueOnGrid(i,u,a.y,o.y),c=this._getValueOnGrid(r,u,a.z,o.z);this._currentPosition.set(n,l,c),t[s]=!0}}else this._currentPosition.set(Math.random()*(o.x-a.x)+a.x,Math.random()*(o.y-a.y)+a.y,Math.random()*(o.z-a.z)+a.z);let r=new nr.zH(this._currentPosition,l),h=0;for(let e=0;e<c;e++){this._vertex0.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e]),this._vertex1.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+1]),this._vertex2.fromArray(this._vertexData.positions,3*this._vertexData.indices[3*e+2]);let t=r.intersectsTriangle(this._vertex0,this._vertex1,this._vertex2);t&&t.distance>0&&h++}if(h%2==0){n--;continue}if(!(i=this.instance.getConnectedValue(e))||!i.positions||0===i.positions.length)continue;let d=i.clone();if(this.matrix.isConnected){let t=this.matrix.getConnectedValue(e);e._instantiateWithPositionAndMatrix(d,this._currentPosition,t,s)}else{let t=e.adaptInput(this.scaling,i_.Vector3,i1.P.OneReadOnly),i=this.rotation.getConnectedValue(e)||i1.P.ZeroReadOnly;e._instantiate(d,this._currentPosition,i,t,s)}this._currentLoopIndex++}if(s.length){if(1===s.length)this._vertexData=s[0];else{let e=s.splice(0,1)[0];this._vertexData=e.merge(s,!0,!1,!0,!0)}}return e.restoreGeometryContext(),e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`+`${this._codeVariableName}.gridMode = ${this.gridMode?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.gridMode=this.gridMode,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext),void 0!==e.gridMode&&(this.gridMode=e.gridMode)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fC.prototype,"evaluateContext",void 0),(0,r$.gn)([lM("Grid mode",0,"MODES",{notifiers:{rebuild:!0}})],fC.prototype,"gridMode",void 0),(0,i3.H7)("BABYLON.InstantiateOnVolumeBlock",fC);class fT extends dz{constructor(e){super(e),this.evaluateContext=!0,this.registerInput("instance",i_.Geometry,!0),this.registerInput("count",i_.Int,!0,1),this.registerOutput("output",i_.Geometry)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBaseBlock"}get instance(){return this._inputs[0]}get count(){return this._inputs[1]}get output(){return this._outputs[0]}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e}_deserialize(e){super._deserialize(e),void 0!==e.evaluateContext&&(this.evaluateContext=e.evaluateContext)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fT.prototype,"evaluateContext",void 0);class fb extends fT{constructor(e){super(e),this.registerInput("matrix",i_.Matrix,!0),this.registerInput("position",i_.Vector3,!0,i1.P.Zero()),this.registerInput("rotation",i_.Vector3,!0,i1.P.Zero()),this.registerInput("scaling",i_.Vector3,!0,i1.P.One()),this.scaling.acceptedConnectionPointTypes.push(i_.Float)}getInstanceIndex(){return this._currentIndex}getExecutionIndex(){return this._currentIndex}getExecutionLoopIndex(){return this._currentIndex}getExecutionFaceIndex(){return 0}getClassName(){return"InstantiateBlock"}get matrix(){return this._inputs[2]}get position(){return this._inputs[3]}get rotation(){return this._inputs[4]}get scaling(){return this._inputs[5]}_buildBlock(e){let t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);let t=this.count.getConnectedValue(e),i=[];for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){let t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;let r=t.clone();if(this.matrix.isConnected){let t=this.matrix.getConnectedValue(e);e._instantiateWithMatrix(r,t,i)}else{let t=this.position.getConnectedValue(e)||i1.P.ZeroReadOnly,s=e.adaptInput(this.scaling,i_.Vector3,i1.P.OneReadOnly),n=this.rotation.getConnectedValue(e)||i1.P.ZeroReadOnly;e._instantiate(r,t,n,s,i)}}if(i.length){if(1===i.length)this._vertexData=i[0];else{let e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,i3.H7)("BABYLON.InstantiateBlock",fb);class fy extends fT{constructor(e){super(e),this.registerInput("direction",i_.Vector3,!0,new i1.P(1,0,0)),this.registerInput("rotation",i_.Vector3,!0,new i1.P(0,0,0)),this.registerInput("scaling",i_.Vector3,!0,new i1.P(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(i_.Float)}getClassName(){return"InstantiateLinearBlock"}get direction(){return this._inputs[2]}get rotation(){return this._inputs[3]}get scaling(){return this._inputs[4]}_buildBlock(e){let t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);let t=this.count.getConnectedValue(e),i=[],r=i1.y3.Identity(),s=i1.P.Zero(),n=i1.P.Zero(),a=i1.P.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){let t=this.instance.getConnectedValue(e);if(!t||!t.positions||0===t.positions.length)continue;let o=t.clone(),l=this.direction.getConnectedValue(e),c=this.rotation.getConnectedValue(e),u=e.adaptInput(this.scaling,i_.Vector3,i1.P.OneReadOnly);s.copyFrom(l.clone().scale(this._currentIndex)),n.copyFrom(c.clone().scale(this._currentIndex)),a.copyFrom(u.clone().scale(this._currentIndex)),a.addInPlaceFromFloats(1,1,1),i1.y3.ComposeToRef(a,i1._f.FromEulerAngles(n.x,n.y,n.z),s,r),e._instantiateWithMatrix(o,r,i)}if(i.length){if(1===i.length)this._vertexData=i[0];else{let e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,i3.H7)("BABYLON.InstantiateLinearBlock",fy);class fI extends fT{constructor(e){super(e),this.registerInput("radius",i_.Int,!0,0,0),this.registerInput("angleStart",i_.Float,!0,0),this.registerInput("angleEnd",i_.Float,!0,2*Math.PI),this.registerInput("transform",i_.Vector3,!0,new i1.P(0,0,0)),this.registerInput("rotation",i_.Vector3,!0,new i1.P(0,0,0)),this.registerInput("scaling",i_.Vector3,!0,new i1.P(0,0,0)),this.scaling.acceptedConnectionPointTypes.push(i_.Float)}getClassName(){return"InstantiateRadialBlock"}get radius(){return this._inputs[2]}get angleStart(){return this._inputs[3]}get angleEnd(){return this._inputs[4]}get transform(){return this._inputs[5]}get rotation(){return this._inputs[6]}get scaling(){return this._inputs[7]}_buildBlock(e){let t=e=>{e.pushExecutionContext(this),e.pushInstancingContext(this);let t=this.count.getConnectedValue(e),i=[],r=i1.y3.Identity(),s=i1.y3.Identity(),n=i1.y3.Identity(),a=i1.P.Zero(),o=i1.P.Zero(),l=i1.P.Zero();for(this._currentIndex=0;this._currentIndex<t;this._currentIndex++){let c=this.instance.getConnectedValue(e);if(!c||!c.positions||0===c.positions.length)continue;let u=c.clone(),h=this.radius.getConnectedValue(e),d=this.angleStart.getConnectedValue(e),f=this.angleEnd.getConnectedValue(e),p=this.transform.getConnectedValue(e),m=this.rotation.getConnectedValue(e),_=e.adaptInput(this.scaling,i_.Vector3,i1.P.OneReadOnly),g=(f-d)/t,v=d+g*this._currentIndex,S=i1._f.FromEulerAngles(0,v,0);a.copyFrom(p.clone().scale(this._currentIndex)),o.copyFrom(m.clone().scale(this._currentIndex)),l.copyFrom(_.clone().scale(this._currentIndex)),l.addInPlaceFromFloats(1,1,1),i1.y3.RotationYawPitchRollToRef(o.y,o.x,o.z,r),s.setTranslationFromFloats(0,0,h),i1.y3.ComposeToRef(l,S,a,n),r.multiplyToRef(s,s),s.multiplyToRef(n,n),e._instantiateWithMatrix(u,n,i)}if(i.length){if(1===i.length)this._vertexData=i[0];else{let e=i.splice(0,1)[0];this._vertexData=e.merge(i,!0,!1,!0,!0)}}return e.restoreExecutionContext(),e.restoreInstancingContext(),this._vertexData};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}}(0,i3.H7)("BABYLON.InstantiateRadialBlock",fI);class fP extends dz{constructor(e){super(e),this.registerInput("float ",i_.Float,!0),this.registerInput("int ",i_.Int,!0),this.registerOutput("float",i_.Float),this.registerOutput("int",i_.Int)}getClassName(){return"IntFloatConverterBlock"}get floatIn(){return this._inputs[0]}get intIn(){return this._inputs[1]}get floatOut(){return this._outputs[0]}get intOut(){return this._outputs[1]}_inputRename(e){return"float "===e?"floatIn":"int "===e?"intIn":e}_buildBlock(){this.floatOut._storedFunction=e=>this.floatIn.isConnected?this.floatIn.getConnectedValue(e):this.intIn.isConnected?this.intIn.getConnectedValue(e):0,this.intOut._storedFunction=e=>this.floatIn.isConnected?Math.floor(this.floatIn.getConnectedValue(e)):this.intIn.isConnected?Math.floor(this.intIn.getConnectedValue(e)):0}}(0,i3.H7)("BABYLON.IntFloatConverterBlock",fP);class fR extends dz{constructor(e){super(e),this.log=[],this._isDebug=!0,this.registerInput("input",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}get buildExecutionTime(){return -1}getClassName(){return"DebugBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}this.log=[];let t=e=>{let t=this.input.getConnectedValue(e);if(null==t)return this.log.push(["null",""]),t;switch(this.input.type){case i_.Vector2:this.log.push([`{X: ${t.x.toFixed(4)} Y: ${t.y.toFixed(4)}}`,t.toString()]);break;case i_.Vector3:this.log.push([`{X: ${t._x.toFixed(4)} Y: ${t._y.toFixed(4)} Z: ${t._z.toFixed(4)}}`,t.toString()]);break;case i_.Vector4:this.log.push([`{X: ${t.x.toFixed(4)} Y: ${t.y.toFixed(4)} Z: ${t.z.toFixed(4)} W: ${t.w.toFixed(4)}}`,t.toString()]);break;default:this.log.push([t.toString(),t.toString()])}return t};this.output.isConnected?this.output._storedFunction=t:this.output._storedValue=t(e)}}(0,i3.H7)("BABYLON.DebugBlock",fR);class fA extends dz{constructor(e){super(e),this.registerInput("geometry",i_.Geometry),this.registerOutput("output",i_.Geometry),this.registerOutput("id",i_.Int),this.registerOutput("collectionId",i_.Int),this.registerOutput("verticesCount",i_.Int),this.registerOutput("facesCount",i_.Int)}getClassName(){return"GeometryInfoBlock"}get geometry(){return this._inputs[0]}get output(){return this._outputs[0]}get id(){return this._outputs[1]}get collectionId(){return this._outputs[2]}get verticesCount(){return this._outputs[3]}get facesCount(){return this._outputs[4]}_buildBlock(){if(!this.geometry.isConnected){this.id._storedValue=0,this.collectionId._storedValue=0,this.verticesCount._storedValue=0,this.facesCount._storedValue=0,this.output._storedValue=0,this.id._storedFunction=null,this.collectionId._storedFunction=null,this.verticesCount._storedFunction=null,this.facesCount._storedFunction=null,this.output._storedFunction=null;return}this.output._storedFunction=e=>(this._currentVertexData=this.geometry.getConnectedValue(e),this._currentVertexData),this.id._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.uniqueId),this.collectionId._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.metadata?this._currentVertexData.metadata.collectionId:0),this.verticesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.positions?this._currentVertexData.positions.length/3:0),this.facesCount._storedFunction=e=>(this._currentVertexData=this._currentVertexData||this.geometry.getConnectedValue(e),this._currentVertexData.indices?this._currentVertexData.indices.length/3:0)}}(0,i3.H7)("BABYLON.GeometryInfoBlock",fA),(eL=ib||(ib={}))[eL.Spherical=0]="Spherical",eL[eL.Cylindrical=1]="Cylindrical",eL[eL.Cubic=2]="Cubic";class fM extends dz{constructor(e){super(e),this.mapping=ib.Spherical,this.registerInput("position",i_.Vector3),this.registerInput("normal",i_.Vector3),this.registerInput("center",i_.Vector3,!0,i1.P.Zero()),this.registerOutput("uv",i_.Vector2)}getClassName(){return"MappingBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get center(){return this._inputs[2]}get uv(){return this._outputs[0]}_buildBlock(){if(!this.position.isConnected){this.uv._storedFunction=null,this.uv._storedValue=null;return}let e=i1.P.Zero(),t=t=>{let i=this.position.getConnectedValue(t)||i1.P.Zero(),r=this.normal.getConnectedValue(t)||i1.P.Zero(),s=this.center.getConnectedValue(t),n=i1.FM.Zero();switch(this.mapping){case ib.Spherical:{i.subtractToRef(s,e);let t=e.length();t>0&&(n.x=Math.acos(e.y/t)/Math.PI,(0!==e.x||0!==e.z)&&(n.y=Math.atan2(e.x,e.z)/(2*Math.PI)));break}case ib.Cylindrical:{i.subtractToRef(s,e);let t=e.length();t>0&&(n.x=Math.atan2(e.x/t,e.z/t)/(2*Math.PI),n.y=(e.y+1)/2);break}case ib.Cubic:{let e=Math.abs(r.x),t=Math.abs(r.y),a=Math.abs(r.z),o=Math.max(Math.abs(i.x),Math.abs(i.y),Math.abs(i.z)),l=0,c=0;e>=t&&e>=a?(l=i.y/o-s.y,c=i.z/o-s.z):t>=e&&t>=a?(l=i.x/o-s.x,c=i.z/o-s.z):(l=i.x/o-s.x,c=i.y/o-s.y),n.x=(l+1)/2,n.y=(c+1)/2}}return n};this.uv._storedFunction=e=>t(e)}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.mapping = BABYLON.MappingTypes.${ib[this.mapping]};
`}serialize(){let e=super.serialize();return e.mapping=this.mapping,e}_deserialize(e){super._deserialize(e),this.mapping=e.mapping}}(0,r$.gn)([lM("Mapping",4,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Spherical",value:ib.Spherical},{label:"Cylindrical",value:ib.Cylindrical},{label:"Cubic",value:ib.Cubic}]})],fM.prototype,"mapping",void 0),(0,i3.H7)("BABYLON.MappingBlock",fM);class fN extends dz{constructor(e){super(e),this.registerInput("matrix0",i_.Matrix),this.registerInput("matrix1",i_.Matrix),this.registerOutput("output",i_.Matrix)}getClassName(){return"MatrixComposeBlock"}get matrix0(){return this._inputs[0]}get matrix1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){this.output._storedFunction=e=>{if(!this.matrix0.isConnected||!this.matrix1.isConnected)return null;let t=this.matrix0.getConnectedValue(e),i=this.matrix1.getConnectedValue(e);return t&&i?t.multiply(i):null}}}(0,i3.H7)("BABYLON.MatrixComposeBlock",fN);class fO extends dz{get endpoints(){return this._endpoints}constructor(e){super(e),this._endpoints=[],this._isTeleportIn=!0,this.registerInput("input",i_.AutoDetect)}getClassName(){return"TeleportInBlock"}get input(){return this._inputs[0]}_dumpCode(e,t){let i=super._dumpCode(e,t);for(let r of this.endpoints)-1===t.indexOf(r)&&(i+=r._dumpCode(e,t));return i}isAnAncestorOfType(e){if(this.getClassName()===e)return!0;for(let t of this.endpoints)if(t.isAnAncestorOfType(e))return!0;return!1}isAnAncestorOf(e){for(let t of this.endpoints)if(t===e||t.isAnAncestorOf(e))return!0;return!1}getDescendantOfPredicate(e){if(e(this))return this;for(let t of this.endpoints){let i=t.getDescendantOfPredicate(e);if(i)return i}return null}attachToEndpoint(e){e.detach(),this._endpoints.push(e),e._entryPoint=this,e._outputs[0]._typeConnectionSource=this._inputs[0],e._tempEntryPointUniqueId=null,e.name="> "+this.name}detachFromEndpoint(e){let t=this._endpoints.indexOf(e);-1!==t&&(this._endpoints.splice(t,1),e._outputs[0]._typeConnectionSource=null,e._entryPoint=null)}_buildBlock(){for(let e of this._endpoints)e.output._storedFunction=e=>this.input.getConnectedValue(e)}}(0,i3.H7)("BABYLON.TeleportInBlock",fO);class fD extends dz{constructor(e){super(e),this._entryPoint=null,this._tempEntryPointUniqueId=null,this._isTeleportOut=!0,this.registerOutput("output",i_.BasedOnInput)}get entryPoint(){return this._entryPoint}getClassName(){return"TeleportOutBlock"}get output(){return this._outputs[0]}detach(){this._entryPoint&&this._entryPoint.detachFromEndpoint(this)}_buildBlock(){}_customBuildStep(e){this.entryPoint&&this.entryPoint.build(e)}_dumpCode(e,t){let i="";return this.entryPoint&&-1===t.indexOf(this.entryPoint)&&(i+=this.entryPoint._dumpCode(e,t)),i+super._dumpCode(e,t)}_dumpCodeForOutputConnections(e){let t=super._dumpCodeForOutputConnections(e);return this.entryPoint&&(t+=this.entryPoint._dumpCodeForOutputConnections(e)),t}clone(){let e=super.clone();return this.entryPoint&&this.entryPoint.attachToEndpoint(e),e}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.entryPoint&&(e+=`${this.entryPoint._codeVariableName}.attachToEndpoint(${this._codeVariableName});
`),e}serialize(){let e=super.serialize();return e.entryPoint=this.entryPoint?.uniqueId??"",e}_deserialize(e){super._deserialize(e),this._tempEntryPointUniqueId=e.entryPoint}}(0,i3.H7)("BABYLON.TeleportOutBlock",fD);class fF extends dz{get textureData(){return this._data}get textureWidth(){return this._width}get textureHeight(){return this._height}constructor(e){super(e),this._data=null,this.serializedCachedData=!1,this.registerOutput("texture",i_.Texture)}getClassName(){return"GeometryTextureBlock"}get texture(){return this._outputs[0]}_prepareImgToLoadAsync(e){return new Promise((t,i)=>{let r=new Image,s=document.createElement("canvas"),n=s.getContext("2d");r.onload=()=>{s.width=r.width,s.height=r.height,n.drawImage(r,0,0);let e=n.getImageData(0,0,r.width,r.height).data,i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=r.width,this._height=r.height,t()},r.onerror=()=>{this._data=null,i()},r.src=e})}cleanData(){this._data=null}loadTextureFromFileAsync(e){return this._prepareImgToLoadAsync(URL.createObjectURL(e))}loadTextureFromUrlAsync(e){return this._prepareImgToLoadAsync(e)}extractFromTextureAsync(e){return new Promise((t,i)=>{if(!e.isReady()){e.onLoadObservable.addOnce(()=>this.extractFromTextureAsync(e).then(t).catch(i));return}let r=e.getSize();a1.Oi.GetTextureDataAsync(e,r.width,r.height).then(async e=>{let i=new Float32Array(e.length);for(let t=0;t<e.length;t++)i[t]=e[t]/255;this._data=i,this._width=r.width,this._height=r.height,t()}).catch(i)})}_buildBlock(){if(!this._data){this.texture._storedValue=null;return}let e={data:this._data,width:this._width,height:this._height};this.texture._storedValue=e}serialize(){let e=super.serialize();return e.width=this._width,e.height=this._height,e.serializedCachedData=this.serializedCachedData,this._data&&this.serializedCachedData&&(e.data=Array.from(this._data)),e}_deserialize(e){super._deserialize(e),this._width=e.width,this._height=e.height,e.data?(this._data=new Float32Array(e.data),this.serializedCachedData=!0):this.serializedCachedData=!!e.serializedCachedData}}(0,r$.gn)([lM("Serialize cached data",0,"ADVANCED",{notifiers:{rebuild:!0}})],fF.prototype,"serializedCachedData",void 0),(0,i3.H7)("BABYLON.GeometryTextureBlock",fF);class fL extends dz{constructor(e){super(e),this.clampCoordinates=!0,this.registerInput("texture",i_.Texture),this.registerInput("coordinates",i_.Vector2),this.registerOutput("rgba",i_.Vector4),this.registerOutput("rgb",i_.Vector3),this.registerOutput("r",i_.Float),this.registerOutput("g",i_.Float),this.registerOutput("b",i_.Float),this.registerOutput("a",i_.Float)}getClassName(){return"GeometryTextureFetchBlock"}get texture(){return this.inputs[0]}get coordinates(){return this.inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}_repeatClamp(e){return e>=0?e%1:1-Math.abs(e)%1}_buildBlock(){let e=e=>{let t=this.texture.getConnectedValue(e);if(!t||!t.data)return null;let i=this.coordinates.getConnectedValue(e);if(!i)return null;let r=this.clampCoordinates?Math.max(0,Math.min(i.x,1)):this._repeatClamp(i.x),s=this.clampCoordinates?Math.max(0,Math.min(i.y,1)):this._repeatClamp(i.y),n=Math.floor(r*(t.width-1)),a=Math.floor(s*(t.height-1)),o=n+t.width*a;return i1.Lt.FromArray(t.data,4*o)};this.rgba._storedFunction=t=>e(t),this.rgb._storedFunction=t=>{let i=e(t);return i?i.toVector3():null},this.r._storedFunction=t=>{let i=e(t);return i?i.x:null},this.g._storedFunction=t=>{let i=e(t);return i?i.y:null},this.b._storedFunction=t=>{let i=e(t);return i?i.z:null},this.a._storedFunction=t=>{let i=e(t);return i?i.w:null}}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.clampCoordinates = ${this.clampCoordinates};
`}serialize(){let e=super.serialize();return e.clampCoordinates=this.clampCoordinates,e}_deserialize(e){super._deserialize(e),this.clampCoordinates=e.clampCoordinates}}(0,r$.gn)([lM("Clamp Coordinates",0,"ADVANCED",{notifiers:{rebuild:!0}})],fL.prototype,"clampCoordinates",void 0),(0,i3.H7)("BABYLON.GeometryTextureFetchBlock",fL);class fw extends dz{constructor(e){super(e),this.registerInput("geometry",i_.Geometry),this.registerOutput("min",i_.Vector3),this.registerOutput("max",i_.Vector3)}getClassName(){return"BoundingBlock"}get geometry(){return this._inputs[0]}get min(){return this._outputs[0]}get max(){return this._outputs[1]}_buildBlock(){this.min._storedFunction=e=>{let t=this.geometry.getConnectedValue(e);return t?(0,d_.k)(t.positions,0,t.positions.length/3).minimum:null},this.max._storedFunction=e=>{let t=this.geometry.getConnectedValue(e);return t?(0,d_.k)(t.positions,0,t.positions.length/3).maximum:null}}}(0,i3.H7)("BABYLON.BoundingBlock",fw),(ew=iy||(iy={}))[ew.Intersect=0]="Intersect",ew[ew.Subtract=1]="Subtract",ew[ew.Union=2]="Union";class fB extends dz{constructor(e){super(e),this.evaluateContext=!1,this.operation=iy.Intersect,this.registerInput("geometry0",i_.Geometry),this.registerInput("geometry1",i_.Geometry),this.registerOutput("output",i_.Geometry)}getClassName(){return"BooleanGeometryBlock"}get geometry0(){return this._inputs[0]}get geometry1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){let t=e=>{let t;let i=this.geometry0.getConnectedValue(e),r=this.geometry1.getConnectedValue(e);if(!i||!r)return null;let s=i.positions.length/3;!i.normals&&r.normals&&(i.normals=Array(i.positions.length)),!r.normals&&i.normals&&(r.normals=Array(r.positions.length)),!i.uvs&&r.uvs&&(i.uvs=Array(2*s)),!r.uvs&&i.uvs&&(r.uvs=Array(2*s)),!i.colors&&r.colors&&(i.colors=Array(4*s)),!r.colors&&i.colors&&(r.colors=Array(4*s));let n=dR.FromVertexData(i),a=dR.FromVertexData(r);switch(this.operation){case iy.Intersect:t=n.intersect(a);break;case iy.Subtract:t=n.subtract(a);break;case iy.Union:t=n.union(a)}return t.toVertexData()};this.evaluateContext?this.output._storedFunction=t:(this.output._storedFunction=null,this.output._storedValue=t(e))}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.evaluateContext = ${this.evaluateContext?"true":"false"};
`+`${this._codeVariableName}.operation = BABYLON.BooleanGeometryOperations.${iy[this.operation]};
`}serialize(){let e=super.serialize();return e.evaluateContext=this.evaluateContext,e.operation=this.operation,e}_deserialize(e){super._deserialize(e),this.evaluateContext=e.evaluateContext,e.operation&&(this.operation=e.operation)}}(0,r$.gn)([lM("Evaluate context",0,"ADVANCED",{notifiers:{rebuild:!0}})],fB.prototype,"evaluateContext",void 0),(0,r$.gn)([lM("Operation",4,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"Intersect",value:iy.Intersect},{label:"Subtract",value:iy.Subtract},{label:"Union",value:iy.Union}]})],fB.prototype,"operation",void 0),(0,i3.H7)("BABYLON.BooleanGeometryBlock",fB);class fV extends dz{constructor(e){super(e),this.registerInput("x",i_.AutoDetect),this.registerInput("y",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.x.isConnected||!this.y.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(e,t)=>Math.atan2(e,t);this.output._storedFunction=t=>{let i=this.x.getConnectedValue(t),r=this.y.getConnectedValue(t);switch(this.x.type){case i_.Int:case i_.Float:return e(i,r);case i_.Vector2:return new i1.FM(e(i.x,r.x),e(i.y,r.y));case i_.Vector3:return new i1.P(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case i_.Vector4:return new i1.Lt(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0}}}(0,i3.H7)("BABYLON.GeometryArcTan2Block",fV);class fU extends dz{constructor(e){super(e),this.registerInput("left",i_.AutoDetect),this.registerInput("right",i_.AutoDetect),this.registerInput("gradient",i_.Float),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected||!this.gradient.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(e,t,i)=>(1-e)*t+e*i;return this.output._storedFunction=t=>{let i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),s=this.gradient.getConnectedValue(t);switch(this.left.type){case i_.Int:case i_.Float:return e(s,i,r);case i_.Vector2:return new i1.FM(e(s,i.x,r.x),e(s,i.y,r.y));case i_.Vector3:return new i1.P(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z));case i_.Vector4:return new i1.Lt(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z),e(s,i.w,r.w))}return 0},this}}(0,i3.H7)("BABYLON.GeometryLerpBlock",fU);class fk extends dz{constructor(e){super(e),this.registerInput("left",i_.AutoDetect),this.registerInput("right",i_.AutoDetect),this.registerInput("gradient",i_.Float),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryNLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected||!this.gradient.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(e,t,i)=>(1-e)*t+e*i;return this.output._storedFunction=t=>{let i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t),s=this.gradient.getConnectedValue(t);switch(this.left.type){case i_.Int:case i_.Float:return e(s,i,r);case i_.Vector2:{let t=new i1.FM(e(s,i.x,r.x),e(s,i.y,r.y));return t.normalize(),t}case i_.Vector3:{let t=new i1.P(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z));return t.normalize(),t}case i_.Vector4:{let t=new i1.Lt(e(s,i.x,r.x),e(s,i.y,r.y),e(s,i.z,r.z),e(s,i.w,r.w));return t.normalize(),t}}return 0},this}}(0,i3.H7)("BABYLON.GeometryNLerpBlock",fk);class fG extends dz{constructor(e){super(e),this.registerInput("value",i_.AutoDetect),this.registerInput("edge",i_.Float),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryStepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.edge.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(e,t)=>e<t?0:1;return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t),r=this.edge.getConnectedValue(t);switch(this.value.type){case i_.Int:case i_.Float:return e(i,r);case i_.Vector2:return new i1.FM(e(i.x,r),e(i.y,r));case i_.Vector3:return new i1.P(e(i.x,r),e(i.y,r),e(i.z,r));case i_.Vector4:return new i1.Lt(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}(0,i3.H7)("BABYLON.GeometryStepBlock",fG);class fz extends dz{constructor(e){super(e),this.registerInput("value",i_.AutoDetect),this.registerInput("edge0",i_.Float),this.registerInput("edge1",i_.Float),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometrySmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.edge0.isConnected||!this.edge1.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(e,t,i)=>{let r=Math.max(0,Math.min((e-t)/(i-t),1));return r*r*(3-2*r)};return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t),r=this.edge0.getConnectedValue(t),s=this.edge1.getConnectedValue(t);switch(this.value.type){case i_.Int:case i_.Float:return e(i,r,s);case i_.Vector2:return new i1.FM(e(i.x,r,s),e(i.y,r,s));case i_.Vector3:return new i1.P(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s));case i_.Vector4:return new i1.Lt(e(i.x,r,s),e(i.y,r,s),e(i.z,r,s),e(i.w,r,s))}return 0},this}}(0,i3.H7)("BABYLON.GeometrySmoothStepBlock",fz);class fH extends dz{constructor(e){super(e),this.registerInput("left",i_.AutoDetect),this.registerInput("right",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(e,t)=>e-Math.floor(e/t)*t;return this.output._storedFunction=t=>{let i=this.left.getConnectedValue(t),r=this.right.getConnectedValue(t);switch(this.left.type){case i_.Int:case i_.Float:return e(i,r);case i_.Vector2:return new i1.FM(e(i.x,r.x),e(i.y,r.y));case i_.Vector3:return new i1.P(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z));case i_.Vector4:return new i1.Lt(e(i.x,r.x),e(i.y,r.y),e(i.z,r.z),e(i.w,r.w))}return 0},this}}(0,i3.H7)("BABYLON.GeometryModBlock",fH);class fW extends dz{constructor(e){super(e),this.registerInput("value",i_.AutoDetect),this.registerInput("power",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryPowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.power.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=(e,t)=>Math.pow(e,t);return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t),r=this.power.getConnectedValue(t);switch(this.value.type){case i_.Int:case i_.Float:return e(i,r);case i_.Vector2:return new i1.FM(e(i.x,r),e(i.y,r));case i_.Vector3:return new i1.P(e(i.x,r),e(i.y,r),e(i.z,r));case i_.Vector4:return new i1.Lt(e(i.x,r),e(i.y,r),e(i.z,r),e(i.w,r))}return 0},this}}(0,i3.H7)("BABYLON.GeometryPowBlock",fW);class fY extends dz{constructor(e){super(e),this.minimum=0,this.maximum=1,this.registerInput("value",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Geometry),this._inputs[0].excludedConnectionPointTypes.push(i_.Texture)}getClassName(){return"GeometryClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}let e=e=>Math.max(this.minimum,Math.min(e,this.maximum));return this.output._storedFunction=t=>{let i=this.value.getConnectedValue(t);switch(this.value.type){case i_.Int:case i_.Float:return e(i);case i_.Vector2:return new i1.FM(e(i.x),e(i.y));case i_.Vector3:return new i1.P(e(i.x),e(i.y),e(i.z));case i_.Vector4:return new i1.Lt(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};
`+`${this._codeVariableName}.maximum = ${this.maximum};
`}serialize(){let e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e){super._deserialize(e),this.minimum=e.minimum,this.maximum=e.maximum}}(0,r$.gn)([lM("Minimum",1)],fY.prototype,"minimum",void 0),(0,r$.gn)([lM("Maximum",1)],fY.prototype,"maximum",void 0),(0,i3.H7)("BABYLON.GeometryClampBlock",fY);class fX extends dz{constructor(e){super(e),this.registerInput("left",i_.AutoDetect),this.registerInput("right",i_.AutoDetect),this.registerOutput("output",i_.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Int),this._inputs[0].excludedConnectionPointTypes.push(i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Vector2),this._inputs[1].excludedConnectionPointTypes.push(i_.Int),this._inputs[1].excludedConnectionPointTypes.push(i_.Float),this._inputs[1].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[1].excludedConnectionPointTypes.push(i_.Vector2)}getClassName(){return"GeometryCrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);switch(this.left.type){case i_.Vector3:return i1.P.Cross(t,i);case i_.Vector4:return i1.P.Cross(t.toVector3(),i.toVector3())}return 0},this}}(0,i3.H7)("BABYLON.GeometryCrossBlock",fX),(eB=iI||(iI={}))[eB.EaseInSine=0]="EaseInSine",eB[eB.EaseOutSine=1]="EaseOutSine",eB[eB.EaseInOutSine=2]="EaseInOutSine",eB[eB.EaseInQuad=3]="EaseInQuad",eB[eB.EaseOutQuad=4]="EaseOutQuad",eB[eB.EaseInOutQuad=5]="EaseInOutQuad",eB[eB.EaseInCubic=6]="EaseInCubic",eB[eB.EaseOutCubic=7]="EaseOutCubic",eB[eB.EaseInOutCubic=8]="EaseInOutCubic",eB[eB.EaseInQuart=9]="EaseInQuart",eB[eB.EaseOutQuart=10]="EaseOutQuart",eB[eB.EaseInOutQuart=11]="EaseInOutQuart",eB[eB.EaseInQuint=12]="EaseInQuint",eB[eB.EaseOutQuint=13]="EaseOutQuint",eB[eB.EaseInOutQuint=14]="EaseInOutQuint",eB[eB.EaseInExpo=15]="EaseInExpo",eB[eB.EaseOutExpo=16]="EaseOutExpo",eB[eB.EaseInOutExpo=17]="EaseInOutExpo",eB[eB.EaseInCirc=18]="EaseInCirc",eB[eB.EaseOutCirc=19]="EaseOutCirc",eB[eB.EaseInOutCirc=20]="EaseInOutCirc",eB[eB.EaseInBack=21]="EaseInBack",eB[eB.EaseOutBack=22]="EaseOutBack",eB[eB.EaseInOutBack=23]="EaseInOutBack",eB[eB.EaseInElastic=24]="EaseInElastic",eB[eB.EaseOutElastic=25]="EaseOutElastic",eB[eB.EaseInOutElastic=26]="EaseInOutElastic";class f$ extends dz{constructor(e){super(e),this.type=iI.EaseInOutSine,this.registerInput("input",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[0].excludedConnectionPointTypes.push(i_.Int)}getClassName(){return"GeometryCurveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){let e;if(!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}switch(this.type){case iI.EaseInSine:e=e=>1-Math.cos(3.1415*e/2);break;case iI.EaseOutSine:e=e=>Math.sin(3.1415*e/2);break;case iI.EaseInOutSine:e=e=>-(Math.cos(3.1415*e)-1)/2;break;case iI.EaseInQuad:e=e=>e*e;break;case iI.EaseOutQuad:e=e=>(1-e)*(1-e);break;case iI.EaseInOutQuad:e=e=>e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2;break;case iI.EaseInCubic:e=e=>e*e*e;break;case iI.EaseOutCubic:e=e=>1-Math.pow(1-e,3);break;case iI.EaseInOutCubic:e=e=>e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2;break;case iI.EaseInQuart:e=e=>e*e*e*e;break;case iI.EaseOutQuart:e=e=>1-Math.pow(1-e,4);break;case iI.EaseInOutQuart:e=e=>e<.5?8*e*e*e*e:1-Math.pow(-2*e+2,4)/2;break;case iI.EaseInQuint:e=e=>e*e*e*e*e;break;case iI.EaseOutQuint:e=e=>1-Math.pow(1-e,5);break;case iI.EaseInOutQuint:e=e=>e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2;break;case iI.EaseInExpo:e=e=>0===e?0:Math.pow(2,10*e-10);break;case iI.EaseOutExpo:e=e=>1===e?1:1-Math.pow(2,-10*e);break;case iI.EaseInOutExpo:e=e=>0===e?0:1===e?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2;break;case iI.EaseInCirc:e=e=>1-Math.sqrt(1-Math.pow(e,2));break;case iI.EaseOutCirc:e=e=>Math.sqrt(1-Math.pow(e-1,2));break;case iI.EaseInOutCirc:e=e=>e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2;break;case iI.EaseInBack:e=e=>2.70158*e*e*e-1.70158*e*e;break;case iI.EaseOutBack:e=e=>2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2);break;case iI.EaseInOutBack:e=e=>e<.5?Math.pow(2*e,2)*(7.189819*e-2.5949095)/2:(Math.pow(2*e-2,2)*(3.5949095*(2*e-2)+3.5949095)+2)/2;break;case iI.EaseInElastic:e=e=>0===e?0:1===e?1:-Math.pow(2,10*e-10)*Math.sin(6.283/3*(10*e-10.75));break;case iI.EaseOutElastic:e=e=>0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(6.283/3*(10*e-.75))+1;break;case iI.EaseInOutElastic:e=e=>0===e?0:1==e?1:e<.5?-(Math.pow(2,20*e-10)*Math.sin(6.283/4.5*(20*e-11.125)))/2:Math.pow(2,-20*e+10)*Math.sin(6.283/4.5*(20*e-11.125))/2+1}return this.output._storedFunction=t=>{let i=this.input.getConnectedValue(t);switch(this.input.type){case i_.Float:return e(i);case i_.Vector2:return new i1.FM(e(i.x),e(i.y));case i_.Vector3:return new i1.P(e(i.x),e(i.y),e(i.z));case i_.Vector4:return new i1.Lt(e(i.x),e(i.y),e(i.z),e(i.w))}return 0},this}serialize(){let e=super.serialize();return e.curveType=this.type,e}_deserialize(e){super._deserialize(e),this.type=e.curveType}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.type = BABYLON.GeometryCurveBlockTypes.${iI[this.type]};
`}}(0,r$.gn)([lM("Type",4,"ADVANCED",{notifiers:{rebuild:!0},options:[{label:"EaseInSine",value:iI.EaseInSine},{label:"EaseOutSine",value:iI.EaseOutSine},{label:"EaseInOutSine",value:iI.EaseInOutSine},{label:"EaseInQuad",value:iI.EaseInQuad},{label:"EaseOutQuad",value:iI.EaseOutQuad},{label:"EaseInOutQuad",value:iI.EaseInOutQuad},{label:"EaseInCubic",value:iI.EaseInCubic},{label:"EaseOutCubic",value:iI.EaseOutCubic},{label:"EaseInOutCubic",value:iI.EaseInOutCubic},{label:"EaseInQuart",value:iI.EaseInQuart},{label:"EaseOutQuart",value:iI.EaseOutQuart},{label:"EaseInOutQuart",value:iI.EaseInOutQuart},{label:"EaseInQuint",value:iI.EaseInQuint},{label:"EaseOutQuint",value:iI.EaseOutQuint},{label:"EaseInOutQuint",value:iI.EaseInOutQuint},{label:"EaseInExpo",value:iI.EaseInExpo},{label:"EaseOutExpo",value:iI.EaseOutExpo},{label:"EaseInOutExpo",value:iI.EaseInOutExpo},{label:"EaseInCirc",value:iI.EaseInCirc},{label:"EaseOutCirc",value:iI.EaseOutCirc},{label:"EaseInOutCirc",value:iI.EaseInOutCirc},{label:"EaseInBack",value:iI.EaseInBack},{label:"EaseOutBack",value:iI.EaseOutBack},{label:"EaseInOutBack",value:iI.EaseInOutBack},{label:"EaseInElastic",value:iI.EaseInElastic},{label:"EaseOutElastic",value:iI.EaseOutElastic},{label:"EaseInOutElastic",value:iI.EaseInOutElastic}]})],f$.prototype,"type",void 0),(0,i3.H7)("BABYLON.GeometryCurveBlock",f$);class fj extends dz{constructor(e){super(e),this.registerInput("color",i_.Vector3),this.registerInput("level",i_.Float,!0,0),this.registerOutput("output",i_.Vector3)}getClassName(){return"GeometryDesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.color.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.color.getConnectedValue(e),i=this.level.getConnectedValue(e),r=.5*(Math.min(t.x,t.y,t.z)+Math.max(t.x,t.y,t.z));return new i1.P(t.x*(1-i)+r*i,t.y*(1-i)+r*i,t.z*(1-i)+r*i)},this}}(0,i3.H7)("BABYLON.GeometryDesaturateBlock",fj);class fq extends dz{constructor(e){super(e),this.registerInput("value",i_.AutoDetect),this.registerInput("steps",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[1].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[1].acceptedConnectionPointTypes.push(i_.Float)}getClassName(){return"GeometryPosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.steps.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.value.getConnectedValue(e),i=this.steps.getConnectedValue(e),r=i;if(this.steps.type===i_.Float)switch(this.value.type){case i_.Vector2:r=new i1.FM(i,i);break;case i_.Vector3:r=new i1.P(i,i,i);break;case i_.Vector4:r=new i1.Lt(i,i,i,i)}switch(this.value.type){case i_.Vector2:return new i1.FM(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y));case i_.Vector3:return new i1.P(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z));case i_.Vector4:return new i1.Lt(t.x/(1/r.x)*(1/r.x),t.y/(1/r.y)*(1/r.y),t.z/(1/r.z)*(1/r.z),t.w/(1/r.w)*(1/r.w));default:return Math.floor(t/(1/i)*(1/i))}},this}}(0,i3.H7)("BABYLON.GeometryPosterizeBlock",fq);class fQ extends dz{constructor(e){super(e),this.registerInput("value",i_.AutoDetect),this.registerInput("reference",i_.AutoDetect),this.registerInput("distance",i_.Float),this.registerInput("replacement",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[1].excludedConnectionPointTypes.push(i_.Float),this._inputs[1].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[3].excludedConnectionPointTypes.push(i_.Float),this._inputs[3].excludedConnectionPointTypes.push(i_.Matrix)}getClassName(){return"GeometryReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected||!this.reference.isConnected||!this.distance.isConnected||!this.replacement.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.value.getConnectedValue(e),i=this.reference.getConnectedValue(e),r=this.distance.getConnectedValue(e),s=this.replacement.getConnectedValue(e);return t.subtract(i).length()<r?s:t},this}}(0,i3.H7)("BABYLON.GeometryReplaceColorBlock",fQ);class fK extends dz{constructor(e){super(e),this.registerInput("left",i_.AutoDetect),this.registerInput("right",i_.AutoDetect),this.registerOutput("output",i_.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Int),this._inputs[0].excludedConnectionPointTypes.push(i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[1].excludedConnectionPointTypes.push(i_.Float),this._inputs[1].excludedConnectionPointTypes.push(i_.Matrix)}getClassName(){return"GeometryDistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.subtract(i).length()},this}}(0,i3.H7)("BABYLON.GeometryDistanceBlock",fK);class fZ extends dz{constructor(e){super(e),this.registerInput("left",i_.AutoDetect),this.registerInput("right",i_.AutoDetect),this.registerOutput("output",i_.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(i_.Int),this._inputs[0].excludedConnectionPointTypes.push(i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix),this._inputs[1].excludedConnectionPointTypes.push(i_.Float),this._inputs[1].excludedConnectionPointTypes.push(i_.Matrix)}getClassName(){return"GeometryDotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.left.isConnected||!this.right.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.left.getConnectedValue(e),i=this.right.getConnectedValue(e);return t.dot(i)},this}}(0,i3.H7)("BABYLON.GeometryDotBlock",fZ);class fJ extends dz{constructor(e){super(e),this.registerInput("value",i_.AutoDetect),this.registerOutput("output",i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Int),this._inputs[0].excludedConnectionPointTypes.push(i_.Float),this._inputs[0].excludedConnectionPointTypes.push(i_.Matrix)}getClassName(){return"GeometryLengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(){if(!this.value.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>this.value.getConnectedValue(e).length(),this}}(0,i3.H7)("BABYLON.GeometryLengthBlock",fJ);class f0 extends dz{constructor(e){super(e),this.registerInput("input",i_.Vector2),this.registerInput("angle",i_.Float),this.registerOutput("output",i_.Vector2)}getClassName(){return"GeometryRotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(){if(!this.angle.isConnected||!this.input.isConnected){this.output._storedFunction=null,this.output._storedValue=null;return}return this.output._storedFunction=e=>{let t=this.input.getConnectedValue(e),i=this.angle.getConnectedValue(e);return new i1.FM(Math.cos(i)*t.x-Math.sin(i)*t.y,Math.sin(i)*t.x+Math.cos(i)*t.y)},this}}(0,i3.H7)("BABYLON.GeometryRotate2dBlock",f0);class f1 extends dz{constructor(e){super(e),this.onInterceptionObservable=new i0.y$(void 0,!0),this.registerInput("input",i_.AutoDetect),this.registerOutput("output",i_.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}get buildExecutionTime(){return -1}getClassName(){return"GeometryInterceptorBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);let t=this._outputs[0],i=this._inputs[0];t._storedFunction=e=>{let t=i.getConnectedValue(e);return this.onInterceptionObservable.notifyObservers(t),t}}}(0,i3.H7)("BABYLON.GeometryInterceptorBlock",f1);class f2 extends rP.Kj{get covariancesATexture(){return this._covariancesATexture}get covariancesBTexture(){return this._covariancesBTexture}get centersTexture(){return this._centersTexture}get colorsTexture(){return this._colorsTexture}constructor(e,t=null,i=null,r=!1){super(e,i),this._vertexCount=0,this._worker=null,this._frameIdLastUpdate=-1,this._modelViewMatrix=i1.y3.Identity(),this._canPostToWorker=!0,this._readyToDisplay=!1,this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._splatPositions=null,this._splatIndex=null,this._covariancesA=null,this._covariancesB=null,this._colors=null,this._keepInRam=!1,this._delayedTextureUpdate=null,this._oldDirection=new i1.P;let s=new nK.x;s.positions=[-2,-2,0,2,-2,0,2,2,0,-2,2,0],s.indices=[0,1,2,0,2,3],s.applyToMesh(this),this.subMeshes=[],new lJ.P(0,0,4,0,6,this),this.setEnabled(!1),this._keepInRam=r,t&&this.loadFileAsync(t),this.material=new dm(this.name+"_material",this._scene)}getClassName(){return"GaussianSplattingMesh"}getTotalVertices(){return this._vertexCount}isReady(e=!1){return!!super.isReady(e,!0)&&(!!this._readyToDisplay||(this._postToWorker(!0),!1))}_postToWorker(e=!1){let t=this.getScene().getFrameId();if(t!==this._frameIdLastUpdate&&this._worker&&this._scene.activeCamera&&this._canPostToWorker){let i=this._scene.activeCamera.getViewMatrix();this.getWorldMatrix().multiplyToRef(i,this._modelViewMatrix),i.invertToRef(i1.jp.Matrix[0]),this.getWorldMatrix().multiplyToRef(i1.jp.Matrix[0],i1.jp.Matrix[1]),i1.P.TransformNormalToRef(i1.P.Forward(this._scene.useRightHandedSystem),i1.jp.Matrix[1],i1.jp.Vector3[2]),i1.jp.Vector3[2].normalize();let r=i1.P.Dot(i1.jp.Vector3[2],this._oldDirection);(e||Math.abs(r-1)>=.01)&&(this._oldDirection.copyFrom(i1.jp.Vector3[2]),this._frameIdLastUpdate=t,this._canPostToWorker=!1,this._worker.postMessage({view:this._modelViewMatrix.m,depthMix:this._depthMix,useRightHandedSystem:this._scene.useRightHandedSystem},[this._depthMix.buffer]))}}render(e,t,i){return this._postToWorker(),super.render(e,t,i)}static ConvertPLYToSplat(e){let t=new Uint8Array(e),i=new TextDecoder().decode(t.slice(0,10240)),r="end_header\n",s=i.indexOf(r);if(s<0||!i)return e;let n=parseInt(/element vertex (\d+)\n/.exec(i)[1]),a=0,o={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1},l=[];for(let e of i.slice(0,s).split("\n").filter(e=>e.startsWith("property "))){let[,t,i]=e.split(" ");if(l.push({name:i,type:t,offset:a}),!o[t])return re.Y.Error(`Unsupported property type: ${t}. Are you sure it's a valid Gaussian Splatting file?`),new ArrayBuffer(0);a+=o[t]}let c=new DataView(e,s+r.length),u=new ArrayBuffer(32*n),h=new i1._f;for(let e=0;e<n;e++){let t=new Float32Array(u,32*e,3),i=new Float32Array(u,32*e+12,3),r=new Uint8ClampedArray(u,32*e+24,4),s=new Uint8ClampedArray(u,32*e+28,4),n=255,o=0,d=0,f=0;for(let s=0;s<l.length;s++){let u;let h=l[s];switch(h.type){case"float":u=c.getFloat32(h.offset+e*a,!0);break;case"int":u=c.getInt32(h.offset+e*a,!0);break;default:throw Error(`Unsupported property type: ${h.type}`)}switch(h.name){case"x":t[0]=u;break;case"y":t[1]=u;break;case"z":t[2]=u;break;case"scale_0":i[0]=Math.exp(u);break;case"scale_1":i[1]=Math.exp(u);break;case"scale_2":i[2]=Math.exp(u);break;case"red":r[0]=u;break;case"green":r[1]=u;break;case"blue":r[2]=u;break;case"f_dc_0":r[0]=(.5+.28209479177387814*u)*255;break;case"f_dc_1":r[1]=(.5+.28209479177387814*u)*255;break;case"f_dc_2":r[2]=(.5+.28209479177387814*u)*255;break;case"f_dc_3":r[3]=(.5+.28209479177387814*u)*255;break;case"opacity":r[3]=1/(1+Math.exp(-u))*255;break;case"rot_0":n=u;break;case"rot_1":o=u;break;case"rot_2":d=u;break;case"rot_3":f=u}}h.set(o,d,f,n),h.normalize(),s[0]=128*h.w+128,s[1]=128*h.x+128,s[2]=128*h.y+128,s[3]=128*h.z+128}return u}loadDataAsync(e){return Promise.resolve(this._loadData(e))}loadFileAsync(e){return rD.w1.LoadFileAsync(e,!0).then(e=>{this._loadData(f2.ConvertPLYToSplat(e))})}dispose(e){this._covariancesATexture?.dispose(),this._covariancesBTexture?.dispose(),this._centersTexture?.dispose(),this._colorsTexture?.dispose(),this._covariancesATexture=null,this._covariancesBTexture=null,this._centersTexture=null,this._colorsTexture=null,this._worker?.terminate(),this._worker=null,super.dispose(e,!0)}_copyTextures(e){this._covariancesATexture=e.covariancesATexture?.clone(),this._covariancesBTexture=e.covariancesBTexture?.clone(),this._centersTexture=e.centersTexture?.clone(),this._colorsTexture=e.colorsTexture?.clone()}clone(e=""){let t=new f2(e,void 0,this.getScene());t._copySource(this),t.makeGeometryUnique(),t._vertexCount=this._vertexCount,t._copyTextures(this),t._modelViewMatrix=i1.y3.Identity(),t._splatPositions=this._splatPositions,t._readyToDisplay=!1,t._instanciateWorker();let i=this.getBoundingInfo();return t.getBoundingInfo().reConstruct(i.minimum,i.maximum,this.getWorldMatrix()),t.forcedInstanceCount=t._vertexCount,t.setEnabled(!0),t}updateData(e){if(!e.byteLength)return;this._covariancesATexture||(this._readyToDisplay=!1);let t=new Uint8Array(e),i=new Float32Array(t.buffer),r=t.length/32;r!=this._vertexCount&&this._updateSplatIndexBuffer(r),this._vertexCount=r;let s=this._getTextureSize(r),n=s.x*s.y;this._splatPositions=new Float32Array(3*n);let a=new Float32Array(3*n),o=new Float32Array(3*n),l=i1.jp.Matrix[0],c=i1.jp.Matrix[1],u=i1.jp.Quaternion[0],h=new i1.P(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),d=new i1.P(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let e=0;e<r;e++){let r=i[8*e+0],s=-i[8*e+1],n=i[8*e+2];this._splatPositions[3*e+0]=r,this._splatPositions[3*e+1]=s,this._splatPositions[3*e+2]=n,h.minimizeInPlaceFromFloats(r,s,n),d.maximizeInPlaceFromFloats(r,s,n),u.set((t[32*e+28+1]-128)/128,(t[32*e+28+2]-128)/128,(t[32*e+28+3]-128)/128,-(t[32*e+28+0]-128)/128),u.toRotationMatrix(l),i1.y3.ScalingToRef(2*i[8*e+3+0],2*i[8*e+3+1],2*i[8*e+3+2],c);let f=l.multiplyToRef(c,i1.jp.Matrix[0]).m;a[3*e+0]=f[0]*f[0]+f[1]*f[1]+f[2]*f[2],a[3*e+1]=f[0]*f[4]+f[1]*f[5]+f[2]*f[6],a[3*e+2]=f[0]*f[8]+f[1]*f[9]+f[2]*f[10],o[3*e+0]=f[4]*f[4]+f[5]*f[5]+f[6]*f[6],o[3*e+1]=f[4]*f[8]+f[5]*f[9]+f[6]*f[10],o[3*e+2]=f[8]*f[8]+f[9]*f[9]+f[10]*f[10]}this.getBoundingInfo().reConstruct(h,d,this.getWorldMatrix()),this.setEnabled(!0);let f=(e,t,i,r)=>new rK.l(e,t,i,r,this._scene,!1,!1,2,1),p=e=>{let t=e.length/3,i=new Float32Array(4*t);for(let r=0;r<t;++r)i[4*r+0]=e[3*r+0],i[4*r+1]=e[3*r+1],i[4*r+2]=e[3*r+2],i[4*r+3]=1;return i},m=new Float32Array(s.x*s.y*4);for(let e=0;e<this._vertexCount;++e)m[4*e+0]=t[32*e+24+0]/255,m[4*e+1]=t[32*e+24+1]/255,m[4*e+2]=t[32*e+24+2]/255,m[4*e+3]=t[32*e+24+3]/255;if(this._keepInRam&&(this._covariancesA=a,this._covariancesB=o,this._colors=m),this._covariancesATexture){this._delayedTextureUpdate={covA:p(a),covB:p(o),colors:m,centers:p(this._splatPositions)};let e=Float32Array.from(this._splatPositions),t=this._vertexCount;this._worker.postMessage({positions:e,vertexCount:t},[e.buffer]),this._postToWorker(!0)}else this._covariancesATexture=f(p(a),s.x,s.y,5),this._covariancesBTexture=f(p(o),s.x,s.y,5),this._centersTexture=f(p(this._splatPositions),s.x,s.y,5),this._colorsTexture=f(m,s.x,s.y,5),this._instanciateWorker()}_loadData(e){e.byteLength&&this.updateData(e)}_updateSplatIndexBuffer(e){(!this._splatIndex||e>this._splatIndex.length)&&(this._splatIndex=new Float32Array(e),this.thinInstanceSetBuffer("splatIndex",this._splatIndex,1,!1)),this.forcedInstanceCount=e}_instanciateWorker(){if(!this._vertexCount)return;this._updateSplatIndexBuffer(this._vertexCount),this._worker?.terminate(),this._worker=new Worker(URL.createObjectURL(new Blob(["(",f2._CreateWorker.toString(),")(self)"],{type:"application/javascript"}))),this._depthMix=new BigInt64Array(this._vertexCount);let e=Float32Array.from(this._splatPositions),t=this._vertexCount;this._worker.postMessage({positions:e,vertexCount:t},[e.buffer]),this._worker.onmessage=e=>{this._depthMix=e.data.depthMix;let i=new Uint32Array(e.data.depthMix.buffer);if(this._splatIndex)for(let e=0;e<this._vertexCount;e++)this._splatIndex[e]=i[2*e];if(this._delayedTextureUpdate){let e=(e,t,i,r)=>{this.getEngine().updateTextureData(e.getInternalTexture(),t,0,0,i,r,0,0,!1)},i=this._getTextureSize(t);e(this._covariancesATexture,this._delayedTextureUpdate.covA,i.x,i.y),e(this._covariancesBTexture,this._delayedTextureUpdate.covB,i.x,i.y),e(this._centersTexture,this._delayedTextureUpdate.centers,i.x,i.y),e(this._colorsTexture,this._delayedTextureUpdate.colors,i.x,i.y),this._delayedTextureUpdate=null}this.thinInstanceBufferUpdated("splatIndex"),this._canPostToWorker=!0,this._readyToDisplay=!0}}_getTextureSize(e){let t=this._scene.getEngine(),i=t.getCaps().maxTextureSize,r=1;if(1!==t.version||t.isWebGPU)r=Math.ceil(e/i);else for(;i*r<e;)r*=2;return r>i&&(re.Y.Error("GaussianSplatting texture size: ("+i+", "+r+"), maxTextureSize: "+i),r=i),new i1.FM(i,r)}}f2._CreateWorker=function(e){let t,i,r,s,n=0;e.onmessage=a=>{if(a.data.positions)t=a.data.positions,n=a.data.vertexCount;else{let o=a.data.view;if(!t||!o)throw Error("positions or view is not defined!");r=new Uint32Array((i=a.data.depthMix).buffer),s=new Float32Array(i.buffer);for(let e=0;e<n;e++)r[2*e]=e;let l=-1;a.data.useRightHandedSystem&&(l=1);for(let e=0;e<n;e++)s[2*e+1]=1e4+(o[2]*t[3*e+0]+o[6]*t[3*e+1]+o[10]*t[3*e+2])*l;i.sort(),e.postMessage({depthMix:i},[i.buffer])}}},i(65691),i(92030),i(65602),i(27498),i(91118),i(8022),i(25972),i(49111),i(56865),i(96289),i(32400),i(51372),i(69364),i(38547);var f3=i(98029);rV.a.OfflineProviderFactory=(e,t,i=!1)=>new f4(e,t,i);class f4{get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}constructor(e,t,i=!1){this._idbFactory="undefined"!=typeof indexedDB?indexedDB:void 0,this._currentSceneUrl=f4._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,f4.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,rD.w1.SetImmediate(()=>{t(!0)})):this._checkManifestFile(t):t(!0)}_checkManifestFile(e){let t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if("function"==typeof URL&&0===this._currentSceneUrl.indexOf("http")){let e=new URL(this._currentSceneUrl);return e.pathname+=".manifest",e.toString()}}catch(e){}return`${this._currentSceneUrl}.manifest`},r=!1,s=i(),n=new lk.g;navigator.onLine&&(r=!0,s=s+(null==s.match(/\?/)?"?":"&")+Date.now()),n.open("GET",s),n.addEventListener("load",()=>{if(200===n.status||f4._ValidateXHRData(n,1))try{let t=JSON.parse(n.response);this._enableSceneOffline=t.enableSceneOffline,this._enableTexturesOffline=t.enableTexturesOffline&&f4._IsUASupportingBlobStorage,t.version&&!isNaN(parseInt(t.version))&&(this._manifestVersionFound=t.version),e(!0)}catch(e){t()}else t()},!1),n.addEventListener("error",()=>{if(r){r=!1;let e=i();n.open("GET",e),n.send()}else t()},!1);try{n.send()}catch(t){re.Y.Error("Error on XHR send request."),e(!1)}}open(e,t){let i=()=>{this._isSupported=!1,t&&t()};if(this._idbFactory&&(this._enableSceneOffline||this._enableTexturesOffline)){if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;let t=this._idbFactory.open("babylonjs",1);t.onerror=()=>{i()},t.onblocked=()=>{re.Y.Error("IDB request blocked. Please reload the page."),i()},t.onsuccess=()=>{this._db=t.result,e()},t.onupgradeneeded=e=>{if(this._db=e.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(e){re.Y.Error("Error while creating object stores. Exception: "+e.message),i()}}}}else this._isSupported=!1,t&&t()}loadImage(e,t){let i=f4._ReturnFullUrlLocation(e),r=()=>{this._hasReachedQuota||null===this._db?t.src=e:this._saveImageIntoDBAsync(i,t)};this._mustUpdateRessources?r():this._loadImageFromDBAsync(i,t,r)}_loadImageFromDBAsync(e,t,i){if(this._isSupported&&null!==this._db){let r;let s=this._db.transaction(["textures"]);s.onabort=()=>{t.src=e},s.oncomplete=()=>{let s;r&&"function"==typeof URL?(s=URL.createObjectURL(r.data),t.onerror=()=>{re.Y.Error("Error loading image from blob URL: "+s+" switching back to web url: "+e),t.src=e},t.src=s):i()};let n=s.objectStore("textures").get(e);n.onsuccess=e=>{r=e.target.result},n.onerror=()=>{re.Y.Error("Error loading texture "+e+" from DB."),t.src=e}}else re.Y.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDBAsync(e,t){let i;if(this._isSupported){let r=()=>{let e;if(i&&"function"==typeof URL)try{e=URL.createObjectURL(i)}catch(t){e=URL.createObjectURL(i)}e&&(t.src=e)};if(f4._IsUASupportingBlobStorage){let s=new lk.g;s.open("GET",e),s.responseType="blob",s.addEventListener("load",()=>{if(200===s.status&&this._db){i=s.response;let n=this._db.transaction(["textures"],"readwrite");n.onabort=e=>{try{let t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}r()},n.oncomplete=()=>{r()};let a={textureUrl:e,data:i};try{let e=n.objectStore("textures").put(a);e.onsuccess=()=>{},e.onerror=()=>{r()}}catch(i){25===i.code&&(f4._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e},!1),s.addEventListener("error",()=>{re.Y.Error("Error in XHR request in BABYLON.Database."),t.src=e},!1),s.send()}else t.src=e}else re.Y.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){this._loadVersionFromDBAsync(e,t,()=>{this._saveVersionIntoDBAsync(e,t)})}_loadVersionFromDBAsync(e,t,i){if(this._isSupported&&this._db){let r;try{let s=this._db.transaction(["versions"]);s.oncomplete=()=>{r?this._manifestVersionFound!==r.data?(this._mustUpdateRessources=!0,i()):t(r.data):(this._mustUpdateRessources=!0,i())},s.onabort=()=>{t(-1)};let n=s.objectStore("versions").get(e);n.onsuccess=e=>{r=e.target.result},n.onerror=()=>{re.Y.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(e){re.Y.Error("Error while accessing 'versions' object store (READ OP). Exception: "+e.message),t(-1)}}else re.Y.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDBAsync(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{let i=this._db.transaction(["versions"],"readwrite");i.onabort=e=>{try{let t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};let r={sceneUrl:e,data:this._manifestVersionFound},s=i.objectStore("versions").put(r);s.onsuccess=()=>{},s.onerror=()=>{re.Y.Error("Error in DB add version request in BABYLON.Database.")}}catch(e){re.Y.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+e.message),t(-1)}else t(-1)}loadFile(e,t,i,r,s){let n=f4._ReturnFullUrlLocation(e),a=()=>{this._saveFileAsync(n,t,i,s,r)};this._checkVersionFromDB(n,e=>{-1!==e?this._mustUpdateRessources?this._saveFileAsync(n,t,i,s,r):this._loadFileAsync(n,t,a,i):r&&r()})}_loadFileAsync(e,t,i,r){if(this._isSupported&&this._db){let s,n;s=-1!==e.indexOf(".babylon")?"scenes":"textures";let a=this._db.transaction([s]);a.oncomplete=()=>{if(n){if(r){let e=n.data?.byteLength||0;r({total:e,loaded:e,lengthComputable:!0})}t(n.data)}else i()},a.onabort=()=>{i()};let o=a.objectStore(s).get(e);o.onsuccess=e=>{n=e.target.result},o.onerror=()=>{re.Y.Error("Error loading file "+e+" from DB."),i()}}else re.Y.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFileAsync(e,t,i,r,s){if(this._isSupported){let n,a;n=-1!==e.indexOf(".babylon")?"scenes":"textures";let o=new lk.g;o.open("GET",e+(null==e.match(/\?/)?"?":"&")+Date.now()),r&&(o.responseType="arraybuffer"),i&&(o.onprogress=i),o.addEventListener("load",()=>{if(200===o.status||o.status<400&&f4._ValidateXHRData(o,r?6:1)){if(a=r?o.response:o.responseText,!this._hasReachedQuota&&this._db){let i;let r=this._db.transaction([n],"readwrite");r.onabort=e=>{try{let t=e.target.error;t&&"QuotaExceededError"===t.name&&(this._hasReachedQuota=!0)}catch(e){}t(a)},r.oncomplete=()=>{t(a)},i="scenes"===n?{sceneUrl:e,data:a,version:this._manifestVersionFound}:{textureUrl:e,data:a};try{let e=r.objectStore(n).put(i);e.onsuccess=()=>{},e.onerror=()=>{re.Y.Error("Error in DB add file request in BABYLON.Database.")}}catch(e){t(a)}}else t(a)}else o.status>=400&&s?s(o):t()},!1),o.addEventListener("error",()=>{re.Y.Error("error on XHR request."),s&&s()},!1),o.send()}else re.Y.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),s&&s()}static _ValidateXHRData(e,t=7){try{if(1&t){if(e.responseText&&e.responseText.length>0)return!0;if(1===t)return!1}if(2&t){let i=(0,f3.A6)(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(2===t)return!1}if(4&t){let t=new Uint8Array(e.response,0,3);if(68===t[0]&&68===t[1]&&83===t[2])return!0}}catch(e){}return!1}}f4._IsUASupportingBlobStorage=!0,f4.IDBStorageEnabled=!1,f4._ParseURL=e=>{document.createElement("a").href=e;let t=e.substring(0,e.lastIndexOf("#")),i=e.substring(t.lastIndexOf("/")+1,e.length);return e.substring(0,e.indexOf(i,0))},f4._ReturnFullUrlLocation=e=>-1===e.indexOf("http:/")&&-1===e.indexOf("https:/")&&"undefined"!=typeof window?f4._ParseURL(window.location.href)+e:e;var f5=i(92539);i(39500),i(75890),i(44062),i(1871),i(46715);var f7=i(21398);i(25425);class f6{_isUbo(e){return void 0!==e.addUniform}constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}}let f8=`#version 300 es
void main() {discard;}
`;sG.v.ShadersStore.gpuUpdateParticlesPixelShader=f8;let f9=`#version 300 es
#define PI 3.14159
uniform float currentCount;uniform float timeDelta;uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;uniform vec2 emitPower;uniform vec2 sizeRange;uniform vec4 scaleRange;
#ifndef COLORGRADIENTS
uniform vec4 color1;uniform vec4 color2;
#endif
uniform vec3 gravity;uniform sampler2D randomSampler;uniform sampler2D randomSampler2;uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;uniform vec3 direction2;uniform vec3 minEmitBox;uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;uniform float radiusRange;uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;uniform float height;uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;uniform float coneAngle;uniform vec2 height;
#ifdef DIRECTEDCONEEMITTER
uniform vec3 direction1;uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;in float life;in vec4 seed;in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;in vec3 noiseCoordinates2;
#endif
out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;out float outLife;out vec4 outSeed;out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif 
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec4 cellInfos;
#endif
vec3 getRandomVec3(float offset) {return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;}
vec4 getRandomVec4(float offset) {return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));}
void main() {float newAge=age+timeDelta; 
if (newAge>=life && stopFactor != 0.) {vec3 newPosition;vec3 newDirection;vec4 randoms=getRandomVec4(seed.x);outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;outAge=newAge-life;outSeed=seed;
#ifdef SIZEGRADIENTS 
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; 
#ifndef COLORGRADIENTS
outColor=color1+(color2-color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif 
#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=vec3(0,0,0);newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;newDirection=direction1+(direction2-direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);newDirection=newPosition+directionRandomizer*randoms3; 
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float phi=2.0*PI*randoms2.x;float theta=acos(2.0*randoms2.y-1.0);float randX=cos(phi)*sin(theta);float randY=cos(theta);float randZ=sin(phi)*sin(theta);newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(direction1+(direction2-direction1)*randoms3);
#else
newDirection=normalize(newPosition+directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);vec3 randoms3=getRandomVec3(seed.z);float yPos=(randoms2.x-0.5)*height;float angle=randoms2.y*PI*2.;float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));float xPos=positionRadius*cos(angle);float zPos=positionRadius*sin(angle);newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
angle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;h=1.-h*h; 
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;lRadius=lRadius*h;float randX=lRadius*sin(s);float randZ=lRadius*cos(s);float randY=h *height.x;newPosition=vec3(randX,randY,randZ); 
vec3 randoms3=getRandomVec3(seed.z);
#ifdef DIRECTEDCONEEMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
if (abs(cos(coneAngle))==1.0) {newDirection=vec3(0.,1.0,0.);} else {newDirection=normalize(newPosition+directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;outInitialPosition=initialPosition;
#else 
newPosition=vec3(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD 
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else 
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD 
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {float directionScale=timeDelta;outAge=newAge;float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient; 
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;outSeed=seed;
#ifndef COLORGRADIENTS 
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;outSize.yz=size.yz;
#else
outSize=size;
#endif 
#ifndef BILLBOARD 
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;float currentVelocity=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*limitVelocityDamping;}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;outDirection=outDirection+force*timeDelta;outNoiseCoordinates1=noiseCoordinates1;outNoiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
float offsetAge=outAge;float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif 
float ratio=0.;if (cellInfos.w==1.0) {ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);}
else {ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);}
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}}`;sG.v.ShadersStore.gpuUpdateParticlesVertexShader=f9;class pe{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}contextLost(){this._updateEffect=void 0,this._renderVAO.length=0,this._updateVAO.length=0}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){return this._updateEffect?.isReady()??!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof f7.E&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new n1.Q("gpuUpdateParticles",this._updateEffectOptions,this._engine),new f6(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null),this._renderVertexBuffers=t}createParticleBuffer(e){return e}bindDrawBuffers(e,t,i){i?this._engine.bindBuffers(this._renderVertexBuffers,i,t):this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){let e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);let r=this._engine;r.bindTransformFeedbackBuffer(t.getBuffer()),r.setRasterizerState(!1),r.beginTransformFeedback(!0),r.drawArraysType(3,0,i),r.endTransformFeedback(),r.setRasterizerState(!0),r.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){let t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof f7.E&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));let r=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),r}}(0,i3.H7)("BABYLON.WebGL2ParticleSystem",pe);let pt=`struct Particle {position : vec3<f32>,
age : f32,
size : vec3<f32>,
life : f32,
seed : vec4<f32>,
direction : vec3<f32>,
dummy0: f32,
#ifdef CUSTOMEMITTER
initialPosition : vec3<f32>,
dummy1: f32,
#endif
#ifndef COLORGRADIENTS
color : vec4<f32>,
#endif
#ifndef BILLBOARD
initialDirection : vec3<f32>,
dummy2: f32,
#endif
#ifdef NOISE
noiseCoordinates1 : vec3<f32>,
dummy3: f32,
noiseCoordinates2 : vec3<f32>,
dummy4: f32,
#endif
#ifdef ANGULARSPEEDGRADIENTS
angle : f32,
#else
angle : vec2<f32>,
#endif
#ifdef ANIMATESHEET
cellIndex : f32,
#ifdef ANIMATESHEETRANDOMSTART
cellStartOffset : f32,
#endif
#endif
};struct Particles {particles : array<Particle>,};struct SimParams {currentCount : f32,
timeDelta : f32,
stopFactor : f32,
randomTextureSize: i32,
lifeTime : vec2<f32>,
emitPower : vec2<f32>,
#ifndef COLORGRADIENTS
color1 : vec4<f32>,
color2 : vec4<f32>,
#endif
sizeRange : vec2<f32>,
scaleRange : vec4<f32>,
angleRange : vec4<f32>,
gravity : vec3<f32>,
#ifdef LIMITVELOCITYGRADIENTS
limitVelocityDamping : f32,
#endif
#ifdef ANIMATESHEET
cellInfos : vec4<f32>,
#endif
#ifdef NOISE
noiseStrength : vec3<f32>,
#endif
#ifndef LOCAL
emitterWM : mat4x4<f32>,
#endif
#ifdef BOXEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
minEmitBox : vec3<f32>,
maxEmitBox : vec3<f32>,
#endif
#ifdef CONEEMITTER
radius : vec2<f32>,
coneAngle : f32,
height : vec2<f32>,
#ifdef DIRECTEDCONEEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef CYLINDEREMITTER
radius : f32,
height : f32,
radiusRange : f32,
#ifdef DIRECTEDCYLINDEREMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef HEMISPHERICEMITTER
radius : f32,
radiusRange : f32,
directionRandomizer : f32,
#endif
#ifdef POINTEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#endif
#ifdef SPHEREEMITTER
radius : f32,
radiusRange : f32,
#ifdef DIRECTEDSPHEREEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
};@binding(0) @group(0) var<uniform> params : SimParams;@binding(1) @group(0) var<storage,read> particlesIn : Particles;@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;@binding(3) @group(0) var randomTexture : texture_2d<f32>;@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;
#ifdef SIZEGRADIENTS
@binding(0) @group(1) var sizeGradientSampler : sampler;@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
@binding(2) @group(1) var angularSpeedGradientSampler : sampler;@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;
#endif 
#ifdef VELOCITYGRADIENTS
@binding(4) @group(1) var velocityGradientSampler : sampler;@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;
#endif
#ifdef LIMITVELOCITYGRADIENTS
@binding(6) @group(1) var limitVelocityGradientSampler : sampler;@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;
#endif
#ifdef DRAGGRADIENTS
@binding(8) @group(1) var dragGradientSampler : sampler;@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;
#endif
#ifdef NOISE
@binding(10) @group(1) var noiseSampler : sampler;@binding(11) @group(1) var noiseTexture : texture_2d<f32>;
#endif
fn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;}
fn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);}
@compute @workgroup_size(64)
fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {let index : u32=GlobalInvocationID.x;let vertexID : f32=f32(index);if (index>=u32(params.currentCount)) {return;}
let PI : f32=3.14159;let timeDelta : f32=params.timeDelta;let newAge : f32=particlesIn.particles[index].age+timeDelta;let life : f32=particlesIn.particles[index].life;let seed : vec4<f32>=particlesIn.particles[index].seed;let direction : vec3<f32>=particlesIn.particles[index].direction;if (newAge>=life && params.stopFactor != 0.) {var newPosition : vec3<f32>;var newDirection : vec3<f32>;let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;particlesOut.particles[index].life=outLife;particlesOut.particles[index].age=newAge-life;particlesOut.particles[index].seed=seed;var sizex : f32;
#ifdef SIZEGRADIENTS 
sizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;
#else
sizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;
#endif
particlesOut.particles[index].size=vec3<f32>(
sizex,
params.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,
params.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);
#ifndef COLORGRADIENTS
particlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
particlesOut.particles[index].angle=vec2<f32>(
params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,
params.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);
#else
particlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;
#endif 
#if defined(POINTEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=vec3<f32>(0.,0.,0.);newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#elif defined(BOXEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#elif defined(SPHEREEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let phi : f32=2.0*PI*randoms2.x;let theta : f32=acos(-1.0+2.0*randoms2.y);let randX : f32=cos(phi)*sin(theta);let randY : f32=cos(theta);let randZ : f32=sin(phi)*sin(theta);newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);
#else
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);let yPos : f32=(-0.5+randoms2.x)*params.height;var angle : f32=randoms2.y*PI*2.;let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));let xPos : f32=positionRadius*cos(angle);let zPos : f32=positionRadius*sin(angle);newPosition=vec3<f32>(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
angle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);let s : f32=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
let h : f32=0.0001;
#else
var h : f32=randoms2.y*params.height.y;h=1.-h*h; 
#endif
var lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;lRadius=lRadius*h;let randX : f32=lRadius*sin(s);let randZ : f32=lRadius*cos(s);let randY : f32=h *params.height.x;newPosition=vec3<f32>(randX,randY,randZ); 
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
#ifdef DIRECTEDCONEEMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
if (abs(cos(params.coneAngle))==1.0) {newDirection=vec3<f32>(0.,1.0,0.);} else {newDirection=normalize(newPosition+params.directionRandomizer*randoms3); }
#endif
#elif defined(CUSTOMEMITTER)
newPosition=particlesIn.particles[index].initialPosition;particlesOut.particles[index].initialPosition=newPosition;
#else 
newPosition=vec3<f32>(0.,0.,0.);newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));
#endif
let power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;
#ifdef LOCAL
particlesOut.particles[index].position=newPosition;
#else
particlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=direction;
#endif
#else
#ifdef LOCAL
let initial : vec3<f32>=newDirection;
#else 
let initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;
#endif
particlesOut.particles[index].direction=initial*power;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
particlesOut.particles[index].cellIndex=params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
particlesOut.particles[index].cellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
particlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;
#endif
} else {var directionScale : f32=timeDelta;particlesOut.particles[index].age=newAge;let ageGradient : f32=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
#endif
#ifdef DRAGGRADIENTS
directionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);
#endif
let position : vec3<f32>=particlesIn.particles[index].position;
#if defined(CUSTOMEMITTER)
particlesOut.particles[index].position=position+(direction-position)*ageGradient; 
particlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;
#else
particlesOut.particles[index].position=position+direction*directionScale;
#endif
particlesOut.particles[index].life=life;particlesOut.particles[index].seed=seed;
#ifndef COLORGRADIENTS 
particlesOut.particles[index].color=particlesIn.particles[index].color;
#endif
#ifdef SIZEGRADIENTS
particlesOut.particles[index].size=vec3<f32>(
textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,
particlesIn.particles[index].size.yz);
#else
particlesOut.particles[index].size=particlesIn.particles[index].size;
#endif 
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#else
var updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
let limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;let currentVelocity : f32=length(updatedDirection);if (currentVelocity>limitVelocity) {updatedDirection=updatedDirection*params.limitVelocityDamping;}
#endif
particlesOut.particles[index].direction=updatedDirection;
#ifdef NOISE
let noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
let angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;
#else
let angle : vec2<f32>=particlesIn.particles[index].angle;particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
var offsetAge : f32=particlesOut.particles[index].age;let dist : f32=params.cellInfos.y-params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
let cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;particlesOut.particles[index].cellStartOffset=cellStartOffset;offsetAge=offsetAge+cellStartOffset;
#else
let cellStartOffset : f32=0.;
#endif 
var ratio : f32;if (params.cellInfos.w==1.0) {ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);}
else {ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);}
particlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));
#endif
}}
`;sG.v.ShadersStoreWGSL.gpuUpdateParticlesComputeShader=pt;class pi{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}contextLost(){this._updateComputeShader=void 0,this._bufferComputeShader.length=0,this._renderVertexBuffers.length=0}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){return this._updateComputeShader?.isReady()??!1}createUpdateBuffer(e){let t={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(t.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(t.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(t.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(t.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(t.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(t.noiseTexture={group:1,binding:11}),this._updateComputeShader=new nF.U("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:t,defines:e.split("\n")}),this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=new s1.M(this._engine,void 0,void 0,"ComputeShaderParticleSystemUBO"),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new f6(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){let t=new sr.N(this._engine,4*e.length,11,"ComputeShaderParticleSystemBuffer");return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t,i){this._engine.bindBuffers(this._renderVertexBuffers[e],i,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[1^e]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){for(let e=0;e<this._bufferComputeShader.length;++e)this._bufferComputeShader[e].dispose();this._bufferComputeShader.length=0,this._simParamsComputeShader?.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}(0,i3.H7)("BABYLON.ComputeShaderParticleSystem",pi);var pr=i(31944),ps=i(7312);let pn=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;sG.v.IncludesShadersStore.clipPlaneFragmentDeclaration2=pn;let pa=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;varying vec2 vUV;varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#include<fogFragmentDeclaration>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#include<fogFragment>(color,gl_FragColor)
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;sG.v.ShadersStore.gpuRenderParticlesPixelShader=pa;let po=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;out float fClipDistance6;
#endif
`;sG.v.IncludesShadersStore.clipPlaneVertexDeclaration2=po;let pl=`precision highp float;uniform mat4 view;uniform mat4 projection;uniform vec2 translationPivot;uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;attribute float age;attribute float life;attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;attribute vec2 uv;varying vec2 vUV;varying vec4 vColor;varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<fogVertexDeclaration>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));vec3 zaxis=normalize(cross(yaxis,xaxis));vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {vec3 normalizedToCamera=normalize(toCamera);vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);mat3 rotMatrix= mat3(row0,row1,row2);vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);float columnOffset=cellIndex-rowOffset*sheetInfos.z;vec2 uvScale=sheetInfos.xy;vec2 uvOffset=vec2(uv.x ,1.0-uv.y);vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=min(1.0,age/life);
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x;
#ifdef BILLBOARD
vec4 rotatedCorner;rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.y=0.;rotatedCorner.xz+=translationPivot;vec3 yaxis=(position+worldOffset)-eyePosition;yaxis.y=0.;vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;vec3 toCamera=(position+worldOffset)-eyePosition;vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.z=0.;rotatedCorner.xy+=translationPivot;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);rotatedCorner.y=0.;rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);rotatedCorner.xz+=translationPivot;vec3 yaxis=normalize(initialDirection);vPositionW=rotate(yaxis,rotatedCorner);vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6) || defined(FOG)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<logDepthVertex>
}`;sG.v.ShadersStore.gpuRenderParticlesVertexShader=pl;var pc=i(42818);class pu extends lY.U{static get IsSupported(){if(!rh.l.LastCreatedEngine)return!1;let e=rh.l.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}_createIndexBuffer(){this._linesIndexBufferUseInstancing=this._engine.createIndexBuffer(new Uint32Array([0,1,1,3,3,2,2,0,0,3]),void 0,"GPUParticleSystemLinesIndexBuffer")}getCapacity(){return this._capacity}get maxActiveParticleCount(){return this._maxActiveParticleCount}set maxActiveParticleCount(e){this._maxActiveParticleCount=Math.min(e,this._capacity)}get activeParticleCount(){return this.maxActiveParticleCount}set activeParticleCount(e){this.maxActiveParticleCount=e}createPointEmitter(e,t){let i=(0,pc.Ei)(e,t);return this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){let i=(0,pc.Sc)(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){let i=(0,pc.qx)(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new i1.P(0,1,0),i=new i1.P(0,1,0)){let r=(0,pc.zg)(e,t,i);return this.particleEmitterType=r,r}createCylinderEmitter(e=1,t=1,i=1,r=0){let s=(0,pc.FC)(e,t,i,r);return this.particleEmitterType=s,s}createDirectedCylinderEmitter(e=1,t=1,i=1,r=new i1.P(0,1,0),s=new i1.P(0,1,0)){let n=(0,pc.OV)(e,t,i,r,s);return this.particleEmitterType=n,n}createConeEmitter(e=1,t=Math.PI/4){let i=(0,pc.Xb)(e,t);return this.particleEmitterType=i,i}createDirectedConeEmitter(e=1,t=Math.PI/4,i=new i1.P(0,1,0),r=new i1.P(0,1,0)){let s=(0,pc.UJ)(e,t,i,r);return this.particleEmitterType=s,s}createBoxEmitter(e,t,i,r){let s=new f5.S;return this.particleEmitterType=s,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=r,s}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady()||this._rebuildingAfterContextLost)return!1;if(this.blendMode!==ps.p.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(ps.p.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(ps.p.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){return this._customWrappers[e]?.effect??this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){return this._customWrappers[e]??this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new cu.q(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new i0.y$),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}get vertexBuffers(){return this._renderVertexBuffers[1^this._targetIndex]}get indexBuffer(){return null}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);let i=new pr.bK(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){for(let e in this._drawWrappers){let t=this._drawWrappers[e];t.drawContext?.reset()}}_addFactorGradient(e,t,i){let r=new pr.b3(t,i);e.push(r),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){e&&(i&&e.sort((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0),this[t]&&(this[t].dispose(),this[t]=null))}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}constructor(e,t,i,r=null,s=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._renderVertexBuffers=[],this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this.updateInAnimate=!1,this._actualFrame=0,this._rawTextureWidth=256,this._rebuildingAfterContextLost=!1,this.onDisposeObservable=new i0.y$,this.onStoppedObservable=new i0.y$,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this.isGPU=!0,this._onBeforeDrawParticlesObservable=null,i&&"Scene"!==i.getClassName()?(this._engine=i,this.defaultProjectionMatrix=i1.y3.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)):(this._scene=i||rh.l.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)),this._engine.getCaps().supportComputeShaders){if(!(0,i3.qw)("BABYLON.ComputeShaderParticleSystem"))throw Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,i3.qw)("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!(0,i3.qw)("BABYLON.WebGL2ParticleSystem"))throw Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new((0,i3.qw)("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new cu.q(this._engine)},this._customWrappers[0].effect=r,this._drawWrappers={0:new cu.q(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._createIndexBuffer(),this._attachImageProcessingConfiguration(null),(t=t??{}).randomTextureSize||delete t.randomTextureSize;let n={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...t},a=t;isFinite(a)&&(n.capacity=a),this._capacity=n.capacity,this._maxActiveParticleCount=n.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=s,this.particleEmitterType=new f5.S;let o=Math.min(this._engine.getCaps().maxTextureSize,n.randomTextureSize),l=[];for(let e=0;e<o;++e)l.push(Math.random()),l.push(Math.random()),l.push(Math.random()),l.push(Math.random());this._randomTexture=new rK.l(new Float32Array(l),o,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,l=[];for(let e=0;e<o;++e)l.push(Math.random()),l.push(Math.random()),l.push(Math.random()),l.push(Math.random());this._randomTexture2=new rK.l(new Float32Array(l),o,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=o}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){let r={};r.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let s=3;r.age=t.createVertexBuffer("age",s,1,this._attributesStrideSize,!0),s+=1,r.size=t.createVertexBuffer("size",s,3,this._attributesStrideSize,!0),s+=3,r.life=t.createVertexBuffer("life",s,1,this._attributesStrideSize,!0),s+=5,this.billboardMode===ps.p.BILLBOARDMODE_STRETCHED&&(r.direction=t.createVertexBuffer("direction",s,3,this._attributesStrideSize,!0)),s+=3,this._platform.alignDataInBuffer&&(s+=1),this.particleEmitterType instanceof f7.E&&(s+=3,this._platform.alignDataInBuffer&&(s+=1)),this._colorGradientsTexture||(r.color=t.createVertexBuffer("color",s,4,this._attributesStrideSize,!0),s+=4),!this._isBillboardBased&&(r.initialDirection=t.createVertexBuffer("initialDirection",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),this.noiseTexture&&(r.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1),r.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",s,3,this._attributesStrideSize,!0),s+=3,this._platform.alignDataInBuffer&&(s+=1)),r.angle=t.createVertexBuffer("angle",s,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?s++:s+=2,this._isAnimationSheetEnabled&&(r.cellIndex=t.createVertexBuffer("cellIndex",s,1,this._attributesStrideSize,!0),s+=1,this.spriteRandomStartCell&&(r.cellStartOffset=t.createVertexBuffer("cellStartOffset",s,1,this._attributesStrideSize,!0),s+=1)),r.offset=i.createVertexBuffer("offset",0,2),r.uv=i.createVertexBuffer("uv",2,2),this._renderVertexBuffers.push(r),this._platform.createVertexBuffers(e,r),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;let t=this._engine,i=[];this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof f7.E&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),!this.isBillboardBased&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));let r=this.particleEmitterType instanceof f7.E,s=i1.jp.Vector3[0],n=0;for(let e=0;e<this._capacity;e++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),r?(this.particleEmitterType.particleDestinationGenerator(e,null,s),i.push(s.x),i.push(s.y),i.push(s.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),n+=16,r&&(this.particleEmitterType.particlePositionGenerator(e,null,s),i.push(s.x),i.push(s.y),i.push(s.z),this._platform.alignDataInBuffer&&i.push(0),n+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),n+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),n+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),n+=8),i.push(0),n+=1,this._angularSpeedGradientsTexture||(i.push(0),n+=1),this._isAnimationSheetEnabled&&(i.push(0),n+=1,this.spriteRandomStartCell&&(i.push(0),n+=1)),this._platform.alignDataInBuffer){let e=3-(n+3&3);for(n+=e;e-- >0;)i.push(0)}let a=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),o=this._platform.createParticleBuffer(i),l=this._platform.createParticleBuffer(i);this._buffer0=new st.l(t,o,!1,this._attributesStrideSize),this._buffer1=new st.l(t,l,!1,this._attributesStrideSize),this._spriteBuffer=new st.l(t,a,!1,4),this._renderVertexBuffers=[],this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture();let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";return this._isBillboardBased&&(e+="\n#define BILLBOARD"),this._colorGradientsTexture&&(e+="\n#define COLORGRADIENTS"),this._sizeGradientsTexture&&(e+="\n#define SIZEGRADIENTS"),this._angularSpeedGradientsTexture&&(e+="\n#define ANGULARSPEEDGRADIENTS"),this._velocityGradientsTexture&&(e+="\n#define VELOCITYGRADIENTS"),this._limitVelocityGradientsTexture&&(e+="\n#define LIMITVELOCITYGRADIENTS"),this._dragGradientsTexture&&(e+="\n#define DRAGGRADIENTS"),this.isAnimationSheetEnabled&&(e+="\n#define ANIMATESHEET",this.spriteRandomStartCell&&(e+="\n#define ANIMATESHEETRANDOMSTART")),this.noiseTexture&&(e+="\n#define NOISE"),this.isLocal&&(e+="\n#define LOCAL"),this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e||(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e)),this._platform.isUpdateBufferReady()}_getWrapper(e){let t=this._getCustomDrawWrapper(e);if(t?.effect)return t;let i=[];this.fillDefines(i,e);let r=this._drawWrappers[e];r||((r=new cu.q(this._engine)).drawContext&&(r.drawContext.useInstancing=!0),this._drawWrappers[e]=r);let s=i.join("\n");if(r.defines!==s){let e=[],t=[],i=[];this.fillUniformsAttributesAndSamplerNames(t,e,i),r.setEffect(this._engine.createEffect("gpuRenderParticles",e,t,i,s),s)}return r}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,r=!1){let s=[st.o.PositionKind,"age","life","size","angle"];return e||s.push(st.o.ColorKind),t&&s.push("cellIndex"),i||s.push("initialDirection"),r&&s.push("direction"),s.push("offset",st.o.UVKind),s}static _GetEffectCreationOptions(e=!1,t=!1,i=!1){let r=["emitterWM","worldOffset","view","projection","colorDead","invView","translationPivot","eyePosition"];return(0,o9.qx)(r),e&&r.push("sheetInfos"),t&&r.push("logarithmicDepthConstant"),i&&(r.push("vFogInfos"),r.push("vFogColor")),r}fillDefines(e,t=0,i=!0){if(this._scene&&((0,o9.lK)(this,this._scene,e),this.applyFog&&this._scene.fogEnabled&&this._scene.fogMode!==rH.x.FOGMODE_NONE&&e.push("#define FOG")),t===ps.p.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case ps.p.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case ps.p.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case ps.p.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL")}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),i&&this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...pu._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===ps.p.BILLBOARDMODE_STRETCHED)),e.push(...pu._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth,this.applyFog)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(ns.$.PrepareUniforms(e,this._imageProcessingConfigurationDefines),ns.$.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:this._scene?.getAnimationRatio()||1),this._actualFrame+=this._timeDelta,!this._stopped&&this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop(),this.updateInAnimate&&this._update()}_createFactorGradientTexture(e,t){let i=this[t];if(!e||!e.length||i)return;let r=new Float32Array(this._rawTextureWidth);for(let t=0;t<this._rawTextureWidth;t++){let i=t/this._rawTextureWidth;pr.fR.GetCurrentGradient(i,e,(e,i,s)=>{r[t]=(0,aP.Lerp)(e.factor1,i.factor1,s)})}this[t]=rK.l.CreateRTexture(r,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1),this[t].name=t.substring(1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;let e=new Uint8Array(4*this._rawTextureWidth),t=i2.zZ.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){let r=i/this._rawTextureWidth;pr.fR.GetCurrentGradient(r,this._colorGradients,(r,s,n)=>{i2.HE.LerpToRef(r.color1,s.color1,n,t),e[4*i]=255*t.r,e[4*i+1]=255*t.g,e[4*i+2]=255*t.b,e[4*i+3]=255*t.a})}this._colorGradientsTexture=rK.l.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1),this._colorGradientsTexture.name="colorGradients"}_render(e,t){let i=this._getWrapper(e),r=i.effect;this._engine.enableEffect(i);let s=this._scene?.getViewMatrix()||i1.y3.IdentityReadOnly;if(r.setMatrix("view",s),r.setMatrix("projection",this.defaultProjectionMatrix??this._scene.getProjectionMatrix()),r.setTexture("diffuseSampler",this.particleTexture),r.setVector2("translationPivot",this.translationPivot),r.setVector3("worldOffset",this.worldOffset),this.isLocal&&r.setMatrix("emitterWM",t),this._colorGradientsTexture?r.setTexture("colorGradientSampler",this._colorGradientsTexture):r.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){let e=this.particleTexture.getBaseSize();r.setFloat3("sheetInfos",this.spriteCellWidth/e.width,this.spriteCellHeight/e.height,e.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){let e=this._scene.activeCamera;r.setVector3("eyePosition",e.globalPosition)}let n=r.defines;if(this._scene&&((0,o9.an)(r,this,this._scene),this.applyFog&&(0,le.D1)(this._scene,void 0,r)),n.indexOf("#define BILLBOARDMODE_ALL")>=0){let e=s.clone();e.invert(),r.setMatrix("invView",e)}switch(this.useLogarithmicDepth&&this._scene&&(0,le.gz)(n,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),e){case ps.p.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case ps.p.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case ps.p.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case ps.p.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4)}return this._platform.bindDrawBuffers(this._targetIndex,r,this._scene?.forceWireframe?this._linesIndexBufferUseInstancing:null),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._scene?.forceWireframe?this._engine.drawElementsType(6,0,10,this._currentActiveCount):this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._scene?.forceWireframe&&this._engine.unbindInstanceAttributes(),this._currentActiveCount}_update(e){if(!this.emitter||!this._targetBuffer||!this._recreateUpdateEffect()||this._rebuildingAfterContextLost)return;if(!e){if(this.emitter.position)e=this.emitter.getWorldMatrix();else{let t=this.emitter;e=i1.jp.Matrix[0],i1.y3.TranslationToRef(t.x,t.y,t.z,e)}}this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",e),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount),this._targetIndex++,2===this._targetIndex&&(this._targetIndex=0);let t=this._sourceBuffer;this._sourceBuffer=this._targetBuffer,this._targetBuffer=t}render(e=!1,t=!1){let i;if(!this._started||!this.isReady())return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let e=0;e<this.preWarmCycles;e++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getRenderId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getRenderId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){let e=0|this._accumulatedCount;this._accumulatedCount-=e,this._currentActiveCount+=e}if(this._currentActiveCount=Math.min(this._maxActiveParticleCount,this._currentActiveCount),!this._currentActiveCount)return 0;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{let e=this.emitter;i=i1.jp.Matrix[0],i1.y3.TranslationToRef(e.x,e.y,e.z,i)}let r=this._engine;this.updateInAnimate||this._update(i);let s=0;return e||t||(r.setState(!1),this.forceDepthWrite&&r.setDepthWrite(!0),s=this.blendMode===ps.p.BLENDMODE_MULTIPLYADD?this._render(ps.p.BLENDMODE_MULTIPLY,i)+this._render(ps.p.BLENDMODE_ADD,i):this._render(this.blendMode,i),this._engine.setAlphaMode(0)),s}rebuild(){let e=()=>{this._recreateUpdateEffect()&&this._platform.isUpdateBufferReady()?(this._initialize(!0),this._rebuildingAfterContextLost=!1):setTimeout(e,10)};this._createIndexBuffer(),this._cachedUpdateDefines="",this._platform.contextLost(),this._rebuildingAfterContextLost=!0,e()}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(let e in this._drawWrappers)this._drawWrappers[e].dispose();if(this._drawWrappers={},this._scene){let e=this._scene.particleSystems.indexOf(this);e>-1&&this._scene.particleSystems.splice(e,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers();for(let e=0;e<this._renderVertexBuffers.length;++e){let t=this._renderVertexBuffers[e];for(let e in t)t[e].dispose()}this._renderVertexBuffers=[],this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t,i=!1){let r={...this._customWrappers},s=null,n=this._engine;if(n.createEffectForParticles&&null!=this.customShader){let e=(s=this.customShader).shaderOptions.defines.length>0?s.shaderOptions.defines.join("\n"):"";r[0]=n.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,e,void 0,void 0,void 0,this)}let a=this.serialize(i),o=pu.Parse(a,this._scene||this._engine,this._rootUrl);return o.name=e,o.customShader=s,o._customWrappers=r,void 0===t&&(t=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=t,o}serialize(e=!1){let t={};return ps.p._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,r=!1,s){let n;let a=e.name;n=t instanceof rV.a?t:t.getEngine();let o=new pu(a,{capacity:s||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(o._rootUrl=i,e.customShader&&n.createEffectForParticles){let t=e.customShader,i=t.shaderOptions.defines.length>0?t.shaderOptions.defines.join("\n"):"",r=n.createEffectForParticles(t.shaderPath.fragmentElement,t.shaderOptions.uniforms,t.shaderOptions.samplers,i,void 0,void 0,void 0,o);o.setCustomEffect(r,0),o.customShader=t}return e.id&&(o.id=e.id),e.activeParticleCount&&(o.activeParticleCount=e.activeParticleCount),ps.p._Parse(e,o,t,i),e.preventAutoStart&&(o.preventAutoStart=e.preventAutoStart),r||o.preventAutoStart||o.start(),o}}i(84228);class ph{constructor(){this._emitterNodeIsOwned=!0,this.systems=[]}get emitterNode(){return this._emitterNode}set emitterNode(e){for(let t of(this._emitterNodeIsOwned&&this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!1),this.systems))t.emitter=e;this._emitterNode=e}setEmitterAsSphere(e,t,i){this._emitterNodeIsOwned&&this._emitterNode&&this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNodeIsOwned=!0,this._emitterCreationOptions={kind:"Sphere",options:e,renderingGroupId:t};let r=(0,n$.Qk)("emitterSphere",{diameter:e.diameter,segments:e.segments},i);r.renderingGroupId=t;let s=new nn.K("emitterSphereMaterial",i);for(let t of(s.emissiveColor=e.color,r.material=s,this.systems))t.emitter=r;this._emitterNode=r}start(e){for(let t of this.systems)e&&(t.emitter=e),t.start()}dispose(){for(let e of this.systems)e.dispose();this.systems.length=0,this._emitterNode&&(this._emitterNode.dispose&&this._emitterNode.dispose(),this._emitterNode=null)}serialize(e=!1){let t={};for(let i of(t.systems=[],this.systems))t.systems.push(i.serialize(e));return this._emitterNode&&(t.emitter=this._emitterCreationOptions),t}static Parse(e,t,i=!1,r){let s=new ph,n=this.BaseAssetsUrl+"/textures/";for(let a of(t=t||rh.l.LastCreatedScene,e.systems))s.systems.push(i?pu.Parse(a,t,n,!0,r):ps.p.Parse(a,t,n,!0,r));if(e.emitter){let i=e.emitter.options;"Sphere"===e.emitter.kind&&s.setEmitterAsSphere({diameter:i.diameter,segments:i.segments,color:i2.Wo.FromArray(i.color)},e.emitter.renderingGroupId,t)}return s}}ph.BaseAssetsUrl="https://assets.babylonjs.com/particles";class pd{static CreateDefault(e,t=500,i,r=!1){let s;return(s=r?new pu("default system",{capacity:t},i):new ps.p("default system",t,i)).emitter=e,s.particleTexture=new rZ.x("https://assets.babylonjs.com/textures/flare.png",s.getScene()),s.createConeEmitter(.1,Math.PI/4),s.color1=new i2.HE(1,1,1,1),s.color2=new i2.HE(1,1,1,1),s.colorDead=new i2.HE(1,1,1,0),s.minSize=.1,s.maxSize=.1,s.minEmitPower=2,s.maxEmitPower=2,s.updateSpeed=1/60,s.emitRate=30,s}static CreateAsync(e,t,i=!1,r){t||(t=rh.l.LastCreatedScene);let s={};return t.addPendingData(s),new Promise((n,a)=>{if(i&&!pu.IsSupported)return t.removePendingData(s),a("Particle system with GPU is not supported.");rD.w1.LoadFile(`${pd.BaseAssetsUrl}/systems/${e}.json`,e=>{t.removePendingData(s);let a=JSON.parse(e.toString());return n(ph.Parse(a,t,i,r))},void 0,void 0,void 0,()=>(t.removePendingData(s),a(`An error occurred with the creation of your particle system. Check if your type '${e}' exists.`)))})}static ExportSet(e){let t=new ph;for(let i of e)t.systems.push(i);return t}static ParseFromFileAsync(e,t,i,r=!1,s="",n){return new Promise((a,o)=>{let l=new lk.g;l.addEventListener("readystatechange",()=>{if(4==l.readyState){if(200==l.status){let t;let o=JSON.parse(l.responseText);t=r?pu.Parse(o,i,s,!1,n):ps.p.Parse(o,i,s,!1,n),e&&(t.name=e),a(t)}else o("Unable to load the particle system")}}),l.open("GET",t),l.send()})}static ParseFromSnippetAsync(e,t,i=!1,r="",s){if("_BLANK"===e){let e=this.CreateDefault(null);return e.start(),Promise.resolve(e)}return new Promise((n,a)=>{let o=new lk.g;o.addEventListener("readystatechange",()=>{if(4==o.readyState){if(200==o.status){let a;let l=JSON.parse(JSON.parse(JSON.parse(o.responseText).jsonPayload).particleSystem);(a=i?pu.Parse(l,t,r,!1,s):ps.p.Parse(l,t,r,!1,s)).snippetId=e,n(a)}else a("Unable to load the snippet "+e)}}),o.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),o.send()})}}pd.BaseAssetsUrl=ph.BaseAssetsUrl,pd.SnippetUrl="https://snippet.babylonjs.com",pd.CreateFromSnippetAsync=pd.ParseFromSnippetAsync,(0,rY.PS)(rz.l.NAME_PARTICLESYSTEM,(e,t,i,r)=>{let s=(0,rY.t)(rz.l.NAME_PARTICLESYSTEM);if(s&&void 0!==e.particleSystems&&null!==e.particleSystems)for(let n=0,a=e.particleSystems.length;n<a;n++){let a=e.particleSystems[n];i.particleSystems.push(s(a,t,r))}}),(0,rY.jq)(rz.l.NAME_PARTICLESYSTEM,(e,t,i)=>e.activeParticleCount?pu.Parse(e,t,i):ps.p.Parse(e,t,i)),rV.a.prototype.createEffectForParticles=function(e,t=[],r=[],s="",n,a,o,l,c=0){let u=[],h=[],d=[];return l?l.fillUniformsAttributesAndSamplerNames(h,u,d):(u=ps.p._GetAttributeNamesOrOptions(),h=ps.p._GetEffectCreationOptions()),-1===s.indexOf(" BILLBOARD")&&(s+="\n#define BILLBOARD\n"),l?.isAnimationSheetEnabled&&-1===s.indexOf(" ANIMATESHEET")&&(s+="\n#define ANIMATESHEET\n"),-1===r.indexOf("diffuseSampler")&&r.push("diffuseSampler"),this.createEffect({vertex:l?.vertexShaderName??"particles",fragmentElement:e},u,h.concat(t),d.concat(r),s,n,a,o,void 0,c,async()=>{0===c?await Promise.resolve().then(i.bind(i,70670)):await Promise.resolve().then(i.bind(i,59089))})},rP.Kj.prototype.getEmittedParticleSystems=function(){let e=[];for(let t=0;t<this.getScene().particleSystems.length;t++){let i=this.getScene().particleSystems[t];i.emitter===this&&e.push(i)}return e},rP.Kj.prototype.getHierarchyEmittedParticleSystems=function(){let e=[],t=this.getDescendants();t.push(this);for(let i=0;i<this.getScene().particleSystems.length;i++){let r=this.getScene().particleSystems[i],s=r.emitter;s.position&&-1!==t.indexOf(s)&&e.push(r)}return e};class pf{getBoundingInfo(){return this._boundingInfo}get hasBoundingInfo(){return null!==this._boundingInfo}constructor(e,t,i,r,s,n,a,o,l=null,c=null){this.idx=0,this.id=0,this.color=new i2.HE(1,1,1,1),this.position=i1.P.Zero(),this.rotation=i1.P.Zero(),this.scaling=i1.P.One(),this.uvs=new i1.Lt(0,0,1,1),this.velocity=i1.P.Zero(),this.pivot=i1.P.Zero(),this.translateFromPivot=!1,this.alive=!0,this.isVisible=!0,this._pos=0,this._ind=0,this.shapeId=0,this.idxInShape=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this.materialIndex=null,this.props=null,this.cullingStrategy=rA.x.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this._globalPosition=i1.P.Zero(),this.idx=e,this.id=t,this._pos=i,this._ind=r,this._model=s,this.shapeId=n,this.idxInShape=a,this._sps=o,l&&(this._modelBoundingInfo=l,this._boundingInfo=new nw.j(l.minimum,l.maximum)),null!==c&&(this.materialIndex=c)}copyToRef(e){return e.position.copyFrom(this.position),e.rotation.copyFrom(this.rotation),this.rotationQuaternion&&(e.rotationQuaternion?e.rotationQuaternion.copyFrom(this.rotationQuaternion):e.rotationQuaternion=this.rotationQuaternion.clone()),e.scaling.copyFrom(this.scaling),this.color&&(e.color?e.color.copyFrom(this.color):e.color=this.color.clone()),e.uvs.copyFrom(this.uvs),e.velocity.copyFrom(this.velocity),e.pivot.copyFrom(this.pivot),e.translateFromPivot=this.translateFromPivot,e.alive=this.alive,e.isVisible=this.isVisible,e.parentId=this.parentId,e.cullingStrategy=this.cullingStrategy,null!==this.materialIndex&&(e.materialIndex=this.materialIndex),this}get scale(){return this.scaling}set scale(e){this.scaling=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e){return!!this._boundingInfo&&!!e.hasBoundingInfo&&(this._sps._bSphereOnly?nB.K.Intersects(this._boundingInfo.boundingSphere,e.getBoundingInfo().boundingSphere):this._boundingInfo.intersects(e.getBoundingInfo(),!1))}isInFrustum(e){return null!==this._boundingInfo&&this._boundingInfo.isInFrustum(e,this.cullingStrategy)}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=i1.jp.Quaternion[0];let e=this.rotation;i1._f.RotationYawPitchRollToRef(e.y,e.x,e.z,t)}t.toRotationMatrix(e)}}class pp{get shapeID(){return this.shapeId}set shapeID(e){this.shapeId=e}constructor(e,t,i,r,s,n,a,o,l){this._indicesLength=0,this.shapeId=e,this._shape=t,this._indices=i,this._indicesLength=i.length,this._shapeUV=n,this._shapeColors=s,this._normals=r,this._positionFunction=a,this._vertexFunction=o,this._material=l}}class pm{constructor(e,t,i,r){this.idx=0,this.ind=0,this.indicesLength=0,this.sqDistance=0,this.materialIndex=0,this.idx=e,this.ind=t,this.indicesLength=i,this.materialIndex=r}}class p_{constructor(){this.position=i1.P.Zero(),this.color=new i2.HE(1,1,1,1),this.uv=i1.FM.Zero()}get x(){return this.position.x}set x(e){this.position.x=e}get y(){return this.position.y}set y(e){this.position.y=e}get z(){return this.position.z}set z(e){this.position.z=e}}class pg{constructor(e,t,i){this.particles=[],this.nbParticles=0,this.billboard=!1,this.recomputeNormals=!1,this.counter=0,this.vars={},this._bSphereOnly=!1,this._bSphereRadiusFactor=1,this._positions=[],this._indices=[],this._normals=[],this._colors=[],this._uvs=[],this._index=0,this._updatable=!0,this._pickable=!1,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._depthSort=!1,this._expandable=!1,this._shapeCounter=0,this._copy=new pf(0,0,0,0,null,0,0,this),this._color=new i2.HE(0,0,0,0),this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeParticleVertex=!1,this._computeBoundingBox=!1,this._autoFixFaceOrientation=!1,this._depthSortParticles=!0,this._mustUnrotateFixedNormals=!1,this._particlesIntersect=!1,this._needs32Bits=!1,this._isNotBuilt=!0,this._lastParticleId=0,this._idxOfId=[],this._multimaterialEnabled=!1,this._useModelMaterial=!1,this._depthSortFunction=(e,t)=>t.sqDistance-e.sqDistance,this._materialSortFunction=(e,t)=>e.materialIndex-t.materialIndex,this._autoUpdateSubMeshes=!1,this._recomputeInvisibles=!1,this.name=e,this._scene=t||rh.l.LastCreatedScene,this._camera=t.activeCamera,this._pickable=!!i&&i.isPickable,this._depthSort=!!i&&i.enableDepthSort,this._multimaterialEnabled=!!i&&i.enableMultiMaterial,this._useModelMaterial=!!i&&i.useModelMaterial,this._multimaterialEnabled=!!this._useModelMaterial||this._multimaterialEnabled,this._expandable=!!i&&i.expandable,this._particlesIntersect=!!i&&i.particleIntersection,this._bSphereOnly=!!i&&i.boundingSphereOnly,this._bSphereRadiusFactor=i&&i.bSphereRadiusFactor?i.bSphereRadiusFactor:1,this._computeBoundingBox=!!i?.computeBoundingBox&&i.computeBoundingBox,this._autoFixFaceOrientation=!!i?.autoFixFaceOrientation&&i.autoFixFaceOrientation,i&&void 0!==i.updatable?this._updatable=i.updatable:this._updatable=!0,this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]),(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]),this._multimaterialEnabled&&(this._multimaterial=new cN.G(this.name+"MultiMaterial",this._scene),this._materials=[],this._materialIndexesById={}),this._tmpVertex=new p_}buildMesh(){if(!this._isNotBuilt&&this.mesh)return this.mesh;if(0===this.nbParticles&&!this.mesh){let e=(0,oQ.uH)("",{radius:1,tessellation:3},this._scene);this.addShape(e,1),e.dispose()}if(this._indices32=this._needs32Bits?new Uint32Array(this._indices):new Uint16Array(this._indices),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors),!this.mesh){let e=new rP.Kj(this.name,this._scene);this.mesh=e}!this._updatable&&this._multimaterialEnabled&&this._sortParticlesByMaterial(),this.recomputeNormals&&nK.x.ComputeNormals(this._positions32,this._indices32,this._normals),this._normals32=new Float32Array(this._normals),this._fixedNormal32=new Float32Array(this._normals),this._mustUnrotateFixedNormals&&this._unrotateFixedNormals();let e=new nK.x;if(e.indices=this._depthSort?this._indices:this._indices32,e.set(this._positions32,st.o.PositionKind),e.set(this._normals32,st.o.NormalKind),this._uvs32.length>0&&e.set(this._uvs32,st.o.UVKind),this._colors32.length>0&&e.set(this._colors32,st.o.ColorKind),e.applyToMesh(this.mesh,this._updatable),this.mesh.isPickable=this._pickable,this._pickable){let e=0;for(let t=0;t<this.nbParticles;t++){let i=this.particles[t],r=i._model._indicesLength;for(let t=0;t<r;t++)if(0==t%3){let t={idx:i.idx,faceId:e};this.pickedParticles[e]=t,e++}}}return this._multimaterialEnabled&&this.setMultiMaterial(this._materials),this._expandable||(this._depthSort||this._multimaterialEnabled||this._autoFixFaceOrientation||(this._indices=null),this._positions=null,this._normals=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0)),this._isNotBuilt=!1,this.recomputeNormals=!1,this._recomputeInvisibles=!0,this.mesh}_getUVKind(e,t){return -1===t&&(e.material?.diffuseTexture?t=e.material.diffuseTexture.coordinatesIndex:e.material?.albedoTexture&&(t=e.material.albedoTexture.coordinatesIndex)),"uv"+(t?t+1:"")}digest(e,t){let i=t&&t.facetNb||1,r=t&&t.number||0,s=t&&t.delta||0,n=e.getVerticesData(st.o.PositionKind),a=e.getIndices(),o=e.getVerticesData(this._getUVKind(e,t?.uvKind??0)),l=e.getVerticesData(st.o.ColorKind),c=e.getVerticesData(st.o.NormalKind),u=t&&t.storage?t.storage:null,h=0,d=a.length/3;r?(r=r>d?d:r,i=Math.round(d/r),s=0):i=i>d?d:i;let f=[],p=[],m=[],_=[],g=[],v=i1.P.Zero(),S=i;for(;h<d;){let t,r;h>d-(i=S+Math.floor((1+s)*Math.random()))&&(i=d-h),f.length=0,p.length=0,m.length=0,_.length=0,g.length=0;let x=0;for(let e=3*h;e<(h+i)*3;e++){m.push(x);let t=a[e],i=3*t;if(f.push(n[i],n[i+1],n[i+2]),p.push(c[i],c[i+1],c[i+2]),o){let e=2*t;_.push(o[e],o[e+1])}if(l){let e=4*t;g.push(l[e],l[e+1],l[e+2],l[e+3])}x++}let E=this.nbParticles,C=this._posToShape(f),T=this._uvsToShapeUV(_),b=m.slice(),y=g.slice(),I=p.slice();for(v.copyFromFloats(0,0,0),t=0;t<C.length;t++)v.addInPlace(C[t]);v.scaleInPlace(1/C.length);let P=new i1.P(1/0,1/0,1/0),R=new i1.P(-1/0,-1/0,-1/0);for(t=0;t<C.length;t++)C[t].subtractInPlace(v),P.minimizeInPlaceFromFloats(C[t].x,C[t].y,C[t].z),R.maximizeInPlaceFromFloats(C[t].x,C[t].y,C[t].z);this._particlesIntersect&&(r=new nw.j(P,R));let A=null;this._useModelMaterial&&(A=e.material?e.material:this._setDefaultMaterial());let M=new pp(this._shapeCounter,C,b,I,y,T,null,null,A),N=this._positions.length,O=this._indices.length;this._meshBuilder(this._index,O,C,this._positions,b,this._indices,_,this._uvs,y,this._colors,I,this._normals,E,0,null,M),this._addParticle(E,this._lastParticleId,N,O,M,this._shapeCounter,0,r,u),this.particles[this.nbParticles].position.addInPlace(v),!u&&(this._index+=C.length,E++,this.nbParticles++,this._lastParticleId++),this._shapeCounter++,h+=i}return this._isNotBuilt=!0,this}_unrotateFixedNormals(){let e=0,t=0,i=i1.jp.Vector3[0],r=i1.jp.Quaternion[0],s=i1.jp.Matrix[0];for(let n=0;n<this.particles.length;n++){let a=this.particles[n],o=a._model._shape;if(a.rotationQuaternion)a.rotationQuaternion.conjugateToRef(r);else{let e=a.rotation;i1._f.RotationYawPitchRollToRef(e.y,e.x,e.z,r),r.conjugateInPlace()}r.toRotationMatrix(s);for(let r=0;r<o.length;r++)t=e+3*r,i1.P.TransformNormalFromFloatsToRef(this._normals32[t],this._normals32[t+1],this._normals32[t+2],s,i),i.toArray(this._fixedNormal32,t);e=t+3}}_resetCopy(){let e=this._copy;e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.copyFromFloats(0,0,1,1),e.color=null,e.translateFromPivot=!1,e.shapeId=0,e.materialIndex=null}_meshBuilder(e,t,i,r,s,n,a,o,l,c,u,h,d,f,p,m){let _;let g=0,v=0,S=0;this._resetCopy();let x=this._copy,E=!!p&&!!p.storage;if(x.idx=d,x.idxInShape=f,x.shapeId=m.shapeId,this._useModelMaterial){let e=m._material.uniqueId,t=this._materialIndexesById;Object.prototype.hasOwnProperty.call(t,e)||(t[e]=this._materials.length,this._materials.push(m._material));let i=t[e];x.materialIndex=i}if(p&&p.positionFunction&&(p.positionFunction(x,d,f),this._mustUnrotateFixedNormals=!0),E)return x;let C=i1.jp.Matrix[0],T=this._tmpVertex,b=T.position,y=T.color,I=T.uv,P=i1.jp.Vector3[1],R=i1.jp.Vector3[2],A=i1.jp.Vector3[3];i1.y3.IdentityToRef(C),x.getRotationMatrix(C),x.pivot.multiplyToRef(x.scaling,A),x.translateFromPivot?R.setAll(0):R.copyFrom(A);let M=p&&p.vertexFunction;for(_=0;_<i.length;_++){if(b.copyFrom(i[_]),x.color&&y.copyFrom(x.color),a&&I.copyFromFloats(a[g],a[g+1]),M&&p.vertexFunction(x,T,_),b.multiplyInPlace(x.scaling).subtractInPlace(A),i1.P.TransformCoordinatesToRef(b,C,P),P.addInPlace(R).addInPlace(x.position),r.push(P.x,P.y,P.z),a){let e=x.uvs;o.push((e.z-e.x)*I.x+e.x,(e.w-e.y)*I.y+e.y),g+=2}if(x.color)this._color.copyFrom(y);else{let e=this._color;l&&void 0!==l[v]?(e.r=l[v],e.g=l[v+1],e.b=l[v+2],e.a=l[v+3]):(e.r=1,e.g=1,e.b=1,e.a=1)}c.push(this._color.r,this._color.g,this._color.b,this._color.a),v+=4,!this.recomputeNormals&&u&&(i1.P.TransformNormalFromFloatsToRef(u[S],u[S+1],u[S+2],C,b),h.push(b.x,b.y,b.z),S+=3)}for(_=0;_<s.length;_++){let t=e+s[_];n.push(t),t>65535&&(this._needs32Bits=!0)}if(this._depthSort||this._multimaterialEnabled){let e=null!==x.materialIndex?x.materialIndex:0;this.depthSortedParticles.push(new pm(d,t,s.length,e))}return x}_posToShape(e){let t=[];for(let i=0;i<e.length;i+=3)t.push(i1.P.FromArray(e,i));return t}_uvsToShapeUV(e){let t=[];if(e)for(let i=0;i<e.length;i++)t.push(e[i]);return t}_addParticle(e,t,i,r,s,n,a,o=null,l=null){let c=new pf(e,t,i,r,s,n,a,this,o);return(l||this.particles).push(c),c}addShape(e,t,i){let r=e.getVerticesData(st.o.PositionKind),s=e.getIndices(),n=e.getVerticesData(st.o.UVKind),a=e.getVerticesData(st.o.ColorKind),o=e.getVerticesData(st.o.NormalKind);this.recomputeNormals=!o;let l=Array.from(s),c=o?Array.from(o):[],u=a?Array.from(a):[],h=i&&i.storage?i.storage:null,d=null;this._particlesIntersect&&(d=e.getBoundingInfo());let f=this._posToShape(r),p=this._uvsToShapeUV(n),m=i?i.positionFunction:null,_=i?i.vertexFunction:null,g=null;this._useModelMaterial&&(g=e.material?e.material:this._setDefaultMaterial());let v=new pp(this._shapeCounter,f,l,c,u,p,m,_,g);for(let e=0;e<t;e++)this._insertNewParticle(this.nbParticles,e,v,f,s,n,a,o,d,h,i);return this._shapeCounter++,this._isNotBuilt=!0,this._shapeCounter-1}_rebuildParticle(e,t=!1){this._resetCopy();let i=this._copy;e._model._positionFunction&&e._model._positionFunction(i,e.idx,e.idxInShape);let r=i1.jp.Matrix[0],s=i1.jp.Vector3[0],n=i1.jp.Vector3[1],a=i1.jp.Vector3[2],o=i1.jp.Vector3[3];i.getRotationMatrix(r),e.pivot.multiplyToRef(e.scaling,o),i.translateFromPivot?a.copyFromFloats(0,0,0):a.copyFrom(o);let l=e._model._shape;for(let t=0;t<l.length;t++)s.copyFrom(l[t]),e._model._vertexFunction&&e._model._vertexFunction(i,s,t),s.multiplyInPlace(i.scaling).subtractInPlace(o),i1.P.TransformCoordinatesToRef(s,r,n),n.addInPlace(a).addInPlace(i.position).toArray(this._positions32,e._pos+3*t);t&&(e.position.setAll(0),e.rotation.setAll(0),e.rotationQuaternion=null,e.scaling.setAll(1),e.uvs.setAll(0),e.pivot.setAll(0),e.translateFromPivot=!1,e.parentId=null)}rebuildMesh(e=!1){for(let t=0;t<this.particles.length;t++)this._rebuildParticle(this.particles[t],e);return this.mesh.updateVerticesData(st.o.PositionKind,this._positions32,!1,!1),this}removeParticles(e,t){let i=t-e+1;if(!this._expandable||i<=0||i>=this.nbParticles||!this._updatable)return[];let r=this.particles,s=this.nbParticles;if(t<s-1){let i=t+1,n=r[i]._pos-r[e]._pos,a=r[i]._ind-r[e]._ind;for(let e=i;e<s;e++){let t=r[e];t._pos-=n,t._ind-=a}}let n=r.splice(e,i);this._positions.length=0,this._indices.length=0,this._colors.length=0,this._uvs.length=0,this._normals.length=0,this._index=0,this._idxOfId.length=0,(this._depthSort||this._multimaterialEnabled)&&(this.depthSortedParticles=[]);let a=0,o=r.length;for(let e=0;e<o;e++){let t=r[e],i=t._model,s=i._shape,n=i._indices,o=i._normals,l=i._shapeColors,c=i._shapeUV;t.idx=e,this._idxOfId[t.id]=e,this._meshBuilder(this._index,a,s,this._positions,n,this._indices,c,this._uvs,l,this._colors,o,this._normals,t.idx,t.idxInShape,null,i),this._index+=s.length,a+=n.length}return this.nbParticles-=i,this._isNotBuilt=!0,n}insertParticlesFromArray(e){if(!this._expandable)return this;let t=0,i=e[0].shapeId,r=e.length;for(let s=0;s<r;s++){let r=e[s],n=r._model,a=n._shape,o=n._indices,l=n._shapeUV,c=n._shapeColors,u=n._normals,h=!u;this.recomputeNormals=h||this.recomputeNormals;let d=r.getBoundingInfo(),f=this._insertNewParticle(this.nbParticles,t,n,a,o,l,c,u,d,null,null);r.copyToRef(f),t++,i!=r.shapeId&&(i=r.shapeId,t=0)}return this._isNotBuilt=!0,this}_insertNewParticle(e,t,i,r,s,n,a,o,l,c,u){let h=this._positions.length,d=this._indices.length,f=this._meshBuilder(this._index,d,r,this._positions,s,this._indices,n,this._uvs,a,this._colors,o,this._normals,e,t,u,i),p=null;return this._updatable&&((p=this._addParticle(this.nbParticles,this._lastParticleId,h,d,i,this._shapeCounter,t,l,c)).position.copyFrom(f.position),p.rotation.copyFrom(f.rotation),f.rotationQuaternion&&(p.rotationQuaternion?p.rotationQuaternion.copyFrom(f.rotationQuaternion):p.rotationQuaternion=f.rotationQuaternion.clone()),f.color&&(p.color?p.color.copyFrom(f.color):p.color=f.color.clone()),p.scaling.copyFrom(f.scaling),p.uvs.copyFrom(f.uvs),null!==f.materialIndex&&(p.materialIndex=f.materialIndex),this.expandable&&(this._idxOfId[p.id]=p.idx)),!c&&(this._index+=r.length,this.nbParticles++,this._lastParticleId++),p}setParticles(e=0,t=this.nbParticles-1,i=!0){if(!this._updatable||this._isNotBuilt)return this;this.beforeUpdateParticles(e,t,i);let r=i1.jp.Matrix[0],s=i1.jp.Matrix[1],n=this.mesh,a=this._colors32,o=this._positions32,l=this._normals32,c=this._uvs32,u=this._indices32,h=this._indices,d=this._fixedNormal32,f=this._depthSort&&this._depthSortParticles,p=i1.jp.Vector3,m=p[5].copyFromFloats(1,0,0),_=p[6].copyFromFloats(0,1,0),g=p[7].copyFromFloats(0,0,1),v=p[8].setAll(Number.MAX_VALUE),S=p[9].setAll(-Number.MAX_VALUE),x=p[10].setAll(0),E=this._tmpVertex,C=E.position,T=E.color,b=E.uv;if((this.billboard||this._depthSort)&&(this.mesh.computeWorldMatrix(!0),this.mesh._worldMatrix.invertToRef(s)),this.billboard){let e=p[0];this._camera.getDirectionToRef(r9.RD.Z,e),i1.P.TransformNormalToRef(e,s,g),g.normalize();let t=this._camera.getViewMatrix(!0);i1.P.TransformNormalFromFloatsToRef(t.m[1],t.m[5],t.m[9],s,_),i1.P.CrossToRef(_,g,m),_.normalize(),m.normalize()}this._depthSort&&i1.P.TransformCoordinatesToRef(this._camera.globalPosition,s,x),i1.y3.IdentityToRef(r);let y=0,I=0,P=0,R=0,A=0,M=0,N=0;if(this.mesh.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(0!=e||t!=this.nbParticles-1)){let e=this.mesh.getBoundingInfo();e&&(v.copyFrom(e.minimum),S.copyFrom(e.maximum))}let O=(I=this.particles[e]._pos)/3|0;R=4*O,M=2*O;for(let i=e;i<=t;i++){let e=this.particles[i];this.updateParticle(e);let t=e._model._shape,s=e._model._shapeUV,u=e._rotationMatrix,h=e.position,O=e.rotation,D=e.scaling,F=e._globalPosition;if(f){let t=this.depthSortedParticles[i];t.idx=e.idx,t.ind=e._ind,t.indicesLength=e._model._indicesLength,t.sqDistance=i1.P.DistanceSquared(e.position,x)}if(!e.alive||e._stillInvisible&&!e.isVisible&&!this._recomputeInvisibles){I+=3*(N=t.length),R+=4*N,M+=2*N;continue}if(e.isVisible){e._stillInvisible=!1;let i=p[12];if(e.pivot.multiplyToRef(D,i),this.billboard&&(O.x=0,O.y=0),(this._computeParticleRotation||this.billboard)&&e.getRotationMatrix(r),null!==e.parentId){let t=this.getParticleById(e.parentId);if(t){let e=t._rotationMatrix,i=t._globalPosition,s=h.x*e[1]+h.y*e[4]+h.z*e[7],n=h.x*e[0]+h.y*e[3]+h.z*e[6],a=h.x*e[2]+h.y*e[5]+h.z*e[8];if(F.x=i.x+n,F.y=i.y+s,F.z=i.z+a,this._computeParticleRotation||this.billboard){let t=r.m;u[0]=t[0]*e[0]+t[1]*e[3]+t[2]*e[6],u[1]=t[0]*e[1]+t[1]*e[4]+t[2]*e[7],u[2]=t[0]*e[2]+t[1]*e[5]+t[2]*e[8],u[3]=t[4]*e[0]+t[5]*e[3]+t[6]*e[6],u[4]=t[4]*e[1]+t[5]*e[4]+t[6]*e[7],u[5]=t[4]*e[2]+t[5]*e[5]+t[6]*e[8],u[6]=t[8]*e[0]+t[9]*e[3]+t[10]*e[6],u[7]=t[8]*e[1]+t[9]*e[4]+t[10]*e[7],u[8]=t[8]*e[2]+t[9]*e[5]+t[10]*e[8]}}else e.parentId=null}else if(F.x=h.x,F.y=h.y,F.z=h.z,this._computeParticleRotation||this.billboard){let e=r.m;u[0]=e[0],u[1]=e[1],u[2]=e[2],u[3]=e[4],u[4]=e[5],u[5]=e[6],u[6]=e[8],u[7]=e[9],u[8]=e[10]}let n=p[11];for(e.translateFromPivot?n.setAll(0):n.copyFrom(i),N=0;N<t.length;N++){y=I+3*N,P=R+4*N,A=M+2*N;let r=2*N,a=r+1;C.copyFrom(t[N]),this._computeParticleColor&&e.color&&T.copyFrom(e.color),this._computeParticleTexture&&b.copyFromFloats(s[r],s[a]),this._computeParticleVertex&&this.updateParticleVertex(e,E,N);let h=C.x*D.x-i.x,f=C.y*D.y-i.y,p=C.z*D.z-i.z,x=h*u[0]+f*u[3]+p*u[6],O=h*u[1]+f*u[4]+p*u[7],L=h*u[2]+f*u[5]+p*u[8];x+=n.x,O+=n.y,L+=n.z;let w=o[y]=F.x+m.x*x+_.x*O+g.x*L,B=o[y+1]=F.y+m.y*x+_.y*O+g.y*L,V=o[y+2]=F.z+m.z*x+_.z*O+g.z*L;if(this._computeBoundingBox&&(v.minimizeInPlaceFromFloats(w,B,V),S.maximizeInPlaceFromFloats(w,B,V)),!this._computeParticleVertex){let e=d[y],t=d[y+1],i=d[y+2],r=e*u[0]+t*u[3]+i*u[6],s=e*u[1]+t*u[4]+i*u[7],n=e*u[2]+t*u[5]+i*u[8];l[y]=m.x*r+_.x*s+g.x*n,l[y+1]=m.y*r+_.y*s+g.y*n,l[y+2]=m.z*r+_.z*s+g.z*n}if(this._computeParticleColor&&e.color){let e=this._colors32;e[P]=T.r,e[P+1]=T.g,e[P+2]=T.b,e[P+3]=T.a}if(this._computeParticleTexture){let t=e.uvs;c[A]=b.x*(t.z-t.x)+t.x,c[A+1]=b.y*(t.w-t.y)+t.y}}}else for(N=0,e._stillInvisible=!0;N<t.length;N++){if(y=I+3*N,P=R+4*N,A=M+2*N,o[y]=o[y+1]=o[y+2]=0,l[y]=l[y+1]=l[y+2]=0,this._computeParticleColor&&e.color){let t=e.color;a[P]=t.r,a[P+1]=t.g,a[P+2]=t.b,a[P+3]=t.a}if(this._computeParticleTexture){let t=e.uvs;c[A]=s[2*N]*(t.z-t.x)+t.x,c[A+1]=s[2*N+1]*(t.w-t.y)+t.y}}if(this._particlesIntersect){let t=e.getBoundingInfo(),i=t.boundingBox,r=t.boundingSphere,s=e._modelBoundingInfo;if(!this._bSphereOnly){let e=s.boundingBox.vectors,t=p[1],r=p[2];t.setAll(Number.MAX_VALUE),r.setAll(-Number.MAX_VALUE);for(let i=0;i<8;i++){let s=e[i].x*D.x,n=e[i].y*D.y,a=e[i].z*D.z,o=s*u[0]+n*u[3]+a*u[6],l=s*u[1]+n*u[4]+a*u[7],c=s*u[2]+n*u[5]+a*u[8],d=h.x+m.x*o+_.x*l+g.x*c,f=h.y+m.y*o+_.y*l+g.y*c,p=h.z+m.z*o+_.z*l+g.z*c;t.minimizeInPlaceFromFloats(d,f,p),r.maximizeInPlaceFromFloats(d,f,p)}i.reConstruct(t,r,n._worldMatrix)}let a=s.minimum.multiplyToRef(D,p[1]),o=s.maximum.multiplyToRef(D,p[2]),l=o.addToRef(a,p[3]).scaleInPlace(.5).addInPlace(F),c=o.subtractToRef(a,p[4]).scaleInPlace(.5*this._bSphereRadiusFactor),d=l.subtractToRef(c,p[1]),f=l.addToRef(c,p[2]);r.reConstruct(d,f,n._worldMatrix)}I=y+3,R=P+4,M=A+2}if(i){if(this._computeParticleColor){let e=n.getVertexBuffer(st.o.ColorKind);e&&!n.isPickable?e.updateDirectly(a,0):n.updateVerticesData(st.o.ColorKind,a,!1,!1)}if(this._computeParticleTexture){let e=n.getVertexBuffer(st.o.UVKind);e&&!n.isPickable?e.updateDirectly(c,0):n.updateVerticesData(st.o.UVKind,c,!1,!1)}let e=n.getVertexBuffer(st.o.PositionKind);if(e&&!n.isPickable?e.updateDirectly(o,0):n.updateVerticesData(st.o.PositionKind,o,!1,!1),!n.areNormalsFrozen||n.isFacetDataEnabled){if(this._computeParticleVertex||n.isFacetDataEnabled){let e=n.isFacetDataEnabled?n.getFacetDataParameters():null;nK.x.ComputeNormals(o,u,l,e);for(let e=0;e<l.length;e++)d[e]=l[e]}if(!n.areNormalsFrozen){let e=n.getVertexBuffer(st.o.NormalKind);e&&!n.isPickable?e.updateDirectly(l,0):n.updateVerticesData(st.o.NormalKind,l,!1,!1)}}if(f){let e=this.depthSortedParticles;e.sort(this._depthSortFunction);let t=e.length,i=0,r=0;for(let s=0;s<t;s++){let t=e[s],n=t.indicesLength,a=t.ind;for(let e=0;e<n;e++)if(u[i]=h[a+e],i++,this._pickable&&0==e%3){let e=this.pickedParticles[r];e.idx=t.idx,e.faceId=r,r++}}}if(this._autoFixFaceOrientation){let e=0;for(let t=0;t<this.particles.length;t++){let i=f?this.particles[this.depthSortedParticles[t].idx]:this.particles[t];if(i.scale.x*i.scale.y*i.scale.z<0)for(let t=0;t<i._model._indicesLength;t+=3){let r=h[i._ind+t];u[e+t]=h[i._ind+t+1],u[e+t+1]=r}e+=i._model._indicesLength}}(f||this._autoFixFaceOrientation)&&n.updateIndices(u)}return this._computeBoundingBox&&(n.hasBoundingInfo?n.getBoundingInfo().reConstruct(v,S,n._worldMatrix):n.buildBoundingInfo(v,S,n._worldMatrix)),this._autoUpdateSubMeshes&&this.computeSubMeshes(),this._recomputeInvisibles=!1,this.afterUpdateParticles(e,t,i),this}dispose(){this.mesh.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._normals32=null,this._fixedNormal32=null,this._uvs32=null,this._colors32=null,this.pickedParticles=null,this.pickedBySubMesh=null,this._materials=null,this._materialIndexes=null,this._indicesByMaterial=null,this._idxOfId=null}pickedParticle(e){if(e.hit){let t=e.subMeshId,i=e.faceId-this.mesh.subMeshes[t].indexStart/3,r=this.pickedBySubMesh;if(r[t]&&r[t][i])return r[t][i]}return null}getParticleById(e){let t=this.particles[e];if(t&&t.id==e)return t;let i=this.particles,r=this._idxOfId[e];if(void 0!==r)return i[r];let s=0,n=this.nbParticles;for(;s<n;){let t=i[s];if(t.id==e)return t;s++}return null}getParticlesByShapeId(e){let t=[];return this.getParticlesByShapeIdToRef(e,t),t}getParticlesByShapeIdToRef(e,t){t.length=0;for(let i=0;i<this.nbParticles;i++){let r=this.particles[i];r.shapeId==e&&t.push(r)}return this}computeSubMeshes(){if(!this.mesh||!this._multimaterialEnabled)return this;let e=this.depthSortedParticles;if(this.particles.length>0)for(let t=0;t<this.particles.length;t++){let i=this.particles[t];i.materialIndex||(i.materialIndex=0);let r=e[t];r.materialIndex=i.materialIndex,r.ind=i._ind,r.indicesLength=i._model._indicesLength,r.idx=i.idx}this._sortParticlesByMaterial();let t=this._indicesByMaterial,i=this._materialIndexes,r=this.mesh;r.subMeshes=[];let s=r.getTotalVertices();for(let e=0;e<i.length;e++){let n=t[e],a=t[e+1]-n,o=i[e];new lJ.P(o,0,s,n,a,r)}return this}_sortParticlesByMaterial(){let e=[0];this._indicesByMaterial=e;let t=[];this._materialIndexes=t;let i=this.depthSortedParticles;i.sort(this._materialSortFunction);let r=i.length,s=this._indices32,n=this._indices,a=0,o=0,l=0,c=i[0].materialIndex;t.push(c),this._pickable&&(this.pickedBySubMesh=[[]],this.pickedParticles=this.pickedBySubMesh[0]);for(let u=0;u<r;u++){let r=i[u],h=r.indicesLength,d=r.ind;r.materialIndex!==c&&(c=r.materialIndex,e.push(l),t.push(c),this._pickable&&(a++,this.pickedBySubMesh[a]=[],o=0));let f=0;for(let e=0;e<h;e++){if(s[l]=n[d+e],this._pickable&&0==e%3){let e=this.pickedBySubMesh[a][o];e?(e.idx=r.idx,e.faceId=f):this.pickedBySubMesh[a][o]={idx:r.idx,faceId:f},o++,f++}l++}}return e.push(s.length),this._updatable&&this.mesh.updateIndices(s),this}_setMaterialIndexesById(){this._materialIndexesById={};for(let e=0;e<this._materials.length;e++){let t=this._materials[e].uniqueId;this._materialIndexesById[t]=e}}_filterUniqueMaterialId(e){return e.filter(function(e,t,i){return i.indexOf(e)===t})}_setDefaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=new nn.K(this.name+"DefaultMaterial",this._scene)),this._defaultMaterial}refreshVisibleSize(){return this._isVisibilityBoxLocked||this.mesh.refreshBoundingInfo(),this}setVisibilityBox(e){let t=e/2;this.mesh.buildBoundingInfo(new i1.P(-t,-t,-t),new i1.P(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e}set isVisibilityBoxLocked(e){this._isVisibilityBoxLocked=e,this.mesh.getBoundingInfo().isLocked=e}get isVisibilityBoxLocked(){return this._isVisibilityBoxLocked}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}set computeParticleVertex(e){this._computeParticleVertex=e}set computeBoundingBox(e){this._computeBoundingBox=e}set depthSortParticles(e){this._depthSortParticles=e}get computeParticleRotation(){return this._computeParticleRotation}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}get computeParticleVertex(){return this._computeParticleVertex}get computeBoundingBox(){return this._computeBoundingBox}get depthSortParticles(){return this._depthSortParticles}get expandable(){return this._expandable}get multimaterialEnabled(){return this._multimaterialEnabled}get useModelMaterial(){return this._useModelMaterial}get materials(){return this._materials}setMultiMaterial(e){this._materials=this._filterUniqueMaterialId(e),this._setMaterialIndexesById(),this._multimaterial&&this._multimaterial.dispose(),this._multimaterial=new cN.G(this.name+"MultiMaterial",this._scene);for(let e=0;e<this._materials.length;e++)this._multimaterial.subMaterials.push(this._materials[e]);this.computeSubMeshes(),this.mesh.material=this._multimaterial}get multimaterial(){return this._multimaterial}set multimaterial(e){this._multimaterial=e}get autoUpdateSubMeshes(){return this._autoUpdateSubMeshes}set autoUpdateSubMeshes(e){this._autoUpdateSubMeshes=e}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}updateParticleVertex(e,t,i){return this}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}(eV=iP||(iP={}))[eV.Color=2]="Color",eV[eV.UV=1]="UV",eV[eV.Random=0]="Random",eV[eV.Stated=3]="Stated",i(22510),i(43886),i(70670),i(85667),i(59089),Object.defineProperty(rA.x.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(e){this._physicsImpostor!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0}),rA.x.prototype.getPhysicsImpostor=function(){return this.physicsImpostor},rA.x.prototype.applyImpulse=function(e,t){return this.physicsImpostor&&this.physicsImpostor.applyImpulse(e,t),this},rA.x.prototype.setPhysicsLinkWith=function(e,t,i,r){return this.physicsImpostor&&e.physicsImpostor&&this.physicsImpostor.createJoint(e.physicsImpostor,nj.HingeJoint,{mainPivot:t,connectedPivot:i,nativeParams:r}),this};class pv{getPluginVersion(){return this._physicsPlugin.getPluginVersion()}static DefaultPluginFactory(){throw(0,rU.S)("")}constructor(e,t=pv.DefaultPluginFactory()){this._physicsPlugin=t,this._physicsBodies=[],this._subTimeStep=0,e=e||new i1.P(0,-9.807,0),this.setGravity(e),this.setTimeStep()}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}setVelocityLimits(e,t){this._physicsPlugin.setVelocityLimits(e,t)}getMaxLinearVelocity(){return this._physicsPlugin.getMaxLinearVelocity()}getMaxAngularVelocity(){return this._physicsPlugin.getMaxAngularVelocity()}_step(e){e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._physicsBodies)}addBody(e){this._physicsBodies.push(e)}removeBody(e){let t=this._physicsBodies.indexOf(e);t>-1&&this._physicsBodies.splice(t,1)}getBodies(){return this._physicsBodies}getPhysicsPlugin(){return this._physicsPlugin}raycastToRef(e,t,i,r){this._physicsPlugin.raycast(e,t,i,r)}raycast(e,t,i){let r=new cG;return this._physicsPlugin.raycast(e,t,r,i),r}}(eU=iR||(iR={}))[eU.FREE=0]="FREE",eU[eU.LIMITED=1]="LIMITED",eU[eU.LOCKED=2]="LOCKED",(ek=iA||(iA={}))[ek.LINEAR_X=0]="LINEAR_X",ek[ek.LINEAR_Y=1]="LINEAR_Y",ek[ek.LINEAR_Z=2]="LINEAR_Z",ek[ek.ANGULAR_X=3]="ANGULAR_X",ek[ek.ANGULAR_Y=4]="ANGULAR_Y",ek[ek.ANGULAR_Z=5]="ANGULAR_Z",ek[ek.LINEAR_DISTANCE=6]="LINEAR_DISTANCE",(eG=iM||(iM={}))[eG.BALL_AND_SOCKET=1]="BALL_AND_SOCKET",eG[eG.DISTANCE=2]="DISTANCE",eG[eG.HINGE=3]="HINGE",eG[eG.SLIDER=4]="SLIDER",eG[eG.LOCK=5]="LOCK",eG[eG.PRISMATIC=6]="PRISMATIC",eG[eG.SIX_DOF=7]="SIX_DOF",(ez=iN||(iN={}))[ez.SPHERE=0]="SPHERE",ez[ez.CAPSULE=1]="CAPSULE",ez[ez.CYLINDER=2]="CYLINDER",ez[ez.BOX=3]="BOX",ez[ez.CONVEX_HULL=4]="CONVEX_HULL",ez[ez.CONTAINER=5]="CONTAINER",ez[ez.MESH=6]="MESH",ez[ez.HEIGHTFIELD=7]="HEIGHTFIELD",(eH=iO||(iO={}))[eH.NONE=0]="NONE",eH[eH.VELOCITY=1]="VELOCITY",eH[eH.POSITION=2]="POSITION",(eW=iD||(iD={})).COLLISION_STARTED="COLLISION_STARTED",eW.COLLISION_CONTINUED="COLLISION_CONTINUED",eW.COLLISION_FINISHED="COLLISION_FINISHED",eW.TRIGGER_ENTERED="TRIGGER_ENTERED",eW.TRIGGER_EXITED="TRIGGER_EXITED",(eY=iF||(iF={}))[eY.STATIC=0]="STATIC",eY[eY.ANIMATED=1]="ANIMATED",eY[eY.DYNAMIC=2]="DYNAMIC",(eX=iL||(iL={}))[eX.DISABLED=0]="DISABLED",eX[eX.TELEPORT=1]="TELEPORT",eX[eX.ACTION=2]="ACTION",(e$=iw||(iw={}))[e$.SIMULATION_CONTROLLED=0]="SIMULATION_CONTROLLED",e$[e$.ALWAYS_ACTIVE=1]="ALWAYS_ACTIVE",e$[e$.ALWAYS_INACTIVE=2]="ALWAYS_INACTIVE",(ej=iB||(iB={}))[ej.GEOMETRIC_MEAN=0]="GEOMETRIC_MEAN",ej[ej.MINIMUM=1]="MINIMUM",ej[ej.MAXIMUM=2]="MAXIMUM",ej[ej.ARITHMETIC_MEAN=3]="ARITHMETIC_MEAN",ej[ej.MULTIPLY=4]="MULTIPLY",rH.x.prototype.getPhysicsEngine=function(){return this._physicsEngine},rH.x.prototype.enablePhysics=function(e=null,t){if(this._physicsEngine)return!0;let i=this._getComponent(rz.l.NAME_PHYSICSENGINE);i||(i=new pS(this),this._addComponent(i));try{if(t&&t?.getPluginVersion()!==1){if(t?.getPluginVersion()===2)this._physicsEngine=new pv(e,t);else throw Error("Unsupported Physics plugin version.")}else this._physicsEngine=new cz(e,t);return this._physicsTimeAccumulator=0,!0}catch(e){return re.Y.Error(e.message),!1}},rH.x.prototype.disablePhysicsEngine=function(){this._physicsEngine&&(this._physicsEngine.dispose(),this._physicsEngine=null)},rH.x.prototype.isPhysicsEnabled=function(){return void 0!==this._physicsEngine},rH.x.prototype.deleteCompoundImpostor=function(e){let t=e.parts[0].mesh;t.physicsImpostor&&(t.physicsImpostor.dispose(),t.physicsImpostor=null)},rH.x.prototype._advancePhysicsEngineStep=function(e){if(this._physicsEngine){let t=this._physicsEngine.getSubTimeStep();if(t>0)for(this._physicsTimeAccumulator+=e;this._physicsTimeAccumulator>t;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(t/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=t;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};class pS{constructor(e){this.name=rz.l.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new i0.y$,this.scene.onAfterPhysicsObservable=new i0.y$,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?1e3*this.scene._physicsEngine.getTimeStep():1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}Object.defineProperty(rR.Y.prototype,"physicsBody",{get:function(){return this._physicsBody},set:function(e){this._physicsBody!==e&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsBody=e,e&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsBody&&(this.physicsBody.dispose(),this.physicsBody=null)})))},enumerable:!0,configurable:!0}),rR.Y.prototype.getPhysicsBody=function(){return this.physicsBody},rR.Y.prototype.applyImpulse=function(e,t){if(!this.physicsBody)throw Error("No Physics Body for TransformNode");return this.physicsBody.applyImpulse(e,t),this},rR.Y.prototype.applyAngularImpulse=function(e){if(!this.physicsBody)throw Error("No Physics Body for TransformNode");return this.physicsBody.applyAngularImpulse(e),this};class px{static GetContactPointToRef(e,t,i,r,s){let n=e.getScene().getPhysicsEngine(),a=n?.getPluginVersion();if(1===a){let s=new nr.zH(t,i).intersectsMesh(e);if(s.hit&&s.pickedPoint)return r.copyFrom(s.pickedPoint),!0}else if(2===a)return e.physicsBody.getObjectCenterWorldToRef(r,s),!0;return!1}static HasAppliedForces(e,t){return 0===e.getMotionType(t)||(e.getMassProperties(t)?.mass??0)===0||e.transformNode?.getTotalVertices()===0}static IsInsideCylinder(e,t,i,r){let s=i1.jp.Vector3[0];return e.subtractToRef(t,s),Math.abs(s.x)<=i&&Math.abs(s.z)<=i&&s.y>=0&&s.y<=r}}class pE{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=i1.P.Zero(),this._originDirection=i1.P.Zero(),this._cylinderPosition=i1.P.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new pT,...this._options},this._origin.addToRef(new i1.P(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new i1.P(0,this._options.height,0),this._originTop),1===this._options.updraftMode&&(this._originDirection=this._origin.subtract(this._originTop).normalize()),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?(this._cylinder.dispose(),this._cylinder=void 0):setTimeout(()=>{!this._dataFetched&&this._cylinder&&(this._cylinder.dispose(),this._cylinder=void 0)},0))}_getHitData(e,t){let i;i=1===this._options.updraftMode?this._originDirection:e.subtract(this._originTop);let r=i1.P.Distance(this._origin,e),s=-1*this._options.strength,n=i.multiplyByFloats(s,s,s);t.force.copyFrom(n),t.contactPoint.copyFrom(e),t.distanceFromOrigin=r}_getBodyHitData(e,t,i){if(px.HasAppliedForces(e))return!1;let r=e.getObjectCenterWorld(i);return!!px.IsInsideCylinder(r,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(r,t),!0)}_getImpostorHitData(e,t){if(0===e.mass)return!1;let i=e.object;if(!this._intersectsWithCylinder(i))return!1;let r=e.getObjectCenter();return this._getHitData(r,t),!0}_tick(){let e=pE._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach(t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)}):this._physicsEngine.getBodies().forEach(t=>{t.iterateOverAllInstances((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)})})}_prepareCylinder(){this._cylinder||(this._cylinder=(0,nz.wf)("updraftEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return!!this._cylinder&&(this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0))}}pE._HitData={force:new i1.P,contactPoint:new i1.P,distanceFromOrigin:0};class pC{constructor(e,t,i){this._scene=e,this._origin=t,this._options=i,this._originTop=i1.P.Zero(),this._cylinderPosition=i1.P.Zero(),this._dataFetched=!1,this._physicsEngine=this._scene.getPhysicsEngine(),this._options={...new pb,...this._options},this._origin.addToRef(new i1.P(0,this._options.height/2,0),this._cylinderPosition),this._origin.addToRef(new i1.P(0,this._options.height,0),this._originTop),this._tickCallback=()=>this._tick(),1===this._physicsEngine.getPluginVersion()&&this._prepareCylinder()}getData(){return this._dataFetched=!0,{cylinder:this._cylinder}}enable(){this._tickCallback.call(this),this._scene.registerBeforeRender(this._tickCallback)}disable(){this._scene.unregisterBeforeRender(this._tickCallback)}dispose(e=!0){this._cylinder&&(e?this._cylinder.dispose():setTimeout(()=>{this._dataFetched||this._cylinder.dispose()},0))}_getHitData(e,t,i){let r,s,n;let a=pC._OriginOnPlane;a.set(this._origin.x,t.y,this._origin.z);let o=i1.jp.Vector3[0];t.subtractToRef(a,o);let l=i1.jp.Vector3[1];if(!px.GetContactPointToRef(e,a,o,l,i.instanceIndex))return!1;let c=i1.P.Distance(l,a)/this._options.radius,u=i1.jp.Vector3[2];if(l.normalizeToRef(u),c>this._options.centripetalForceThreshold&&u.negateInPlace(),c>this._options.centripetalForceThreshold)r=u.x*this._options.centripetalForceMultiplier,s=u.y*this._options.updraftForceMultiplier,n=u.z*this._options.centripetalForceMultiplier;else{let e=i1.P.Cross(a,t).normalize();r=(e.x+u.x)*this._options.centrifugalForceMultiplier,s=this._originTop.y*this._options.updraftForceMultiplier,n=(e.z+u.z)*this._options.centrifugalForceMultiplier}let h=i1.jp.Vector3[3];return h.set(r,s,n),h.scaleInPlace(this._options.strength),i.force.copyFrom(h),i.contactPoint.copyFrom(t),i.distanceFromOrigin=c,!0}_getBodyHitData(e,t,i){if(px.HasAppliedForces(e,i))return!1;let r=e.transformNode,s=e.getObjectCenterWorld(i);return!!px.IsInsideCylinder(s,this._origin,this._options.radius,this._options.height)&&(t.instanceIndex=i,this._getHitData(r,s,t))}_getImpostorHitData(e,t){if(0===e.mass||"Mesh"!==e.object.getClassName()&&"InstancedMesh"!==e.object.getClassName())return!1;let i=e.object;if(!this._intersectsWithCylinder(i))return!1;let r=e.getObjectCenter();return this._getHitData(i,r,t),!0}_tick(){let e=pC._HitData;1===this._physicsEngine.getPluginVersion()?this._physicsEngine.getImpostors().forEach(t=>{this._getImpostorHitData(t,e)&&t.applyForce(e.force,e.contactPoint)}):this._physicsEngine.getBodies().forEach(t=>{t.iterateOverAllInstances((t,i)=>{this._getBodyHitData(t,e,i)&&t.applyForce(e.force,e.contactPoint,e.instanceIndex)})})}_prepareCylinder(){this._cylinder||(this._cylinder=(0,nz.wf)("vortexEventCylinder",{height:this._options.height,diameter:2*this._options.radius},this._scene),this._cylinder.isVisible=!1)}_intersectsWithCylinder(e){return this._cylinder.position=this._cylinderPosition,this._cylinder.intersectsMesh(e,!0)}}pC._OriginOnPlane=i1.P.Zero(),pC._HitData={force:new i1.P,contactPoint:new i1.P,distanceFromOrigin:0};class pT{constructor(){this.radius=5,this.strength=10,this.height=10,this.updraftMode=0}}class pb{constructor(){this.radius=5,this.strength=10,this.height=10,this.centripetalForceThreshold=.7,this.centripetalForceMultiplier=5,this.centrifugalForceMultiplier=.5,this.updraftForceMultiplier=.02}}(eq=iV||(iV={}))[eq.Constant=0]="Constant",eq[eq.Linear=1]="Linear",(eQ=iU||(iU={}))[eQ.Center=0]="Center",eQ[eQ.Perpendicular=1]="Perpendicular";class py extends sD.D{getClassName(){return"BlackAndWhitePostProcess"}constructor(e,t,i,r,s,n){super(e,"blackAndWhite",["degree"],null,t,i,r,s,n),this.degree=1,this.onApplyObservable.add(e=>{e.setFloat("degree",this.degree)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,51414)))):t.push(Promise.resolve().then(i.bind(i,20281))),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new py(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],py.prototype,"degree",void 0),(0,i3.H7)("BABYLON.BlackAndWhitePostProcess",py);class pI{constructor(e,t,i,r){this._name=t,this._singleInstance=r||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(let e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){let t=this._postProcesses[e];for(let e=0;e<t.length;e++)if(!t[e].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;let i=rD.w1.MakeArray(e||this._cameras);if(i)for(let e=0;e<i.length;e++){let r=i[e];if(!r)continue;let s=r.name;if(t=this._singleInstance?0:s,!this._postProcesses[t]){let e=this._getPostProcesses();e&&(this._postProcesses[t]=Array.isArray(e)?e:[e])}this._indicesForCamera[s]||(this._indicesForCamera[s]=[]),this._postProcesses[t].forEach(e=>{let t=r.attachPostProcess(e);this._indicesForCamera[s].push(t)}),this._cameras[s]||(this._cameras[s]=r)}}_detachCameras(e){let t=rD.w1.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){let i=t[e],r=i.name,s=this._postProcesses[this._singleInstance?0:r];s&&s.forEach(e=>{i.detachPostProcess(e)}),this._cameras[r]&&(this._cameras[r]=null),delete this._indicesForCamera[r]}}_enable(e){let t=rD.w1.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){let i=t[e],r=i.name,s=this._singleInstance?0:r;for(let n=0;n<this._indicesForCamera[r].length;n++){let a=this._indicesForCamera[r][n];null==i._postProcesses[a]&&t[e].attachPostProcess(this._postProcesses[s][n],a)}}}_disable(e){let t=rD.w1.MakeArray(e||this._cameras);if(t)for(let e=0;e<t.length;e++){let i=t[e],r=i.name;this._postProcesses[this._singleInstance?0:r].forEach(e=>{i.detachPostProcess(e)})}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}class pP extends sD.D{getClassName(){return"ExtractHighlightsPostProcess"}constructor(e,t,i,r,s,n,a=0,o=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,r,s,n,null,a,void 0,null,o),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add(e=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&e.setTextureFromPostProcess("textureSampler",this._inputPostProcess),e.setFloat("threshold",Math.pow(this.threshold,r2.zp)),e.setFloat("exposure",this._exposure)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,71764)))):t.push(Promise.resolve().then(i.bind(i,23710))),super._gatherImports(e,t)}}(0,r$.gn)([(0,rj.qC)()],pP.prototype,"threshold",void 0),(0,i3.H7)("BABYLON.ExtractHighlightsPostProcess",pP);class pR extends sD.D{getClassName(){return"BloomMergePostProcess"}constructor(e,t,i,r,s,n,a,o,l,c=0,u=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],s,n,a,o,l,null,c,void 0,null,!0),this.weight=1,this.weight=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("bloomBlur",i),e.setFloat("bloomWeight",this.weight)}),u||this.updateEffect()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,37846)))):t.push(Promise.resolve().then(i.bind(i,65630))),super._gatherImports(e,t)}}(0,r$.gn)([(0,rj.qC)()],pR.prototype,"weight",void 0),(0,i3.H7)("BABYLON.BloomMergePostProcess",pR);class pA extends pI{get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}constructor(e,t,i,r,s=0,n=!1){super(e.getEngine(),"bloom",()=>this._effects,!0),this._bloomScale=t,this._effects=[],this._downscale=new pP("highlights",1,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,n),this._blurX=new o2.i("horizontal blur",new i1.FM(1,0),10,t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,void 0,n),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new o2.i("vertical blur",new i1.FM(0,1),10,t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,void 0,n),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=r,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new pR("bloomMerge",this._downscale,this._blurY,i,t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,n),this._merge.autoClear=!1,this._effects.push(this._merge)}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}class pM extends sD.D{getClassName(){return"ChromaticAberrationPostProcess"}constructor(e,t,i,r,s,n,a,o,l=0,c=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],r,s,n,a,o,null,l,void 0,null,c),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new i1.FM(.707,.707),this.centerPosition=new i1.FM(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add(e=>{e.setFloat("chromatic_aberration",this.aberrationAmount),e.setFloat("screen_width",t),e.setFloat("screen_height",i),e.setFloat("radialIntensity",this.radialIntensity),e.setFloat2("direction",this.direction.x,this.direction.y),e.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,8290))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,31506))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pM(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],pM.prototype,"aberrationAmount",void 0),(0,r$.gn)([(0,rj.qC)()],pM.prototype,"radialIntensity",void 0),(0,r$.gn)([(0,rj.qC)()],pM.prototype,"direction",void 0),(0,r$.gn)([(0,rj.qC)()],pM.prototype,"centerPosition",void 0),(0,r$.gn)([(0,rj.qC)()],pM.prototype,"screenWidth",void 0),(0,r$.gn)([(0,rj.qC)()],pM.prototype,"screenHeight",void 0),(0,i3.H7)("BABYLON.ChromaticAberrationPostProcess",pM);class pN extends sD.D{getClassName(){return"CircleOfConfusionPostProcess"}constructor(e,t,i,r,s,n,a,o=0,l=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,r,s,n,a,null,o,void 0,null,l),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add(e=>{if(!this._depthTexture){re.Y.Warn("No depth texture set on CircleOfConfusionPostProcess");return}e.setTexture("depthSampler",this._depthTexture);let t=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);e.setFloat("focusDistance",this.focusDistance),e.setFloat("cocPrecalculation",t);let i=this._depthTexture.activeCamera;e.setFloat2("cameraMinMaxZ",i.minZ,i.maxZ-i.minZ)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,9969)))):t.push(Promise.resolve().then(i.bind(i,87320))),super._gatherImports(e,t)}set depthTexture(e){this._depthTexture=e}}(0,r$.gn)([(0,rj.qC)()],pN.prototype,"lensSize",void 0),(0,r$.gn)([(0,rj.qC)()],pN.prototype,"fStop",void 0),(0,r$.gn)([(0,rj.qC)()],pN.prototype,"focusDistance",void 0),(0,r$.gn)([(0,rj.qC)()],pN.prototype,"focalLength",void 0),(0,i3.H7)("BABYLON.CircleOfConfusionPostProcess",pN);class pO extends sD.D{getClassName(){return"ColorCorrectionPostProcess"}constructor(e,t,i,r,s,n,a){super(e,"colorCorrection",null,["colorTable"],i,r,s,n,a);let o=r?.getScene()||null;this._colorTableTexture=new rZ.x(t,o,!0,!1,rZ.x.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=rZ.x.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=e=>{e.setTexture("colorTable",this._colorTableTexture)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,55840))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,84980))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pO(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],pO.prototype,"colorTableUrl",void 0),(0,i3.H7)("BABYLON.ColorCorrectionPostProcess",pO);class pD extends sD.D{getClassName(){return"ConvolutionPostProcess"}constructor(e,t,i,r,s,n,a,o=0){super(e,"convolution",["kernel","screenSize"],null,i,r,s,n,a,null,o),this.kernel=t,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setArray("kernel",this.kernel)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,38458))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,57477))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pD(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType),e,i,r)}}pD.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1],pD.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0],pD.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1],pD.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0],pD.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2],pD.GaussianKernel=[0,1,0,1,1,1,0,1,0],(0,r$.gn)([(0,rj.qC)()],pD.prototype,"kernel",void 0),(0,i3.H7)("BABYLON.ConvolutionPostProcess",pD);class pF extends o2.i{getClassName(){return"DepthOfFieldBlurPostProcess"}constructor(e,t,i,r,s,n,a,o=null,l=rZ.x.BILINEAR_SAMPLINGMODE,c,u,h=0,d=!1,f=5){super(e,i,r,s,n,2,c,u,h,`#define DOF 1
`,d,f),this.direction=i,this.externalTextureSamplerBinding=!!o,this.onApplyObservable.add(e=>{null!=o&&e.setTextureFromPostProcess("textureSampler",o),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",a)})}}(0,r$.gn)([(0,rj.qC)()],pF.prototype,"direction",void 0),(0,i3.H7)("BABYLON.DepthOfFieldBlurPostProcess",pF);class pL extends sD.D{getClassName(){return"DepthOfFieldMergePostProcess"}constructor(e,t,i,r,s,n,a,o,l,c=0,u=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],s,n,a,o,l,null,c,void 0,null,!0),this._blurSteps=r,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(e=>{e.setTextureFromPostProcess("textureSampler",t),e.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),r.forEach((t,i)=>{e.setTextureFromPostProcessOutput("blurStep"+(r.length-i-1),t)})}),u||this.updateEffect()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,56930)))):t.push(Promise.resolve().then(i.bind(i,82494))),super._gatherImports(e,t)}updateEffect(e=null,t=null,i=null,r,s,n){e||(e="#define BLUR_LEVEL "+(this._blurSteps.length-1)+"\n"),super.updateEffect(e,t,i,r,s,n)}}(eK=ik||(ik={}))[eK.Low=0]="Low",eK[eK.Medium=1]="Medium",eK[eK.High=2]="High";class pw extends pI{set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}constructor(e,t,i=0,r=0,s=!1){super(e.getEngine(),"depth of field",()=>this._effects,!0),this._effects=[];let n=e.getEngine(),a=n.isWebGPU||n.version>1?6:5;this._circleOfConfusion=new pN("circleOfConfusion",t,1,null,rZ.x.BILINEAR_SAMPLINGMODE,n,!1,r,s),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let o=1,l=15;switch(i){case 2:o=3,l=51;break;case 1:o=2,l=31;break;default:l=15,o=1}let c=l/Math.pow(2,o-1),u=1;for(let t=0;t<o;t++){let i=new pF("vertical blur",e,new i1.FM(0,1),c,u,null,this._circleOfConfusion,0==t?this._circleOfConfusion:null,rZ.x.BILINEAR_SAMPLINGMODE,n,!1,r,s,0==t?a:5);i.autoClear=!1,u=.75/Math.pow(2,t);let o=new pF("horizontal blur",e,new i1.FM(1,0),c,u,null,this._circleOfConfusion,null,rZ.x.BILINEAR_SAMPLINGMODE,n,!1,r,s);o.autoClear=!1,this._depthOfFieldBlurY.push(i),this._depthOfFieldBlurX.push(o)}this._effects=[this._circleOfConfusion];for(let e=0;e<this._depthOfFieldBlurX.length;e++)this._effects.push(this._depthOfFieldBlurY[e]),this._effects.push(this._depthOfFieldBlurX[e]);this._dofMerge=new pL("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,u,null,rZ.x.BILINEAR_SAMPLINGMODE,n,!1,r,s),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}class pB extends sD.D{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,r,s,n){super(e,"displayPass",["passSampler"],["passSampler"],t,i,r,s,n)}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,76995))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,8983))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pB(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}(0,i3.H7)("BABYLON.DisplayPassPostProcess",pB);class pV extends sD.D{getClassName(){return"FilterPostProcess"}constructor(e,t,i,r,s,n,a){super(e,"filter",["kernelMatrix"],null,i,r,s,n,a),this.kernelMatrix=t,this.onApply=e=>{e.setMatrix("kernelMatrix",this.kernelMatrix)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,25232))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,56095))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pV(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.oQ)()],pV.prototype,"kernelMatrix",void 0),(0,i3.H7)("BABYLON.FilterPostProcess",pV);class pU extends sD.D{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,r,s,n,a=0){super(e,"fxaa",["texelSize"],null,t,i,r||rZ.x.BILINEAR_SAMPLINGMODE,s,n,null,a,"fxaa",void 0,!0);let o=this._getDefines();this.updateEffect(o),this.onApplyObservable.add(e=>{let t=this.texelSize;e.setFloat2("texelSize",t.x,t.y)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,75426)),Promise.resolve().then(i.bind(i,4527))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,23798)),Promise.resolve().then(i.bind(i,87812))])),super._gatherImports(e,t)}_getDefines(){let e=this.getEngine();return e&&e.extractDriverInfo().toLowerCase().indexOf("mali")>-1?"#define MALI 1\n":null}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pU(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}(0,i3.H7)("BABYLON.FxaaPostProcess",pU);class pk extends sD.D{getClassName(){return"GrainPostProcess"}constructor(e,t,i,r,s,n,a=0,o=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,r,s,n,null,a,void 0,null,o),this.intensity=30,this.animated=!1,this.onApplyObservable.add(e=>{e.setFloat("intensity",this.intensity),e.setFloat("animatedSeed",this.animated?Math.random()+1:1)})}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,78562))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,69094))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pk(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],pk.prototype,"intensity",void 0),(0,r$.gn)([(0,rj.qC)()],pk.prototype,"animated",void 0),(0,i3.H7)("BABYLON.GrainPostProcess",pk);class pG extends sD.D{get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let e=null,t=this.getEngine(),i=this.getCamera();if(i)e=i.getScene();else if(t&&t.scenes){let i=t.scenes;e=i[i.length-1]}else e=rh.l.LastCreatedScene;e?this._imageProcessingConfiguration=e.imageProcessingConfiguration:this._imageProcessingConfiguration=new ns.$}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),t||this._updateParameters()}}get isSupported(){let e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterY(){return this.imageProcessingConfiguration.vignetteCenterY}set vignetteCenterY(e){this.imageProcessingConfiguration.vignetteCenterY=e}get vignetteCenterX(){return this.imageProcessingConfiguration.vignetteCenterX}set vignetteCenterX(e){this.imageProcessingConfiguration.vignetteCenterX=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}constructor(e,t,i=null,r,s,n,a=0,o){super(e,"imageProcessing",[],[],t,i,r,s,n,null,a,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:0,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},o?(o.applyByPostProcess=!0,this._attachImageProcessingConfiguration(o,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=e=>{this.imageProcessingConfiguration.bind(e,this.aspectRatio)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.resolve().then(i.bind(i,60224)))):t.push(Promise.resolve().then(i.bind(i,22382))),super._gatherImports(e,t)}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(let t in this._defines){let i=this._defines[t];switch(typeof i){case"number":case"string":e+=`#define ${t} ${i};
`;break;default:i&&(e+=`#define ${t};
`)}}let t=["textureSampler"],i=["scale"];ns.$&&(ns.$.PrepareSamplers(t,this._defines),ns.$.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}(0,r$.gn)([(0,rj.qC)()],pG.prototype,"_fromLinearSpace",void 0),i(21968),i(90894);let pz=["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","boneTextureWidth"];(0,o9.qx)(pz);class pH{get normalsAreUnsigned(){return this._normalsAreUnsigned}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._enableScreenspaceDepth=!1,this._attachmentsFromPrePass=[]}_forceTextureType(e,t){e===pH.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===pH.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===pH.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===pH.DEPTH_TEXTURE_TYPE?(this._depthIndex=t,this._enableDepth=!0):e===pH.NORMAL_TEXTURE_TYPE?(this._normalIndex=t,this._enableNormal=!0):e===pH.SCREENSPACE_DEPTH_TEXTURE_TYPE&&(this._screenspaceDepthIndex=t,this._enableScreenspaceDepth=!0)}_setAttachments(e){this._attachmentsFromPrePass=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case pH.POSITION_TEXTURE_TYPE:return this._positionIndex;case pH.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case pH.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;case pH.DEPTH_TEXTURE_TYPE:return this._depthIndex;case pH.NORMAL_TEXTURE_TYPE:return this._normalIndex;case pH.SCREENSPACE_DEPTH_TEXTURE_TYPE:return this._screenspaceDepthIndex;default:return -1}}get enableDepth(){return this._enableDepth}set enableDepth(e){this._enableDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableNormal(){return this._enableNormal}set enableNormal(e){this._enableNormal=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableScreenspaceDepth(){return this._enableScreenspaceDepth}set enableScreenspaceDepth(e){this._enableScreenspaceDepth=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return"object"==typeof this._ratioOrDimensions?1:this._ratioOrDimensions}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=1,i=15,r){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this.generateNormalsInWorldSpace=!1,this._normalsAreUnsigned=!1,this._resizeObserver=null,this._enableDepth=!0,this._enableNormal=!0,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._enableScreenspaceDepth=!1,this._clearColor=new i2.HE(0,0,0,0),this._clearDepthColor=new i2.HE(1e8,0,0,1),this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._screenspaceDepthIndex=-1,this._linkedWithPrePass=!1,this.useSpecificClearForDepthTexture=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._scene=e,this._ratioOrDimensions=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,this._textureTypesAndFormats=r||{},this._initShaderSourceAsync(),pH._SceneComponentInitialization(this._scene),this._createRenderTargets()}async _initShaderSourceAsync(){this._scene.getEngine().isWebGPU&&!pH.ForceGLSL?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,18938)),Promise.resolve().then(i.bind(i,62598))])):await Promise.all([Promise.resolve().then(i.bind(i,90894)),Promise.resolve().then(i.bind(i,21968))]),this._shadersLoaded=!0}isReady(e,t){if(!this._shadersLoaded)return!1;let i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;let r=[],s=[st.o.PositionKind,st.o.NormalKind],n=e.getMesh();if(i){let e=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(r.push("#define ALPHATEST"),r.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),e=!0),i.bumpTexture&&o6.k.BumpTextureEnabled&&(r.push("#define BUMP"),r.push(`#define BUMP_UV${i.bumpTexture.coordinatesIndex+1}`),e=!0),this._enableReflectivity){let t=!1;"PBRMetallicRoughnessMaterial"===i.getClassName()?(i.metallicRoughnessTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),t=!0),t&&(i.baseTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),e=!0),i.baseColor&&r.push("#define ALBEDOCOLOR"))):"PBRSpecularGlossinessMaterial"===i.getClassName()?(i.specularGlossinessTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),e=!0,i.specularGlossinessTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor&&r.push("#define REFLECTIVITYCOLOR"),null!=i.glossiness&&r.push("#define GLOSSINESS")):"PBRMaterial"===i.getClassName()?(i.metallicTexture&&(r.push("#define ORMTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),r.push("#define METALLICWORKFLOW"),e=!0,t=!0),null!=i.metallic&&(r.push("#define METALLIC"),r.push("#define METALLICWORKFLOW"),t=!0),null!=i.roughness&&(r.push("#define ROUGHNESS"),r.push("#define METALLICWORKFLOW"),t=!0),t?(i.albedoTexture&&(r.push("#define ALBEDOTEXTURE"),r.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&r.push("#define GAMMAALBEDO"),e=!0),i.albedoColor&&r.push("#define ALBEDOCOLOR")):(i.reflectivityTexture?(r.push("#define SPECULARGLOSSINESSTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0):i.reflectivityColor&&r.push("#define REFLECTIVITYCOLOR"),null!=i.microSurface&&r.push("#define GLOSSINESS"))):"StandardMaterial"===i.getClassName()&&(i.specularTexture&&(r.push("#define REFLECTIVITYTEXTURE"),r.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&r.push("#define GAMMAREFLECTIVITYTEXTURE"),e=!0),i.specularColor&&r.push("#define REFLECTIVITYCOLOR"))}e&&(r.push("#define NEED_UV"),n.isVerticesDataPresent(st.o.UVKind)&&(s.push(st.o.UVKind),r.push("#define UV1")),n.isVerticesDataPresent(st.o.UV2Kind)&&(s.push(st.o.UV2Kind),r.push("#define UV2")))}this._enableDepth&&(r.push("#define DEPTH"),r.push("#define DEPTH_INDEX "+this._depthIndex)),this._enableNormal&&(r.push("#define NORMAL"),r.push("#define NORMAL_INDEX "+this._normalIndex)),this._enablePosition&&(r.push("#define POSITION"),r.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(r.push("#define VELOCITY"),r.push("#define VELOCITY_INDEX "+this._velocityIndex),-1===this.excludedSkinnedMeshesFromVelocity.indexOf(n)&&r.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(r.push("#define REFLECTIVITY"),r.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),this._enableScreenspaceDepth&&-1!==this._screenspaceDepthIndex&&(r.push("#define SCREENSPACE_DEPTH_INDEX "+this._screenspaceDepthIndex),r.push("#define SCREENSPACE_DEPTH")),this.generateNormalsInWorldSpace&&r.push("#define NORMAL_WORLDSPACE"),this._normalsAreUnsigned&&r.push("#define ENCODE_NORMAL"),n.useBones&&n.computeBonesUsingShaders&&n.skeleton?(s.push(st.o.MatricesIndicesKind),s.push(st.o.MatricesWeightsKind),n.numBoneInfluencers>4&&(s.push(st.o.MatricesIndicesExtraKind),s.push(st.o.MatricesWeightsExtraKind)),r.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),r.push("#define BONETEXTURE "+n.skeleton.isUsingTextureForMatrices),r.push("#define BonesPerMesh "+(n.skeleton.bones.length+1))):(r.push("#define NUM_BONE_INFLUENCERS 0"),r.push("#define BONETEXTURE false"),r.push("#define BonesPerMesh 0"));let a=n.morphTargetManager,o=0;a&&(o=a.numMaxInfluencers||a.numInfluencers)>0&&(r.push("#define MORPHTARGETS"),r.push("#define NUM_MORPH_INFLUENCERS "+o),a.isUsingTextureForTargets&&r.push("#define MORPHTARGETS_TEXTURE"),(0,le.Vk)(s,n,o)),t&&(r.push("#define INSTANCES"),(0,le.y9)(s,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&r.push("#define THIN_INSTANCES")),this._linkedWithPrePass?r.push("#define SCENE_MRT_COUNT "+this._attachmentsFromPrePass.length):r.push("#define SCENE_MRT_COUNT "+this._multiRenderTarget.textures.length),(0,o9.lK)(i,this._scene,r);let l=this._scene.getEngine(),c=e._getDrawWrapper(void 0,!0),u=c.defines,h=r.join("\n");return u!==h&&c.setEffect(l.createEffect("geometry",{attributes:s,uniformsNames:pz,samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets","boneSampler"],defines:h,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:o},shaderLanguage:this.shaderLanguage},l),h),c.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){let e=[],t=[],i=0;return this._enableDepth&&(this._depthIndex=i,i++,e.push("gBuffer_Depth"),t.push(this._textureTypesAndFormats[pH.DEPTH_TEXTURE_TYPE])),this._enableNormal&&(this._normalIndex=i,i++,e.push("gBuffer_Normal"),t.push(this._textureTypesAndFormats[pH.NORMAL_TEXTURE_TYPE])),this._enablePosition&&(this._positionIndex=i,i++,e.push("gBuffer_Position"),t.push(this._textureTypesAndFormats[pH.POSITION_TEXTURE_TYPE])),this._enableVelocity&&(this._velocityIndex=i,i++,e.push("gBuffer_Velocity"),t.push(this._textureTypesAndFormats[pH.VELOCITY_TEXTURE_TYPE])),this._enableReflectivity&&(this._reflectivityIndex=i,i++,e.push("gBuffer_Reflectivity"),t.push(this._textureTypesAndFormats[pH.REFLECTIVITY_TEXTURE_TYPE])),this._enableScreenspaceDepth&&(this._screenspaceDepthIndex=i,i++,e.push("gBuffer_ScreenspaceDepth"),t.push(this._textureTypesAndFormats[pH.SCREENSPACE_DEPTH_TEXTURE_TYPE])),[i,e,t]}_createRenderTargets(){let e=this._scene.getEngine(),[t,i,r]=this._assignRenderTargetIndices(),s=0;e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?s=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(s=2);let n=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions},a=[],o=[];for(let e of r)e?(a.push(e.textureType),o.push(e.textureFormat)):(a.push(s),o.push(5));if(this._normalsAreUnsigned=11===a[pH.NORMAL_TEXTURE_TYPE]||13===a[pH.NORMAL_TEXTURE_TYPE],this._multiRenderTarget=new ud("gBuffer",n,t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,types:a,formats:o,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null;let l=[!0],c=[!1],u=[!0];for(let e=1;e<t;++e)l.push(!0),u.push(!1),c.push(!0);let h=e.buildTextureLayout(l),d=e.buildTextureLayout(c),f=e.buildTextureLayout(u);this._multiRenderTarget.onClearObservable.add(e=>{e.bindAttachments(this.useSpecificClearForDepthTexture?d:h),e.clear(this._clearColor,!0,!0,!0),this.useSpecificClearForDepthTexture&&(e.bindAttachments(f),e.clear(this._clearDepthColor,!0,!0,!0)),e.bindAttachments(h)}),this._resizeObserver=e.onResizeObservable.add(()=>{if(this._multiRenderTarget){let t=void 0!==this._ratioOrDimensions.width?this._ratioOrDimensions:{width:e.getRenderWidth()*this._ratioOrDimensions,height:e.getRenderHeight()*this._ratioOrDimensions};this._multiRenderTarget.resize(t)}});let p=e=>{let t=e.getRenderingMesh(),i=e.getEffectiveMesh(),r=this._scene,s=r.getEngine(),n=e.getMaterial();if(!n)return;if(i._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[i.uniqueId]&&(this._previousTransformationMatrices[i.uniqueId]={world:i1.y3.Identity(),viewProjection:r.getTransformMatrix()},t.skeleton)){let e=t.skeleton.getTransformMatrices(t);this._previousBonesTransformationMatrices[t.uniqueId]=this._copyBonesTransformationMatrices(e,new Float32Array(e.length))}let a=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;let o=s.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||t.hasThinInstances),l=i.getWorldMatrix();if(this.isReady(e,o)){let c;let u=e._getDrawWrapper();if(!u)return;let h=u.effect;s.enableEffect(u),o||t._bind(e,h,n.fillMode),this._useUbo?((0,le.ml)(h,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(h.setMatrix("viewProjection",r.getTransformMatrix()),h.setMatrix("view",r.getViewMatrix()));let d=t._instanceDataStorage;if(!d.isFrozen&&(n.backFaceCulling||null!==n.sideOrientation)){let e=i._getWorldMatrixDeterminant();c=n._getEffectiveOrientation(t),e<0&&(c=c===n0.F.ClockWiseSideOrientation?n0.F.CounterClockWiseSideOrientation:n0.F.ClockWiseSideOrientation)}else c=d.sideOrientation;if(n._preBind(u,c),n.needAlphaTesting()){let e=n.getAlphaTestTexture();e&&(h.setTexture("diffuseSampler",e),h.setMatrix("diffuseMatrix",e.getTextureMatrix()))}if(n.bumpTexture&&r.getEngine().getCaps().standardDerivatives&&o6.k.BumpTextureEnabled&&(h.setFloat3("vBumpInfos",n.bumpTexture.coordinatesIndex,1/n.bumpTexture.level,n.parallaxScaleBias),h.setMatrix("bumpMatrix",n.bumpTexture.getTextureMatrix()),h.setTexture("bumpSampler",n.bumpTexture),h.setFloat2("vTangentSpaceParams",n.invertNormalMapX?-1:1,n.invertNormalMapY?-1:1)),this._enableReflectivity&&("PBRMetallicRoughnessMaterial"===n.getClassName()?(null!==n.metallicRoughnessTexture&&(h.setTexture("reflectivitySampler",n.metallicRoughnessTexture),h.setMatrix("reflectivityMatrix",n.metallicRoughnessTexture.getTextureMatrix())),null!==n.metallic&&h.setFloat("metallic",n.metallic),null!==n.roughness&&h.setFloat("glossiness",1-n.roughness),null!==n.baseTexture&&(h.setTexture("albedoSampler",n.baseTexture),h.setMatrix("albedoMatrix",n.baseTexture.getTextureMatrix())),null!==n.baseColor&&h.setColor3("albedoColor",n.baseColor)):"PBRSpecularGlossinessMaterial"===n.getClassName()?(null!==n.specularGlossinessTexture?(h.setTexture("reflectivitySampler",n.specularGlossinessTexture),h.setMatrix("reflectivityMatrix",n.specularGlossinessTexture.getTextureMatrix())):null!==n.specularColor&&h.setColor3("reflectivityColor",n.specularColor),null!==n.glossiness&&h.setFloat("glossiness",n.glossiness)):"PBRMaterial"===n.getClassName()?(null!==n.metallicTexture&&(h.setTexture("reflectivitySampler",n.metallicTexture),h.setMatrix("reflectivityMatrix",n.metallicTexture.getTextureMatrix())),null!==n.metallic&&h.setFloat("metallic",n.metallic),null!==n.roughness&&h.setFloat("glossiness",1-n.roughness),null!==n.roughness||null!==n.metallic||null!==n.metallicTexture?(null!==n.albedoTexture&&(h.setTexture("albedoSampler",n.albedoTexture),h.setMatrix("albedoMatrix",n.albedoTexture.getTextureMatrix())),null!==n.albedoColor&&h.setColor3("albedoColor",n.albedoColor)):(null!==n.reflectivityTexture?(h.setTexture("reflectivitySampler",n.reflectivityTexture),h.setMatrix("reflectivityMatrix",n.reflectivityTexture.getTextureMatrix())):null!==n.reflectivityColor&&h.setColor3("reflectivityColor",n.reflectivityColor),null!==n.microSurface&&h.setFloat("glossiness",n.microSurface))):"StandardMaterial"===n.getClassName()&&(null!==n.specularTexture&&(h.setTexture("reflectivitySampler",n.specularTexture),h.setMatrix("reflectivityMatrix",n.specularTexture.getTextureMatrix())),null!==n.specularColor&&h.setColor3("reflectivityColor",n.specularColor))),(0,o9.an)(h,n,this._scene),t.useBones&&t.computeBonesUsingShaders&&t.skeleton){let e=t.skeleton;if(e.isUsingTextureForMatrices&&h.getUniformIndex("boneTextureWidth")>-1){let i=e.getTransformMatrixTexture(t);h.setTexture("boneSampler",i),h.setFloat("boneTextureWidth",4*(e.bones.length+1))}else h.setMatrices("mBones",t.skeleton.getTransformMatrices(t));this._enableVelocity&&h.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[t.uniqueId])}(0,le.KG)(t,h),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(h),this._enableVelocity&&(h.setMatrix("previousWorld",this._previousTransformationMatrices[i.uniqueId].world),h.setMatrix("previousViewProjection",this._previousTransformationMatrices[i.uniqueId].viewProjection)),o&&t.hasThinInstances&&h.setMatrix("world",l),t._processRendering(i,e,h,n.fillMode,a,o,(e,t)=>{e||h.setMatrix("world",t)})}this._enableVelocity&&(this._previousTransformationMatrices[i.uniqueId].world=l.clone(),this._previousTransformationMatrices[i.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),t.skeleton&&this._copyBonesTransformationMatrices(t.skeleton.getTransformMatrices(t),this._previousBonesTransformationMatrices[i.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(t,i,r)=>{if((r||0===i)&&t.subMeshes)for(let i=0;i<t.subMeshes.length;++i){let r=t.subMeshes[i],s=r.getMaterial(),n=r.getRenderingMesh();if(!s)continue;let a=n._getInstancesRenderList(r._id,!!r.getReplacementMesh()),o=e.getCaps().instancedArrays&&(null!==a.visibleInstances[r._id]||n.hasThinInstances);if(!this.isReady(r,o))return!1}return!0},this._multiRenderTarget.customRenderFunction=(t,i,r,s)=>{let n;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachmentsFromPrePass)}if(s.length){for(e.setColorWrite(!1),n=0;n<s.length;n++)p(s.data[n]);e.setColorWrite(!0)}for(n=0;n<t.length;n++)p(t.data[n]);for(e.setDepthWrite(!1),n=0;n<i.length;n++)p(i.data[n]);if(this.renderTransparentMeshes)for(n=0;n<r.length;n++)p(r.data[n]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}pH.ForceGLSL=!1,pH.DEPTH_TEXTURE_TYPE=0,pH.NORMAL_TEXTURE_TYPE=1,pH.POSITION_TEXTURE_TYPE=2,pH.VELOCITY_TEXTURE_TYPE=3,pH.REFLECTIVITY_TEXTURE_TYPE=4,pH.SCREENSPACE_DEPTH_TEXTURE_TYPE=5,pH._SceneComponentInitialization=e=>{throw(0,rU.S)("GeometryBufferRendererSceneComponent")};class pW{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(rH.x.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(e){e&&e.isSupported&&(this._geometryBufferRenderer=e)},enumerable:!0,configurable:!0}),rH.x.prototype.enableGeometryBufferRenderer=function(e=1,t=15,i){return this._geometryBufferRenderer||(this._geometryBufferRenderer=new pH(this,e,t,i),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null)),this._geometryBufferRenderer},rH.x.prototype.disableGeometryBufferRenderer=function(){this._geometryBufferRenderer&&(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class pY{constructor(e){this.name=rz.l.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(rz.l.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}pH._SceneComponentInitialization=e=>{let t=e._getComponent(rz.l.NAME_GEOMETRYBUFFERRENDERER);t||(t=new pY(e),e._addComponent(t))};class pX extends sD.D{get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}constructor(e,t,i,r,s,n,a,o=0,l=!1,c=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection","projection"],["velocitySampler","depthSampler"],i,r,s,n,a,"#define GEOMETRY_SUPPORTED\n#define SAMPLES 64.0\n#define OBJECT_BASED",o,void 0,null,l),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=c,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new pW)),this._applyMode()}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,89376))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,95759))])),super._gatherImports(e,t)}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else{if(!this._prePassRenderer)return;t=this._prePassRenderer.excludedSkinnedMesh}let i=t.indexOf(e);-1!==i&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return re.Y.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=this._isObjectBased),this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=i1.y3.Identity(),this._previousViewProjection=this._scene.getTransformMatrix().clone(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new i1.FM(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){let t=this._geometryBufferRenderer.getTextureIndex(pH.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){let t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){let t=i1.jp.Matrix[0];if(t.copyFrom(this._scene.getTransformMatrix()),t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection.copyFrom(t),e.setMatrix("projection",this._scene.getProjectionMatrix()),e.setVector2("screenSize",new i1.FM(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){let t=this._geometryBufferRenderer.getTextureIndex(pH.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){let t=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[t])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){let e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join("\n"))}}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pX(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],pX.prototype,"motionStrength",void 0),(0,r$.gn)([(0,rj.qC)()],pX.prototype,"motionBlurSamples",null),(0,r$.gn)([(0,rj.qC)()],pX.prototype,"isObjectBased",null),(0,i3.H7)("BABYLON.MotionBlurPostProcess",pX),sG.v.ShadersStore.refractionPixelShader="varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D refractionSampler;uniform vec3 baseColor;uniform float depth;uniform float colorLevel;void main() {float ref=1.0-texture2D(refractionSampler,vUV).r;vec2 uv=vUV-vec2(0.5);vec2 offset=uv*depth*ref;vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);}";class p$ extends sD.D{get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}constructor(e,t,i,r,s,n,a,o,l,c){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],n,a,o,l,c),this._ownRefractionTexture=!0,this.color=i,this.depth=r,this.colorLevel=s,this.refractionTextureUrl=t,this.onActivateObservable.add(e=>{this._refTexture=this._refTexture||new rZ.x(t,e.getScene())}),this.onApplyObservable.add(e=>{e.setColor3("baseColor",this.color),e.setFloat("depth",this.depth),e.setFloat("colorLevel",this.colorLevel),e.setTexture("refractionSampler",this._refTexture)})}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new p$(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],p$.prototype,"color",void 0),(0,r$.gn)([(0,rj.qC)()],p$.prototype,"depth",void 0),(0,r$.gn)([(0,rj.qC)()],p$.prototype,"colorLevel",void 0),(0,r$.gn)([(0,rj.qC)()],p$.prototype,"refractionTextureUrl",void 0),(0,i3.H7)("BABYLON.RefractionPostProcess",p$),i(230);class pj extends sD.D{getClassName(){return"SharpenPostProcess"}constructor(e,t,i,r,s,n,a=0,o=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,r,s,n,null,a,void 0,null,o),this.colorAmount=1,this.edgeAmount=.3,this.onApply=e=>{e.setFloat2("screenSize",this.width,this.height),e.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}_gatherImports(e,t){e?(this._webGPUReady=!0,t.push(Promise.all([Promise.resolve().then(i.bind(i,6459))]))):t.push(Promise.all([Promise.resolve().then(i.bind(i,230))])),super._gatherImports(e,t)}static _Parse(e,t,i,r){return rq.p.Parse(()=>new pj(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],pj.prototype,"colorAmount",void 0),(0,r$.gn)([(0,rj.qC)()],pj.prototype,"edgeAmount",void 0),(0,i3.H7)("BABYLON.SharpenPostProcess",pj);class pq{get name(){return this._name}get cameras(){return this._cameras}get engine(){return this._engine}constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=[],this._cameras=[]}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(let e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){let i=this._renderEffects[e];i&&i._enable(rD.w1.MakeArray(t||this._cameras))}_disableEffect(e,t){let i=this._renderEffects[e];i&&i._disable(rD.w1.MakeArray(t||this._cameras))}_attachCameras(e,t){let i;let r=rD.w1.MakeArray(e||this._cameras);if(!r)return;let s=[];for(i=0;i<r.length;i++){let e=r[i];e&&(-1===this._cameras.indexOf(e)?this._cameras.push(e):t&&s.push(i))}for(i=0;i<s.length;i++)r.splice(s[i],1);for(let e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._attachCameras(r)}_detachCameras(e){let t=rD.w1.MakeArray(e||this._cameras);if(t){for(let e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._detachCameras(t);for(let e=0;e<t.length;e++)this._cameras.splice(this._cameras.indexOf(t[e]),1)}}_update(){for(let e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;let t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=[]}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;let t=Object.keys(this._renderEffects);if(t.length>0){let i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}_adaptPostProcessesToViewPort(){for(let e of Object.keys(this._renderEffects)){let t=this._renderEffects[e].getPostProcesses();if(t)for(let e of t)e.adaptScaleToCurrentViewport=!0}}setPrePassRenderer(e){return!1}dispose(){}}(0,r$.gn)([(0,rj.qC)()],pq.prototype,"_name",void 0);class pQ{constructor(){this._renderPipelines={}}get supportedPipelines(){let e=[];for(let t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){let i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}removePipeline(e){delete this._renderPipelines[e]}attachCamerasToRenderPipeline(e,t,i=!1){let r=this._renderPipelines[e];r&&r._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){let i=this._renderPipelines[e];i&&i._detachCameras(t)}enableEffectInPipeline(e,t,i){let r=this._renderPipelines[e];r&&r._enableEffect(t,i)}disableEffectInPipeline(e,t,i){let r=this._renderPipelines[e];r&&r._disableEffect(t,i)}update(){for(let e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){let t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(let e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(let e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(rH.x.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let e=this._getComponent(rz.l.NAME_POSTPROCESSRENDERPIPELINEMANAGER);e||(e=new pK(this),this._addComponent(e)),this._postProcessRenderPipelineManager=new pQ}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class pK{constructor(e){this.name=rz.l.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(rz.l.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class pZ extends pq{get automaticBuild(){return this._buildAllowed}set automaticBuild(e){this._buildAllowed=e}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){let e=this.bloom;this.bloom=new pA(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;let t=this.depthOfField;this.depthOfField=new pw(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let e=0;e<this._cameras.length;e++)t.disposeEffects(this._cameras[e]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new ca.c("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return null!=this._glowLayer}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}constructor(e="",t=!0,i=rh.l.LastCreatedScene,r,s=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=0,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new i0.y$,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=r||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=s,this._scene=i;let n=this._scene.getEngine().getCaps();this._hdr=t&&(n.textureHalfFloatRender||n.textureFloatRender),this._hdr?n.textureHalfFloatRender?this._defaultPipelineTextureType=2:n.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);let a=this._scene.getEngine();this.sharpen=new pj("sharpen",1,null,rZ.x.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new pI(a,this.SharpenPostProcessId,()=>this.sharpen,!0),this.depthOfField=new pw(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this._hardwareScaleLevel=a.getHardwareScalingLevel(),this._resizeObserver=a.onResizeObservable.add(()=>{this._hardwareScaleLevel=a.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel}),this.bloom=new pA(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel/this._hardwareScaleLevel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new pM("ChromaticAberration",a.getRenderWidth(),a.getRenderHeight(),1,null,rZ.x.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new pI(a,this.ChromaticAberrationPostProcessId,()=>this.chromaticAberration,!0),this.grain=new pk("Grain",1,null,rZ.x.BILINEAR_SAMPLINGMODE,a,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new pI(a,this.GrainPostProcessId,()=>this.grain,!0);let o=!0;this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add(()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,o?rD.w1.SetImmediate(()=>{this._buildPipeline()}):this._buildPipeline())}),this._buildPipeline(),o=!1}getClassName(){return"DefaultRenderingPipeline"}prepare(){let e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;let e=this._scene.getEngine();if(this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(let e of this._cameras)this._scene.enableDepthRenderer(e).useOnlyInActiveCamera=!0;this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(e=>{this._cameras.indexOf(e.activeCamera)>-1&&(this.depthOfField.depthTexture=e.enableDepthRenderer(e.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);let e=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=e.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new pG("imageProcessing",1,null,rZ.x.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new pI(e,this.ImageProcessingPostProcessId,()=>this.imageProcessing,!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._cameras&&0!==this._cameras.length||(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new pU("fxaa",1,null,rZ.x.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new pI(e,this.FxaaPostProcessId,()=>this.fxaa,!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera))&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add(()=>{this._scene.activeCamera&&-1===this._cameras.indexOf(this._scene.activeCamera)&&(this._scene.autoClear=!0)})),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add(()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)})),this._adaptPostProcessesToViewPort(),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&re.Y.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){let i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){let t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._buildAllowed=!1,this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene._postProcessRenderPipelineManager.removePipeline(this.name),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){let e=rq.p.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return rq.p.Parse(()=>new pZ(e._name,e._name._hdr,t),e,t,i)}}(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"sharpenEnabled",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"bloomKernel",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"_bloomWeight",void 0),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"_bloomThreshold",void 0),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"_hdr",void 0),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"bloomWeight",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"bloomThreshold",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"bloomScale",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"bloomEnabled",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"depthOfFieldEnabled",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"depthOfFieldBlurLevel",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"fxaaEnabled",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"samples",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"imageProcessingEnabled",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"glowLayerEnabled",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"chromaticAberrationEnabled",null),(0,r$.gn)([(0,rj.qC)()],pZ.prototype,"grainEnabled",null),(0,i3.H7)("BABYLON.DefaultRenderingPipeline",pZ),i(31506);let pJ=`uniform sampler2D textureSampler; 
uniform float gain;uniform float threshold;uniform float screen_width;uniform float screen_height;varying vec2 vUV;vec4 highlightColor(vec4 color) {vec4 highlight=color;float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));float lum_threshold;if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);highlight*=luminance*gain;highlight.a=1.0;return highlight;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{vec4 original=texture2D(textureSampler,vUV);if (gain==-1.0) {gl_FragColor=vec4(0.0,0.0,0.0,1.0);return;}
float w=2.0/screen_width;float h=2.0/screen_height;float weight=1.0;vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;gl_FragColor=blurred;}`;sG.v.ShadersStore.lensHighlightsPixelShader=pJ;let p0=`uniform sampler2D textureSampler;uniform sampler2D highlightsSampler;uniform sampler2D depthSampler;uniform sampler2D grainSampler;uniform float grain_amount;uniform bool blur_noise;uniform float screen_width;uniform float screen_height;uniform float distortion;uniform bool dof_enabled;uniform float screen_distance; 
uniform float aperture;uniform float darken;uniform float edge_blur;uniform bool highlights;uniform float near;uniform float far;varying vec2 vUV;
#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1 
vec2 centered_screen_pos;vec2 distorted_coords;float radius2;float radius;vec2 rand(vec2 co)
{float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));return clamp(vec2(noise1,noise2),0.0,1.0);}
vec2 getDistortedCoords(vec2 coords) {if (distortion==0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);vec2 dist_coords=vec2(0.5,0.5);dist_coords.x=0.5+direction.x*radius2*1.0;dist_coords.y=0.5+direction.y*radius2*1.0;float dist_amount=clamp(distortion*0.23,0.0,1.0);dist_coords=mix(coords,dist_coords,dist_amount);return dist_coords;}
float sampleScreen(inout vec4 color,in vec2 offset,in float weight) {vec2 coords=distorted_coords;float angle=rand(coords*100.0).x*TWOPI;coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));color+=texture2D(textureSampler,coords)*weight;return weight;}
float getBlurLevel(float size) {return min(3.0,ceil(size/1.0));}
vec4 getBlurColor(float size) {vec4 col=texture2D(textureSampler,distorted_coords);float blur_level=getBlurLevel(size);float w=(size/screen_width);float h=(size/screen_height);float total_weight=1.0;vec2 sample_coords;total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);if (blur_level>1.0) {total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);}
if (blur_level>2.0) {total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);}
col/=total_weight; 
if (darken>0.0) {col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);}
return col;}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;radius=sqrt(radius2);distorted_coords=getDistortedCoords(vUV); 
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); 
float depth=texture2D(depthSampler,distorted_coords).r; 
float distance=near+(far-near)*depth; 
vec4 color=texture2D(textureSampler,vUV); 
float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));if (dof_enabled==false || coc<0.07) { coc=0.0; }
float edge_blur_amount=0.0;if (edge_blur>0.0) {edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;}
float blur_amount=max(edge_blur_amount,coc);if (blur_amount==0.0) {gl_FragColor=texture2D(textureSampler,distorted_coords);}
else {gl_FragColor=getBlurColor(blur_amount*1.7);if (highlights) {gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;}
if (blur_noise) {vec2 noise=rand(distorted_coords)*0.01*blur_amount;vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;}}
if (grain_amount>0.0) {vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;}}
`;sG.v.ShadersStore.depthOfFieldPixelShader=p0;class p1{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}class p2 extends pq{set epsilon(e){this._epsilon=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO())}get epsilon(){return this._epsilon}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set bypassBlur(e){let t=this._getDefinesForBlur(this.expensiveBlur,e),i=this._getSamplersForBlur(e);this._blurHPostProcess.updateEffect(t.h,null,i),this._blurVPostProcess.updateEffect(t.v,null,i),this._bypassBlur=e}get bypassBlur(){return this._bypassBlur}set expensiveBlur(e){let t=this._getDefinesForBlur(e,this._bypassBlur);this._blurHPostProcess.updateEffect(t.h),this._blurVPostProcess.updateEffect(t.v),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){let e=rh.l.LastCreatedEngine;return!!e&&e._features.supportSSAO2}get scene(){return this._scene}constructor(e,t,i,r,s=!1,n=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._epsilon=.02,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this.radius=2,this.base=0,this._bypassBlur=!1,this._expensiveBlur=!0,this.bilateralSamples=16,this.bilateralSoften=0,this.bilateralTolerance=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._textureType=n,this._forceGeometryBuffer=s,!this.isSupported){re.Y.Error("The current engine does not support SSAO 2.");return}let a=this._ratio.ssaoRatio||i,o=this._ratio.blurRatio||i;this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),t.geometryBufferRenderer?.generateNormalsInWorldSpace&&re.Y.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!")):(t.enablePrePassRenderer(),t.prePassRenderer?.generateNormalsInWorldSpace&&re.Y.Error("SSAO2RenderingPipeline does not support generateNormalsInWorldSpace=true for the prepass renderer!")),this._createRandomTexture(),this._originalColorPostProcess=new sO.Q("SSAOOriginalSceneColor",1,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,this._textureType),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(a,o,this._textureType),this._createSSAOCombinePostProcess(o,this._textureType),this.addEffect(new pI(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){let t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_rebuild(){super._rebuild()}_getSamplersForBlur(e){return e?["textureSampler"]:["textureSampler","depthSampler"]}_getDefinesForBlur(e,t){let i="#define BLUR\n";return t&&(i+="#define BLUR_BYPASS\n"),e||(i+="#define BLUR_LEGACY\n"),{h:i+"#define BLUR_H\n",v:i}}_createBlurPostProcess(e,t,i){let r=this._getDefinesForBlur(this.expensiveBlur,this.bypassBlur),s=this._getSamplersForBlur(this.bypassBlur);this._blurHPostProcess=this._createBlurFilter("BlurH",s,e,r.h,i,!0),this._blurVPostProcess=this._createBlurFilter("BlurV",s,t,r.v,i,!1)}_createBlurFilter(e,t,r,s,n,a){let o=new sD.D(e,"ssao2",["outSize","samples","soften","tolerance"],t,r,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,s,n,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,33212))):t.push(Promise.resolve().then(i.bind(i,23210)))});return o.onApply=e=>{if(!this._scene.activeCamera)return;let t=a?this._ssaoCombinePostProcess.width:this._ssaoCombinePostProcess.height,i=a?this._originalColorPostProcess.width:this._originalColorPostProcess.height;e.setFloat("outSize",t>0?t:i),e.setInt("samples",this.bilateralSamples),e.setFloat("soften",this.bilateralSoften),e.setFloat("tolerance",this.bilateralTolerance),this._geometryBufferRenderer?e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)])},o.samples=this.textureSamples,o.autoClear=!1,o}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(1431655765&this._bits[0])<<1|(2863311530&this._bits[0])>>>1>>>0,this._bits[0]=(858993459&this._bits[0])<<2|(3435973836&this._bits[0])>>>2>>>0,this._bits[0]=(252645135&this._bits[0])<<4|(4042322160&this._bits[0])>>>4>>>0,this._bits[0]=(16711935&this._bits[0])<<8|(4278255360&this._bits[0])>>>8>>>0,23283064365386963e-26*this._bits[0]}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){let i=2*t*Math.PI,r=1-.85*e,s=Math.sqrt(1-r*r);return new i1.P(Math.cos(i)*s,Math.sin(i)*s,r)}_generateHemisphere(){let e;let t=this.samples,i=[],r=0;for(;r<t;){if(t<16)e=this._hemisphereSample_uniform(Math.random(),Math.random());else{let i=this._hammersley(r,t);e=this._hemisphereSample_uniform(i[0],i[1])}i.push(e.x,e.y,e.z),r++}return i}_getDefinesForSSAO(){return`#define SSAO
#define SAMPLES ${this.samples}
#define EPSILON ${this.epsilon.toFixed(4)}`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();let r=this._getDefinesForSSAO();this._ssaoPostProcess=new sD.D("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],["randomSampler","depthSampler","normalSampler"],e,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,r,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,33212))):t.push(Promise.resolve().then(i.bind(i,23210)))}),this._ssaoPostProcess.autoClear=!1,this._ssaoPostProcess.onApply=e=>{if(this._scene.activeCamera){if(e.setArray3("sampleSphere",this._sampleSphere),e.setFloat("randTextureTiles",32),e.setFloat("samplesFactor",1/this.samples),e.setFloat("totalStrength",this.totalStrength),e.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),e.setFloat("radius",this.radius),e.setFloat("maxZ",this.maxZ),e.setFloat("minZAspect",this.minZAspect),e.setFloat("base",this.base),e.setFloat("near",this._scene.activeCamera.minZ),this._scene.activeCamera.mode===rO.V.PERSPECTIVE_CAMERA)e.setMatrix3x3("depthProjection",p2.PERSPECTIVE_DEPTH_PROJECTION),e.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),e.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{let t=this._scene.getEngine().getRenderWidth()/2,i=this._scene.getEngine().getRenderHeight()/2,r=this._scene.activeCamera.orthoLeft??-t,s=this._scene.activeCamera.orthoRight??t,n=this._scene.activeCamera.orthoBottom??-i,a=this._scene.activeCamera.orthoTop??i;e.setMatrix3x3("depthProjection",p2.ORTHO_DEPTH_PROJECTION),e.setFloat("xViewport",(s-r)*.5),e.setFloat("yViewport",(a-n)*.5)}e.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),e.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),e.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),e.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new p1)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new sD.D("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,66393))):t.push(Promise.resolve().then(i.bind(i,35729)))}),this._ssaoCombinePostProcess.onApply=e=>{let t=this._scene.activeCamera.viewport;e.setVector4("viewport",i1.jp.Vector4[0].copyFromFloats(t.x,t.y,t.width,t.height)),e.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.autoClear=!1,this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){let e=new Uint8Array(65536),t=i1.FM.Zero();for(let i=0;i<e.length;)t.set((0,aP.RandomRange)(0,1),(0,aP.RandomRange)(0,1)).normalize().scaleInPlace(255),e[i++]=Math.floor(t.x),e[i++]=Math.floor(t.y),e[i++]=0,e[i++]=255;let i=rK.l.CreateRGBATexture(e,128,128,this._scene,!1,!1,2);i.name="SSAORandomTexture",i.wrapU=rZ.x.WRAP_ADDRESSMODE,i.wrapV=rZ.x.WRAP_ADDRESSMODE,this._randomTexture=i}serialize(){let e=rq.p.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return rq.p.Parse(()=>new p2(e._name,t,e._ratio,void 0,e._forceGeometryBuffer,e._textureType),e,t,i)}}p2.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1],p2.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1],(0,r$.gn)([(0,rj.qC)()],p2.prototype,"totalStrength",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"maxZ",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"minZAspect",void 0),(0,r$.gn)([(0,rj.qC)("epsilon")],p2.prototype,"_epsilon",void 0),(0,r$.gn)([(0,rj.qC)("samples")],p2.prototype,"_samples",void 0),(0,r$.gn)([(0,rj.qC)("textureSamples")],p2.prototype,"_textureSamples",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"_forceGeometryBuffer",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"_ratio",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"_textureType",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"radius",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"base",void 0),(0,r$.gn)([(0,rj.qC)("bypassBlur")],p2.prototype,"_bypassBlur",void 0),(0,r$.gn)([(0,rj.qC)("expensiveBlur")],p2.prototype,"_expensiveBlur",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"bilateralSamples",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"bilateralSoften",void 0),(0,r$.gn)([(0,rj.qC)()],p2.prototype,"bilateralTolerance",void 0),(0,i3.H7)("BABYLON.SSAO2RenderingPipeline",p2);let p3=`uniform sampler2D textureSampler;varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;uniform float randTextureTiles;uniform float samplesFactor;uniform vec3 sampleSphere[SAMPLES];uniform float totalStrength;uniform float radius;uniform float area;uniform float fallOff;uniform float base;vec3 normalFromDepth(float depth,vec2 coords)
{vec2 offset1=vec2(0.0,radius);vec2 offset2=vec2(radius,0.0);float depth1=texture2D(textureSampler,coords+offset1).r;float depth2=texture2D(textureSampler,coords+offset2).r;vec3 p1=vec3(offset1,depth1-depth);vec3 p2=vec3(offset2,depth2-depth);vec3 normal=cross(p1,p2);normal.z=-normal.z;return normalize(normal);}
void main()
{vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);float depth=texture2D(textureSampler,vUV).r;vec3 position=vec3(vUV,depth);vec3 normal=normalFromDepth(depth,vUV);float radiusDepth=radius/depth;float occlusion=0.0;vec3 ray;vec3 hemiRay;float occlusionDepth;float difference;for (int i=0; i<SAMPLES; i++)
{ray=radiusDepth*reflect(sampleSphere[i],random);hemiRay=position+sign(dot(ray,normal))*ray;occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;difference=depth-occlusionDepth;occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));}
float ao=1.0-totalStrength*occlusion*samplesFactor;float result=clamp(ao+base,0.0,1.0);gl_FragColor.r=result;gl_FragColor.g=result;gl_FragColor.b=result;gl_FragColor.a=1.0;}
#endif
`;sG.v.ShadersStore.ssaoPixelShader=p3,i(35729);class p4 extends pq{get scene(){return this._scene}constructor(e,t,i,r){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();let s=i.ssaoRatio||i,n=i.combineRatio||i;this._originalColorPostProcess=new sO.Q("SSAOOriginalSceneColor",n,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(s),this._createBlurPostProcess(s),this._createSSAOCombinePostProcess(n),this.addEffect(new pI(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new pI(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),r&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,r)}_attachCameras(e,t){for(let i of(super._attachCameras(e,t),this._cameras))this._scene.enableDepthRenderer(i).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let e=0;e<this._scene.cameras.length;e++){let t=this._scene.cameras[e];this._originalColorPostProcess.dispose(t),this._ssaoPostProcess.dispose(t),this._blurHPostProcess.dispose(t),this._blurVPostProcess.dispose(t),this._ssaoCombinePostProcess.dispose(t)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new o2.i("BlurH",new i1.FM(1,0),16,e,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new o2.i("BlurV",new i1.FM(0,1),16,e,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(()=>{let e=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*e}),this._blurVPostProcess.onActivateObservable.add(()=>{let e=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*e})}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){let t=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271];this._ssaoPostProcess=new sD.D("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES 16\n#define SSAO"),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=e=>{this._firstUpdate&&(e.setArray3("sampleSphere",t),e.setFloat("samplesFactor",.0625),e.setFloat("randTextureTiles",4)),e.setFloat("totalStrength",this.totalStrength),e.setFloat("radius",this.radius),e.setFloat("area",this.area),e.setFloat("fallOff",this.fallOff),e.setFloat("base",this.base),e.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),e.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new sD.D("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,rZ.x.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=e=>{e.setVector4("viewport",i1.jp.Vector4[0].copyFromFloats(0,0,1,1)),e.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){let e=new Uint8Array(1048576);for(let t=0;t<e.length;)e[t++]=Math.floor(255*Math.max(0,(0,aP.RandomRange)(-1,1))),e[t++]=Math.floor(255*Math.max(0,(0,aP.RandomRange)(-1,1))),e[t++]=Math.floor(255*Math.max(0,(0,aP.RandomRange)(-1,1))),e[t++]=255;let t=rK.l.CreateRGBATexture(e,512,512,this._scene,!1,!1,2);t.name="SSAORandomTexture",t.wrapU=rZ.x.WRAP_ADDRESSMODE,t.wrapV=rZ.x.WRAP_ADDRESSMODE,this._randomTexture=t}}(0,r$.gn)([(0,rj.qC)()],p4.prototype,"totalStrength",void 0),(0,r$.gn)([(0,rj.qC)()],p4.prototype,"radius",void 0),(0,r$.gn)([(0,rj.qC)()],p4.prototype,"area",void 0),(0,r$.gn)([(0,rj.qC)()],p4.prototype,"fallOff",void 0),(0,r$.gn)([(0,rj.qC)()],p4.prototype,"base",void 0);class p5{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}let p7=`uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;uniform sampler2D normalSampler;uniform sampler2D positionSampler;
#endif
uniform mat4 view;uniform mat4 projection;uniform float stepSize;uniform float strength;uniform float threshold;uniform float roughnessFactor;uniform float reflectionSpecularFalloffExponent;varying vec2 vUV;
#ifdef SSR_SUPPORTED
struct ReflectionInfo {vec3 color;vec4 coords;};/**
* According to specular,see https:
*/
vec3 fresnelSchlick(float cosTheta,vec3 F0)
{return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);}
/**
* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit
* by sampling multiple reflection pixels.
*/
ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;info.color=vec3(0.0);vec4 projectedCoord;float sampledDepth;for(int i=0; i<SMOOTH_STEPS; i++)
{projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;dir*=0.5;if(depth>0.0)
hitCoord-=dir;else
hitCoord+=dir;info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;}
projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;info.color/=float(SMOOTH_STEPS+1);return info;}
/**
* Tests the given world position (hitCoord) according to the given reflection vector (dir)
* until it finds a collision (means that depth is enough close to say "it's the pixel to sample!").
*/
ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{ReflectionInfo info;vec4 projectedCoord;float sampledDepth;dir*=stepSize;for(int i=0; i<REFLECTION_SAMPLES; i++)
{hitCoord+=dir;projectedCoord=projection*vec4(hitCoord,1.0);projectedCoord.xy/=projectedCoord.w;projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;float depth=sampledDepth-hitCoord.z;
#ifdef RIGHT_HANDED_SCENE
depth*=-1.0;
#endif
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;
#endif
}}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);return info;}
vec3 hash(vec3 a)
{a=fract(a*0.8);a+=dot(a,a.yxz+19.19);return fract((a.xxy+a.yxx)*a.zyx);}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 albedoFull=texture2D(textureSampler,vUV);vec3 albedo=albedoFull.rgb;float spec=texture2D(reflectivitySampler,vUV).r;if (spec==0.0) {gl_FragColor=albedoFull;return;}
vec3 normal=(texture2D(normalSampler,vUV)).xyz;vec3 position=(view*texture2D(positionSampler,vUV)).xyz;vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));float roughness=1.0-texture2D(reflectivitySampler,vUV).a;vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;ReflectionInfo info=getReflectionInfo(jitt+reflected,position);vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);vec3 F0=vec3(0.04);F0 =mix(F0,albedo,spec);vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);
#ifdef RIGHT_HANDED_SCENE
reflected.z*=-1.0;
#endif
float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);float albedoMultiplier=1.0-reflectionMultiplier;vec3 SSR=info.color*fresnel;gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;sG.v.ShadersStore.screenSpaceReflectionPixelShader=p7;class p6 extends sD.D{get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}constructor(e,t,i,r,s,n,a,o=0,l=!1,c=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,r,s,n,a,"#define SSR_SUPPORTED\n#define REFLECTION_SAMPLES 64\n#define SMOOTH_STEPS 5\n",o,void 0,null,l),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=c,this._forceGeometryBuffer){let e=t.enableGeometryBufferRenderer();e&&e.isSupported&&(e.enablePosition=!0,e.enableReflectivity=!0,e.generateNormalsInWorldSpace&&re.Y.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"))}else{let e=t.enablePrePassRenderer();e?.markAsDirty(),e?.generateNormalsInWorldSpace&&re.Y.Error("ScreenSpaceReflectionPostProcess does not support generateNormalsInWorldSpace=true for the prepass renderer!"),this._prePassEffectConfiguration=new p5}this._updateEffectDefines(),this.onApply=e=>{let i=this._geometryBufferRenderer,r=this._prePassRenderer;if(!r&&!i)return;if(i){let t=i.getTextureIndex(pH.POSITION_TEXTURE_TYPE),r=i.getTextureIndex(pH.REFLECTIVITY_TEXTURE_TYPE);e.setTexture("normalSampler",i.getGBuffer().textures[1]),e.setTexture("positionSampler",i.getGBuffer().textures[t]),e.setTexture("reflectivitySampler",i.getGBuffer().textures[r])}else if(r){let t=r.getIndex(1),i=r.getIndex(3),s=r.getIndex(6);e.setTexture("normalSampler",r.getRenderTarget().textures[s]),e.setTexture("positionSampler",r.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",r.getRenderTarget().textures[i])}let s=t.activeCamera;if(!s)return;let n=s.getViewMatrix(!0),a=s.getProjectionMatrix(!0);e.setMatrix("projection",a),e.setMatrix("view",n),e.setFloat("threshold",this.threshold),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){let e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join("\n"))}static _Parse(e,t,i,r){return rq.p.Parse(()=>new p6(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],p6.prototype,"threshold",void 0),(0,r$.gn)([(0,rj.qC)()],p6.prototype,"strength",void 0),(0,r$.gn)([(0,rj.qC)()],p6.prototype,"reflectionSpecularFalloffExponent",void 0),(0,r$.gn)([(0,rj.qC)()],p6.prototype,"step",void 0),(0,r$.gn)([(0,rj.qC)()],p6.prototype,"roughnessFactor",void 0),(0,r$.gn)([(0,rj.qC)()],p6.prototype,"enableSmoothReflections",null),(0,r$.gn)([(0,rj.qC)()],p6.prototype,"reflectionSamples",null),(0,r$.gn)([(0,rj.qC)()],p6.prototype,"smoothSteps",null),(0,i3.H7)("BABYLON.ScreenSpaceReflectionPostProcess",p6);let p8=`uniform sampler2D textureSampler;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
#if defined(PASS_POST_PROCESS)
void main(void)
{vec4 color=texture2D(textureSampler,vUV);gl_FragColor=color;}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+dsOffsets[0]);average+=texture2D(textureSampler,vUV+dsOffsets[1]);average+=texture2D(textureSampler,vUV+dsOffsets[2]);average+=texture2D(textureSampler,vUV+dsOffsets[3]);average+=texture2D(textureSampler,vUV+dsOffsets[4]);average+=texture2D(textureSampler,vUV+dsOffsets[5]);average+=texture2D(textureSampler,vUV+dsOffsets[6]);average+=texture2D(textureSampler,vUV+dsOffsets[7]);average+=texture2D(textureSampler,vUV+dsOffsets[8]);average+=texture2D(textureSampler,vUV+dsOffsets[9]);average+=texture2D(textureSampler,vUV+dsOffsets[10]);average+=texture2D(textureSampler,vUV+dsOffsets[11]);average+=texture2D(textureSampler,vUV+dsOffsets[12]);average+=texture2D(textureSampler,vUV+dsOffsets[13]);average+=texture2D(textureSampler,vUV+dsOffsets[14]);average+=texture2D(textureSampler,vUV+dsOffsets[15]);average/=16.0;gl_FragColor=average;}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];uniform float brightThreshold;void main(void)
{vec4 average=vec4(0.0,0.0,0.0,0.0);average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));average*=0.25;float luminance=length(average.rgb);if (luminance<brightThreshold) {average=vec4(0.0,0.0,0.0,1.0);}
gl_FragColor=average;}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;uniform sampler2D lensSampler;uniform float exposure;void main(void)
{vec3 colour=texture2D(textureSampler,vUV).rgb;colour*=exposure;vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);colour=retColor*retColor;colour+=colour*texture2D(lensSampler,vUV).rgb;vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);gl_FragColor=finalColor;}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;uniform mat4 lightWorld;uniform vec3 cameraPosition;uniform vec3 sunDirection;uniform vec3 sunColor;uniform vec2 depthValues;uniform float scatteringCoefficient;uniform float scatteringPower;uniform sampler2D shadowMapSampler;uniform sampler2D positionSampler;float computeScattering(float lightDotView)
{float result=1.0-scatteringCoefficient*scatteringCoefficient;result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));return result;}
void main(void)
{vec3 worldPos=texture2D(positionSampler,vUV).rgb;vec3 startPosition=cameraPosition;vec3 rayVector=worldPos-startPosition;float rayLength=length(rayVector);vec3 rayDirection=rayVector/rayLength;float stepLength=rayLength/NB_STEPS;vec3 stepL=rayDirection*stepLength;vec3 currentPosition=startPosition;vec3 accumFog=vec3(0.0);for (int i=0; i<int(NB_STEPS); i++)
{vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);float shadowPixelDepth=clamp(depthMetric,0.0,1.0);worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));currentPosition+=stepL;}
accumFog/=NB_STEPS;vec3 color=accumFog*scatteringPower;gl_FragColor=vec4(color*exp(color) ,1.0);}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;void main(void)
{gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];void main()
{float average=0.0;vec4 color=vec4(0.0);float maximum=-1e20;vec3 weight=vec3(0.299,0.587,0.114);for (int i=0; i<4; i++)
{color=texture2D(textureSampler,vUV+ lumOffsets[i]);float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));
#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);average+=(0.25*log(1e-5+GreyValue));}
average=exp(average);gl_FragColor=vec4(average,maximum,0.0,1.0);}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{vec4 color=vec4(0.0);float average=0.0;for (int i=0; i<9; i++)
{color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);average+=color.r;}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;uniform float averageLuminance;void main()
{vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;color=adjustedColor;color.a=1.0;
#endif
gl_FragColor=color;}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;uniform float strength;uniform float ghostDispersal;uniform float haloWidth;uniform vec2 resolution;uniform float distortionStrength;float hash(vec2 p)
{float h=dot(p,vec2(127.1,311.7));return -1.0+2.0*fract(sin(h)*43758.5453123);}
float noise(in vec2 p)
{vec2 i=floor(p);vec2 f=fract(p);vec2 u=f*f*(3.0-2.0*f);return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);}
float fbm(vec2 p)
{float f=0.0;f+=0.5000*noise(p); p*=2.02;f+=0.2500*noise(p); p*=2.03;f+=0.1250*noise(p); p*=2.01;f+=0.0625*noise(p); p*=2.04;f/=0.9375;return f;}
vec3 pattern(vec2 uv)
{vec2 p=-1.0+2.0*uv;float p2=dot(p,p);float f=fbm(vec2(15.0*p2))/2.0;float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));return (1.0-f)*vec3(r,g,b);}
float luminance(vec3 color)
{return dot(color.rgb,vec3(0.2126,0.7152,0.0722));}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);}
void main(void)
{vec2 uv=-vUV+vec2(1.0);vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;vec2 texelSize=1.0/resolution;vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);vec4 result=vec4(0.0);float ghostIndice=1.0;for (int i=0; i<GHOSTS; ++i)
{vec2 offset=fract(uv+ghostDir*ghostIndice);float weight=length(vec2(0.5)-offset)/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;ghostIndice+=1.0;}
vec2 haloVec=normalize(ghostDir)*haloWidth;float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));weight=pow(1.0-weight,10.0);result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));gl_FragColor=result;}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;uniform sampler2D lensDirtSampler;uniform sampler2D lensStarSampler;uniform mat4 lensStarMatrix;void main(void)
{vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;vec4 lensMod=texture2D(lensDirtSampler,vUV);lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);vec4 result=texture2D(textureSampler,vUV)*lensMod;gl_FragColor=texture2D(otherSampler,vUV)+result;}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;uniform sampler2D depthSampler;uniform float distance;void main(void)
{vec4 sharp=texture2D(otherSampler,vUV);vec4 blur=texture2D(textureSampler,vUV);float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);float factor=0.0;if (dist<0.05)
factor=1.0;else if (dist<0.1)
factor=20.0*(0.1-dist);else if (dist<0.5)
factor=0.0;else
factor=2.0*(dist-0.5);factor=clamp(factor,0.0,0.90);gl_FragColor=mix(sharp,blur,factor);}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;uniform mat4 prevViewProjection;uniform vec2 screenSize;uniform float motionScale;uniform float motionStrength;uniform sampler2D depthSampler;void main(void)
{vec2 texelSize=1.0/screenSize;float depth=texture2D(depthSampler,vUV).r;vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);cpos=cpos*inverseViewProjection;vec4 ppos=cpos*prevViewProjection;ppos.xyz/=ppos.w;ppos.xy=ppos.xy*0.5+0.5;vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;float speed=length(velocity/texelSize);int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));vec4 result=texture2D(textureSampler,vUV);for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {if (i>=nSamples)
break;vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);result+=texture2D(textureSampler,offset1);}
gl_FragColor=result/float(nSamples);}
#endif
`;sG.v.ShadersStore.standardPixelShader=p8;class p9 extends pq{get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){let t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join("\n"))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){let t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer()){re.Y.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect("#define VLS\n#define NB_STEPS "+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect("#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}constructor(e,t,i,r=null,s){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=s||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=r,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}_buildPipeline(){let e=this._ratio,t=this._scene;this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new p6("HDRPass",t,e,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess}),this.addEffect(new pI(t.getEngine(),"HDRScreenSpaceReflections",()=>this.screenSpaceReflectionPostProcess,!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new sD.D("HDRPass","standard",[],[],e,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.originalPostProcess}),this.addEffect(new pI(t.getEngine(),"HDRPassPostProcess",()=>this.originalPostProcess,!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new sD.D("HDRDepthOfFieldSource","standard",[],[],e,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pI(t.getEngine(),"HDRBaseDepthOfFieldSource",()=>this.textureAdderFinalPostProcess,!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new sD.D("HDRVLSFinal","standard",[],[],e,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pI(t.getEngine(),"HDRVLSFinal",()=>this.volumetricLightFinalPostProcess,!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new sD.D("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pI(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",()=>this.lensFlareFinalPostProcess,!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new sD.D("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new pI(t.getEngine(),"HDRPostHDReDepthOfFieldSource",()=>this.hdrFinalPostProcess,!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new pU("fxaa",1,null,rZ.x.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new pI(t.getEngine(),"HDRFxaa",()=>this.fxaaPostProcess,!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&re.Y.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){let i=Array(32);this.downSampleX4PostProcess=new sD.D("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=e=>{let t=0,r=this.downSampleX4PostProcess.width,s=this.downSampleX4PostProcess.height;for(let e=-2;e<2;e++)for(let n=-2;n<2;n++)i[t]=1/r*(e+.5),i[t+1]=1/s*(n+.5),t+=2;e.setArray2("dsOffsets",i)},this.addEffect(new pI(e.getEngine(),"HDRDownSampleX4",()=>this.downSampleX4PostProcess,!0))}_createBrightPassPostProcess(e,t){let i=Array(8);this.brightPassPostProcess=new sD.D("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=e=>{let t=1/this.brightPassPostProcess.width,r=1/this.brightPassPostProcess.height;i[0]=-.5*t,i[1]=.5*r,i[2]=.5*t,i[3]=.5*r,i[4]=-.5*t,i[5]=-.5*r,i[6]=.5*t,i[7]=-.5*r,e.setArray2("dsOffsets",i),e.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new pI(e.getEngine(),"HDRBrightPass",()=>this.brightPassPostProcess,!0))}_createBlurPostProcesses(e,t,i,r="blurWidth"){let s=e.getEngine(),n=new o2.i("HDRBlurH_"+i,new i1.FM(1,0),this[r],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),a=new o2.i("HDRBlurV_"+i,new i1.FM(0,1),this[r],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);n.onActivateObservable.add(()=>{let e=n.width/s.getRenderWidth();n.kernel=this[r]*e}),a.onActivateObservable.add(()=>{let e=a.height/s.getRenderHeight();a.kernel=this.horizontalBlur?64*e:this[r]*e}),this.addEffect(new pI(e.getEngine(),"HDRBlurH"+i,()=>n,!0)),this.addEffect(new pI(e.getEngine(),"HDRBlurV"+i,()=>a,!0)),this.blurHPostProcesses.push(n),this.blurVPostProcesses.push(a)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new sD.D("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),e.setTexture("lensSampler",this.lensTexture),e.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new pI(e.getEngine(),"HDRTextureAdder",()=>this.textureAdderPostProcess,!0))}_createVolumetricLightPostProcess(e,t){let i=e.enableGeometryBufferRenderer();i.enablePosition=!0;let r=i.getGBuffer();this.volumetricLightPostProcess=new sD.D("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLS\n#define NB_STEPS "+this._volumetricLightStepsCount.toFixed(1));let s=i1.FM.Zero();this.volumetricLightPostProcess.onApply=e=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){let t=this.sourceLight.getShadowGenerator();e.setTexture("shadowMapSampler",t.getShadowMap()),e.setTexture("positionSampler",r.textures[2]),e.setColor3("sunColor",this.sourceLight.diffuse),e.setVector3("sunDirection",this.sourceLight.getShadowDirection()),e.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),e.setMatrix("shadowViewProjection",t.getTransformMatrix()),e.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),e.setFloat("scatteringPower",this.volumetricLightPower),s.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),s.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),e.setVector2("depthValues",s)}},this.addEffect(new pI(e.getEngine(),"HDRVLS",()=>this.volumetricLightPostProcess,!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new sD.D("HDRVLSMerge","standard",[],["originalSampler"],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=e=>{e.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new pI(e.getEngine(),"HDRVLSMerge",()=>this.volumetricLightMergePostProces,!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,p9.LuminanceSteps);this.luminancePostProcess=new sD.D("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);let r=[];this.luminancePostProcess.onApply=e=>{let t=1/this.luminancePostProcess.width,i=1/this.luminancePostProcess.height;r[0]=-.5*t,r[1]=.5*i,r[2]=.5*t,r[3]=.5*i,r[4]=-.5*t,r[5]=-.5*i,r[6]=.5*t,r[7]=-.5*i,e.setArray2("lumOffsets",r)},this.addEffect(new pI(e.getEngine(),"HDRLuminance",()=>this.luminancePostProcess,!0));for(let r=p9.LuminanceSteps-1;r>=0;r--){i=Math.pow(3,r);let s="#define LUMINANCE_DOWN_SAMPLE\n";0===r&&(s+="#define FINAL_DOWN_SAMPLER");let n=new sD.D("HDRLuminanceDownSample"+r,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,t);this.luminanceDownSamplePostProcesses.push(n)}let s=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach((t,i)=>{let r=Array(18);t.onApply=e=>{if(!s)return;let n=0;for(let e=-1;e<2;e++)for(let t=-1;t<2;t++)r[n]=e/s.width,r[n+1]=t/s.height,n+=2;e.setArray2("dsOffsets",r),e.setFloat("halfDestPixelSize",.5/s.width),s=i===this.luminanceDownSamplePostProcesses.length-1?this.luminancePostProcess:t},i===this.luminanceDownSamplePostProcesses.length-1&&(t.onAfterRender=()=>{let t=e.getEngine().readPixels(0,0,1,1),i=new i1.Lt(6030862941101084e-23,1/65025,1/255,1);t.then(e=>{let t=new Uint8Array(e.buffer);this._hdrCurrentLuminance=(t[0]*i.x+t[1]*i.y+t[2]*i.z+t[3]*i.w)/100})}),this.addEffect(new pI(e.getEngine(),"HDRLuminanceDownSample"+i,()=>t,!0))})}_createHdrPostProcess(e,t){let i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new sD.D("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join("\n"),0);let r=1,s=0,n=0;this.hdrPostProcess.onApply=t=>{if(t.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),s+=e.getEngine().getDeltaTime(),r<0)r=this._hdrCurrentLuminance;else{let e=(n-s)/1e3;this._hdrCurrentLuminance<r+this.hdrDecreaseRate*e?r+=this.hdrDecreaseRate*e:this._hdrCurrentLuminance>r-this.hdrIncreaseRate*e?r-=this.hdrIncreaseRate*e:r=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/r:(r=(0,aP.Clamp)(r,this.hdrMinimumLuminance,1e20),t.setFloat("averageLuminance",r)),n=s,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new pI(e.getEngine(),"HDR",()=>this.hdrPostProcess,!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new sD.D("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new pI(e.getEngine(),"HDRLensFlare",()=>this.lensFlarePostProcess,!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new sD.D("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new pI(e.getEngine(),"HDRLensFlareCompose",()=>this.lensFlareComposePostProcess,!0));let i=new i1.FM(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=e=>{e.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),e.setTexture("lensColorSampler",this.lensColorTexture),e.setFloat("strength",this.lensFlareStrength),e.setFloat("ghostDispersal",this.lensFlareGhostDispersal),e.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,e.setVector2("resolution",i),e.setFloat("distortionStrength",this.lensFlareDistortionStrength)};let r=i1.y3.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),s=i1.y3.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=e=>{if(!this._scene.activeCamera)return;e.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),e.setTexture("lensDirtSampler",this.lensFlareDirtTexture),e.setTexture("lensStarSampler",this.lensStarTexture);let t=this._scene.activeCamera.getViewMatrix().getRow(0),i=this._scene.activeCamera.getViewMatrix().getRow(2),n=i1.P.Dot(t.toVector3(),new i1.P(1,0,0))+i1.P.Dot(i.toVector3(),new i1.P(0,0,1));n*=4;let a=i1.y3.FromValues(.5*Math.cos(n),-Math.sin(n),0,0,Math.sin(n),.5*Math.cos(n),0,0,0,0,1,0,0,0,0,1),o=s.multiply(a).multiply(r);e.setMatrix("lensStarMatrix",o),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new sD.D("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=e=>{e.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),e.setTexture("depthSampler",this._getDepthTexture()),e.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new pI(e.getEngine(),"HDRDepthOfField",()=>this.depthOfFieldPostProcess,!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){let i=new pX("HDRMotionBlur",e,t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new sD.D("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,rZ.x.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define MOTION_BLUR\n#define MAX_MOTION_SAMPLES "+this.motionBlurSamples.toFixed(1),0);let i=0,r=i1.y3.Identity(),s=i1.y3.Identity(),n=i1.y3.Identity(),a=i1.FM.Zero();this.motionBlurPostProcess.onApply=t=>{(n=e.getProjectionMatrix().multiply(e.getViewMatrix())).invertToRef(s),t.setMatrix("inverseViewProjection",s),t.setMatrix("prevViewProjection",r),r=n,a.x=this.motionBlurPostProcess.width,a.y=this.motionBlurPostProcess.height,t.setVector2("screenSize",a),i=e.getEngine().getFps()/60,t.setFloat("motionScale",i),t.setFloat("motionStrength",this.motionStrength),t.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new pI(e.getEngine(),"HDRMotionBlur",()=>this.motionBlurPostProcess,!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){let t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let e=0;e<this.luminanceDownSamplePostProcesses.length;e++)this.luminanceDownSamplePostProcesses[e].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let e=0;e<this.blurHPostProcesses.length;e++)this.blurHPostProcesses[e].dispose(t);for(let e=0;e<this.blurVPostProcesses.length;e++)this.blurVPostProcesses[e].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){let e=rq.p.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=rq.p.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){let r=rq.p.Parse(()=>new p9(e._name,t,e._ratio),e,t,i);return e.sourceLightId&&(r.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&rq.p.Parse(()=>r.screenSpaceReflectionPostProcess,e.screenSpaceReflectionPostProcess,t,i),r}}p9.LuminanceSteps=6,(0,r$.gn)([(0,rj.qC)()],p9.prototype,"brightThreshold",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"blurWidth",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"horizontalBlur",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"exposure",null),(0,r$.gn)([(0,rj.oU)("lensTexture")],p9.prototype,"lensTexture",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"volumetricLightCoefficient",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"volumetricLightPower",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"volumetricLightBlurScale",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"hdrMinimumLuminance",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"hdrDecreaseRate",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"hdrIncreaseRate",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"hdrAutoExposure",null),(0,r$.gn)([(0,rj.oU)("lensColorTexture")],p9.prototype,"lensColorTexture",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"lensFlareStrength",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"lensFlareGhostDispersal",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"lensFlareHaloWidth",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"lensFlareDistortionStrength",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"lensFlareBlurWidth",void 0),(0,r$.gn)([(0,rj.oU)("lensStarTexture")],p9.prototype,"lensStarTexture",void 0),(0,r$.gn)([(0,rj.oU)("lensFlareDirtTexture")],p9.prototype,"lensFlareDirtTexture",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"depthOfFieldDistance",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"depthOfFieldBlurWidth",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"motionStrength",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"objectBasedMotionBlur",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"_ratio",void 0),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"BloomEnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"DepthOfFieldEnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"LensFlareEnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"HDREnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"VLSEnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"MotionBlurEnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"fxaaEnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"screenSpaceReflectionsEnabled",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"volumetricLightStepsCount",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"motionBlurSamples",null),(0,r$.gn)([(0,rj.qC)()],p9.prototype,"samples",null),(0,i3.H7)("BABYLON.StandardRenderingPipeline",p9);class me{constructor(e=!1){this.enabled=!1,this.name="screenSpaceReflections2",this.texturesRequired=[6,3],this.texturesRequired.push(e?10:5)}}let mt=i1.y3.Compose(new i1.P(.5,.5,.5),i1._f.Identity(),new i1.P(.5,.5,.5)),mi=i1.y3.Compose(new i1.P(.5,.5,1),i1._f.Identity(),new i1.P(.5,.5,0));class mr extends pq{set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}get reflectivityThreshold(){return this._reflectivityThreshold}set reflectivityThreshold(e){e!==this._reflectivityThreshold&&(0===e&&0!==this._reflectivityThreshold||0!==e&&0===this._reflectivityThreshold?(this._reflectivityThreshold=e,this._buildPipeline()):this._reflectivityThreshold=e)}get ssrDownsample(){return this._ssrDownsample}set ssrDownsample(e){e!==this._ssrDownsample&&(this._ssrDownsample=e,this._buildPipeline())}get blurDispersionStrength(){return this._blurDispersionStrength}set blurDispersionStrength(e){if(e===this._blurDispersionStrength)return;let t=0===e&&0!==this._blurDispersionStrength||0!==e&&0===this._blurDispersionStrength;this._blurDispersionStrength=e,t&&this._buildPipeline()}_useBlur(){return this._blurDispersionStrength>0}get blurDownsample(){return this._blurDownsample}set blurDownsample(e){e!==this._blurDownsample&&(this._blurDownsample=e,this._buildPipeline())}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e,this._updateEffectDefines()}get environmentTextureIsProbe(){return this._environmentTextureIsProbe}set environmentTextureIsProbe(e){this._environmentTextureIsProbe=e,this._updateEffectDefines()}get attenuateScreenBorders(){return this._attenuateScreenBorders}set attenuateScreenBorders(e){this._attenuateScreenBorders!==e&&(this._attenuateScreenBorders=e,this._updateEffectDefines())}get attenuateIntersectionDistance(){return this._attenuateIntersectionDistance}set attenuateIntersectionDistance(e){this._attenuateIntersectionDistance!==e&&(this._attenuateIntersectionDistance=e,this._updateEffectDefines())}get attenuateIntersectionIterations(){return this._attenuateIntersectionIterations}set attenuateIntersectionIterations(e){this._attenuateIntersectionIterations!==e&&(this._attenuateIntersectionIterations=e,this._updateEffectDefines())}get attenuateFacingCamera(){return this._attenuateFacingCamera}set attenuateFacingCamera(e){this._attenuateFacingCamera!==e&&(this._attenuateFacingCamera=e,this._updateEffectDefines())}get attenuateBackfaceReflection(){return this._attenuateBackfaceReflection}set attenuateBackfaceReflection(e){this._attenuateBackfaceReflection!==e&&(this._attenuateBackfaceReflection=e,this._updateEffectDefines())}get clipToFrustum(){return this._clipToFrustum}set clipToFrustum(e){this._clipToFrustum!==e&&(this._clipToFrustum=e,this._updateEffectDefines())}get useFresnel(){return this._useFresnel}set useFresnel(e){this._useFresnel!==e&&(this._useFresnel=e,this._buildPipeline())}get enableAutomaticThicknessComputation(){return this._enableAutomaticThicknessComputation}set enableAutomaticThicknessComputation(e){this._enableAutomaticThicknessComputation!==e&&(this._enableAutomaticThicknessComputation=e,this._buildPipeline())}get backfaceDepthRenderer(){return this._depthRenderer}get backfaceDepthTextureDownsample(){return this._backfaceDepthTextureDownsample}set backfaceDepthTextureDownsample(e){this._backfaceDepthTextureDownsample!==e&&(this._backfaceDepthTextureDownsample=e,this._resizeDepthRenderer())}get backfaceForceDepthWriteTransparentMeshes(){return this._backfaceForceDepthWriteTransparentMeshes}set backfaceForceDepthWriteTransparentMeshes(e){this._backfaceForceDepthWriteTransparentMeshes!==e&&(this._backfaceForceDepthWriteTransparentMeshes=e,this._depthRenderer&&(this._depthRenderer.forceDepthWriteTransparentMeshes=e))}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get inputTextureColorIsInGammaSpace(){return this._inputTextureColorIsInGammaSpace}set inputTextureColorIsInGammaSpace(e){this._inputTextureColorIsInGammaSpace!==e&&(this._inputTextureColorIsInGammaSpace=e,this._buildPipeline())}get generateOutputInGammaSpace(){return this._generateOutputInGammaSpace}set generateOutputInGammaSpace(e){this._generateOutputInGammaSpace!==e&&(this._generateOutputInGammaSpace=e,this._buildPipeline())}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._buildPipeline())}getScene(){return this._scene}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}get scene(){return this._scene}get isSupported(){let e=this._scene.getEngine().getCaps();return e.drawBuffersExtension&&e.texelFetch}constructor(e,t,i,r=!1,s=0,n=!1){if(super(t.getEngine(),e),this.SSRRenderEffect="SSRRenderEffect",this.SSRBlurRenderEffect="SSRBlurRenderEffect",this.SSRCombineRenderEffect="SSRCombineRenderEffect",this._samples=1,this.maxDistance=1e3,this.step=1,this.thickness=.5,this.strength=1,this.reflectionSpecularFalloffExponent=1,this.maxSteps=1e3,this.roughnessFactor=.2,this.selfCollisionNumSkip=1,this._reflectivityThreshold=.04,this._ssrDownsample=0,this._blurDispersionStrength=.03,this._blurDownsample=0,this._enableSmoothReflections=!1,this._useScreenspaceDepth=!1,this._environmentTextureIsProbe=!1,this._attenuateScreenBorders=!0,this._attenuateIntersectionDistance=!0,this._attenuateIntersectionIterations=!0,this._attenuateFacingCamera=!1,this._attenuateBackfaceReflection=!1,this._clipToFrustum=!0,this._useFresnel=!1,this._enableAutomaticThicknessComputation=!1,this._backfaceDepthTextureDownsample=0,this._backfaceForceDepthWriteTransparentMeshes=!0,this._isEnabled=!0,this._inputTextureColorIsInGammaSpace=!0,this._generateOutputInGammaSpace=!0,this._debug=!1,this._forceGeometryBuffer=!1,this._isDirty=!1,this._camerasToBeAttached=[],this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=s,this._forceGeometryBuffer=r,this._useScreenspaceDepth=n,this.isSupported){if(t.postProcessRenderPipelineManager.addPipeline(this),this._forceGeometryBuffer){let e=t.enableGeometryBufferRenderer();e&&(e.enableReflectivity=!0,e.useSpecificClearForDepthTexture=!0,e.enableScreenspaceDepth=this._useScreenspaceDepth,e.enableDepth=!this._useScreenspaceDepth)}else{let e=t.enablePrePassRenderer();e&&(e.useSpecificClearForDepthTexture=!0,e.markAsDirty())}this._buildPipeline()}}getClassName(){return"SSRRenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){let t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(e=!1){this._disposeDepthRenderer(),this._disposePostProcesses(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}_getTextureSize(){let e=this._scene.getEngine(),t=this._prePassRenderer,i={width:e.getRenderWidth(),height:e.getRenderHeight()};if(t&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){let e=t.getRenderTarget();e&&e.textures&&(i=e.textures[t.getIndex(4)].getSize())}else this._ssrPostProcess?.inputTexture&&(i.width=this._ssrPostProcess.inputTexture.width,i.height=this._ssrPostProcess.inputTexture.height);return i}_updateEffectDefines(){let e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define SSRAYTRACE_ENABLE_REFINEMENT"),this._scene.useRightHandedSystem&&e.push("#define SSRAYTRACE_RIGHT_HANDED_SCENE"),this._useScreenspaceDepth&&e.push("#define SSRAYTRACE_SCREENSPACE_DEPTH"),this._environmentTexture&&(e.push("#define SSR_USE_ENVIRONMENT_CUBE"),this._environmentTexture.boundingBoxSize&&e.push("#define SSR_USE_LOCAL_REFLECTIONMAP_CUBIC"),this._environmentTexture.gammaSpace&&e.push("#define SSR_ENVIRONMENT_CUBE_IS_GAMMASPACE")),this._environmentTextureIsProbe&&e.push("#define SSR_INVERTCUBICMAP"),this._enableAutomaticThicknessComputation&&e.push("#define SSRAYTRACE_USE_BACK_DEPTHBUFFER"),this._attenuateScreenBorders&&e.push("#define SSR_ATTENUATE_SCREEN_BORDERS"),this._attenuateIntersectionDistance&&e.push("#define SSR_ATTENUATE_INTERSECTION_DISTANCE"),this._attenuateIntersectionIterations&&e.push("#define SSR_ATTENUATE_INTERSECTION_NUMITERATIONS"),this._attenuateFacingCamera&&e.push("#define SSR_ATTENUATE_FACING_CAMERA"),this._attenuateBackfaceReflection&&e.push("#define SSR_ATTENUATE_BACKFACE_REFLECTION"),this._clipToFrustum&&e.push("#define SSRAYTRACE_CLIP_TO_FRUSTUM"),this._useBlur()&&e.push("#define SSR_USE_BLUR"),this._debug&&e.push("#define SSRAYTRACE_DEBUG"),this._inputTextureColorIsInGammaSpace&&e.push("#define SSR_INPUT_IS_GAMMA_SPACE"),this._generateOutputInGammaSpace&&e.push("#define SSR_OUTPUT_IS_GAMMA_SPACE"),this._useFresnel&&e.push("#define SSR_BLEND_WITH_FRESNEL"),0===this._reflectivityThreshold&&e.push("#define SSR_DISABLE_REFLECTIVITY_TEST"),(this._geometryBufferRenderer?.generateNormalsInWorldSpace??this._prePassRenderer?.generateNormalsInWorldSpace)&&e.push("#define SSR_NORMAL_IS_IN_WORLDSPACE"),this._geometryBufferRenderer?.normalsAreUnsigned&&e.push("#define SSR_DECODE_NORMAL");let t=this._cameras?.[0];t&&1===t.mode&&e.push("#define ORTHOGRAPHIC_CAMERA"),this._ssrPostProcess?.updateEffect(e.join("\n"))}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled){this._isDirty=!0;return}this._isDirty=!1;let e=this._scene.getEngine();if(this._disposeDepthRenderer(),this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._enableAutomaticThicknessComputation){let e=this._cameras?.[0];e&&(this._depthRendererCamera=e,this._depthRenderer=new c_(this._scene,void 0,void 0,this._useScreenspaceDepth,1,!this._useScreenspaceDepth,"SSRBackDepth"),this._useScreenspaceDepth||(this._depthRenderer.clearColor.r=1e8),this._depthRenderer.reverseCulling=!0,this._depthRenderer.forceDepthWriteTransparentMeshes=this._backfaceForceDepthWriteTransparentMeshes,this._resizeDepthRenderer(),e.customRenderTargets.push(this._depthRenderer.getDepthMap()))}this._createSSRPostProcess(),this.addEffect(new pI(e,this.SSRRenderEffect,()=>this._ssrPostProcess,!0)),this._useBlur()&&(this._createBlurAndCombinerPostProcesses(),this.addEffect(new pI(e,this.SSRBlurRenderEffect,()=>[this._blurPostProcessX,this._blurPostProcessY],!0)),this.addEffect(new pI(e,this.SSRCombineRenderEffect,()=>this._blurCombinerPostProcess,!0))),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_resizeDepthRenderer(){if(!this._depthRenderer)return;let e=this._getTextureSize(),t=this._depthRenderer.getDepthMap().getSize(),i=Math.floor(e.width/(this._backfaceDepthTextureDownsample+1)),r=Math.floor(e.height/(this._backfaceDepthTextureDownsample+1));(t.width!==i||t.height!==r)&&this._depthRenderer.getDepthMap().resize({width:i,height:r})}_disposeDepthRenderer(){if(this._depthRenderer){if(this._depthRendererCamera){let e=this._depthRendererCamera.customRenderTargets.indexOf(this._depthRenderer.getDepthMap())??-1;-1!==e&&this._depthRendererCamera.customRenderTargets.splice(e,1)}this._depthRendererCamera=null,this._depthRenderer.getDepthMap().dispose()}this._depthRenderer=null}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){let t=this._cameras[e];this._ssrPostProcess?.dispose(t),this._blurPostProcessX?.dispose(t),this._blurPostProcessY?.dispose(t),this._blurCombinerPostProcess?.dispose(t)}this._ssrPostProcess=null,this._blurPostProcessX=null,this._blurPostProcessY=null,this._blurCombinerPostProcess=null}_createSSRPostProcess(){this._ssrPostProcess=new sD.D("ssr","screenSpaceReflection2",["projection","invProjectionMatrix","view","invView","thickness","reflectionSpecularFalloffExponent","strength","stepSize","maxSteps","roughnessFactor","projectionPixel","nearPlaneZ","farPlaneZ","maxDistance","selfCollisionNumSkip","vReflectionPosition","vReflectionSize","backSizeFactor","reflectivityThreshold"],["textureSampler","normalSampler","reflectivitySampler","depthSampler","envCubeSampler","backDepthSampler"],1,null,this._textureType,this._scene.getEngine(),!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,71714))):t.push(Promise.resolve().then(i.bind(i,29336)))}),this._updateEffectDefines(),this._ssrPostProcess.onApply=e=>{this._resizeDepthRenderer();let t=this._geometryBufferRenderer,i=this._prePassRenderer;if(!i&&!t)return;if(t){let i=t.getTextureIndex(pH.REFLECTIVITY_TEXTURE_TYPE),r=t.getTextureIndex(pH.NORMAL_TEXTURE_TYPE);if(e.setTexture("normalSampler",t.getGBuffer().textures[r]),e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this._useScreenspaceDepth){let i=t.getTextureIndex(pH.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else{let i=t.getTextureIndex(pH.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}}else if(i){let t=i.getIndex(this._useScreenspaceDepth?10:5),r=i.getIndex(3),s=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[s]),e.setTexture("depthSampler",i.getRenderTarget().textures[t]),e.setTexture("reflectivitySampler",i.getRenderTarget().textures[r])}this._enableAutomaticThicknessComputation&&this._depthRenderer&&(e.setTexture("backDepthSampler",this._depthRenderer.getDepthMap()),e.setFloat("backSizeFactor",this._backfaceDepthTextureDownsample+1));let r=this._scene.activeCamera;if(!r)return;let s=r.getViewMatrix(),n=r.getProjectionMatrix();n.invertToRef(i1.jp.Matrix[0]),s.invertToRef(i1.jp.Matrix[1]),e.setMatrix("projection",n),e.setMatrix("view",s),e.setMatrix("invView",i1.jp.Matrix[1]),e.setMatrix("invProjectionMatrix",i1.jp.Matrix[0]),e.setFloat("thickness",this.thickness),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("strength",this.strength),e.setFloat("stepSize",this.step),e.setFloat("maxSteps",this.maxSteps),e.setFloat("roughnessFactor",this.roughnessFactor),e.setFloat("nearPlaneZ",r.minZ),e.setFloat("farPlaneZ",r.maxZ),e.setFloat("maxDistance",this.maxDistance),e.setFloat("selfCollisionNumSkip",this.selfCollisionNumSkip),e.setFloat("reflectivityThreshold",this._reflectivityThreshold);let a=this._getTextureSize();i1.y3.ScalingToRef(a.width,a.height,1,i1.jp.Matrix[2]),n.multiplyToRef(this._scene.getEngine().isWebGPU?mi:mt,i1.jp.Matrix[3]),i1.jp.Matrix[3].multiplyToRef(i1.jp.Matrix[2],i1.jp.Matrix[4]),e.setMatrix("projectionPixel",i1.jp.Matrix[4]),this._environmentTexture&&(e.setTexture("envCubeSampler",this._environmentTexture),this._environmentTexture.boundingBoxSize&&(e.setVector3("vReflectionPosition",this._environmentTexture.boundingBoxPosition),e.setVector3("vReflectionSize",this._environmentTexture.boundingBoxSize)))},this._ssrPostProcess.samples=this.samples,this._forceGeometryBuffer||(this._ssrPostProcess._prePassEffectConfiguration=new me(this._useScreenspaceDepth))}_createBlurAndCombinerPostProcesses(){let e=this._scene.getEngine();this._blurPostProcessX=new sD.D("SSRblurX","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._ssrDownsample+1):1,null,2,e,!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,11105))):t.push(Promise.resolve().then(i.bind(i,23397)))}),this._blurPostProcessX.autoClear=!1,this._blurPostProcessX.onApplyObservable.add(e=>{let t=this._blurPostProcessX?.inputTexture.width??this._scene.getEngine().getRenderWidth();e.setFloat2("texelOffsetScale",this._blurDispersionStrength/t,0)}),this._blurPostProcessY=new sD.D("SSRblurY","screenSpaceReflection2Blur",["texelOffsetScale"],["textureSampler"],this._useBlur()?1/(this._blurDownsample+1):1,null,2,e,!1,"",this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,11105))):t.push(Promise.resolve().then(i.bind(i,23397)))}),this._blurPostProcessY.autoClear=!1,this._blurPostProcessY.onApplyObservable.add(e=>{let t=this._blurPostProcessY?.inputTexture.height??this._scene.getEngine().getRenderHeight();e.setFloat2("texelOffsetScale",0,this._blurDispersionStrength/t)});let t=["strength","reflectionSpecularFalloffExponent","reflectivityThreshold"],r=["textureSampler","mainSampler","reflectivitySampler"],s="";this._debug&&(s+="#define SSRAYTRACE_DEBUG\n"),this._inputTextureColorIsInGammaSpace&&(s+="#define SSR_INPUT_IS_GAMMA_SPACE\n"),this._generateOutputInGammaSpace&&(s+="#define SSR_OUTPUT_IS_GAMMA_SPACE\n"),this.useFresnel&&(s+="#define SSR_BLEND_WITH_FRESNEL\n",t.push("projection","invProjectionMatrix","nearPlaneZ","farPlaneZ"),r.push("depthSampler","normalSampler")),this._useScreenspaceDepth&&(s+="#define SSRAYTRACE_SCREENSPACE_DEPTH"),0===this._reflectivityThreshold&&(s+="#define SSR_DISABLE_REFLECTIVITY_TEST"),this._blurCombinerPostProcess=new sD.D("SSRblurCombiner","screenSpaceReflection2BlurCombiner",t,r,this._useBlur()?1/(this._blurDownsample+1):1,null,1,e,!1,s,this._textureType,void 0,void 0,void 0,void 0,this._scene.getEngine().isWebGPU?1:0,(e,t)=>{e?t.push(Promise.resolve().then(i.bind(i,31176))):t.push(Promise.resolve().then(i.bind(i,74881)))}),this._blurCombinerPostProcess.autoClear=!1,this._blurCombinerPostProcess.onApplyObservable.add(e=>{let t=this._geometryBufferRenderer,i=this._prePassRenderer;if(i||t){if(i&&this._scene.activeCamera?._getFirstPostProcess()===this._ssrPostProcess){let t=i.getRenderTarget();t&&t.textures&&e.setTexture("mainSampler",t.textures[i.getIndex(4)])}else e.setTextureFromPostProcess("mainSampler",this._ssrPostProcess);if(t){let i=t.getTextureIndex(pH.REFLECTIVITY_TEXTURE_TYPE);if(e.setTexture("reflectivitySampler",t.getGBuffer().textures[i]),this.useFresnel){let i=this._scene.activeCamera;if(i&&this._useScreenspaceDepth&&(e.setFloat("nearPlaneZ",i.minZ),e.setFloat("farPlaneZ",i.maxZ)),e.setTexture("normalSampler",t.getGBuffer().textures[1]),this._useScreenspaceDepth){let i=t.getTextureIndex(pH.SCREENSPACE_DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",t.getGBuffer().textures[i])}else e.setTexture("depthSampler",t.getGBuffer().textures[0])}}else if(i){let t=i.getIndex(3);if(e.setTexture("reflectivitySampler",i.getRenderTarget().textures[t]),this.useFresnel){let t=this._scene.activeCamera;t&&this._useScreenspaceDepth&&(e.setFloat("nearPlaneZ",t.minZ),e.setFloat("farPlaneZ",t.maxZ));let r=i.getIndex(this._useScreenspaceDepth?10:5),s=i.getIndex(6);e.setTexture("normalSampler",i.getRenderTarget().textures[s]),e.setTexture("depthSampler",i.getRenderTarget().textures[r])}}if(e.setFloat("strength",this.strength),e.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),e.setFloat("reflectivityThreshold",this._reflectivityThreshold),this.useFresnel){let t=this._scene.activeCamera;if(t){let i=t.getProjectionMatrix();i.invertToRef(i1.jp.Matrix[0]),e.setMatrix("projection",i),e.setMatrix("invProjectionMatrix",i1.jp.Matrix[0])}}}})}serialize(){let e=rq.p.Serialize(this);return e.customType="SSRRenderingPipeline",e}static Parse(e,t,i){return rq.p.Parse(()=>new mr(e._name,t,e._ratio),e,t,i)}}(0,r$.gn)([(0,rj.qC)()],mr.prototype,"samples",null),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"maxDistance",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"step",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"thickness",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"strength",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"reflectionSpecularFalloffExponent",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"maxSteps",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"roughnessFactor",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"selfCollisionNumSkip",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"_reflectivityThreshold",void 0),(0,r$.gn)([(0,rj.qC)("_ssrDownsample")],mr.prototype,"_ssrDownsample",void 0),(0,r$.gn)([(0,rj.qC)()],mr.prototype,"ssrDownsample",null),(0,r$.gn)([(0,rj.qC)("blurDispersionStrength")],mr.prototype,"_blurDispersionStrength",void 0),(0,r$.gn)([(0,rj.qC)("blurDownsample")],mr.prototype,"_blurDownsample",void 0),(0,r$.gn)([(0,rj.qC)("enableSmoothReflections")],mr.prototype,"_enableSmoothReflections",void 0),(0,r$.gn)([(0,rj.qC)("environmentTexture")],mr.prototype,"_environmentTexture",void 0),(0,r$.gn)([(0,rj.qC)("environmentTextureIsProbe")],mr.prototype,"_environmentTextureIsProbe",void 0),(0,r$.gn)([(0,rj.qC)("attenuateScreenBorders")],mr.prototype,"_attenuateScreenBorders",void 0),(0,r$.gn)([(0,rj.qC)("attenuateIntersectionDistance")],mr.prototype,"_attenuateIntersectionDistance",void 0),(0,r$.gn)([(0,rj.qC)("attenuateIntersectionIterations")],mr.prototype,"_attenuateIntersectionIterations",void 0),(0,r$.gn)([(0,rj.qC)("attenuateFacingCamera")],mr.prototype,"_attenuateFacingCamera",void 0),(0,r$.gn)([(0,rj.qC)("attenuateBackfaceReflection")],mr.prototype,"_attenuateBackfaceReflection",void 0),(0,r$.gn)([(0,rj.qC)("clipToFrustum")],mr.prototype,"_clipToFrustum",void 0),(0,r$.gn)([(0,rj.qC)("useFresnel")],mr.prototype,"_useFresnel",void 0),(0,r$.gn)([(0,rj.qC)("enableAutomaticThicknessComputation")],mr.prototype,"_enableAutomaticThicknessComputation",void 0),(0,r$.gn)([(0,rj.qC)("backfaceDepthTextureDownsample")],mr.prototype,"_backfaceDepthTextureDownsample",void 0),(0,r$.gn)([(0,rj.qC)("backfaceForceDepthWriteTransparentMeshes")],mr.prototype,"_backfaceForceDepthWriteTransparentMeshes",void 0),(0,r$.gn)([(0,rj.qC)("isEnabled")],mr.prototype,"_isEnabled",void 0),(0,r$.gn)([(0,rj.qC)("inputTextureColorIsInGammaSpace")],mr.prototype,"_inputTextureColorIsInGammaSpace",void 0),(0,r$.gn)([(0,rj.qC)("generateOutputInGammaSpace")],mr.prototype,"_generateOutputInGammaSpace",void 0),(0,r$.gn)([(0,rj.qC)("debug")],mr.prototype,"_debug",void 0),(0,i3.H7)("BABYLON.SSRRenderingPipeline",mr);let ms=`varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D historySampler;uniform float factor;void main() {vec4 c=texelFetch(textureSampler,ivec2(gl_FragCoord.xy),0);vec4 h=texelFetch(historySampler,ivec2(gl_FragCoord.xy),0);gl_FragColor=mix(h,c,factor);}
`;sG.v.ShadersStore.taaPixelShader=ms;class mn extends pq{set samples(e){this._samples!==e&&(this._samples=e,this._hs.regenerate(e))}get samples(){return this._samples}set msaaSamples(e){this._msaaSamples!==e&&(this._msaaSamples=e,this._taaPostProcess&&(this._taaPostProcess.samples=e))}get msaaSamples(){return this._msaaSamples}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,e?e&&(this._isDirty?this._buildPipeline():null!==this._cameras&&(this._firstUpdate=!0,this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras))):null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()))}get scene(){return this._scene}get isSupported(){return this._scene.getEngine().getCaps().texelFetch}constructor(e,t,i,r=0){let s=t.getEngine();super(s,e),this.TAARenderEffect="TAARenderEffect",this.TAAPassEffect="TAAPassEffect",this._samples=8,this._msaaSamples=1,this.factor=.05,this.disableOnCameraMove=!0,this._isEnabled=!0,this._isDirty=!1,this._camerasToBeAttached=[],this._pingpong=0,this._firstUpdate=!0,this._cameras=i||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._textureType=r,this._hs=new dg(this.samples),this.isSupported&&(this._createPingPongTextures(s.getRenderWidth(),s.getRenderHeight()),t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline())}getClassName(){return"TAARenderingPipeline"}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){let t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._ping.dispose(),this._pong.dispose(),super.dispose()}_createPingPongTextures(e,t){let i=this._scene.getEngine();this._ping?.dispose(),this._pong?.dispose(),this._ping=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._pong=i.createRenderTargetTexture({width:e,height:t},{generateMipMaps:!1,generateDepthBuffer:!1,type:2,samplingMode:1}),this._hs.setDimensions(e/2,t/2),this._hs.next(),this._firstUpdate=!0}_updateEffectDefines(){this._taaPostProcess?.updateEffect("")}_buildPipeline(){if(!this.isSupported)return;if(!this._isEnabled){this._isDirty=!0;return}this._isDirty=!1;let e=this._scene.getEngine();this._disposePostProcesses(),null!==this._cameras&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._createTAAPostProcess(),this.addEffect(new pI(e,this.TAARenderEffect,()=>this._taaPostProcess,!0)),this._createPassPostProcess(),this.addEffect(new pI(e,this.TAAPassEffect,()=>this._passPostProcess,!0)),null!==this._cameras&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras)}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){let t=this._cameras[e];this._taaPostProcess?.dispose(t),this._passPostProcess?.dispose(t),t.getProjectionMatrix(!0)}this._taaPostProcess=null,this._passPostProcess=null}_createTAAPostProcess(){this._taaPostProcess=new sD.D("TAA","taa",{uniforms:["factor"],samplers:["historySampler"],size:1,engine:this._scene.getEngine(),textureType:this._textureType}),this._taaPostProcess.samples=this._msaaSamples,this._updateEffectDefines(),this._taaPostProcess.onActivateObservable.add(()=>{let e=this._scene.activeCamera;if(this._taaPostProcess?.width!==this._ping.width||this._taaPostProcess?.height!==this._ping.height){let e=this._scene.getEngine();this._createPingPongTextures(e.getRenderWidth(),e.getRenderHeight())}if(e&&!e.hasMoved){if(e.mode===rO.V.PERSPECTIVE_CAMERA){let t=e.getProjectionMatrix();t.setRowFromFloats(2,this._hs.x,this._hs.y,t.m[10],t.m[11])}else{let t=e.getProjectionMatrix(!0);t.setRowFromFloats(3,this._hs.x+t.m[12],this._hs.y+t.m[13],t.m[14],t.m[15])}}this._passPostProcess&&(this._passPostProcess.inputTexture=this._pingpong?this._ping:this._pong),this._pingpong=1^this._pingpong,this._hs.next()}),this._taaPostProcess.onApplyObservable.add(e=>{let t=this._scene.activeCamera;e._bindTexture("historySampler",this._pingpong?this._ping.texture:this._pong.texture),e.setFloat("factor",t?.hasMoved&&this.disableOnCameraMove||this._firstUpdate?1:this.factor),this._firstUpdate=!1})}_createPassPostProcess(){let e=this._scene.getEngine();this._passPostProcess=new sO.Q("TAAPass",1,null,1,e),this._passPostProcess.inputTexture=this._ping,this._passPostProcess.autoClear=!1}serialize(){let e=rq.p.Serialize(this);return e.customType="TAARenderingPipeline",e}static Parse(e,t,i){return rq.p.Parse(()=>new mn(e._name,t,e._ratio),e,t,i)}}(0,r$.gn)([(0,rj.qC)("samples")],mn.prototype,"_samples",void 0),(0,r$.gn)([(0,rj.qC)("msaaSamples")],mn.prototype,"_msaaSamples",void 0),(0,r$.gn)([(0,rj.qC)()],mn.prototype,"factor",void 0),(0,r$.gn)([(0,rj.qC)()],mn.prototype,"disableOnCameraMove",void 0),(0,r$.gn)([(0,rj.qC)("isEnabled")],mn.prototype,"_isEnabled",void 0),(0,i3.H7)("BABYLON.TAARenderingPipeline",mn),i(23210),i(33212),i(66393),i(29336),i(23397),i(74881),i(71714),i(11105),i(31176),(eZ=iG||(iG={}))[eZ.Hable=0]="Hable",eZ[eZ.Reinhard=1]="Reinhard",eZ[eZ.HejiDawson=2]="HejiDawson",eZ[eZ.Photographic=3]="Photographic";let ma=`uniform sampler2D textureSampler;uniform sampler2D lightScatteringSampler;uniform float decay;uniform float exposure;uniform float weight;uniform float density;uniform vec2 meshPositionOnScreen;varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 tc=vUV;vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;float illuminationDecay=1.0;vec4 color=texture2D(lightScatteringSampler,tc)*0.4;for(int i=0; i<NUM_SAMPLES; i++) {tc-=deltaTexCoord;vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;dataSample*=illuminationDecay*weight;color+=dataSample;illuminationDecay*=decay;}
vec4 realColor=texture2D(textureSampler,vUV);gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));
#define CUSTOM_FRAGMENT_MAIN_END
}
`;sG.v.ShadersStore.volumetricLightScatteringPixelShader=ma,i(96944),i(59343);let mo=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;sG.v.ShadersStore.volumetricLightScatteringPassVertexShader=mo;let ml=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);}
`;sG.v.ShadersStore.volumetricLightScatteringPassPixelShader=ml;class mc extends sD.D{get useDiffuseColor(){return re.Y.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){re.Y.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}constructor(e,t,i,r,s=100,n=rZ.x.BILINEAR_SAMPLINGMODE,a,o,l){super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,n,a,o,"#define NUM_SAMPLES "+s),this._screenCoordinates=i1.FM.Zero(),this.customMeshPosition=i1.P.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=[],this.includedMeshes=[],this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,a=(l=i?.getScene()??l??this._scene).getEngine(),this._viewPort=new sk.l(0,0,1,1).toGlobal(a.getRenderWidth(),a.getRenderHeight()),this.mesh=r??mc.CreateDefaultMesh("VolumetricLightScatteringMesh",l),this._createPass(l,t.passRatio||t),this.onActivate=e=>{this.isSupported||this.dispose(e),this.onActivate=null},this.onApplyObservable.add(e=>{this._updateMeshScreenCoordinates(l),e.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),e.setFloat("exposure",this.exposure),e.setFloat("decay",this.decay),e.setFloat("weight",this.weight),e.setFloat("density",this.density),e.setVector2("meshPositionOnScreen",this._screenCoordinates)})}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){let i=e.getMesh();if(i===this.mesh&&i.material)return i.material.isReady(i);let r=i._internalAbstractMeshDataInfo._materialForRenderPass?.[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(i,e,t);let s=[],n=[st.o.PositionKind],a=e.getMaterial();a&&(a.needAlphaTesting()&&s.push("#define ALPHATEST"),i.isVerticesDataPresent(st.o.UVKind)&&(n.push(st.o.UVKind),s.push("#define UV1")),i.isVerticesDataPresent(st.o.UV2Kind)&&(n.push(st.o.UV2Kind),s.push("#define UV2")));let o=new o8.L;if(i.useBones&&i.computeBonesUsingShaders&&i.skeleton){n.push(st.o.MatricesIndicesKind),n.push(st.o.MatricesWeightsKind),i.numBoneInfluencers>4&&(n.push(st.o.MatricesIndicesExtraKind),n.push(st.o.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+i.numBoneInfluencers),i.numBoneInfluencers>0&&o.addCPUSkinningFallback(0,i);let e=i.skeleton;e.isUsingTextureForMatrices?s.push("#define BONETEXTURE"):s.push("#define BonesPerMesh "+(e.bones.length+1))}else s.push("#define NUM_BONE_INFLUENCERS 0");let l=i.morphTargetManager,c=0;l&&(c=l.numMaxInfluencers||l.numInfluencers)>0&&(s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+c),l.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),(0,le.Vk)(n,i,c)),t&&(s.push("#define INSTANCES"),(0,le.y9)(n),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));let u=i.bakedVertexAnimationManager;u&&u.isEnabled&&(s.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&n.push("bakedVertexAnimationSettingsInstanced"));let h=e._getDrawWrapper(void 0,!0),d=h.defines,f=s.join("\n");return d!==f&&h.setEffect(i.getScene().getEngine().createEffect("volumetricLightScatteringPass",{attributes:n,uniformsNames:["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","morphTargetInfluences","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"],uniformBuffersNames:[],samplers:["diffuseSampler","morphTargets","boneSampler","bakedVertexAnimationTexture"],defines:f,fallbacks:o,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:c}},i.getScene().getEngine()),f),h.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){let t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);-1!==t&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.includedMeshes.length>0&&-1===this.includedMeshes.indexOf(e)||this.excludedMeshes.length>0&&-1!==this.excludedMeshes.indexOf(e)}_createPass(e,t){let i;let r=e.getEngine();this._volumetricLightScatteringRTT=new s2._("volumetricLightScatteringMap",{width:r.getRenderWidth()*t,height:r.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;let s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);let n=e=>{let t=e.getRenderingMesh(),i=e.getEffectiveMesh();if(this._meshExcluded(t))return;i._internalAbstractMeshDataInfo._isActiveIntermediate=!1;let r=e.getMaterial();if(!r)return;let s=t.getScene(),n=s.getEngine();n.setState(r.backFaceCulling,void 0,void 0,void 0,r.cullBackFaces);let a=t._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(a.mustReturn)return;let o=n.getCaps().instancedArrays&&(null!==a.visibleInstances[e._id]||t.hasThinInstances);if(this._isReady(e,o)){let l=i._internalAbstractMeshDataInfo._materialForRenderPass?.[n.currentRenderPassId],c=e._getDrawWrapper();if(t!==this.mesh||c||(c=r._getDrawWrapper()),!c)return;let u=c.effect;if(n.enableEffect(c),o||t._bind(e,u,r.fillMode),t===this.mesh)r.bind(i.getWorldMatrix(),t);else if(l)l.bindForSubMesh(i.getWorldMatrix(),i,e);else{if(u.setMatrix("viewProjection",s.getTransformMatrix()),r.needAlphaTesting()){let e=r.getAlphaTestTexture();e&&(u.setTexture("diffuseSampler",e),u.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,le.qx)(t,u),(0,le.KG)(t,u),t.morphTargetManager&&t.morphTargetManager.isUsingTextureForTargets&&t.morphTargetManager._bind(u);let i=e.getMesh().bakedVertexAnimationManager;i&&i.isEnabled&&i.bind(u,o)}o&&t.hasThinInstances&&u.setMatrix("world",i.getWorldMatrix()),t._processRendering(i,e,u,n0.F.TriangleFillMode,a,o,(e,t)=>{e||u.setMatrix("world",t)})}},a=new i2.HE(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(()=>{i=e.clearColor,e.clearColor=a}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(()=>{e.clearColor=i}),this._volumetricLightScatteringRTT.customIsReadyFunction=(e,t,i)=>{if((i||0===t)&&e.subMeshes)for(let t=0;t<e.subMeshes.length;++t){let i=e.subMeshes[t],s=i.getMaterial(),n=i.getRenderingMesh();if(!s)continue;let a=n._getInstancesRenderList(i._id,!!i.getReplacementMesh()),o=r.getCaps().instancedArrays&&(null!==a.visibleInstances[i._id]||n.hasThinInstances);if(!this._isReady(i,o))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(t,i,r,s)=>{let a;let o=e.getEngine();if(s.length){for(o.setColorWrite(!1),a=0;a<s.length;a++)n(s.data[a]);o.setColorWrite(!0)}for(a=0;a<t.length;a++)n(t.data[a]);for(a=0;a<i.length;a++)n(i.data[a]);if(r.length){for(a=0;a<r.length;a++){let t=r.data[a],i=t.getBoundingInfo();i&&e.activeCamera&&(t._alphaIndex=t.getMesh().alphaIndex,t._distanceToCamera=i.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}let t=r.data.slice(0,r.length);for(t.sort((e,t)=>e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0),o.setAlphaMode(2),a=0;a<t.length;a++)n(t[a]);o.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){let t;let i=e.getTransformMatrix();t=this.useCustomMeshPosition?this.customMeshPosition:this.attachedNode?this.attachedNode.position:this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;let r=i1.P.Project(t,i1.y3.Identity(),i,this._viewPort);this._screenCoordinates.x=r.x/this._viewPort.width,this._screenCoordinates.y=r.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){let i=(0,oY.pT)(e,{size:1},t);i.billboardMode=rA.x.BILLBOARDMODE_ALL;let r=new nn.K(e+"Material",t);return r.emissiveColor=new i2.Wo(1,1,1),i.material=r,i}}(0,r$.gn)([(0,rj.hd)()],mc.prototype,"customMeshPosition",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"useCustomMeshPosition",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"invert",void 0),(0,r$.gn)([(0,rj.RR)()],mc.prototype,"mesh",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"excludedMeshes",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"includedMeshes",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"exposure",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"decay",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"weight",void 0),(0,r$.gn)([(0,rj.qC)()],mc.prototype,"density",void 0),(0,i3.H7)("BABYLON.VolumetricLightScatteringPostProcess",mc);let mu=`precision highp float;varying vec2 vUV;uniform sampler2D textureSampler;uniform sampler2D normalSampler;uniform float curvature_ridge;uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{if (curvature<0.5/control)
return curvature*(1.0-curvature*control);return 0.25/control;}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);return 2.0*curvature_soft_clamp(normal_diff,ridge);}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{ivec2 texel=ivec2(gl_FragCoord.xy);vec4 baseColor=texture2D(textureSampler,vUV);float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);baseColor.rgb*=curvature+1.0;gl_FragColor=baseColor;}`;sG.v.ShadersStore.screenSpaceCurvaturePixelShader=mu;class mh extends sD.D{getClassName(){return"ScreenSpaceCurvaturePostProcess"}constructor(e,t,i,r,s,n,a,o=0,l=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,r,s,n,a,void 0,o,void 0,null,l),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?(this._geometryBufferRenderer.generateNormalsInWorldSpace&&re.Y.Error("ScreenSpaceCurvaturePostProcess does not support generateNormalsInWorldSpace=true for the geometry buffer renderer!"),this.onApply=e=>{e.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),e.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));let t=this._geometryBufferRenderer.getGBuffer().textures[1];e.setTexture("normalSampler",t)}):re.Y.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}static get IsSupported(){let e=rh.l.LastCreatedEngine;return!!e&&e.getCaps().drawBuffersExtension}static _Parse(e,t,i,r){return rq.p.Parse(()=>new mh(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,r)}}(0,r$.gn)([(0,rj.qC)()],mh.prototype,"ridge",void 0),(0,r$.gn)([(0,rj.qC)()],mh.prototype,"valley",void 0),(0,i3.H7)("BABYLON.ScreenSpaceCurvaturePostProcess",mh),i(50127),i(6914),i(54378),i(1778),i(74669),i(25250),i(97534),i(89022),i(98974),i(88869),i(57196),i(92516),i(60224),i(22382),i(6459),i(69094),i(78562),i(8290),i(82494),i(56930),i(87320),i(9969),i(65630),i(37846),i(23710),i(71764),i(23798),i(87812),i(75426),i(4527),i(20281),i(51414),i(45147),i(18034),i(57477),i(38458),i(84980),i(55840),i(95759),i(89376),i(56095),i(25232),i(78102),i(47837),i(8983),i(76995),i(99154),i(67169),i(48250),rH.x.prototype.enableDepthRenderer=function(e,t=!1,i=!1,r=3,s=!1){if(!(e=e||this.activeCamera))throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[e.id]){let n=!!this.getEngine().getCaps().textureFloatRender,a=0;a=!this.getEngine().getCaps().textureHalfFloatRender||i&&n?n?1:0:2,this._depthRenderer[e.id]=new c_(this,a,e,t,r,s)}return this._depthRenderer[e.id]},rH.x.prototype.disableDepthRenderer=function(e){(e=e||this.activeCamera)&&this._depthRenderer&&this._depthRenderer[e.id]&&this._depthRenderer[e.id].dispose()};class md{constructor(e){this.name=rz.l.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(rz.l.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(rz.l.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(let e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(let t in this.scene._depthRenderer){let i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(let t in this.scene._depthRenderer){let i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}c_._SceneComponentInitialization=e=>{let t=e._getComponent(rz.l.NAME_DEPTHRENDERER);t||(t=new md(e),e._addComponent(t))};class mf{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class mp{get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){-1===this._excludedMeshes.indexOf(e.uniqueId)&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){let t=this._excludedMeshes.indexOf(e.uniqueId);-1!==t&&this._excludedMeshes.splice(t,1)}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new nV.t(10),this._excludedSubMeshes=new nV.t(10),this._excludedMeshes=[],this._colorCache=[new i2.HE(mp._DEPTH_CLEAR_VALUE,mp._DEPTH_CLEAR_VALUE,0,0),new i2.HE(-mp._MIN_DEPTH,mp._MAX_DEPTH,0,0),new i2.HE(0,0,0,0)],this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._passCount=t,!e.enablePrePassRenderer()){re.Y.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.");return}for(let e=0;e<this._layoutCacheFormat.length;++e)this._layoutCache[e]=this._engine.buildTextureLayout(this._layoutCacheFormat[e]);this._renderPassIds=[],this.useRenderPasses=!1,this._engine.isWebGPU&&(this._shaderLanguage=1),this._prePassEffectConfiguration=new mf,this._createTextures(),this._createEffects()}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){let e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new ud("depthPeelingDepth0MRT",e,3,this._scene,void 0,["depthPeelingDepth0MRT_depth","depthPeelingDepth0MRT_frontColor","depthPeelingDepth0MRT_backColor"]),new ud("depthPeelingDepth1MRT",e,3,this._scene,void 0,["depthPeelingDepth1MRT_depth","depthPeelingDepth1MRT_frontColor","depthPeelingDepth1MRT_backColor"])],this._colorMrts=[new ud("depthPeelingColor0MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor0MRT_frontColor","depthPeelingColor0MRT_backColor"]),new ud("depthPeelingColor1MRT",e,2,this._scene,{generateDepthBuffer:!1},["depthPeelingColor1MRT_frontColor","depthPeelingColor1MRT_backColor"])],this._blendBackMrt=new ud("depthPeelingBackMRT",e,1,this._scene,{generateDepthBuffer:!1},["depthPeelingBackMRT_blendBack"]),this._outputRT=new s2._("depthPeelingOutputRTT",e,this._scene,!1);let t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2,label:"DepthPeelingRenderer-DepthTexture"},{format:5,samplingMode:1,type:2,label:"DepthPeelingRenderer-ColorTexture"}];for(let i=0;i<2;i++){let r=this._engine._createInternalTexture(e,t[0],!1),s=this._engine._createInternalTexture(e,t[1],!1),n=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(r,0),this._depthMrts[i].setInternalTexture(s,1),this._depthMrts[i].setInternalTexture(n,2),this._colorMrts[i].setInternalTexture(s,0),this._colorMrts[i].setInternalTexture(n,1),this._thinTextures.push(new u_.g(r),new u_.g(s),new u_.g(n))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)6!==e&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){let e=this._scene.prePassRenderer;if(!e)return!1;let t=e.getIndex(4),i=e.defaultRT.textures?.length?e.defaultRT.textures[t].getInternalTexture():null;return!!i&&(this._blendBackTexture!==i&&(this._blendBackTexture=i,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new u_.g(this._blendBackTexture),e.defaultRT.renderTarget.shareDepth(this._depthMrts[0].renderTarget)),!0)}_createEffects(){this._blendBackEffectWrapper=new cF.H({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,36050)):await Promise.resolve().then(i.bind(i,50324))}}),this._blendBackEffectWrapperPingPong=new cF.H({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,36050)):await Promise.resolve().then(i.bind(i,50324))}}),this._finalEffectWrapper=new cF.H({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,49407)):await Promise.resolve().then(i.bind(i,31515))}}),this._effectRenderer=new cF.I(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[3*this._currentPingPongState]),e.setTexture("oitFrontColorSampler",this._thinTextures[3*this._currentPingPongState+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){let r;let s=e.data[i].getMaterial(),n=!0,a=!1,o=e.data[i],l=!1;if(this._useRenderPasses&&(l=!(r=o._getDrawWrapper())),s&&(n=s.allowShaderHotSwapping,a=s.backFaceCulling,s.allowShaderHotSwapping=!1,s.backFaceCulling=!1),o.render(!1),l&&(r=o._getDrawWrapper()).materialContext){let e=t[r.materialContext.uniqueId];e||(e=t[r.materialContext.uniqueId]=this._engine.createMaterialContext()),o._getDrawWrapper().materialContext=e}s&&(s.allowShaderHotSwapping=n,s.backFaceCulling=a)}}_finalCompose(e){this._scene.prePassRenderer?.setCustomOutput(this._outputRT)?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[3*e+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}isReady(){return this._blendBackEffectWrapper.effect.isReady()&&this._blendBackEffectWrapperPingPong.effect.isReady()&&this._finalEffectWrapper.effect.isReady()&&this._updateTextures()}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this.isReady())return this._excludedSubMeshes;this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport);for(let t=0;t<e.length;t++){let i=e.data[t],r=i.getMaterial(),s=r&&i.getRenderingMesh()._getRenderingFillMode(r.fillMode);r&&(s===n0.F.TriangleFanDrawMode||s===n0.F.TriangleFillMode||s===n0.F.TriangleStripDrawMode)&&-1===this._excludedMeshes.indexOf(i.getMesh().uniqueId)?this._candidateSubMeshes.push(i):this._excludedSubMeshes.push(i)}if(!this._candidateSubMeshes.length)return this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._finalCompose(1),this._excludedSubMeshes;let t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,r=0;for(let e=0;e<this._passCount;e++){r=1-(i=e%2),this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[e+1]),this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[r].renderTarget),this._engine.bindFramebuffer(this._depthMrts[r].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[r].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();let t=0!==r&&this._useRenderPasses?this._blendBackEffectWrapperPingPong:this._blendBackEffectWrapper;this._engine.enableEffect(t._drawWrapper),t.effect.setTexture("uBackColor",this._thinTextures[3*r+2]),this._effectRenderer.render(t),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(r),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}mp._DEPTH_CLEAR_VALUE=-99999,mp._MIN_DEPTH=0,mp._MAX_DEPTH=1,Object.defineProperty(rH.x.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let e=this._getComponent(rz.l.NAME_DEPTHPEELINGRENDERER);e||(e=new mm(this),this._addComponent(e))}return this._depthPeelingRenderer},set:function(e){this._depthPeelingRenderer=e},enumerable:!0,configurable:!0}),Object.defineProperty(rH.x.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(e){this._useOrderIndependentTransparency!==e&&(this._useOrderIndependentTransparency=e,this.markAllMaterialsAsDirty(63),this.prePassRenderer?.markAsDirty())},enumerable:!0,configurable:!0});class mm{constructor(e){this.name=rz.l.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new mp(e)}register(){}rebuild(){}dispose(){this.scene.depthPeelingRenderer?.dispose(),this.scene.depthPeelingRenderer=null}}rA.x.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this},rA.x.prototype.enableEdgesRendering=function(e=.95,t=!1,i){return this.disableEdgesRendering(),this._edgesRenderer=new mg(this,e,t,!0,i),this},Object.defineProperty(rA.x.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0}),dM._.prototype.enableEdgesRendering=function(e=.95,t=!1){return this.disableEdgesRendering(),this._edgesRenderer=new mv(this,e,t),this},dM.E.prototype.enableEdgesRendering=function(e=.95,t=!1){return dM._.prototype.enableEdgesRendering.apply(this,arguments),this};class m_{constructor(){this.edges=[],this.edgesConnectedCount=0}}class mg{get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e,t){if(!e._edgeRenderLineShader){let r=new nA.j("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"],uniformBuffers:["Scene","Mesh"],shaderLanguage:t,extraInitializationsAsync:async()=>{1===t?await Promise.all([Promise.resolve().then(i.bind(i,87765)),Promise.resolve().then(i.bind(i,89298))]):await Promise.all([Promise.resolve().then(i.bind(i,98370)),Promise.resolve().then(i.bind(i,29688))])}},!1);r.disableDepthWrite=!0,r.backFaceCulling=!1,r.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=r}return e._edgeRenderLineShader}get shaderLanguage(){return this._shaderLanguage}constructor(e,t=.95,i=!1,r=!0,s){this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=[],this._linesNormals=[],this._linesIndices=[],this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new nV.t(32),this._shaderLanguage=0,this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=s??null,this._epsilon=t;let n=this._source.getScene().getEngine();n.isWebGPU&&(this._drawWrapper=new cu.q(n),this._shaderLanguage=1),this._prepareRessources(),r&&(s?.useAlternateEdgeFinder??!0?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}_prepareRessources(){this._lineShader||(this._lineShader=mg._GetShader(this._source.getScene(),this._shaderLanguage))}_rebuild(){let e=this._buffers[st.o.PositionKind];e&&e._rebuild(),(e=this._buffers[st.o.NormalKind])&&e._rebuild();let t=this._source.getScene().getEngine();this._ib=t.createIndexBuffer(this._linesIndices)}dispose(){this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let e=this._buffers[st.o.PositionKind];e&&(e.dispose(),this._buffers[st.o.PositionKind]=null),(e=this._buffers[st.o.NormalKind])&&(e.dispose(),this._buffers[st.o.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),this._drawWrapper?.dispose()}_processEdgeForAdjacencies(e,t,i,r,s){return e===i&&t===r||e===r&&t===i?0:e===r&&t===s||e===s&&t===r?1:e===s&&t===i||e===i&&t===s?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,r,s){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(r,1e-10)||e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(s,1e-10)||e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(r,1e-10)?1:e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(s,1e-10)?2:-1}_checkEdge(e,t,i,r,s){(void 0===t||i1.P.Dot(i[e],i[t])<this._epsilon)&&this.createLine(r,s,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,r){let s=(e,t,i)=>{i>=0&&t.push(i);for(let i=0;i<e.length;++i)t.push(e[i][0])},n=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?n=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(n=2);for(let t=0;t<3;++t)t===n?e[t].sort((e,t)=>e[1]<t[1]?-1:e[1]>t[1]?1:0):e[t].sort((e,t)=>e[1]>t[1]?-1:e[1]<t[1]?1:0);let a=[],o=[];s(e[n],a,-1);let l=a.length;for(let a=n+2;a>=n+1;--a)s(e[a%3],o,a!==n+2?r[i[t+(a+1)%3]]:-1);let c=o.length;i.push(r[i[t+n]],a[0],o[0]),i.push(r[i[t+(n+1)%3]],o[c-1],a[l-1]);let u=l<=c,h=u?l:c,d=u?c:l,f=u?l-1:c-1,p=u?0:1,m=l+c-2,_=0,g=0,v=u?a:o,S=u?o:a,x=0;for(;m-- >0;){let e;p?i.push(v[_],S[g]):i.push(S[g],v[_]),(x+=h)>=d&&_<f?(e=v[++_],x-=d):e=S[++g],i.push(e)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){let e=this._source.getVerticesData(st.o.PositionKind),t=this._source.getIndices();if(!t||!e)return;Array.isArray(t)||(t=Array.from(t));let i=this._options?.useFastVertexMerger??!0,r=i?Math.round(-Math.log(this._options?.epsilonVertexMerge??1e-6)/Math.log(10)):this._options?.epsilonVertexMerge??1e-6,s=[],n=[];if(i){let t={};for(let i=0;i<e.length;i+=3){let a=e[i+0],o=e[i+1],l=e[i+2],c=a.toFixed(r)+"|"+o.toFixed(r)+"|"+l.toFixed(r);if(void 0!==t[c])s.push(t[c]);else{let e=i/3;t[c]=e,s.push(e),n.push(e)}}}else for(let t=0;t<e.length;t+=3){let i=e[t+0],a=e[t+1],o=e[t+2],l=!1;for(let n=0;n<t&&!l;n+=3){let t=e[n+0],c=e[n+1],u=e[n+2];if(Math.abs(i-t)<r&&Math.abs(a-c)<r&&Math.abs(o-u)<r){s.push(n/3),l=!0;break}}l||(s.push(t/3),n.push(t/3))}if(this._options?.applyTessellation){let i=this._options?.epsilonVertexAligned??1e-6,r=[];for(let a=0;a<t.length;a+=3){let o;for(let l=0;l<3;++l){let c=s[t[a+l]],u=s[t[a+(l+1)%3]],h=s[t[a+(l+2)%3]];if(c===u)continue;let d=e[3*c+0],f=e[3*c+1],p=e[3*c+2],m=e[3*u+0],_=e[3*u+1],g=e[3*u+2],v=Math.sqrt((m-d)*(m-d)+(_-f)*(_-f)+(g-p)*(g-p));for(let t=0;t<n.length-1;t++){let s=n[t];if(s===c||s===u||s===h)continue;let S=e[3*s+0],x=e[3*s+1],E=e[3*s+2],C=Math.sqrt((S-d)*(S-d)+(x-f)*(x-f)+(E-p)*(E-p));Math.abs(C+Math.sqrt((S-m)*(S-m)+(x-_)*(x-_)+(E-g)*(E-g))-v)<i&&(o||(o={index:a,edgesPoints:[[],[],[]]},r.push(o)),o.edgesPoints[l].push([s,C]))}}}for(let e=0;e<r.length;++e){let i=r[e];this._tessellateTriangle(i.edgesPoints,i.index,t,s)}r.length=0}let a={};for(let i=0;i<t.length;i+=3){let r;for(let n=0;n<3;++n){let o=s[t[i+n]],l=s[t[i+(n+1)%3]],c=s[t[i+(n+2)%3]];if(o===l||(o===c||l===c)&&this._options?.removeDegeneratedTriangles)continue;if(i1.jp.Vector3[0].copyFromFloats(e[3*o+0],e[3*o+1],e[3*o+2]),i1.jp.Vector3[1].copyFromFloats(e[3*l+0],e[3*l+1],e[3*l+2]),i1.jp.Vector3[2].copyFromFloats(e[3*c+0],e[3*c+1],e[3*c+2]),r||(i1.jp.Vector3[1].subtractToRef(i1.jp.Vector3[0],i1.jp.Vector3[3]),i1.jp.Vector3[2].subtractToRef(i1.jp.Vector3[1],i1.jp.Vector3[4]),(r=i1.P.Cross(i1.jp.Vector3[3],i1.jp.Vector3[4])).normalize()),o>l){let e=o;o=l,l=e}let u=o+"_"+l,h=a[u];h?h.done||(i1.P.Dot(r,h.normal)<this._epsilon&&this.createLine(i1.jp.Vector3[0],i1.jp.Vector3[1],this._linesPositions.length/3),h.done=!0):a[u]={normal:r,done:!1,index:i,i:n}}}for(let i in a){let r=a[i];if(!r.done){let i=s[t[r.index+r.i]],n=s[t[r.index+(r.i+1)%3]];i1.jp.Vector3[0].copyFromFloats(e[3*i+0],e[3*i+1],e[3*i+2]),i1.jp.Vector3[1].copyFromFloats(e[3*n+0],e[3*n+1],e[3*n+2]),this.createLine(i1.jp.Vector3[0],i1.jp.Vector3[1],this._linesPositions.length/3)}}let o=this._source.getScene().getEngine();this._buffers[st.o.PositionKind]=new st.o(o,this._linesPositions,st.o.PositionKind,!1),this._buffers[st.o.NormalKind]=new st.o(o,this._linesNormals,st.o.NormalKind,!1,!1,4),this._buffersForInstances[st.o.PositionKind]=this._buffers[st.o.PositionKind],this._buffersForInstances[st.o.NormalKind]=this._buffers[st.o.NormalKind],this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){let e,t;let i=this._source.getVerticesData(st.o.PositionKind),r=this._source.getIndices();if(!r||!i)return;let s=[],n=[];for(e=0;e<r.length;e+=3){t=new m_;let a=r[e],o=r[e+1],l=r[e+2];t.p0=new i1.P(i[3*a],i[3*a+1],i[3*a+2]),t.p1=new i1.P(i[3*o],i[3*o+1],i[3*o+2]),t.p2=new i1.P(i[3*l],i[3*l+1],i[3*l+2]);let c=i1.P.Cross(t.p1.subtract(t.p0),t.p2.subtract(t.p1));c.normalize(),n.push(c),s.push(t)}for(e=0;e<s.length;e++){t=s[e];for(let i=e+1;i<s.length;i++){let n=s[i];if(3===t.edgesConnectedCount)break;if(3===n.edgesConnectedCount)continue;let a=r[3*i],o=r[3*i+1],l=r[3*i+2];for(let s=0;s<3;s++){let c=0;if(void 0===t.edges[s]){switch(s){case 0:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(t.p0,t.p1,n.p0,n.p1,n.p2):this._processEdgeForAdjacencies(r[3*e],r[3*e+1],a,o,l);break;case 1:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(t.p1,t.p2,n.p0,n.p1,n.p2):this._processEdgeForAdjacencies(r[3*e+1],r[3*e+2],a,o,l);break;case 2:c=this._checkVerticesInsteadOfIndices?this._processEdgeForAdjacenciesWithVertices(t.p2,t.p0,n.p0,n.p1,n.p2):this._processEdgeForAdjacencies(r[3*e+2],r[3*e],a,o,l)}if(-1!==c&&(t.edges[s]=i,n.edges[c]=e,t.edgesConnectedCount++,n.edgesConnectedCount++,3===t.edgesConnectedCount))break}}}}for(e=0;e<s.length;e++){let t=s[e];this._checkEdge(e,t.edges[0],n,t.p0,t.p1),this._checkEdge(e,t.edges[1],n,t.p1,t.p2),this._checkEdge(e,t.edges[2],n,t.p2,t.p0)}let a=this._source.getScene().getEngine();this._buffers[st.o.PositionKind]=new st.o(a,this._linesPositions,st.o.PositionKind,!1),this._buffers[st.o.NormalKind]=new st.o(a,this._linesNormals,st.o.NormalKind,!1,!1,4),this._buffersForInstances[st.o.PositionKind]=this._buffers[st.o.PositionKind],this._buffersForInstances[st.o.NormalKind]=this._buffers[st.o.NormalKind],this._ib=a.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){let e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera){this._lineShader._setDrawWrapper(t);return}let i=this._source.hasInstances&&this.customInstances.length>0,r=i||this._source.hasThinInstances,s=0;if(r){if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){let e=this._source._instanceDataStorage;if(s=this.customInstances.length,!e.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!e.isFrozen){let t=0;for(let i=0;i<s;++i)this.customInstances.data[i].copyToArray(e.instancesData,t),t+=16;e.instancesBuffer.updateDirectly(e.instancesData,0,s)}}else s=this._source.thinInstanceCount}let n=e.getEngine();this._lineShader._preBind(),1!==this._source.edgesColor.a?n.setAlphaMode(2):n.setAlphaMode(0),n.bindBuffers(r?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===rO.V.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",n.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix(),this._source),n.drawElementsType(n0.F.TriangleFillMode,0,this._indicesCount,s),this._lineShader.unbind(),r&&n.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class mv extends mg{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){let e=this._source.getVerticesData(st.o.PositionKind),t=this._source.getIndices();if(!t||!e)return;let i=i1.jp.Vector3[0],r=i1.jp.Vector3[1],s=t.length-1;for(let n=0,a=0;n<s;n+=2,a+=4)i1.P.FromArrayToRef(e,3*t[n],i),i1.P.FromArrayToRef(e,3*t[n+1],r),this.createLine(i,r,a);let n=this._source.getScene().getEngine();this._buffers[st.o.PositionKind]=new st.o(n,this._linesPositions,st.o.PositionKind,!1),this._buffers[st.o.NormalKind]=new st.o(n,this._linesNormals,st.o.NormalKind,!1,!1,4),this._ib=n.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}class mS extends ud{constructor(e,t,i,r,s,n){super(e,i,r,s,n),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new pG("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){let e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),r=this.getRenderHeight();(i!==e||r!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){let e=this._scene;if(super.dispose(),e&&e.prePassRenderer){let t=e.prePassRenderer.renderTargets.indexOf(this);-1!==t&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class mx{get generateNormalsInWorldSpace(){return this._generateNormalsInWorldSpace}set generateNormalsInWorldSpace(e){this._generateNormalsInWorldSpace!==e&&(this._generateNormalsInWorldSpace=e,this._markAllMaterialsAsPrePassDirty())}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}get useSpecificClearForDepthTexture(){return this._useSpecificClearForDepthTexture}set useSpecificClearForDepthTexture(e){this._useSpecificClearForDepthTexture!==e&&(this._useSpecificClearForDepthTexture=e,this._isDirty=!0)}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._scene.activeCamera?.renderPassId??this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtTypes=[],this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._generateNormalsInWorldSpace=!1,this._useSpecificClearForDepthTexture=!1,this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new i2.HE(0,0,0,0),this._clearDepthColor=new i2.HE(1e8,0,0,1),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine();let t=0;this._engine._caps.textureFloat&&this._engine._caps.textureFloatLinearFiltering?t=1:this._engine._caps.textureHalfFloat&&this._engine._caps.textureHalfFloatLinearFiltering&&(t=2);for(let e=0;e<mx.TextureFormats.length;++e){let i=mx.TextureFormats[e].format;1!==mx.TextureFormats[e].type||(mx.TextureFormats[e].type=t,1!==t||6!==i&&7!==i&&5!==i||this._engine._caps.supportFloatTexturesResolve||(mx.TextureFormats[e].type=2))}mx._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}_createRenderTarget(e,t){let i=new mS(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),this._enabled&&this._update(),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){let i=t.getMaterial(),r=i&&i.isPrePassCapable,s=i&&-1!==this.excludedMaterials.indexOf(i);this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&r&&!s?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!s&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){let e=[],t=[!1],i=[!1],r=[!0];for(let s=0;s<this.mrtCount;s++)e.push(!0),s>0&&(this._useSpecificClearForDepthTexture&&5===this._mrtLayout[s]?(t.push(!1),i.push(!0)):(t.push(!0),i.push(!1)),r.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._clearDepthAttachments=this._engine.buildTextureLayout(i),this._defaultAttachments=this._engine.buildTextureLayout(r)}_resetLayout(){for(let e=0;e<mx.TextureFormats.length;e++)this._textureIndices[mx.TextureFormats[e].purpose]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtTypes=[mx.TextureFormats[4].type],this._mrtFormats=[mx.TextureFormats[4].format],this._mrtNames=[mx.TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();let e=[];for(let t=0;t<this._mrtLayout.length;t++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());let t=[{prePassConstant:5,geometryBufferConstant:pH.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:pH.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:pH.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:pH.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:pH.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){let r=this._mrtLayout.indexOf(t[i].prePassConstant);-1!==r&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,r),e[r]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){let t=this._postProcessesSourceForThisPass[0];return!!t&&(t.inputTexture=e.renderTarget,!0)}_renderPostProcesses(e,t){let i=this._postProcessesSourceForThisPass[0],r=i?i.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null,s=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(s=s.concat([this._currentTarget.imageProcessingPostProcess])),s.length&&(this._scene.postProcessManager._prepareFrame(this._currentTarget.renderTarget?.texture,s),this._scene.postProcessManager.directRender(s,r,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._isDirty&&this._update(),this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._useSpecificClearForDepthTexture&&(this._engine.bindAttachments(this._clearDepthAttachments),this._engine.clear(this._clearDepthColor,!0,!1,!1)),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();let e=this._currentTarget.renderTarget;e&&this._engine.bindFramebuffer(e)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e}getEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e)return this._effectConfigurations[t];return null}_enable(){let e=this.mrtCount;for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&this._enableTextures(this._effectConfigurations[e].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){(this.mrtCount!==e||this.renderTargets[t].count!==this.mrtCount)&&this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtTypes,formats:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled&&(!this._effectConfigurations[e].postProcess&&this._effectConfigurations[e].createPostProcess&&this._effectConfigurations[e].createPostProcess(),this._effectConfigurations[e].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[e].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(!e.renderTargetTexture)return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[];if(e.renderTargetTexture.useCameraPostProcesses){let t=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return t?t._postProcesses:[]}return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[]}_setupOutputForThisPass(e,t){let i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&0!==this._scene.activeCameras.indexOf(t);this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(e=>null!=e),this._scene.autoClear=!0;let r=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!r&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;let s=this._getFirstPostProcess(this._postProcessesSourceForThisPass),n=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0],a=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||r,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),n?a=n:this._needsCompositionForThisPass?a=e.imageProcessingPostProcess:s&&(a=s),this._bindFrameBuffer(),this._linkInternalTexture(e,a)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){let t=!1;if(e){for(let i=0;i<e.length;i++)if(e[i]?.getClassName()==="ImageProcessingPostProcess"){t=!0;break}}return t}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(null!==e[t])return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){let i=e[t];-1===this._textureIndices[i]&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtTypes.push(mx.TextureFormats[i].type),this._mrtFormats.push(mx.TextureFormats[i].format),this._mrtNames.push(mx.TextureFormats[i].name),this.mrtCount++),(2===i||11===i)&&(this._scene.needsPreviousWorldMatrices=!0)}}update(){this._isDirty&&this._update()}_update(){let e;this._disable();let t=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),t=!0);for(let e=0;e<this._scene.materials.length;e++)this._scene.materials[e].setPrePassRenderer(this)&&(t=!0);t&&this._setRenderTargetEnabled(this.defaultRT,!0);for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)e=this._getPostProcessesSource(this.renderTargets[i]);else{let t=this._scene.activeCamera;if(!t)continue;e=t._postProcesses}if(e&&(e=e.filter(e=>null!=e))){for(let r=0;r<e.length;r++)e[r].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),t=!0);this._hasImageProcessing(e)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,t&&this._enable()}_markAllMaterialsAsPrePassDirty(){let e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(n0.F.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}mx._SceneComponentInitialization=e=>{throw(0,rU.S)("PrePassRendererSceneComponent")},mx.TextureFormats=[{purpose:0,type:2,format:5,name:"prePass_Irradiance"},{purpose:1,type:2,format:5,name:"prePass_Position"},{purpose:2,type:0,format:5,name:"prePass_Velocity"},{purpose:3,type:0,format:5,name:"prePass_Reflectivity"},{purpose:4,type:2,format:5,name:"prePass_Color"},{purpose:5,type:1,format:6,name:"prePass_Depth"},{purpose:6,type:2,format:5,name:"prePass_Normal"},{purpose:7,type:0,format:5,name:"prePass_Albedo"},{purpose:8,type:0,format:5,name:"prePass_WorldNormal"},{purpose:9,type:2,format:5,name:"prePass_LocalPosition"},{purpose:10,type:1,format:6,name:"prePass_ScreenDepth"},{purpose:11,type:2,format:5,name:"prePass_VelocityLinear"}],Object.defineProperty(rH.x.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(e){e&&e.isSupported&&(this._prePassRenderer=e)},enumerable:!0,configurable:!0}),rH.x.prototype.enablePrePassRenderer=function(){return this._prePassRenderer||(this._prePassRenderer=new mx(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,re.Y.Error("PrePassRenderer needs WebGL 2 support.\nMaybe you tried to use the following features that need the PrePassRenderer :\n + Subsurface Scattering"))),this._prePassRenderer},rH.x.prototype.disablePrePassRenderer=function(){this._prePassRenderer&&(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class mE{constructor(e){this.name=rz.l.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(rz.l.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(rz.l.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(rz.l.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(rz.l.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(rz.l.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(rz.l.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(rz.l.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(rz.l.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&!e.noPrePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&!e.noPrePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,r){if(!r)return;let s=e.getScene();s.prePassRenderer&&s.prePassRenderer.bindAttachmentsForEffect(r,t)}_afterRenderingMeshStage(e){let t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){}dispose(){this.scene.disablePrePassRenderer()}}mx._SceneComponentInitialization=e=>{let t=e._getComponent(rz.l.NAME_PREPASSRENDERER);t||(t=new mE(e),e._addComponent(t))};let mC=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
#define TWO_PI 6.2831855
vec2 Golden2dSeq(int i,float n)
{return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));}
vec2 SampleDiskGolden(int i,int sampleCount)
{vec2 f=Golden2dSeq(i,float(sampleCount));return vec2(sqrt(f.x),TWO_PI*f.y);}`;sG.v.IncludesShadersStore.fibonacci=mC,i(59628),sG.v.IncludesShadersStore.diffusionProfile="uniform vec3 diffusionS[5];uniform float diffusionD[5];uniform float filterRadii[5];";let mT=`#include<fibonacci>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;uniform vec2 texelSize;uniform sampler2D textureSampler;uniform sampler2D irradianceSampler;uniform sampler2D depthSampler;uniform sampler2D albedoSampler;uniform vec2 viewportSize;uniform float metersPerUnit;const float LOG2_E=1.4426950408889634;const float SSS_PIXELS_PER_SAMPLE=4.;const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true
vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
vec3 expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp(8.*PI))*expSum; }
vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{u=1.-u; 
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));float n=exp2(log2(g)*(-1.0/3.0)); 
float p=(g*n)*n; 
float c=1.+p+n; 
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
float x=(3./LOG2_E)*log2(c)-d; 
float rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));float r=x*rcpS;float rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2(r,rcpPdf);}
vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif
float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{float scale =rcp(float(n));float offset=rcp(float(n))*0.5;float sinPhase,cosPhase;sinPhase=sin(phase);cosPhase=cos(phase);vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);float r=bdp.x;float rcpPdf=bdp.y;float phi=SampleDiskGolden(i,n).y;float sinPhi,cosPhi;sinPhi=sin(phi);cosPhi=cos(phi);float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
vec2 vec=r*vec2(cosPsi,sinPsi);vec2 position; 
float xy2;position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;xy2 =r*r;vec4 textureSample=texture2D(irradianceSampler,position);float viewZ=texture2D(depthSampler,position).r;vec3 irradiance =textureSample.rgb;if (testLightingForSSS(textureSample.a))
{float relZ=viewZ-centerPosVS.z;vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);totalIrradiance+=weight*irradiance;totalWeight +=weight;}
else
{}}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));float centerDepth =0.;vec4 inputColor=texture2D(textureSampler,vUV);bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);if (passedStencilTest)
{centerDepth=texture2D(depthSampler,vUV).r;}
if (!passedStencilTest) { 
gl_FragColor=inputColor;return;}
float distScale =1.;vec3 S =diffusionS[diffusionProfileIndex];float d =diffusionD[diffusionProfileIndex];float filterRadius=filterRadii[diffusionProfileIndex];vec2 centerPosNDC=vUV;vec2 cornerPosNDC=vUV+0.5*texelSize;vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; 
vec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; 
float mmPerUnit =1000.*(metersPerUnit*rcp(distScale));float unitsPerMm=rcp(mmPerUnit);float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;float filterArea =PI*Sq(filterRadius*pixelsPerMm);int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));int sampleBudget=_SssSampleBudget;int texturingMode=0;vec3 albedo =texture2D(albedoSampler,vUV).rgb;if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);gl_FragColor=vec4(green,1.0);return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);return;}
#ifdef DEBUG_SSS_SAMPLES
vec3 red =vec3(1.,0.,0.);vec3 blue=vec3(0.,0.,1.);gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);return;
#endif
float phase=0.;int n=min(sampleCount,sampleBudget);vec3 centerWeight =vec3(0.); 
vec3 totalIrradiance=vec3(0.);vec3 totalWeight =vec3(0.);for (int i=0; i<n; i++)
{EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);}
totalWeight=max(totalWeight,HALF_MIN);gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);}`;sG.v.ShadersStore.subSurfaceScatteringPixelShader=mT;class mb extends sD.D{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,r=null,s,n,a,o=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,r,s||rZ.x.BILINEAR_SAMPLINGMODE,n,a,null,o,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add(e=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration){re.Y.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}let i=this.texelSize;e.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),e.setFloat2("texelSize",i.x,i.y),e.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),e.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),e.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),e.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),e.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),e.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),e.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}}class my{get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=rz.l.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new i2.Wo(1,1,1)),this._scene=e,my._SceneComponentInitialization(this._scene)}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return re.Y.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[3*t]===e.r&&this._ssDiffusionS[3*t+1]===e.g&&this._ssDiffusionS[3*t+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new mb("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){let t=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,t)}_sampleBurleyDiffusionProfile(e,t){let i=1+4*(e=1-e)*(2*e+Math.sqrt(1+4*e*e)),r=Math.pow(i,-1/3);return 3*Math.log((1+i*r*r+r)/(4*e))*t}}my._SceneComponentInitialization=e=>{throw(0,rU.S)("SubSurfaceSceneComponent")},(0,rY.PS)(rz.l.NAME_SUBSURFACE,(e,t)=>{if(void 0!==e.ssDiffusionProfileColors&&null!==e.ssDiffusionProfileColors&&(t.enableSubSurfaceForPrePass(),t.subSurfaceConfiguration))for(let i=0,r=e.ssDiffusionProfileColors.length;i<r;i++){let r=e.ssDiffusionProfileColors[i];t.subSurfaceConfiguration.addDiffusionProfile(new i2.Wo(r.r,r.g,r.b))}}),Object.defineProperty(rH.x.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(e){e&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=e)},enumerable:!0,configurable:!0}),rH.x.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;let e=this.enablePrePassRenderer();return e?(this._subSurfaceConfiguration=new my(this),e.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null},rH.x.prototype.disableSubSurfaceForPrePass=function(){this._subSurfaceConfiguration&&(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class mI{constructor(e){this.name=rz.l.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;let t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){this.scene.prePassRenderer&&this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}my._SceneComponentInitialization=e=>{let t=e._getComponent(rz.l.NAME_SUBSURFACE);t||(t=new mI(e),e._addComponent(t))},rH.x.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new mP(this)),this._outlineRenderer},Object.defineProperty(rP.Kj.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOutline=e},enumerable:!0,configurable:!0}),Object.defineProperty(rP.Kj.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(e){e&&this.getScene().getOutlineRenderer(),this._renderOverlay=e},enumerable:!0,configurable:!0});class mP{get shaderLanguage(){return this._shaderLanguage}constructor(e){this.name=rz.l.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this._shaderLanguage=0,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let e=0;e<4;++e)this._passIdForDrawWrapper[e]=this._engine.createRenderPassId(`Outline Renderer (${e})`);this._engine.isWebGPU&&(this._shaderLanguage=1)}register(){this.scene._beforeRenderingMeshStage.registerStep(rz.l.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(rz.l.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,r){r=r??this._passIdForDrawWrapper[0];let s=this.scene,n=s.getEngine(),a=n.getCaps().instancedArrays&&(null!==t.visibleInstances[e._id]&&void 0!==t.visibleInstances[e._id]||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,a,r))return;let o=e.getMesh(),l=o._internalAbstractMeshDataInfo._actAsRegularMesh?o:null,c=e.getRenderingMesh(),u=l||c,h=e.getMaterial();if(!h||!s.activeCamera)return;let d=e._getDrawWrapper(r),f=cu.q.GetEffect(d);n.enableEffect(d),h.useLogarithmicDepth&&f.setFloat("logarithmicDepthConstant",2/(Math.log(s.activeCamera.maxZ+1)/Math.LN2)),f.setFloat("offset",i?0:c.outlineWidth),f.setColor4("color",i?c.overlayColor:c.outlineColor,i?c.overlayAlpha:h.alpha),f.setMatrix("viewProjection",s.getTransformMatrix()),f.setMatrix("world",u.getWorldMatrix()),(0,le.qx)(c,f),(0,le.KG)(c,f),c.morphTargetManager&&c.morphTargetManager.isUsingTextureForTargets&&c.morphTargetManager._bind(f),a||c._bind(e,f,h.fillMode);let p=e.getMesh().bakedVertexAnimationManager;if(p&&p.isEnabled&&p.bind(f,a),h&&h.needAlphaTesting()){let e=h.getAlphaTestTexture();e&&(f.setTexture("diffuseSampler",e),f.setMatrix("diffuseMatrix",e.getTextureMatrix()))}(0,o9.an)(f,h,s),n.setZOffset(-this.zOffset),n.setZOffsetUnits(-this.zOffsetUnits),c._processRendering(u,e,f,h.fillMode,t,a,(e,t)=>{f.setMatrix("world",t)}),n.setZOffset(0),n.setZOffsetUnits(0)}isReady(e,t,r){r=r??this._passIdForDrawWrapper[0];let s=[],n=[st.o.PositionKind,st.o.NormalKind],a=e.getMesh(),o=e.getMaterial();if(!o)return!1;let l=a.getScene();o.needAlphaTesting()&&(s.push("#define ALPHATEST"),a.isVerticesDataPresent(st.o.UVKind)&&(n.push(st.o.UVKind),s.push("#define UV1")),a.isVerticesDataPresent(st.o.UV2Kind)&&(n.push(st.o.UV2Kind),s.push("#define UV2"))),o.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH"),(0,o9.lK)(o,l,s);let c=new o8.L;if(a.useBones&&a.computeBonesUsingShaders&&a.skeleton){n.push(st.o.MatricesIndicesKind),n.push(st.o.MatricesWeightsKind),a.numBoneInfluencers>4&&(n.push(st.o.MatricesIndicesExtraKind),n.push(st.o.MatricesWeightsExtraKind));let e=a.skeleton;s.push("#define NUM_BONE_INFLUENCERS "+a.numBoneInfluencers),a.numBoneInfluencers>0&&c.addCPUSkinningFallback(0,a),e.isUsingTextureForMatrices?s.push("#define BONETEXTURE"):s.push("#define BonesPerMesh "+(e.bones.length+1))}else s.push("#define NUM_BONE_INFLUENCERS 0");let u=a.morphTargetManager,h=0;u&&(h=u.numMaxInfluencers||u.numInfluencers)>0&&(s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+h),u.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),(0,le.Vk)(n,a,h)),t&&(s.push("#define INSTANCES"),(0,le.y9)(n),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES"));let d=a.bakedVertexAnimationManager;d&&d.isEnabled&&(s.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),t&&n.push("bakedVertexAnimationSettingsInstanced"));let f=e._getDrawWrapper(r,!0),p=f.defines,m=s.join("\n");if(p!==m){let e=["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","boneTextureWidth","morphTargetCount","morphTargetTextureInfo","morphTargetTextureIndices","bakedVertexAnimationSettings","bakedVertexAnimationTextureSizeInverted","bakedVertexAnimationTime","bakedVertexAnimationTexture"];(0,o9.qx)(e),f.setEffect(this.scene.getEngine().createEffect("outline",{attributes:n,uniformsNames:e,uniformBuffersNames:[],samplers:["diffuseSampler","boneSampler","morphTargets","bakedVertexAnimationTexture"],defines:m,fallbacks:c,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:h},shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,54576)),Promise.resolve().then(i.bind(i,3742))]):await Promise.all([Promise.resolve().then(i.bind(i,52478)),Promise.resolve().then(i.bind(i,80962))])}},this.scene.getEngine()),m)}return f.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){let r=t.getMaterial();r&&r.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(mP._StencilReference),this._engine.setStencilFunctionReference(mP._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),r&&r.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){let e=this._engine.getAlphaMode(),r=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(e),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=r}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}mP._StencilReference=4,i(86134);class mR{get particleSize(){return this._particleSize}set particleSize(e){e!==this._particleSize&&(this._particleSize=e,this.onParticleSizeChanged.notifyObservers(this))}get useInstancing(){return!this.indexBuffer}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&this._hasVelocity()&&(this._useVelocity=e,this._effectsAreDirty=!0)}_hasVelocity(){return!!this.vertexBuffers?.velocity}get indexBuffer(){return null}getClassName(){return"FluidRenderingObject"}get shaderLanguage(){return this._shaderLanguage}constructor(e,t){this.priority=0,this._particleSize=.1,this.onParticleSizeChanged=new i0.y$,this.particleThicknessAlpha=.05,this._useVelocity=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._effectsAreDirty=!0,this._depthEffectWrapper=null,this._thicknessEffectWrapper=null,this._shaderLanguage=t??(this._engine.isWebGPU?1:0)}_createEffects(){let e=["view","projection","particleRadius","size"],t=["position","offset"],r=[];this._effectsAreDirty=!1,this.useVelocity&&(t.push("velocity"),r.push("#define FLUIDRENDERING_VELOCITY")),this._scene.useRightHandedSystem&&r.push("#define FLUIDRENDERING_RHS"),this._depthEffectWrapper=new cF.H({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDepth",fragmentShader:"fluidRenderingParticleDepth",attributeNames:t,uniformNames:e,samplerNames:[],defines:r,shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,51083)),Promise.resolve().then(i.bind(i,68534))]):await Promise.all([Promise.resolve().then(i.bind(i,15803)),Promise.resolve().then(i.bind(i,59325))])}}),e.push("particleAlpha"),this._thicknessEffectWrapper=new cF.H({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleThickness",fragmentShader:"fluidRenderingParticleThickness",attributeNames:["position","offset"],uniformNames:e,samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.all([Promise.resolve().then(i.bind(i,2530)),Promise.resolve().then(i.bind(i,74836))]):await Promise.all([Promise.resolve().then(i.bind(i,95899)),Promise.resolve().then(i.bind(i,3977))])}})}isReady(){if(this._effectsAreDirty&&this._createEffects(),!this._depthEffectWrapper||!this._thicknessEffectWrapper)return!1;let e=this._depthEffectWrapper._drawWrapper.effect,t=this._thicknessEffectWrapper._drawWrapper.effect;return e.isReady()&&t.isReady()}renderDepthTexture(){let e=this.numParticles;if(!this._depthEffectWrapper||0===e)return;let t=this._depthEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat2("size",this._particleSize,this._particleSize),i.setFloat("particleRadius",this._particleSize/2),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}renderThicknessTexture(){let e=this.numParticles;if(!this._thicknessEffectWrapper||0===e)return;let t=this._thicknessEffectWrapper._drawWrapper,i=t.effect;this._engine.setAlphaMode(6),this._engine.setDepthWrite(!1),this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),i.setFloat("particleAlpha",this.particleThicknessAlpha),i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0)}renderDiffuseTexture(){}dispose(){this._depthEffectWrapper?.dispose(!1),this._thicknessEffectWrapper?.dispose(!1)}}class mA extends mR{get particleSystem(){return this._particleSystem}getClassName(){return"FluidRenderingObjectParticleSystem"}get useTrueRenderingForDiffuseTexture(){return this._useTrueRenderingForDiffuseTexture}set useTrueRenderingForDiffuseTexture(e){this._useTrueRenderingForDiffuseTexture!==e&&(this._useTrueRenderingForDiffuseTexture=e,e?(this._particleSystem.blendMode=this._blendMode,this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null):(this._particleSystem.blendMode=-1,this._onBeforeDrawParticleObserver=this._particleSystem.onBeforeDrawParticlesObservable.add(()=>{this._engine.setAlphaMode(2)})))}get vertexBuffers(){return this._particleSystem.vertexBuffers}get indexBuffer(){return this._particleSystem.indexBuffer}constructor(e,t,i){super(e,i),this._useTrueRenderingForDiffuseTexture=!0,this._particleSystem=t,this._originalRender=t.render.bind(t),this._blendMode=t.blendMode,this._onBeforeDrawParticleObserver=null,this._updateInAnimate=this._particleSystem.updateInAnimate,this._particleSystem.updateInAnimate=!0,this._particleSystem.render=()=>0,this.particleSize=(t.minSize+t.maxSize)/2,this.useTrueRenderingForDiffuseTexture=!1}isReady(){return super.isReady()&&this._particleSystem.isReady()}get numParticles(){return this._particleSystem.getActiveCount()}renderDiffuseTexture(){this._originalRender()}dispose(){super.dispose(),this._particleSystem.onBeforeDrawParticlesObservable.remove(this._onBeforeDrawParticleObserver),this._onBeforeDrawParticleObserver=null,this._particleSystem.render=this._originalRender,this._particleSystem.blendMode=this._blendMode,this._particleSystem.updateInAnimate=this._updateInAnimate}}class mM{get blurNumIterations(){return this._blurNumIterations}set blurNumIterations(e){if(this._blurNumIterations!==e&&(this._blurNumIterations=e,null!==this._blurPostProcesses)){let e=this._blurPostProcesses[0],t=this._blurPostProcesses[1];this._blurPostProcesses=[];for(let i=0;i<2*this._blurNumIterations;++i)this._blurPostProcesses[i]=1&i?t:e}}get renderTarget(){return this._rt}get renderTargetBlur(){return this._rtBlur}get texture(){return this._texture}get textureBlur(){return this._textureBlurred}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i,r,s,n,a=1,o=6,l=1,c=6,u=!1,h=null,d=!0,f=1,p){this.enableBlur=!0,this.blurSizeDivisor=1,this.blurFilterSize=7,this._blurNumIterations=3,this.blurMaxFilterSize=100,this.blurDepthScale=10,this.particleSize=.02,this.onDisposeObservable=new i0.y$,this._shaderLanguage=0,this._name=e,this._scene=t,this._camera=h,this._engine=t.getEngine(),this._width=i,this._height=r,this._blurTextureSizeX=s,this._blurTextureSizeY=n,this._textureType=a,this._textureFormat=o,this._blurTextureType=l,this._blurTextureFormat=c,this._useStandardBlur=u,this._generateDepthBuffer=d,this._samples=f,this._postProcessRunningIndex=0,this.enableBlur=0!==s&&0!==n,this._rt=null,this._texture=null,this._rtBlur=null,this._textureBlurred=null,this._blurPostProcesses=null,this._shaderLanguage=p??(this._engine.isWebGPU?1:0)}initialize(){if(this.dispose(),this._createRenderTarget(),this.enableBlur&&this._texture){let[e,t,i]=this._createBlurPostProcesses(this._texture,this._blurTextureType,this._blurTextureFormat,this.blurSizeDivisor,this._name,this._useStandardBlur);this._rtBlur=e,this._textureBlurred=t,this._blurPostProcesses=i}}applyBlurPostProcesses(){this.enableBlur&&this._blurPostProcesses&&(this._postProcessRunningIndex=0,this._scene.postProcessManager.directRender(this._blurPostProcesses,this._rtBlur,!0),this._engine.unBindFramebuffer(this._rtBlur))}_createRenderTarget(){this._rt=this._engine.createRenderTargetTexture({width:this._width,height:this._height},{generateMipMaps:!1,type:this._textureType,format:this._textureFormat,samplingMode:1,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTT-${this._name}`});let e=this._rt.texture;e.incrementReferences(),this._texture=new rZ.x(null,this._scene),this._texture.name="rtt"+this._name,this._texture._texture=e,this._texture.wrapU=rZ.x.CLAMP_ADDRESSMODE,this._texture.wrapV=rZ.x.CLAMP_ADDRESSMODE,this._texture.anisotropicFilteringLevel=1}_createBlurPostProcesses(e,t,r,s,n,a=!1){let o=this._scene.getEngine(),l=new i1.FM(Math.floor(this._blurTextureSizeX/s),Math.floor(this._blurTextureSizeY/s)),c=1===t&&o.getCaps().textureFloatLinearFiltering||2===t&&o.getCaps().textureHalfFloatLinearFiltering,u=this._engine.createRenderTargetTexture({width:l.x,height:l.y},{generateMipMaps:!1,type:t,format:r,samplingMode:c?2:1,generateDepthBuffer:!1,generateStencilBuffer:!1,samples:this._samples,label:`FluidRenderingRTTBlur-${n}`}),h=u.texture;h.incrementReferences();let d=new rZ.x(null,this._scene);if(d.name="rttBlurred"+n,d._texture=h,d.wrapU=rZ.x.CLAMP_ADDRESSMODE,d.wrapV=rZ.x.CLAMP_ADDRESSMODE,d.anisotropicFilteringLevel=1,a){let s=new sD.D("BilateralBlurX","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,o,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,16785)):await Promise.resolve().then(i.bind(i,55520))});s.samples=this._samples,s.externalTextureSamplerBinding=!0,s.onApplyObservable.add(t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",s.inputTexture.texture),t.setInt("filterSize",this.blurFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),this._postProcessRunningIndex++}),s.onSizeChangedObservable.add(()=>{s._textures.forEach(e=>{e.texture.wrapU=rZ.x.CLAMP_ADDRESSMODE,e.texture.wrapV=rZ.x.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(s);let n=new sD.D("BilateralBlurY","fluidRenderingStandardBlur",["filterSize","blurDir"],null,1,null,1,o,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,16785)):await Promise.resolve().then(i.bind(i,55520))});n.samples=this._samples,n.onApplyObservable.add(e=>{e.setInt("filterSize",this.blurFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),this._postProcessRunningIndex++}),n.onSizeChangedObservable.add(()=>{n._textures.forEach(e=>{e.texture.wrapU=rZ.x.CLAMP_ADDRESSMODE,e.texture.wrapV=rZ.x.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(n),s.autoClear=!1,n.autoClear=!1;let a=[];for(let e=0;e<2*this._blurNumIterations;++e)a[e]=1&e?n:s;return[u,d,a]}{let s=["maxFilterSize","blurDir","projectedParticleConstant","depthThreshold"],n=new sD.D("BilateralBlurX","fluidRenderingBilateralBlur",s,null,1,null,1,o,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,85355)):await Promise.resolve().then(i.bind(i,54580))});n.samples=this._samples,n.externalTextureSamplerBinding=!0,n.onApplyObservable.add(t=>{0===this._postProcessRunningIndex?t.setTexture("textureSampler",e):t._bindTexture("textureSampler",n.inputTexture.texture),t.setInt("maxFilterSize",this.blurMaxFilterSize),t.setFloat2("blurDir",1/this._blurTextureSizeX,0),t.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),t.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),n.onSizeChangedObservable.add(()=>{n._textures.forEach(e=>{e.texture.wrapU=rZ.x.CLAMP_ADDRESSMODE,e.texture.wrapV=rZ.x.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(n);let a=new sD.D("BilateralBlurY","fluidRenderingBilateralBlur",s,null,1,null,1,o,!0,null,t,void 0,void 0,void 0,r,this._shaderLanguage,async()=>{1===this.shaderLanguage?await Promise.resolve().then(i.bind(i,85355)):await Promise.resolve().then(i.bind(i,54580))});a.samples=this._samples,a.onApplyObservable.add(e=>{e.setInt("maxFilterSize",this.blurMaxFilterSize),e.setFloat2("blurDir",0,1/this._blurTextureSizeY),e.setFloat("projectedParticleConstant",this._getProjectedParticleConstant()),e.setFloat("depthThreshold",this._getDepthThreshold()),this._postProcessRunningIndex++}),a.onSizeChangedObservable.add(()=>{a._textures.forEach(e=>{e.texture.wrapU=rZ.x.CLAMP_ADDRESSMODE,e.texture.wrapV=rZ.x.CLAMP_ADDRESSMODE})}),this._fixReusablePostProcess(a),n.autoClear=!1,a.autoClear=!1;let l=[];for(let e=0;e<2*this._blurNumIterations;++e)l[e]=1&e?a:n;return[u,d,l]}}_fixReusablePostProcess(e){e.isReusable()&&(e.onActivateObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}),e.onApplyObservable.add(()=>{e._currentRenderTextureInd=(e._currentRenderTextureInd+1)%2}))}_getProjectedParticleConstant(){return this.blurFilterSize*this.particleSize*.05*(this._height/2)/Math.tan((this._camera?.fov??45*Math.PI/180)/2)}_getDepthThreshold(){return this.particleSize/2*this.blurDepthScale}dispose(){this.onDisposeObservable.hasObservers()&&this.onDisposeObservable.notifyObservers(this),this._rt?.dispose(),this._rt=null,this._texture?.dispose(),this._texture=null,this._rtBlur?.dispose(),this._rtBlur=null,this._textureBlurred?.dispose(),this._textureBlurred=null,this._blurPostProcesses&&(this._blurPostProcesses[0].dispose(),this._blurPostProcesses[1].dispose()),this._blurPostProcesses=null}}(eJ=iz||(iz={}))[eJ.DepthTexture=0]="DepthTexture",eJ[eJ.DepthBlurredTexture=1]="DepthBlurredTexture",eJ[eJ.ThicknessTexture=2]="ThicknessTexture",eJ[eJ.ThicknessBlurredTexture=3]="ThicknessBlurredTexture",eJ[eJ.DiffuseTexture=4]="DiffuseTexture",eJ[eJ.Normals=5]="Normals",eJ[eJ.DiffuseRendering=6]="DiffuseRendering";class mN{get needInitialization(){return this._needInitialization}get generateDiffuseTexture(){return this._generateDiffuseTexture}set generateDiffuseTexture(e){this._generateDiffuseTexture!==e&&(this._generateDiffuseTexture=e,this._needInitialization=!0)}get debugFeature(){return this._debugFeature}set debugFeature(e){this._debugFeature!==e&&(this._needInitialization=!0,this._debugFeature=e)}get debug(){return this._debug}set debug(e){this._debug!==e&&(this._debug=e,this._needInitialization=!0)}get environmentMap(){return this._environmentMap}set environmentMap(e){this._environmentMap!==e&&(this._needInitialization=!0,this._environmentMap=e)}get enableBlurDepth(){return this._enableBlurDepth}set enableBlurDepth(e){this._enableBlurDepth!==e&&(this._enableBlurDepth=e,this._needInitialization=!0)}get blurDepthSizeDivisor(){return this._blurDepthSizeDivisor}set blurDepthSizeDivisor(e){this._blurDepthSizeDivisor!==e&&(this._blurDepthSizeDivisor=e,this._needInitialization=!0)}get blurDepthFilterSize(){return this._blurDepthFilterSize}set blurDepthFilterSize(e){this._blurDepthFilterSize!==e&&(this._blurDepthFilterSize=e,this._setBlurParameters())}get blurDepthNumIterations(){return this._blurDepthNumIterations}set blurDepthNumIterations(e){this._blurDepthNumIterations!==e&&(this._blurDepthNumIterations=e,this._setBlurParameters())}get blurDepthMaxFilterSize(){return this._blurDepthMaxFilterSize}set blurDepthMaxFilterSize(e){this._blurDepthMaxFilterSize!==e&&(this._blurDepthMaxFilterSize=e,this._setBlurParameters())}get blurDepthDepthScale(){return this._blurDepthDepthScale}set blurDepthDepthScale(e){this._blurDepthDepthScale!==e&&(this._blurDepthDepthScale=e,this._setBlurParameters())}get enableBlurThickness(){return this._enableBlurThickness}set enableBlurThickness(e){this._enableBlurThickness!==e&&(this._enableBlurThickness=e,this._needInitialization=!0)}get blurThicknessSizeDivisor(){return this._blurThicknessSizeDivisor}set blurThicknessSizeDivisor(e){this._blurThicknessSizeDivisor!==e&&(this._blurThicknessSizeDivisor=e,this._needInitialization=!0)}get blurThicknessFilterSize(){return this._blurThicknessFilterSize}set blurThicknessFilterSize(e){this._blurThicknessFilterSize!==e&&(this._blurThicknessFilterSize=e,this._setBlurParameters())}get blurThicknessNumIterations(){return this._blurThicknessNumIterations}set blurThicknessNumIterations(e){this._blurThicknessNumIterations!==e&&(this._blurThicknessNumIterations=e,this._setBlurParameters())}get useFixedThickness(){return this._useFixedThickness}set useFixedThickness(e){this._useFixedThickness!==e&&(this._useFixedThickness=e,this._needInitialization=!0)}get useVelocity(){return this._useVelocity}set useVelocity(e){this._useVelocity!==e&&(this._useVelocity=e,this._needInitialization=!0,this._onUseVelocityChanged.notifyObservers(this))}get depthMapSize(){return this._depthMapSize}set depthMapSize(e){this._depthMapSize!==e&&(this._depthMapSize=e,this._needInitialization=!0)}get thicknessMapSize(){return this._thicknessMapSize}set thicknessMapSize(e){this._thicknessMapSize!==e&&(this._thicknessMapSize=e,this._needInitialization=!0)}get diffuseMapSize(){return this._diffuseMapSize}set diffuseMapSize(e){this._diffuseMapSize!==e&&(this._diffuseMapSize=e,this._needInitialization=!0)}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._needInitialization=!0)}get compositeMode(){return this._compositeMode}set compositeMode(e){this._compositeMode!==e&&(this._compositeMode=e,this._needInitialization=!0)}get camera(){return this._camera}get shaderLanguage(){return this._shaderLanguage}constructor(e,t,i){this._generateDiffuseTexture=!1,this.fluidColor=new i2.Wo(.085,.6375,.765),this.density=2,this.refractionStrength=.1,this.fresnelClamp=1,this.specularPower=250,this.minimumThickness=0,this.dirLight=new i1.P(-2,-1,1).normalize(),this._debugFeature=1,this._debug=!1,this._enableBlurDepth=!0,this._blurDepthSizeDivisor=1,this._blurDepthFilterSize=7,this._blurDepthNumIterations=3,this._blurDepthMaxFilterSize=100,this._blurDepthDepthScale=10,this._enableBlurThickness=!0,this._blurThicknessSizeDivisor=1,this._blurThicknessFilterSize=5,this._blurThicknessNumIterations=1,this._useFixedThickness=!1,this._onUseVelocityChanged=new i0.y$,this._useVelocity=!1,this._depthMapSize=null,this._thicknessMapSize=null,this._diffuseMapSize=null,this._samples=1,this._compositeMode=!1,this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._camera=t??e.activeCamera,this._needInitialization=!0,this._bgDepthTexture=null,this._invProjectionMatrix=new i1.y3,this._depthClearColor=new i2.HE(1e6,1e6,1e6,1),this._thicknessClearColor=new i2.HE(0,0,0,1),this._depthRenderTarget=null,this._diffuseRenderTarget=null,this._thicknessRenderTarget=null,this._renderPostProcess=null,this._shaderLanguage=i??(this._engine.isWebGPU?1:0)}_initialize(){this.dispose(),this._needInitialization=!1;let e=this._depthMapSize??this._engine.getRenderWidth(),t=null!==this._depthMapSize?Math.round(this._depthMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();if(this._depthRenderTarget=new mM("Depth",this._scene,e,t,e,t,1,7,1,7,!1,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._depthRenderTarget),this.generateDiffuseTexture){let e=this._diffuseMapSize??this._engine.getRenderWidth(),t=null!==this._diffuseMapSize?Math.round(this._diffuseMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._diffuseRenderTarget=new mM("Diffuse",this._scene,e,t,0,0,0,5,0,5,!0,this._camera,!0,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._diffuseRenderTarget)}let i=this._thicknessMapSize??this._engine.getRenderWidth(),r=null!==this._thicknessMapSize?Math.round(this._thicknessMapSize*this._engine.getRenderHeight()/this._engine.getRenderWidth()):this._engine.getRenderHeight();this._useFixedThickness||(this._thicknessRenderTarget=new mM("Thickness",this._scene,i,r,i,r,2,6,2,6,!0,this._camera,!1,this._samples,this._shaderLanguage),this._initializeRenderTarget(this._thicknessRenderTarget)),this._createLiquidRenderingPostProcess()}_setBlurParameters(e=null){(null===e||e===this._depthRenderTarget)&&this._setBlurDepthParameters(),(null===e||e===this._thicknessRenderTarget)&&this._setBlurThicknessParameters()}_setBlurDepthParameters(){this._depthRenderTarget&&(this._depthRenderTarget.blurFilterSize=this.blurDepthFilterSize,this._depthRenderTarget.blurMaxFilterSize=this.blurDepthMaxFilterSize,this._depthRenderTarget.blurNumIterations=this.blurDepthNumIterations,this._depthRenderTarget.blurDepthScale=this.blurDepthDepthScale)}_setBlurThicknessParameters(){this._thicknessRenderTarget&&(this._thicknessRenderTarget.blurFilterSize=this.blurThicknessFilterSize,this._thicknessRenderTarget.blurNumIterations=this.blurThicknessNumIterations)}_initializeRenderTarget(e){e!==this._diffuseRenderTarget&&(e.enableBlur=e===this._depthRenderTarget?this.enableBlurDepth:this.enableBlurThickness,e.blurSizeDivisor=e===this._depthRenderTarget?this.blurDepthSizeDivisor:this.blurThicknessSizeDivisor),this._setBlurParameters(e),e.initialize()}_createLiquidRenderingPostProcess(){let e=this._scene.getEngine(),t=["viewMatrix","projectionMatrix","invProjectionMatrix","texelSize","dirLight","cameraFar","density","refractionStrength","fresnelClamp","specularPower"],r=["depthSampler"],s=[];if(this.dispose(!0),!this._camera)return;let n=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture,a=new i1.FM(1/n.getSize().width,1/n.getSize().height);this._scene.useRightHandedSystem&&s.push("#define FLUIDRENDERING_RHS"),null!==this._environmentMap&&(this._environmentMap??this._scene.environmentTexture)&&(r.push("reflectionSampler"),s.push("#define FLUIDRENDERING_ENVIRONMENT")),this._diffuseRenderTarget?(r.push("diffuseSampler"),s.push("#define FLUIDRENDERING_DIFFUSETEXTURE")):t.push("diffuseColor"),this._useVelocity&&(r.push("velocitySampler"),s.push("#define FLUIDRENDERING_VELOCITY")),this._useFixedThickness?(t.push("thickness"),r.push("bgDepthSampler"),s.push("#define FLUIDRENDERING_FIXED_THICKNESS")):(t.push("minimumThickness"),r.push("thicknessSampler")),this._compositeMode&&s.push("#define FLUIDRENDERING_COMPOSITE_MODE"),this._debug&&(s.push("#define FLUIDRENDERING_DEBUG"),5===this._debugFeature?s.push("#define FLUIDRENDERING_DEBUG_SHOWNORMAL"):6===this._debugFeature?s.push("#define FLUIDRENDERING_DEBUG_DIFFUSERENDERING"):(s.push("#define FLUIDRENDERING_DEBUG_TEXTURE"),r.push("debugSampler"),(0===this._debugFeature||1===this._debugFeature)&&s.push("#define FLUIDRENDERING_DEBUG_DEPTH"))),this._renderPostProcess=new sD.D("FluidRendering","fluidRenderingRender",t,r,1,null,2,e,!1,null,0,void 0,void 0,!0,void 0,this._shaderLanguage,async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,26356)):await Promise.resolve().then(i.bind(i,36733))}),this._renderPostProcess.updateEffect(s.join("\n")),this._renderPostProcess.samples=this._samples;let o=e.setTextureSampler;this._renderPostProcess.onApplyObservable.add(t=>{if(this._invProjectionMatrix.copyFrom(this._scene.getProjectionMatrix()),this._invProjectionMatrix.invert(),o&&o.call(e,"textureSamplerSampler",this._renderPostProcess.inputTexture.texture),this._depthRenderTarget.enableBlur?(t.setTexture("depthSampler",this._depthRenderTarget.textureBlur),o&&o.call(e,"depthSamplerSampler",this._depthRenderTarget.textureBlur?.getInternalTexture()??null)):(t.setTexture("depthSampler",this._depthRenderTarget.texture),o&&o.call(e,"depthSamplerSampler",this._depthRenderTarget.texture?.getInternalTexture()??null)),this._diffuseRenderTarget?this._diffuseRenderTarget.enableBlur?(t.setTexture("diffuseSampler",this._diffuseRenderTarget.textureBlur),o&&o.call(e,"diffuseSamplerSampler",this._diffuseRenderTarget.textureBlur?.getInternalTexture()??null)):(t.setTexture("diffuseSampler",this._diffuseRenderTarget.texture),o&&o.call(e,"diffuseSamplerSampler",this._diffuseRenderTarget.texture?.getInternalTexture()??null)):t.setColor3("diffuseColor",this.fluidColor),this._useFixedThickness?(t.setFloat("thickness",this.minimumThickness),t._bindTexture("bgDepthSampler",this._bgDepthTexture),o&&o.call(e,"bgDepthSamplerSampler",this._bgDepthTexture??null)):(this._thicknessRenderTarget.enableBlur?(t.setTexture("thicknessSampler",this._thicknessRenderTarget.textureBlur),o&&o.call(e,"thicknessSamplerSampler",this._thicknessRenderTarget.textureBlur?.getInternalTexture()??null)):(t.setTexture("thicknessSampler",this._thicknessRenderTarget.texture),o&&o.call(e,"thicknessSamplerSampler",this._thicknessRenderTarget.texture?.getInternalTexture()??null)),t.setFloat("minimumThickness",this.minimumThickness)),null!==this._environmentMap){let i=this._environmentMap??this._scene.environmentTexture;i&&(t.setTexture("reflectionSampler",i),o&&o.call(e,"reflectionSamplerSampler",i?.getInternalTexture()??null))}if(t.setMatrix("viewMatrix",this._scene.getViewMatrix()),t.setMatrix("invProjectionMatrix",this._invProjectionMatrix),t.setMatrix("projectionMatrix",this._scene.getProjectionMatrix()),t.setVector2("texelSize",a),t.setFloat("density",this.density),t.setFloat("refractionStrength",this.refractionStrength),t.setFloat("fresnelClamp",this.fresnelClamp),t.setFloat("specularPower",this.specularPower),t.setVector3("dirLight",this.dirLight),t.setFloat("cameraFar",this._camera.maxZ),this._debug){let i=null;switch(this._debugFeature){case 0:i=this._depthRenderTarget.texture;break;case 1:i=this._depthRenderTarget.enableBlur?this._depthRenderTarget.textureBlur:this._depthRenderTarget.texture;break;case 2:i=this._thicknessRenderTarget?.texture??null;break;case 3:i=this._thicknessRenderTarget?.enableBlur?this._thicknessRenderTarget?.textureBlur??null:this._thicknessRenderTarget?.texture??null;break;case 4:this._diffuseRenderTarget&&(i=this._diffuseRenderTarget.texture)}5!==this._debugFeature&&(t.setTexture("debugSampler",i),o&&o.call(e,"debugSamplerSampler",i?.getInternalTexture()??null))}})}_clearTargets(){this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),this._engine.clear(this._depthClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!0,!1),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),this._engine.clear(this._thicknessClearColor,!0,!1,!1),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget))}_render(e){if(this._needInitialization||!e.isReady())return;let t=this._engine._currentRenderTarget;this._engine.setState(!1,void 0,void 0,void 0,!0),this._engine.setDepthBuffer(!0),this._engine.setDepthWrite(!0),this._engine.setAlphaMode(0),this._depthRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._depthRenderTarget.renderTarget),e.renderDepthTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._depthRenderTarget.renderTarget)),this._diffuseRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._diffuseRenderTarget.renderTarget),e.renderDiffuseTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._diffuseRenderTarget.renderTarget)),this._thicknessRenderTarget?.renderTarget&&(this._engine.bindFramebuffer(this._thicknessRenderTarget.renderTarget),e.renderThicknessTexture(),this._engine.unbindInstanceAttributes(),this._engine.unBindFramebuffer(this._thicknessRenderTarget.renderTarget)),this._depthRenderTarget?.applyBlurPostProcesses(),this._diffuseRenderTarget?.applyBlurPostProcesses(),this._thicknessRenderTarget?.applyBlurPostProcesses(),t&&this._engine.bindFramebuffer(t)}dispose(e=!1){e||(this._depthRenderTarget?.dispose(),this._depthRenderTarget=null,this._diffuseRenderTarget?.dispose(),this._diffuseRenderTarget=null,this._thicknessRenderTarget?.dispose(),this._thicknessRenderTarget=null),this._renderPostProcess&&this._camera&&this._camera.detachPostProcess(this._renderPostProcess),this._renderPostProcess?.dispose(),this._renderPostProcess=null,this._needInitialization=!1}}class mO extends mR{getClassName(){return"FluidRenderingObjectCustomParticles"}get vertexBuffers(){return this._vertexBuffers}constructor(e,t,i,r){super(e,r),this._numParticles=i,this._diffuseEffectWrapper=null,this._vertexBuffers={},this.addBuffers(t)}addBuffers(e){for(let t in e){let i;let r=!0;switch(t){case"velocity":i=3;break;case"offset":r=!1}this._vertexBuffers[t]=new st.o(this._engine,e[t],t,!0,!1,i,r)}}_createEffects(){super._createEffects(),this._diffuseEffectWrapper=new cF.H({engine:this._engine,useShaderStore:!0,vertexShader:"fluidRenderingParticleDiffuse",fragmentShader:"fluidRenderingParticleDiffuse",attributeNames:["position","offset","color"],uniformNames:["view","projection","size"],samplerNames:[],shaderLanguage:this._shaderLanguage,extraInitializationsAsync:async()=>{1===this._shaderLanguage?await Promise.resolve().then(i.bind(i,17160)):await Promise.resolve().then(i.bind(i,96739))}})}isReady(){return this._vertexBuffers.offset||(this._vertexBuffers.offset=new st.o(this._engine,[0,0,1,0,0,1,1,1],"offset",!1,!1,2)),super.isReady()&&(this._diffuseEffectWrapper?.effect.isReady()??!1)}get numParticles(){return this._numParticles}setNumParticles(e){this._numParticles=e}renderDiffuseTexture(){let e=this.numParticles;if(!this._diffuseEffectWrapper||0===e)return;let t=this._diffuseEffectWrapper._drawWrapper,i=t.effect;this._engine.enableEffect(t),this._engine.bindBuffers(this.vertexBuffers,this.indexBuffer,i),i.setMatrix("view",this._scene.getViewMatrix()),i.setMatrix("projection",this._scene.getProjectionMatrix()),null!==this._particleSize&&i.setFloat2("size",this._particleSize,this._particleSize),this.useInstancing?this._engine.drawArraysType(7,0,4,e):this._engine.drawElementsType(0,0,e)}dispose(){for(let e in super.dispose(),this._diffuseEffectWrapper?.dispose(),this._vertexBuffers)this._vertexBuffers[e].dispose();this._vertexBuffers={}}}(e0=iH||(iH={}))[e0.None=0]="None",e0[e0.ToLinearSpace=1]="ToLinearSpace",e0[e0.ToGammaSpace=2]="ToGammaSpace";class mD{get shaderLanguage(){return this._shaderLanguage}_textureIsInternal(e){return void 0===e.getInternalTexture}constructor(e,t=!1){this._shaderLanguage=0,this._shadersLoaded=!1,this._engine=e,this._isDepthTexture=t,this._renderer=new cF.I(e),this._initShaderSourceAsync(t)}async _initShaderSourceAsync(e){let t=this._engine;t.isWebGPU?(this._shaderLanguage=1,await Promise.resolve().then(i.bind(i,26918))):await Promise.resolve().then(i.bind(i,87423)),this._shadersLoaded=!0,this._effectWrapper=new cF.H({engine:t,name:"CopyTextureToTexture",fragmentShader:"copyTextureToTexture",useShaderStore:!0,uniformNames:["conversion"],samplerNames:["textureSampler"],defines:e?["#define DEPTH_TEXTURE"]:[],shaderLanguage:this._shaderLanguage}),this._effectWrapper.onApplyObservable.add(()=>{e&&(t.setState(!1),t.setDepthBuffer(!0),t.depthCullingState.depthMask=!0,t.depthCullingState.depthFunc=519),this._textureIsInternal(this._source)?this._effectWrapper.effect._bindTexture("textureSampler",this._source):this._effectWrapper.effect.setTexture("textureSampler",this._source),this._effectWrapper.effect.setFloat("conversion",this._conversion)})}isReady(){return this._shadersLoaded&&this._effectWrapper.effect.isReady()}copy(e,t,i=0){if(!this.isReady())return!1;this._source=e,this._conversion=i;let r=this._engine.depthCullingState.depthFunc;return this._renderer.render(this._effectWrapper,t),this._isDepthTexture&&r&&(this._engine.depthCullingState.depthFunc=r),!0}dispose(){this._effectWrapper.dispose(),this._renderer.dispose()}}class mF{get depthRTWrapper(){return this._depthRTWrapper}constructor(e,t,i,r=1){this._engine=e,this._copyTextureToTexture=new mD(e,!0),this._depthRTWrapper=this._engine.createRenderTargetTexture({width:t,height:i},{generateMipMaps:!1,type:0,format:6,samplingMode:1,generateDepthBuffer:!0,generateStencilBuffer:!1,samples:r,noColorAttachment:!0,label:"FluidRenderingDepthTextureCopyRTT"}),this._depthRTWrapper.createDepthStencilTexture(0,!1,!1,1,void 0,"FluidRenderingDepthTextureCopyRTTDepthStencil").label=`FluidDepthTextureCopy${t}x${i}x${r}`}copy(e){return this._copyTextureToTexture.copy(e,this._depthRTWrapper)}dispose(){this._depthRTWrapper.dispose(),this._copyTextureToTexture.dispose()}}Object.defineProperty(rH.x.prototype,"fluidRenderer",{get:function(){return this._fluidRenderer},set:function(e){this._fluidRenderer=e},enumerable:!0,configurable:!0}),rH.x.prototype.enableFluidRenderer=function(){return this._fluidRenderer||(this._fluidRenderer=new mw(this)),this._fluidRenderer},rH.x.prototype.disableFluidRenderer=function(){this._fluidRenderer?.dispose(),this._fluidRenderer=null};class mL{constructor(e){this.name=rz.l.NAME_FLUIDRENDERER,this.scene=e}register(){this.scene._gatherActiveCameraRenderTargetsStage.registerStep(rz.l.STEP_GATHERACTIVECAMERARENDERTARGETS_FLUIDRENDERER,this,this._gatherActiveCameraRenderTargets),this.scene._afterCameraDrawStage.registerStep(rz.l.STEP_AFTERCAMERADRAW_FLUIDRENDERER,this,this._afterCameraDraw)}_gatherActiveCameraRenderTargets(e){this.scene.fluidRenderer?._prepareRendering()}_afterCameraDraw(e){this.scene.fluidRenderer?._render(e)}rebuild(){let e=this.scene.fluidRenderer;if(!e)return;let t=new Set;for(let i=0;i<e.renderObjects.length;++i){let r=e.renderObjects[i].object;if(r.addBuffers){let e=r.vertexBuffers;for(let i in e)t.add(e[i].getWrapperBuffer())}}t.forEach(e=>{e._rebuild()})}dispose(){this.scene.disableFluidRenderer()}}class mw{static _SceneComponentInitialization(e){let t=e._getComponent(rz.l.NAME_FLUIDRENDERER);t||(t=new mL(e),e._addComponent(t))}get shaderLanguage(){return this._shaderLanguage}constructor(e){this._shaderLanguage=0,this._scene=e,this._engine=e.getEngine(),this._onEngineResizeObserver=null,this.renderObjects=[],this.targetRenderers=[],this._cameras=new Map,mw._SceneComponentInitialization(this._scene),this._onEngineResizeObserver=this._engine.onResizeObservable.add(()=>{this._initialize()}),this._engine.isWebGPU&&(this._shaderLanguage=1)}recreate(){this._sortRenderingObjects(),this._initialize()}getRenderObjectFromParticleSystem(e){let t=this._getParticleSystemIndex(e);return -1!==t?this.renderObjects[t]:null}addParticleSystem(e,t,i,r){let s=new mA(this._scene,e,this._shaderLanguage);s.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),i||(i=new mN(this._scene,r,this._shaderLanguage),this.targetRenderers.push(i)),i._onUseVelocityChanged.hasObservers()||i._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),void 0!==t&&(i.generateDiffuseTexture=t);let n={object:s,targetRenderer:i};return this.renderObjects.push(n),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),n}addCustomParticles(e,t,i,r,s){let n=new mO(this._scene,e,t,this._shaderLanguage);n.onParticleSizeChanged.add(()=>this._setParticleSizeForRenderTargets()),r||(r=new mN(this._scene,s,this._shaderLanguage),this.targetRenderers.push(r)),r._onUseVelocityChanged.hasObservers()||r._onUseVelocityChanged.add(()=>this._setUseVelocityForRenderObject()),void 0!==i&&(r.generateDiffuseTexture=i);let a={object:n,targetRenderer:r};return this.renderObjects.push(a),this._sortRenderingObjects(),this._setParticleSizeForRenderTargets(),a}removeRenderObject(e,t=!0){let i=this.renderObjects.indexOf(e);return -1!==i&&(e.object.dispose(),this.renderObjects.splice(i,1),t&&this._removeUnusedTargetRenderers()?this._initialize():this._setParticleSizeForRenderTargets(),!0)}_sortRenderingObjects(){this.renderObjects.sort((e,t)=>e.object.priority<t.object.priority?-1:e.object.priority>t.object.priority?1:0)}_removeUnusedTargetRenderers(){let e={};for(let t=0;t<this.renderObjects.length;++t){let i=this.renderObjects[t].targetRenderer;e[this.targetRenderers.indexOf(i)]=!0}let t=!1,i=[];for(let r=0;r<this.targetRenderers.length;++r)e[r]?i.push(this.targetRenderers[r]):(this.targetRenderers[r].dispose(),t=!0);return t&&(this.targetRenderers.length=0,this.targetRenderers.push(...i)),t}_getParticleSystemIndex(e){for(let t=0;t<this.renderObjects.length;++t){let i=this.renderObjects[t].object;if(i.particleSystem&&i.particleSystem===e)return t}return -1}_initialize(){for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();let e=new Map;for(let t=0;t<this.targetRenderers.length;++t){let i=this.targetRenderers[t];if(i._initialize(),i.camera&&i._renderPostProcess){let r=e.get(i.camera);r||(r=[[],{}],e.set(i.camera,r)),r[0].push(i),i.camera.attachPostProcess(i._renderPostProcess,t)}}let t=e.keys();for(let i=t.next();!0!==i.done;i=t.next()){let t=i.value,r=e.get(t),s=t._getFirstPostProcess();if(!s)continue;let[n,a]=r;s.onSizeChangedObservable.add(()=>{for(let e of(s.inputTexture.depthStencilTexture||s.inputTexture.createDepthStencilTexture(0,!0,this._engine.isStencilEnable,n[0].samples,this._engine.isStencilEnable?13:14,`PostProcessRTTDepthStencil-${s.name}`),n)){let t=e._thicknessRenderTarget?.renderTarget,i=t?.texture;if(t&&i){let e=i.width+"_"+i.height,r=a[e];r||(r=a[e]=new mF(this._engine,i.width,i.height)),r.depthRTWrapper.shareDepth(t)}}})}t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){let t=i.value,r=this._cameras.get(t)[1],s=e.get(t);if(s)for(let e in r)s[1][e]||r[e].dispose();else for(let e in r)r[e].dispose()}this._cameras.clear(),this._cameras=e,this._setParticleSizeForRenderTargets()}_setParticleSizeForRenderTargets(){let e=new Map;for(let t=0;t<this.renderObjects.length;++t){let i=this.renderObjects[t],r=e.get(i.targetRenderer);void 0===r&&(r=0),e.set(i.targetRenderer,Math.max(r,i.object.particleSize))}e.forEach((e,t)=>{t._depthRenderTarget&&(t._depthRenderTarget.particleSize=e)})}_setUseVelocityForRenderObject(){for(let e of this.renderObjects)e.object.useVelocity=e.targetRenderer.useVelocity}_prepareRendering(){for(let e of this.targetRenderers)if(e.needInitialization){this._initialize();return}}_render(e){for(let t=0;t<this.targetRenderers.length;++t)e&&this.targetRenderers[t].camera!==e||this.targetRenderers[t]._clearTargets();let t=this._cameras.keys();for(let i=t.next();!0!==i.done;i=t.next()){let t=i.value,r=this._cameras.get(t);if(e&&t!==e)continue;let s=t._getFirstPostProcess();if(!s)continue;let n=s.inputTexture?.depthStencilTexture;if(n){let[e,t]=r;for(let t of e)t._bgDepthTexture=n;for(let e in t)t[e].copy(n)}}for(let t=0;t<this.renderObjects.length;++t){let i=this.renderObjects[t];e&&i.targetRenderer.camera!==e||i.targetRenderer._render(i.object)}}dispose(){this._engine.onResizeObservable.remove(this._onEngineResizeObserver),this._onEngineResizeObserver=null;for(let e=0;e<this.renderObjects.length;++e)this.renderObjects[e].object.dispose();for(let e=0;e<this.targetRenderers.length;++e)this.targetRenderers[e].dispose();this._cameras.forEach(e=>{let t=e[1];for(let e in t)t[e].dispose()}),this.renderObjects=[],this.targetRenderers=[],this._cameras.clear()}}i(15803),i(59325),i(95899),i(3977);let mB=`attribute vec3 position;attribute vec2 offset;attribute vec4 color;uniform mat4 view;uniform mat4 projection;uniform vec2 size;varying vec2 uv;varying vec3 diffuseColor;void main(void) {vec3 cornerPos;cornerPos.xy=vec2(offset.x-0.5,offset.y-0.5)*size;cornerPos.z=0.0;vec3 viewPos=(view*vec4(position,1.0)).xyz+cornerPos;gl_Position=projection*vec4(viewPos,1.0);uv=offset;diffuseColor=color.rgb;}
`;sG.v.ShadersStore.fluidRenderingParticleDiffuseVertexShader=mB,i(96739),i(54580),i(55520),i(36733),i(51083),i(68534),i(2530),i(74836);let mV=`attribute position: vec3f;attribute offset: vec2f;attribute color: vec4f;uniform view: mat4x4f;uniform projection: mat4x4f;uniform size: vec2f;varying uv: vec2f;varying diffuseColor: vec3f;@vertex
fn main(input: VertexInputs)->FragmentInputs {var cornerPos: vec3f=vec3f(
vec2f(input.offset.x-0.5,input.offset.y-0.5)*uniforms.size,
0.0
);var viewPos: vec3f=(uniforms.view*vec4f(input.position,1.0)).xyz+cornerPos;vertexOutputs.position=uniforms.projection*vec4f(viewPos,1.0);vertexOutputs.uv=input.offset;vertexOutputs.diffuseColor=input.color.rgb;}
`;sG.v.ShadersStoreWGSL.fluidRenderingParticleDiffuseVertexShader=mV,i(17160),i(85355),i(16785),i(26356);class mU extends o5.H{constructor(){super(...arguments),this.RSMCREATE=!1,this.RSMCREATE_PROJTEXTURE=!1,this.RSMCREATE_LIGHT_IS_SPOT=!1}}class mk extends hq.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,mk.Name,300,new mU),this._lightColor=new i2.Wo,this._hasProjectionTexture=!1,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._varAlbedoName=e instanceof ut.m?"surfaceAlbedo":"baseColor.rgb"}prepareDefines(e){e.RSMCREATE=this._isEnabled,this._hasProjectionTexture=!1;let t=this.light.getTypeID()===rN._.LIGHTTYPEID_SPOTLIGHT;if(t){let e=this.light;this._hasProjectionTexture=!!e.projectionTexture&&e.projectionTexture.isReady()}e.RSMCREATE_PROJTEXTURE=this._hasProjectionTexture,e.RSMCREATE_LIGHT_IS_SPOT=t,e.SCENE_MRT_COUNT=3}getClassName(){return"RSMCreatePluginMaterial"}getUniforms(){return{ubo:[{name:"rsmTextureProjectionMatrix",size:16,type:"mat4"},{name:"rsmSpotInfo",size:4,type:"vec4"},{name:"rsmLightColor",size:3,type:"vec3"},{name:"rsmLightPosition",size:3,type:"vec3"}],fragment:`#ifdef RSMCREATE
                    uniform mat4 rsmTextureProjectionMatrix;
                    uniform vec4 rsmSpotInfo;
                    uniform vec3 rsmLightColor;
                    uniform vec3 rsmLightPosition;
                #endif`}}getSamplers(e){e.push("rsmTextureProjectionSampler")}bindForSubMesh(e){if(this._isEnabled&&(this.light.diffuse.scaleToRef(this.light.getScaledIntensity(),this._lightColor),e.updateColor3("rsmLightColor",this._lightColor),this.light.getTypeID()===rN._.LIGHTTYPEID_SPOTLIGHT)){let t=this.light;this._hasProjectionTexture&&(e.updateMatrix("rsmTextureProjectionMatrix",t.projectionTextureMatrix),e.setTexture("rsmTextureProjectionSampler",t.projectionTexture));let i=i1.jp.Vector3[0];t.computeTransformedInformation()?(e.updateFloat3("rsmLightPosition",this.light.transformedPosition.x,this.light.transformedPosition.y,this.light.transformedPosition.z),t.transformedDirection.normalizeToRef(i)):(e.updateFloat3("rsmLightPosition",this.light.position.x,this.light.position.y,this.light.position.z),t.direction.normalizeToRef(i)),e.updateFloat4("rsmSpotInfo",i.x,i.y,i.z,Math.cos(.5*t.angle))}}getCustomCode(e,t){return"vertex"===e?null:1===t?{CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RSMCREATE
                    #ifdef RSMCREATE_PROJTEXTURE
                        var rsmTextureProjectionSamplerSampler: sampler;
                        var rsmTextureProjectionSampler: texture_2d<f32>;
                    #endif
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                #ifdef RSMCREATE
                    var rsmColor = ${this._varAlbedoName} * uniforms.rsmLightColor;
                    #ifdef RSMCREATE_PROJTEXTURE
                    {
                        var strq = uniforms.rsmTextureProjectionMatrix * vec4f(fragmentInputs.vPositionW, 1.0);
                        strq /= strq.w;
                        rsmColor *= textureSample(rsmTextureProjectionSampler, rsmTextureProjectionSamplerSampler, strq.xy).rgb;
                    }
                    #endif
                    #ifdef RSMCREATE_LIGHT_IS_SPOT
                    {
                        var cosAngle = max(0., dot(uniforms.rsmSpotInfo.xyz, normalize(fragmentInputs.vPositionW - uniforms.rsmLightPosition)));
                        rsmColor = sign(cosAngle - uniforms.rsmSpotInfo.w) * rsmColor;
                    }
                    #endif

                    #define MRT_AND_COLOR
                    fragmentOutputs.fragData0 = vec4f(fragmentInputs.vPositionW, 1.);
                    fragmentOutputs.fragData1 = vec4f(normalize(normalW) * 0.5 + 0.5, 1.);
                    fragmentOutputs.fragData2 = vec4f(rsmColor, 1.);
                #endif
            `}:{CUSTOM_FRAGMENT_BEGIN:`
                #ifdef RSMCREATE
                    #extension GL_EXT_draw_buffers : require
                #endif
            `,CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RSMCREATE
                    #ifdef RSMCREATE_PROJTEXTURE
                        uniform highp sampler2D rsmTextureProjectionSampler;                    
                    #endif
                    layout(location = 0) out highp vec4 glFragData[3];
                    vec4 glFragColor;
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR:`
                #ifdef RSMCREATE
                    vec3 rsmColor = ${this._varAlbedoName} * rsmLightColor;
                    #ifdef RSMCREATE_PROJTEXTURE
                    {
                        vec4 strq = rsmTextureProjectionMatrix * vec4(vPositionW, 1.0);
                        strq /= strq.w;
                        rsmColor *= texture2D(rsmTextureProjectionSampler, strq.xy).rgb;
                    }
                    #endif
                    #ifdef RSMCREATE_LIGHT_IS_SPOT
                    {
                        float cosAngle = max(0., dot(rsmSpotInfo.xyz, normalize(vPositionW - rsmLightPosition)));
                        rsmColor = sign(cosAngle - rsmSpotInfo.w) * rsmColor;
                    }
                    #endif
                    glFragData[0] = vec4(vPositionW, 1.);
                    glFragData[1] = vec4(normalize(normalW) * 0.5 + 0.5, 1.);
                    glFragData[2] = vec4(rsmColor, 1.);
                #endif
            `}}}mk.Name="RSMCreate",(0,r$.gn)([(0,rj.qC)()],mk.prototype,"light",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],mk.prototype,"isEnabled",void 0),(0,i3.H7)("BABYLON.RSMCreatePluginMaterial",mk);class mG{get enable(){return this._enable}set enable(e){0===this._giRSM.length&&(e=!1),e!==this._enable&&(this._enable=e,this._debugLayer.isEnabled=this._showOnlyGI&&e,this._materialsWithRenderPlugin.forEach(t=>{t.pluginManager&&(t.pluginManager.getPlugin(mH.Name).isEnabled=e)}),this.recreateResources(!e))}get enableBlur(){return this._enableBlur}set enableBlur(e){e!==this._enableBlur&&(this._enableBlur=e,this.recreateResources())}get useQualityBlur(){return this._useQualityBlur}set useQualityBlur(e){e!==this._useQualityBlur&&(this._useQualityBlur=e,this.recreateResources())}get fullSizeBlur(){return this._forceFullSizeBlur}set fullSizeBlur(e){this._forceFullSizeBlur!==e&&(this._forceFullSizeBlur=e,this.recreateResources())}get useQualityUpsampling(){return this._useQualityUpsampling}set useQualityUpsampling(e){e!==this._useQualityUpsampling&&(this._useQualityUpsampling=e,this.recreateResources())}get showOnlyGI(){return this._showOnlyGI}set showOnlyGI(e){this._showOnlyGI!==e&&(this._showOnlyGI=e,this._debugLayer.isEnabled=e)}get use32BitsDepthBuffer(){return this._use32BitsDepthBuffer}set use32BitsDepthBuffer(e){this._use32BitsDepthBuffer!==e&&(this._use32BitsDepthBuffer=e,this.recreateResources())}setOutputDimensions(e){this._outputDimensions=e,this.recreateResources()}setGITextureDimensions(e){this._giTextureDimensions=e,this.recreateResources()}get giTextureType(){return this._giTextureType}set giTextureType(e){this._giTextureType!==e&&(this._giTextureType=e,this.recreateResources())}get shaderLanguage(){return this._shaderLanguage}get giRSM(){return this._giRSM}addGIRSM(e){Array.isArray(e)?this._giRSM.push(...e):this._giRSM.push(e),this.recreateResources()}removeGIRSM(e){if(Array.isArray(e))for(let t=0;t<e.length;++t){let i=this._giRSM.indexOf(e[t]);-1!==i&&this._giRSM.splice(i,1)}else{let t=this._giRSM.indexOf(e);-1!==t&&this._giRSM.splice(t,1)}0===this._giRSM.length?this.enable=!1:this.recreateResources()}addMaterial(e){e?this._addGISupportToMaterial(e):this._scene.meshes.forEach(e=>{e.getTotalVertices()>0&&e.isEnabled()&&e.material&&this._addGISupportToMaterial(e.material)})}get countersGPU(){return this._counters}recreateResources(e=!1){if(!this._shadersLoaded){this._onShaderLoadedObservable.addOnce(()=>{this.recreateResources(e)});return}this._disposePostProcesses(e),this._createPostProcesses(),this._setPluginParameters()}generateSampleTexture(e){this._sampleTexture?.dispose(),this._maxSamples=e;let t=new Float32Array(4*this._maxSamples);for(let e=0;e<this._maxSamples;e++){let i=Math.random(),r=Math.random(),s=i*Math.sin(2*Math.PI*r),n=i*Math.cos(2*Math.PI*r);t[4*e+0]=s,t[4*e+1]=n,t[4*e+2]=i*i,t[4*e+3]=1}this._sampleTexture=new rK.l(t,this._maxSamples,1,5,this._scene,!1,!1,1,1),this._sampleTexture.name="GIRSMSamples"}dispose(){this._disposePostProcesses(!0),this._debugLayer.texture?.dispose(),this._debugLayer.dispose(),this._scene.onBeforeDrawPhaseObservable.remove(this._drawPhaseObserver)}constructor(e,t,i={width:256,height:256},r=2048,s=11){this._giRSM=[],this._blurRTT=null,this._blurPostProcesses=null,this._blurXPostprocess=null,this._blurYPostprocess=null,this._upsamplingXPostprocess=null,this._upsamplingYPostprocess=null,this._ppGlobalIllumination=[],this._firstActivation=!0,this._geomBufferEnabled=!1,this._geomBufferEnablePosition=!1,this._tempMatrix=new i1.y3,this._enable=!1,this.pause=!1,this._enableBlur=!0,this._useQualityBlur=!1,this.blurDepthThreshold=.05,this.blurNormalThreshold=.25,this.blurKernel=12,this._forceFullSizeBlur=!1,this._useQualityUpsampling=!1,this.upsamplerKernel=6,this._showOnlyGI=!1,this._use32BitsDepthBuffer=!1,this._shaderLanguage=0,this._shadersLoaded=!1,this._onShaderLoadedObservable=new i0.y$,this._scene=e,this._engine=e.getEngine(),this._outputDimensions=t,this._giTextureDimensions=i,this._giTextureType=s,this._materialsWithRenderPlugin=[],this._maxSamples=r,this._debugLayer=new cc.m("debug layer",null,this._scene,!1),this._debugLayer.isEnabled=!1,this._counters=[],this._countersRTW=[],this._initShaderSourceAsync(),this.generateSampleTexture(r),this._drawPhaseObserver=this._scene.onBeforeDrawPhaseObservable.add(()=>{let e=this._engine._currentRenderTarget,t=!1;if(this._enable){!this.pause&&(this._scene.postProcessManager.directRender(this._ppGlobalIllumination,this._ppGlobalIllumination[0].inputTexture),this._engine.unBindFramebuffer(this._ppGlobalIllumination[0].inputTexture,!0),this._engine.setAlphaMode(0),t=!0,this.enableBlur&&this._blurPostProcesses&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,this._blurRTT.renderTarget,!0),this._engine.unBindFramebuffer(this._blurRTT.renderTarget,!0)));for(let e=0;e<this._counters.length;++e){let t=this._countersRTW[e];for(let i=0;i<t.length;++i)0===i?this._counters[e].value=this.pause?0:t[i].gpuTimeInFrame?.counter.lastSecAverage??0:this.pause||(this._counters[e].value+=t[i].gpuTimeInFrame?.counter.lastSecAverage??0)}this._scene.activeCamera&&this._engine.setViewport(this._scene.activeCamera.viewport)}t&&e&&this._engine.bindFramebuffer(e)})}async _initShaderSourceAsync(){this._engine.isWebGPU?(this._shaderLanguage=1,await Promise.all([Promise.resolve().then(i.bind(i,98101)),Promise.resolve().then(i.bind(i,45971)),Promise.resolve().then(i.bind(i,4009)),Promise.resolve().then(i.bind(i,99640))])):await Promise.all([Promise.resolve().then(i.bind(i,90214)),Promise.resolve().then(i.bind(i,4497)),Promise.resolve().then(i.bind(i,47036)),Promise.resolve().then(i.bind(i,61354))]),this._shadersLoaded=!0,this._onShaderLoadedObservable.notifyObservers()}_disposePostProcesses(e=!1){for(let e of(this._blurRTT?.dispose(),this._blurRTT=null,this._blurPostProcesses=[],this._blurXPostprocess?.dispose(),this._blurXPostprocess=null,this._blurYPostprocess?.dispose(),this._blurYPostprocess=null,this._upsamplingXPostprocess?.dispose(),this._upsamplingXPostprocess=null,this._upsamplingYPostprocess?.dispose(),this._upsamplingYPostprocess=null,this._ppGlobalIllumination))e.dispose();this._ppGlobalIllumination=[],e&&(this._geomBufferEnabled?(this._scene.enableGeometryBufferRenderer(),this._scene.geometryBufferRenderer.enablePosition=this._geomBufferEnablePosition):this._scene.disableGeometryBufferRenderer()),this._counters=[],this._countersRTW=[]}_setPluginParameters(){this._enable&&this._materialsWithRenderPlugin.forEach(e=>{if(e.pluginManager){let t=e.pluginManager.getPlugin(mH.Name);t.textureGIContrib=this.enableBlur?this._blurRTT.renderTarget.texture:this._ppGlobalIllumination[0].inputTexture.texture,t.outputTextureWidth=this._outputDimensions.width,t.outputTextureHeight=this._outputDimensions.height}})}_createPostProcesses(){if(!this._enable)return;let e=13===this._giTextureType?4:5;this._firstActivation&&(this._firstActivation=!1,this._geomBufferEnabled=!!this._scene.geometryBufferRenderer,this._geomBufferEnablePosition=this._scene.geometryBufferRenderer?.enablePosition??!1),this._geomBufferEnabled||this._scene.disableGeometryBufferRenderer();let t=this._scene.enableGeometryBufferRenderer(this._enableBlur?this._outputDimensions:this._giTextureDimensions,this._use32BitsDepthBuffer?14:15,mG.GeometryBufferTextureTypesAndFormats);if(!t)throw Error("Geometry buffer renderer is not supported but is required for GIRSMManager.");t.enablePosition=!0,this._geomBufferEnabled||(t.generateNormalsInWorldSpace=!0);let i=t.normalsAreUnsigned,r=t.generateNormalsInWorldSpace;this._counters.push({name:"Geometry buffer renderer",value:0}),this._countersRTW.push([this._scene.geometryBufferRenderer.getGBuffer().renderTarget]);let s="";i&&(s+="#define DECODE_NORMAL\n"),r||(s+="#define TRANSFORM_NORMAL\n");for(let i=0;i<this._giRSM.length;++i){let n=this._giRSM[i],a=n.rsm,o=new sD.D("RSMGlobalIllumination"+i,n.useFullTexture?"rsmFullGlobalIllumination":"rsmGlobalIllumination",{...this._giTextureDimensions,uniforms:["rsmLightMatrix","rsmInfo","rsmInfo2","invView"],samplers:["normalSampler","rsmPositionW","rsmNormalW","rsmFlux","rsmSamples"],defines:s,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage});this._ppGlobalIllumination.push(o),0!==i&&(o.shareOutputWith(this._ppGlobalIllumination[0]),o.alphaMode=1),o.autoClear=!1,o.externalTextureSamplerBinding=!0,o.onApplyObservable.add(e=>{e.setTexture("textureSampler",t.getGBuffer().textures[t.getTextureIndex(pH.POSITION_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(pH.NORMAL_TEXTURE_TYPE)]),e.setTexture("rsmPositionW",a.positionWorldTexture),e.setTexture("rsmNormalW",a.normalWorldTexture),e.setTexture("rsmFlux",a.fluxTexture),e.setMatrix("rsmLightMatrix",a.lightTransformationMatrix),n.useFullTexture?e.setFloat4("rsmInfo",a.fluxTexture.getInternalTexture().width,a.fluxTexture.getInternalTexture().height,n.intensity,n.edgeArtifactCorrection):(e.setTexture("rsmSamples",this._sampleTexture),e.setFloat4("rsmInfo",n.numSamples,n.radius,n.intensity,n.edgeArtifactCorrection),e.setFloat4("rsmInfo2",n.noiseFactor,n.rotateSample?1:0,a.fluxTexture.getInternalTexture().width,a.fluxTexture.getInternalTexture().height)),r||(this._tempMatrix.copyFrom(this._scene.activeCamera.getViewMatrix()),this._tempMatrix.invert(),e.setMatrix("invView",this._tempMatrix))})}for(let e of this._ppGlobalIllumination)e.inputTexture||e.resize(this._giTextureDimensions.width,this._giTextureDimensions.height);if(this._counters.push({name:"GI generation",value:0}),this._countersRTW.push([this._ppGlobalIllumination[0].inputTexture]),this._enableBlur){let r=this._forceFullSizeBlur?this._outputDimensions:this._giTextureDimensions;this._blurRTT=new s2._("GIRSMContribution",this._outputDimensions,this._scene,{type:this._giTextureType,format:e,generateDepthBuffer:!1}),this._blurRTT.wrapU=0,this._blurRTT.wrapV=0,this._blurRTT.updateSamplingMode(1),this._blurRTT.skipInitialClear=!0;let s=[];if(this._counters.push({name:"GI blur",value:0}),this._countersRTW.push(s),this._blurXPostprocess=new sD.D(this._useQualityBlur?"BilateralBlur":"BilateralBlurX",this._useQualityBlur?"bilateralBlurQuality":"bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._blurXPostprocess.onApplyObservable.add(e=>{e._bindTexture("textureSampler",this._ppGlobalIllumination[0].inputTexture.texture),e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(pH.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(pH.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.blurKernel),e.setFloat2("blurDir",1/this._giTextureDimensions.width,this._useQualityBlur?1/this._giTextureDimensions.height:0),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)}),this._blurXPostprocess.externalTextureSamplerBinding=!0,this._blurXPostprocess.autoClear=!1,this._useQualityBlur||(this._blurYPostprocess=new sD.D("BilateralBlurY","bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._blurYPostprocess.autoClear=!1,this._blurYPostprocess.onApplyObservable.add(e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(pH.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(pH.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.blurKernel),e.setFloat2("blurDir",0,1/this._giTextureDimensions.height),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)}),this._blurYPostprocess.resize(r.width,r.height),s.push(this._blurYPostprocess.inputTexture)),this._blurPostProcesses=[this._blurXPostprocess],this._blurYPostprocess&&this._blurPostProcesses.push(this._blurYPostprocess),this._giTextureDimensions.width>=this._outputDimensions.width&&this._giTextureDimensions.height>=this._outputDimensions.height||this._forceFullSizeBlur)s.push(this._blurRTT.renderTarget);else{let n=[];this._counters.push({name:"GI upsampling",value:0}),this._countersRTW.push(n),this._upsamplingXPostprocess=new sD.D(this._useQualityUpsampling?"BilateralUpsampling":"BilateralUpsamplingX",this._useQualityUpsampling?"bilateralBlurQuality":"bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:r,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._upsamplingXPostprocess.autoClear=!1,this._upsamplingXPostprocess.onApplyObservable.add(e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(pH.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(pH.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.upsamplerKernel),e.setFloat2("blurDir",1/this._outputDimensions.width,this._useQualityUpsampling?1/this._outputDimensions.height:0),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)}),this._upsamplingXPostprocess.resize(r.width,r.height),s.push(this._upsamplingXPostprocess.inputTexture),this.useQualityUpsampling||(this._upsamplingYPostprocess=new sD.D("BilateralUpsamplingY","bilateralBlur",{uniforms:["filterSize","blurDir","depthThreshold","normalThreshold"],samplers:["depthSampler","normalSampler"],defines:i?"#define DECODE_NORMAL":void 0,size:this._outputDimensions,samplingMode:2,engine:this._engine,textureType:this._giTextureType,textureFormat:e,shaderLanguage:this._shaderLanguage}),this._upsamplingYPostprocess.autoClear=!1,this._upsamplingYPostprocess.onApplyObservable.add(e=>{e.setTexture("depthSampler",t.getGBuffer().textures[t.getTextureIndex(pH.DEPTH_TEXTURE_TYPE)]),e.setTexture("normalSampler",t.getGBuffer().textures[t.getTextureIndex(pH.NORMAL_TEXTURE_TYPE)]),e.setInt("filterSize",this.upsamplerKernel),e.setFloat2("blurDir",0,1/this._outputDimensions.height),e.setFloat("depthThreshold",this.blurDepthThreshold),e.setFloat("normalThreshold",this.blurNormalThreshold)}),this._upsamplingYPostprocess.resize(this._outputDimensions.width,this._outputDimensions.height),n.push(this._upsamplingYPostprocess.inputTexture)),n.push(this._blurRTT.renderTarget),this._blurPostProcesses.push(this._upsamplingXPostprocess),this._upsamplingYPostprocess&&this._blurPostProcesses.push(this._upsamplingYPostprocess)}}this._debugLayer.texture?.dispose(),this._debugLayer.texture=new o1.V(this._scene,this._enableBlur?this._blurRTT.renderTarget.texture:this._ppGlobalIllumination[0].inputTexture.texture)}_addGISupportToMaterial(e){if(e.pluginManager?.getPlugin(mH.Name))return;let t=new mH(e);this._enable&&this._ppGlobalIllumination.length>0&&(t.textureGIContrib=this._ppGlobalIllumination[0].inputTexture.texture,t.outputTextureWidth=this._outputDimensions.width,t.outputTextureHeight=this._outputDimensions.height),t.isEnabled=this._enable,this._materialsWithRenderPlugin.push(e)}}mG.GeometryBufferTextureTypesAndFormats={0:{textureType:2,textureFormat:6},1:{textureType:11,textureFormat:5},2:{textureType:2,textureFormat:5}};class mz extends o5.H{constructor(){super(...arguments),this.RENDER_WITH_GIRSM=!1,this.RSMCREATE_PROJTEXTURE=!1}}class mH extends hq.n{_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isCompatible(){return!0}constructor(e){super(e,mH.Name,310,new mz),this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._isPBR=e instanceof ut.m}prepareDefines(e){e.RENDER_WITH_GIRSM=this._isEnabled}getClassName(){return"GIRSMRenderPluginMaterial"}getUniforms(){return{ubo:[{name:"girsmTextureOutputSize",size:2,type:"vec2"}],fragment:`#ifdef RENDER_WITH_GIRSM
                    uniform vec2 girsmTextureOutputSize;
                #endif`}}getSamplers(e){e.push("girsmTextureGIContrib")}bindForSubMesh(e){this._isEnabled&&(e.bindTexture("girsmTextureGIContrib",this.textureGIContrib),e.updateFloat2("girsmTextureOutputSize",this.outputTextureWidth,this.outputTextureHeight))}getCustomCode(e,t){let i;return 1===t?(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_GIRSM
                    var girsmTextureGIContribSampler: sampler;
                    var girsmTextureGIContrib: texture_2d<f32>;

                    fn computeIndirect() -> vec3f {
                        var uv = fragmentInputs.position.xy / uniforms.girsmTextureOutputSize;
                        return textureSample(girsmTextureGIContrib, girsmTextureGIContribSampler, uv).rgb;
                    }
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:`
                #ifdef RENDER_WITH_GIRSM
                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;
                #endif
            `},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_GIRSM
                    color = vec4f(color.rgb + computeIndirect() * baseColor.rgb, color.a);
                #endif
            `)):(i={CUSTOM_FRAGMENT_DEFINITIONS:`
                #ifdef RENDER_WITH_GIRSM
                    uniform sampler2D girsmTextureGIContrib;

                    vec3 computeIndirect() {
                        vec2 uv = gl_FragCoord.xy / girsmTextureOutputSize;
                        return texture2D(girsmTextureGIContrib, uv).rgb;
                    }
                #endif
            `,CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION:`
                #ifdef RENDER_WITH_GIRSM
                    finalDiffuse += computeIndirect() * surfaceAlbedo.rgb;
                #endif
            `},this._isPBR||(i.CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR=`
                #ifdef RENDER_WITH_GIRSM
                    color.rgb += computeIndirect() * baseColor.rgb;
                #endif
            `)),"vertex"===e?null:i}}mH.Name="GIRSMRender",(0,r$.gn)([(0,rj.qC)()],mH.prototype,"textureGIContrib",void 0),(0,r$.gn)([(0,rj.qC)()],mH.prototype,"outputTextureWidth",void 0),(0,r$.gn)([(0,rj.qC)()],mH.prototype,"outputTextureHeight",void 0),(0,r$.gn)([(0,rj.qC)(),(0,rj.wz)("_markAllSubMeshesAsTexturesDirty")],mH.prototype,"isEnabled",void 0),(0,i3.H7)("BABYLON.GIRSMRenderPluginMaterial",mH),i(90214),i(4497),i(47036),i(61354),i(98101),i(45971),i(4009),i(99640),i(81042),i(74725),i(62598),i(18938),i(48272),i(94359),i(23581),i(96018),i(29688),i(98370),i(89298),i(87765),i(52478),i(80962),i(54576),i(3742),i(1934),i(97989),i(99221),i(5901),i(80188),i(58876),i(81140),i(93775),i(21419),i(66839),i(60398),i(71493),i(44370),i(61309),i(56327),i(57809),i(65608),i(67662),i(17434),i(74001),i(94012),i(69869),i(58742),i(70376),i(90893),i(71393),i(83750),i(83280),i(89092),i(69481),i(66925),i(34805),i(2338),i(66586),i(54734),i(34873),i(28346),i(78821),i(89970),i(32715),i(50324),i(31515),i(36050),i(49407);let mW=`#if defined(WEBGL2) || defined(WEBGPU) || defined(NATIVE)
#define TEXTUREFUNC(s,c,l) texture2DLodEXT(s,c,l)
#else
#define TEXTUREFUNC(s,c,b) texture2D(s,c,b)
#endif
precision highp float;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform float spriteCount;uniform sampler2D spriteSheet;uniform vec2 spriteMapSize;uniform vec2 outputSize;uniform vec2 stageSize;uniform sampler2D frameMap;uniform sampler2D tileMaps[LAYERS];uniform sampler2D animationMap;uniform vec3 colorMul;float mt;const float fdStep=1./4.;const float aFrameSteps=MAX_ANIMATION_FRAMES==0. ? 0. : 1./MAX_ANIMATION_FRAMES;mat4 getFrameData(float frameID){float fX=frameID/spriteCount;return mat4(
texture2D(frameMap,vec2(fX,0.),0.),
texture2D(frameMap,vec2(fX,fdStep*1.),0.),
texture2D(frameMap,vec2(fX,fdStep*2.),0.),
vec4(0.)
);}
void main(){vec4 color=vec4(0.);vec2 tileUV=fract(tUV);vec2 tileID=floor(tUV);vec2 sheetUnits=1./spriteMapSize;float spriteUnits=1./spriteCount;vec2 stageUnits=1./stageSize;for(int i=0; i<LAYERS; i++) {float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);if(animationData.y>0.) {mt=mod(time*animationData.z,1.0);for(float f=0.; f<MAX_ANIMATION_FRAMES; f++){if(animationData.y>mt){frameID=animationData.x;break;}
animationData=TEXTUREFUNC(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);}}
mat4 frameData=getFrameData(frameID+0.5);vec2 frameSize=(frameData[0].zw)/spriteMapSize;vec2 offset=frameData[0].xy*sheetUnits;vec2 ratio=frameData[2].xy/frameData[0].zw;
#ifdef FR_CW
if (frameData[2].z==1.){tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;}
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
#else
if (frameData[2].z==1.){
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
tileUV.xy=tileUV.yx;} else {tileUV.xy=fract(tUV).xy;
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
}
#endif
vec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);if (i==0){color=nc;} else {float alpha=min(color.a+nc.a,1.0);vec3 mixed=mix(color.xyz,nc.xyz,nc.a);color=vec4(mixed,alpha);}}
color.xyz*=colorMul;gl_FragColor=color;}
`;sG.v.ShadersStore.spriteMapPixelShader=mW;let mY=`precision highp float;attribute vec3 position;attribute vec3 normal;attribute vec2 uv;varying vec3 vPosition;varying vec2 vUV;varying vec2 tUV;uniform float time;uniform mat4 worldViewProjection;uniform vec2 stageSize;uniform float stageScale;void main() {vec4 p=vec4( position,1. );vPosition=p.xyz;vUV=uv;tUV=uv*stageSize; 
gl_Position=worldViewProjection*p;}`;sG.v.ShadersStore.spriteMapVertexShader=mY,(e1=iW||(iW={}))[e1.CCW=0]="CCW",e1[e1.CW=1]="CW",i(5566),i(12199),i(34560),i(39684),i(28858),i(83762),i(39360),(e2=iY||(iY={}))[e2.INIT=0]="INIT",e2[e2.RUNNING=1]="RUNNING",e2[e2.DONE=2]="DONE",e2[e2.ERROR=3]="ERROR";class mX{constructor(e){this.name=e,this._isCompleted=!1,this._taskState=0}get isCompleted(){return this._isCompleted}get taskState(){return this._taskState}get errorObject(){return this._errorObject}_setErrorObject(e,t){this._errorObject||(this._errorObject={message:e,exception:t})}run(e,t,i){this._taskState=1,this.runTask(e,()=>{this._onDoneCallback(t,i)},(e,t)=>{this._onErrorCallback(i,e,t)})}runTask(e,t,i){throw Error("runTask is not implemented")}reset(){this._taskState=0}_onErrorCallback(e,t,i){this._taskState=3,this._errorObject={message:t,exception:i},this.onError&&this.onError(this,t,i),e()}_onDoneCallback(e,t){try{this._taskState=2,this._isCompleted=!0,this.onSuccess&&this.onSuccess(this),e()}catch(e){this._onErrorCallback(t,"Task is done, error executing success callback(s)",e)}}}class m${constructor(e,t,i){this.remainingCount=e,this.totalCount=t,this.task=i}}class mj extends mX{constructor(e,t,i,r,s){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=r,this.extension=s}runTask(e,t,i){lh.n0.LoadAssetContainer(this.rootUrl,this.sceneFilename,e,e=>{this.loadedContainer=e,this.loadedMeshes=e.meshes,this.loadedTransformNodes=e.transformNodes,this.loadedParticleSystems=e.particleSystems,this.loadedSkeletons=e.skeletons,this.loadedAnimationGroups=e.animationGroups,t()},null,(e,t,r)=>{i(t,r)},this.extension)}}class mq extends mX{constructor(e,t,i,r,s){super(e),this.name=e,this.meshesNames=t,this.rootUrl=i,this.sceneFilename=r,this.extension=s}runTask(e,t,i){lh.n0.ImportMesh(this.meshesNames,this.rootUrl,this.sceneFilename,e,(e,i,r,s,n)=>{this.loadedMeshes=e,this.loadedTransformNodes=n,this.loadedParticleSystems=i,this.loadedSkeletons=r,this.loadedAnimationGroups=s,t()},null,(e,t,r)=>{i(t,r)},this.extension)}}class mQ extends mX{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,e=>{this.text=e,t()},void 0,!1,!1,(e,t)=>{e&&i(e.status+" "+e.statusText,t)})}}class mK extends mX{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){e._loadFile(this.url,e=>{this.data=e,t()},void 0,!0,!0,(e,t)=>{e&&i(e.status+" "+e.statusText,t)})}}class mZ extends mX{constructor(e,t){super(e),this.name=e,this.url=t}runTask(e,t,i){let r=new Image;rD.w1.SetCorsBehavior(this.url,r),r.onload=()=>{this.image=r,t()},r.onerror=e=>{i("Error loading image",e)},r.src=this.url}}class mJ extends mX{constructor(e,t,i,r=!0,s=rZ.x.TRILINEAR_SAMPLINGMODE){super(e),this.name=e,this.url=t,this.noMipmap=i,this.invertY=r,this.samplingMode=s}runTask(e,t,i){this.texture=new rZ.x(this.url,e,this.noMipmap,this.invertY,this.samplingMode,()=>{t()},(e,t)=>{i(e,t)})}}class m0 extends mX{constructor(e,t,i,r,s,n){super(e),this.name=e,this.url=t,this.extensions=i,this.noMipmap=r,this.files=s,this.prefiltered=n}runTask(e,t,i){this.texture=new o4(this.url,e,this.extensions,this.noMipmap,this.files,()=>{t()},(e,t)=>{i(e,t)},void 0,this.prefiltered)}}class m1 extends mX{constructor(e,t,i,r=!1,s=!0,n=!1,a=!1){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=r,this.generateHarmonics=s,this.gammaSpace=n,this.reserved=a}runTask(e,t,i){this.texture=new cw(this.url,e,this.size,this.noMipmap,this.generateHarmonics,this.gammaSpace,this.reserved,()=>{t()},(e,t)=>{i(e,t)})}}class m2 extends mX{constructor(e,t,i,r=!1,s=!0){super(e),this.name=e,this.url=t,this.size=i,this.noMipmap=r,this.gammaSpace=s}runTask(e,t,i){this.texture=new uu(this.url,e,this.size,this.noMipmap,this.gammaSpace,()=>{t()},(e,t)=>{i(e,t)})}}class m3{constructor(e){this._isLoading=!1,this._tasks=[],this._waitingTasksCount=0,this._totalTasksCount=0,this.onTaskSuccessObservable=new i0.y$,this.onTaskErrorObservable=new i0.y$,this.onTasksDoneObservable=new i0.y$,this.onProgressObservable=new i0.y$,this.useDefaultLoadingScreen=!0,this.autoHideLoadingUI=!0,this._scene=e||rh.l.LastCreatedScene}addContainerTask(e,t,i,r,s){let n=new mj(e,t,i,r,s);return this._tasks.push(n),n}addMeshTask(e,t,i,r,s){let n=new mq(e,t,i,r,s);return this._tasks.push(n),n}addTextFileTask(e,t){let i=new mQ(e,t);return this._tasks.push(i),i}addBinaryFileTask(e,t){let i=new mK(e,t);return this._tasks.push(i),i}addImageTask(e,t){let i=new mZ(e,t);return this._tasks.push(i),i}addTextureTask(e,t,i,r,s=rZ.x.TRILINEAR_SAMPLINGMODE){let n=new mJ(e,t,i,r,s);return this._tasks.push(n),n}addCubeTextureTask(e,t,i,r,s,n){let a=new m0(e,t,i,r,s,n);return this._tasks.push(a),a}addHDRCubeTextureTask(e,t,i,r=!1,s=!0,n=!1,a=!1){let o=new m1(e,t,i,r,s,n,a);return this._tasks.push(o),o}addEquiRectangularCubeTextureAssetTask(e,t,i,r=!1,s=!0){let n=new m2(e,t,i,r,s);return this._tasks.push(n),n}removeTask(e){let t=this._tasks.indexOf(e);t>-1&&this._tasks.splice(t,1)}_decreaseWaitingTasksCount(e){this._waitingTasksCount--;try{this.onProgress&&this.onProgress(this._waitingTasksCount,this._totalTasksCount,e),this.onProgressObservable.notifyObservers(new m$(this._waitingTasksCount,this._totalTasksCount,e))}catch(e){re.Y.Error("Error running progress callbacks."),re.Y.Log(e)}if(0===this._waitingTasksCount){try{let e=this._tasks.slice();for(let t of(this.onFinish&&this.onFinish(e),e))if(2===t.taskState){let e=this._tasks.indexOf(t);e>-1&&this._tasks.splice(e,1)}this.onTasksDoneObservable.notifyObservers(this._tasks)}catch(e){re.Y.Error("Error running tasks-done callbacks."),re.Y.Log(e)}this._isLoading=!1,this.autoHideLoadingUI&&this._scene.getEngine().hideLoadingUI()}}_runTask(e){let t=(t,i)=>{e._setErrorObject(t,i),this.onTaskError?this.onTaskError(e):e.onError||re.Y.Error(this._formatTaskErrorMessage(e)),this.onTaskErrorObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)};e.run(this._scene,()=>{try{this.onTaskSuccess&&this.onTaskSuccess(e),this.onTaskSuccessObservable.notifyObservers(e),this._decreaseWaitingTasksCount(e)}catch(e){t("Error executing task success callbacks",e)}},t)}_formatTaskErrorMessage(e){let t="Unable to complete task "+e.name;return e.errorObject.message&&(t+=`: ${e.errorObject.message}`),e.errorObject.exception&&(t+=`: ${e.errorObject.exception}`),t}reset(){return this._isLoading=!1,this._tasks=[],this}load(){if(this._isLoading)return this;if(this._isLoading=!0,this._waitingTasksCount=this._tasks.length,this._totalTasksCount=this._tasks.length,0===this._waitingTasksCount)return this._isLoading=!1,this.onFinish&&this.onFinish(this._tasks),this.onTasksDoneObservable.notifyObservers(this._tasks),this;this.useDefaultLoadingScreen&&this._scene.getEngine().displayLoadingUI();for(let e=0;e<this._tasks.length;e++){let t=this._tasks[e];0===t.taskState&&this._runTask(t)}return this}loadAsync(){return new Promise((e,t)=>{if(this._isLoading){e();return}this.onTasksDoneObservable.addOnce(i=>{i&&i.length?t(i):e()}),this.load()})}}i(84684),i(90580),i(26584),i(24243),i0.y$.prototype.notifyObserversWithPromise=async function(e,t=-1,i,r,s){let n=Promise.resolve(e);if(!this.observers.length)return n;let a=this._eventState;return a.mask=t,a.target=i,a.currentTarget=r,a.skipNextObservers=!1,a.userInfo=s,this.observers.forEach(i=>{!a.skipNextObservers&&!i._willBeUnregistered&&i.mask&t&&(n=i.scope?n.then(t=>(a.lastReturnValue=t,i.callback.apply(i.scope,[e,a]))):n.then(t=>(a.lastReturnValue=t,i.callback(e,a))),i.unregisterOnNextCall&&this._deferUnregister(i))}),await n,e};class m4{getDescription(){return""}apply(e,t){return!0}constructor(e=0){this.priority=e}}class m5 extends m4{getDescription(){return"Reducing render target texture size to "+this.maximumSize}constructor(e=0,t=1024,i=.5){super(e),this.priority=e,this.maximumSize=t,this.step=i}apply(e,t){let i=!0;for(let t=0;t<e.textures.length;t++){let r=e.textures[t];if(!r.canRescale||r.getContext)continue;let s=r.getSize();Math.max(s.width,s.height)>this.maximumSize&&(r.scale(this.step),i=!1)}return i}}class m7 extends m4{getDescription(){return"Setting hardware scaling level to "+this._currentScale}constructor(e=0,t=2,i=.25){super(e),this.priority=e,this.maximumScale=t,this.step=i,this._currentScale=-1,this._directionOffset=1}apply(e,t){return -1===this._currentScale&&(this._currentScale=e.getEngine().getHardwareScalingLevel(),this._currentScale>this.maximumScale&&(this._directionOffset=-1)),this._currentScale+=this._directionOffset*this.step,e.getEngine().setHardwareScalingLevel(this._currentScale),1===this._directionOffset?this._currentScale>=this.maximumScale:this._currentScale<=this.maximumScale}}class m6 extends m4{getDescription(){return"Turning shadows on/off"}apply(e,t){return e.shadowsEnabled=t.isInImprovementMode,!0}}class m8 extends m4{getDescription(){return"Turning post-processes on/off"}apply(e,t){return e.postProcessesEnabled=t.isInImprovementMode,!0}}class m9 extends m4{getDescription(){return"Turning lens flares on/off"}apply(e,t){return e.lensFlaresEnabled=t.isInImprovementMode,!0}}class _e extends m4{getDescription(){return this.onGetDescription?this.onGetDescription():"Running user defined callback"}apply(e,t){return!this.onApply||this.onApply(e,t)}}class _t extends m4{getDescription(){return"Turning particles on/off"}apply(e,t){return e.particlesEnabled=t.isInImprovementMode,!0}}class _i extends m4{getDescription(){return"Turning render targets off"}apply(e,t){return e.renderTargetsEnabled=t.isInImprovementMode,!0}}class _r extends m4{constructor(){super(...arguments),this._canBeMerged=e=>e instanceof rP.Kj&&!e.isDisposed()&&!!e.isVisible&&!!e.isEnabled()&&!(e.instances.length>0)&&!e.skeleton&&!e.hasLODLevels&&0!==e.getTotalVertices()}static get UpdateSelectionTree(){return _r._UpdateSelectionTree}static set UpdateSelectionTree(e){_r._UpdateSelectionTree=e}getDescription(){return"Merging similar meshes together"}apply(e,t,i){let r=e.meshes.slice(0),s=r.length;for(let e=0;e<s;e++){let t=[],i=r[e];if(this._canBeMerged(i)){t.push(i);for(let n=e+1;n<s;n++){let e=r[n];this._canBeMerged(e)&&e.material===i.material&&e.checkCollisions===i.checkCollisions&&(t.push(e),s--,r.splice(n,1),n--)}t.length<2||rP.Kj.MergeMeshes(t,void 0,!0)}}return e.createOrUpdateSelectionOctree&&(void 0!=i?i&&e.createOrUpdateSelectionOctree():_r.UpdateSelectionTree&&e.createOrUpdateSelectionOctree()),!0}}_r._UpdateSelectionTree=!1;class _s{constructor(e=60,t=2e3){this.targetFrameRate=e,this.trackerDuration=t,this.optimizations=[]}addOptimization(e){return this.optimizations.push(e),this}addCustomOptimization(e,t,i=0){let r=new _e(i);return r.onApply=e,r.onGetDescription=t,this.optimizations.push(r),this}static LowDegradationAllowed(e){let t=new _s(e),i=0;return t.addOptimization(new _r(i)),t.addOptimization(new m6(i)),t.addOptimization(new m9(i)),i++,t.addOptimization(new m8(i)),t.addOptimization(new _t(i)),i++,t.addOptimization(new m5(i,1024)),t}static ModerateDegradationAllowed(e){let t=new _s(e),i=0;return t.addOptimization(new _r(i)),t.addOptimization(new m6(i)),t.addOptimization(new m9(i)),i++,t.addOptimization(new m8(i)),t.addOptimization(new _t(i)),i++,t.addOptimization(new m5(i,512)),i++,t.addOptimization(new _i(i)),i++,t.addOptimization(new m7(i,2)),t}static HighDegradationAllowed(e){let t=new _s(e),i=0;return t.addOptimization(new _r(i)),t.addOptimization(new m6(i)),t.addOptimization(new m9(i)),i++,t.addOptimization(new m8(i)),t.addOptimization(new _t(i)),i++,t.addOptimization(new m5(i,256)),i++,t.addOptimization(new _i(i)),i++,t.addOptimization(new m7(i,4)),t}}class _n{get isInImprovementMode(){return this._improvementMode}set isInImprovementMode(e){this._improvementMode=e}get currentPriorityLevel(){return this._currentPriorityLevel}get currentFrameRate(){return this._currentFrameRate}get targetFrameRate(){return this._targetFrameRate}set targetFrameRate(e){this._targetFrameRate=e}get trackerDuration(){return this._trackerDuration}set trackerDuration(e){this._trackerDuration=e}get optimizations(){return this._options.optimizations}constructor(e,t,i=!0,r=!1){if(this._isRunning=!1,this._currentPriorityLevel=0,this._targetFrameRate=60,this._trackerDuration=2e3,this._currentFrameRate=0,this._improvementMode=!1,this.onSuccessObservable=new i0.y$,this.onNewOptimizationAppliedObservable=new i0.y$,this.onFailureObservable=new i0.y$,t?this._options=t:this._options=new _s,this._options.targetFrameRate&&(this._targetFrameRate=this._options.targetFrameRate),this._options.trackerDuration&&(this._trackerDuration=this._options.trackerDuration),i){let e=0;for(let t of this._options.optimizations)t.priority=e++}this._improvementMode=r,this._scene=e||rh.l.LastCreatedScene,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>{this._sceneDisposeObserver=null,this.dispose()})}stop(){this._isRunning=!1}reset(){this._currentPriorityLevel=0}start(){this._isRunning||(this._isRunning=!0,this._scene.executeWhenReady(()=>{setTimeout(()=>{this._checkCurrentState()},this._trackerDuration)}))}_checkCurrentState(){if(!this._isRunning)return;let e=this._scene,t=this._options;if(this._currentFrameRate=Math.round(e.getEngine().getFps()),this._improvementMode&&this._currentFrameRate<=this._targetFrameRate||!this._improvementMode&&this._currentFrameRate>=this._targetFrameRate){this._isRunning=!1,this.onSuccessObservable.notifyObservers(this);return}let i=!0,r=!0;for(let s=0;s<t.optimizations.length;s++){let n=t.optimizations[s];n.priority===this._currentPriorityLevel&&(r=!1,i=i&&n.apply(e,this),this.onNewOptimizationAppliedObservable.notifyObservers(n))}if(r){this._isRunning=!1,this.onFailureObservable.notifyObservers(this);return}i&&this._currentPriorityLevel++,e.executeWhenReady(()=>{setTimeout(()=>{this._checkCurrentState()},this._trackerDuration)})}dispose(){this.stop(),this.onSuccessObservable.clear(),this.onFailureObservable.clear(),this.onNewOptimizationAppliedObservable.clear(),this._sceneDisposeObserver&&this._scene.onDisposeObservable.remove(this._sceneDisposeObserver)}static OptimizeAsync(e,t,i,r){let s=new _n(e,t||_s.ModerateDegradationAllowed(),!1);return i&&s.onSuccessObservable.add(()=>{i()}),r&&s.onFailureObservable.add(()=>{r()}),s.start(),s}}let _a=[],_o=(e,t)=>{e.doNotSerialize||(t.vertexData.push(e.serializeVerticeData()),_a[e.id]=!0)},_l=(e,t)=>{let i={},r=e._geometry;return r&&!e.getScene().getGeometryById(r.id)&&_o(r,t.geometries),e.serialize&&e.serialize(i),i},_c=(e,t)=>{if(e._isMesh){if(1===e.delayLoadState||0===e.delayLoadState){let i=i=>{t.materials=t.materials||[],e.material&&!t.materials.some(t=>t.id===e.material.id)&&t.materials.push(i.serialize())};if(e.material&&!e.material.doNotSerialize){if(e.material instanceof cN.G){if(t.multiMaterials=t.multiMaterials||[],!t.multiMaterials.some(t=>t.id===e.material.id))for(let r of(t.multiMaterials.push(e.material.serialize()),e.material.subMaterials))r&&i(r)}else i(e.material)}else e.material||i(e.getScene().defaultMaterial);let r=e._geometry;r&&(t.geometries||(t.geometries={},t.geometries.boxes=[],t.geometries.spheres=[],t.geometries.cylinders=[],t.geometries.toruses=[],t.geometries.grounds=[],t.geometries.planes=[],t.geometries.torusKnots=[],t.geometries.vertexData=[]),_o(r,t.geometries)),e.skeleton&&!e.skeleton.doNotSerialize&&(t.skeletons=t.skeletons||[],t.skeletons.push(e.skeleton.serialize())),t.meshes=t.meshes||[],t.meshes.push(_l(e,t))}}else"TransformNode"===e.getClassName()?t.transformNodes.push(e.serialize()):-1!==e.getClassName().indexOf("Camera")?t.cameras.push(e.serialize()):-1!==e.getClassName().indexOf("Light")&&t.lights.push(e.serialize())};class _u{static ClearCache(){_a=[]}static Serialize(e){return _u._Serialize(e)}static _Serialize(e,t=!0){let i,r,s;let n={};if(t&&!e.getEngine()._features.supportSyncTextureRead&&rZ.x.ForceSerializeBuffers&&re.Y.Warn("The serialization object may not contain the proper base64 encoded texture data! You should use the SerializeAsync method instead."),_u.ClearCache(),n.useDelayedTextureLoading=e.useDelayedTextureLoading,n.autoClear=e.autoClear,n.clearColor=e.clearColor.asArray(),n.ambientColor=e.ambientColor.asArray(),n.gravity=e.gravity.asArray(),n.collisionsEnabled=e.collisionsEnabled,n.useRightHandedSystem=e.useRightHandedSystem,void 0!==e.fogMode&&null!==e.fogMode&&(n.fogMode=e.fogMode),void 0!==e.fogColor&&null!==e.fogColor&&(n.fogColor=e.fogColor.asArray()),void 0!==e.fogStart&&null!==e.fogStart&&(n.fogStart=e.fogStart),void 0!==e.fogEnd&&null!==e.fogEnd&&(n.fogEnd=e.fogEnd),void 0!==e.fogDensity&&null!==e.fogDensity&&(n.fogDensity=e.fogDensity),e.isPhysicsEnabled&&e.isPhysicsEnabled()){let t=e.getPhysicsEngine();t&&(n.physicsEnabled=!0,n.physicsGravity=t.gravity.asArray(),n.physicsEngine=t.getPhysicsPluginName())}for(let t of(e.metadata&&(n.metadata=e.metadata),n.morphTargetManagers=[],e.meshes)){let e=t.morphTargetManager;e&&n.morphTargetManagers.push(e.serialize())}for(i=0,n.lights=[];i<e.lights.length;i++)(r=e.lights[i]).doNotSerialize||n.lights.push(r.serialize());for(i=0,n.cameras=[];i<e.cameras.length;i++){let t=e.cameras[i];t.doNotSerialize||n.cameras.push(t.serialize())}if(e.activeCamera&&(n.activeCameraID=e.activeCamera.id),rq.p.AppendSerializedAnimations(e,n),e.animationGroups&&e.animationGroups.length>0){n.animationGroups=[];for(let t=0;t<e.animationGroups.length;t++){let i=e.animationGroups[t];n.animationGroups.push(i.serialize())}}if(e.reflectionProbes&&e.reflectionProbes.length>0)for(i=0,n.reflectionProbes=[];i<e.reflectionProbes.length;i++){let t=e.reflectionProbes[i];n.reflectionProbes.push(t.serialize())}for(i=0,n.materials=[],n.multiMaterials=[];i<e.materials.length;i++)(s=e.materials[i]).doNotSerialize||n.materials.push(s.serialize());for(i=0,n.multiMaterials=[];i<e.multiMaterials.length;i++){let t=e.multiMaterials[i];n.multiMaterials.push(t.serialize())}for(e.environmentTexture&&(e.environmentTexture._files?n.environmentTexture=e.environmentTexture.serialize():(n.environmentTexture=e.environmentTexture.name,n.environmentTextureRotationY=e.environmentTexture.rotationY)),n.environmentIntensity=e.environmentIntensity,n.skeletons=[],i=0;i<e.skeletons.length;i++){let t=e.skeletons[i];t.doNotSerialize||n.skeletons.push(t.serialize())}for(i=0,n.transformNodes=[];i<e.transformNodes.length;i++)e.transformNodes[i].doNotSerialize||n.transformNodes.push(e.transformNodes[i].serialize());n.geometries={},n.geometries.boxes=[],n.geometries.spheres=[],n.geometries.cylinders=[],n.geometries.toruses=[],n.geometries.grounds=[],n.geometries.planes=[],n.geometries.torusKnots=[],n.geometries.vertexData=[],_a=[];let a=e.getGeometries();for(i=0;i<a.length;i++){let e=a[i];e.isReady()&&_o(e,n.geometries)}for(i=0,n.meshes=[];i<e.meshes.length;i++){let t=e.meshes[i];t instanceof rP.Kj&&!t.doNotSerialize&&(1===t.delayLoadState||0===t.delayLoadState)&&n.meshes.push(_l(t,n))}for(i=0,n.particleSystems=[];i<e.particleSystems.length;i++)n.particleSystems.push(e.particleSystems[i].serialize(!1));for(i=0,n.postProcesses=[];i<e.postProcesses.length;i++)n.postProcesses.push(e.postProcesses[i].serialize());for(let t of(e.actionManager&&(n.actions=e.actionManager.serialize("scene")),e._serializableComponents))t.serialize(n);if(e.spriteManagers)for(i=0,n.spriteManagers=[];i<e.spriteManagers.length;i++)n.spriteManagers.push(e.spriteManagers[i].serialize(!0));return n}static SerializeAsync(e){let t=_u._Serialize(e,!1),i=[];return this._CollectPromises(t,i),Promise.all(i).then(()=>t)}static _CollectPromises(e,t){if(Array.isArray(e))for(let i=0;i<e.length;++i){let r=e[i];r instanceof Promise?t.push(r.then(t=>e[i]=t)):(r instanceof Object||Array.isArray(r))&&this._CollectPromises(r,t)}else if(e instanceof Object){for(let i in e)if(Object.prototype.hasOwnProperty.call(e,i)){let r=e[i];r instanceof Promise?t.push(r.then(t=>e[i]=t)):(r instanceof Object||Array.isArray(r))&&this._CollectPromises(r,t)}}}static SerializeMesh(e,t=!1,i=!1){let r={};if(r.meshes=[],r.transformNodes=[],r.cameras=[],r.lights=[],_u.ClearCache(),e=e instanceof Array?e:[e],t||i)for(let r=0;r<e.length;++r)i&&e[r].getDescendants().forEach(t=>{0>e.indexOf(t)&&!t.doNotSerialize&&e.push(t)}),t&&e[r].parent&&0>e.indexOf(e[r].parent)&&!e[r].parent.doNotSerialize&&e.push(e[r].parent);return e.forEach(e=>{_c(e,r)}),r}}i(88388),i(88734),i(44667),i(93148),i(91511);class _h{static IsSupported(e,t){let i=t??e.getRenderingCanvas();return!!i&&"function"==typeof i.captureStream}get isRecording(){return!!this._canvas&&this._isRecording}constructor(e,t={}){if(!_h.IsSupported(e,t.canvas))throw"Your browser does not support recording so far.";let i=t.canvas??e.getRenderingCanvas();if(!i)throw"The babylon engine must have a canvas to be recorded";this._canvas=i,this._isRecording=!1,this._options={..._h._DefaultOptions,...t};let r=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(let e of this._options.audioTracks)r.addTrack(e);this._mediaRecorder=new MediaRecorder(r,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=e=>this._handleDataAvailable(e),this._mediaRecorder.onerror=e=>this._handleError(e),this._mediaRecorder.onstop=()=>this._handleStop()}stopRecording(){this._canvas&&this._mediaRecorder&&this.isRecording&&(this._isRecording=!1,this._mediaRecorder.stop())}startRecording(e="babylonjs.webm",t=7){if(!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return t>0&&setTimeout(()=>{this.stopRecording()},1e3*t),this._fileName=e,this._recordedChunks=[],this._resolve=null,this._reject=null,this._isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise((e,t)=>{this._resolve=e,this._reject=t})}dispose(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null}_handleDataAvailable(e){e.data.size>0&&this._recordedChunks.push(e.data)}_handleError(e){if(this.stopRecording(),this._reject)this._reject(e.error);else throw new e.error}_handleStop(){this.stopRecording();let e=new Blob(this._recordedChunks);this._resolve&&this._resolve(e),window.URL.createObjectURL(e),this._fileName&&rD.w1.Download(e,this._fileName)}}_h._DefaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3};var _d=i(32514);let _f=null;function _p(e,t,i,r,s="image/png",n=!1,a){let{height:o,width:l}=__(e,t,i);if(!(o&&l)){re.Y.Error("Invalid 'size' parameter !");return}_f||(_f=document.createElement("canvas")),_f.width=l,_f.height=o;let c=_f.getContext("2d"),u=e.getRenderWidth()/e.getRenderHeight(),h=l,d=h/u;d>o&&(h=(d=o)*u);let f=Math.max(0,l-h)/2,p=Math.max(0,o-d)/2;t.getScene().activeCamera!==t?_m(e,t,i,e=>{if(n){let t=new Blob([e]);rD.w1.DownloadBlob(t),r&&r("")}else r&&r(e)},s,1,e.getCreationOptions().antialias,void 0,void 0,void 0,void 0,a):e.onEndFrameObservable.addOnce(()=>{let t=e.getRenderingCanvas();c&&t&&c.drawImage(t,f,p,h,d),_f&&(n?(rD.w1.EncodeScreenshotCanvasData(_f,void 0,s,void 0,a),r&&r("")):rD.w1.EncodeScreenshotCanvasData(_f,r,s,void 0,a))})}function _m(e,t,r,s,n="image/png",a=1,o=!1,l,c=!1,u=!1,h=!0,d,f){let{height:p,width:m,finalWidth:_,finalHeight:g}=__(e,t,r);if(!(p&&m)){re.Y.Error("Invalid 'size' parameter !");return}let v={width:e.getRenderWidth(),height:e.getRenderHeight()};e.setSize(m,p);let S=t.getScene(),x=new s2._("screenShot",{width:m,height:p},S,!1,!1,0,!1,rZ.x.BILINEAR_SAMPLINGMODE,void 0,u,void 0,void 0,void 0,a);x.renderList=S.meshes.slice(),x.samples=a,x.renderSprites=c,x.activeCamera=t,x.forceLayerMaskCheck=h,f?.(x);let E=()=>{x.isReadyForRendering()&&t.isReady(!0)?(e.onEndFrameObservable.addOnce(()=>{_===m&&g===p?x.readPixels(void 0,void 0,void 0,!1).then(e=>{(0,_d.DumpData)(m,p,e,s,n,l,!0,void 0,d),x.dispose()}):(e.isWebGPU?Promise.resolve().then(i.bind(i,98974)):Promise.resolve().then(i.bind(i,97534))).then(()=>(0,a1.$0)("pass",x.getInternalTexture(),S,void 0,void 0,void 0,_,g).then(t=>{e._readTexturePixels(t,_,g,-1,0,null,!0,!1,0,0).then(e=>{(0,_d.DumpData)(_,g,e,s,n,l,!0,void 0,d),t.dispose()})}))}),S.incrementRenderId(),S.resetCachedMaterial(),x.render(!0),e.setSize(v.width,v.height),t.getProjectionMatrix(!0),S.render()):setTimeout(E,16)},C=()=>{S.incrementRenderId(),S.resetCachedMaterial(),E()};if(o){let e=new pU("antialiasing",1,S.activeCamera);x.addPostProcess(e),e.onEffectCreatedObservable.addOnce(e=>{e.isReady()?C():e.onCompiled=()=>{C()}})}else C()}function __(e,t,i){let r=0,s=0,n=0,a=0;if("object"==typeof i){let o=i.precision?Math.abs(i.precision):1;i.width&&i.height?(r=i.height*o,s=i.width*o):i.width&&!i.height?r=Math.round((s=i.width*o)/e.getAspectRatio(t)):i.height&&!i.width?s=Math.round((r=i.height*o)*e.getAspectRatio(t)):r=Math.round((s=Math.round(e.getRenderWidth()*o))/e.getAspectRatio(t)),i.finalWidth&&i.finalHeight?(a=i.finalHeight,n=i.finalWidth):i.finalWidth&&!i.finalHeight?a=Math.round((n=i.finalWidth)/e.getAspectRatio(t)):i.finalHeight&&!i.finalWidth?n=Math.round((a=i.finalHeight)*e.getAspectRatio(t)):(n=s,a=r)}else isNaN(i)||(r=i,s=i,n=i,a=i);return s&&(s=Math.floor(s)),r&&(r=Math.floor(r)),n&&(n=Math.floor(n)),a&&(a=Math.floor(a)),{height:0|r,width:0|s,finalWidth:0|n,finalHeight:0|a}}rD.w1.CreateScreenshot=_p,rD.w1.CreateScreenshotAsync=function(e,t,i,r="image/png",s){return new Promise((n,a)=>{_p(e,t,i,e=>{void 0!==e?n(e):a(Error("Data is undefined"))},r,void 0,s)})},rD.w1.CreateScreenshotUsingRenderTarget=_m,rD.w1.CreateScreenshotUsingRenderTargetAsync=function(e,t,i,r="image/png",s=1,n=!1,a,o=!1,l=!1,c=!0,u,h){return new Promise((d,f)=>{_m(e,t,i,e=>{void 0!==e?d(e):f(Error("Data is undefined"))},r,s,n,a,o,l,c,u,h)})},(e3=iX||(iX={}))[e3.Checkbox=0]="Checkbox",e3[e3.Slider=1]="Slider",e3[e3.Vector3=2]="Vector3",e3[e3.Quaternion=3]="Quaternion",e3[e3.Color3=4]="Color3",e3[e3.String=5]="String",e3[e3.Button=6]="Button",e3[e3.Options=7]="Options",e3[e3.Tab=8]="Tab",e3[e3.FileButton=9]="FileButton",e3[e3.Vector2=10]="Vector2",i(99265),i(79927);class _g{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{let e={};return{getItem:t=>{let i=e[t];return void 0===i?null:i},setItem:(t,i)=>{e[t]=i}}}}static ReadString(e,t){let i=this._Storage.getItem(e);return null!==i?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){let i=this._Storage.getItem(e);return null!==i?"true"===i:t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){let i=this._Storage.getItem(e);return null!==i?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}_g._Storage=_g._GetStorage(),i(16832),function(e){class t{serialize(){let e={},t=Array(this._characterToIdx.size);return this._characterToIdx.forEach((e,i)=>{t[e]=i}),e.characters=t,e.insertionCosts=this._insertionCosts,e.deletionCosts=this._deletionCosts,e.substitutionCosts=this._substitutionCosts,JSON.stringify(e)}static Deserialize(e){let i=JSON.parse(e),r=new t(i.characters);return r._insertionCosts=i.insertionCosts,r._deletionCosts=i.deletionCosts,r._substitutionCosts=i.substitutionCosts,r}constructor(e,t=null,i=null,r=null){let s;t=t??(()=>1),i=i??(()=>1),r=r??((e,t)=>e===t?0:1),this._characterToIdx=new Map,this._insertionCosts=Array(e.length),this._deletionCosts=Array(e.length),this._substitutionCosts=Array(e.length);for(let n=0;n<e.length;++n){s=e[n],this._characterToIdx.set(s,n),this._insertionCosts[n]=t(s),this._deletionCosts[n]=i(s),this._substitutionCosts[n]=Array(e.length);for(let t=n;t<e.length;++t)this._substitutionCosts[n][t]=r(s,e[t])}}getCharacterIdx(e){return this._characterToIdx.get(e)}getInsertionCost(e){return this._insertionCosts[e]}getDeletionCost(e){return this._deletionCosts[e]}getSubstitutionCost(e,t){return this._substitutionCosts[Math.min(e,t)][Math.max(e,t)]}}e.Alphabet=t;class i{serialize(){return JSON.stringify(this._characters)}static Deserialize(e,t){let r=new i([],t);return r._characters=JSON.parse(e),r}constructor(e,t){if(e.length>i._MAX_SEQUENCE_LENGTH)throw Error("Sequences longer than "+i._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=t,this._characters=e.map(e=>this._alphabet.getCharacterIdx(e))}distance(e){return i._Distance(this,e)}static _Distance(e,t){let r=e._alphabet;if(r!==t._alphabet)throw Error("Cannot Levenshtein compare Sequences built from different alphabets.");let s=e._characters,n=t._characters,a=s.length,o=n.length,l=i._CostMatrix;l[0][0]=0;for(let e=0;e<a;++e)l[e+1][0]=l[e][0]+r.getInsertionCost(s[e]);for(let e=0;e<o;++e)l[0][e+1]=l[0][e]+r.getInsertionCost(n[e]);for(let e=0;e<a;++e)for(let t=0;t<o;++t)i._InsertionCost=l[e+1][t]+r.getInsertionCost(n[t]),i._DeletionCost=l[e][t+1]+r.getDeletionCost(s[e]),i._SubstitutionCost=l[e][t]+r.getSubstitutionCost(s[e],n[t]),l[e+1][t+1]=Math.min(i._InsertionCost,i._DeletionCost,i._SubstitutionCost);return l[a][o]}}i._MAX_SEQUENCE_LENGTH=256,i._CostMatrix=[...Array(i._MAX_SEQUENCE_LENGTH+1)].map(()=>Array(i._MAX_SEQUENCE_LENGTH+1)),e.Sequence=i}(i$||(i$={}));class _v{serialize(){return JSON.stringify(this)}static Deserialize(e){let t=JSON.parse(e),i=new _v(t._segmentLength);return i._points=t._points.map(e=>new i1.P(e._x,e._y,e._z)),i}constructor(e=.01){this._points=[],this._segmentLength=e}getLength(){return this._points.length*this._segmentLength}add(e){let t=this._points.length;if(0===t)this._points.push(e.clone());else{let i=()=>this._segmentLength/i1.P.Distance(this._points[t-1],e);for(let r=i();r<=1;r=i()){let i=this._points[t-1].scale(1-r);e.scaleAndAddToRef(r,i),this._points.push(i),++t}}}resampleAtTargetResolution(e){let t=new _v(this.getLength()/e);return this._points.forEach(e=>{t.add(e)}),t}tokenize(e){let t=[],i=new i1.P;for(let r=2;r<this._points.length;++r)_v._TransformSegmentDirToRef(this._points[r-2],this._points[r-1],this._points[r],i)&&t.push(_v._TokenizeSegment(i,e));return t}static _TransformSegmentDirToRef(e,t,i,r){return t.subtractToRef(e,_v._ForwardDir),_v._ForwardDir.normalize(),t.scaleToRef(-1,_v._InverseFromVec),_v._InverseFromVec.normalize(),!(Math.abs(i1.P.Dot(_v._ForwardDir,_v._InverseFromVec))>.98)&&(i1.P.CrossToRef(_v._ForwardDir,_v._InverseFromVec,_v._UpDir),_v._UpDir.normalize(),i1.y3.LookAtLHToRef(e,t,_v._UpDir,_v._LookMatrix),i.subtractToRef(t,_v._FromToVec),_v._FromToVec.normalize(),i1.P.TransformNormalToRef(_v._FromToVec,_v._LookMatrix,r),!0)}static _TokenizeSegment(e,t){_v._BestMatch=0,_v._Score=i1.P.Dot(e,t[0]),_v._BestScore=_v._Score;for(let i=1;i<t.length;++i)_v._Score=i1.P.Dot(e,t[i]),_v._Score>_v._BestScore&&(_v._BestMatch=i,_v._BestScore=_v._Score);return _v._BestMatch}}_v._ForwardDir=new i1.P,_v._InverseFromVec=new i1.P,_v._UpDir=new i1.P,_v._FromToVec=new i1.P,_v._LookMatrix=new i1.y3;class _S{serialize(){return JSON.stringify(this._sequences.map(e=>e.serialize()))}static Deserialize(e,t){let i=new _S;return i._sequences=JSON.parse(e).map(e=>i$.Sequence.Deserialize(e,t)),i}static CreateFromTrajectory(e,t,i){return _S.CreateFromTokenizationPyramid(_S._GetTokenizationPyramid(e,t),i)}static CreateFromTokenizationPyramid(e,t){let i=new _S;return i._sequences=e.map(e=>new i$.Sequence(e,t)),i}constructor(){this._sequences=[]}static _GetTokenizationPyramid(e,t,i=_S._FINEST_DESCRIPTOR_RESOLUTION){let r=[];for(let s=i;s>4;s=Math.floor(s/2))r.push(e.resampleAtTargetResolution(s).tokenize(t.chars));return r}distance(e){let t=0;for(let i=0;i<this._sequences.length;++i)t+=Math.pow(2,i)*this._sequences[i].distance(e._sequences[i]);return t}}_S._FINEST_DESCRIPTOR_RESOLUTION=32;class _x{serialize(){let e={};return e.descriptors=this._descriptors.map(e=>e.serialize()),e.centroidIdx=this._centroidIdx,e.averageDistance=this._averageDistance,JSON.stringify(e)}static Deserialize(e,t){let i=JSON.parse(e),r=new _x;return r._descriptors=i.descriptors.map(e=>_S.Deserialize(e,t)),r._centroidIdx=i.centroidIdx,r._averageDistance=i.averageDistance,r}constructor(e=[]){this._descriptors=e,this._centroidIdx=-1,this._averageDistance=0,this._refreshDescription()}add(e){this._descriptors.push(e),this._refreshDescription()}getMatchCost(e){return e.distance(this._descriptors[this._centroidIdx])/this._averageDistance}getMatchMinimumDistance(e){return Math.min(...this._descriptors.map(t=>t.distance(e)))}_refreshDescription(){let e;this._centroidIdx=-1;let t=this._descriptors.map(t=>(e=0,this._descriptors.forEach(i=>{e+=t.distance(i)}),e));for(let e=0;e<t.length;++e)(this._centroidIdx<0||t[e]<t[this._centroidIdx])&&(this._centroidIdx=e);this._averageDistance=0,this._descriptors.forEach(e=>{this._averageDistance+=e.distance(this._descriptors[this._centroidIdx])}),this._descriptors.length>0&&(this._averageDistance=Math.max(this._averageDistance/this._descriptors.length,_x._MIN_AVERAGE_DISTANCE))}}_x._MIN_AVERAGE_DISTANCE=1,i(46254);class _E{constructor(e,t,i){this._scene=e,re.Y.Log(`[Reflector] Connecting to ws://${t}:${i}`),this._webSocket=new WebSocket(`ws://${t}:${i}`),this._webSocket.onmessage=e=>{let t=e.data;if(t.startsWith(_E._SERVER_PREFIX)){let e=t.substring(_E._SERVER_PREFIX.length);re.Y.Log(`[Reflector] Received server message: ${e.substring(0,64)}`),this._handleServerMessage(e);return}re.Y.Log(`[Reflector] Received client message: ${t.substring(0,64)}`),this._handleClientMessage()},this._webSocket.onclose=e=>{re.Y.Log(`[Reflector] Disconnected ${e.code} ${e.reason}`)}}close(){this._webSocket.close()}_handleServerMessage(e){"connected"===e&&_u.SerializeAsync(this._scene).then(e=>{this._webSocket.send(`load|${JSON.stringify(e)}`)})}_handleClientMessage(){}}_E._SERVER_PREFIX="$$";class _C{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){let e=new Float32Array(Math.floor(1.5*this._view.length));e.set(this._view),this._view=e}}let _T="timestamp",_b="numPoints",_y=/\r/g;class _I{static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{let e=rW.F.Now-this._startingTimestamp,t=this.datasets.ids.length,i=this.datasets.startingIndices.itemLength,r=0;if(i>0){let e=this.datasets.startingIndices.at(i-1);r=e+this.datasets.data.at(e+_I.NumberOfPointsOffset)+_I.SliceDataOffset}if(this.datasets.startingIndices.push(r),this.datasets.data.push(e),this.datasets.data.push(t),this.datasets.ids.forEach(e=>{let t=this._strategies.get(e);t&&this.datasets.data.push(t.getData())}),this.datasetObservable.hasObservers()){let i=[e,t];for(let e=0;e<t;e++)i.push(this.datasets.data.at(r+_I.SliceDataOffset+e));this.datasetObservable.notifyObservers(i)}},this.datasets={ids:[],data:new _C(1800),startingIndices:new _C(1800)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new i0.y$,this.datasetObservable=new i0.y$,this.metadataObservable=new i0.y$(e=>e.callback(this._datasetMeta,new i0.he(0))),t&&this.addCollectionStrategies(...t)}registerEvent(e,t,i){return this._strategies.has(e)&&!t?void 0:(this._strategies.has(e)&&t&&(this._strategies.get(e)?.dispose(),this._strategies.delete(e)),this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:t=>{let i=0,r=0,s=t.onAfterRenderObservable.add(()=>{r=i,i=0}),n=this._customEventObservable.add(t=>{e===t.name&&(void 0!==t.value?i=t.value:i++)});return{id:e,getData:()=>r,dispose:()=>{t.onAfterRenderObservable.remove(s),this._customEventObservable.remove(n)}}},category:i}),{name:e})}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach(e=>{this.registerEvent(e,!0)})}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:r}of e){let e=t(this._scene);if(this._strategies.has(e.id)){e.dispose();continue}this.datasets.ids.push(e.id),i&&(i=i.replace(RegExp("@","g"),"")),this._datasetMeta.set(e.id,{color:this._getHexColorFromId(e.id),category:i,hidden:r}),this._strategies.set(e.id,e)}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let i=0;i<e.length;i++)t=e.charCodeAt(i)+((t<<5)-t);let i="#";for(let e=0;e<24;e+=8){let r="0"+(t>>e&255).toString(16);i+=r.substring(r.length-2)}return i}getCurrentSlice(){let e=[rW.F.Now-this._startingTimestamp,this.datasets.ids.length];this.datasets.ids.forEach(t=>{let i=this._strategies.get(t);i&&this.datasetObservable.hasObservers()&&e.push(i.getData())}),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(e)}updateMetadata(e,t,i){let r=this._datasetMeta.get(e);r&&(r[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new _C(1800),this.datasets.ids.length=0,this.datasets.startingIndices=new _C(1800),this._datasetMeta.clear(),this._strategies.forEach(e=>e.dispose()),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){let i=e.replace(_y,"").split("\n").map(e=>e.split(",").filter(e=>e.length>0)).filter(e=>e.length>0),r=_I.NumberOfPointsOffset;if(i.length<2)return!1;let s={ids:[],data:new _C(1800),startingIndices:new _C(1800)},[n,...a]=i;if(n.length<2||n[0]!==_T||n[r]!==_b)return!1;let o=new Map;for(let e=_I.SliceDataOffset;e<n.length;e++){let[t,i]=n[e].split("@");s.ids.push(t),o.set(t,i)}let l=0;for(let e of a){if(e.length<2)return!1;let t=parseFloat(e[0]),i=parseInt(e[r]);if(isNaN(i)||isNaN(t)||(s.data.push(t),s.data.push(i),i+_I.SliceDataOffset!==e.length))return!1;for(let t=_I.SliceDataOffset;t<e.length;t++){let i=parseFloat(e[t]);if(isNaN(i))return!1;s.data.push(i)}s.startingIndices.push(l),l+=e.length}if(this.datasets.ids=s.ids,this.datasets.data=s.data,this.datasets.startingIndices=s.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach(e=>e.dispose()),this._strategies.clear(),!t)for(let e of this.datasets.ids){let t=o.get(e);this._datasetMeta.set(e,{category:t,color:this._getHexColorFromId(e)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${_T},${_b}`;for(let t=0;t<this.datasets.ids.length;t++)if(e+=`,${this.datasets.ids[t]}`,this._datasetMeta){let i=this._datasetMeta.get(this.datasets.ids[t]);i?.category&&(e+=`@${i.category}`)}e+="\n";for(let t=0;t<this.datasets.startingIndices.itemLength;t++){let i=this.datasets.startingIndices.at(t),r=this.datasets.data.at(i),s=this.datasets.data.at(i+_I.NumberOfPointsOffset);e+=`${r},${s}`;for(let t=0;t<s;t++)e+=`,${this.datasets.data.at(i+_I.SliceDataOffset+t)}`;for(let t=0;t<this.datasets.ids.length-s;t++)e+=",";e+="\n"}let t=`${new Date().toISOString()}-perfdata.csv`;rD.w1.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?void 0===this._startingTimestamp&&(this._startingTimestamp=rW.F.Now):(this.datasets.data=new _C(1800),this.datasets.startingIndices=new _C(1800),this._startingTimestamp=rW.F.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach(e=>{e.dispose()}),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}rH.x.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new _I(this)),this._perfCollector};var _P=i(78314);i0.y$.prototype.runCoroutineAsync=function(e){if(!this._coroutineScheduler){let e=function(e){let t=[],i=[],r=[],s=e.add(()=>{let e=t.length;for(let s=0;s<e;s++)(0,_P.WP)(t.shift(),i.shift(),r.shift())});return{scheduler:(e,s,n)=>{t.push(e),i.push(s),r.push(n)},dispose:()=>{e.remove(s)}}}(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return(0,_P.sM)(e,this._coroutineScheduler)},i0.y$.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};let _R=`#ifdef GL_ES
precision highp float;
#endif
#define M_PI 3.1415926535897932384626433832795
varying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(
- sin( longitude )*sin( latitude ),
cos( latitude ),
- cos( longitude )*sin( latitude )
);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}`;sG.v.ShadersStore.equirectangularPanoramaPixelShader=_R,i(85974),i(49587),i(61232),i(27881),i(87423),i(26918),(e4=ij||(ij={}))[e4.ENTERING_XR=0]="ENTERING_XR",e4[e4.EXITING_XR=1]="EXITING_XR",e4[e4.IN_XR=2]="IN_XR",e4[e4.NOT_IN_XR=3]="NOT_IN_XR",(e5=iq||(iq={}))[e5.NOT_TRACKING=0]="NOT_TRACKING",e5[e5.TRACKING_LOST=1]="TRACKING_LOST",e5[e5.TRACKING=2]="TRACKING";class _A extends lE{constructor(e,t={}){super(e),this.options=t,this._direction=new i1.P(0,0,-1),this._mat=new i1.y3,this._onSelectEnabled=!1,this._origin=new i1.P(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new i0.y$,this._onHitTestResults=e=>{let t=e.map(e=>{let t=i1.y3.FromArray(e.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||t.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&t.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),t),{xrHitResult:e,transformationMatrix:t}});this.lastNativeXRHitResults=e,this.onHitTestResultObservable.notifyObservers(t)},this._onSelect=e=>{this._onSelectEnabled&&_A.XRHitTestWithSelectEvent(e,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",rD.w1.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,r){return e.requestHitTest(t,i).then(e=>e.filter(r||(e=>!!e.hitMatrix)))}static XRHitTestWithSelectEvent(e,t){let i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);let r=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,r,t)}attach(){return!!super.attach()&&(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0)}detach(){return!!super.detach()&&(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;let t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;i1.y3.FromArrayToRef(t.transform.matrix,0,this._mat),i1.P.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),i1.P.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();let i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});_A.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}_A.Name=ll.b.HIT_TEST,_A.Version=1,ll.d.AddWebXRFeature(_A.Name,(e,t)=>()=>new _A(e,t),_A.Version,!1);let _M=0;class _N extends lE{set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new i0.y$,this.onAnchorRemovedObservable=new i0.y$,this.onAnchorUpdatedObservable=new i0.y$,this._tmpVector=new i1.P,this._tmpQuaternion=new i1._f,this.xrNativeFeatureName="anchors",this._options.clearAnchorsOnSessionInit&&this._xrSessionManager.onXRSessionInit.add(()=>{this._trackedAnchors.length=0,this._futureAnchors.length=0,this._lastFrameDetected.clear()})}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new i1.P,i=new i1._f){this._populateTmpTransformation(t,i);let r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(e.xrHitResult.createAnchor)try{let t=await e.xrHitResult.createAnchor(r);return new Promise((e,i)=>{this._futureAnchors.push({nativeAnchor:t,resolved:!1,submitted:!0,xrTransformation:r,resolve:e,reject:i})})}catch(e){throw Error(e)}else throw this.detach(),Error("Anchors not enabled in this environment/browser")}async addAnchorAtPositionAndRotationAsync(e,t=new i1._f,i=!1){this._populateTmpTransformation(e,t);let r=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),s=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformation(r,this._xrSessionManager.currentFrame):void 0;return new Promise((e,t)=>{this._futureAnchors.push({nativeAnchor:s,resolved:!1,submitted:!1,xrTransformation:r,resolve:e,reject:t})})}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){let e=this._trackedAnchors.pop();e&&this.onAnchorRemovedObservable.notifyObservers(e)}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;let t=e.trackedAnchors;if(t){let i=this._trackedAnchors.filter(e=>!t.has(e.xrAnchor)).map(e=>this._trackedAnchors.indexOf(e)),r=0;i.forEach(e=>{let t=this._trackedAnchors.splice(e-r,1)[0];this.onAnchorRemovedObservable.notifyObservers(t),r++}),t.forEach(t=>{if(this._lastFrameDetected.has(t)){let i=this._findIndexInAnchorArray(t),r=this._trackedAnchors[i];try{this._updateAnchorWithXRFrame(t,r,e),r.attachedNode&&(r.attachedNode.rotationQuaternion=r.attachedNode.rotationQuaternion||new i1._f,r.transformationMatrix.decompose(r.attachedNode.scaling,r.attachedNode.rotationQuaternion,r.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(r)}catch(e){rD.w1.Warn("Anchor could not be updated")}}else{let i={id:_M++,xrAnchor:t,remove:()=>t.delete()},r=this._updateAnchorWithXRFrame(t,i,e);this._trackedAnchors.push(r),this.onAnchorAddedObservable.notifyObservers(r);let s=this._futureAnchors.filter(e=>e.nativeAnchor===t)[0];s&&(s.resolve(r),s.resolved=!0)}}),this._lastFrameDetected=t}this._futureAnchors.forEach(t=>{t.resolved||t.submitted||(this._createAnchorAtTransformation(t.xrTransformation,e).then(e=>{t.nativeAnchor=e},e=>{t.resolved=!0,t.reject(e)}),t.submitted=!0)})}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return -1}_updateAnchorWithXRFrame(e,t,i){let r=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(r){let e=t.transformationMatrix||new i1.y3;i1.y3.FromArrayToRef(r.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}async _createAnchorAtTransformation(e,t){if(t.createAnchor)try{return t.createAnchor(e,this._referenceSpaceForFrameAnchors??this._xrSessionManager.referenceSpace)}catch(e){throw Error(e)}else throw this.detach(),Error("Anchors are not enabled in your browser")}}_N.Name=ll.b.ANCHOR_SYSTEM,_N.Version=1,ll.d.AddWebXRFeature(_N.Name,(e,t)=>()=>new _N(e,t),_N.Version);let _O=0;class _D extends lE{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new i0.y$,this.onPlaneRemovedObservable=new i0.y$,this.onPlaneUpdatedObservable=new i0.y$,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){let e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return"undefined"!=typeof XRPlane}async initiateRoomCapture(){return this._xrSessionManager.session.initiateRoomCapture?this._xrSessionManager.session.initiateRoomCapture():Promise.reject("initiateRoomCapture is not supported on this session")}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;let t=e.detectedPlanes||e.worldInformation?.detectedPlanes;if(t){for(let e=0;e<this._detectedPlanes.length;e++){let i=this._detectedPlanes[e];t.has(i.xrPlane)||(this._detectedPlanes.splice(e--,1),this.onPlaneRemovedObservable.notifyObservers(i))}t.forEach(t=>{if(this._lastFrameDetected.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){let i=this._findIndexInPlaneArray(t),r=this._detectedPlanes[i];this._updatePlaneWithXRPlane(t,r,e),this.onPlaneUpdatedObservable.notifyObservers(r)}}else{let i={id:_O++,xrPlane:t,polygonDefinition:[]},r=this._updatePlaneWithXRPlane(t,i,e);this._detectedPlanes.push(r),this.onPlaneAddedObservable.notifyObservers(r)}}),this._lastFrameDetected=t}}_init(){let e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};if(this._xrSessionManager.isNative&&this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),!this._xrSessionManager.session.updateWorldTrackingState){e();return}this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map(e=>{let t=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new i1.P(e.x,e.y,e.z*t)});let r=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(r){let e=t.transformationMatrix||new i1.y3;i1.y3.FromArrayToRef(r.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return -1}}_D.Name=ll.b.PLANE_DETECTION,_D.Version=1,ll.d.AddWebXRFeature(_D.Name,(e,t)=>()=>new _D(e,t),_D.Version);class _F extends lE{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new i0.y$}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){let t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper){if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){let i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){let i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{let i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach(t=>t.setEnabled(e)),this.onBackgroundStateChangedObservable.notifyObservers(e)}}_F.Name=ll.b.BACKGROUND_REMOVER,_F.Version=1,ll.d.AddWebXRFeature(_F.Name,(e,t)=>()=>new _F(e,t),_F.Version,!0);class _L extends lE{_createPhysicsImpostor(e){let t=this._options.physicsProperties.impostorType||nq.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,r=(0,n$.Qk)("impostor-mesh-"+e.uniqueId,{diameterX:"number"==typeof i?i:i.width,diameterY:"number"==typeof i?i:i.height,diameterZ:"number"==typeof i?i:i.depth});r.isVisible=this._debugMode,r.isPickable=!1,r.rotationQuaternion=new i1._f;let s=e.grip||e.pointer;r.position.copyFrom(s.position),r.rotationQuaternion.copyFrom(s.rotationQuaternion);let n=new nq(r,t,{mass:0,...this._options.physicsProperties});this._controllers[e.uniqueId]={xrController:e,impostor:n,impostorMesh:r}}constructor(e,t){super(e),this._options=t,this._attachController=e=>{this._controllers[e.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||re.Y.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&e.inputSource.gamepad?e.onMotionControllerInitObservable.addOnce(t=>{t._doNotLoadControllerMesh?this._createPhysicsImpostor(e):t.onModelLoadedObservable.addOnce(()=>{let i=new nq(t.rootMesh,nq.MeshImpostor,{mass:0,...this._options.physicsProperties}),r=e.grip||e.pointer;this._controllers[e.uniqueId]={xrController:e,impostor:i,oldPos:r.position.clone(),oldRotation:r.rotationQuaternion.clone()}})}):this._createPhysicsImpostor(e))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new i1._f,this._tmpVector=new i1.P,this._options.physicsProperties||(this._options.physicsProperties={})}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach(e=>{let t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)})}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._options.enableHeadsetImpostor){let e=this._options.headsetImpostorParams||{impostorType:nq.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=(0,n$.Qk)("headset-mesh",{diameterX:"number"==typeof t?t:t.width,diameterY:"number"==typeof t?t:t.height,diameterZ:"number"==typeof t?t:t.depth}),this._headsetMesh.rotationQuaternion=new i1._f,this._headsetMesh.isVisible=!1,this._headsetImpostor=new nq(this._headsetMesh,e.impostorType,{mass:0,...e})}return!0}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._headsetMesh&&this._headsetMesh.dispose(),!0)}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){let t="string"==typeof e?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties={...this._options.physicsProperties,...e}}_onXRFrame(e){if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),this._options.xrInput.xrCamera._lastXRViewerPose?.linearVelocity){let e=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(this._options.xrInput.xrCamera._lastXRViewerPose?.angularVelocity){let e=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach(e=>{let t=this._controllers[e],i=t.xrController.grip||t.xrController.pointer,r=t.oldPos||t.impostorMesh.position;if(t.xrController._lastXRPose?.linearVelocity){let e=t.xrController._lastXRPose.linearVelocity;this._tmpVector.set(e.x,e.y,e.z),t.impostor.setLinearVelocity(this._tmpVector)}else i.position.subtractToRef(r,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),t.impostor.setLinearVelocity(this._tmpVector);r.copyFrom(i.position),this._debugMode&&re.Y.Log([this._tmpVector,"linear"]);let s=t.oldRotation||t.impostorMesh.rotationQuaternion;if(t.xrController._lastXRPose?.angularVelocity){let e=t.xrController._lastXRPose.angularVelocity;this._tmpVector.set(e.x,e.y,e.z),t.impostor.setAngularVelocity(this._tmpVector)}else if(!s.equalsWithEpsilon(i.rotationQuaternion)){s.conjugateInPlace().multiplyToRef(i.rotationQuaternion,this._tmpQuaternion);let e=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),e<.001)this._tmpVector.scaleInPlace(2);else{let t=2*Math.atan2(e,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(t/(this._delta/1e3*e))}t.impostor.setAngularVelocity(this._tmpVector)}s.copyFrom(i.rotationQuaternion),this._debugMode&&re.Y.Log([this._tmpVector,this._tmpQuaternion,"angular"])})}_detachController(e){let t=this._controllers[e];t&&(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}_L.Name=ll.b.PHYSICS_CONTROLLERS,_L.Version=1,ll.d.AddWebXRFeature(_L.Name,(e,t)=>()=>new _L(e,t),_L.Version,!0);class _w extends lE{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new i1.y3,this._tmpPos=new i1.P,this._tmpQuat=new i1._f,this._initHitTestSource=e=>{if(!e)return;let t=new XRRay(this.options.offsetRay||{}),i={space:this.options.useReferenceSpace?e:this._xrSessionManager.viewerReferenceSpace,offsetRay:t};if(this.options.entityTypes&&(i.entityTypes=this.options.entityTypes),!i.space){rD.w1.Warn("waiting for viewer reference space to initialize");return}this._xrSessionManager.session.requestHitTestSource(i).then(e=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=e})},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new i0.y$,this.paused=!1,this.xrNativeFeatureName="hit-test",rD.w1.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach()||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){let e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then(e=>{this._transientXrHitTestSource=e})}return!0}detach(){return!!super.detach()&&(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0)}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(this.attached&&!this.paused){if(this._xrHitTestSource){let t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach(e=>{this._processWebXRHitTestResult(e.results,e.inputSource)})}}_processWebXRHitTestResult(e,t){let i=[];e.forEach(e=>{let r=e.getPose(this._xrSessionManager.referenceSpace);if(!r)return;let s=r.transform.position,n=r.transform.orientation;this._tmpPos.set(s.x,s.y,s.z).scaleInPlace(this._xrSessionManager.worldScalingFactor),this._tmpQuat.set(n.x,n.y,n.z,n.w),i1.y3.FromFloat32ArrayToRefScaled(r.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());let a={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:e};i.push(a)}),this.onHitTestResultObservable.notifyObservers(i)}}_w.Name=ll.b.HIT_TEST,_w.Version=2,ll.d.AddWebXRFeature(_w.Name,(e,t)=>()=>new _w(e,t),_w.Version,!1);class _B extends lE{get featurePointCloud(){return this._featurePointCloud}constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new i0.y$,this.onFeaturePointsUpdatedObservable=new i0.y$,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return!!super.detach()&&(this.featurePointCloud.length=0,!0)}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;let t=e.featurePointCloud;if(t&&0!==t.length){if(t.length%5!=0)throw Error("Received malformed feature point cloud of length: "+t.length);let e=t.length/5,i=[],r=[];for(let s=0;s<e;s++){let e=5*s,n=t[e+4];this._featurePointCloud[n]?i.push(n):(this._featurePointCloud[n]={position:new i1.P,confidenceValue:0},r.push(n)),this._featurePointCloud[n].position.x=t[e],this._featurePointCloud[n].position.y=t[e+1],this._featurePointCloud[n].position.z=t[e+2],this._featurePointCloud[n].confidenceValue=t[e+3]}r.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(r),i.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(i)}}_init(){this._xrSessionManager.session.trySetFeaturePointCloudEnabled&&this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)&&(this._enabled=!0)}}_B.Name=ll.b.FEATURE_POINTS,_B.Version=1,ll.d.AddWebXRFeature(_B.Name,e=>()=>new _B(e),_B.Version);let _V=0;class _U extends lE{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new i0.y$,this.onMeshRemovedObservable=new i0.y$,this.onMeshUpdatedObservable=new i0.y$,this.xrNativeFeatureName="mesh-detection",this._options.generateMeshes&&(this._options.convertCoordinateSystems=!0),this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return!!super.detach()&&(this._xrSessionManager.isNative&&this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(e=>{this.onMeshRemovedObservable.notifyObservers(e)}),this._detectedMeshes.clear()),!0)}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){try{if(!this.attached||!e)return;let t=e.detectedMeshes||e.worldInformation?.detectedMeshes;if(t){let i=new Set;this._detectedMeshes.forEach((e,r)=>{t.has(r)||i.add(r)}),i.forEach(e=>{let t=this._detectedMeshes.get(e);t&&(this.onMeshRemovedObservable.notifyObservers(t),this._detectedMeshes.delete(e))}),t.forEach(t=>{if(this._detectedMeshes.has(t)){if(t.lastChangedTime===this._xrSessionManager.currentTimestamp){let i=this._detectedMeshes.get(t);i&&(this._updateVertexDataWithXRMesh(t,i,e),this.onMeshUpdatedObservable.notifyObservers(i))}}else{let i={id:_V++,xrMesh:t},r=this._updateVertexDataWithXRMesh(t,i,e);this._detectedMeshes.set(t,r),this.onMeshAddedObservable.notifyObservers(r)}})}}catch(e){re.Y.Log(e.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),this._options.preferredDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){t.xrMesh=e,t.worldParentNode=this._options.worldParentNode;let r=e.vertices||e.positions;if(this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=r,t.normals=e.normals;else{t.positions=new Float32Array(r.length);for(let e=0;e<r.length;e+=3)t.positions[e]=r[e],t.positions[e+1]=r[e+1],t.positions[e+2]=-1*r[e+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let i=0;i<e.normals.length;i+=3)t.normals[i]=e.normals[i],t.normals[i+1]=e.normals[i+1],t.normals[i+2]=-1*e.normals[i+2]}}t.indices=e.indices;let s=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(s){let e=t.transformationMatrix||new aN.y3;aN.y3.FromArrayToRef(s.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),t.transformationMatrix=e,this._options.worldParentNode&&e.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),e)}if(this._options.generateMeshes){if(t.mesh){let e=t.mesh;e.updateVerticesData(st.o.PositionKind,t.positions),t.normals?e.updateVerticesData(st.o.NormalKind,t.normals):e.createNormals(!0),e.updateIndices(t.indices)}else{let e=new rP.Kj("xr mesh "+t.id,this._xrSessionManager.scene);e.rotationQuaternion=new aN._f,e.setVerticesData(st.o.PositionKind,t.positions),t.normals?e.setVerticesData(st.o.NormalKind,t.normals):e.createNormals(!0),e.setIndices(t.indices,void 0,!0),t.mesh=e}t.transformationMatrix?.decompose(t.mesh.scaling,t.mesh.rotationQuaternion,t.mesh.position)}}return t}}_U.Name=ll.b.MESH_DETECTION,_U.Version=1,ll.d.AddWebXRFeature(_U.Name,(e,t)=>()=>new _U(e,t),_U.Version,!1),(e7=iQ||(iQ={}))[e7.NotReceived=0]="NotReceived",e7[e7.Waiting=1]="Waiting",e7[e7.Received=2]="Received";class _k extends lE{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new i0.y$,this.onTrackableImageFoundObservable=new i0.y$,this.onTrackedImageUpdatedObservable=new i0.y$,this._trackableScoreStatus=iQ.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach(e=>{e.originalBitmap.close()}),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};let e=this.options.images.map(e=>"string"==typeof e.src?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(e.src):Promise.resolve(e.src));try{let t=await Promise.all(e);return this._originalTrackingRequest=t.map((e,t)=>({image:e,widthInMeters:this.options.images[t].estimatedRealWorldWidth})),{trackedImages:this._originalTrackingRequest}}catch(e){return rD.w1.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(e.getImageTrackingResults&&this._trackableScoreStatus!==iQ.Waiting){if(this._trackableScoreStatus===iQ.NotReceived){this._checkScoresAsync();return}for(let t of e.getImageTrackingResults()){let i=!1,r=t.index,s=this._trackedImages[r];if(!s)continue;s.xrTrackingResult=t,s.realWorldWidth!==t.measuredWidthInMeters&&(s.realWorldWidth=t.measuredWidthInMeters,i=!0);let n=e.getPose(t.imageSpace,this._xrSessionManager.referenceSpace);if(n){let e=s.transformationMatrix;i1.y3.FromArrayToRef(n.transform.matrix,0,e),this._xrSessionManager.scene.useRightHandedSystem||e.toggleModelMatrixHandInPlace(),i=!0}let a="emulated"===t.trackingState;s.emulated!==a&&(s.emulated=a,i=!0),i&&this.onTrackedImageUpdatedObservable.notifyObservers(s)}}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==iQ.NotReceived)return;this._trackableScoreStatus=iQ.Waiting;let e=await this._xrSessionManager.session.getTrackedImageScores();if(!e||0===e.length){this._trackableScoreStatus=iQ.NotReceived;return}for(let t=0;t<e.length;++t)if("untrackable"==e[t])this.onUntrackableImageFoundObservable.notifyObservers(t);else{let e=this._originalTrackingRequest[t].image,i={id:t,originalBitmap:e,transformationMatrix:new i1.y3,ratio:e.width/e.height};this._trackedImages[t]=i,this.onTrackableImageFoundObservable.notifyObservers(i)}this._trackableScoreStatus=e.length>0?iQ.Received:iQ.NotReceived}}_k.Name=ll.b.IMAGE_TRACKING,_k.Version=1,ll.d.AddWebXRFeature(_k.Name,(e,t)=>()=>new _k(e,t),_k.Version,!1);class _G extends lE{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",rD.w1.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!!super.attach()&&!!this._xrSessionManager.session.domOverlayState&&null!==this._xrSessionManager.session.domOverlayState.type&&(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,null!==this._element&&!0===this.options.supressXRSelectEvents&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),!0)}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),null!==this._element&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(void 0===this.options.element)return rD.w1.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if("string"==typeof this.options.element){let e=document.querySelector(this.options.element);if(null===e)return rD.w1.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}_G.Name=ll.b.DOM_OVERLAY,_G.Version=1,ll.d.AddWebXRFeature(_G.Name,(e,t)=>()=>new _G(e,t),_G.Version,!1);class _z extends lE{get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}constructor(e,t){if(super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=new i1._f,this._tmpRotationMatrix=i1.y3.Identity(),this._tmpTranslationDirection=new i1.P,this._tmpMovementTranslation=new i1.P,this._tempCacheQuaternion=new i1._f,this._attachController=e=>{if(this._controllers[e.uniqueId])return;this._controllers[e.uniqueId]={xrController:e,registeredComponents:[]};let t=this._controllers[e.uniqueId];if("tracked-pointer"===t.xrController.inputSource.targetRayMode&&t.xrController.inputSource.gamepad){let i=()=>{if(e.motionController)for(let i of this._currentRegistrationConfigurations){let r=null;if(i.allowedComponentTypes)for(let t of i.allowedComponentTypes){let i=e.motionController.getComponentOfType(t);if(null!==i){r=i;break}}if(i.mainComponentOnly){let t=e.motionController.getMainComponent();if(null===t)continue;r=t}if("function"==typeof i.componentSelectionPredicate&&(r=i.componentSelectionPredicate(e)),r&&i.forceHandedness&&e.inputSource.handedness!==i.forceHandedness||null===r)continue;let s={registrationConfiguration:i,component:r};t.registeredComponents.push(s),"axisChangedHandler"in i&&(s.onAxisChangedObserver=r.onAxisValueChangedObservable.add(e=>{i.axisChangedHandler(e,this._movementState,this._featureContext,this._xrInput)})),"buttonChangedHandler"in i&&(s.onButtonChangedObserver=r.onButtonStateChangedObservable.add(e=>{e.changes.pressed&&i.buttonChangedHandler(e.changes.pressed,this._movementState,this._featureContext,this._xrInput)}))}};e.motionController?i():e.onMotionControllerInitObservable.addOnce(()=>{i()})}},!t||void 0===t.xrInput){rD.w1.Error('WebXRControllerMovement feature requires "xrInput" option.');return}Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=_z.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:t.movementOrientationFollowsViewerPose??!0,movementOrientationFollowsController:t.movementOrientationFollowsController??!1,orientationPreferredHandedness:t.orientationPreferredHandedness,movementSpeed:t.movementSpeed??1,movementThreshold:t.movementThreshold??.25,rotationEnabled:t.rotationEnabled??!0,rotationSpeed:t.rotationSpeed??1,rotationThreshold:t.rotationThreshold??.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput}attach(){return!!super.attach()&&(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0)}detach(){return!!super.detach()&&(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._controllers={},!0)}_onXRFrame(e){if(this.attached){if(0!==this._movementState.rotateX&&this._featureContext.rotationEnabled){let e=.001*this._xrSessionManager.scene.getEngine().getDeltaTime()*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);if(this._featureContext.movementOrientationFollowsViewerPose)this._xrInput.xrCamera.cameraRotation.y+=e,i1._f.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),this._xrInput.xrCamera.rotationQuaternion.multiplyToRef(this._tempCacheQuaternion,this._movementDirection);else if(this._featureContext.movementOrientationFollowsController){this._xrInput.xrCamera.cameraRotation.y+=e;let t=this._featureContext.orientationPreferredHandedness||"right",i=Object.keys(this._controllers).find(e=>this._controllers[e]?.xrController?.inputSource.handedness===t)||Object.keys(this._controllers)[0],r=this._controllers[i];i1._f.RotationYawPitchRollToRef(e,0,0,this._tempCacheQuaternion),(r?.xrController.pointer.rotationQuaternion||i1._f.Identity()).multiplyToRef(this._tempCacheQuaternion,this._movementDirection)}else i1._f.RotationYawPitchRollToRef(3*e,0,0,this._tempCacheQuaternion),this._movementDirection.multiplyInPlace(this._tempCacheQuaternion)}else if(this._featureContext.movementOrientationFollowsViewerPose)this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);else if(this._featureContext.movementOrientationFollowsController){let e=this._featureContext.orientationPreferredHandedness||"right",t=Object.keys(this._controllers).find(t=>this._controllers[t]?.xrController.inputSource.handedness===e)||Object.keys(this._controllers)[0],i=this._controllers[t];this._movementDirection.copyFrom(i?.xrController.pointer.rotationQuaternion||i1._f.Identity())}(this._movementState.moveX||this._movementState.moveY)&&this._featureContext.movementEnabled&&(i1.y3.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),i1.P.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){let t=this._controllers[e];if(t){for(let e of t.registeredComponents)e.onAxisChangedObserver&&e.component.onAxisValueChangedObservable.remove(e.onAxisChangedObserver),e.onButtonChangedObserver&&e.component.onButtonStateChangedObservable.remove(e.onButtonChangedObserver);delete this._controllers[e]}}}_z.Name=ll.b.MOVEMENT,_z.REGISTRATIONS={default:[{allowedComponentTypes:[lu.THUMBSTICK_TYPE,lu.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(e,t,i)=>{t.rotateX=Math.abs(e.x)>i.rotationThreshold?e.x:0,t.rotateY=Math.abs(e.y)>i.rotationThreshold?e.y:0}},{allowedComponentTypes:[lu.THUMBSTICK_TYPE,lu.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(e,t,i)=>{t.moveX=Math.abs(e.x)>i.movementThreshold?e.x:0,t.moveY=Math.abs(e.y)>i.movementThreshold?e.y:0}}]},_z.Version=1,ll.d.AddWebXRFeature(_z.Name,(e,t)=>()=>new _z(e,t),_z.Version,!0);var _H=i(42044);class _W extends lE{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=i1.P.Up().negateInPlace(),this._lightColor=i2.Wo.White(),this._intensity=1,this._sphericalHarmonics=new oA._,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new i0.y$,this._updateReflectionCubeMap=()=>{if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){let e=Date.now();if(e-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=e}let e=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(e&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)this._reflectionCubeMap._texture._hardwareTexture?.set(e),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{let t=new s0.l(this._xrSessionManager.scene.getEngine(),0);t.isCube=!0,t.invertY=!1,t._useSRGBBuffer="srgba8"===this.options.reflectionFormat,t.format=5,t.generateMipMaps=!0,t.type="srgba8"!==this.options.reflectionFormat?2:0,t.samplingMode=3,t.width=this._reflectionCubeMapTextureSize,t.height=this._reflectionCubeMapTextureSize,t._cachedWrapU=1,t._cachedWrapV=1,t._hardwareTexture=new nl.B(e,this._getCanvasContext()),this._reflectionCubeMap._texture=t}this._reflectionCubeMap._texture.isReady=!0,this.options.disablePreFiltering?(this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)):(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._hdrFilter.prefilter(this._reflectionCubeMap).then(()=>{this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap)}))}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new oq("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new i1.P(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=_H.m.FALLOFF_GLTF),this._hdrFilter=new cL(this._xrSessionManager.scene.getEngine()),rD.w1.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return null===this._canvasContext&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(null===this._xrWebGLBinding){let e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){if(!super.attach())return!1;let e=this.options.reflectionFormat??(this._xrSessionManager.session.preferredReflectionFormat||"srgba8");return this.options.reflectionFormat=e,this._xrSessionManager.session.requestLightProbe({reflectionFormat:e}).then(e=>{this._xrLightProbe=e,this.options.disableCubeMapReflection||(!this._reflectionCubeMap&&(this._reflectionCubeMap=new o1.V(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))}),!0}detach(){let e=super.detach();return null===this._xrLightProbe||this.options.disableCubeMapReflection||(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),null!==this._reflectionCubeMap&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){if(null!==this._xrLightProbe){if(this.options.lightEstimationPollInterval){let e=Date.now();if(e-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=e}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);let e=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new i1.P,this._lightColor=new i2.Wo,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*e),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new oA.i,this._reflectionCubeMap.sphericalPolynomial?.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}_W.Name=ll.b.LIGHT_ESTIMATION,_W.Version=1,ll.d.AddWebXRFeature(_W.Name,(e,t)=>()=>new _W(e,t),_W.Version,!1);class _Y extends lE{constructor(e){super(e),this.onEyeTrackingStartedObservable=new i0.y$,this.onEyeTrackingEndedObservable=new i0.y$,this.onEyeTrackingFrameUpdateObservable=new i0.y$,this._eyeTrackingStartListener=e=>{this._latestEyeSpace=e.gazeSpace,this._gazeRay=new nr.zH(i1.P.Zero(),i1.P.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(this.attached&&e&&this._latestEyeSpace&&this._gazeRay){let t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z).scaleInPlace(this._xrSessionManager.worldScalingFactor);let e=t.transform.orientation;i1.jp.Quaternion[0].set(e.x,e.y,e.z,e.w),this._xrSessionManager.scene.useRightHandedSystem?i1.P.RightHandedForwardReadOnly.rotateByQuaternionToRef(i1.jp.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,i1.jp.Quaternion[0].z*=-1,i1.jp.Quaternion[0].w*=-1,i1.P.LeftHandedForwardReadOnly.rotateByQuaternionToRef(i1.jp.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}_Y.Name=ll.b.EYE_TRACKING,_Y.Version=1,ll.d.AddWebXRFeature(_Y.Name,e=>()=>new _Y(e),_Y.Version,!1);class _X{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():i1.FM.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class _${constructor(){this._samples=new _X(20),this._entropy=0,this.onFirstStepDetected=new i0.y$}update(e,t,i,r){let s,n;this._samples.push(e,t);let a=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=i1.FM.Distance(a,this._samples.at(1)),this._entropy>this._entropyThreshold)return;for(s=this._samePointCheckStartIdx;s<this._samples.length&&!(i1.FM.DistanceSquared(a,this._samples.at(s))<this._samePointSquaredDistanceThreshold);++s);if(s===this._samples.length)return;let o=-1,l=0;for(let e,t=1;t<s;++t)(e=i1.FM.DistanceSquared(a,this._samples.at(t)))>o&&(l=t,o=e);if(o<this._apexSquaredDistanceThreshold)return;let c=this._samples.at(l),u=c.subtract(a);u.normalize();let h=i1.jp.Vector2[0],d=0;for(let e=1;e<s;++e)this._samples.at(e).subtractToRef(a,h),n=i1.FM.Dot(u,h),d+=h.lengthSquared()-n*n;if(d>s*this._squaredProjectionDistanceThreshold)return;let f=i1.jp.Vector3[0];f.set(i,r,0);let p=i1.jp.Vector3[1];p.set(u.x,u.y,0);let m=i1.P.Cross(f,p).z>0,_=a.clone(),g=a.clone();c.subtractToRef(a,u),m?(u.scaleAndAddToRef(this._axisToApexShrinkFactor,_),u.scaleAndAddToRef(this._axisToApexExtendFactor,g)):(u.scaleAndAddToRef(this._axisToApexExtendFactor,_),u.scaleAndAddToRef(this._axisToApexShrinkFactor,g)),this.onFirstStepDetected.notifyObservers({leftApex:_,rightApex:g,currentPosition:a,currentStepDirection:m?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return 9e-4}get _apexSquaredDistanceThreshold(){return .0081}get _squaredProjectionDistanceThreshold(){return 9e-4}get _axisToApexShrinkFactor(){return .8}get _axisToApexExtendFactor(){return -1.6}get _entropyDecayFactor(){return .93}get _entropyThreshold(){return .4}}class _j{constructor(e,t,i,r){this._leftApex=new i1.FM,this._rightApex=new i1.FM,this._currentPosition=new i1.FM,this._axis=new i1.FM,this._axisLength=-1,this._forward=new i1.FM,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new i1.FM,this._vitality=0,this.onMovement=new i0.y$,this.onFootfall=new i0.y$,this._reset(e,t,i,"left"===r)}_reset(e,t,i,r){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=r,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);let i=this._t,r=i1.FM.Dot(this._currentPosition,this._axis);this._t=r/(this._axisLength*this._axisLength);let s=this._currentPosition.lengthSquared()-r/this._axisLength*(r/this._axisLength);this._vitality*=.92-100*Math.max(s-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;let i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold)&&(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),!(this._axisLength<.03))}get _vitalityThreshold(){return .1}get forward(){return this._forward}}class _q{static get _MillisecondsPerUpdate(){return 1e3/15}constructor(e){this._detector=new _$,this._walker=null,this._movement=new i1.FM,this._millisecondsSinceLastUpdate=_q._MillisecondsPerUpdate,this.movementThisFrame=i1.P.Zero(),this._engine=e,this._detector.onFirstStepDetected.add(e=>{this._walker||(this._walker=new _j(e.leftApex,e.rightApex,e.currentPosition,e.currentStepDirection),this._walker.onFootfall.add(()=>{re.Y.Log("Footfall!")}),this._walker.onMovement.add(e=>{this._walker.forward.scaleAndAddToRef(.024*e.deltaT,this._movement)}))})}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=_q._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=_q._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&!this._walker.update(e.x,e.z)&&(this._walker=null),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class _Q extends lE{static get Name(){return ll.b.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera="WebXRCamera"===this._locomotionTarget.getClassName()}constructor(e,t){super(e),this._up=new i1.P,this._forward=new i1.P,this._position=new i1.P,this._movement=new i1.P,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&re.Y.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}isCompatible(){return void 0===this._sessionManager.sessionMode||"immersive-vr"===this._sessionManager.sessionMode}attach(){return!!(this.isCompatible&&super.attach())&&(this._walker=new _q(this._sessionManager.scene.getEngine()),!0)}detach(){return!!super.detach()&&(this._walker=null,!0)}_onXRFrame(e){let t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;let i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,r=t.transform.matrix;this._up.copyFromFloats(r[4],r[5],i*r[6]),this._forward.copyFromFloats(r[8],r[9],i*r[10]),this._position.copyFromFloats(r[12],r[13],i*r[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||i1.P.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}ll.d.AddWebXRFeature(_Q.Name,(e,t)=>()=>new _Q(e,t),_Q.Version,!1);class _K extends no{constructor(e,t,i,r,s,n,a=null){super(e,t,i,r,n),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=r,this.isMultiview=s,this.createRTTProvider=n,this._originalInternalTexture=a}}class _Z extends nc{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this.onRenderTargetTextureCreatedObservable=new i0.y$,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t="none"){let i=this._lastSubImages.get(t),r="right"==t?1:0,s=e.colorTextureWidth??e.textureWidth,n=e.colorTextureHeight??e.textureHeight;if(!this._renderTargetTextures[r]||i?.textureWidth!==s||i?.textureHeight!==n){let i;let a=e.depthStencilTextureWidth??s,o=e.depthStencilTextureHeight??n;(s===a||n===o)&&(i=e.depthStencilTexture),this._renderTargetTextures[r]=this._createRenderTargetTexture(s,n,null,e.colorTexture,i,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:s,framebufferHeight:n},this.onRenderTargetTextureCreatedObservable.notifyObservers({texture:this._renderTargetTextures[r],eye:t})}return this._lastSubImages.set(t,e),this._renderTargetTextures[r]}_getSubImageForEye(e){let t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){let t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e?.eye)}_setViewportForSubImage(e,t){let i=t.colorTextureWidth??t.textureWidth,r=t.colorTextureHeight??t.textureHeight,s=t.viewport;e.x=s.x/i,e.y=s.y/r,e.width=s.width/i,e.height=s.height/r}trySetViewportForView(e,t){let i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return!!i&&(this._setViewportForSubImage(e,i),!0)}}class _J extends _K{constructor(e,t,i){super(()=>e.textureWidth,()=>e.textureHeight,e,"XRProjectionLayer",t,e=>new _0(e,i,this)),this.layer=e}}class _0 extends _Z{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){let t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){let i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}}let _1={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1,clearOnAccess:!1},_2={};class _3 extends lE{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this._isMultiviewEnabled=!1,this._projectionLayerInitialized=!1,this._compositionLayerTextureMapping=new WeakMap,this._layerToRTTProviderMapping=new WeakMap,this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;let e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;let t={..._1,...this._options.projectionLayerInit};return this._isMultiviewEnabled=this._options.preferMultiviewOnInit&&e.getCaps().multiview,this.createProjectionLayer(t),this._projectionLayerInitialized=!0,!0}detach(){return!!super.detach()&&(this._existingLayers.forEach(e=>{e.dispose()}),this._existingLayers.length=0,this._projectionLayerInitialized=!1,!0)}createXRWebGLLayer(e=_2){return new nu(new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e))}_validateLayerInit(e,t=this._isMultiviewEnabled){if(!this._xrSessionManager.inXRSession)throw Error("Cannot create a layer outside of a WebXR session. Make sure the session has started before creating layers.");if(t&&"texture-array"!==e.textureType)throw Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&"texture-array"===e.textureType)throw Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.")}_extendXRLayerInit(e,t=this._isMultiviewEnabled){return t&&(e.textureType="texture-array"),e}createProjectionLayer(e=_1,t=this._isMultiviewEnabled){this._extendXRLayerInit(e,t),this._validateLayerInit(e,t);let i=new _J(this._xrWebGLBinding.createProjectionLayer(e),t,this._xrWebGLBinding);return this.addXRSessionLayer(i),i}_createQuadLayer(e={params:{}},t){this._extendXRLayerInit(e.params,!1);let i=this._existingLayers[0].layer.textureWidth,r=this._existingLayers[0].layer.textureHeight,s={space:this._xrSessionManager.referenceSpace,viewPixelWidth:i,viewPixelHeight:r,clearOnAccess:!0,...e.params};this._validateLayerInit(s,!1);let n=this._xrWebGLBinding.createQuadLayer(s);n.width=this._isMultiviewEnabled?1:2,n.height=1;let a=new _K(()=>n.width,()=>n.height,n,"XRQuadLayer",!1,e=>new _Z(e,this._xrWebGLBinding,a));t&&this._compositionLayerTextureMapping.set(n,t);let o=a.createRenderTargetTextureProvider(this._xrSessionManager);return this._layerToRTTProviderMapping.set(n,o),this.addXRSessionLayer(a),a}addFullscreenAdvancedDynamicTexture(e,t={distanceFromHeadset:1.5}){let i=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}},e),r=i.layer,s=Math.max(.1,t.distanceFromHeadset);r.transform=new XRRigidTransform({x:0,y:0,z:-s},{x:0,y:0,z:0,w:1});let n=this._layerToRTTProviderMapping.get(r);if(!n)throw Error("Could not find the RTT provider for the layer");let a=this._xrSessionManager.scene.layers.find(t=>t.texture===e);if(!a)throw Error("Could not find the babylon layer for the texture");return n.onRenderTargetTextureCreatedObservable.add(e=>{e.eye&&"right"===e.eye||(e.texture.clearColor=new i2.HE(0,0,0,0),a.renderTargetTextures.push(e.texture),a.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.scene.onBeforeRenderObservable.add(()=>{e.texture.render()}),a.renderTargetTextures.push(e.texture),a.renderOnlyInRenderTargetTextures=!0,this._xrSessionManager.onXRSessionEnded.addOnce(()=>{a.renderTargetTextures.splice(a.renderTargetTextures.indexOf(e.texture),1),a.renderOnlyInRenderTargetTextures=!1}))}),i}_addLensFlareSystem(e){let t=this._createQuadLayer({params:{space:this._xrSessionManager.viewerReferenceSpace,textureType:"texture",layout:"mono"}}),i=t.layer;i.width=2,i.height=1,i.transform=new XRRigidTransform({x:0,y:0,z:-10},{x:0,y:0,z:0,w:1});let r=this._layerToRTTProviderMapping.get(i);if(!r)throw Error("Could not find the RTT provider for the layer");return r.onRenderTargetTextureCreatedObservable.add(t=>{t.texture.clearColor=new i2.HE(0,0,0,0),t.texture.customRenderFunction=()=>{e.render()}}),this._xrSessionManager.onXRSessionInit.add(()=>{this._xrSessionManager.scene.lensFlareSystems.splice(this._xrSessionManager.scene.lensFlareSystems.indexOf(e),1)}),this._xrSessionManager.onXRSessionEnded.add(()=>{this._xrSessionManager.scene.lensFlareSystems.push(e)}),t}addXRSessionLayer(e){this._existingLayers.push(e),this.setXRSessionLayers(this._existingLayers)}setXRSessionLayers(e=this._existingLayers){let t={...this._xrSessionManager.session.renderState};t.baseLayer=void 0,t.layers=e.map(e=>e.layer),this._xrSessionManager.updateRenderState(t),this._projectionLayerInitialized||this._xrSessionManager._setBaseLayerWrapper(e.length>0?e.at(0):null)}isCompatible(){return!this._xrSessionManager.isNative&&"undefined"!=typeof XRWebGLBinding&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){let t=this._existingLayers;for(let i=0;i<t.length;++i){let r=t[i];if("XRProjectionLayer"!==r.layerType){let t=this._layerToRTTProviderMapping.get(r.layer);if(!t)continue;if(t.layerWrapper.isMultiview){let i=e.getViewerPose(this._xrSessionManager.referenceSpace);if(i){let e=i.views;for(let i=0;i<e.length;++i){let r=e[i];t.getRenderTargetTextureForView(r)}}}else t.getRenderTargetTextureForView()}}}}_3.Name=ll.b.LAYERS,_3.Version=1,ll.d.AddWebXRFeature(_3.Name,(e,t)=>()=>new _3(e,t),_3.Version,!1);class _4 extends lE{get width(){return this._width}get height(){return this._height}get rawValueToMeters(){return this._rawValueToMeters}get normDepthBufferFromNormView(){return this._normDepthBufferFromNormView}get depthUsage(){switch(this._xrSessionManager.session.depthUsage){case"cpu-optimized":return"cpu";case"gpu-optimized":return"gpu"}}get depthDataFormat(){switch(this._xrSessionManager.session.depthDataFormat){case"luminance-alpha":return"ushort";case"float32":return"float"}}get latestInternalTexture(){if(!this._cachedWebGLTexture)return null;let e=this._xrSessionManager.scene.getEngine(),t=new s0.l(e,0);return t.isCube=!1,t.invertY=!1,t._useSRGBBuffer=!1,t.format="ushort"===this.depthDataFormat?2:5,t.generateMipMaps=!1,t.type="ushort"===this.depthDataFormat?5:1,t.samplingMode=7,t.width=this.width??0,t.height=this.height??0,t._cachedWrapU=1,t._cachedWrapV=1,t._hardwareTexture=new nl.B(this._cachedWebGLTexture,e._gl),t}get latestDepthBuffer(){return this._cachedDepthBuffer?"ushort"===this.depthDataFormat?new Uint16Array(this._cachedDepthBuffer):new Float32Array(this._cachedDepthBuffer):null}get latestDepthImageTexture(){return this._cachedDepthImageTexture}constructor(e,t){super(e),this.options=t,this._width=null,this._height=null,this._rawValueToMeters=null,this._normDepthBufferFromNormView=null,this._cachedDepthBuffer=null,this._cachedWebGLTexture=null,this._cachedDepthImageTexture=null,this.onGetDepthInMetersAvailable=new i0.y$,this.xrNativeFeatureName="depth-sensing",rD.w1.Warn("depth-sensing is an experimental and unstable feature.")}attach(e){return!!super.attach(e)&&null!=this._xrSessionManager.session.depthDataFormat&&null!=this._xrSessionManager.session.depthUsage&&(this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._xrSessionManager.scene.getEngine()._gl),!0)}dispose(){this._cachedDepthImageTexture?.dispose()}_onXRFrame(e){let t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(null!=i)for(let t of i.views)switch(this.depthUsage){case"cpu":this._updateDepthInformationAndTextureCPUDepthUsage(e,t,this.depthDataFormat);break;case"gpu":if(!this._glBinding)break;this._updateDepthInformationAndTextureWebGLDepthUsage(this._glBinding,t,this.depthDataFormat);break;default:rD.w1.Error("Unknown depth usage"),this.detach()}}_updateDepthInformationAndTextureCPUDepthUsage(e,t,i){let r=e.getDepthInformation(t);if(null===r)return;let{data:s,width:n,height:a,rawValueToMeters:o,getDepthInMeters:l}=r;switch(this._width=n,this._height=a,this._rawValueToMeters=o,this._cachedDepthBuffer=s,this.onGetDepthInMetersAvailable.notifyObservers(l.bind(r)),this._cachedDepthImageTexture||(this._cachedDepthImageTexture=rK.l.CreateRTexture(null,n,a,this._xrSessionManager.scene,!1,!0,rZ.x.NEAREST_SAMPLINGMODE,1)),i){case"ushort":this._cachedDepthImageTexture.update(Float32Array.from(new Uint16Array(s)).map(e=>e*o));break;case"float":this._cachedDepthImageTexture.update(new Float32Array(s).map(e=>e*o))}}_updateDepthInformationAndTextureWebGLDepthUsage(e,t,i){let r=e.getDepthInformation(t);if(null===r)return;let{texture:s,width:n,height:a}=r;this._width=n,this._height=a,this._cachedWebGLTexture=s;let o=this._xrSessionManager.scene,l=o.getEngine().wrapWebGLTexture(s);this._cachedDepthImageTexture||(this._cachedDepthImageTexture=rK.l.CreateRTexture(null,n,a,o,!1,!0,rZ.x.NEAREST_SAMPLINGMODE,"ushort"===i?0:1)),this._cachedDepthImageTexture._texture=l}getXRSessionInitExtension(){let e=null!=this.options.usagePreference&&0!==this.options.usagePreference.length,t=null!=this.options.dataFormatPreference&&0!==this.options.dataFormatPreference.length;return new Promise(i=>{i(e&&t?{depthSensing:{usagePreference:this.options.usagePreference.map(e=>{switch(e){case"cpu":return"cpu-optimized";case"gpu":return"gpu-optimized"}}),dataFormatPreference:this.options.dataFormatPreference.map(e=>{switch(e){case"ushort":return"luminance-alpha";case"float":return"float32"}})}}:{})})}}_4.Name=ll.b.DEPTH_SENSING,_4.Version=1,ll.d.AddWebXRFeature(_4.Name,(e,t)=>()=>new _4(e,t),_4.Version,!1);let _5=`precision highp float;
#define CUSTOM_FRAGMENT_BEGIN
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
highp vec4 motionVector=( clipPos/clipPos.w-previousClipPos/previousClipPos.w );gl_FragColor=motionVector;
#define CUSTOM_FRAGMENT_MAIN_END
}`;sG.v.ShadersStore.velocityPixelShader=_5;let _7=`#define CUSTOM_VERTEX_BEGIN
#define VELOCITY
attribute vec3 position;
#include<instancesDeclaration>
uniform mat4 viewProjection;uniform mat4 previousViewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;uniform mat4 previousViewProjectionR;
#endif
varying vec4 clipPos;varying vec4 previousClipPos;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);vec4 previousWorldPos=finalPreviousWorld*vec4(positionUpdated,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;} else {clipPos=viewProjectionR*worldPos;previousClipPos=previousViewProjectionR*previousWorldPos;gl_Position=clipPos;}
#elif
clipPos=viewProjection*worldPos;previousClipPos=previousViewProjection*previousWorldPos;gl_Position=clipPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;sG.v.ShadersStore.velocityVertexShader=_7;class _6 extends s2._{constructor(e,t,i,r=512){super("spacewarp rtt",r,i,!1,!0,2,!1,void 0,!1,!1,!0,void 0,!0),this._originalPairing=[],this._previousWorldMatrices=[],this._previousTransforms=[i1.y3.Identity(),i1.y3.Identity()],this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight(),e,t),this._renderTarget._disposeOnlyFramebuffers=!0,this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,i&&(this._velocityMaterial=new nA.j("velocity shader material",i,{vertex:"velocity",fragment:"velocity"},{uniforms:["world","previousWorld","viewProjection","viewProjectionR","previousViewProjection","previousViewProjectionR"]}),this._velocityMaterial._materialHelperNeedsPreviousMatrices=!0,this._velocityMaterial.onBindObservable.add(e=>{this._previousWorldMatrices[e.uniqueId]=this._previousWorldMatrices[e.uniqueId]||e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousWorld",this._previousWorldMatrices[e.uniqueId]),this._previousWorldMatrices[e.uniqueId]=e.getWorldMatrix(),this._velocityMaterial.getEffect().setMatrix("previousViewProjection",this._previousTransforms[0]),this._velocityMaterial.getEffect().setMatrix("previousViewProjectionR",this._previousTransforms[1]),this._previousTransforms[0].copyFrom(i.getTransformMatrix()),this._previousTransforms[1].copyFrom(i._transformMatrixR)}),this._velocityMaterial.freeze())}render(e=!1,t=!1){this._originalPairing.length=0;let i=this.getScene();i&&this._velocityMaterial&&i.getActiveMeshes().forEach(e=>{this._originalPairing.push([e,e.material]),e.material=this._velocityMaterial}),super.render(e,t),this._originalPairing.forEach(e=>{e[0].material=e[1]})}_bindFrameBuffer(){this._renderTarget&&this.getScene().getEngine().bindSpaceWarpFramebuffer(this._renderTarget)}getViewCount(){return 2}dispose(){super.dispose(),this._velocityMaterial.dispose(),this._previousTransforms.length=0,this._previousWorldMatrices.length=0,this._originalPairing.length=0}}class _8{constructor(e,t,i){this._scene=e,this._xrSessionManager=t,this._xrWebGLBinding=i,this._lastSubImages=new Map,this._renderTargetTextures=new Map,this._engine=e.getEngine()}_getSubImageForView(e){let t=this._xrSessionManager._getBaseLayerWrapper();if(!t)throw Error("For Space Warp, the base layer should be a WebXR Projection Layer.");if("XRProjectionLayer"!==t.layerType)throw Error('For Space Warp, the base layer type should "XRProjectionLayer".');let i=t.layer;return this._xrWebGLBinding.getViewSubImage(i,e)}_setViewportForSubImage(e,t){e.x=0,e.y=0,e.width=t.motionVectorTextureWidth,e.height=t.motionVectorTextureHeight}_createRenderTargetTexture(e,t,i,r,s){if(!this._engine)throw Error("Engine is disposed");let n=new _6(r,s,this._scene,{width:e,height:t}),a=n.renderTarget;return i&&(a._framebuffer=i),a._colorTextureArray=r,a._depthStencilTextureArray=s,n.disableRescaling(),n.renderListPredicate=()=>!0,n}_getRenderTargetForSubImage(e,t){let i=this._lastSubImages.get(t),r=this._renderTargetTextures.get(t.eye),s=e.motionVectorTextureWidth,n=e.motionVectorTextureHeight;return r&&i?.textureWidth===s&&i?.textureHeight==n||(r=this._createRenderTargetTexture(s,n,null,e.motionVectorTexture,e.depthStencilTexture),this._renderTargetTextures.set(t.eye,r),this._framebufferDimensions={framebufferWidth:s,framebufferHeight:n}),this._lastSubImages.set(t,e),r}trySetViewportForView(e,t){let i=this._lastSubImages.get(t)||this._getSubImageForView(t);return!!i&&(this._setViewportForSubImage(e,i),!0)}accessMotionVector(e){let t=this._getSubImageForView(e);t&&(t.motionVectorTexture,t.depthStencilTexture)}getRenderTargetTextureForEye(e){return null}getRenderTargetTextureForView(e){let t=this._getSubImageForView(e);return t?this._getRenderTargetForSubImage(t,e):null}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.clear()}}class _9 extends lE{constructor(e){super(e),this._onAfterRenderObserver=null,this.dependsOn=[ll.b.LAYERS],this.xrNativeFeatureName="space-warp",this._xrSessionManager.scene.needsPreviousWorldMatrices=!0}attach(){if(!super.attach())return!1;let e=this._xrSessionManager.scene.getEngine();return this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this.spaceWarpRTTProvider=new _8(this._xrSessionManager.scene,this._xrSessionManager,this._xrWebGLBinding),this._onAfterRenderObserver=this._xrSessionManager.scene.onAfterRenderObservable.add(()=>this._onAfterRender()),!0}detach(){return this._xrSessionManager.scene.onAfterRenderObservable.remove(this._onAfterRenderObserver),super.detach()}_onAfterRender(){this.attached&&this._renderTargetTexture&&this._renderTargetTexture.render(!1,!1)}isCompatible(){return this._xrSessionManager.scene.getEngine().getCaps().colorBufferHalfFloat||!1}dispose(){super.dispose()}_onXRFrame(e){let t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;let i=t.views[0];this._renderTargetTexture=this._renderTargetTexture||this.spaceWarpRTTProvider.getRenderTargetTextureForView(i),this.spaceWarpRTTProvider.accessMotionVector(i)}}_9.Name=ll.b.SPACE_WARP,_9.Version=1,ll.d.AddWebXRFeature(_9.Name,e=>()=>new _9(e),_9.Version,!1);class ge extends lE{constructor(e,t={}){super(e),this.options=t,this._cachedInternalTextures=[],this.texturesData=[],this.viewIndex=[],this.cameraIntrinsics=[],this.onTexturesUpdatedObservable=new i0.y$,this.xrNativeFeatureName="camera-access"}attach(e){return!!super.attach(e)&&(this._glContext=this._xrSessionManager.scene.getEngine()._gl,this._glBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),!0)}detach(){return!!super.detach()&&(this._glBinding=void 0,this.options.doNotDisposeOnDetach||(this._cachedInternalTextures.forEach(e=>e.dispose()),this.texturesData.forEach(e=>e.dispose()),this._cachedInternalTextures.length=0,this.texturesData.length=0,this.cameraIntrinsics.length=0),!0)}dispose(){super.dispose(),this.onTexturesUpdatedObservable.clear()}_updateCameraIntrinsics(e,t){let i={width:e.camera.width,height:e.camera.height,x:0,y:0},r=e.projectionMatrix,s=(1-r[8])*i.width/2+i.x,n=(1-r[9])*i.height/2+i.y,a=i.width/2*r[0],o=i.height/2*r[5],l=i.width/2*r[4];this.cameraIntrinsics[t]={u0:s,v0:n,ax:a,ay:o,gamma:l,width:i.width,height:i.height,viewportX:i.x,viewportY:i.y}}_updateInternalTextures(e,t=0){if(!e.camera)return!1;this.viewIndex[t]=e.eye;let i=this._glBinding?.getCameraImage(e.camera);if(this._cachedInternalTextures[t])this._cachedInternalTextures[t]._hardwareTexture?.set(i);else{let r=new s0.l(this._xrSessionManager.scene.getEngine(),0,!0);r.invertY=!1,r.format=5,r.generateMipMaps=!0,r.type=1,r.samplingMode=3,r.width=e.camera.width,r.height=e.camera.height,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new nl.B(i,this._glContext),this._cachedInternalTextures[t]=r;let s=new o1.V(this._xrSessionManager.scene);s.name=`WebXR Raw Camera Access (${t})`,s._texture=this._cachedInternalTextures[t],this.texturesData[t]=s,this._updateCameraIntrinsics(e,t)}return this._cachedInternalTextures[t].isReady=!0,!0}_onXRFrame(e){let t=this._xrSessionManager.referenceSpace,i=e.getViewerPose(t);if(!i||!i.views)return;let r=!0;i.views.forEach((e,t)=>{r=r&&this._updateInternalTextures(e,t)}),r&&this.onTexturesUpdatedObservable.notifyObservers(this.texturesData)}}ge.Name=ll.b.RAW_CAMERA_ACCESS,ge.Version=1,ll.d.AddWebXRFeature(ge.Name,(e,t)=>()=>new ge(e,t),ge.Version,!1);class gt extends ld{constructor(e,t,i){super(e,gi[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}lg.RegisterController("generic-hand-select-grasp",(e,t)=>new gt(t,e.gamepad,e.handedness));let gi={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class gr extends ld{constructor(e,t,i){super(e,gs["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";return{filename:"left"===this.handedness?gr.MODEL_LEFT_FILENAME:gr.MODEL_RIGHT_FILENAME,path:gr.MODEL_BASE_URL+"default/"}}_getModelLoadingConstraints(){let e=lh.n0.IsPluginForExtensionAvailable(".glb");return e||re.Y.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){this.rootMesh&&(this.getComponentIds().forEach((e,t)=>{if(!this.disableAnimation&&e&&this.rootMesh){let i=this._mapping.buttons[e],r=i.rootNodeName;if(!r){re.Y.Log("Skipping unknown button at index: "+t+" with mapped name: "+e);return}let s=this._getChildByName(this.rootMesh,r);if(!s){re.Y.Warn("Missing button mesh with name: "+r);return}if(i.valueMesh=this._getImmediateChildByName(s,this._mapping.defaultButton.valueNodeName),i.pressedMesh=this._getImmediateChildByName(s,this._mapping.defaultButton.pressedNodeName),i.unpressedMesh=this._getImmediateChildByName(s,this._mapping.defaultButton.unpressedNodeName),i.valueMesh&&i.pressedMesh&&i.unpressedMesh){let t=this.getComponent(e);t&&t.onButtonStateChangedObservable.add(e=>{this._lerpTransform(i,e.value)},void 0,!0)}else re.Y.Warn("Missing button submesh under mesh with name: "+r)}}),this.getComponentIds().forEach(e=>{let t=this.getComponent(e);t.isAxes()&&["x-axis","y-axis"].forEach(i=>{if(!this.rootMesh)return;let r=this._mapping.axes[e][i],s=this._getChildByName(this.rootMesh,r.rootNodeName);if(!s){re.Y.Warn("Missing axis mesh with name: "+r.rootNodeName);return}r.valueMesh=this._getImmediateChildByName(s,this._mapping.defaultAxis.valueNodeName),r.minMesh=this._getImmediateChildByName(s,this._mapping.defaultAxis.minNodeName),r.maxMesh=this._getImmediateChildByName(s,this._mapping.defaultAxis.maxNodeName),r.valueMesh&&r.minMesh&&r.maxMesh?t&&t.onAxisValueChangedObservable.add(e=>{let t="x-axis"===i?e.x:e.y;this._lerpTransform(r,t,!0)},void 0,!0):re.Y.Warn("Missing axis submesh under mesh with name: "+r.rootNodeName)})}))}_setRootMesh(e){let t;this.rootMesh=new rP.Kj(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;for(let i=0;i<e.length;i++){let r=e[i];r.isPickable=!1,r.parent||(t=r)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=i1._f.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}gr.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/",gr.MODEL_LEFT_FILENAME="left.glb",gr.MODEL_RIGHT_FILENAME="right.glb",lg.RegisterController("windows-mixed-reality",(e,t)=>new gr(t,e.gamepad,e.handedness));let gs={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class gn extends ld{constructor(e,t,i,r=!1,s=!1){super(e,ga[i],t,i),this._forceLegacyControllers=s,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";return{filename:"left"===this.handedness?gn.MODEL_LEFT_FILENAME:gn.MODEL_RIGHT_FILENAME,path:this._isQuest()?gn.QUEST_MODEL_BASE_URL:gn.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){let t=this._isQuest(),i="right"===this.handedness?-1:1;this.getComponentIds().forEach(e=>{let r=e&&this.getComponent(e);r&&r.onButtonStateChangedObservable.add(r=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":t||(this._modelRootNode.getChildren()[3].rotation.x=-(.2*r.value),this._modelRootNode.getChildren()[3].position.y=-(.005*r.value),this._modelRootNode.getChildren()[3].position.z=-(.005*r.value));return;case"xr-standard-squeeze":t||(this._modelRootNode.getChildren()[4].position.x=i*r.value*.0035);return;case"xr-standard-thumbstick":return;case"a-button":case"x-button":t||(r.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0);return;case"b-button":case"y-button":t||(r.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0);return}},void 0,!0)})}_setRootMesh(e){this.rootMesh=new rP.Kj(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=i1._f.FromEulerAngles(0,Math.PI,0)),e.forEach(e=>{e.isPickable=!1}),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}gn.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/",gn.MODEL_LEFT_FILENAME="left.babylon",gn.MODEL_RIGHT_FILENAME="right.babylon",gn.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/",lg.RegisterController("oculus-touch",(e,t)=>new gn(t,e.gamepad,e.handedness)),lg.RegisterController("oculus-touch-legacy",(e,t)=>new gn(t,e.gamepad,e.handedness,!0));let ga={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class go extends ld{constructor(e,t,i){super(e,gl[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){return{filename:go.MODEL_FILENAME,path:go.MODEL_BASE_URL}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){this.getComponentIds().forEach(e=>{let t=e&&this.getComponent(e);t&&t.onButtonStateChangedObservable.add(t=>{if(this.rootMesh&&!this.disableAnimation)switch(e){case"xr-standard-trigger":this._modelRootNode.getChildren()[6].rotation.x=-(.15*t.value);return;case"xr-standard-touchpad":case"xr-standard-squeeze":return}},void 0,!0)})}_setRootMesh(e){this.rootMesh=new rP.Kj(this.profileId+" "+this.handedness,this.scene),e.forEach(e=>{e.isPickable=!1}),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=i1._f.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}go.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/",go.MODEL_FILENAME="wand.babylon",lg.RegisterController("htc-vive",(e,t)=>new go(t,e.gamepad,e.handedness));let gl={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};class gc{get session(){return this._nativeImpl.session}constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(8),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>this._nativeImpl._imageTrackingResults??[]}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;let i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];let r=this._xrTransform.orientation;return r.x=this._xrPoseVectorData[4],r.y=this._xrPoseVectorData[5],r.z=this._xrPoseVectorData[6],r.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}getDepthInformation(e){throw Error("This function is not available in Babylon Native")}}aE("NativeXRFrame",gc),i(77210),(e6=iK||(iK={}))[e6.Input=0]="Input",e6[e6.Output=1]="Output";class gu{constructor(e,t,i){this._ownerBlock=i,this._connectedPoint=[],this.uniqueId=(0,hj.f)(),this.connectedPointIds=[],this.name=e,this._connectionType=t}get connectionType(){return this._connectionType}_isSingularConnection(){return!0}isConnected(){return this._connectedPoint.length>0}connectTo(e){if(this._connectionType===e._connectionType)throw Error(`Cannot connect two points of type ${this.connectionType}`);if(this._isSingularConnection()&&this._connectedPoint.length>0||e._isSingularConnection()&&e._connectedPoint.length>0)throw Error("Max number of connections for point reached");this._connectedPoint.push(e),e._connectedPoint.push(this)}serialize(e={}){for(let t of(e.uniqueId=this.uniqueId,e.name=this.name,e._connectionType=this._connectionType,e.connectedPointIds=[],e.className=this.getClassName(),this._connectedPoint))e.connectedPointIds.push(t.uniqueId)}getClassName(){return"FGConnection"}deserialize(e){this.uniqueId=e.uniqueId,this.name=e.name,this._connectionType=e._connectionType,this.connectedPointIds=e.connectedPointIds}static Parse(e={},t){let i=new(rD.w1.Instantiate(e.className))(e.name,e._connectionType,t);return i.deserialize(e),i}}class gh{constructor(e){this.value=this._toInt(e)}_toInt(e){return 0|e}add(e){return new gh(this.value+e.value)}subtract(e){return new gh(this.value-e.value)}multiply(e){return new gh(Math.imul(this.value,e.value))}divide(e){return new gh(this.value/e.value)}getClassName(){return gh.ClassName}equals(e){return this.value===e.value}static Parse(e){return new gh(e.value)}}gh.ClassName="FlowGraphInteger",(0,i3.H7)("FlowGraphInteger",gh);class gd{constructor(e,t){this.typeName=e,this.defaultValue=t}serialize(e){e.typeName=this.typeName,e.defaultValue=this.defaultValue}static Parse(e){return new gd(e.typeName,e.defaultValue)}}let gf=new gd("any",void 0),gp=new gd("string",""),gm=new gd("number",0),g_=new gd("boolean",!1),gg=new gd("Vector2",i1.FM.Zero()),gv=new gd("Vector3",i1.P.Zero()),gS=new gd("Vector4",i1.Lt.Zero()),gx=new gd("Matrix",i1.y3.Identity()),gE=new gd("Color3",i2.Wo.Black()),gC=new gd("Color4",new i2.HE(0,0,0,0)),gT=new gd("Quaternion",i1._f.Identity()),gb=new gd("FlowGraphInteger",new gh(0));class gy extends gu{constructor(e,t,i,r){super(e,t,i),this.richType=r}_isSingularConnection(){return 0===this.connectionType}setValue(e,t){t._setConnectionValue(this,e)}connectTo(e){super.connectTo(e)}_getValueOrDefault(e){return e._hasConnectionValue(this)?e._getConnectionValue(this):this.richType.defaultValue}getValue(e){return 1===this.connectionType?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._updateOutputs(e),this._getValueOrDefault(e)):this.isConnected()?this._connectedPoint[0].getValue(e):this._getValueOrDefault(e)}getClassName(){return"FGDataConnection"}serialize(e={}){super.serialize(e),e.richType={},this.richType.serialize(e.richType)}static Parse(e,t){let i=gu.Parse(e,t);return i.richType=gd.Parse(e.richType),i}}function gI(e){return"Mesh"===e||"AbstractMesh"===e||"GroundMesh"===e||"InstanceMesh"===e||"LinesMesh"===e||"GoldbergMesh"===e||"GreasedLineMesh"===e||"TrailMesh"===e}function gP(e){return"Vector2"===e||"Vector3"===e||"Vector4"===e||"Quaternion"===e||"Color3"===e||"Color4"===e}function gR(e,t,i){let r=t?.getClassName?.()??"";gI(r)?i[e]={name:t.name,className:r}:gP(r)?i[e]={value:t.asArray(),className:r}:i[e]=t}function gA(e,t,i){let r=t[e],s=r?.className;return gI(s)?i.getMeshByName(r.name):gP(s)?function(e,t){if("Vector2"===e)return i1.FM.FromArray(t);if("Vector3"===e)return i1.P.FromArray(t);if("Vector4"===e)return i1.Lt.FromArray(t);if("Quaternion"===e)return i1._f.FromArray(t);if("Color3"===e)return new i2.Wo(t[0],t[1],t[2]);if("Color4"===e)return new i2.HE(t[0],t[1],t[2],t[3]);throw Error(`Unknown vector class name ${e}`)}(s,r.value):"Matrix"===s?i1.y3.FromArray(r.value):s===gh.ClassName?gh.Parse(r):r&&void 0!==r.value?r.value:r}(0,i3.H7)("FGDataConnection",gy);class gM{constructor(e){this.config=e,this.uniqueId=(0,hj.f)(),this.name=this.config?.name??this.getClassName(),this.dataInputs=[],this.dataOutputs=[]}_updateOutputs(e){}registerDataInput(e,t){let i=new gy(e,0,this,t);return this.dataInputs.push(i),i}registerDataOutput(e,t){let i=new gy(e,1,this,t);return this.dataOutputs.push(i),i}getDataInput(e){return this.dataInputs.find(t=>t.name===e)}getDataOutput(e){return this.dataOutputs.find(t=>t.name===e)}serialize(e={},t=gR){for(let t of(e.uniqueId=this.uniqueId,e.config={},this.config&&(e.config.name=this.config.name),e.dataInputs=[],e.dataOutputs=[],e.className=this.getClassName(),this.dataInputs)){let i={};t.serialize(i),e.dataInputs.push(i)}for(let t of this.dataOutputs){let i={};t.serialize(i),e.dataOutputs.push(i)}}getClassName(){return"FGBlock"}static Parse(e,t){var i;let r=rD.w1.Instantiate(e.className),s={},n=t.valueParseFunction??gA;if(e.config)for(let i in e.config)s[i]=n(i,e.config,t.scene);("FGSetPropertyBlock"===(i=e.className)||"FGGetPropertyBlock"===i||"FGPlayAnimationBlock"===i||"FGMeshPickEventBlock"===i)&&(s.pathConverter=t.pathConverter);let a=new r(s);a.uniqueId=e.uniqueId;for(let t=0;t<e.dataInputs.length;t++){let i=a.getDataInput(e.dataInputs[t].name);if(i)i.deserialize(e.dataInputs[t]);else throw Error("Could not find data input with name "+e.dataInputs[t].name+" in block "+e.className)}for(let t=0;t<e.dataOutputs.length;t++){let i=a.getDataOutput(e.dataOutputs[t].name);if(i)i.deserialize(e.dataOutputs[t]);else throw Error("Could not find data output with name "+e.dataOutputs[t].name+" in block "+e.className)}return a.metadata=e.metadata,a.deserialize&&a.deserialize(e),a}}class gN extends gu{_isSingularConnection(){return 1===this.connectionType}_activateSignal(e){0===this.connectionType?(e._notifyExecuteNode(this._ownerBlock),this._ownerBlock._execute(e,this),e._increaseExecutionId()):this._connectedPoint[0]?._activateSignal(e)}}(0,i3.H7)("FlowGraphSignalConnection",gN);class gO extends gM{constructor(e){super(e),this.signalInputs=[],this.signalOutputs=[],this.in=this._registerSignalInput("in")}_registerSignalInput(e){let t=new gN(e,0,this);return this.signalInputs.push(t),t}_registerSignalOutput(e){let t=new gN(e,1,this);return this.signalOutputs.push(t),t}getSignalInput(e){return this.signalInputs.find(t=>t.name===e)}getSignalOutput(e){return this.signalOutputs.find(t=>t.name===e)}serialize(e={}){for(let t of(super.serialize(e),e.signalInputs=[],e.signalOutputs=[],this.signalInputs)){let i={};t.serialize(i),e.signalInputs.push(i)}for(let t of this.signalOutputs){let i={};t.serialize(i),e.signalOutputs.push(i)}}deserialize(e){for(let t=0;t<e.signalInputs.length;t++){let i=this.getSignalInput(e.signalInputs[t].name);if(i)i.deserialize(e.signalInputs[t]);else throw Error("Could not find signal input with name "+e.signalInputs[t].name+" in block "+e.className)}for(let t=0;t<e.signalOutputs.length;t++){let i=this.getSignalOutput(e.signalOutputs[t].name);if(i)i.deserialize(e.signalOutputs[t]);else throw Error("Could not find signal output with name "+e.signalOutputs[t].name+" in block "+e.className)}}getClassName(){return"FGExecutionBlock"}}class gD extends gO{constructor(e){super(e),this.out=this._registerSignalOutput("out"),this.done=this._registerSignalOutput("done")}_startPendingTasks(e){this._preparePendingTasks(e),e._addPendingBlock(this)}}class gF extends gD{_execute(e){e._notifyExecuteNode(this),this.out._activateSignal(e)}}class gL{constructor(e){this.uniqueId=(0,hj.f)(),this._userVariables={},this._executionVariables={},this._connectionValues={},this._pendingBlocks=[],this._executionId=0,this.onNodeExecutedObservable=new i0.y$,this._configuration=e}hasVariable(e){return e in this._userVariables}setVariable(e,t){this._userVariables[e]=t}getVariable(e){return this._userVariables[e]}get userVariables(){return this._userVariables}_getUniqueIdPrefixedName(e,t){return`${e.uniqueId}_${t}`}_setExecutionVariable(e,t,i){this._executionVariables[this._getUniqueIdPrefixedName(e,t)]=i}_getExecutionVariable(e,t,i){return this._hasExecutionVariable(e,t)?this._executionVariables[this._getUniqueIdPrefixedName(e,t)]:i}_deleteExecutionVariable(e,t){delete this._executionVariables[this._getUniqueIdPrefixedName(e,t)]}_hasExecutionVariable(e,t){return this._getUniqueIdPrefixedName(e,t) in this._executionVariables}_hasConnectionValue(e){return e.uniqueId in this._connectionValues}_setConnectionValue(e,t){this._connectionValues[e.uniqueId]=t}_getConnectionValue(e){return this._connectionValues[e.uniqueId]}get configuration(){return this._configuration}_addPendingBlock(e){this._pendingBlocks.push(e)}_removePendingBlock(e){let t=this._pendingBlocks.indexOf(e);-1!==t&&this._pendingBlocks.splice(t,1)}_clearPendingBlocks(){for(let e of this._pendingBlocks)e._cancelPendingTasks(this);this._pendingBlocks.length=0}_notifyExecuteNode(e){this.onNodeExecutedObservable.notifyObservers(e)}_increaseExecutionId(){this._executionId++}get executionId(){return this._executionId}serialize(e={},t=gR){for(let i in e.uniqueId=this.uniqueId,e._userVariables={},this._userVariables)t(i,this._userVariables[i],e._userVariables);for(let i in e._connectionValues={},this._connectionValues)t(i,this._connectionValues[i],e._connectionValues)}getClassName(){return"FGContext"}static Parse(e,t){let i=t.graph.createContext(),r=t.valueParseFunction??gA;for(let t in i.uniqueId=e.uniqueId,e._userVariables){let s=r(t,e._userVariables,i._configuration.scene);i._userVariables[t]=s}for(let t in e._connectionValues){let s=r(t,e._connectionValues,i._configuration.scene);i._connectionValues[t]=s}return i}}function gw(e,t){return!!(e.parent&&(e.parent===t||gw(e.parent,t)))}(0,r$.gn)([(0,rj.qC)()],gL.prototype,"uniqueId",void 0);class gB extends gF{constructor(e){super(e),this.config=e}_getReferencedMesh(){let e=this.config.pathConverter.convert(this.config.path),t=e.info.getObject(e.object);if(!t||!(t instanceof rA.x))throw Error("Mesh pick event block requires a valid mesh");return t}_preparePendingTasks(e){let t=e._getExecutionVariable(this,"meshPickObserver");if(!t){let i=this._getReferencedMesh();e._setExecutionVariable(this,"mesh",i),t=i.getScene().onPointerObservable.add(t=>{t.type===r1.kD.POINTERPICK&&t.pickInfo?.pickedMesh&&(t.pickInfo?.pickedMesh===i||gw(t.pickInfo?.pickedMesh,i))&&this._execute(e)});let r=i.onDisposeObservable.add(()=>this._onDispose);e._setExecutionVariable(this,"meshPickObserver",t),e._setExecutionVariable(this,"meshDisposeObserver",r)}}_onDispose(e){this._cancelPendingTasks(e),e._removePendingBlock(this)}_cancelPendingTasks(e){let t=e._getExecutionVariable(this,"mesh"),i=e._getExecutionVariable(this,"meshPickObserver"),r=e._getExecutionVariable(this,"meshDisposeObserver");t.getScene().onPointerObservable.remove(i),t.onDisposeObservable.remove(r),e._deleteExecutionVariable(this,"mesh"),e._deleteExecutionVariable(this,"meshPickObserver"),e._deleteExecutionVariable(this,"meshDisposeObserver")}getClassName(){return gB.ClassName}serialize(e){super.serialize(e),e.config.path=this.config.path}}gB.ClassName="FGMeshPickEventBlock",(0,i3.H7)(gB.ClassName,gB),(e8=iZ||(iZ={}))[e8.Stopped=0]="Stopped",e8[e8.Started=1]="Started";class gV{constructor(e){this._eventBlocks=[],this._executionContexts=[],this.state=0,this._scene=e.scene,this._coordinator=e.coordinator,this._sceneDisposeObserver=this._scene.onDisposeObservable.add(()=>this.dispose())}createContext(){let e=new gL({scene:this._scene,coordinator:this._coordinator});return this._executionContexts.push(e),e}getContext(e){return this._executionContexts[e]}addEventBlock(e){this._eventBlocks.push(e)}start(){if(1!==this.state)for(let e of(this.state=1,0===this._executionContexts.length&&this.createContext(),this._executionContexts))for(let t of this._getContextualOrder())t._startPendingTasks(e)}_getContextualOrder(){let e=[];for(let t of this._eventBlocks)if(t.getClassName()===gB.ClassName){let i=t._getReferencedMesh(),r=0;for(;r<e.length;r++){let t=e[r]._getReferencedMesh();if(i&&t&&gw(i,t))break}e.splice(r,0,t)}else e.push(t);return e}dispose(){if(0!==this.state){for(let e of(this.state=0,this._executionContexts))e._clearPendingBlocks();this._executionContexts.length=0,this._eventBlocks.length=0,this._scene.onDisposeObservable.remove(this._sceneDisposeObserver),this._sceneDisposeObserver=null}}visitAllBlocks(e){let t=[],i=new Set;for(let e of this._eventBlocks)t.push(e),i.add(e.uniqueId);for(;t.length>0;){let r=t.pop();for(let s of(e(r),r.dataInputs))for(let e of s._connectedPoint)i.has(e._ownerBlock.uniqueId)||(t.push(e._ownerBlock),i.add(e._ownerBlock.uniqueId));if(r instanceof gO)for(let e of r.signalOutputs)for(let r of e._connectedPoint)i.has(r._ownerBlock.uniqueId)||(t.push(r._ownerBlock),i.add(r._ownerBlock.uniqueId))}}serialize(e={},t){for(let i of(e.allBlocks=[],this.visitAllBlocks(t=>{let i={};t.serialize(i),e.allBlocks.push(i)}),e.executionContexts=[],this._executionContexts)){let r={};i.serialize(r,t),e.executionContexts.push(r)}}static GetDataOutConnectionByUniqueId(e,t){for(let i of e)for(let e of i.dataOutputs)if(e.uniqueId===t)return e;throw Error("Could not find data out connection with unique id "+t)}static GetSignalInConnectionByUniqueId(e,t){for(let i of e)if(i instanceof gO){for(let e of i.signalInputs)if(e.uniqueId===t)return e}throw Error("Could not find signal in connection with unique id "+t)}static Parse(e,t){let i=t.coordinator.createGraph(),r=[],s=t.valueParseFunction??gA;for(let n of e.allBlocks){let e=gM.Parse(n,{scene:t.coordinator.config.scene,pathConverter:t.pathConverter,valueParseFunction:s});r.push(e),e instanceof gF&&i.addEventBlock(e)}for(let e of r){for(let t of e.dataInputs)for(let e of t.connectedPointIds){let i=gV.GetDataOutConnectionByUniqueId(r,e);t.connectTo(i)}if(e instanceof gO)for(let t of e.signalOutputs)for(let e of t.connectedPointIds){let i=gV.GetSignalInConnectionByUniqueId(r,e);t.connectTo(i)}}for(let t of e.executionContexts)gL.Parse(t,{graph:i,valueParseFunction:s});return i}}class gU{constructor(e){this.config=e,this._flowGraphs=[],this._customEventsMap=new Map,this.config.scene.onDisposeObservable.add(()=>{this.dispose()}),(gU.SceneCoordinators.get(this.config.scene)??[]).push(this)}createGraph(){let e=new gV({scene:this.config.scene,coordinator:this});return this._flowGraphs.push(e),e}removeGraph(e){let t=this._flowGraphs.indexOf(e);-1!==t&&(e.dispose(),this._flowGraphs.splice(t,1))}start(){this._flowGraphs.forEach(e=>e.start())}dispose(){this._flowGraphs.forEach(e=>e.dispose()),this._flowGraphs.length=0;let e=gU.SceneCoordinators.get(this.config.scene)??[],t=e.indexOf(this);-1!==t&&e.splice(t,1)}serialize(e,t){e._flowGraphs=[],this._flowGraphs.forEach(i=>{let r={};i.serialize(r,t),e._flowGraphs.push(r)})}static Parse(e,t){let i=t.valueParseFunction??gA,r=new gU({scene:t.scene});return e._flowGraphs?.forEach(e=>{gV.Parse(e,{coordinator:r,valueParseFunction:i,pathConverter:t.pathConverter})}),r}get flowGraphs(){return this._flowGraphs}getCustomEventObservable(e){let t=this._customEventsMap.get(e);return t||(t=new i0.y$,this._customEventsMap.set(e,t)),t}notifyCustomEvent(e,t){let i=this._customEventsMap.get(e);i&&i.notifyObservers(t)}}gU.SceneCoordinators=new Map;class gk extends gO{constructor(e){super(e),this.out=this._registerSignalOutput("out")}}class gG extends gk{constructor(e){super(e),this.message=this.registerDataInput("message",gf)}_execute(e){let t=this.message.getValue(e);re.Y.Log(t),this.out._activateSignal(e)}getClassName(){return gG.ClassName}}gG.ClassName="FGConsoleLogBlock",(0,i3.H7)(gG.ClassName,gG);class gz extends gk{constructor(e){super(e),this.config=e,this.input=this.registerDataInput(e.variableName,gf)}_execute(e){let t=this.config.variableName,i=this.input.getValue(e);e.setVariable(t,i),this.out._activateSignal(e)}getClassName(){return gz.ClassName}}gz.ClassName="FGSetVariableBlock",(0,i3.H7)(gz.ClassName,gz);let gH=new RegExp(/\{(\w+)\}/g);class gW{constructor(e,t){this.path=e,this.ownerBlock=t,this.templatedInputs=[];let i=gH.exec(e);for(;i;){let[,r]=i;this.templatedInputs.push(t.registerDataInput(r,gb)),i=gH.exec(e)}}getAccessor(e,t){let i=this.path;for(let e of this.templatedInputs){let r=e.getValue(t).value;i=i.replace(`{${e.name}}`,r.toString())}return e.convert(i)}}class gY extends gk{constructor(e){super(e),this.config=e,this.a=this.registerDataInput("a",gf),this.templateComponent=new gW(e.path,this)}_execute(e){let t=this.a.getValue(e),i=this.templateComponent.getAccessor(this.config.pathConverter,e);i.info.set(t,i.object),this.out._activateSignal(e)}serialize(e={}){super.serialize(e),e.config.path=this.config.path}getClassName(){return gY.ClassName}}gY.ClassName="FGSetPropertyBlock",(0,i3.H7)("FGSetPropertyBlock",gY);class gX extends gk{constructor(e){super(e),this.config=e;for(let e=0;e<this.config.eventData.length;e++){let t=this.config.eventData[e];this.registerDataInput(t,gf)}}_execute(e){let t=this.config.eventId,i=this.dataInputs.map(t=>t.getValue(e));e.configuration.coordinator.notifyCustomEvent(t,i),this.out._activateSignal(e)}getClassName(){return gX.ClassName}}gX.ClassName="FGSendCustomEventBlock",(0,i3.H7)("FGSendCustomEventBlock",gX);class g$ extends gO{constructor(e){super(e),this.condition=this.registerDataInput("condition",g_),this.onTrue=this._registerSignalOutput("onTrue"),this.onFalse=this._registerSignalOutput("onFalse")}_execute(e){this.condition.getValue(e)?this.onTrue._activateSignal(e):this.onFalse._activateSignal(e)}getClassName(){return"FGBranchBlock"}}(0,i3.H7)("FGBranchBlock",g$);class gj extends gk{constructor(e={startIndex:new gh(0)}){super(e),this.config=e,this.reset=this._registerSignalInput("reset"),this.n=this.registerDataInput("n",gb),this.value=this.registerDataOutput("value",gb)}_execute(e,t){if(t===this.reset)this.value.setValue(this.config.startIndex,e);else{let t=this.value.getValue(e);t.value<this.n.getValue(e).value&&(this.value.setValue(new gh(t.value+1),e),this.out._activateSignal(e))}}getClassName(){return gj.ClassName}}gj.ClassName="FGDoNBlock",(0,i3.H7)(gj.ClassName,gj);class gq extends gk{constructor(e){super(e),this.startIndex=this.registerDataInput("startIndex",gm),this.endIndex=this.registerDataInput("endIndex",gm),this.step=this.registerDataInput("step",gm),this.index=this.registerDataOutput("index",gm),this.onLoop=this._registerSignalOutput("onLoop")}_executeLoop(e){let t=e._getExecutionVariable(this,"index");t<e._getExecutionVariable(this,"endIndex")?(this.index.setValue(t,e),this.onLoop._activateSignal(e),t+=e._getExecutionVariable(this,"step",1),e._setExecutionVariable(this,"index",t),this._executeLoop(e)):this.out._activateSignal(e)}_execute(e){let t=this.startIndex.getValue(e),i=this.endIndex.getValue(e),r=this.step.getValue(e);e._setExecutionVariable(this,"index",t),e._setExecutionVariable(this,"endIndex",i),e._setExecutionVariable(this,"step",r),this._executeLoop(e)}getClassName(){return"FGForLoopBlock"}}(0,i3.H7)("FGForLoopBlock",gq);class gQ extends gk{constructor(e){super(e),this.reset=this._registerSignalInput("reset"),this.duration=this.registerDataInput("duration",gm),this.timeRemaining=this.registerDataOutput("timeRemaining",gm)}_execute(e,t){let i=e._getExecutionVariable(this,"lastExecutedTime"),r=this.duration.getValue(e),s=Date.now();t===this.reset||void 0===i||s-i>r?(this.timeRemaining.setValue(0,e),this.out._activateSignal(e),e._setExecutionVariable(this,"lastExecutedTime",s)):this.timeRemaining.setValue(r-(s-i),e)}getClassName(){return"FGThrottleBlock"}}(0,i3.H7)("FGThrottleBlock",gQ);class gK extends gD{constructor(e){super(e),this.timeout=this.registerDataInput("timeout",gm)}_preparePendingTasks(e){let t=this.timeout.getValue(e);if(void 0!==t&&t>=0){let i=e._getExecutionVariable(this,"runningTimers")||[],r=new l9({timeout:t,contextObservable:e.configuration.scene.onBeforeRenderObservable,onEnded:()=>this._onEnded(r,e)});r.start(),i.push(r),e._setExecutionVariable(this,"runningTimers",i)}}_execute(e){this._startPendingTasks(e),this.out._activateSignal(e)}_onEnded(e,t){let i=t._getExecutionVariable(this,"runningTimers")||[],r=i.indexOf(e);-1!==r?i.splice(r,1):rD.w1.Warn("FlowGraphTimerBlock: Timer ended but was not found in the running timers list"),t._removePendingBlock(this),this.done._activateSignal(t)}_cancelPendingTasks(e){for(let t of e._getExecutionVariable(this,"runningTimers")||[])t.dispose();e._deleteExecutionVariable(this,"runningTimers")}getClassName(){return gK.ClassName}}gK.ClassName="FGTimerBlock",(0,i3.H7)("FGTimerBlock",gK);class gZ extends gO{constructor(e){super(e),this.config=e,this._cachedUnusedIndexes=[],this.reset=this._registerSignalInput("reset"),this.currentIndex=this.registerDataOutput("currentIndex",gm),this.config.startIndex=void 0!==this.config.startIndex?this.config.startIndex:0,this.config.startIndex=Math.max(0,Math.min(this.config.startIndex,this.config.numberOutputFlows-1)),this.outFlows=[];for(let e=0;e<this.config.numberOutputFlows;e++)this.outFlows.push(this._registerSignalOutput(`out${e}`))}_getUnusedIndexes(e){let t=this._cachedUnusedIndexes;if(t.length=0,e._hasExecutionVariable(this,"unusedIndexes")){let i=e._getExecutionVariable(this,"unusedIndexes");for(let e=0;e<i.length;e++)t.push(i[e])}else for(let e=0;e<this.config.numberOutputFlows;e++)t.push(e);return t}_getNextOutput(e,t){if(!this.config.isRandom)return e+1;{let e=Math.floor(Math.random()*t.length);return t[e]}}_execute(e,t){let i=e._getExecutionVariable(this,"currentIndex")??this.config.startIndex-1,r=this._getUnusedIndexes(e);if(t===this.reset){e._deleteExecutionVariable(this,"currentIndex"),e._deleteExecutionVariable(this,"unusedIndexes");return}let s=this._getNextOutput(i,r);if(s>=this.config.numberOutputFlows&&this.config.loop)s=0;else if(s>=this.config.numberOutputFlows&&!this.config.loop)return;if(0===(r=r.filter(e=>e!==s)).length)for(let e=0;e<this.config.numberOutputFlows;e++)r.push(e);e._setExecutionVariable(this,"unusedIndexes",r),e._setExecutionVariable(this,"currentIndex",s),this.currentIndex.setValue(s,e),this.outFlows[s]._activateSignal(e)}getClassName(){return"FGMultiGateBlock"}serialize(e){super.serialize(e),e.config.numberOutputFlows=this.config.numberOutputFlows,e.config.isRandom=this.config.isRandom,e.config.loop=this.config.loop,e.config.startIndex=this.config.startIndex}}(0,i3.H7)("FGMultiGateBlock",gZ);class gJ extends gO{constructor(e){super(e),this.config=e,this.selection=this.registerDataInput("selection",gf),this.outputFlows=[];for(let e=0;e<=this.config.cases.length;e++)this.outputFlows.push(this._registerSignalOutput(`out${e}`))}_execute(e,t){let i=this.selection.getValue(e);for(let t=0;t<this.config.cases.length;t++)if(i===this.config.cases[t]){this.outputFlows[t]._activateSignal(e);return}this.outputFlows[this.outputFlows.length-1]._activateSignal(e)}getClassName(){return"FGSwitchBlock"}serialize(e){super.serialize(e),e.cases=this.config.cases}}(0,i3.H7)("FGSwitchBlock",gJ);class g0 extends gk{constructor(e){super(e),this.config=e,this.inFlows=[],this._cachedActivationState=[],this.reset=this._registerSignalInput("reset");for(let e=1;e<this.config.numberInputFlows;e++)this.inFlows.push(this._registerSignalInput(`in${e}`))}_getCurrentActivationState(e){let t=this._cachedActivationState;if(t.length=0,e._hasExecutionVariable(this,"activationState")){let i=e._getExecutionVariable(this,"activationState");for(let e=0;e<i.length;e++)t.push(i[e])}else for(let e=0;e<this.config.numberInputFlows;e++)t.push(!1);return t}_execute(e,t){let i=this._getCurrentActivationState(e);if(t===this.reset)for(let e=0;e<this.config.numberInputFlows;e++)i[e]=!1;else if(t===this.in)i[0]=!0;else{let e=this.inFlows.indexOf(t);e>=0&&(i[e+1]=!0)}if(e._setExecutionVariable(this,"activationState",i.slice()),i.every(e=>e)){this.out._activateSignal(e);for(let e=0;e<this.config.numberInputFlows;e++)i[e]=!1}}getClassName(){return"FGWaitAllBlock"}serialize(e){super.serialize(e),e.config.numberInputFlows=this.config.numberInputFlows}}(0,i3.H7)("FGWaitAllBlock",g0);class g1 extends gk{constructor(e){super(e),this.count=this.registerDataOutput("count",gm),this.reset=this._registerSignalInput("reset")}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"count",0),this.count.setValue(0,e);return}let i=(e._getExecutionVariable(this,"count")??0)+1;e._setExecutionVariable(this,"count",i),this.count.setValue(i,e),this.out._activateSignal(e)}getClassName(){return"FGCounterBlock"}}(0,i3.H7)("FGCounterBlock",g1);class g2 extends gk{constructor(e){super(e),this.config=e,this.condition=this.registerDataInput("condition",g_),this.loopBody=this._registerSignalOutput("loopBody")}_execute(e,t){let i=this.condition.getValue(e);for(this.config?.isDo&&!i&&this.loopBody._activateSignal(e);i;)this.loopBody._activateSignal(e),i=this.condition.getValue(e);this.out._activateSignal(e)}getClassName(){return g2.ClassName}serialize(e){super.serialize(e),e.isDo=this.config?.isDo}}g2.ClassName="FGWhileLoopBlock",(0,i3.H7)(g2.ClassName,g2);class g3 extends gk{constructor(e){super(e),this.count=this.registerDataInput("count",gm),this.reset=this._registerSignalInput("reset"),this.currentCount=this.registerDataOutput("currentCount",gm)}_execute(e,t){if(t===this.reset){e._setExecutionVariable(this,"debounceCount",0);return}let i=this.count.getValue(e),r=e._getExecutionVariable(this,"debounceCount",0)+1;this.currentCount.setValue(r,e),e._setExecutionVariable(this,"debounceCount",r),r>=i&&(this.out._activateSignal(e),e._setExecutionVariable(this,"debounceCount",0))}getClassName(){return"FGDebounceBlock"}}(0,i3.H7)("FGDebounceBlock",g3);class g4 extends gO{constructor(e){super(e),this.onOn=this._registerSignalOutput("onOn"),this.onOff=this._registerSignalOutput("onOff"),this.isOn=this.registerDataOutput("isOn",g_)}_execute(e,t){let i=e._getExecutionVariable(this,"value",!1);i=!i,e._setExecutionVariable(this,"value",i),this.isOn.setValue(i,e),i?this.onOn._activateSignal(e):this.onOff._activateSignal(e)}getClassName(){return"FGFlipFlopBlock"}}(0,i3.H7)("FGFlipFlopBlock",g4);class g5 extends gO{constructor(e){super(e),this.config=e,this.outFlows=[];for(let e=0;e<this.config.numberOutputFlows;e++)this.outFlows.push(this._registerSignalOutput(`${e}`))}_execute(e){for(let t=0;t<this.config.numberOutputFlows;t++)this.outFlows[t]._activateSignal(e)}getClassName(){return g5.ClassName}}g5.ClassName="FGSequenceBlock",(0,i3.H7)(g5.ClassName,g5);class g7 extends gD{constructor(e){super(e),this.config=e,this.templateTargetComponent=new gW(e.targetPath,this),this.templateAnimationComponent=new gW(e.animationPath,this),this.speed=this.registerDataInput("speed",gm),this.loop=this.registerDataInput("loop",g_),this.from=this.registerDataInput("from",gm),this.to=this.registerDataInput("to",gm),this.runningAnimatable=this.registerDataOutput("runningAnimatable",gf)}_preparePendingTasks(e){let t=this.templateTargetComponent.getAccessor(this.config.pathConverter,e),i=t.info.getObject(t.object),r=this.templateAnimationComponent.getAccessor(this.config.pathConverter,e),s=r.info.get(r.object);if(!i||!s)throw Error("Cannot play animation without target or animation");let n=e._getExecutionVariable(this,"runningAnimatables")??[],a=this.runningAnimatable.getValue(e);if(a&&a.paused)a.restart();else{let t=e.configuration.scene.beginDirectAnimation(i,[s],this.from.getValue(e),this.to.getValue(e),this.loop.getValue(e),this.speed.getValue(e),()=>this._onAnimationEnd(t,e));this.runningAnimatable.setValue(t,e),n.push(t)}e._setExecutionVariable(this,"runningAnimatables",n)}_execute(e){this._startPendingTasks(e),this.out._activateSignal(e)}_onAnimationEnd(e,t){let i=t._getExecutionVariable(this,"runningAnimatables")??[],r=i.indexOf(e);-1!==r&&i.splice(r,1),t._removePendingBlock(this),this.done._activateSignal(t)}_cancelPendingTasks(e){for(let t of e._getExecutionVariable(this,"runningAnimatables")??[])t.stop();e._deleteExecutionVariable(this,"runningAnimatables")}getClassName(){return g7.ClassName}serialize(e={}){super.serialize(e),e.config.targetPath=this.config.targetPath,e.config.animationPath=this.config.animationPath}}g7.ClassName="FGPlayAnimationBlock",(0,i3.H7)(g7.ClassName,g7);class g6 extends gk{constructor(e){super(e),this.animationToStop=this.registerDataInput("animationToStop",gf)}_execute(e){this.animationToStop.getValue(e).stop(),this.out._activateSignal(e)}getClassName(){return"FGStopAnimationBlock"}}(0,i3.H7)("FGStopAnimationBlock",g6);class g8 extends gk{constructor(e){super(e),this.animationToPause=this.registerDataInput("animationToPause",gf)}_execute(e){this.animationToPause.getValue(e).pause(),this.out._activateSignal(e)}getClassName(){return"FGPauseAnimationBlock"}}(0,i3.H7)("FGPauseAnimationBlock",g8);class g9 extends gM{constructor(e){super(e),this.condition=this.registerDataInput("condition",g_),this.trueValue=this.registerDataInput("trueValue",gf),this.falseValue=this.registerDataInput("falseValue",gf),this.output=this.registerDataOutput("output",gf)}_updateOutputs(e){this.output.setValue(this.condition.getValue(e)?this.trueValue.getValue(e):this.falseValue.getValue(e),e)}getClassName(){return"FGConditionalDataBlock"}}(0,i3.H7)("FGConditionalDataBlock",g9);class ve extends gM{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput(e.variableName,gf)}_updateOutputs(e){let t=this.config.variableName;e.hasVariable(t)&&this.output.setValue(e.getVariable(t),e)}getClassName(){return ve.ClassName}serialize(e){super.serialize(e),e.config.variableName=this.config.variableName}}ve.ClassName="FGGetVariableBlock",(0,i3.H7)(ve.ClassName,ve);class vt extends gM{constructor(e){super(e),this.sourceSystem=this.registerDataInput("sourceSystem",gf),this.destinationSystem=this.registerDataInput("destinationSystem",gf),this.inputCoordinates=this.registerDataInput("inputCoordinates",gv),this.outputCoordinates=this.registerDataOutput("outputCoordinates",gv)}_updateOutputs(e){let t=this.sourceSystem.getValue(e),i=this.destinationSystem.getValue(e),r=this.inputCoordinates.getValue(e),s=t.getWorldMatrix(),n=i.getWorldMatrix(),a=i1.jp.Matrix[0].copyFrom(n);a.invert();let o=i1.jp.Matrix[1];a.multiplyToRef(s,o);let l=this.outputCoordinates.getValue(e);i1.P.TransformCoordinatesToRef(r,o,l)}getClassName(){return"FGCoordinateTransformBlock"}}(0,i3.H7)("FGCoordinateTransformBlock",vt);class vi extends gM{constructor(e){super(e),this.config=e,this.output=this.registerDataOutput("output",function(e){switch(typeof e){case"string":return gp;case"number":return gm;case"boolean":return g_;case"object":if(e instanceof i1.FM)return gg;if(e instanceof i1.P)return gv;if(e instanceof i1.Lt)return gS;if(e instanceof i2.Wo)return gE;else if(e instanceof i2.HE)return gC;else if(e instanceof i1._f)return gT;else if(e instanceof gh)return gb;else return gf;default:return gf}}(e.value))}_updateOutputs(e){this.output.setValue(this.config.value,e)}getClassName(){return"FGConstantBlock"}serialize(e={},t=gR){super.serialize(e),t("value",this.config.value,e.config)}}(0,i3.H7)("FGConstantBlock",vi);class vr extends gM{constructor(e){super(e),this.config=e,this.value=this.registerDataOutput("value",gf),this.templateComponent=new gW(e.path,this)}_updateOutputs(e){let t=this.templateComponent.getAccessor(this.config.pathConverter,e),i=t.info.get(t.object);this.value.setValue(i,e)}getClassName(){return vr.ClassName}serialize(e={}){super.serialize(e),e.config.path=this.config.path}}vr.ClassName="FGGetPropertyBlock",(0,i3.H7)(vr.ClassName,vr);let vs="cachedOperationValue",vn="cachedExecutionId";class va extends gM{constructor(e,t){super(t),this.value=this.registerDataOutput("value",e)}_updateOutputs(e){let t=e._getExecutionVariable(this,vn),i=e._getExecutionVariable(this,vs);if(void 0!==i&&t===e.executionId)this.value.setValue(i,e);else{let t=this._doOperation(e);e._setExecutionVariable(this,vs,t),e._setExecutionVariable(this,vn,e.executionId),this.value.setValue(t,e)}}}class vo extends va{constructor(e,t,i,r,s,n){super(i,n),this._operation=r,this._className=s,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e))}getClassName(){return this._className}}class vl extends va{constructor(e,t,i,r,s){super(t,s),this._operation=i,this._className=r,this.a=this.registerDataInput("a",e)}_doOperation(e){return this._operation(this.a.getValue(e))}getClassName(){return this._className}}let vc="FGLogic",vu="AndBlock",vh="OrBlock",vd="NotBlock";class vf extends vo{constructor(e){super(g_,g_,g_,(e,t)=>e&&t,`${vc}${vu}`,e)}}(0,i3.H7)(`${vc}${vu}`,vf);class vp extends vo{constructor(e){super(g_,g_,g_,(e,t)=>e||t,`${vc}${vh}`,e)}}(0,i3.H7)(`${vc}${vh}`,vp);class vm extends vl{constructor(e){super(g_,g_,e=>!e,`${vc}${vd}`,e)}}(0,i3.H7)(`${vc}${vd}`,vm);class v_ extends va{constructor(e,t,i,r){super(e,r),this._operation=t,this._className=i}_doOperation(e){return this._operation()}getClassName(){return this._className}}class vg extends va{constructor(e,t,i,r,s,n,a){super(r,a),this._operation=s,this._className=n,this.a=this.registerDataInput("a",e),this.b=this.registerDataInput("b",t),this.c=this.registerDataInput("c",i)}_doOperation(e){return this._operation(this.a.getValue(e),this.b.getValue(e),this.c.getValue(e))}getClassName(){return this._className}}function vv(e){return e.getClassName?e.getClassName():""}function vS(e,t){return"Vector2"===e&&"Vector2"===t||"Vector3"===e&&"Vector3"===t||"Vector4"===e&&"Vector4"===t}function vx(e,t){return"Matrix"===e&&"Matrix"===t}function vE(e,t){return"FlowGraphInteger"===e&&"FlowGraphInteger"===t}class vC extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicAdd(e,t),vC.ClassName,e)}_polymorphicAdd(e,t){let i=vv(e),r=vv(t);return vS(i,r)||vx(i,r)||vE(i,r)?e.add(t):e+t}}vC.ClassName="FGAddBlock",(0,i3.H7)(vC.ClassName,vC);class vT extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicAdd(e,t),vT.ClassName,e)}_polymorphicAdd(e,t){let i=vv(e),r=vv(t);return vS(i,r)||vE(i,r)?e.subtract(t):vx(i,r)?e.add(t.scale(-1)):e-t}}vT.ClassName="FGSubBlock",(0,i3.H7)(vT.ClassName,vT);class vb extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicMultiply(e,t),vb.ClassName,e)}_polymorphicMultiply(e,t){let i=vv(e),r=vv(t);return vS(i,r)||vE(i,r)?e.multiply(t):vx(i,r)?i1.y3.FromValues(e.m[0]*t.m[0],e.m[4]*t.m[4],e.m[8]*t.m[8],e.m[12]*t.m[12],e.m[1]*t.m[1],e.m[5]*t.m[5],e.m[9]*t.m[9],e.m[13]*t.m[13],e.m[2]*t.m[2],e.m[6]*t.m[6],e.m[10]*t.m[10],e.m[14]*t.m[14],e.m[3]*t.m[3],e.m[7]*t.m[7],e.m[11]*t.m[11],e.m[15]*t.m[15]):e*t}}vb.ClassName="FGMultiplyBlock",(0,i3.H7)(vb.ClassName,vb);class vy extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicDivide(e,t),vy.ClassName,e)}_polymorphicDivide(e,t){let i=vv(e),r=vv(t);return vS(i,r)||vE(i,r)?e.divide(t):vx(i,r)?i1.y3.FromValues(e.m[0]/t.m[0],e.m[4]/t.m[4],e.m[8]/t.m[8],e.m[12]/t.m[12],e.m[1]/t.m[1],e.m[5]/t.m[5],e.m[9]/t.m[9],e.m[13]/t.m[13],e.m[2]/t.m[2],e.m[6]/t.m[6],e.m[10]/t.m[10],e.m[14]/t.m[14],e.m[3]/t.m[3],e.m[7]/t.m[7],e.m[11]/t.m[11],e.m[15]/t.m[15]):e/t}}vy.ClassName="FGDivideBlock",(0,i3.H7)(vy.ClassName,vy);class vI extends v_{constructor(e){super(gm,()=>Math.random(),vI.ClassName,e)}}vI.ClassName="FGRandomBlock",(0,i3.H7)(vI.ClassName,vI);class vP extends vo{constructor(e){super(gf,gf,gm,(e,t)=>this._polymorphicDot(e,t),vP.ClassName,e)}_polymorphicDot(e,t){switch(vv(e)){case"Vector2":return i1.FM.Dot(e,t);case"Vector3":return i1.P.Dot(e,t);case"Vector4":return i1.Lt.Dot(e,t);default:throw Error(`Cannot get dot product of ${e} and ${t}`)}}}vP.ClassName="FGDotBlock",(0,i3.H7)(vP.ClassName,vP);class vR extends v_{constructor(e){super(gm,()=>Math.E,vR.ClassName,e)}}vR.ClassName="FGEBlock",(0,i3.H7)(vR.ClassName,vR);class vA extends v_{constructor(e){super(gm,()=>Math.PI,vA.ClassName,e)}}vA.ClassName="FGPIBlock",(0,i3.H7)(vA.ClassName,vA);class vM extends v_{constructor(e){super(gm,()=>Number.POSITIVE_INFINITY,vM.ClassName,e)}}vM.ClassName="FGInfBlock",(0,i3.H7)(vM.ClassName,vM);class vN extends v_{constructor(e){super(gm,()=>Number.NaN,vN.ClassName,e)}}function vO(e,t){switch(vv(e)){case"FlowGraphInteger":return new gh(t(e.value));case"Vector2":return new i1.FM(t(e.x),t(e.y));case"Vector3":return new i1.P(t(e.x),t(e.y),t(e.z));case"Vector4":return new i1.Lt(t(e.x),t(e.y),t(e.z),t(e.w));case"Matrix":return i1.y3.FromValues(t(e.m[0]),t(e.m[4]),t(e.m[8]),t(e.m[12]),t(e.m[1]),t(e.m[5]),t(e.m[9]),t(e.m[13]),t(e.m[2]),t(e.m[6]),t(e.m[10]),t(e.m[14]),t(e.m[3]),t(e.m[7]),t(e.m[11]),t(e.m[15]));default:return t(e)}}vN.ClassName="FGNaNBlock",(0,i3.H7)(vN.ClassName,vN);class vD extends vl{constructor(e){super(gf,gf,e=>this._polymorphicAbs(e),vD.ClassName,e)}_polymorphicAbs(e){return vO(e,Math.abs)}}vD.ClassName="FGAbsBlock",(0,i3.H7)(vD.ClassName,vD);class vF extends vl{constructor(e){super(gf,gf,e=>this._polymorphicSign(e),vF.ClassName,e)}_polymorphicSign(e){return vO(e,Math.sign)}}vF.ClassName="FGSignBlock",(0,i3.H7)(vF.ClassName,vF);class vL extends vl{constructor(e){super(gf,gf,e=>this._polymorphicTrunc(e),vL.ClassName,e)}_polymorphicTrunc(e){return vO(e,Math.trunc)}}vL.ClassName="FGTruncBlock",(0,i3.H7)(vL.ClassName,vL);class vw extends vl{constructor(e){super(gf,gf,e=>this._polymorphicFloor(e),vw.ClassName,e)}_polymorphicFloor(e){return vO(e,Math.floor)}}vw.ClassName="FGFloorBlock",(0,i3.H7)(vw.ClassName,vw);class vB extends vl{constructor(e){super(gf,gf,e=>this._polymorphicCeiling(e),vB.ClassName,e)}_polymorphicCeiling(e){return vO(e,Math.ceil)}}vB.ClassName="FGCeilBlock",(0,i3.H7)(vB.ClassName,vB);class vV extends vl{constructor(e){super(gf,gf,e=>this._polymorphicFract(e),vV.ClassName,e)}_polymorphicFract(e){return vO(e,e=>e-Math.floor(e))}}vV.ClassName="FGFractBlock",(0,i3.H7)(vV.ClassName,vV);class vU extends vl{constructor(e){super(gf,gf,e=>this._polymorphicNeg(e),vU.ClassName,e)}_polymorphicNeg(e){return vO(e,e=>-e)}}function vk(e,t,i){switch(vv(e)){case"FlowGraphInteger":return new gh(i(e.value,t.value));case"Vector2":return new i1.FM(i(e.x,t.x),i(e.y,t.y));case"Vector3":return new i1.P(i(e.x,t.x),i(e.y,t.y),i(e.z,t.z));case"Vector4":return new i1.Lt(i(e.x,t.x),i(e.y,t.y),i(e.z,t.z),i(e.w,t.w));case"Matrix":return i1.y3.FromValues(i(e.m[0],t.m[0]),i(e.m[4],t.m[4]),i(e.m[8],t.m[8]),i(e.m[12],t.m[12]),i(e.m[1],t.m[1]),i(e.m[5],t.m[5]),i(e.m[9],t.m[9]),i(e.m[13],t.m[13]),i(e.m[2],t.m[2]),i(e.m[6],t.m[6]),i(e.m[10],t.m[10]),i(e.m[14],t.m[14]),i(e.m[3],t.m[3]),i(e.m[7],t.m[7]),i(e.m[11],t.m[11]),i(e.m[15],t.m[15]));default:return i(e,t)}}vU.ClassName="FGNegBlock",(0,i3.H7)(vU.ClassName,vU);class vG extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicRemainder(e,t),vG.ClassName,e)}_polymorphicRemainder(e,t){return vk(e,t,(e,t)=>e%t)}}vG.ClassName="FGRemainderBlock",(0,i3.H7)(vG.ClassName,vG);class vz extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicMin(e,t),vz.ClassName,e)}_polymorphicMin(e,t){return vk(e,t,Math.min)}}vz.ClassName="FGMinBlock",(0,i3.H7)(vz.ClassName,vz);class vH extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicMax(e,t),vH.ClassName,e)}_polymorphicMax(e,t){return vk(e,t,Math.max)}}function vW(e,t,i){return Math.min(Math.max(e,Math.min(t,i)),Math.max(t,i))}function vY(e,t,i,r){switch(vv(e)){case"FlowGraphInteger":return new gh(r(e.value,t.value,i.value));case"Vector2":return new i1.FM(r(e.x,t.x,i.x),r(e.y,t.y,i.y));case"Vector3":return new i1.P(r(e.x,t.x,i.x),r(e.y,t.y,i.y),r(e.z,t.z,i.z));case"Vector4":return new i1.Lt(r(e.x,t.x,i.x),r(e.y,t.y,i.y),r(e.z,t.z,i.z),r(e.w,t.w,i.w));case"Matrix":return i1.y3.FromValues(r(e.m[0],t.m[0],i.m[0]),r(e.m[4],t.m[4],i.m[4]),r(e.m[8],t.m[8],i.m[8]),r(e.m[12],t.m[12],i.m[12]),r(e.m[1],t.m[1],i.m[1]),r(e.m[5],t.m[5],i.m[5]),r(e.m[9],t.m[9],i.m[9]),r(e.m[13],t.m[13],i.m[13]),r(e.m[2],t.m[2],i.m[2]),r(e.m[6],t.m[6],i.m[6]),r(e.m[10],t.m[10],i.m[10]),r(e.m[14],t.m[14],i.m[14]),r(e.m[3],t.m[3],i.m[3]),r(e.m[7],t.m[7],i.m[7]),r(e.m[11],t.m[11],i.m[11]),r(e.m[15],t.m[15],i.m[15]));default:return r(e,t,i)}}vH.ClassName="FGMaxBlock",(0,i3.H7)(vH.ClassName,vH);class vX extends vg{constructor(e){super(gf,gf,gf,gf,(e,t,i)=>this._polymorphicClamp(e,t,i),vX.ClassName,e)}_polymorphicClamp(e,t,i){return vY(e,t,i,vW)}}function v$(e){return Math.min(Math.max(e,0),1)}vX.ClassName="FGClampBlock",(0,i3.H7)(vX.ClassName,vX);class vj extends vl{constructor(e){super(gf,gf,e=>this._polymorphicSaturate(e),vj.ClassName,e)}_polymorphicSaturate(e){return vO(e,v$)}}vj.ClassName="FGSaturateBlock",(0,i3.H7)(vj.ClassName,vj);class vq extends vg{constructor(e){super(gf,gf,gf,gf,(e,t,i)=>this._polymorphicInterpolate(e,t,i),vq.ClassName,e)}_interpolate(e,t,i){return(1-i)*e+i*t}_polymorphicInterpolate(e,t,i){return vY(e,t,i,this._interpolate)}}vq.ClassName="FGInterpolateBlock",(0,i3.H7)(vq.ClassName,vq);class vQ extends vo{constructor(e){super(gf,gf,g_,(e,t)=>this._polymorphicEq(e,t),vQ.ClassName,e)}_polymorphicEq(e,t){let i=vv(e),r=vv(t);return vS(i,r)||vx(i,r)||vE(i,r)?e.equals(t):e===t}}function vK(e,t,i){let r=vv(e);if(r===vv(t)){if(""===r)return i(e,t);if("FlowGraphInteger"===r)return i(e.value,t.value);throw Error(`Cannot compare ${e} and ${t}`)}throw Error(`${e} and ${t} are of different types.`)}vQ.ClassName="FGEqBlock",(0,i3.H7)(vQ.ClassName,vQ);class vZ extends vo{constructor(e){super(gf,gf,g_,(e,t)=>this._polymorphicLessThan(e,t),vZ.ClassName,e)}_polymorphicLessThan(e,t){return vK(e,t,(e,t)=>e<t)}}vZ.ClassName="FGLessThanBlock",(0,i3.H7)(vZ.ClassName,vZ);class vJ extends vo{constructor(e){super(gf,gf,g_,(e,t)=>this._polymorphicLessThanOrEqual(e,t),vJ.ClassName,e)}_polymorphicLessThanOrEqual(e,t){return vK(e,t,(e,t)=>e<=t)}}vJ.ClassName="FGLessThanOrEqualBlock";class v0 extends vo{constructor(e){super(gf,gf,g_,(e,t)=>this._polymorphicGreaterThan(e,t),v0.ClassName,e)}_polymorphicGreaterThan(e,t){return vK(e,t,(e,t)=>e>t)}}v0.ClassName="FGGreaterThanBlock",(0,i3.H7)(v0.ClassName,v0);class v1 extends vo{constructor(e){super(gf,gf,g_,(e,t)=>this._polymorphicGreaterThanOrEqual(e,t),v1.ClassName,e)}_polymorphicGreaterThanOrEqual(e,t){return vK(e,t,(e,t)=>e>=t)}}v1.ClassName="FGGreaterThanOrEqualBlock",(0,i3.H7)(v1.ClassName,v1);class v2 extends vl{constructor(e){super(gf,g_,e=>this._polymorphicIsNan(e),v2.ClassName,e)}_polymorphicIsNan(e){let t=vv(e);if(""===t)return isNaN(e);if("FlowGraphInteger"===t)return isNaN(e.value);throw Error(`Cannot get NaN of ${e}`)}}v2.ClassName="FGIsNanBlock",(0,i3.H7)(v2.ClassName,v2);class v3 extends vl{constructor(e){super(gf,g_,e=>this._polymorphicIsInf(e),v3.ClassName,e)}_polymorphicIsInf(e){let t=vv(e);if(""===t)return!isFinite(e);if("FlowGraphInteger"===t)return!isFinite(e.value);throw Error(`Cannot get isInf of ${e}`)}}v3.ClassName="FGIsInfBlock";class v4 extends vl{constructor(e){super(gf,gf,e=>this._polymorphicDegToRad(e),v4.ClassName,e)}_degToRad(e){return e*Math.PI/180}_polymorphicDegToRad(e){return vO(e,this._degToRad)}}v4.ClassName="FGDegToRadBlock",(0,i3.H7)(v4.ClassName,v4);class v5 extends vl{constructor(e){super(gf,gf,e=>this._polymorphicRadToDeg(e),v5.ClassName,e)}_radToDeg(e){return 180*e/Math.PI}_polymorphicRadToDeg(e){return vO(e,this._radToDeg)}}v5.ClassName="FGRadToDegBlock",(0,i3.H7)(v5.ClassName,v5);class v7 extends vl{constructor(e){super(gf,gf,e=>this._polymorphicSin(e),v7.ClassName,e)}_polymorphicSin(e){return vO(e,Math.sin)}}v7.ClassName="FGSinBlock",(0,i3.H7)(v7.ClassName,v7);class v6 extends vl{constructor(e){super(gf,gf,e=>this._polymorphicCos(e),v6.ClassName,e)}_polymorphicCos(e){return vO(e,Math.cos)}}v6.ClassName="FGCosBlock",(0,i3.H7)(v6.ClassName,v6);class v8 extends vl{constructor(e){super(gf,gf,e=>this._polymorphicTan(e),v8.ClassName,e)}_polymorphicTan(e){return vO(e,Math.tan)}}v8.ClassName="FGTanBlock",(0,i3.H7)(v8.ClassName,v8);class v9 extends vl{constructor(e){super(gf,gf,e=>this._polymorphicAsin(e),v9.ClassName,e)}_polymorphicAsin(e){return vO(e,Math.asin)}}v9.ClassName="FGAsinBlock",(0,i3.H7)(v9.ClassName,v9);class Se extends vl{constructor(e){super(gf,gf,e=>this._polymorphicAcos(e),Se.ClassName,e)}_polymorphicAcos(e){return vO(e,Math.acos)}}Se.ClassName="FGAcosBlock",(0,i3.H7)(Se.ClassName,Se);class St extends vl{constructor(e){super(gf,gf,e=>this._polymorphicAtan(e),St.ClassName,e)}_polymorphicAtan(e){return vO(e,Math.atan)}}St.ClassName="FGAtanBlock",(0,i3.H7)(St.ClassName,St);class Si extends vo{constructor(e){super(gf,gf,gf,(e,t)=>this._polymorphicAtan2(e,t),Si.ClassName,e)}_polymorphicAtan2(e,t){return vk(e,t,Math.atan2)}}Si.ClassName="FGAtan2Block",(0,i3.H7)(Si.ClassName,Si);class Sr extends vl{constructor(e){super(gf,gf,e=>this._polymorphicSinh(e),Sr.ClassName,e)}_polymorphicSinh(e){return vO(e,Math.sinh)}}Sr.ClassName="FGSinhBlock",(0,i3.H7)(Sr.ClassName,Sr);class Ss extends vl{constructor(e){super(gf,gf,e=>this._polymorphicCosh(e),Ss.ClassName,e)}_polymorphicCosh(e){return vO(e,Math.cosh)}}Ss.ClassName="FGCoshBlock",(0,i3.H7)(Ss.ClassName,Ss);class Sn extends vl{constructor(e){super(gf,gf,e=>this._polymorphicTanh(e),Sn.ClassName,e)}_polymorphicTanh(e){return vO(e,Math.tanh)}}Sn.ClassName="FGTanhBlock",(0,i3.H7)(Sn.ClassName,Sn);class Sa extends vl{constructor(e){super(gf,gm,e=>this._polymorphicAsinh(e),Sa.ClassName,e)}_polymorphicAsinh(e){return vO(e,Math.asinh)}}Sa.ClassName="FGAsinhBlock",(0,i3.H7)(Sa.ClassName,Sa);class So extends vl{constructor(e){super(gf,gm,e=>this._polymorphicAcosh(e),So.ClassName,e)}_polymorphicAcosh(e){return vO(e,Math.acosh)}}So.ClassName="FGAcoshBlock",(0,i3.H7)(So.ClassName,So);class Sl extends vl{constructor(e){super(gf,gm,e=>this._polymorphicAtanh(e),Sl.ClassName,e)}_polymorphicAtanh(e){return vO(e,Math.atanh)}}Sl.ClassName="FGAtanhBlock",(0,i3.H7)(Sl.ClassName,Sl);class Sc extends vl{constructor(e){super(gf,gm,e=>this._polymorphicExp(e),Sc.ClassName,e)}_polymorphicExp(e){return vO(e,Math.exp)}}Sc.ClassName="FGExpBlock",(0,i3.H7)(Sc.ClassName,Sc);class Su extends vl{constructor(e){super(gf,gm,e=>this._polymorphicLog(e),Su.ClassName,e)}_polymorphicLog(e){return vO(e,Math.log)}}Su.ClassName="FGLogBlock",(0,i3.H7)(Su.ClassName,Su);class Sh extends vl{constructor(e){super(gf,gm,e=>this._polymorphicLog2(e),Sh.ClassName,e)}_polymorphicLog2(e){return vO(e,Math.log2)}}Sh.ClassName="FGLog2Block",(0,i3.H7)(Sh.ClassName,Sh);class Sd extends vl{constructor(e){super(gf,gm,e=>this._polymorphicLog10(e),Sd.ClassName,e)}_polymorphicLog10(e){return vO(e,Math.log10)}}Sd.ClassName="FGLog10Block",(0,i3.H7)(Sd.ClassName,Sd);class Sf extends vl{constructor(e){super(gf,gm,e=>this._polymorphicSqrt(e),Sf.ClassName,e)}_polymorphicSqrt(e){return vO(e,Math.sqrt)}}Sf.ClassName="FGSqrtBlock",(0,i3.H7)(Sf.ClassName,Sf);class Sp extends vl{constructor(e){super(gf,gm,e=>this._polymorphicCubeRoot(e),Sp.ClassName,e)}_polymorphicCubeRoot(e){return vO(e,Math.cbrt)}}Sp.ClassName="FGCubeRootBlock",(0,i3.H7)(Sp.ClassName,Sp);class Sm extends vo{constructor(e){super(gf,gm,gm,(e,t)=>this._polymorphicPow(e,t),Sm.ClassName,e)}_polymorphicPow(e,t){return vk(e,t,Math.pow)}}Sm.ClassName="FGPowBlock",(0,i3.H7)(Sm.ClassName,Sm);class S_ extends vl{constructor(e){super(gf,gm,e=>this._polymorphicLength(e),S_.ClassName,e)}_polymorphicLength(e){switch(vv(e)){case"Vector2":case"Vector3":case"Vector4":return e.length();default:throw Error(`Cannot compute length of value ${e}`)}}}S_.ClassName="FGLengthBlock",(0,i3.H7)(S_.ClassName,S_);class Sg extends vl{constructor(e){super(gf,gf,e=>this._polymorphicNormalize(e),Sg.ClassName,e)}_polymorphicNormalize(e){switch(vv(e)){case"Vector2":case"Vector3":case"Vector4":return e.normalize();default:throw Error(`Cannot normalize value ${e}`)}}}Sg.ClassName="FGNormalizeBlock",(0,i3.H7)(Sg.ClassName,Sg);class Sv extends vo{constructor(e){super(gv,gv,gv,(e,t)=>i1.P.Cross(e,t),Sv.ClassName,e)}}Sv.ClassName="FGCrossBlock",(0,i3.H7)(Sv.ClassName,Sv);class SS extends vo{constructor(e){super(gg,gm,gg,(e,t)=>i1.FM.Transform(e,i1.y3.RotationZ(t)),SS.ClassName,e)}}SS.ClassName="FGRotate2DBlock",(0,i3.H7)(SS.ClassName,SS);class Sx extends vg{constructor(e){super(gv,gv,gm,gv,(e,t,i)=>i1.P.TransformCoordinates(e,i1.y3.RotationAxis(t,i)),Sx.ClassName,e)}}Sx.ClassName="FGRotate3DBlock",(0,i3.H7)(Sx.ClassName,Sx);class SE extends vl{constructor(e){super(gx,gx,e=>i1.y3.Transpose(e),SE.ClassName,e)}}SE.ClassName="FGTransposeBlock",(0,i3.H7)(SE.ClassName,SE);class SC extends vl{constructor(e){super(gx,gm,e=>e.determinant(),SC.ClassName,e)}}SC.ClassName="FGDeterminantBlock",(0,i3.H7)(SC.ClassName,SC);class ST extends vl{constructor(e){super(gx,gx,e=>i1.y3.Invert(e),ST.ClassName,e)}}ST.ClassName="FGInvertMatrixBlock",(0,i3.H7)(ST.ClassName,ST);class Sb extends vo{constructor(e){super(gx,gx,gx,(e,t)=>t.multiply(e),Sb.ClassName,e)}}Sb.ClassName="FGMatMulBlock",(0,i3.H7)(Sb.ClassName,Sb);class Sy extends vl{constructor(e){super(gb,gb,e=>new gh(~e.value),Sy.ClassName,e)}}Sy.ClassName="FGBitwiseNotBlock",(0,i3.H7)(Sy.ClassName,Sy);class SI extends vo{constructor(e){super(gb,gb,gb,(e,t)=>new gh(e.value&t.value),SI.ClassName,e)}}SI.ClassName="FGBitwiseAndBlock",(0,i3.H7)(SI.ClassName,SI);class SP extends vo{constructor(e){super(gb,gb,gb,(e,t)=>new gh(e.value|t.value),SP.ClassName,e)}}SP.ClassName="FGBitwiseOrBlock",(0,i3.H7)(SP.ClassName,SP);class SR extends vo{constructor(e){super(gb,gb,gb,(e,t)=>new gh(e.value^t.value),SR.ClassName,e)}}SR.ClassName="FGBitwiseXorBlock",(0,i3.H7)(SR.ClassName,SR);class SA extends vo{constructor(e){super(gb,gb,gb,(e,t)=>new gh(e.value<<t.value),SA.ClassName,e)}}SA.ClassName="FGBitwiseLeftShiftBlock",(0,i3.H7)(SA.ClassName,SA);class SM extends vo{constructor(e){super(gb,gb,gb,(e,t)=>new gh(e.value>>t.value),SM.ClassName,e)}}SM.ClassName="FGBitwiseRightShiftBlock",(0,i3.H7)(SM.ClassName,SM);class SN extends vl{constructor(e){super(gb,gb,e=>new gh(Math.clz32(e.value)),SN.ClassName,e)}}SN.ClassName="FGCountLeadingZerosBlock",(0,i3.H7)(SN.ClassName,SN);class SO extends vl{constructor(e){super(gb,gb,e=>new gh(e.value?31-Math.clz32(e.value&-e.value):32),SO.ClassName,e)}}SO.ClassName="FGCountTrailingZerosBlock",(0,i3.H7)(SO.ClassName,SO);class SD extends vl{constructor(e){super(gb,gb,e=>new gh(function(e){let t=0;for(;e;)t+=1&e,e>>=1;return t}(e.value)),SD.ClassName,e)}}SD.ClassName="FGCountOneBitsBlock",(0,i3.H7)(SD.ClassName,SD);class SF extends gF{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneReadyObserver")){let t=e.configuration.scene.onReadyObservable.add(()=>{this._execute(e)});e._setExecutionVariable(this,"sceneReadyObserver",t)}}_cancelPendingTasks(e){let t=e._getExecutionVariable(this,"sceneReadyObserver");e.configuration.scene.onReadyObservable.remove(t),e._deleteExecutionVariable(this,"sceneReadyObserver")}getClassName(){return SF.ClassName}}SF.ClassName="FGSceneReadyEventBlock",(0,i3.H7)("FGSceneReadyEventBlock",SF);class SL extends gF{constructor(e){super(e),this.config=e;for(let e=0;e<this.config.eventData.length;e++){let t=this.config.eventData[e];this.registerDataOutput(t,gf)}}_preparePendingTasks(e){let t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);this._eventObserver=t.add(t=>{for(let i=0;i<t.length;i++)this.dataOutputs[i].setValue(t[i],e);this._execute(e)})}_cancelPendingTasks(e){let t=e.configuration.coordinator.getCustomEventObservable(this.config.eventId);t?t.remove(this._eventObserver):rD.w1.Warn(`FlowGraphReceiveCustomEventBlock: Missing observable for event ${this.config.eventId}`)}getClassName(){return SL.ClassName}serialize(e){super.serialize(e),e.eventId=this.config.eventId,e.eventData=this.config.eventData}}SL.ClassName="FGReceiveCustomEventBlock",(0,i3.H7)(SL.ClassName,SL);class Sw extends gF{_preparePendingTasks(e){if(!e._getExecutionVariable(this,"sceneBeforeRender")){let t=e.configuration.scene.onBeforeRenderObservable.add(()=>{this._execute(e)});e._setExecutionVariable(this,"sceneBeforeRender",t)}}_cancelPendingTasks(e){let t=e._getExecutionVariable(this,"sceneBeforeRender");e.configuration.scene.onBeforeRenderObservable.remove(t),e._deleteExecutionVariable(this,"sceneBeforeRender")}getClassName(){return Sw.ClassName}}Sw.ClassName="FGSceneTickEventBlock",(0,i3.H7)(Sw.ClassName,Sw)}}]);